var __defProp = Object.defineProperty;
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};

// src/bitburner/dist/payload.js
var payload = ["InVzZSBzdHJpY3QiOwooKCkgPT4gewogIHZhciBfX2NyZWF0ZSA9IE9iamVjdC5jcmVhdGU7CiAgdmFyIF9fZGVmUHJvcCA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKICB2YXIgX19nZXRPd25Qcm9wRGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3I7CiAgdmFyIF9fZ2V0T3duUHJvcE5hbWVzID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXM7CiAgdmFyIF9fZ2V0T3duUHJvcFN5bWJvbHMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzOwogIHZhciBfX2dldFByb3RvT2YgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2Y7CiAgdmFyIF9faGFzT3duUHJvcCA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgdmFyIF9fcHJvcElzRW51bSA9IE9iamVjdC5wcm90b3R5cGUucHJvcGVydHlJc0VudW1lcmFibGU7CiAgdmFyIF9fZGVmTm9ybWFsUHJvcCA9IChvYmosIGtleSwgdmFsdWUpID0+IGtleSBpbiBvYmogPyBfX2RlZlByb3Aob2JqLCBrZXksIHsgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSwgdmFsdWUgfSkgOiBvYmpba2V5XSA9IHZhbHVlOwogIHZhciBfX3NwcmVhZFZhbHVlcyA9IChhMiwgYikgPT4gewogICAgZm9yICh2YXIgcHJvcCBpbiBiIHx8IChiID0ge30pKQogICAgICBpZiAoX19oYXNPd25Qcm9wLmNhbGwoYiwgcHJvcCkpCiAgICAgICAgX19kZWZOb3JtYWxQcm9wKGEyLCBwcm9wLCBiW3Byb3BdKTsKICAgIGlmIChfX2dldE93blByb3BTeW1ib2xzKQogICAgICBmb3IgKHZhciBwcm9wIG9mIF9fZ2V0T3duUHJvcFN5bWJvbHMoYikpIHsKICAgICAgICBpZiAoX19wcm9wSXNFbnVtLmNhbGwoYiwgcHJvcCkpCiAgICAgICAgICBfX2RlZk5vcm1hbFByb3AoYTIsIHByb3AsIGJbcHJvcF0pOwogICAgICB9CiAgICByZXR1cm4gYTI7CiAgfTsKICB2YXIgX19jb21tb25KUyA9IChjYiwgbW9kKSA9PiBmdW5jdGlvbiBfX3JlcXVpcmUoKSB7CiAgICByZXR1cm4gbW9kIHx8ICgwLCBjYltfX2dldE93blByb3BOYW1lcyhjYilbMF1dKSgobW9kID0geyBleHBvcnRzOiB7fSB9KS5leHBvcnRzLCBtb2QpLCBtb2QuZXhwb3J0czsKICB9OwogIHZhciBfX2NvcHlQcm9wcyA9ICh0bywgZnJvbSwgZXhjZXB0LCBkZXNjKSA9PiB7CiAgICBpZiAoZnJvbSAmJiB0eXBlb2YgZnJvbSA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIGZyb20gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgZm9yIChsZXQga2V5IG9mIF9fZ2V0T3duUHJvcE5hbWVzKGZyb20pKQogICAgICAgIGlmICghX19oYXNPd25Qcm9wLmNhbGwodG8sIGtleSkgJiYga2V5ICE9PSBleGNlcHQpCiAgICAgICAgICBfX2RlZlByb3AodG8sIGtleSwgeyBnZXQ6ICgpID0+IGZyb21ba2V5XSwgZW51bWVyYWJsZTogIShkZXNjID0gX19nZXRPd25Qcm9wRGVzYyhmcm9tLCBrZXkpKSB8fCBkZXNjLmVudW1lcmFibGUgfSk7CiAgICB9CiAgICByZXR1cm4gdG87CiAgfTsKICB2YXIgX190b0VTTSA9IChtb2QsIGlzTm9kZU1vZGUsIHRhcmdldCkgPT4gKHRhcmdldCA9IG1vZCAhPSBudWxsID8gX19jcmVhdGUoX19nZXRQcm90b09mKG1vZCkpIDoge30sIF9fY29weVByb3BzKAogICAgLy8gSWYgdGhlIGltcG9ydGVyIGlzIGluIG5vZGUgY29tcGF0aWJpbGl0eSBtb2RlIG9yIHRoaXMgaXMgbm90IGFuIEVTTQogICAgLy8gZmlsZSB0aGF0IGhhcyBiZWVuIGNvbnZlcnRlZCB0byBhIENvbW1vbkpTIGZpbGUgdXNpbmcgYSBCYWJlbC0KICAgIC8vIGNvbXBhdGlibGUgdHJhbnNmb3JtIChpLmUuICJfX2VzTW9kdWxlIiBoYXMgbm90IGJlZW4gc2V0KSwgdGhlbiBzZXQKICAgIC8vICJkZWZhdWx0IiB0byB0aGUgQ29tbW9uSlMgIm1vZHVsZS5leHBvcnRzIiBmb3Igbm9kZSBjb21wYXRpYmlsaXR5LgogICAgaXNOb2RlTW9kZSB8fCAhbW9kIHx8ICFtb2QuX19lc01vZHVsZSA/IF9fZGVmUHJvcCh0YXJnZXQsICJkZWZhdWx0IiwgeyB2YWx1ZTogbW9kLCBlbnVtZXJhYmxlOiB0cnVlIH0pIDogdGFyZ2V0LAogICAgbW9kCiAgKSk7CgogIC8vIG5vZGVfbW9kdWxlcy9yZWFjdC9janMvcmVhY3QuZGV2ZWxvcG1lbnQuanMKICB2YXIgcmVxdWlyZV9yZWFjdF9kZXZlbG9wbWVudCA9IF9fY29tbW9uSlMoewogICAgIm5vZGVfbW9kdWxlcy9yZWFjdC9janMvcmVhY3QuZGV2ZWxvcG1lbnQuanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgICAidXNlIHN0cmljdCI7CiAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgKGZ1bmN0aW9uKCkgewogICAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgICAgaWYgKHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQobmV3IEVycm9yKCkpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIFJlYWN0VmVyc2lvbiA9ICIxOC4yLjAiOwogICAgICAgICAgdmFyIFJFQUNUX0VMRU1FTlRfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmVsZW1lbnQiKTsKICAgICAgICAgIHZhciBSRUFDVF9QT1JUQUxfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnBvcnRhbCIpOwogICAgICAgICAgdmFyIFJFQUNUX0ZSQUdNRU5UX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5mcmFnbWVudCIpOwogICAgICAgICAgdmFyIFJFQUNUX1NUUklDVF9NT0RFX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5zdHJpY3RfbW9kZSIpOwogICAgICAgICAgdmFyIFJFQUNUX1BST0ZJTEVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wcm9maWxlciIpOwogICAgICAgICAgdmFyIFJFQUNUX1BST1ZJREVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wcm92aWRlciIpOwogICAgICAgICAgdmFyIFJFQUNUX0NPTlRFWFRfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmNvbnRleHQiKTsKICAgICAgICAgIHZhciBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZm9yd2FyZF9yZWYiKTsKICAgICAgICAgIHZhciBSRUFDVF9TVVNQRU5TRV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3VzcGVuc2UiKTsKICAgICAgICAgIHZhciBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5zdXNwZW5zZV9saXN0Iik7CiAgICAgICAgICB2YXIgUkVBQ1RfTUVNT19UWVBFID0gU3ltYm9sLmZvcigicmVhY3QubWVtbyIpOwogICAgICAgICAgdmFyIFJFQUNUX0xBWllfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmxhenkiKTsKICAgICAgICAgIHZhciBSRUFDVF9PRkZTQ1JFRU5fVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0Lm9mZnNjcmVlbiIpOwogICAgICAgICAgdmFyIE1BWUJFX0lURVJBVE9SX1NZTUJPTCA9IFN5bWJvbC5pdGVyYXRvcjsKICAgICAgICAgIHZhciBGQVVYX0lURVJBVE9SX1NZTUJPTCA9ICJAQGl0ZXJhdG9yIjsKICAgICAgICAgIGZ1bmN0aW9uIGdldEl0ZXJhdG9yRm4obWF5YmVJdGVyYWJsZSkgewogICAgICAgICAgICBpZiAobWF5YmVJdGVyYWJsZSA9PT0gbnVsbCB8fCB0eXBlb2YgbWF5YmVJdGVyYWJsZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbWF5YmVJdGVyYXRvciA9IE1BWUJFX0lURVJBVE9SX1NZTUJPTCAmJiBtYXliZUl0ZXJhYmxlW01BWUJFX0lURVJBVE9SX1NZTUJPTF0gfHwgbWF5YmVJdGVyYWJsZVtGQVVYX0lURVJBVE9SX1NZTUJPTF07CiAgICAgICAgICAgIGlmICh0eXBlb2YgbWF5YmVJdGVyYXRvciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHJldHVybiBtYXliZUl0ZXJhdG9yOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIFJlYWN0Q3VycmVudERpc3BhdGNoZXIgPSB7CiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAaW50ZXJuYWwKICAgICAgICAgICAgICogQHR5cGUge1JlYWN0Q29tcG9uZW50fQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgY3VycmVudDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIHZhciBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyA9IHsKICAgICAgICAgICAgdHJhbnNpdGlvbjogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIHZhciBSZWFjdEN1cnJlbnRBY3RRdWV1ZSA9IHsKICAgICAgICAgICAgY3VycmVudDogbnVsbCwKICAgICAgICAgICAgLy8gVXNlZCB0byByZXByb2R1Y2UgYmVoYXZpb3Igb2YgYGJhdGNoZWRVcGRhdGVzYCBpbiBsZWdhY3kgbW9kZS4KICAgICAgICAgICAgaXNCYXRjaGluZ0xlZ2FjeTogZmFsc2UsCiAgICAgICAgICAgIGRpZFNjaGVkdWxlTGVnYWN5VXBkYXRlOiBmYWxzZQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBSZWFjdEN1cnJlbnRPd25lciA9IHsKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICAgKiBAdHlwZSB7UmVhY3RDb21wb25lbnR9CiAgICAgICAgICAgICAqLwogICAgICAgICAgICBjdXJyZW50OiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIFJlYWN0RGVidWdDdXJyZW50RnJhbWUgPSB7fTsKICAgICAgICAgIHZhciBjdXJyZW50RXh0cmFTdGFja0ZyYW1lID0gbnVsbDsKICAgICAgICAgIGZ1bmN0aW9uIHNldEV4dHJhU3RhY2tGcmFtZShzdGFjaykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY3VycmVudEV4dHJhU3RhY2tGcmFtZSA9IHN0YWNrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUuc2V0RXh0cmFTdGFja0ZyYW1lID0gZnVuY3Rpb24oc3RhY2spIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjdXJyZW50RXh0cmFTdGFja0ZyYW1lID0gc3RhY2s7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldEN1cnJlbnRTdGFjayA9IG51bGw7CiAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUuZ2V0U3RhY2tBZGRlbmR1bSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHZhciBzdGFjayA9ICIiOwogICAgICAgICAgICAgIGlmIChjdXJyZW50RXh0cmFTdGFja0ZyYW1lKSB7CiAgICAgICAgICAgICAgICBzdGFjayArPSBjdXJyZW50RXh0cmFTdGFja0ZyYW1lOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgaW1wbCA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWUuZ2V0Q3VycmVudFN0YWNrOwogICAgICAgICAgICAgIGlmIChpbXBsKSB7CiAgICAgICAgICAgICAgICBzdGFjayArPSBpbXBsKCkgfHwgIiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBzdGFjazsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBlbmFibGVTY29wZUFQSSA9IGZhbHNlOwogICAgICAgICAgdmFyIGVuYWJsZUNhY2hlRWxlbWVudCA9IGZhbHNlOwogICAgICAgICAgdmFyIGVuYWJsZVRyYW5zaXRpb25UcmFjaW5nID0gZmFsc2U7CiAgICAgICAgICB2YXIgZW5hYmxlTGVnYWN5SGlkZGVuID0gZmFsc2U7CiAgICAgICAgICB2YXIgZW5hYmxlRGVidWdUcmFjaW5nID0gZmFsc2U7CiAgICAgICAgICB2YXIgUmVhY3RTaGFyZWRJbnRlcm5hbHMgPSB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIsCiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLAogICAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lcgogICAgICAgICAgfTsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgICAgIFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudEFjdFF1ZXVlID0gUmVhY3RDdXJyZW50QWN0UXVldWU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB3YXJuKGZvcm1hdCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbiA+IDEgPyBfbGVuIC0gMSA6IDApLCBfa2V5ID0gMTsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgICAgICAgICAgICBhcmdzW19rZXkgLSAxXSA9IGFyZ3VtZW50c1tfa2V5XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHByaW50V2FybmluZygid2FybiIsIGZvcm1hdCwgYXJncyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBlcnJvcihmb3JtYXQpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIF9sZW4yID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuMiA+IDEgPyBfbGVuMiAtIDEgOiAwKSwgX2tleTIgPSAxOyBfa2V5MiA8IF9sZW4yOyBfa2V5MisrKSB7CiAgICAgICAgICAgICAgICAgIGFyZ3NbX2tleTIgLSAxXSA9IGFyZ3VtZW50c1tfa2V5Ml07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwcmludFdhcm5pbmcoImVycm9yIiwgZm9ybWF0LCBhcmdzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHByaW50V2FybmluZyhsZXZlbCwgZm9ybWF0LCBhcmdzKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWUyLmdldFN0YWNrQWRkZW5kdW0oKTsKICAgICAgICAgICAgICBpZiAoc3RhY2sgIT09ICIiKSB7CiAgICAgICAgICAgICAgICBmb3JtYXQgKz0gIiVzIjsKICAgICAgICAgICAgICAgIGFyZ3MgPSBhcmdzLmNvbmNhdChbc3RhY2tdKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGFyZ3NXaXRoRm9ybWF0ID0gYXJncy5tYXAoZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZyhpdGVtKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBhcmdzV2l0aEZvcm1hdC51bnNoaWZ0KCJXYXJuaW5nOiAiICsgZm9ybWF0KTsKICAgICAgICAgICAgICBGdW5jdGlvbi5wcm90b3R5cGUuYXBwbHkuY2FsbChjb25zb2xlW2xldmVsXSwgY29uc29sZSwgYXJnc1dpdGhGb3JtYXQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZGlkV2FyblN0YXRlVXBkYXRlRm9yVW5tb3VudGVkQ29tcG9uZW50ID0ge307CiAgICAgICAgICBmdW5jdGlvbiB3YXJuTm9vcChwdWJsaWNJbnN0YW5jZSwgY2FsbGVyTmFtZSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIF9jb25zdHJ1Y3RvciA9IHB1YmxpY0luc3RhbmNlLmNvbnN0cnVjdG9yOwogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gX2NvbnN0cnVjdG9yICYmIChfY29uc3RydWN0b3IuZGlzcGxheU5hbWUgfHwgX2NvbnN0cnVjdG9yLm5hbWUpIHx8ICJSZWFjdENsYXNzIjsKICAgICAgICAgICAgICB2YXIgd2FybmluZ0tleSA9IGNvbXBvbmVudE5hbWUgKyAiLiIgKyBjYWxsZXJOYW1lOwogICAgICAgICAgICAgIGlmIChkaWRXYXJuU3RhdGVVcGRhdGVGb3JVbm1vdW50ZWRDb21wb25lbnRbd2FybmluZ0tleV0pIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZXJyb3IoIkNhbid0IGNhbGwgJXMgb24gYSBjb21wb25lbnQgdGhhdCBpcyBub3QgeWV0IG1vdW50ZWQuIFRoaXMgaXMgYSBuby1vcCwgYnV0IGl0IG1pZ2h0IGluZGljYXRlIGEgYnVnIGluIHlvdXIgYXBwbGljYXRpb24uIEluc3RlYWQsIGFzc2lnbiB0byBgdGhpcy5zdGF0ZWAgZGlyZWN0bHkgb3IgZGVmaW5lIGEgYHN0YXRlID0ge307YCBjbGFzcyBwcm9wZXJ0eSB3aXRoIHRoZSBkZXNpcmVkIHN0YXRlIGluIHRoZSAlcyBjb21wb25lbnQuIiwgY2FsbGVyTmFtZSwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgZGlkV2FyblN0YXRlVXBkYXRlRm9yVW5tb3VudGVkQ29tcG9uZW50W3dhcm5pbmdLZXldID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIFJlYWN0Tm9vcFVwZGF0ZVF1ZXVlID0gewogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQ2hlY2tzIHdoZXRoZXIgb3Igbm90IHRoaXMgY29tcG9zaXRlIGNvbXBvbmVudCBpcyBtb3VudGVkLgogICAgICAgICAgICAgKiBAcGFyYW0ge1JlYWN0Q2xhc3N9IHB1YmxpY0luc3RhbmNlIFRoZSBpbnN0YW5jZSB3ZSB3YW50IHRvIHRlc3QuCiAgICAgICAgICAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgbW91bnRlZCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAgICAgKiBAcHJvdGVjdGVkCiAgICAgICAgICAgICAqIEBmaW5hbAogICAgICAgICAgICAgKi8KICAgICAgICAgICAgaXNNb3VudGVkOiBmdW5jdGlvbihwdWJsaWNJbnN0YW5jZSkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEZvcmNlcyBhbiB1cGRhdGUuIFRoaXMgc2hvdWxkIG9ubHkgYmUgaW52b2tlZCB3aGVuIGl0IGlzIGtub3duIHdpdGgKICAgICAgICAgICAgICogY2VydGFpbnR5IHRoYXQgd2UgYXJlICoqbm90KiogaW4gYSBET00gdHJhbnNhY3Rpb24uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIFlvdSBtYXkgd2FudCB0byBjYWxsIHRoaXMgd2hlbiB5b3Uga25vdyB0aGF0IHNvbWUgZGVlcGVyIGFzcGVjdCBvZiB0aGUKICAgICAgICAgICAgICogY29tcG9uZW50J3Mgc3RhdGUgaGFzIGNoYW5nZWQgYnV0IGBzZXRTdGF0ZWAgd2FzIG5vdCBjYWxsZWQuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIFRoaXMgd2lsbCBub3QgaW52b2tlIGBzaG91bGRDb21wb25lbnRVcGRhdGVgLCBidXQgaXQgd2lsbCBpbnZva2UKICAgICAgICAgICAgICogYGNvbXBvbmVudFdpbGxVcGRhdGVgIGFuZCBgY29tcG9uZW50RGlkVXBkYXRlYC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtSZWFjdENsYXNzfSBwdWJsaWNJbnN0YW5jZSBUaGUgaW5zdGFuY2UgdGhhdCBzaG91bGQgcmVyZW5kZXIuCiAgICAgICAgICAgICAqIEBwYXJhbSB7P2Z1bmN0aW9ufSBjYWxsYmFjayBDYWxsZWQgYWZ0ZXIgY29tcG9uZW50IGlzIHVwZGF0ZWQuCiAgICAgICAgICAgICAqIEBwYXJhbSB7P3N0cmluZ30gY2FsbGVyTmFtZSBuYW1lIG9mIHRoZSBjYWxsaW5nIGZ1bmN0aW9uIGluIHRoZSBwdWJsaWMgQVBJLgogICAgICAgICAgICAgKiBAaW50ZXJuYWwKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGVucXVldWVGb3JjZVVwZGF0ZTogZnVuY3Rpb24ocHVibGljSW5zdGFuY2UsIGNhbGxiYWNrLCBjYWxsZXJOYW1lKSB7CiAgICAgICAgICAgICAgd2Fybk5vb3AocHVibGljSW5zdGFuY2UsICJmb3JjZVVwZGF0ZSIpOwogICAgICAgICAgICB9LAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogUmVwbGFjZXMgYWxsIG9mIHRoZSBzdGF0ZS4gQWx3YXlzIHVzZSB0aGlzIG9yIGBzZXRTdGF0ZWAgdG8gbXV0YXRlIHN0YXRlLgogICAgICAgICAgICAgKiBZb3Ugc2hvdWxkIHRyZWF0IGB0aGlzLnN0YXRlYCBhcyBpbW11dGFibGUuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIFRoZXJlIGlzIG5vIGd1YXJhbnRlZSB0aGF0IGB0aGlzLnN0YXRlYCB3aWxsIGJlIGltbWVkaWF0ZWx5IHVwZGF0ZWQsIHNvCiAgICAgICAgICAgICAqIGFjY2Vzc2luZyBgdGhpcy5zdGF0ZWAgYWZ0ZXIgY2FsbGluZyB0aGlzIG1ldGhvZCBtYXkgcmV0dXJuIHRoZSBvbGQgdmFsdWUuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7UmVhY3RDbGFzc30gcHVibGljSW5zdGFuY2UgVGhlIGluc3RhbmNlIHRoYXQgc2hvdWxkIHJlcmVuZGVyLgogICAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gY29tcGxldGVTdGF0ZSBOZXh0IHN0YXRlLgogICAgICAgICAgICAgKiBAcGFyYW0gez9mdW5jdGlvbn0gY2FsbGJhY2sgQ2FsbGVkIGFmdGVyIGNvbXBvbmVudCBpcyB1cGRhdGVkLgogICAgICAgICAgICAgKiBAcGFyYW0gez9zdHJpbmd9IGNhbGxlck5hbWUgbmFtZSBvZiB0aGUgY2FsbGluZyBmdW5jdGlvbiBpbiB0aGUgcHVibGljIEFQSS4KICAgICAgICAgICAgICogQGludGVybmFsCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBlbnF1ZXVlUmVwbGFjZVN0YXRlOiBmdW5jdGlvbihwdWJsaWNJbnN0YW5jZSwgY29tcGxldGVTdGF0ZSwgY2FsbGJhY2ssIGNhbGxlck5hbWUpIHsKICAgICAgICAgICAgICB3YXJuTm9vcChwdWJsaWNJbnN0YW5jZSwgInJlcGxhY2VTdGF0ZSIpOwogICAgICAgICAgICB9LAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogU2V0cyBhIHN1YnNldCBvZiB0aGUgc3RhdGUuIFRoaXMgb25seSBleGlzdHMgYmVjYXVzZSBfcGVuZGluZ1N0YXRlIGlzCiAgICAgICAgICAgICAqIGludGVybmFsLiBUaGlzIHByb3ZpZGVzIGEgbWVyZ2luZyBzdHJhdGVneSB0aGF0IGlzIG5vdCBhdmFpbGFibGUgdG8gZGVlcAogICAgICAgICAgICAgKiBwcm9wZXJ0aWVzIHdoaWNoIGlzIGNvbmZ1c2luZy4gVE9ETzogRXhwb3NlIHBlbmRpbmdTdGF0ZSBvciBkb24ndCB1c2UgaXQKICAgICAgICAgICAgICogZHVyaW5nIHRoZSBtZXJnZS4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtSZWFjdENsYXNzfSBwdWJsaWNJbnN0YW5jZSBUaGUgaW5zdGFuY2UgdGhhdCBzaG91bGQgcmVyZW5kZXIuCiAgICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBwYXJ0aWFsU3RhdGUgTmV4dCBwYXJ0aWFsIHN0YXRlIHRvIGJlIG1lcmdlZCB3aXRoIHN0YXRlLgogICAgICAgICAgICAgKiBAcGFyYW0gez9mdW5jdGlvbn0gY2FsbGJhY2sgQ2FsbGVkIGFmdGVyIGNvbXBvbmVudCBpcyB1cGRhdGVkLgogICAgICAgICAgICAgKiBAcGFyYW0gez9zdHJpbmd9IE5hbWUgb2YgdGhlIGNhbGxpbmcgZnVuY3Rpb24gaW4gdGhlIHB1YmxpYyBBUEkuCiAgICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZW5xdWV1ZVNldFN0YXRlOiBmdW5jdGlvbihwdWJsaWNJbnN0YW5jZSwgcGFydGlhbFN0YXRlLCBjYWxsYmFjaywgY2FsbGVyTmFtZSkgewogICAgICAgICAgICAgIHdhcm5Ob29wKHB1YmxpY0luc3RhbmNlLCAic2V0U3RhdGUiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBhc3NpZ24gPSBPYmplY3QuYXNzaWduOwogICAgICAgICAgdmFyIGVtcHR5T2JqZWN0ID0ge307CiAgICAgICAgICB7CiAgICAgICAgICAgIE9iamVjdC5mcmVlemUoZW1wdHlPYmplY3QpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gQ29tcG9uZW50KHByb3BzLCBjb250ZXh0LCB1cGRhdGVyKSB7CiAgICAgICAgICAgIHRoaXMucHJvcHMgPSBwcm9wczsKICAgICAgICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dDsKICAgICAgICAgICAgdGhpcy5yZWZzID0gZW1wdHlPYmplY3Q7CiAgICAgICAgICAgIHRoaXMudXBkYXRlciA9IHVwZGF0ZXIgfHwgUmVhY3ROb29wVXBkYXRlUXVldWU7CiAgICAgICAgICB9CiAgICAgICAgICBDb21wb25lbnQucHJvdG90eXBlLmlzUmVhY3RDb21wb25lbnQgPSB7fTsKICAgICAgICAgIENvbXBvbmVudC5wcm90b3R5cGUuc2V0U3RhdGUgPSBmdW5jdGlvbihwYXJ0aWFsU3RhdGUsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcGFydGlhbFN0YXRlICE9PSAib2JqZWN0IiAmJiB0eXBlb2YgcGFydGlhbFN0YXRlICE9PSAiZnVuY3Rpb24iICYmIHBhcnRpYWxTdGF0ZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJzZXRTdGF0ZSguLi4pOiB0YWtlcyBhbiBvYmplY3Qgb2Ygc3RhdGUgdmFyaWFibGVzIHRvIHVwZGF0ZSBvciBhIGZ1bmN0aW9uIHdoaWNoIHJldHVybnMgYW4gb2JqZWN0IG9mIHN0YXRlIHZhcmlhYmxlcy4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnVwZGF0ZXIuZW5xdWV1ZVNldFN0YXRlKHRoaXMsIHBhcnRpYWxTdGF0ZSwgY2FsbGJhY2ssICJzZXRTdGF0ZSIpOwogICAgICAgICAgfTsKICAgICAgICAgIENvbXBvbmVudC5wcm90b3R5cGUuZm9yY2VVcGRhdGUgPSBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgICAgICB0aGlzLnVwZGF0ZXIuZW5xdWV1ZUZvcmNlVXBkYXRlKHRoaXMsIGNhbGxiYWNrLCAiZm9yY2VVcGRhdGUiKTsKICAgICAgICAgIH07CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBkZXByZWNhdGVkQVBJcyA9IHsKICAgICAgICAgICAgICBpc01vdW50ZWQ6IFsiaXNNb3VudGVkIiwgIkluc3RlYWQsIG1ha2Ugc3VyZSB0byBjbGVhbiB1cCBzdWJzY3JpcHRpb25zIGFuZCBwZW5kaW5nIHJlcXVlc3RzIGluIGNvbXBvbmVudFdpbGxVbm1vdW50IHRvIHByZXZlbnQgbWVtb3J5IGxlYWtzLiJdLAogICAgICAgICAgICAgIHJlcGxhY2VTdGF0ZTogWyJyZXBsYWNlU3RhdGUiLCAiUmVmYWN0b3IgeW91ciBjb2RlIHRvIHVzZSBzZXRTdGF0ZSBpbnN0ZWFkIChzZWUgaHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL3JlYWN0L2lzc3Vlcy8zMjM2KS4iXQogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgZGVmaW5lRGVwcmVjYXRpb25XYXJuaW5nID0gZnVuY3Rpb24obWV0aG9kTmFtZSwgaW5mbykgewogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShDb21wb25lbnQucHJvdG90eXBlLCBtZXRob2ROYW1lLCB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB3YXJuKCIlcyguLi4pIGlzIGRlcHJlY2F0ZWQgaW4gcGxhaW4gSmF2YVNjcmlwdCBSZWFjdCBjbGFzc2VzLiAlcyIsIGluZm9bMF0sIGluZm9bMV0pOwogICAgICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwogICAgICAgICAgICBmb3IgKHZhciBmbk5hbWUgaW4gZGVwcmVjYXRlZEFQSXMpIHsKICAgICAgICAgICAgICBpZiAoZGVwcmVjYXRlZEFQSXMuaGFzT3duUHJvcGVydHkoZm5OYW1lKSkgewogICAgICAgICAgICAgICAgZGVmaW5lRGVwcmVjYXRpb25XYXJuaW5nKGZuTmFtZSwgZGVwcmVjYXRlZEFQSXNbZm5OYW1lXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBDb21wb25lbnREdW1teSgpIHsKICAgICAgICAgIH0KICAgICAgICAgIENvbXBvbmVudER1bW15LnByb3RvdHlwZSA9IENvbXBvbmVudC5wcm90b3R5cGU7CiAgICAgICAgICBmdW5jdGlvbiBQdXJlQ29tcG9uZW50KHByb3BzLCBjb250ZXh0LCB1cGRhdGVyKSB7CiAgICAgICAgICAgIHRoaXMucHJvcHMgPSBwcm9wczsKICAgICAgICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dDsKICAgICAgICAgICAgdGhpcy5yZWZzID0gZW1wdHlPYmplY3Q7CiAgICAgICAgICAgIHRoaXMudXBkYXRlciA9IHVwZGF0ZXIgfHwgUmVhY3ROb29wVXBkYXRlUXVldWU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHVyZUNvbXBvbmVudFByb3RvdHlwZSA9IFB1cmVDb21wb25lbnQucHJvdG90eXBlID0gbmV3IENvbXBvbmVudER1bW15KCk7CiAgICAgICAgICBwdXJlQ29tcG9uZW50UHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUHVyZUNvbXBvbmVudDsKICAgICAgICAgIGFzc2lnbihwdXJlQ29tcG9uZW50UHJvdG90eXBlLCBDb21wb25lbnQucHJvdG90eXBlKTsKICAgICAgICAgIHB1cmVDb21wb25lbnRQcm90b3R5cGUuaXNQdXJlUmVhY3RDb21wb25lbnQgPSB0cnVlOwogICAgICAgICAgZnVuY3Rpb24gY3JlYXRlUmVmKCkgewogICAgICAgICAgICB2YXIgcmVmT2JqZWN0ID0gewogICAgICAgICAgICAgIGN1cnJlbnQ6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIE9iamVjdC5zZWFsKHJlZk9iamVjdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlZk9iamVjdDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpc0FycmF5SW1wbCA9IEFycmF5LmlzQXJyYXk7CiAgICAgICAgICBmdW5jdGlvbiBpc0FycmF5KGEyKSB7CiAgICAgICAgICAgIHJldHVybiBpc0FycmF5SW1wbChhMik7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB0eXBlTmFtZSh2YWx1ZSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIGhhc1RvU3RyaW5nVGFnID0gdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiBTeW1ib2wudG9TdHJpbmdUYWc7CiAgICAgICAgICAgICAgdmFyIHR5cGUyID0gaGFzVG9TdHJpbmdUYWcgJiYgdmFsdWVbU3ltYm9sLnRvU3RyaW5nVGFnXSB8fCB2YWx1ZS5jb25zdHJ1Y3Rvci5uYW1lIHx8ICJPYmplY3QiOwogICAgICAgICAgICAgIHJldHVybiB0eXBlMjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gd2lsbENvZXJjaW9uVGhyb3codmFsdWUpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiAiIiArIHZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY2hlY2tLZXlTdHJpbmdDb2VyY2lvbih2YWx1ZSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSBwcm92aWRlZCBrZXkgaXMgYW4gdW5zdXBwb3J0ZWQgdHlwZSAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHR5cGVOYW1lKHZhbHVlKSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldFdyYXBwZWROYW1lKG91dGVyVHlwZSwgaW5uZXJUeXBlLCB3cmFwcGVyTmFtZSkgewogICAgICAgICAgICB2YXIgZGlzcGxheU5hbWUgPSBvdXRlclR5cGUuZGlzcGxheU5hbWU7CiAgICAgICAgICAgIGlmIChkaXNwbGF5TmFtZSkgewogICAgICAgICAgICAgIHJldHVybiBkaXNwbGF5TmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZnVuY3Rpb25OYW1lID0gaW5uZXJUeXBlLmRpc3BsYXlOYW1lIHx8IGlubmVyVHlwZS5uYW1lIHx8ICIiOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb25OYW1lICE9PSAiIiA/IHdyYXBwZXJOYW1lICsgIigiICsgZnVuY3Rpb25OYW1lICsgIikiIDogd3JhcHBlck5hbWU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRDb250ZXh0TmFtZSh0eXBlMikgewogICAgICAgICAgICByZXR1cm4gdHlwZTIuZGlzcGxheU5hbWUgfHwgIkNvbnRleHQiOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUyKSB7CiAgICAgICAgICAgIGlmICh0eXBlMiA9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZTIudGFnID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgZXJyb3IoIlJlY2VpdmVkIGFuIHVuZXhwZWN0ZWQgb2JqZWN0IGluIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSgpLiBUaGlzIGlzIGxpa2VseSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZTIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICByZXR1cm4gdHlwZTIuZGlzcGxheU5hbWUgfHwgdHlwZTIubmFtZSB8fCBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZTIgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHR5cGUyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN3aXRjaCAodHlwZTIpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZSQUdNRU5UX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gIkZyYWdtZW50IjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuICJQb3J0YWwiOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPRklMRVJfVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiAiUHJvZmlsZXIiOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1RSSUNUX01PREVfVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiAiU3RyaWN0TW9kZSI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZSI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlTGlzdCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlMiA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKHR5cGUyLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0NPTlRFWFRfVFlQRToKICAgICAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB0eXBlMjsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lKGNvbnRleHQpICsgIi5Db25zdW1lciI7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BST1ZJREVSX1RZUEU6CiAgICAgICAgICAgICAgICAgIHZhciBwcm92aWRlciA9IHR5cGUyOwogICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUocHJvdmlkZXIuX2NvbnRleHQpICsgIi5Qcm92aWRlciI7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEU6CiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRXcmFwcGVkTmFtZSh0eXBlMiwgdHlwZTIucmVuZGVyLCAiRm9yd2FyZFJlZiIpOwogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEU6CiAgICAgICAgICAgICAgICAgIHZhciBvdXRlck5hbWUgPSB0eXBlMi5kaXNwbGF5TmFtZSB8fCBudWxsOwogICAgICAgICAgICAgICAgICBpZiAob3V0ZXJOYW1lICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG91dGVyTmFtZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUyLnR5cGUpIHx8ICJNZW1vIjsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gdHlwZTI7CiAgICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgICAgdmFyIGluaXQyID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGluaXQyKHBheWxvYWQpKTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICAgICAgICB2YXIgUkVTRVJWRURfUFJPUFMgPSB7CiAgICAgICAgICAgIGtleTogdHJ1ZSwKICAgICAgICAgICAgcmVmOiB0cnVlLAogICAgICAgICAgICBfX3NlbGY6IHRydWUsCiAgICAgICAgICAgIF9fc291cmNlOiB0cnVlCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHNwZWNpYWxQcm9wS2V5V2FybmluZ1Nob3duLCBzcGVjaWFsUHJvcFJlZldhcm5pbmdTaG93biwgZGlkV2FybkFib3V0U3RyaW5nUmVmczsKICAgICAgICAgIHsKICAgICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmcyA9IHt9OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaGFzVmFsaWRSZWYoY29uZmlnKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsICJyZWYiKSkgewogICAgICAgICAgICAgICAgdmFyIGdldHRlciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoY29uZmlnLCAicmVmIikuZ2V0OwogICAgICAgICAgICAgICAgaWYgKGdldHRlciAmJiBnZXR0ZXIuaXNSZWFjdFdhcm5pbmcpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY29uZmlnLnJlZiAhPT0gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaGFzVmFsaWRLZXkoY29uZmlnKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsICJrZXkiKSkgewogICAgICAgICAgICAgICAgdmFyIGdldHRlciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoY29uZmlnLCAia2V5IikuZ2V0OwogICAgICAgICAgICAgICAgaWYgKGdldHRlciAmJiBnZXR0ZXIuaXNSZWFjdFdhcm5pbmcpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY29uZmlnLmtleSAhPT0gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZGVmaW5lS2V5UHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICAgIHZhciB3YXJuQWJvdXRBY2Nlc3NpbmdLZXkgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIXNwZWNpYWxQcm9wS2V5V2FybmluZ1Nob3duKSB7CiAgICAgICAgICAgICAgICAgIHNwZWNpYWxQcm9wS2V5V2FybmluZ1Nob3duID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBga2V5YCBpcyBub3QgYSBwcm9wLiBUcnlpbmcgdG8gYWNjZXNzIGl0IHdpbGwgcmVzdWx0IGluIGB1bmRlZmluZWRgIGJlaW5nIHJldHVybmVkLiBJZiB5b3UgbmVlZCB0byBhY2Nlc3MgdGhlIHNhbWUgdmFsdWUgd2l0aGluIHRoZSBjaGlsZCBjb21wb25lbnQsIHlvdSBzaG91bGQgcGFzcyBpdCBhcyBhIGRpZmZlcmVudCBwcm9wLiAoaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3NwZWNpYWwtcHJvcHMpIiwgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgd2FybkFib3V0QWNjZXNzaW5nS2V5LmlzUmVhY3RXYXJuaW5nID0gdHJ1ZTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHByb3BzLCAia2V5IiwgewogICAgICAgICAgICAgIGdldDogd2FybkFib3V0QWNjZXNzaW5nS2V5LAogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGRlZmluZVJlZlByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSkgewogICAgICAgICAgICB2YXIgd2FybkFib3V0QWNjZXNzaW5nUmVmID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCFzcGVjaWFsUHJvcFJlZldhcm5pbmdTaG93bikgewogICAgICAgICAgICAgICAgICBzcGVjaWFsUHJvcFJlZldhcm5pbmdTaG93biA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGVycm9yKCIlczogYHJlZmAgaXMgbm90IGEgcHJvcC4gVHJ5aW5nIHRvIGFjY2VzcyBpdCB3aWxsIHJlc3VsdCBpbiBgdW5kZWZpbmVkYCBiZWluZyByZXR1cm5lZC4gSWYgeW91IG5lZWQgdG8gYWNjZXNzIHRoZSBzYW1lIHZhbHVlIHdpdGhpbiB0aGUgY2hpbGQgY29tcG9uZW50LCB5b3Ugc2hvdWxkIHBhc3MgaXQgYXMgYSBkaWZmZXJlbnQgcHJvcC4gKGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zcGVjaWFsLXByb3BzKSIsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHdhcm5BYm91dEFjY2Vzc2luZ1JlZi5pc1JlYWN0V2FybmluZyA9IHRydWU7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm9wcywgInJlZiIsIHsKICAgICAgICAgICAgICBnZXQ6IHdhcm5BYm91dEFjY2Vzc2luZ1JlZiwKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB3YXJuSWZTdHJpbmdSZWZDYW5ub3RCZUF1dG9Db252ZXJ0ZWQoY29uZmlnKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGNvbmZpZy5yZWYgPT09ICJzdHJpbmciICYmIFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQgJiYgY29uZmlnLl9fc2VsZiAmJiBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LnN0YXRlTm9kZSAhPT0gY29uZmlnLl9fc2VsZikgewogICAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoUmVhY3RDdXJyZW50T3duZXIuY3VycmVudC50eXBlKTsKICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0U3RyaW5nUmVmc1tjb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgICBlcnJvcignQ29tcG9uZW50ICIlcyIgY29udGFpbnMgdGhlIHN0cmluZyByZWYgIiVzIi4gU3VwcG9ydCBmb3Igc3RyaW5nIHJlZnMgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIFRoaXMgY2FzZSBjYW5ub3QgYmUgYXV0b21hdGljYWxseSBjb252ZXJ0ZWQgdG8gYW4gYXJyb3cgZnVuY3Rpb24uIFdlIGFzayB5b3UgdG8gbWFudWFsbHkgZml4IHRoaXMgY2FzZSBieSB1c2luZyB1c2VSZWYoKSBvciBjcmVhdGVSZWYoKSBpbnN0ZWFkLiBMZWFybiBtb3JlIGFib3V0IHVzaW5nIHJlZnMgc2FmZWx5IGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zdHJpY3QtbW9kZS1zdHJpbmctcmVmJywgY29tcG9uZW50TmFtZSwgY29uZmlnLnJlZik7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFN0cmluZ1JlZnNbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIFJlYWN0RWxlbWVudCA9IGZ1bmN0aW9uKHR5cGUyLCBrZXksIHJlZiwgc2VsZiwgc291cmNlLCBvd25lciwgcHJvcHMpIHsKICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSB7CiAgICAgICAgICAgICAgLy8gVGhpcyB0YWcgYWxsb3dzIHVzIHRvIHVuaXF1ZWx5IGlkZW50aWZ5IHRoaXMgYXMgYSBSZWFjdCBFbGVtZW50CiAgICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0VMRU1FTlRfVFlQRSwKICAgICAgICAgICAgICAvLyBCdWlsdC1pbiBwcm9wZXJ0aWVzIHRoYXQgYmVsb25nIG9uIHRoZSBlbGVtZW50CiAgICAgICAgICAgICAgdHlwZTogdHlwZTIsCiAgICAgICAgICAgICAga2V5LAogICAgICAgICAgICAgIHJlZiwKICAgICAgICAgICAgICBwcm9wcywKICAgICAgICAgICAgICAvLyBSZWNvcmQgdGhlIGNvbXBvbmVudCByZXNwb25zaWJsZSBmb3IgY3JlYXRpbmcgdGhpcyBlbGVtZW50LgogICAgICAgICAgICAgIF9vd25lcjogb3duZXIKICAgICAgICAgICAgfTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGVsZW1lbnQuX3N0b3JlID0ge307CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsZW1lbnQuX3N0b3JlLCAidmFsaWRhdGVkIiwgewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB2YWx1ZTogZmFsc2UKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudCwgIl9zZWxmIiwgewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgICAgd3JpdGFibGU6IGZhbHNlLAogICAgICAgICAgICAgICAgdmFsdWU6IHNlbGYKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudCwgIl9zb3VyY2UiLCB7CiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgICB3cml0YWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgICB2YWx1ZTogc291cmNlCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgaWYgKE9iamVjdC5mcmVlemUpIHsKICAgICAgICAgICAgICAgIE9iamVjdC5mcmVlemUoZWxlbWVudC5wcm9wcyk7CiAgICAgICAgICAgICAgICBPYmplY3QuZnJlZXplKGVsZW1lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICAgIH07CiAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVFbGVtZW50KHR5cGUyLCBjb25maWcsIGNoaWxkcmVuMikgewogICAgICAgICAgICB2YXIgcHJvcE5hbWU7CiAgICAgICAgICAgIHZhciBwcm9wcyA9IHt9OwogICAgICAgICAgICB2YXIga2V5ID0gbnVsbDsKICAgICAgICAgICAgdmFyIHJlZiA9IG51bGw7CiAgICAgICAgICAgIHZhciBzZWxmID0gbnVsbDsKICAgICAgICAgICAgdmFyIHNvdXJjZSA9IG51bGw7CiAgICAgICAgICAgIGlmIChjb25maWcgIT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChoYXNWYWxpZFJlZihjb25maWcpKSB7CiAgICAgICAgICAgICAgICByZWYgPSBjb25maWcucmVmOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICB3YXJuSWZTdHJpbmdSZWZDYW5ub3RCZUF1dG9Db252ZXJ0ZWQoY29uZmlnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGhhc1ZhbGlkS2V5KGNvbmZpZykpIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgY2hlY2tLZXlTdHJpbmdDb2VyY2lvbihjb25maWcua2V5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGtleSA9ICIiICsgY29uZmlnLmtleTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2VsZiA9IGNvbmZpZy5fX3NlbGYgPT09IHZvaWQgMCA/IG51bGwgOiBjb25maWcuX19zZWxmOwogICAgICAgICAgICAgIHNvdXJjZSA9IGNvbmZpZy5fX3NvdXJjZSA9PT0gdm9pZCAwID8gbnVsbCA6IGNvbmZpZy5fX3NvdXJjZTsKICAgICAgICAgICAgICBmb3IgKHByb3BOYW1lIGluIGNvbmZpZykgewogICAgICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoY29uZmlnLCBwcm9wTmFtZSkgJiYgIVJFU0VSVkVEX1BST1BTLmhhc093blByb3BlcnR5KHByb3BOYW1lKSkgewogICAgICAgICAgICAgICAgICBwcm9wc1twcm9wTmFtZV0gPSBjb25maWdbcHJvcE5hbWVdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2hpbGRyZW5MZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoIC0gMjsKICAgICAgICAgICAgaWYgKGNoaWxkcmVuTGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgICAgcHJvcHMuY2hpbGRyZW4gPSBjaGlsZHJlbjI7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2hpbGRyZW5MZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgdmFyIGNoaWxkQXJyYXkgPSBBcnJheShjaGlsZHJlbkxlbmd0aCk7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbkxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjaGlsZEFycmF5W2ldID0gYXJndW1lbnRzW2kgKyAyXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKE9iamVjdC5mcmVlemUpIHsKICAgICAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShjaGlsZEFycmF5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJvcHMuY2hpbGRyZW4gPSBjaGlsZEFycmF5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlMiAmJiB0eXBlMi5kZWZhdWx0UHJvcHMpIHsKICAgICAgICAgICAgICB2YXIgZGVmYXVsdFByb3BzID0gdHlwZTIuZGVmYXVsdFByb3BzOwogICAgICAgICAgICAgIGZvciAocHJvcE5hbWUgaW4gZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgICAgICBpZiAocHJvcHNbcHJvcE5hbWVdID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gZGVmYXVsdFByb3BzW3Byb3BOYW1lXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChrZXkgfHwgcmVmKSB7CiAgICAgICAgICAgICAgICB2YXIgZGlzcGxheU5hbWUgPSB0eXBlb2YgdHlwZTIgPT09ICJmdW5jdGlvbiIgPyB0eXBlMi5kaXNwbGF5TmFtZSB8fCB0eXBlMi5uYW1lIHx8ICJVbmtub3duIiA6IHR5cGUyOwogICAgICAgICAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICAgICAgICBkZWZpbmVLZXlQcm9wV2FybmluZ0dldHRlcihwcm9wcywgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHJlZikgewogICAgICAgICAgICAgICAgICBkZWZpbmVSZWZQcm9wV2FybmluZ0dldHRlcihwcm9wcywgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gUmVhY3RFbGVtZW50KHR5cGUyLCBrZXksIHJlZiwgc2VsZiwgc291cmNlLCBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LCBwcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjbG9uZUFuZFJlcGxhY2VLZXkob2xkRWxlbWVudCwgbmV3S2V5KSB7CiAgICAgICAgICAgIHZhciBuZXdFbGVtZW50ID0gUmVhY3RFbGVtZW50KG9sZEVsZW1lbnQudHlwZSwgbmV3S2V5LCBvbGRFbGVtZW50LnJlZiwgb2xkRWxlbWVudC5fc2VsZiwgb2xkRWxlbWVudC5fc291cmNlLCBvbGRFbGVtZW50Ll9vd25lciwgb2xkRWxlbWVudC5wcm9wcyk7CiAgICAgICAgICAgIHJldHVybiBuZXdFbGVtZW50OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY2xvbmVFbGVtZW50KGVsZW1lbnQsIGNvbmZpZywgY2hpbGRyZW4yKSB7CiAgICAgICAgICAgIGlmIChlbGVtZW50ID09PSBudWxsIHx8IGVsZW1lbnQgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVhY3QuY2xvbmVFbGVtZW50KC4uLik6IFRoZSBhcmd1bWVudCBtdXN0IGJlIGEgUmVhY3QgZWxlbWVudCwgYnV0IHlvdSBwYXNzZWQgIiArIGVsZW1lbnQgKyAiLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwcm9wTmFtZTsKICAgICAgICAgICAgdmFyIHByb3BzID0gYXNzaWduKHt9LCBlbGVtZW50LnByb3BzKTsKICAgICAgICAgICAgdmFyIGtleSA9IGVsZW1lbnQua2V5OwogICAgICAgICAgICB2YXIgcmVmID0gZWxlbWVudC5yZWY7CiAgICAgICAgICAgIHZhciBzZWxmID0gZWxlbWVudC5fc2VsZjsKICAgICAgICAgICAgdmFyIHNvdXJjZSA9IGVsZW1lbnQuX3NvdXJjZTsKICAgICAgICAgICAgdmFyIG93bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICAgIGlmIChjb25maWcgIT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChoYXNWYWxpZFJlZihjb25maWcpKSB7CiAgICAgICAgICAgICAgICByZWYgPSBjb25maWcucmVmOwogICAgICAgICAgICAgICAgb3duZXIgPSBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaGFzVmFsaWRLZXkoY29uZmlnKSkgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKGNvbmZpZy5rZXkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAga2V5ID0gIiIgKyBjb25maWcua2V5OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZGVmYXVsdFByb3BzOwogICAgICAgICAgICAgIGlmIChlbGVtZW50LnR5cGUgJiYgZWxlbWVudC50eXBlLmRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgICAgZGVmYXVsdFByb3BzID0gZWxlbWVudC50eXBlLmRlZmF1bHRQcm9wczsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm9yIChwcm9wTmFtZSBpbiBjb25maWcpIHsKICAgICAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgcHJvcE5hbWUpICYmICFSRVNFUlZFRF9QUk9QUy5oYXNPd25Qcm9wZXJ0eShwcm9wTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZ1twcm9wTmFtZV0gPT09IHZvaWQgMCAmJiBkZWZhdWx0UHJvcHMgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICAgIHByb3BzW3Byb3BOYW1lXSA9IGRlZmF1bHRQcm9wc1twcm9wTmFtZV07CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gY29uZmlnW3Byb3BOYW1lXTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2hpbGRyZW5MZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoIC0gMjsKICAgICAgICAgICAgaWYgKGNoaWxkcmVuTGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgICAgcHJvcHMuY2hpbGRyZW4gPSBjaGlsZHJlbjI7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2hpbGRyZW5MZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgdmFyIGNoaWxkQXJyYXkgPSBBcnJheShjaGlsZHJlbkxlbmd0aCk7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbkxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjaGlsZEFycmF5W2ldID0gYXJndW1lbnRzW2kgKyAyXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJvcHMuY2hpbGRyZW4gPSBjaGlsZEFycmF5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBSZWFjdEVsZW1lbnQoZWxlbWVudC50eXBlLCBrZXksIHJlZiwgc2VsZiwgc291cmNlLCBvd25lciwgcHJvcHMpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaXNWYWxpZEVsZW1lbnQob2JqZWN0KSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqZWN0ID09PSAib2JqZWN0IiAmJiBvYmplY3QgIT09IG51bGwgJiYgb2JqZWN0LiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgU0VQQVJBVE9SID0gIi4iOwogICAgICAgICAgdmFyIFNVQlNFUEFSQVRPUiA9ICI6IjsKICAgICAgICAgIGZ1bmN0aW9uIGVzY2FwZShrZXkpIHsKICAgICAgICAgICAgdmFyIGVzY2FwZVJlZ2V4ID0gL1s9Ol0vZzsKICAgICAgICAgICAgdmFyIGVzY2FwZXJMb29rdXAgPSB7CiAgICAgICAgICAgICAgIj0iOiAiPTAiLAogICAgICAgICAgICAgICI6IjogIj0yIgogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgZXNjYXBlZFN0cmluZyA9IGtleS5yZXBsYWNlKGVzY2FwZVJlZ2V4LCBmdW5jdGlvbihtYXRjaCkgewogICAgICAgICAgICAgIHJldHVybiBlc2NhcGVyTG9va3VwW21hdGNoXTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiAiJCIgKyBlc2NhcGVkU3RyaW5nOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRpZFdhcm5BYm91dE1hcHMgPSBmYWxzZTsKICAgICAgICAgIHZhciB1c2VyUHJvdmlkZWRLZXlFc2NhcGVSZWdleCA9IC9cLysvZzsKICAgICAgICAgIGZ1bmN0aW9uIGVzY2FwZVVzZXJQcm92aWRlZEtleSh0ZXh0KSB7CiAgICAgICAgICAgIHJldHVybiB0ZXh0LnJlcGxhY2UodXNlclByb3ZpZGVkS2V5RXNjYXBlUmVnZXgsICIkJi8iKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldEVsZW1lbnRLZXkoZWxlbWVudCwgaW5kZXgyKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZWxlbWVudCA9PT0gIm9iamVjdCIgJiYgZWxlbWVudCAhPT0gbnVsbCAmJiBlbGVtZW50LmtleSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tLZXlTdHJpbmdDb2VyY2lvbihlbGVtZW50LmtleSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBlc2NhcGUoIiIgKyBlbGVtZW50LmtleSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGluZGV4Mi50b1N0cmluZygzNik7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtYXBJbnRvQXJyYXkoY2hpbGRyZW4yLCBhcnJheTIsIGVzY2FwZWRQcmVmaXgsIG5hbWVTb0ZhciwgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIHR5cGUyID0gdHlwZW9mIGNoaWxkcmVuMjsKICAgICAgICAgICAgaWYgKHR5cGUyID09PSAidW5kZWZpbmVkIiB8fCB0eXBlMiA9PT0gImJvb2xlYW4iKSB7CiAgICAgICAgICAgICAgY2hpbGRyZW4yID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW52b2tlQ2FsbGJhY2sgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGNoaWxkcmVuMiA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGludm9rZUNhbGxiYWNrID0gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzd2l0Y2ggKHR5cGUyKSB7CiAgICAgICAgICAgICAgICBjYXNlICJzdHJpbmciOgogICAgICAgICAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgICAgICAgICAgaW52b2tlQ2FsbGJhY2sgPSB0cnVlOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgICAgIHN3aXRjaCAoY2hpbGRyZW4yLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9FTEVNRU5UX1RZUEU6CiAgICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRToKICAgICAgICAgICAgICAgICAgICAgIGludm9rZUNhbGxiYWNrID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW52b2tlQ2FsbGJhY2spIHsKICAgICAgICAgICAgICB2YXIgX2NoaWxkID0gY2hpbGRyZW4yOwogICAgICAgICAgICAgIHZhciBtYXBwZWRDaGlsZCA9IGNhbGxiYWNrKF9jaGlsZCk7CiAgICAgICAgICAgICAgdmFyIGNoaWxkS2V5ID0gbmFtZVNvRmFyID09PSAiIiA/IFNFUEFSQVRPUiArIGdldEVsZW1lbnRLZXkoX2NoaWxkLCAwKSA6IG5hbWVTb0ZhcjsKICAgICAgICAgICAgICBpZiAoaXNBcnJheShtYXBwZWRDaGlsZCkpIHsKICAgICAgICAgICAgICAgIHZhciBlc2NhcGVkQ2hpbGRLZXkgPSAiIjsKICAgICAgICAgICAgICAgIGlmIChjaGlsZEtleSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGVzY2FwZWRDaGlsZEtleSA9IGVzY2FwZVVzZXJQcm92aWRlZEtleShjaGlsZEtleSkgKyAiLyI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBtYXBJbnRvQXJyYXkobWFwcGVkQ2hpbGQsIGFycmF5MiwgZXNjYXBlZENoaWxkS2V5LCAiIiwgZnVuY3Rpb24oYzIpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGMyOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChtYXBwZWRDaGlsZCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNWYWxpZEVsZW1lbnQobWFwcGVkQ2hpbGQpKSB7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAobWFwcGVkQ2hpbGQua2V5ICYmICghX2NoaWxkIHx8IF9jaGlsZC5rZXkgIT09IG1hcHBlZENoaWxkLmtleSkpIHsKICAgICAgICAgICAgICAgICAgICAgIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24obWFwcGVkQ2hpbGQua2V5KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgbWFwcGVkQ2hpbGQgPSBjbG9uZUFuZFJlcGxhY2VLZXkoCiAgICAgICAgICAgICAgICAgICAgbWFwcGVkQ2hpbGQsCiAgICAgICAgICAgICAgICAgICAgLy8gS2VlcCBib3RoIHRoZSAobWFwcGVkKSBhbmQgb2xkIGtleXMgaWYgdGhleSBkaWZmZXIsIGp1c3QgYXMKICAgICAgICAgICAgICAgICAgICAvLyB0cmF2ZXJzZUFsbENoaWxkcmVuIHVzZWQgdG8gZG8gZm9yIG9iamVjdHMgYXMgY2hpbGRyZW4KICAgICAgICAgICAgICAgICAgICBlc2NhcGVkUHJlZml4ICsgLy8gJEZsb3dGaXhNZSBGbG93IGluY29ycmVjdGx5IHRoaW5rcyBSZWFjdC5Qb3J0YWwgZG9lc24ndCBoYXZlIGEga2V5CiAgICAgICAgICAgICAgICAgICAgKG1hcHBlZENoaWxkLmtleSAmJiAoIV9jaGlsZCB8fCBfY2hpbGQua2V5ICE9PSBtYXBwZWRDaGlsZC5rZXkpID8gKAogICAgICAgICAgICAgICAgICAgICAgLy8gJEZsb3dGaXhNZSBGbG93IGluY29ycmVjdGx5IHRoaW5rcyBleGlzdGluZyBlbGVtZW50J3Mga2V5IGNhbiBiZSBhIG51bWJlcgogICAgICAgICAgICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHJlYWN0LWludGVybmFsL3NhZmUtc3RyaW5nLWNvZXJjaW9uCiAgICAgICAgICAgICAgICAgICAgICBlc2NhcGVVc2VyUHJvdmlkZWRLZXkoIiIgKyBtYXBwZWRDaGlsZC5rZXkpICsgIi8iCiAgICAgICAgICAgICAgICAgICAgKSA6ICIiKSArIGNoaWxkS2V5CiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBhcnJheTIucHVzaChtYXBwZWRDaGlsZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjaGlsZDsKICAgICAgICAgICAgdmFyIG5leHROYW1lOwogICAgICAgICAgICB2YXIgc3VidHJlZUNvdW50ID0gMDsKICAgICAgICAgICAgdmFyIG5leHROYW1lUHJlZml4ID0gbmFtZVNvRmFyID09PSAiIiA/IFNFUEFSQVRPUiA6IG5hbWVTb0ZhciArIFNVQlNFUEFSQVRPUjsKICAgICAgICAgICAgaWYgKGlzQXJyYXkoY2hpbGRyZW4yKSkgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4yLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkcmVuMltpXTsKICAgICAgICAgICAgICAgIG5leHROYW1lID0gbmV4dE5hbWVQcmVmaXggKyBnZXRFbGVtZW50S2V5KGNoaWxkLCBpKTsKICAgICAgICAgICAgICAgIHN1YnRyZWVDb3VudCArPSBtYXBJbnRvQXJyYXkoY2hpbGQsIGFycmF5MiwgZXNjYXBlZFByZWZpeCwgbmV4dE5hbWUsIGNhbGxiYWNrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGl0ZXJhdG9yRm4gPSBnZXRJdGVyYXRvckZuKGNoaWxkcmVuMik7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVyYXRvckZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB2YXIgaXRlcmFibGVDaGlsZHJlbiA9IGNoaWxkcmVuMjsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKGl0ZXJhdG9yRm4gPT09IGl0ZXJhYmxlQ2hpbGRyZW4uZW50cmllcykgewogICAgICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0TWFwcykgewogICAgICAgICAgICAgICAgICAgICAgd2FybigiVXNpbmcgTWFwcyBhcyBjaGlsZHJlbiBpcyBub3Qgc3VwcG9ydGVkLiBVc2UgYW4gYXJyYXkgb2Yga2V5ZWQgUmVhY3RFbGVtZW50cyBpbnN0ZWFkLiIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNYXBzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGl0ZXJhdG9yID0gaXRlcmF0b3JGbi5jYWxsKGl0ZXJhYmxlQ2hpbGRyZW4pOwogICAgICAgICAgICAgICAgdmFyIHN0ZXA7CiAgICAgICAgICAgICAgICB2YXIgaWkgPSAwOwogICAgICAgICAgICAgICAgd2hpbGUgKCEoc3RlcCA9IGl0ZXJhdG9yLm5leHQoKSkuZG9uZSkgewogICAgICAgICAgICAgICAgICBjaGlsZCA9IHN0ZXAudmFsdWU7CiAgICAgICAgICAgICAgICAgIG5leHROYW1lID0gbmV4dE5hbWVQcmVmaXggKyBnZXRFbGVtZW50S2V5KGNoaWxkLCBpaSsrKTsKICAgICAgICAgICAgICAgICAgc3VidHJlZUNvdW50ICs9IG1hcEludG9BcnJheShjaGlsZCwgYXJyYXkyLCBlc2NhcGVkUHJlZml4LCBuZXh0TmFtZSwgY2FsbGJhY2spOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZTIgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICB2YXIgY2hpbGRyZW5TdHJpbmcgPSBTdHJpbmcoY2hpbGRyZW4yKTsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiT2JqZWN0cyBhcmUgbm90IHZhbGlkIGFzIGEgUmVhY3QgY2hpbGQgKGZvdW5kOiAiICsgKGNoaWxkcmVuU3RyaW5nID09PSAiW29iamVjdCBPYmplY3RdIiA/ICJvYmplY3Qgd2l0aCBrZXlzIHsiICsgT2JqZWN0LmtleXMoY2hpbGRyZW4yKS5qb2luKCIsICIpICsgIn0iIDogY2hpbGRyZW5TdHJpbmcpICsgIikuIElmIHlvdSBtZWFudCB0byByZW5kZXIgYSBjb2xsZWN0aW9uIG9mIGNoaWxkcmVuLCB1c2UgYW4gYXJyYXkgaW5zdGVhZC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN1YnRyZWVDb3VudDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG1hcENoaWxkcmVuKGNoaWxkcmVuMiwgZnVuYywgY29udGV4dCkgewogICAgICAgICAgICBpZiAoY2hpbGRyZW4yID09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gY2hpbGRyZW4yOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICAgICAgdmFyIGNvdW50ID0gMDsKICAgICAgICAgICAgbWFwSW50b0FycmF5KGNoaWxkcmVuMiwgcmVzdWx0LCAiIiwgIiIsIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbChjb250ZXh0LCBjaGlsZCwgY291bnQrKyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY291bnRDaGlsZHJlbihjaGlsZHJlbjIpIHsKICAgICAgICAgICAgdmFyIG4gPSAwOwogICAgICAgICAgICBtYXBDaGlsZHJlbihjaGlsZHJlbjIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIG4rKzsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBuOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZm9yRWFjaENoaWxkcmVuKGNoaWxkcmVuMiwgZm9yRWFjaEZ1bmMsIGZvckVhY2hDb250ZXh0KSB7CiAgICAgICAgICAgIG1hcENoaWxkcmVuKGNoaWxkcmVuMiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgZm9yRWFjaEZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgfSwgZm9yRWFjaENvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdG9BcnJheShjaGlsZHJlbjIpIHsKICAgICAgICAgICAgcmV0dXJuIG1hcENoaWxkcmVuKGNoaWxkcmVuMiwgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgICAgICAgIH0pIHx8IFtdOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gb25seUNoaWxkKGNoaWxkcmVuMikgewogICAgICAgICAgICBpZiAoIWlzVmFsaWRFbGVtZW50KGNoaWxkcmVuMikpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJlYWN0LkNoaWxkcmVuLm9ubHkgZXhwZWN0ZWQgdG8gcmVjZWl2ZSBhIHNpbmdsZSBSZWFjdCBlbGVtZW50IGNoaWxkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjaGlsZHJlbjI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVDb250ZXh0KGRlZmF1bHRWYWx1ZSkgewogICAgICAgICAgICB2YXIgY29udGV4dCA9IHsKICAgICAgICAgICAgICAkJHR5cGVvZjogUkVBQ1RfQ09OVEVYVF9UWVBFLAogICAgICAgICAgICAgIC8vIEFzIGEgd29ya2Fyb3VuZCB0byBzdXBwb3J0IG11bHRpcGxlIGNvbmN1cnJlbnQgcmVuZGVyZXJzLCB3ZSBjYXRlZ29yaXplCiAgICAgICAgICAgICAgLy8gc29tZSByZW5kZXJlcnMgYXMgcHJpbWFyeSBhbmQgb3RoZXJzIGFzIHNlY29uZGFyeS4gV2Ugb25seSBleHBlY3QKICAgICAgICAgICAgICAvLyB0aGVyZSB0byBiZSB0d28gY29uY3VycmVudCByZW5kZXJlcnMgYXQgbW9zdDogUmVhY3QgTmF0aXZlIChwcmltYXJ5KSBhbmQKICAgICAgICAgICAgICAvLyBGYWJyaWMgKHNlY29uZGFyeSk7IFJlYWN0IERPTSAocHJpbWFyeSkgYW5kIFJlYWN0IEFSVCAoc2Vjb25kYXJ5KS4KICAgICAgICAgICAgICAvLyBTZWNvbmRhcnkgcmVuZGVyZXJzIHN0b3JlIHRoZWlyIGNvbnRleHQgdmFsdWVzIG9uIHNlcGFyYXRlIGZpZWxkcy4KICAgICAgICAgICAgICBfY3VycmVudFZhbHVlOiBkZWZhdWx0VmFsdWUsCiAgICAgICAgICAgICAgX2N1cnJlbnRWYWx1ZTI6IGRlZmF1bHRWYWx1ZSwKICAgICAgICAgICAgICAvLyBVc2VkIHRvIHRyYWNrIGhvdyBtYW55IGNvbmN1cnJlbnQgcmVuZGVyZXJzIHRoaXMgY29udGV4dCBjdXJyZW50bHkKICAgICAgICAgICAgICAvLyBzdXBwb3J0cyB3aXRoaW4gaW4gYSBzaW5nbGUgcmVuZGVyZXIuIFN1Y2ggYXMgcGFyYWxsZWwgc2VydmVyIHJlbmRlcmluZy4KICAgICAgICAgICAgICBfdGhyZWFkQ291bnQ6IDAsCiAgICAgICAgICAgICAgLy8gVGhlc2UgYXJlIGNpcmN1bGFyCiAgICAgICAgICAgICAgUHJvdmlkZXI6IG51bGwsCiAgICAgICAgICAgICAgQ29uc3VtZXI6IG51bGwsCiAgICAgICAgICAgICAgLy8gQWRkIHRoZXNlIHRvIHVzZSBzYW1lIGhpZGRlbiBjbGFzcyBpbiBWTSBhcyBTZXJ2ZXJDb250ZXh0CiAgICAgICAgICAgICAgX2RlZmF1bHRWYWx1ZTogbnVsbCwKICAgICAgICAgICAgICBfZ2xvYmFsTmFtZTogbnVsbAogICAgICAgICAgICB9OwogICAgICAgICAgICBjb250ZXh0LlByb3ZpZGVyID0gewogICAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9QUk9WSURFUl9UWVBFLAogICAgICAgICAgICAgIF9jb250ZXh0OiBjb250ZXh0CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciBoYXNXYXJuZWRBYm91dFVzaW5nTmVzdGVkQ29udGV4dENvbnN1bWVycyA9IGZhbHNlOwogICAgICAgICAgICB2YXIgaGFzV2FybmVkQWJvdXRVc2luZ0NvbnN1bWVyUHJvdmlkZXIgPSBmYWxzZTsKICAgICAgICAgICAgdmFyIGhhc1dhcm5lZEFib3V0RGlzcGxheU5hbWVPbkNvbnN1bWVyID0gZmFsc2U7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgQ29uc3VtZXIgPSB7CiAgICAgICAgICAgICAgICAkJHR5cGVvZjogUkVBQ1RfQ09OVEVYVF9UWVBFLAogICAgICAgICAgICAgICAgX2NvbnRleHQ6IGNvbnRleHQKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKENvbnN1bWVyLCB7CiAgICAgICAgICAgICAgICBQcm92aWRlcjogewogICAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGlmICghaGFzV2FybmVkQWJvdXRVc2luZ0NvbnN1bWVyUHJvdmlkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgIGhhc1dhcm5lZEFib3V0VXNpbmdDb25zdW1lclByb3ZpZGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJSZW5kZXJpbmcgPENvbnRleHQuQ29uc3VtZXIuUHJvdmlkZXI+IGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBEaWQgeW91IG1lYW4gdG8gcmVuZGVyIDxDb250ZXh0LlByb3ZpZGVyPiBpbnN0ZWFkPyIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5Qcm92aWRlcjsKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihfUHJvdmlkZXIpIHsKICAgICAgICAgICAgICAgICAgICBjb250ZXh0LlByb3ZpZGVyID0gX1Byb3ZpZGVyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgX2N1cnJlbnRWYWx1ZTogewogICAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjb250ZXh0Ll9jdXJyZW50VmFsdWU7CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oX2N1cnJlbnRWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnRleHQuX2N1cnJlbnRWYWx1ZSA9IF9jdXJyZW50VmFsdWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBfY3VycmVudFZhbHVlMjogewogICAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjb250ZXh0Ll9jdXJyZW50VmFsdWUyOwogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKF9jdXJyZW50VmFsdWUyKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFZhbHVlMiA9IF9jdXJyZW50VmFsdWUyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgX3RocmVhZENvdW50OiB7CiAgICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuX3RocmVhZENvdW50OwogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKF90aHJlYWRDb3VudCkgewogICAgICAgICAgICAgICAgICAgIGNvbnRleHQuX3RocmVhZENvdW50ID0gX3RocmVhZENvdW50OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgQ29uc3VtZXI6IHsKICAgICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWhhc1dhcm5lZEFib3V0VXNpbmdOZXN0ZWRDb250ZXh0Q29uc3VtZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgICBoYXNXYXJuZWRBYm91dFVzaW5nTmVzdGVkQ29udGV4dENvbnN1bWVycyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiUmVuZGVyaW5nIDxDb250ZXh0LkNvbnN1bWVyLkNvbnN1bWVyPiBpcyBub3Qgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gRGlkIHlvdSBtZWFuIHRvIHJlbmRlciA8Q29udGV4dC5Db25zdW1lcj4gaW5zdGVhZD8iKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuQ29uc3VtZXI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBkaXNwbGF5TmFtZTogewogICAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjb250ZXh0LmRpc3BsYXlOYW1lOwogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFoYXNXYXJuZWRBYm91dERpc3BsYXlOYW1lT25Db25zdW1lcikgewogICAgICAgICAgICAgICAgICAgICAgd2FybigiU2V0dGluZyBgZGlzcGxheU5hbWVgIG9uIENvbnRleHQuQ29uc3VtZXIgaGFzIG5vIGVmZmVjdC4gWW91IHNob3VsZCBzZXQgaXQgZGlyZWN0bHkgb24gdGhlIGNvbnRleHQgd2l0aCBDb250ZXh0LmRpc3BsYXlOYW1lID0gJyVzJy4iLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICBoYXNXYXJuZWRBYm91dERpc3BsYXlOYW1lT25Db25zdW1lciA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgY29udGV4dC5Db25zdW1lciA9IENvbnN1bWVyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjb250ZXh0Ll9jdXJyZW50UmVuZGVyZXIgPSBudWxsOwogICAgICAgICAgICAgIGNvbnRleHQuX2N1cnJlbnRSZW5kZXJlcjIgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb250ZXh0OwogICAgICAgICAgfQogICAgICAgICAgdmFyIFVuaW5pdGlhbGl6ZWQgPSAtMTsKICAgICAgICAgIHZhciBQZW5kaW5nID0gMDsKICAgICAgICAgIHZhciBSZXNvbHZlZCA9IDE7CiAgICAgICAgICB2YXIgUmVqZWN0ZWQgPSAyOwogICAgICAgICAgZnVuY3Rpb24gbGF6eUluaXRpYWxpemVyKHBheWxvYWQpIHsKICAgICAgICAgICAgaWYgKHBheWxvYWQuX3N0YXR1cyA9PT0gVW5pbml0aWFsaXplZCkgewogICAgICAgICAgICAgIHZhciBjdG9yID0gcGF5bG9hZC5fcmVzdWx0OwogICAgICAgICAgICAgIHZhciB0aGVuYWJsZSA9IGN0b3IoKTsKICAgICAgICAgICAgICB0aGVuYWJsZS50aGVuKGZ1bmN0aW9uKG1vZHVsZU9iamVjdDIpIHsKICAgICAgICAgICAgICAgIGlmIChwYXlsb2FkLl9zdGF0dXMgPT09IFBlbmRpbmcgfHwgcGF5bG9hZC5fc3RhdHVzID09PSBVbmluaXRpYWxpemVkKSB7CiAgICAgICAgICAgICAgICAgIHZhciByZXNvbHZlZCA9IHBheWxvYWQ7CiAgICAgICAgICAgICAgICAgIHJlc29sdmVkLl9zdGF0dXMgPSBSZXNvbHZlZDsKICAgICAgICAgICAgICAgICAgcmVzb2x2ZWQuX3Jlc3VsdCA9IG1vZHVsZU9iamVjdDI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwgZnVuY3Rpb24oZXJyb3IyKSB7CiAgICAgICAgICAgICAgICBpZiAocGF5bG9hZC5fc3RhdHVzID09PSBQZW5kaW5nIHx8IHBheWxvYWQuX3N0YXR1cyA9PT0gVW5pbml0aWFsaXplZCkgewogICAgICAgICAgICAgICAgICB2YXIgcmVqZWN0ZWQgPSBwYXlsb2FkOwogICAgICAgICAgICAgICAgICByZWplY3RlZC5fc3RhdHVzID0gUmVqZWN0ZWQ7CiAgICAgICAgICAgICAgICAgIHJlamVjdGVkLl9yZXN1bHQgPSBlcnJvcjI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgaWYgKHBheWxvYWQuX3N0YXR1cyA9PT0gVW5pbml0aWFsaXplZCkgewogICAgICAgICAgICAgICAgdmFyIHBlbmRpbmcgPSBwYXlsb2FkOwogICAgICAgICAgICAgICAgcGVuZGluZy5fc3RhdHVzID0gUGVuZGluZzsKICAgICAgICAgICAgICAgIHBlbmRpbmcuX3Jlc3VsdCA9IHRoZW5hYmxlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocGF5bG9hZC5fc3RhdHVzID09PSBSZXNvbHZlZCkgewogICAgICAgICAgICAgIHZhciBtb2R1bGVPYmplY3QgPSBwYXlsb2FkLl9yZXN1bHQ7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKG1vZHVsZU9iamVjdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJsYXp5OiBFeHBlY3RlZCB0aGUgcmVzdWx0IG9mIGEgZHluYW1pYyBpbXBvcnQoKSBjYWxsLiBJbnN0ZWFkIHJlY2VpdmVkOiAlc1xuXG5Zb3VyIGNvZGUgc2hvdWxkIGxvb2sgbGlrZTogXG4gIGNvbnN0IE15Q29tcG9uZW50ID0gbGF6eSgoKSA9PiBpbXBvcnQoJy4vTXlDb21wb25lbnQnKSlcblxuRGlkIHlvdSBhY2NpZGVudGFsbHkgcHV0IGN1cmx5IGJyYWNlcyBhcm91bmQgdGhlIGltcG9ydD8iLCBtb2R1bGVPYmplY3QpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoISgiZGVmYXVsdCIgaW4gbW9kdWxlT2JqZWN0KSkgewogICAgICAgICAgICAgICAgICBlcnJvcigibGF6eTogRXhwZWN0ZWQgdGhlIHJlc3VsdCBvZiBhIGR5bmFtaWMgaW1wb3J0KCkgY2FsbC4gSW5zdGVhZCByZWNlaXZlZDogJXNcblxuWW91ciBjb2RlIHNob3VsZCBsb29rIGxpa2U6IFxuICBjb25zdCBNeUNvbXBvbmVudCA9IGxhenkoKCkgPT4gaW1wb3J0KCcuL015Q29tcG9uZW50JykpIiwgbW9kdWxlT2JqZWN0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIG1vZHVsZU9iamVjdC5kZWZhdWx0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRocm93IHBheWxvYWQuX3Jlc3VsdDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbGF6eShjdG9yKSB7CiAgICAgICAgICAgIHZhciBwYXlsb2FkID0gewogICAgICAgICAgICAgIC8vIFdlIHVzZSB0aGVzZSBmaWVsZHMgdG8gc3RvcmUgdGhlIHJlc3VsdC4KICAgICAgICAgICAgICBfc3RhdHVzOiBVbmluaXRpYWxpemVkLAogICAgICAgICAgICAgIF9yZXN1bHQ6IGN0b3IKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIGxhenlUeXBlID0gewogICAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9MQVpZX1RZUEUsCiAgICAgICAgICAgICAgX3BheWxvYWQ6IHBheWxvYWQsCiAgICAgICAgICAgICAgX2luaXQ6IGxhenlJbml0aWFsaXplcgogICAgICAgICAgICB9OwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIGRlZmF1bHRQcm9wczsKICAgICAgICAgICAgICB2YXIgcHJvcFR5cGVzOwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGxhenlUeXBlLCB7CiAgICAgICAgICAgICAgICBkZWZhdWx0UHJvcHM6IHsKICAgICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBkZWZhdWx0UHJvcHM7CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24obmV3RGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0LmxhenkoLi4uKTogSXQgaXMgbm90IHN1cHBvcnRlZCB0byBhc3NpZ24gYGRlZmF1bHRQcm9wc2AgdG8gYSBsYXp5IGNvbXBvbmVudCBpbXBvcnQuIEVpdGhlciBzcGVjaWZ5IHRoZW0gd2hlcmUgdGhlIGNvbXBvbmVudCBpcyBkZWZpbmVkLCBvciBjcmVhdGUgYSB3cmFwcGluZyBjb21wb25lbnQgYXJvdW5kIGl0LiIpOwogICAgICAgICAgICAgICAgICAgIGRlZmF1bHRQcm9wcyA9IG5ld0RlZmF1bHRQcm9wczsKICAgICAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobGF6eVR5cGUsICJkZWZhdWx0UHJvcHMiLCB7CiAgICAgICAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBwcm9wVHlwZXM6IHsKICAgICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm9wVHlwZXM7CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24obmV3UHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0LmxhenkoLi4uKTogSXQgaXMgbm90IHN1cHBvcnRlZCB0byBhc3NpZ24gYHByb3BUeXBlc2AgdG8gYSBsYXp5IGNvbXBvbmVudCBpbXBvcnQuIEVpdGhlciBzcGVjaWZ5IHRoZW0gd2hlcmUgdGhlIGNvbXBvbmVudCBpcyBkZWZpbmVkLCBvciBjcmVhdGUgYSB3cmFwcGluZyBjb21wb25lbnQgYXJvdW5kIGl0LiIpOwogICAgICAgICAgICAgICAgICAgIHByb3BUeXBlcyA9IG5ld1Byb3BUeXBlczsKICAgICAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobGF6eVR5cGUsICJwcm9wVHlwZXMiLCB7CiAgICAgICAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbGF6eVR5cGU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBmb3J3YXJkUmVmKHJlbmRlcikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHJlbmRlciAhPSBudWxsICYmIHJlbmRlci4kJHR5cGVvZiA9PT0gUkVBQ1RfTUVNT19UWVBFKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiZm9yd2FyZFJlZiByZXF1aXJlcyBhIHJlbmRlciBmdW5jdGlvbiBidXQgcmVjZWl2ZWQgYSBgbWVtb2AgY29tcG9uZW50LiBJbnN0ZWFkIG9mIGZvcndhcmRSZWYobWVtbyguLi4pKSwgdXNlIG1lbW8oZm9yd2FyZFJlZiguLi4pKS4iKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiByZW5kZXIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJmb3J3YXJkUmVmIHJlcXVpcmVzIGEgcmVuZGVyIGZ1bmN0aW9uIGJ1dCB3YXMgZ2l2ZW4gJXMuIiwgcmVuZGVyID09PSBudWxsID8gIm51bGwiIDogdHlwZW9mIHJlbmRlcik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChyZW5kZXIubGVuZ3RoICE9PSAwICYmIHJlbmRlci5sZW5ndGggIT09IDIpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoImZvcndhcmRSZWYgcmVuZGVyIGZ1bmN0aW9ucyBhY2NlcHQgZXhhY3RseSB0d28gcGFyYW1ldGVyczogcHJvcHMgYW5kIHJlZi4gJXMiLCByZW5kZXIubGVuZ3RoID09PSAxID8gIkRpZCB5b3UgZm9yZ2V0IHRvIHVzZSB0aGUgcmVmIHBhcmFtZXRlcj8iIDogIkFueSBhZGRpdGlvbmFsIHBhcmFtZXRlciB3aWxsIGJlIHVuZGVmaW5lZC4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHJlbmRlciAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAocmVuZGVyLmRlZmF1bHRQcm9wcyAhPSBudWxsIHx8IHJlbmRlci5wcm9wVHlwZXMgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBlcnJvcigiZm9yd2FyZFJlZiByZW5kZXIgZnVuY3Rpb25zIGRvIG5vdCBzdXBwb3J0IHByb3BUeXBlcyBvciBkZWZhdWx0UHJvcHMuIERpZCB5b3UgYWNjaWRlbnRhbGx5IHBhc3MgYSBSZWFjdCBjb21wb25lbnQ/Iik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBlbGVtZW50VHlwZSA9IHsKICAgICAgICAgICAgICAkJHR5cGVvZjogUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRSwKICAgICAgICAgICAgICByZW5kZXIKICAgICAgICAgICAgfTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBvd25OYW1lOwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50VHlwZSwgImRpc3BsYXlOYW1lIiwgewogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gb3duTmFtZTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgICAgICAgb3duTmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgICAgIGlmICghcmVuZGVyLm5hbWUgJiYgIXJlbmRlci5kaXNwbGF5TmFtZSkgewogICAgICAgICAgICAgICAgICAgIHJlbmRlci5kaXNwbGF5TmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZWxlbWVudFR5cGU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgUkVBQ1RfTU9EVUxFX1JFRkVSRU5DRTsKICAgICAgICAgIHsKICAgICAgICAgICAgUkVBQ1RfTU9EVUxFX1JFRkVSRU5DRSA9IFN5bWJvbC5mb3IoInJlYWN0Lm1vZHVsZS5yZWZlcmVuY2UiKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGlzVmFsaWRFbGVtZW50VHlwZSh0eXBlMikgewogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUyID09PSAic3RyaW5nIiB8fCB0eXBlb2YgdHlwZTIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZTIgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUgfHwgdHlwZTIgPT09IFJFQUNUX1BST0ZJTEVSX1RZUEUgfHwgZW5hYmxlRGVidWdUcmFjaW5nIHx8IHR5cGUyID09PSBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFIHx8IHR5cGUyID09PSBSRUFDVF9TVVNQRU5TRV9UWVBFIHx8IHR5cGUyID09PSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEUgfHwgZW5hYmxlTGVnYWN5SGlkZGVuIHx8IHR5cGUyID09PSBSRUFDVF9PRkZTQ1JFRU5fVFlQRSB8fCBlbmFibGVTY29wZUFQSSB8fCBlbmFibGVDYWNoZUVsZW1lbnQgfHwgZW5hYmxlVHJhbnNpdGlvblRyYWNpbmcpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUyID09PSAib2JqZWN0IiAmJiB0eXBlMiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmICh0eXBlMi4kJHR5cGVvZiA9PT0gUkVBQ1RfTEFaWV9UWVBFIHx8IHR5cGUyLiQkdHlwZW9mID09PSBSRUFDVF9NRU1PX1RZUEUgfHwgdHlwZTIuJCR0eXBlb2YgPT09IFJFQUNUX1BST1ZJREVSX1RZUEUgfHwgdHlwZTIuJCR0eXBlb2YgPT09IFJFQUNUX0NPTlRFWFRfVFlQRSB8fCB0eXBlMi4kJHR5cGVvZiA9PT0gUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRSB8fCAvLyBUaGlzIG5lZWRzIHRvIGluY2x1ZGUgYWxsIHBvc3NpYmxlIG1vZHVsZSByZWZlcmVuY2Ugb2JqZWN0CiAgICAgICAgICAgICAgLy8gdHlwZXMgc3VwcG9ydGVkIGJ5IGFueSBGbGlnaHQgY29uZmlndXJhdGlvbiBhbnl3aGVyZSBzaW5jZQogICAgICAgICAgICAgIC8vIHdlIGRvbid0IGtub3cgd2hpY2ggRmxpZ2h0IGJ1aWxkIHRoaXMgd2lsbCBlbmQgdXAgYmVpbmcgdXNlZAogICAgICAgICAgICAgIC8vIHdpdGguCiAgICAgICAgICAgICAgdHlwZTIuJCR0eXBlb2YgPT09IFJFQUNUX01PRFVMRV9SRUZFUkVOQ0UgfHwgdHlwZTIuZ2V0TW9kdWxlSWQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG1lbW8odHlwZTIsIGNvbXBhcmUpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghaXNWYWxpZEVsZW1lbnRUeXBlKHR5cGUyKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIm1lbW86IFRoZSBmaXJzdCBhcmd1bWVudCBtdXN0IGJlIGEgY29tcG9uZW50LiBJbnN0ZWFkIHJlY2VpdmVkOiAlcyIsIHR5cGUyID09PSBudWxsID8gIm51bGwiIDogdHlwZW9mIHR5cGUyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGVsZW1lbnRUeXBlID0gewogICAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9NRU1PX1RZUEUsCiAgICAgICAgICAgICAgdHlwZTogdHlwZTIsCiAgICAgICAgICAgICAgY29tcGFyZTogY29tcGFyZSA9PT0gdm9pZCAwID8gbnVsbCA6IGNvbXBhcmUKICAgICAgICAgICAgfTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBvd25OYW1lOwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50VHlwZSwgImRpc3BsYXlOYW1lIiwgewogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gb3duTmFtZTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgICAgICAgb3duTmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgICAgIGlmICghdHlwZTIubmFtZSAmJiAhdHlwZTIuZGlzcGxheU5hbWUpIHsKICAgICAgICAgICAgICAgICAgICB0eXBlMi5kaXNwbGF5TmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZWxlbWVudFR5cGU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZXNvbHZlRGlzcGF0Y2hlcigpIHsKICAgICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQ7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoZGlzcGF0Y2hlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgaG9vayBjYWxsLiBIb29rcyBjYW4gb25seSBiZSBjYWxsZWQgaW5zaWRlIG9mIHRoZSBib2R5IG9mIGEgZnVuY3Rpb24gY29tcG9uZW50LiBUaGlzIGNvdWxkIGhhcHBlbiBmb3Igb25lIG9mIHRoZSBmb2xsb3dpbmcgcmVhc29uczpcbjEuIFlvdSBtaWdodCBoYXZlIG1pc21hdGNoaW5nIHZlcnNpb25zIG9mIFJlYWN0IGFuZCB0aGUgcmVuZGVyZXIgKHN1Y2ggYXMgUmVhY3QgRE9NKVxuMi4gWW91IG1pZ2h0IGJlIGJyZWFraW5nIHRoZSBSdWxlcyBvZiBIb29rc1xuMy4gWW91IG1pZ2h0IGhhdmUgbW9yZSB0aGFuIG9uZSBjb3B5IG9mIFJlYWN0IGluIHRoZSBzYW1lIGFwcFxuU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9pbnZhbGlkLWhvb2stY2FsbCBmb3IgdGlwcyBhYm91dCBob3cgdG8gZGVidWcgYW5kIGZpeCB0aGlzIHByb2JsZW0uIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXNlQ29udGV4dChDb250ZXh0KSB7CiAgICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChDb250ZXh0Ll9jb250ZXh0ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHZhciByZWFsQ29udGV4dCA9IENvbnRleHQuX2NvbnRleHQ7CiAgICAgICAgICAgICAgICBpZiAocmVhbENvbnRleHQuQ29uc3VtZXIgPT09IENvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIkNhbGxpbmcgdXNlQ29udGV4dChDb250ZXh0LkNvbnN1bWVyKSBpcyBub3Qgc3VwcG9ydGVkLCBtYXkgY2F1c2UgYnVncywgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBEaWQgeW91IG1lYW4gdG8gY2FsbCB1c2VDb250ZXh0KENvbnRleHQpIGluc3RlYWQ/Iik7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJlYWxDb250ZXh0LlByb3ZpZGVyID09PSBDb250ZXh0KSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJDYWxsaW5nIHVzZUNvbnRleHQoQ29udGV4dC5Qcm92aWRlcikgaXMgbm90IHN1cHBvcnRlZC4gRGlkIHlvdSBtZWFuIHRvIGNhbGwgdXNlQ29udGV4dChDb250ZXh0KSBpbnN0ZWFkPyIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VDb250ZXh0KENvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXNlU3RhdGUzKGluaXRpYWxTdGF0ZSkgewogICAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZVN0YXRlKGluaXRpYWxTdGF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1c2VSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQyKSB7CiAgICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlUmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0Mik7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1c2VSZWYyKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZVJlZihpbml0aWFsVmFsdWUpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXNlRWZmZWN0MyhjcmVhdGUyLCBkZXBzKSB7CiAgICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlRWZmZWN0KGNyZWF0ZTIsIGRlcHMpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXNlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZTIsIGRlcHMpIHsKICAgICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VJbnNlcnRpb25FZmZlY3QoY3JlYXRlMiwgZGVwcyk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1c2VMYXlvdXRFZmZlY3QoY3JlYXRlMiwgZGVwcykgewogICAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZUxheW91dEVmZmVjdChjcmVhdGUyLCBkZXBzKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVzZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlQ2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXNlTWVtbyhjcmVhdGUyLCBkZXBzKSB7CiAgICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlTWVtbyhjcmVhdGUyLCBkZXBzKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVzZUltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUyLCBkZXBzKSB7CiAgICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZTIsIGRlcHMpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXNlRGVidWdWYWx1ZSh2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VEZWJ1Z1ZhbHVlKHZhbHVlLCBmb3JtYXR0ZXJGbik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVzZVRyYW5zaXRpb24oKSB7CiAgICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlVHJhbnNpdGlvbigpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXNlRGVmZXJyZWRWYWx1ZSh2YWx1ZSkgewogICAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZURlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXNlSWQoKSB7CiAgICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlSWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVzZVN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlU3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRpc2FibGVkRGVwdGggPSAwOwogICAgICAgICAgdmFyIHByZXZMb2c7CiAgICAgICAgICB2YXIgcHJldkluZm87CiAgICAgICAgICB2YXIgcHJldldhcm47CiAgICAgICAgICB2YXIgcHJldkVycm9yOwogICAgICAgICAgdmFyIHByZXZHcm91cDsKICAgICAgICAgIHZhciBwcmV2R3JvdXBDb2xsYXBzZWQ7CiAgICAgICAgICB2YXIgcHJldkdyb3VwRW5kOwogICAgICAgICAgZnVuY3Rpb24gZGlzYWJsZWRMb2coKSB7CiAgICAgICAgICB9CiAgICAgICAgICBkaXNhYmxlZExvZy5fX3JlYWN0RGlzYWJsZWRMb2cgPSB0cnVlOwogICAgICAgICAgZnVuY3Rpb24gZGlzYWJsZUxvZ3MoKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgcHJldkxvZyA9IGNvbnNvbGUubG9nOwogICAgICAgICAgICAgICAgcHJldkluZm8gPSBjb25zb2xlLmluZm87CiAgICAgICAgICAgICAgICBwcmV2V2FybiA9IGNvbnNvbGUud2FybjsKICAgICAgICAgICAgICAgIHByZXZFcnJvciA9IGNvbnNvbGUuZXJyb3I7CiAgICAgICAgICAgICAgICBwcmV2R3JvdXAgPSBjb25zb2xlLmdyb3VwOwogICAgICAgICAgICAgICAgcHJldkdyb3VwQ29sbGFwc2VkID0gY29uc29sZS5ncm91cENvbGxhcHNlZDsKICAgICAgICAgICAgICAgIHByZXZHcm91cEVuZCA9IGNvbnNvbGUuZ3JvdXBFbmQ7CiAgICAgICAgICAgICAgICB2YXIgcHJvcHMgPSB7CiAgICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgICAgdmFsdWU6IGRpc2FibGVkTG9nLAogICAgICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGNvbnNvbGUsIHsKICAgICAgICAgICAgICAgICAgaW5mbzogcHJvcHMsCiAgICAgICAgICAgICAgICAgIGxvZzogcHJvcHMsCiAgICAgICAgICAgICAgICAgIHdhcm46IHByb3BzLAogICAgICAgICAgICAgICAgICBlcnJvcjogcHJvcHMsCiAgICAgICAgICAgICAgICAgIGdyb3VwOiBwcm9wcywKICAgICAgICAgICAgICAgICAgZ3JvdXBDb2xsYXBzZWQ6IHByb3BzLAogICAgICAgICAgICAgICAgICBncm91cEVuZDogcHJvcHMKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkaXNhYmxlZERlcHRoKys7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlZW5hYmxlTG9ncygpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGRpc2FibGVkRGVwdGgtLTsKICAgICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgdmFyIHByb3BzID0gewogICAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoY29uc29sZSwgewogICAgICAgICAgICAgICAgICBsb2c6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkxvZwogICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgaW5mbzogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2SW5mbwogICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgd2FybjogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2V2FybgogICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgZXJyb3I6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkVycm9yCiAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICBncm91cDogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2R3JvdXAKICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgIGdyb3VwQ29sbGFwc2VkOiBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cENvbGxhcHNlZAogICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgZ3JvdXBFbmQ6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwRW5kCiAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPCAwKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiZGlzYWJsZWREZXB0aCBmZWxsIGJlbG93IHplcm8uIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudERpc3BhdGNoZXI7CiAgICAgICAgICB2YXIgcHJlZml4OwogICAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUobmFtZSwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAocHJlZml4ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSB4Mi5zdGFjay50cmltKCkubWF0Y2goL1xuKCAqKGF0ICk/KS8pOwogICAgICAgICAgICAgICAgICBwcmVmaXggPSBtYXRjaCAmJiBtYXRjaFsxXSB8fCAiIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuICJcbiIgKyBwcmVmaXggKyBuYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcmVlbnRyeSA9IGZhbHNlOwogICAgICAgICAgdmFyIGNvbXBvbmVudEZyYW1lQ2FjaGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBQb3NzaWJseVdlYWtNYXAgPSB0eXBlb2YgV2Vha01hcCA9PT0gImZ1bmN0aW9uIiA/IFdlYWtNYXAgOiBNYXA7CiAgICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUgPSBuZXcgUG9zc2libHlXZWFrTWFwKCk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKGZuLCBjb25zdHJ1Y3QpIHsKICAgICAgICAgICAgaWYgKCFmbiB8fCByZWVudHJ5KSB7CiAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgZnJhbWUyID0gY29tcG9uZW50RnJhbWVDYWNoZS5nZXQoZm4pOwogICAgICAgICAgICAgIGlmIChmcmFtZTIgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZyYW1lMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNvbnRyb2w7CiAgICAgICAgICAgIHJlZW50cnkgPSB0cnVlOwogICAgICAgICAgICB2YXIgcHJldmlvdXNQcmVwYXJlU3RhY2tUcmFjZSA9IEVycm9yLnByZXBhcmVTdGFja1RyYWNlOwogICAgICAgICAgICBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZSA9IHZvaWQgMDsKICAgICAgICAgICAgdmFyIHByZXZpb3VzRGlzcGF0Y2hlcjsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHByZXZpb3VzRGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgICBkaXNhYmxlTG9ncygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaWYgKGNvbnN0cnVjdCkgewogICAgICAgICAgICAgICAgdmFyIEZha2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRmFrZS5wcm90b3R5cGUsICJwcm9wcyIsIHsKICAgICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gIm9iamVjdCIgJiYgUmVmbGVjdC5jb25zdHJ1Y3QpIHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBSZWZsZWN0LmNvbnN0cnVjdChGYWtlLCBbXSk7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgICAgY29udHJvbCA9IHgyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIFJlZmxlY3QuY29uc3RydWN0KGZuLCBbXSwgRmFrZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIEZha2UuY2FsbCgpOwogICAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICAgIGNvbnRyb2wgPSB4MjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBmbi5jYWxsKEZha2UucHJvdG90eXBlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRyb2wgPSB4MjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoIChzYW1wbGUpIHsKICAgICAgICAgICAgICBpZiAoc2FtcGxlICYmIGNvbnRyb2wgJiYgdHlwZW9mIHNhbXBsZS5zdGFjayA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHZhciBzYW1wbGVMaW5lcyA9IHNhbXBsZS5zdGFjay5zcGxpdCgiXG4iKTsKICAgICAgICAgICAgICAgIHZhciBjb250cm9sTGluZXMgPSBjb250cm9sLnN0YWNrLnNwbGl0KCJcbiIpOwogICAgICAgICAgICAgICAgdmFyIHMgPSBzYW1wbGVMaW5lcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgdmFyIGMyID0gY29udHJvbExpbmVzLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgICB3aGlsZSAocyA+PSAxICYmIGMyID49IDAgJiYgc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjMl0pIHsKICAgICAgICAgICAgICAgICAgYzItLTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvciAoOyBzID49IDEgJiYgYzIgPj0gMDsgcy0tLCBjMi0tKSB7CiAgICAgICAgICAgICAgICAgIGlmIChzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2MyXSkgewogICAgICAgICAgICAgICAgICAgIGlmIChzICE9PSAxIHx8IGMyICE9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgIHMtLTsKICAgICAgICAgICAgICAgICAgICAgICAgYzItLTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGMyIDwgMCB8fCBzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2MyXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfZnJhbWUgPSAiXG4iICsgc2FtcGxlTGluZXNbc10ucmVwbGFjZSgiIGF0IG5ldyAiLCAiIGF0ICIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbi5kaXNwbGF5TmFtZSAmJiBfZnJhbWUuaW5jbHVkZXMoIjxhbm9ueW1vdXM+IikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9mcmFtZSA9IF9mcmFtZS5yZXBsYWNlKCI8YW5vbnltb3VzPiIsIGZuLmRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlLnNldChmbiwgX2ZyYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9mcmFtZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAocyA+PSAxICYmIGMyID49IDApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICByZWVudHJ5ID0gZmFsc2U7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2aW91c0Rpc3BhdGNoZXI7CiAgICAgICAgICAgICAgICByZWVuYWJsZUxvZ3MoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgRXJyb3IucHJlcGFyZVN0YWNrVHJhY2UgPSBwcmV2aW91c1ByZXBhcmVTdGFja1RyYWNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBuYW1lID0gZm4gPyBmbi5kaXNwbGF5TmFtZSB8fCBmbi5uYW1lIDogIiI7CiAgICAgICAgICAgIHZhciBzeW50aGV0aWNGcmFtZSA9IG5hbWUgPyBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZShuYW1lKSA6ICIiOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZS5zZXQoZm4sIHN5bnRoZXRpY0ZyYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN5bnRoZXRpY0ZyYW1lOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKGZuLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKGZuLCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHNob3VsZENvbnN0cnVjdChDb21wb25lbnQyKSB7CiAgICAgICAgICAgIHZhciBwcm90b3R5cGUgPSBDb21wb25lbnQyLnByb3RvdHlwZTsKICAgICAgICAgICAgcmV0dXJuICEhKHByb3RvdHlwZSAmJiBwcm90b3R5cGUuaXNSZWFjdENvbXBvbmVudCk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYodHlwZTIsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgICBpZiAodHlwZTIgPT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUodHlwZTIsIHNob3VsZENvbnN0cnVjdCh0eXBlMikpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUyID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSh0eXBlMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3dpdGNoICh0eXBlMikgewogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2UiKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2VMaXN0Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlMiA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKHR5cGUyLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEU6CiAgICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUZ1bmN0aW9uQ29tcG9uZW50RnJhbWUodHlwZTIucmVuZGVyKTsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTUVNT19UWVBFOgogICAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKHR5cGUyLnR5cGUsIHNvdXJjZSwgb3duZXJGbik7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgICB2YXIgbGF6eUNvbXBvbmVudCA9IHR5cGUyOwogICAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IGxhenlDb21wb25lbnQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICAgIHZhciBpbml0MiA9IGxhenlDb21wb25lbnQuX2luaXQ7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihpbml0MihwYXlsb2FkKSwgc291cmNlLCBvd25lckZuKTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbG9nZ2VkVHlwZUZhaWx1cmVzID0ge307CiAgICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChlbGVtZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICAgIHZhciBzdGFjayA9IGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihlbGVtZW50LnR5cGUsIGVsZW1lbnQuX3NvdXJjZSwgb3duZXIgPyBvd25lci50eXBlIDogbnVsbCk7CiAgICAgICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEuc2V0RXh0cmFTdGFja0ZyYW1lKHN0YWNrKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxLnNldEV4dHJhU3RhY2tGcmFtZShudWxsKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNoZWNrUHJvcFR5cGVzKHR5cGVTcGVjcywgdmFsdWVzLCBsb2NhdGlvbiwgY29tcG9uZW50TmFtZSwgZWxlbWVudCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIGhhcyA9IEZ1bmN0aW9uLmNhbGwuYmluZChoYXNPd25Qcm9wZXJ0eSk7CiAgICAgICAgICAgICAgZm9yICh2YXIgdHlwZVNwZWNOYW1lIGluIHR5cGVTcGVjcykgewogICAgICAgICAgICAgICAgaWYgKGhhcyh0eXBlU3BlY3MsIHR5cGVTcGVjTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgdmFyIGVycm9yJDEgPSB2b2lkIDA7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGVyciA9IEVycm9yKChjb21wb25lbnROYW1lIHx8ICJSZWFjdCBjbGFzcyIpICsgIjogIiArIGxvY2F0aW9uICsgIiB0eXBlIGAiICsgdHlwZVNwZWNOYW1lICsgImAgaXMgaW52YWxpZDsgaXQgbXVzdCBiZSBhIGZ1bmN0aW9uLCB1c3VhbGx5IGZyb20gdGhlIGBwcm9wLXR5cGVzYCBwYWNrYWdlLCBidXQgcmVjZWl2ZWQgYCIgKyB0eXBlb2YgdHlwZVNwZWNzW3R5cGVTcGVjTmFtZV0gKyAiYC5UaGlzIG9mdGVuIGhhcHBlbnMgYmVjYXVzZSBvZiB0eXBvcyBzdWNoIGFzIGBQcm9wVHlwZXMuZnVuY3Rpb25gIGluc3RlYWQgb2YgYFByb3BUeXBlcy5mdW5jYC4iKTsKICAgICAgICAgICAgICAgICAgICAgIGVyci5uYW1lID0gIkludmFyaWFudCBWaW9sYXRpb24iOwogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlcnJvciQxID0gdHlwZVNwZWNzW3R5cGVTcGVjTmFtZV0odmFsdWVzLCB0eXBlU3BlY05hbWUsIGNvbXBvbmVudE5hbWUsIGxvY2F0aW9uLCBudWxsLCAiU0VDUkVUX0RPX05PVF9QQVNTX1RISVNfT1JfWU9VX1dJTExfQkVfRklSRUQiKTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICAgICAgICAgICAgICBlcnJvciQxID0gZXg7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKGVycm9yJDEgJiYgIShlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IpKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzOiB0eXBlIHNwZWNpZmljYXRpb24gb2YgJXMgYCVzYCBpcyBpbnZhbGlkOyB0aGUgdHlwZSBjaGVja2VyIGZ1bmN0aW9uIG11c3QgcmV0dXJuIGBudWxsYCBvciBhbiBgRXJyb3JgIGJ1dCByZXR1cm5lZCBhICVzLiBZb3UgbWF5IGhhdmUgZm9yZ290dGVuIHRvIHBhc3MgYW4gYXJndW1lbnQgdG8gdGhlIHR5cGUgY2hlY2tlciBjcmVhdG9yIChhcnJheU9mLCBpbnN0YW5jZU9mLCBvYmplY3RPZiwgb25lT2YsIG9uZU9mVHlwZSwgYW5kIHNoYXBlIGFsbCByZXF1aXJlIGFuIGFyZ3VtZW50KS4iLCBjb21wb25lbnROYW1lIHx8ICJSZWFjdCBjbGFzcyIsIGxvY2F0aW9uLCB0eXBlU3BlY05hbWUsIHR5cGVvZiBlcnJvciQxKTsKICAgICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChudWxsKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoZXJyb3IkMSBpbnN0YW5jZW9mIEVycm9yICYmICEoZXJyb3IkMS5tZXNzYWdlIGluIGxvZ2dlZFR5cGVGYWlsdXJlcykpIHsKICAgICAgICAgICAgICAgICAgICBsb2dnZWRUeXBlRmFpbHVyZXNbZXJyb3IkMS5tZXNzYWdlXSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkZhaWxlZCAlcyB0eXBlOiAlcyIsIGxvY2F0aW9uLCBlcnJvciQxLm1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGVsZW1lbnQpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChlbGVtZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICAgIHZhciBzdGFjayA9IGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihlbGVtZW50LnR5cGUsIGVsZW1lbnQuX3NvdXJjZSwgb3duZXIgPyBvd25lci50eXBlIDogbnVsbCk7CiAgICAgICAgICAgICAgICBzZXRFeHRyYVN0YWNrRnJhbWUoc3RhY2spOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzZXRFeHRyYVN0YWNrRnJhbWUobnVsbCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd247CiAgICAgICAgICB7CiAgICAgICAgICAgIHByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKSB7CiAgICAgICAgICAgIGlmIChSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50KSB7CiAgICAgICAgICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoUmVhY3RDdXJyZW50T3duZXIuY3VycmVudC50eXBlKTsKICAgICAgICAgICAgICBpZiAobmFtZSkgewogICAgICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgYCIgKyBuYW1lICsgImAuIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0U291cmNlSW5mb0Vycm9yQWRkZW5kdW0oc291cmNlKSB7CiAgICAgICAgICAgIGlmIChzb3VyY2UgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHZhciBmaWxlTmFtZSA9IHNvdXJjZS5maWxlTmFtZS5yZXBsYWNlKC9eLipbXFxcL10vLCAiIik7CiAgICAgICAgICAgICAgdmFyIGxpbmVOdW1iZXIgPSBzb3VyY2UubGluZU51bWJlcjsKICAgICAgICAgICAgICByZXR1cm4gIlxuXG5DaGVjayB5b3VyIGNvZGUgYXQgIiArIGZpbGVOYW1lICsgIjoiICsgbGluZU51bWJlciArICIuIjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRTb3VyY2VJbmZvRXJyb3JBZGRlbmR1bUZvclByb3BzKGVsZW1lbnRQcm9wcykgewogICAgICAgICAgICBpZiAoZWxlbWVudFByb3BzICE9PSBudWxsICYmIGVsZW1lbnRQcm9wcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdldFNvdXJjZUluZm9FcnJvckFkZGVuZHVtKGVsZW1lbnRQcm9wcy5fX3NvdXJjZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG93bmVySGFzS2V5VXNlV2FybmluZyA9IHt9OwogICAgICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudENvbXBvbmVudEVycm9ySW5mbyhwYXJlbnRUeXBlKSB7CiAgICAgICAgICAgIHZhciBpbmZvID0gZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCk7CiAgICAgICAgICAgIGlmICghaW5mbykgewogICAgICAgICAgICAgIHZhciBwYXJlbnROYW1lID0gdHlwZW9mIHBhcmVudFR5cGUgPT09ICJzdHJpbmciID8gcGFyZW50VHlwZSA6IHBhcmVudFR5cGUuZGlzcGxheU5hbWUgfHwgcGFyZW50VHlwZS5uYW1lOwogICAgICAgICAgICAgIGlmIChwYXJlbnROYW1lKSB7CiAgICAgICAgICAgICAgICBpbmZvID0gIlxuXG5DaGVjayB0aGUgdG9wLWxldmVsIHJlbmRlciBjYWxsIHVzaW5nIDwiICsgcGFyZW50TmFtZSArICI+LiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBpbmZvOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVFeHBsaWNpdEtleShlbGVtZW50LCBwYXJlbnRUeXBlKSB7CiAgICAgICAgICAgIGlmICghZWxlbWVudC5fc3RvcmUgfHwgZWxlbWVudC5fc3RvcmUudmFsaWRhdGVkIHx8IGVsZW1lbnQua2V5ICE9IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxlbWVudC5fc3RvcmUudmFsaWRhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIGN1cnJlbnRDb21wb25lbnRFcnJvckluZm8gPSBnZXRDdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvKHBhcmVudFR5cGUpOwogICAgICAgICAgICBpZiAob3duZXJIYXNLZXlVc2VXYXJuaW5nW2N1cnJlbnRDb21wb25lbnRFcnJvckluZm9dKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG93bmVySGFzS2V5VXNlV2FybmluZ1tjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvXSA9IHRydWU7CiAgICAgICAgICAgIHZhciBjaGlsZE93bmVyID0gIiI7CiAgICAgICAgICAgIGlmIChlbGVtZW50ICYmIGVsZW1lbnQuX293bmVyICYmIGVsZW1lbnQuX293bmVyICE9PSBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50KSB7CiAgICAgICAgICAgICAgY2hpbGRPd25lciA9ICIgSXQgd2FzIHBhc3NlZCBhIGNoaWxkIGZyb20gIiArIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShlbGVtZW50Ll9vd25lci50eXBlKSArICIuIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShlbGVtZW50KTsKICAgICAgICAgICAgICBlcnJvcignRWFjaCBjaGlsZCBpbiBhIGxpc3Qgc2hvdWxkIGhhdmUgYSB1bmlxdWUgImtleSIgcHJvcC4lcyVzIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvd2FybmluZy1rZXlzIGZvciBtb3JlIGluZm9ybWF0aW9uLicsIGN1cnJlbnRDb21wb25lbnRFcnJvckluZm8sIGNoaWxkT3duZXIpOwogICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlQ2hpbGRLZXlzKG5vZGUsIHBhcmVudFR5cGUpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBub2RlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNBcnJheShub2RlKSkgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gbm9kZVtpXTsKICAgICAgICAgICAgICAgIGlmIChpc1ZhbGlkRWxlbWVudChjaGlsZCkpIHsKICAgICAgICAgICAgICAgICAgdmFsaWRhdGVFeHBsaWNpdEtleShjaGlsZCwgcGFyZW50VHlwZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGlzVmFsaWRFbGVtZW50KG5vZGUpKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUuX3N0b3JlKSB7CiAgICAgICAgICAgICAgICBub2RlLl9zdG9yZS52YWxpZGF0ZWQgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlKSB7CiAgICAgICAgICAgICAgdmFyIGl0ZXJhdG9yRm4gPSBnZXRJdGVyYXRvckZuKG5vZGUpOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgaXRlcmF0b3JGbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgaWYgKGl0ZXJhdG9yRm4gIT09IG5vZGUuZW50cmllcykgewogICAgICAgICAgICAgICAgICB2YXIgaXRlcmF0b3IgPSBpdGVyYXRvckZuLmNhbGwobm9kZSk7CiAgICAgICAgICAgICAgICAgIHZhciBzdGVwOwogICAgICAgICAgICAgICAgICB3aGlsZSAoIShzdGVwID0gaXRlcmF0b3IubmV4dCgpKS5kb25lKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzVmFsaWRFbGVtZW50KHN0ZXAudmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YWxpZGF0ZUV4cGxpY2l0S2V5KHN0ZXAudmFsdWUsIHBhcmVudFR5cGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wVHlwZXMoZWxlbWVudCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIHR5cGUyID0gZWxlbWVudC50eXBlOwogICAgICAgICAgICAgIGlmICh0eXBlMiA9PT0gbnVsbCB8fCB0eXBlMiA9PT0gdm9pZCAwIHx8IHR5cGVvZiB0eXBlMiA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHByb3BUeXBlczsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBwcm9wVHlwZXMgPSB0eXBlMi5wcm9wVHlwZXM7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdHlwZTIgPT09ICJvYmplY3QiICYmICh0eXBlMi4kJHR5cGVvZiA9PT0gUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRSB8fCAvLyBOb3RlOiBNZW1vIG9ubHkgY2hlY2tzIG91dGVyIHByb3BzIGhlcmUuCiAgICAgICAgICAgICAgLy8gSW5uZXIgcHJvcHMgYXJlIGNoZWNrZWQgaW4gdGhlIHJlY29uY2lsZXIuCiAgICAgICAgICAgICAgdHlwZTIuJCR0eXBlb2YgPT09IFJFQUNUX01FTU9fVFlQRSkpIHsKICAgICAgICAgICAgICAgIHByb3BUeXBlcyA9IHR5cGUyLnByb3BUeXBlczsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlMik7CiAgICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcyhwcm9wVHlwZXMsIGVsZW1lbnQucHJvcHMsICJwcm9wIiwgbmFtZSwgZWxlbWVudCk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlMi5Qcm9wVHlwZXMgIT09IHZvaWQgMCAmJiAhcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd24pIHsKICAgICAgICAgICAgICAgIHByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHZhciBfbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlMik7CiAgICAgICAgICAgICAgICBlcnJvcigiQ29tcG9uZW50ICVzIGRlY2xhcmVkIGBQcm9wVHlwZXNgIGluc3RlYWQgb2YgYHByb3BUeXBlc2AuIERpZCB5b3UgbWlzc3BlbGwgdGhlIHByb3BlcnR5IGFzc2lnbm1lbnQ/IiwgX25hbWUgfHwgIlVua25vd24iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlMi5nZXREZWZhdWx0UHJvcHMgPT09ICJmdW5jdGlvbiIgJiYgIXR5cGUyLmdldERlZmF1bHRQcm9wcy5pc1JlYWN0Q2xhc3NBcHByb3ZlZCkgewogICAgICAgICAgICAgICAgZXJyb3IoImdldERlZmF1bHRQcm9wcyBpcyBvbmx5IHVzZWQgb24gY2xhc3NpYyBSZWFjdC5jcmVhdGVDbGFzcyBkZWZpbml0aW9ucy4gVXNlIGEgc3RhdGljIHByb3BlcnR5IG5hbWVkIGBkZWZhdWx0UHJvcHNgIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZUZyYWdtZW50UHJvcHMoZnJhZ21lbnQpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMoZnJhZ21lbnQucHJvcHMpOwogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGtleSA9IGtleXNbaV07CiAgICAgICAgICAgICAgICBpZiAoa2V5ICE9PSAiY2hpbGRyZW4iICYmIGtleSAhPT0gImtleSIpIHsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShmcmFnbWVudCk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIHByb3AgYCVzYCBzdXBwbGllZCB0byBgUmVhY3QuRnJhZ21lbnRgLiBSZWFjdC5GcmFnbWVudCBjYW4gb25seSBoYXZlIGBrZXlgIGFuZCBgY2hpbGRyZW5gIHByb3BzLiIsIGtleSk7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZnJhZ21lbnQucmVmICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGZyYWdtZW50KTsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGF0dHJpYnV0ZSBgcmVmYCBzdXBwbGllZCB0byBgUmVhY3QuRnJhZ21lbnRgLiIpOwogICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShudWxsKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnRXaXRoVmFsaWRhdGlvbih0eXBlMiwgcHJvcHMsIGNoaWxkcmVuMikgewogICAgICAgICAgICB2YXIgdmFsaWRUeXBlID0gaXNWYWxpZEVsZW1lbnRUeXBlKHR5cGUyKTsKICAgICAgICAgICAgaWYgKCF2YWxpZFR5cGUpIHsKICAgICAgICAgICAgICB2YXIgaW5mbyA9ICIiOwogICAgICAgICAgICAgIGlmICh0eXBlMiA9PT0gdm9pZCAwIHx8IHR5cGVvZiB0eXBlMiA9PT0gIm9iamVjdCIgJiYgdHlwZTIgIT09IG51bGwgJiYgT2JqZWN0LmtleXModHlwZTIpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgaW5mbyArPSAiIFlvdSBsaWtlbHkgZm9yZ290IHRvIGV4cG9ydCB5b3VyIGNvbXBvbmVudCBmcm9tIHRoZSBmaWxlIGl0J3MgZGVmaW5lZCBpbiwgb3IgeW91IG1pZ2h0IGhhdmUgbWl4ZWQgdXAgZGVmYXVsdCBhbmQgbmFtZWQgaW1wb3J0cy4iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgc291cmNlSW5mbyA9IGdldFNvdXJjZUluZm9FcnJvckFkZGVuZHVtRm9yUHJvcHMocHJvcHMpOwogICAgICAgICAgICAgIGlmIChzb3VyY2VJbmZvKSB7CiAgICAgICAgICAgICAgICBpbmZvICs9IHNvdXJjZUluZm87CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGluZm8gKz0gZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciB0eXBlU3RyaW5nOwogICAgICAgICAgICAgIGlmICh0eXBlMiA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdHlwZVN0cmluZyA9ICJudWxsIjsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkodHlwZTIpKSB7CiAgICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gImFycmF5IjsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUyICE9PSB2b2lkIDAgJiYgdHlwZTIuJCR0eXBlb2YgPT09IFJFQUNUX0VMRU1FTlRfVFlQRSkgewogICAgICAgICAgICAgICAgdHlwZVN0cmluZyA9ICI8IiArIChnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZTIudHlwZSkgfHwgIlVua25vd24iKSArICIgLz4iOwogICAgICAgICAgICAgICAgaW5mbyA9ICIgRGlkIHlvdSBhY2NpZGVudGFsbHkgZXhwb3J0IGEgSlNYIGxpdGVyYWwgaW5zdGVhZCBvZiBhIGNvbXBvbmVudD8iOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gdHlwZW9mIHR5cGUyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QuY3JlYXRlRWxlbWVudDogdHlwZSBpcyBpbnZhbGlkIC0tIGV4cGVjdGVkIGEgc3RyaW5nIChmb3IgYnVpbHQtaW4gY29tcG9uZW50cykgb3IgYSBjbGFzcy9mdW5jdGlvbiAoZm9yIGNvbXBvc2l0ZSBjb21wb25lbnRzKSBidXQgZ290OiAlcy4lcyIsIHR5cGVTdHJpbmcsIGluZm8pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZWxlbWVudCA9IGNyZWF0ZUVsZW1lbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgaWYgKGVsZW1lbnQgPT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2YWxpZFR5cGUpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMjsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFsaWRhdGVDaGlsZEtleXMoYXJndW1lbnRzW2ldLCB0eXBlMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlMiA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSkgewogICAgICAgICAgICAgIHZhbGlkYXRlRnJhZ21lbnRQcm9wcyhlbGVtZW50KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YWxpZGF0ZVByb3BUeXBlcyhlbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBkaWRXYXJuQWJvdXREZXByZWNhdGVkQ3JlYXRlRmFjdG9yeSA9IGZhbHNlOwogICAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmFjdG9yeVdpdGhWYWxpZGF0aW9uKHR5cGUyKSB7CiAgICAgICAgICAgIHZhciB2YWxpZGF0ZWRGYWN0b3J5ID0gY3JlYXRlRWxlbWVudFdpdGhWYWxpZGF0aW9uLmJpbmQobnVsbCwgdHlwZTIpOwogICAgICAgICAgICB2YWxpZGF0ZWRGYWN0b3J5LnR5cGUgPSB0eXBlMjsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0RGVwcmVjYXRlZENyZWF0ZUZhY3RvcnkpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dERlcHJlY2F0ZWRDcmVhdGVGYWN0b3J5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHdhcm4oIlJlYWN0LmNyZWF0ZUZhY3RvcnkoKSBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gQ29uc2lkZXIgdXNpbmcgSlNYIG9yIHVzZSBSZWFjdC5jcmVhdGVFbGVtZW50KCkgZGlyZWN0bHkgaW5zdGVhZC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHZhbGlkYXRlZEZhY3RvcnksICJ0eXBlIiwgewogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB3YXJuKCJGYWN0b3J5LnR5cGUgaXMgZGVwcmVjYXRlZC4gQWNjZXNzIHRoZSBjbGFzcyBkaXJlY3RseSBiZWZvcmUgcGFzc2luZyBpdCB0byBjcmVhdGVGYWN0b3J5LiIpOwogICAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgInR5cGUiLCB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHR5cGUyCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICByZXR1cm4gdHlwZTI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHZhbGlkYXRlZEZhY3Rvcnk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjbG9uZUVsZW1lbnRXaXRoVmFsaWRhdGlvbihlbGVtZW50LCBwcm9wcywgY2hpbGRyZW4yKSB7CiAgICAgICAgICAgIHZhciBuZXdFbGVtZW50ID0gY2xvbmVFbGVtZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAyOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFsaWRhdGVDaGlsZEtleXMoYXJndW1lbnRzW2ldLCBuZXdFbGVtZW50LnR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhbGlkYXRlUHJvcFR5cGVzKG5ld0VsZW1lbnQpOwogICAgICAgICAgICByZXR1cm4gbmV3RWxlbWVudDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHN0YXJ0VHJhbnNpdGlvbihzY29wZSwgb3B0aW9ucykgewogICAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uID0ge307CiAgICAgICAgICAgIHZhciBjdXJyZW50VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb247CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uLl91cGRhdGVkRmliZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHNjb3BlKCk7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChwcmV2VHJhbnNpdGlvbiA9PT0gbnVsbCAmJiBjdXJyZW50VHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycykgewogICAgICAgICAgICAgICAgICB2YXIgdXBkYXRlZEZpYmVyc0NvdW50ID0gY3VycmVudFRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMuc2l6ZTsKICAgICAgICAgICAgICAgICAgaWYgKHVwZGF0ZWRGaWJlcnNDb3VudCA+IDEwKSB7CiAgICAgICAgICAgICAgICAgICAgd2FybigiRGV0ZWN0ZWQgYSBsYXJnZSBudW1iZXIgb2YgdXBkYXRlcyBpbnNpZGUgc3RhcnRUcmFuc2l0aW9uLiBJZiB0aGlzIGlzIGR1ZSB0byBhIHN1YnNjcmlwdGlvbiBwbGVhc2UgcmUtd3JpdGUgaXQgdG8gdXNlIFJlYWN0IHByb3ZpZGVkIGhvb2tzLiBPdGhlcndpc2UgY29uY3VycmVudCBtb2RlIGd1YXJhbnRlZXMgYXJlIG9mZiB0aGUgdGFibGUuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY3VycmVudFRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMuY2xlYXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBkaWRXYXJuQWJvdXRNZXNzYWdlQ2hhbm5lbCA9IGZhbHNlOwogICAgICAgICAgdmFyIGVucXVldWVUYXNrSW1wbCA9IG51bGw7CiAgICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlVGFzayh0YXNrKSB7CiAgICAgICAgICAgIGlmIChlbnF1ZXVlVGFza0ltcGwgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdmFyIHJlcXVpcmVTdHJpbmcgPSAoInJlcXVpcmUiICsgTWF0aC5yYW5kb20oKSkuc2xpY2UoMCwgNyk7CiAgICAgICAgICAgICAgICB2YXIgbm9kZVJlcXVpcmUgPSBtb2R1bGUgJiYgbW9kdWxlW3JlcXVpcmVTdHJpbmddOwogICAgICAgICAgICAgICAgZW5xdWV1ZVRhc2tJbXBsID0gbm9kZVJlcXVpcmUuY2FsbChtb2R1bGUsICJ0aW1lcnMiKS5zZXRJbW1lZGlhdGU7CiAgICAgICAgICAgICAgfSBjYXRjaCAoX2VycikgewogICAgICAgICAgICAgICAgZW5xdWV1ZVRhc2tJbXBsID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmIChkaWRXYXJuQWJvdXRNZXNzYWdlQ2hhbm5lbCA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dE1lc3NhZ2VDaGFubmVsID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgTWVzc2FnZUNoYW5uZWwgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJUaGlzIGJyb3dzZXIgZG9lcyBub3QgaGF2ZSBhIE1lc3NhZ2VDaGFubmVsIGltcGxlbWVudGF0aW9uLCBzbyBlbnF1ZXVpbmcgdGFza3MgdmlhIGF3YWl0IGFjdChhc3luYyAoKSA9PiAuLi4pIHdpbGwgZmFpbC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUgYXQgaHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL3JlYWN0L2lzc3VlcyBpZiB5b3UgZW5jb3VudGVyIHRoaXMgd2FybmluZy4iKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIGNoYW5uZWwgPSBuZXcgTWVzc2FnZUNoYW5uZWwoKTsKICAgICAgICAgICAgICAgICAgY2hhbm5lbC5wb3J0MS5vbm1lc3NhZ2UgPSBjYWxsYmFjazsKICAgICAgICAgICAgICAgICAgY2hhbm5lbC5wb3J0Mi5wb3N0TWVzc2FnZSh2b2lkIDApOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGVucXVldWVUYXNrSW1wbCh0YXNrKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBhY3RTY29wZURlcHRoID0gMDsKICAgICAgICAgIHZhciBkaWRXYXJuTm9Bd2FpdEFjdCA9IGZhbHNlOwogICAgICAgICAgZnVuY3Rpb24gYWN0KGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgcHJldkFjdFNjb3BlRGVwdGggPSBhY3RTY29wZURlcHRoOwogICAgICAgICAgICAgIGFjdFNjb3BlRGVwdGgrKzsKICAgICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9IFtdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcHJldklzQmF0Y2hpbmdMZWdhY3kgPSBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5pc0JhdGNoaW5nTGVnYWN5OwogICAgICAgICAgICAgIHZhciByZXN1bHQ7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmlzQmF0Y2hpbmdMZWdhY3kgPSB0cnVlOwogICAgICAgICAgICAgICAgcmVzdWx0ID0gY2FsbGJhY2soKTsKICAgICAgICAgICAgICAgIGlmICghcHJldklzQmF0Y2hpbmdMZWdhY3kgJiYgUmVhY3RDdXJyZW50QWN0UXVldWUuZGlkU2NoZWR1bGVMZWdhY3lVcGRhdGUpIHsKICAgICAgICAgICAgICAgICAgdmFyIHF1ZXVlID0gUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudDsKICAgICAgICAgICAgICAgICAgaWYgKHF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuZGlkU2NoZWR1bGVMZWdhY3lVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBmbHVzaEFjdFF1ZXVlKHF1ZXVlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgcG9wQWN0U2NvcGUocHJldkFjdFNjb3BlRGVwdGgpOwogICAgICAgICAgICAgICAgdGhyb3cgZXJyb3IyOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5pc0JhdGNoaW5nTGVnYWN5ID0gcHJldklzQmF0Y2hpbmdMZWdhY3k7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChyZXN1bHQgIT09IG51bGwgJiYgdHlwZW9mIHJlc3VsdCA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIHJlc3VsdC50aGVuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB2YXIgdGhlbmFibGVSZXN1bHQgPSByZXN1bHQ7CiAgICAgICAgICAgICAgICB2YXIgd2FzQXdhaXRlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgdmFyIHRoZW5hYmxlID0gewogICAgICAgICAgICAgICAgICB0aGVuOiBmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgICAgICAgICB3YXNBd2FpdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGVuYWJsZVJlc3VsdC50aGVuKGZ1bmN0aW9uKHJldHVyblZhbHVlMikgewogICAgICAgICAgICAgICAgICAgICAgcG9wQWN0U2NvcGUocHJldkFjdFNjb3BlRGVwdGgpOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGFjdFNjb3BlRGVwdGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlGbHVzaEFzeW5jQWN0V29yayhyZXR1cm5WYWx1ZTIsIHJlc29sdmUsIHJlamVjdCk7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJldHVyblZhbHVlMik7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24oZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgICBwb3BBY3RTY29wZShwcmV2QWN0U2NvcGVEZXB0aCk7CiAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuTm9Bd2FpdEFjdCAmJiB0eXBlb2YgUHJvbWlzZSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIH0pLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIXdhc0F3YWl0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGlkV2Fybk5vQXdhaXRBY3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiWW91IGNhbGxlZCBhY3QoYXN5bmMgKCkgPT4gLi4uKSB3aXRob3V0IGF3YWl0LiBUaGlzIGNvdWxkIGxlYWQgdG8gdW5leHBlY3RlZCB0ZXN0aW5nIGJlaGF2aW91ciwgaW50ZXJsZWF2aW5nIG11bHRpcGxlIGFjdCBjYWxscyBhbmQgbWl4aW5nIHRoZWlyIHNjb3Blcy4gWW91IHNob3VsZCAtIGF3YWl0IGFjdChhc3luYyAoKSA9PiAuLi4pOyIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhlbmFibGU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciByZXR1cm5WYWx1ZSA9IHJlc3VsdDsKICAgICAgICAgICAgICAgIHBvcEFjdFNjb3BlKHByZXZBY3RTY29wZURlcHRoKTsKICAgICAgICAgICAgICAgIGlmIChhY3RTY29wZURlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfcXVldWUgPSBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50OwogICAgICAgICAgICAgICAgICBpZiAoX3F1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgZmx1c2hBY3RRdWV1ZShfcXVldWUpOwogICAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBfdGhlbmFibGUgPSB7CiAgICAgICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50ID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5Rmx1c2hBc3luY0FjdFdvcmsocmV0dXJuVmFsdWUsIHJlc29sdmUsIHJlamVjdCk7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJldHVyblZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhlbmFibGU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YXIgX3RoZW5hYmxlMiA9IHsKICAgICAgICAgICAgICAgICAgICB0aGVuOiBmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmV0dXJuVmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGVuYWJsZTI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwb3BBY3RTY29wZShwcmV2QWN0U2NvcGVEZXB0aCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHByZXZBY3RTY29wZURlcHRoICE9PSBhY3RTY29wZURlcHRoIC0gMSkgewogICAgICAgICAgICAgICAgZXJyb3IoIllvdSBzZWVtIHRvIGhhdmUgb3ZlcmxhcHBpbmcgYWN0KCkgY2FsbHMsIHRoaXMgaXMgbm90IHN1cHBvcnRlZC4gQmUgc3VyZSB0byBhd2FpdCBwcmV2aW91cyBhY3QoKSBjYWxscyBiZWZvcmUgbWFraW5nIGEgbmV3IG9uZS4gIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGFjdFNjb3BlRGVwdGggPSBwcmV2QWN0U2NvcGVEZXB0aDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjdXJzaXZlbHlGbHVzaEFzeW5jQWN0V29yayhyZXR1cm5WYWx1ZSwgcmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgcXVldWUgPSBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50OwogICAgICAgICAgICAgIGlmIChxdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgZmx1c2hBY3RRdWV1ZShxdWV1ZSk7CiAgICAgICAgICAgICAgICAgIGVucXVldWVUYXNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGlmIChxdWV1ZS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXR1cm5WYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5Rmx1c2hBc3luY0FjdFdvcmsocmV0dXJuVmFsdWUsIHJlc29sdmUsIHJlamVjdCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVzb2x2ZShyZXR1cm5WYWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaXNGbHVzaGluZyA9IGZhbHNlOwogICAgICAgICAgZnVuY3Rpb24gZmx1c2hBY3RRdWV1ZShxdWV1ZSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCFpc0ZsdXNoaW5nKSB7CiAgICAgICAgICAgICAgICBpc0ZsdXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGZvciAoOyBpIDwgcXVldWUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBxdWV1ZVtpXTsKICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrKHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKGNhbGxiYWNrICE9PSBudWxsKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBxdWV1ZS5sZW5ndGggPSAwOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgIHF1ZXVlID0gcXVldWUuc2xpY2UoaSArIDEpOwogICAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICBpc0ZsdXNoaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY3JlYXRlRWxlbWVudCQxID0gY3JlYXRlRWxlbWVudFdpdGhWYWxpZGF0aW9uOwogICAgICAgICAgdmFyIGNsb25lRWxlbWVudCQxID0gY2xvbmVFbGVtZW50V2l0aFZhbGlkYXRpb247CiAgICAgICAgICB2YXIgY3JlYXRlRmFjdG9yeSA9IGNyZWF0ZUZhY3RvcnlXaXRoVmFsaWRhdGlvbjsKICAgICAgICAgIHZhciBDaGlsZHJlbjIgPSB7CiAgICAgICAgICAgIG1hcDogbWFwQ2hpbGRyZW4sCiAgICAgICAgICAgIGZvckVhY2g6IGZvckVhY2hDaGlsZHJlbiwKICAgICAgICAgICAgY291bnQ6IGNvdW50Q2hpbGRyZW4sCiAgICAgICAgICAgIHRvQXJyYXksCiAgICAgICAgICAgIG9ubHk6IG9ubHlDaGlsZAogICAgICAgICAgfTsKICAgICAgICAgIGV4cG9ydHMuQ2hpbGRyZW4gPSBDaGlsZHJlbjI7CiAgICAgICAgICBleHBvcnRzLkNvbXBvbmVudCA9IENvbXBvbmVudDsKICAgICAgICAgIGV4cG9ydHMuRnJhZ21lbnQgPSBSRUFDVF9GUkFHTUVOVF9UWVBFOwogICAgICAgICAgZXhwb3J0cy5Qcm9maWxlciA9IFJFQUNUX1BST0ZJTEVSX1RZUEU7CiAgICAgICAgICBleHBvcnRzLlB1cmVDb21wb25lbnQgPSBQdXJlQ29tcG9uZW50OwogICAgICAgICAgZXhwb3J0cy5TdHJpY3RNb2RlID0gUkVBQ1RfU1RSSUNUX01PREVfVFlQRTsKICAgICAgICAgIGV4cG9ydHMuU3VzcGVuc2UgPSBSRUFDVF9TVVNQRU5TRV9UWVBFOwogICAgICAgICAgZXhwb3J0cy5fX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRCA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzOwogICAgICAgICAgZXhwb3J0cy5jbG9uZUVsZW1lbnQgPSBjbG9uZUVsZW1lbnQkMTsKICAgICAgICAgIGV4cG9ydHMuY3JlYXRlQ29udGV4dCA9IGNyZWF0ZUNvbnRleHQ7CiAgICAgICAgICBleHBvcnRzLmNyZWF0ZUVsZW1lbnQgPSBjcmVhdGVFbGVtZW50JDE7CiAgICAgICAgICBleHBvcnRzLmNyZWF0ZUZhY3RvcnkgPSBjcmVhdGVGYWN0b3J5OwogICAgICAgICAgZXhwb3J0cy5jcmVhdGVSZWYgPSBjcmVhdGVSZWY7CiAgICAgICAgICBleHBvcnRzLmZvcndhcmRSZWYgPSBmb3J3YXJkUmVmOwogICAgICAgICAgZXhwb3J0cy5pc1ZhbGlkRWxlbWVudCA9IGlzVmFsaWRFbGVtZW50OwogICAgICAgICAgZXhwb3J0cy5sYXp5ID0gbGF6eTsKICAgICAgICAgIGV4cG9ydHMubWVtbyA9IG1lbW87CiAgICAgICAgICBleHBvcnRzLnN0YXJ0VHJhbnNpdGlvbiA9IHN0YXJ0VHJhbnNpdGlvbjsKICAgICAgICAgIGV4cG9ydHMudW5zdGFibGVfYWN0ID0gYWN0OwogICAgICAgICAgZXhwb3J0cy51c2VDYWxsYmFjayA9IHVzZUNhbGxiYWNrOwogICAgICAgICAgZXhwb3J0cy51c2VDb250ZXh0ID0gdXNlQ29udGV4dDsKICAgICAgICAgIGV4cG9ydHMudXNlRGVidWdWYWx1ZSA9IHVzZURlYnVnVmFsdWU7CiAgICAgICAgICBleHBvcnRzLnVzZURlZmVycmVkVmFsdWUgPSB1c2VEZWZlcnJlZFZhbHVlOwogICAgICAgICAgZXhwb3J0cy51c2VFZmZlY3QgPSB1c2VFZmZlY3QzOwogICAgICAgICAgZXhwb3J0cy51c2VJZCA9IHVzZUlkOwogICAgICAgICAgZXhwb3J0cy51c2VJbXBlcmF0aXZlSGFuZGxlID0gdXNlSW1wZXJhdGl2ZUhhbmRsZTsKICAgICAgICAgIGV4cG9ydHMudXNlSW5zZXJ0aW9uRWZmZWN0ID0gdXNlSW5zZXJ0aW9uRWZmZWN0OwogICAgICAgICAgZXhwb3J0cy51c2VMYXlvdXRFZmZlY3QgPSB1c2VMYXlvdXRFZmZlY3Q7CiAgICAgICAgICBleHBvcnRzLnVzZU1lbW8gPSB1c2VNZW1vOwogICAgICAgICAgZXhwb3J0cy51c2VSZWR1Y2VyID0gdXNlUmVkdWNlcjsKICAgICAgICAgIGV4cG9ydHMudXNlUmVmID0gdXNlUmVmMjsKICAgICAgICAgIGV4cG9ydHMudXNlU3RhdGUgPSB1c2VTdGF0ZTM7CiAgICAgICAgICBleHBvcnRzLnVzZVN5bmNFeHRlcm5hbFN0b3JlID0gdXNlU3luY0V4dGVybmFsU3RvcmU7CiAgICAgICAgICBleHBvcnRzLnVzZVRyYW5zaXRpb24gPSB1c2VUcmFuc2l0aW9uOwogICAgICAgICAgZXhwb3J0cy52ZXJzaW9uID0gUmVhY3RWZXJzaW9uOwogICAgICAgICAgaWYgKHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wKG5ldyBFcnJvcigpKTsKICAgICAgICAgIH0KICAgICAgICB9KSgpOwogICAgICB9CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9yZWFjdC9pbmRleC5qcwogIHZhciByZXF1aXJlX3JlYWN0ID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL3JlYWN0L2luZGV4LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgICAgInVzZSBzdHJpY3QiOwogICAgICBpZiAoZmFsc2UpIHsKICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IG51bGw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3JlYWN0X2RldmVsb3BtZW50KCk7CiAgICAgIH0KICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3NjaGVkdWxlci9janMvc2NoZWR1bGVyLmRldmVsb3BtZW50LmpzCiAgdmFyIHJlcXVpcmVfc2NoZWR1bGVyX2RldmVsb3BtZW50ID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL3NjaGVkdWxlci9janMvc2NoZWR1bGVyLmRldmVsb3BtZW50LmpzIihleHBvcnRzKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgaWYgKHRydWUpIHsKICAgICAgICAoZnVuY3Rpb24oKSB7CiAgICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydChuZXcgRXJyb3IoKSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZW5hYmxlU2NoZWR1bGVyRGVidWdnaW5nID0gZmFsc2U7CiAgICAgICAgICB2YXIgZW5hYmxlUHJvZmlsaW5nID0gZmFsc2U7CiAgICAgICAgICB2YXIgZnJhbWVZaWVsZE1zID0gNTsKICAgICAgICAgIGZ1bmN0aW9uIHB1c2goaGVhcCwgbm9kZSkgewogICAgICAgICAgICB2YXIgaW5kZXgyID0gaGVhcC5sZW5ndGg7CiAgICAgICAgICAgIGhlYXAucHVzaChub2RlKTsKICAgICAgICAgICAgc2lmdFVwKGhlYXAsIG5vZGUsIGluZGV4Mik7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwZWVrKGhlYXApIHsKICAgICAgICAgICAgcmV0dXJuIGhlYXAubGVuZ3RoID09PSAwID8gbnVsbCA6IGhlYXBbMF07CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwb3AoaGVhcCkgewogICAgICAgICAgICBpZiAoaGVhcC5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZmlyc3QgPSBoZWFwWzBdOwogICAgICAgICAgICB2YXIgbGFzdCA9IGhlYXAucG9wKCk7CiAgICAgICAgICAgIGlmIChsYXN0ICE9PSBmaXJzdCkgewogICAgICAgICAgICAgIGhlYXBbMF0gPSBsYXN0OwogICAgICAgICAgICAgIHNpZnREb3duKGhlYXAsIGxhc3QsIDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmaXJzdDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHNpZnRVcChoZWFwLCBub2RlLCBpKSB7CiAgICAgICAgICAgIHZhciBpbmRleDIgPSBpOwogICAgICAgICAgICB3aGlsZSAoaW5kZXgyID4gMCkgewogICAgICAgICAgICAgIHZhciBwYXJlbnRJbmRleCA9IGluZGV4MiAtIDEgPj4+IDE7CiAgICAgICAgICAgICAgdmFyIHBhcmVudCA9IGhlYXBbcGFyZW50SW5kZXhdOwogICAgICAgICAgICAgIGlmIChjb21wYXJlKHBhcmVudCwgbm9kZSkgPiAwKSB7CiAgICAgICAgICAgICAgICBoZWFwW3BhcmVudEluZGV4XSA9IG5vZGU7CiAgICAgICAgICAgICAgICBoZWFwW2luZGV4Ml0gPSBwYXJlbnQ7CiAgICAgICAgICAgICAgICBpbmRleDIgPSBwYXJlbnRJbmRleDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gc2lmdERvd24oaGVhcCwgbm9kZSwgaSkgewogICAgICAgICAgICB2YXIgaW5kZXgyID0gaTsKICAgICAgICAgICAgdmFyIGxlbmd0aCA9IGhlYXAubGVuZ3RoOwogICAgICAgICAgICB2YXIgaGFsZkxlbmd0aCA9IGxlbmd0aCA+Pj4gMTsKICAgICAgICAgICAgd2hpbGUgKGluZGV4MiA8IGhhbGZMZW5ndGgpIHsKICAgICAgICAgICAgICB2YXIgbGVmdEluZGV4ID0gKGluZGV4MiArIDEpICogMiAtIDE7CiAgICAgICAgICAgICAgdmFyIGxlZnQgPSBoZWFwW2xlZnRJbmRleF07CiAgICAgICAgICAgICAgdmFyIHJpZ2h0SW5kZXggPSBsZWZ0SW5kZXggKyAxOwogICAgICAgICAgICAgIHZhciByaWdodCA9IGhlYXBbcmlnaHRJbmRleF07CiAgICAgICAgICAgICAgaWYgKGNvbXBhcmUobGVmdCwgbm9kZSkgPCAwKSB7CiAgICAgICAgICAgICAgICBpZiAocmlnaHRJbmRleCA8IGxlbmd0aCAmJiBjb21wYXJlKHJpZ2h0LCBsZWZ0KSA8IDApIHsKICAgICAgICAgICAgICAgICAgaGVhcFtpbmRleDJdID0gcmlnaHQ7CiAgICAgICAgICAgICAgICAgIGhlYXBbcmlnaHRJbmRleF0gPSBub2RlOwogICAgICAgICAgICAgICAgICBpbmRleDIgPSByaWdodEluZGV4OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgaGVhcFtpbmRleDJdID0gbGVmdDsKICAgICAgICAgICAgICAgICAgaGVhcFtsZWZ0SW5kZXhdID0gbm9kZTsKICAgICAgICAgICAgICAgICAgaW5kZXgyID0gbGVmdEluZGV4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAocmlnaHRJbmRleCA8IGxlbmd0aCAmJiBjb21wYXJlKHJpZ2h0LCBub2RlKSA8IDApIHsKICAgICAgICAgICAgICAgIGhlYXBbaW5kZXgyXSA9IHJpZ2h0OwogICAgICAgICAgICAgICAgaGVhcFtyaWdodEluZGV4XSA9IG5vZGU7CiAgICAgICAgICAgICAgICBpbmRleDIgPSByaWdodEluZGV4OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjb21wYXJlKGEyLCBiKSB7CiAgICAgICAgICAgIHZhciBkaWZmID0gYTIuc29ydEluZGV4IC0gYi5zb3J0SW5kZXg7CiAgICAgICAgICAgIHJldHVybiBkaWZmICE9PSAwID8gZGlmZiA6IGEyLmlkIC0gYi5pZDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBJbW1lZGlhdGVQcmlvcml0eSA9IDE7CiAgICAgICAgICB2YXIgVXNlckJsb2NraW5nUHJpb3JpdHkgPSAyOwogICAgICAgICAgdmFyIE5vcm1hbFByaW9yaXR5ID0gMzsKICAgICAgICAgIHZhciBMb3dQcmlvcml0eSA9IDQ7CiAgICAgICAgICB2YXIgSWRsZVByaW9yaXR5ID0gNTsKICAgICAgICAgIGZ1bmN0aW9uIG1hcmtUYXNrRXJyb3JlZCh0YXNrLCBtcykgewogICAgICAgICAgfQogICAgICAgICAgdmFyIGhhc1BlcmZvcm1hbmNlTm93ID0gdHlwZW9mIHBlcmZvcm1hbmNlID09PSAib2JqZWN0IiAmJiB0eXBlb2YgcGVyZm9ybWFuY2Uubm93ID09PSAiZnVuY3Rpb24iOwogICAgICAgICAgaWYgKGhhc1BlcmZvcm1hbmNlTm93KSB7CiAgICAgICAgICAgIHZhciBsb2NhbFBlcmZvcm1hbmNlID0gcGVyZm9ybWFuY2U7CiAgICAgICAgICAgIGV4cG9ydHMudW5zdGFibGVfbm93ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGxvY2FsUGVyZm9ybWFuY2Uubm93KCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgbG9jYWxEYXRlID0gRGF0ZTsKICAgICAgICAgICAgdmFyIGluaXRpYWxUaW1lID0gbG9jYWxEYXRlLm5vdygpOwogICAgICAgICAgICBleHBvcnRzLnVuc3RhYmxlX25vdyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBsb2NhbERhdGUubm93KCkgLSBpbml0aWFsVGltZTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBtYXhTaWduZWQzMUJpdEludCA9IDEwNzM3NDE4MjM7CiAgICAgICAgICB2YXIgSU1NRURJQVRFX1BSSU9SSVRZX1RJTUVPVVQgPSAtMTsKICAgICAgICAgIHZhciBVU0VSX0JMT0NLSU5HX1BSSU9SSVRZX1RJTUVPVVQgPSAyNTA7CiAgICAgICAgICB2YXIgTk9STUFMX1BSSU9SSVRZX1RJTUVPVVQgPSA1ZTM7CiAgICAgICAgICB2YXIgTE9XX1BSSU9SSVRZX1RJTUVPVVQgPSAxZTQ7CiAgICAgICAgICB2YXIgSURMRV9QUklPUklUWV9USU1FT1VUID0gbWF4U2lnbmVkMzFCaXRJbnQ7CiAgICAgICAgICB2YXIgdGFza1F1ZXVlID0gW107CiAgICAgICAgICB2YXIgdGltZXJRdWV1ZSA9IFtdOwogICAgICAgICAgdmFyIHRhc2tJZENvdW50ZXIgPSAxOwogICAgICAgICAgdmFyIGN1cnJlbnRUYXNrID0gbnVsbDsKICAgICAgICAgIHZhciBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgICAgdmFyIGlzUGVyZm9ybWluZ1dvcmsgPSBmYWxzZTsKICAgICAgICAgIHZhciBpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgICAgdmFyIGlzSG9zdFRpbWVvdXRTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICAgIHZhciBsb2NhbFNldFRpbWVvdXQgPSB0eXBlb2Ygc2V0VGltZW91dCA9PT0gImZ1bmN0aW9uIiA/IHNldFRpbWVvdXQgOiBudWxsOwogICAgICAgICAgdmFyIGxvY2FsQ2xlYXJUaW1lb3V0ID0gdHlwZW9mIGNsZWFyVGltZW91dCA9PT0gImZ1bmN0aW9uIiA/IGNsZWFyVGltZW91dCA6IG51bGw7CiAgICAgICAgICB2YXIgbG9jYWxTZXRJbW1lZGlhdGUgPSB0eXBlb2Ygc2V0SW1tZWRpYXRlICE9PSAidW5kZWZpbmVkIiA/IHNldEltbWVkaWF0ZSA6IG51bGw7CiAgICAgICAgICB2YXIgaXNJbnB1dFBlbmRpbmcgPSB0eXBlb2YgbmF2aWdhdG9yICE9PSAidW5kZWZpbmVkIiAmJiBuYXZpZ2F0b3Iuc2NoZWR1bGluZyAhPT0gdm9pZCAwICYmIG5hdmlnYXRvci5zY2hlZHVsaW5nLmlzSW5wdXRQZW5kaW5nICE9PSB2b2lkIDAgPyBuYXZpZ2F0b3Iuc2NoZWR1bGluZy5pc0lucHV0UGVuZGluZy5iaW5kKG5hdmlnYXRvci5zY2hlZHVsaW5nKSA6IG51bGw7CiAgICAgICAgICBmdW5jdGlvbiBhZHZhbmNlVGltZXJzKGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICAgIHZhciB0aW1lcjIgPSBwZWVrKHRpbWVyUXVldWUpOwogICAgICAgICAgICB3aGlsZSAodGltZXIyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKHRpbWVyMi5jYWxsYmFjayA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcG9wKHRpbWVyUXVldWUpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodGltZXIyLnN0YXJ0VGltZSA8PSBjdXJyZW50VGltZSkgewogICAgICAgICAgICAgICAgcG9wKHRpbWVyUXVldWUpOwogICAgICAgICAgICAgICAgdGltZXIyLnNvcnRJbmRleCA9IHRpbWVyMi5leHBpcmF0aW9uVGltZTsKICAgICAgICAgICAgICAgIHB1c2godGFza1F1ZXVlLCB0aW1lcjIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRpbWVyMiA9IHBlZWsodGltZXJRdWV1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZVRpbWVvdXQoY3VycmVudFRpbWUpIHsKICAgICAgICAgICAgaXNIb3N0VGltZW91dFNjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgICAgICBhZHZhbmNlVGltZXJzKGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgaWYgKCFpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCkgewogICAgICAgICAgICAgIGlmIChwZWVrKHRhc2tRdWV1ZSkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlzSG9zdENhbGxiYWNrU2NoZWR1bGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJlcXVlc3RIb3N0Q2FsbGJhY2soZmx1c2hXb3JrKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGZpcnN0VGltZXIgPSBwZWVrKHRpbWVyUXVldWUpOwogICAgICAgICAgICAgICAgaWYgKGZpcnN0VGltZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmVxdWVzdEhvc3RUaW1lb3V0KGhhbmRsZVRpbWVvdXQsIGZpcnN0VGltZXIuc3RhcnRUaW1lIC0gY3VycmVudFRpbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZmx1c2hXb3JrKGhhc1RpbWVSZW1haW5pbmcsIGluaXRpYWxUaW1lMikgewogICAgICAgICAgICBpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgICAgICBpZiAoaXNIb3N0VGltZW91dFNjaGVkdWxlZCkgewogICAgICAgICAgICAgIGlzSG9zdFRpbWVvdXRTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICAgICAgICBjYW5jZWxIb3N0VGltZW91dCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlzUGVyZm9ybWluZ1dvcmsgPSB0cnVlOwogICAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaWYgKGVuYWJsZVByb2ZpbGluZykgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHdvcmtMb29wKGhhc1RpbWVSZW1haW5pbmcsIGluaXRpYWxUaW1lMik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgICAgICAgICBpZiAoY3VycmVudFRhc2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgY3VycmVudFRpbWUgPSBleHBvcnRzLnVuc3RhYmxlX25vdygpOwogICAgICAgICAgICAgICAgICAgIG1hcmtUYXNrRXJyb3JlZChjdXJyZW50VGFzaywgY3VycmVudFRpbWUpOwogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRUYXNrLmlzUXVldWVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB3b3JrTG9vcChoYXNUaW1lUmVtYWluaW5nLCBpbml0aWFsVGltZTIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBjdXJyZW50VGFzayA9IG51bGw7CiAgICAgICAgICAgICAgY3VycmVudFByaW9yaXR5TGV2ZWwgPSBwcmV2aW91c1ByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgICAgaXNQZXJmb3JtaW5nV29yayA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB3b3JrTG9vcChoYXNUaW1lUmVtYWluaW5nLCBpbml0aWFsVGltZTIpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRUaW1lID0gaW5pdGlhbFRpbWUyOwogICAgICAgICAgICBhZHZhbmNlVGltZXJzKGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgY3VycmVudFRhc2sgPSBwZWVrKHRhc2tRdWV1ZSk7CiAgICAgICAgICAgIHdoaWxlIChjdXJyZW50VGFzayAhPT0gbnVsbCAmJiAhZW5hYmxlU2NoZWR1bGVyRGVidWdnaW5nKSB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnRUYXNrLmV4cGlyYXRpb25UaW1lID4gY3VycmVudFRpbWUgJiYgKCFoYXNUaW1lUmVtYWluaW5nIHx8IHNob3VsZFlpZWxkVG9Ib3N0KCkpKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gY3VycmVudFRhc2suY2FsbGJhY2s7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgY3VycmVudFRhc2suY2FsbGJhY2sgPSBudWxsOwogICAgICAgICAgICAgICAgY3VycmVudFByaW9yaXR5TGV2ZWwgPSBjdXJyZW50VGFzay5wcmlvcml0eUxldmVsOwogICAgICAgICAgICAgICAgdmFyIGRpZFVzZXJDYWxsYmFja1RpbWVvdXQgPSBjdXJyZW50VGFzay5leHBpcmF0aW9uVGltZSA8PSBjdXJyZW50VGltZTsKICAgICAgICAgICAgICAgIHZhciBjb250aW51YXRpb25DYWxsYmFjayA9IGNhbGxiYWNrKGRpZFVzZXJDYWxsYmFja1RpbWVvdXQpOwogICAgICAgICAgICAgICAgY3VycmVudFRpbWUgPSBleHBvcnRzLnVuc3RhYmxlX25vdygpOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjb250aW51YXRpb25DYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBjdXJyZW50VGFzay5jYWxsYmFjayA9IGNvbnRpbnVhdGlvbkNhbGxiYWNrOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRUYXNrID09PSBwZWVrKHRhc2tRdWV1ZSkpIHsKICAgICAgICAgICAgICAgICAgICBwb3AodGFza1F1ZXVlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYWR2YW5jZVRpbWVycyhjdXJyZW50VGltZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHBvcCh0YXNrUXVldWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjdXJyZW50VGFzayA9IHBlZWsodGFza1F1ZXVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY3VycmVudFRhc2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgZmlyc3RUaW1lciA9IHBlZWsodGltZXJRdWV1ZSk7CiAgICAgICAgICAgICAgaWYgKGZpcnN0VGltZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlcXVlc3RIb3N0VGltZW91dChoYW5kbGVUaW1lb3V0LCBmaXJzdFRpbWVyLnN0YXJ0VGltZSAtIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1bnN0YWJsZV9ydW5XaXRoUHJpb3JpdHkocHJpb3JpdHlMZXZlbCwgZXZlbnRIYW5kbGVyKSB7CiAgICAgICAgICAgIHN3aXRjaCAocHJpb3JpdHlMZXZlbCkgewogICAgICAgICAgICAgIGNhc2UgSW1tZWRpYXRlUHJpb3JpdHk6CiAgICAgICAgICAgICAgY2FzZSBVc2VyQmxvY2tpbmdQcmlvcml0eToKICAgICAgICAgICAgICBjYXNlIE5vcm1hbFByaW9yaXR5OgogICAgICAgICAgICAgIGNhc2UgTG93UHJpb3JpdHk6CiAgICAgICAgICAgICAgY2FzZSBJZGxlUHJpb3JpdHk6CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgcHJpb3JpdHlMZXZlbCA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5TGV2ZWwgPSBjdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICAgICAgY3VycmVudFByaW9yaXR5TGV2ZWwgPSBwcmlvcml0eUxldmVsOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHJldHVybiBldmVudEhhbmRsZXIoKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByZXZpb3VzUHJpb3JpdHlMZXZlbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfbmV4dChldmVudEhhbmRsZXIpIHsKICAgICAgICAgICAgdmFyIHByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgIHN3aXRjaCAoY3VycmVudFByaW9yaXR5TGV2ZWwpIHsKICAgICAgICAgICAgICBjYXNlIEltbWVkaWF0ZVByaW9yaXR5OgogICAgICAgICAgICAgIGNhc2UgVXNlckJsb2NraW5nUHJpb3JpdHk6CiAgICAgICAgICAgICAgY2FzZSBOb3JtYWxQcmlvcml0eToKICAgICAgICAgICAgICAgIHByaW9yaXR5TGV2ZWwgPSBOb3JtYWxQcmlvcml0eTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBwcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgIGN1cnJlbnRQcmlvcml0eUxldmVsID0gcHJpb3JpdHlMZXZlbDsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZXR1cm4gZXZlbnRIYW5kbGVyKCk7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgY3VycmVudFByaW9yaXR5TGV2ZWwgPSBwcmV2aW91c1ByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX3dyYXBDYWxsYmFjayhjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgcGFyZW50UHJpb3JpdHlMZXZlbCA9IGN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHlMZXZlbCA9IGN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgICAgICAgIGN1cnJlbnRQcmlvcml0eUxldmVsID0gcGFyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIGN1cnJlbnRQcmlvcml0eUxldmVsID0gcHJldmlvdXNQcmlvcml0eUxldmVsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX3NjaGVkdWxlQ2FsbGJhY2socHJpb3JpdHlMZXZlbCwgY2FsbGJhY2ssIG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRUaW1lID0gZXhwb3J0cy51bnN0YWJsZV9ub3coKTsKICAgICAgICAgICAgdmFyIHN0YXJ0VGltZTI7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gIm9iamVjdCIgJiYgb3B0aW9ucyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBkZWxheSA9IG9wdGlvbnMuZGVsYXk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBkZWxheSA9PT0gIm51bWJlciIgJiYgZGVsYXkgPiAwKSB7CiAgICAgICAgICAgICAgICBzdGFydFRpbWUyID0gY3VycmVudFRpbWUgKyBkZWxheTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc3RhcnRUaW1lMiA9IGN1cnJlbnRUaW1lOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdGFydFRpbWUyID0gY3VycmVudFRpbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRpbWVvdXQyOwogICAgICAgICAgICBzd2l0Y2ggKHByaW9yaXR5TGV2ZWwpIHsKICAgICAgICAgICAgICBjYXNlIEltbWVkaWF0ZVByaW9yaXR5OgogICAgICAgICAgICAgICAgdGltZW91dDIgPSBJTU1FRElBVEVfUFJJT1JJVFlfVElNRU9VVDsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgVXNlckJsb2NraW5nUHJpb3JpdHk6CiAgICAgICAgICAgICAgICB0aW1lb3V0MiA9IFVTRVJfQkxPQ0tJTkdfUFJJT1JJVFlfVElNRU9VVDsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgSWRsZVByaW9yaXR5OgogICAgICAgICAgICAgICAgdGltZW91dDIgPSBJRExFX1BSSU9SSVRZX1RJTUVPVVQ7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIExvd1ByaW9yaXR5OgogICAgICAgICAgICAgICAgdGltZW91dDIgPSBMT1dfUFJJT1JJVFlfVElNRU9VVDsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgTm9ybWFsUHJpb3JpdHk6CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHRpbWVvdXQyID0gTk9STUFMX1BSSU9SSVRZX1RJTUVPVVQ7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZXhwaXJhdGlvblRpbWUgPSBzdGFydFRpbWUyICsgdGltZW91dDI7CiAgICAgICAgICAgIHZhciBuZXdUYXNrID0gewogICAgICAgICAgICAgIGlkOiB0YXNrSWRDb3VudGVyKyssCiAgICAgICAgICAgICAgY2FsbGJhY2ssCiAgICAgICAgICAgICAgcHJpb3JpdHlMZXZlbCwKICAgICAgICAgICAgICBzdGFydFRpbWU6IHN0YXJ0VGltZTIsCiAgICAgICAgICAgICAgZXhwaXJhdGlvblRpbWUsCiAgICAgICAgICAgICAgc29ydEluZGV4OiAtMQogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAoc3RhcnRUaW1lMiA+IGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICAgICAgbmV3VGFzay5zb3J0SW5kZXggPSBzdGFydFRpbWUyOwogICAgICAgICAgICAgIHB1c2godGltZXJRdWV1ZSwgbmV3VGFzayk7CiAgICAgICAgICAgICAgaWYgKHBlZWsodGFza1F1ZXVlKSA9PT0gbnVsbCAmJiBuZXdUYXNrID09PSBwZWVrKHRpbWVyUXVldWUpKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNIb3N0VGltZW91dFNjaGVkdWxlZCkgewogICAgICAgICAgICAgICAgICBjYW5jZWxIb3N0VGltZW91dCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgaXNIb3N0VGltZW91dFNjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXF1ZXN0SG9zdFRpbWVvdXQoaGFuZGxlVGltZW91dCwgc3RhcnRUaW1lMiAtIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV3VGFzay5zb3J0SW5kZXggPSBleHBpcmF0aW9uVGltZTsKICAgICAgICAgICAgICBwdXNoKHRhc2tRdWV1ZSwgbmV3VGFzayk7CiAgICAgICAgICAgICAgaWYgKCFpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCAmJiAhaXNQZXJmb3JtaW5nV29yaykgewogICAgICAgICAgICAgICAgaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgcmVxdWVzdEhvc3RDYWxsYmFjayhmbHVzaFdvcmspOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV3VGFzazsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX3BhdXNlRXhlY3V0aW9uKCkgewogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfY29udGludWVFeGVjdXRpb24oKSB7CiAgICAgICAgICAgIGlmICghaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgJiYgIWlzUGVyZm9ybWluZ1dvcmspIHsKICAgICAgICAgICAgICBpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICAgICAgcmVxdWVzdEhvc3RDYWxsYmFjayhmbHVzaFdvcmspOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1bnN0YWJsZV9nZXRGaXJzdENhbGxiYWNrTm9kZSgpIHsKICAgICAgICAgICAgcmV0dXJuIHBlZWsodGFza1F1ZXVlKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX2NhbmNlbENhbGxiYWNrKHRhc2spIHsKICAgICAgICAgICAgdGFzay5jYWxsYmFjayA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1bnN0YWJsZV9nZXRDdXJyZW50UHJpb3JpdHlMZXZlbCgpIHsKICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGlzTWVzc2FnZUxvb3BSdW5uaW5nID0gZmFsc2U7CiAgICAgICAgICB2YXIgc2NoZWR1bGVkSG9zdENhbGxiYWNrID0gbnVsbDsKICAgICAgICAgIHZhciB0YXNrVGltZW91dElEID0gLTE7CiAgICAgICAgICB2YXIgZnJhbWVJbnRlcnZhbCA9IGZyYW1lWWllbGRNczsKICAgICAgICAgIHZhciBzdGFydFRpbWUgPSAtMTsKICAgICAgICAgIGZ1bmN0aW9uIHNob3VsZFlpZWxkVG9Ib3N0KCkgewogICAgICAgICAgICB2YXIgdGltZUVsYXBzZWQgPSBleHBvcnRzLnVuc3RhYmxlX25vdygpIC0gc3RhcnRUaW1lOwogICAgICAgICAgICBpZiAodGltZUVsYXBzZWQgPCBmcmFtZUludGVydmFsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVxdWVzdFBhaW50KCkgewogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZm9yY2VGcmFtZVJhdGUoZnBzKSB7CiAgICAgICAgICAgIGlmIChmcHMgPCAwIHx8IGZwcyA+IDEyNSkgewogICAgICAgICAgICAgIGNvbnNvbGVbImVycm9yIl0oImZvcmNlRnJhbWVSYXRlIHRha2VzIGEgcG9zaXRpdmUgaW50IGJldHdlZW4gMCBhbmQgMTI1LCBmb3JjaW5nIGZyYW1lIHJhdGVzIGhpZ2hlciB0aGFuIDEyNSBmcHMgaXMgbm90IHN1cHBvcnRlZCIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZnBzID4gMCkgewogICAgICAgICAgICAgIGZyYW1lSW50ZXJ2YWwgPSBNYXRoLmZsb29yKDFlMyAvIGZwcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZnJhbWVJbnRlcnZhbCA9IGZyYW1lWWllbGRNczsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoc2NoZWR1bGVkSG9zdENhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnRUaW1lID0gZXhwb3J0cy51bnN0YWJsZV9ub3coKTsKICAgICAgICAgICAgICBzdGFydFRpbWUgPSBjdXJyZW50VGltZTsKICAgICAgICAgICAgICB2YXIgaGFzVGltZVJlbWFpbmluZyA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIGhhc01vcmVXb3JrID0gdHJ1ZTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgaGFzTW9yZVdvcmsgPSBzY2hlZHVsZWRIb3N0Q2FsbGJhY2soaGFzVGltZVJlbWFpbmluZywgY3VycmVudFRpbWUpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBpZiAoaGFzTW9yZVdvcmspIHsKICAgICAgICAgICAgICAgICAgc2NoZWR1bGVQZXJmb3JtV29ya1VudGlsRGVhZGxpbmUoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGlzTWVzc2FnZUxvb3BSdW5uaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIHNjaGVkdWxlZEhvc3RDYWxsYmFjayA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlzTWVzc2FnZUxvb3BSdW5uaW5nID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgc2NoZWR1bGVQZXJmb3JtV29ya1VudGlsRGVhZGxpbmU7CiAgICAgICAgICBpZiAodHlwZW9mIGxvY2FsU2V0SW1tZWRpYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgbG9jYWxTZXRJbW1lZGlhdGUocGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIE1lc3NhZ2VDaGFubmVsICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICB2YXIgY2hhbm5lbCA9IG5ldyBNZXNzYWdlQ2hhbm5lbCgpOwogICAgICAgICAgICB2YXIgcG9ydCA9IGNoYW5uZWwucG9ydDI7CiAgICAgICAgICAgIGNoYW5uZWwucG9ydDEub25tZXNzYWdlID0gcGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lOwogICAgICAgICAgICBzY2hlZHVsZVBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHBvcnQucG9zdE1lc3NhZ2UobnVsbCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzY2hlZHVsZVBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGxvY2FsU2V0VGltZW91dChwZXJmb3JtV29ya1VudGlsRGVhZGxpbmUsIDApOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVxdWVzdEhvc3RDYWxsYmFjayhjYWxsYmFjaykgewogICAgICAgICAgICBzY2hlZHVsZWRIb3N0Q2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgICAgaWYgKCFpc01lc3NhZ2VMb29wUnVubmluZykgewogICAgICAgICAgICAgIGlzTWVzc2FnZUxvb3BSdW5uaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICBzY2hlZHVsZVBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZXF1ZXN0SG9zdFRpbWVvdXQoY2FsbGJhY2ssIG1zKSB7CiAgICAgICAgICAgIHRhc2tUaW1lb3V0SUQgPSBsb2NhbFNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY2FsbGJhY2soZXhwb3J0cy51bnN0YWJsZV9ub3coKSk7CiAgICAgICAgICAgIH0sIG1zKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNhbmNlbEhvc3RUaW1lb3V0KCkgewogICAgICAgICAgICBsb2NhbENsZWFyVGltZW91dCh0YXNrVGltZW91dElEKTsKICAgICAgICAgICAgdGFza1RpbWVvdXRJRCA9IC0xOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHVuc3RhYmxlX3JlcXVlc3RQYWludCA9IHJlcXVlc3RQYWludDsKICAgICAgICAgIHZhciB1bnN0YWJsZV9Qcm9maWxpbmcgPSBudWxsOwogICAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9JZGxlUHJpb3JpdHkgPSBJZGxlUHJpb3JpdHk7CiAgICAgICAgICBleHBvcnRzLnVuc3RhYmxlX0ltbWVkaWF0ZVByaW9yaXR5ID0gSW1tZWRpYXRlUHJpb3JpdHk7CiAgICAgICAgICBleHBvcnRzLnVuc3RhYmxlX0xvd1ByaW9yaXR5ID0gTG93UHJpb3JpdHk7CiAgICAgICAgICBleHBvcnRzLnVuc3RhYmxlX05vcm1hbFByaW9yaXR5ID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgICBleHBvcnRzLnVuc3RhYmxlX1Byb2ZpbGluZyA9IHVuc3RhYmxlX1Byb2ZpbGluZzsKICAgICAgICAgIGV4cG9ydHMudW5zdGFibGVfVXNlckJsb2NraW5nUHJpb3JpdHkgPSBVc2VyQmxvY2tpbmdQcmlvcml0eTsKICAgICAgICAgIGV4cG9ydHMudW5zdGFibGVfY2FuY2VsQ2FsbGJhY2sgPSB1bnN0YWJsZV9jYW5jZWxDYWxsYmFjazsKICAgICAgICAgIGV4cG9ydHMudW5zdGFibGVfY29udGludWVFeGVjdXRpb24gPSB1bnN0YWJsZV9jb250aW51ZUV4ZWN1dGlvbjsKICAgICAgICAgIGV4cG9ydHMudW5zdGFibGVfZm9yY2VGcmFtZVJhdGUgPSBmb3JjZUZyYW1lUmF0ZTsKICAgICAgICAgIGV4cG9ydHMudW5zdGFibGVfZ2V0Q3VycmVudFByaW9yaXR5TGV2ZWwgPSB1bnN0YWJsZV9nZXRDdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICAgIGV4cG9ydHMudW5zdGFibGVfZ2V0Rmlyc3RDYWxsYmFja05vZGUgPSB1bnN0YWJsZV9nZXRGaXJzdENhbGxiYWNrTm9kZTsKICAgICAgICAgIGV4cG9ydHMudW5zdGFibGVfbmV4dCA9IHVuc3RhYmxlX25leHQ7CiAgICAgICAgICBleHBvcnRzLnVuc3RhYmxlX3BhdXNlRXhlY3V0aW9uID0gdW5zdGFibGVfcGF1c2VFeGVjdXRpb247CiAgICAgICAgICBleHBvcnRzLnVuc3RhYmxlX3JlcXVlc3RQYWludCA9IHVuc3RhYmxlX3JlcXVlc3RQYWludDsKICAgICAgICAgIGV4cG9ydHMudW5zdGFibGVfcnVuV2l0aFByaW9yaXR5ID0gdW5zdGFibGVfcnVuV2l0aFByaW9yaXR5OwogICAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9zY2hlZHVsZUNhbGxiYWNrID0gdW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjazsKICAgICAgICAgIGV4cG9ydHMudW5zdGFibGVfc2hvdWxkWWllbGQgPSBzaG91bGRZaWVsZFRvSG9zdDsKICAgICAgICAgIGV4cG9ydHMudW5zdGFibGVfd3JhcENhbGxiYWNrID0gdW5zdGFibGVfd3JhcENhbGxiYWNrOwogICAgICAgICAgaWYgKHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wKG5ldyBFcnJvcigpKTsKICAgICAgICAgIH0KICAgICAgICB9KSgpOwogICAgICB9CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9zY2hlZHVsZXIvaW5kZXguanMKICB2YXIgcmVxdWlyZV9zY2hlZHVsZXIgPSBfX2NvbW1vbkpTKHsKICAgICJub2RlX21vZHVsZXMvc2NoZWR1bGVyL2luZGV4LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgICAgInVzZSBzdHJpY3QiOwogICAgICBpZiAoZmFsc2UpIHsKICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IG51bGw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3NjaGVkdWxlcl9kZXZlbG9wbWVudCgpOwogICAgICB9CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9yZWFjdC1kb20vY2pzL3JlYWN0LWRvbS5kZXZlbG9wbWVudC5qcwogIHZhciByZXF1aXJlX3JlYWN0X2RvbV9kZXZlbG9wbWVudCA9IF9fY29tbW9uSlMoewogICAgIm5vZGVfbW9kdWxlcy9yZWFjdC1kb20vY2pzL3JlYWN0LWRvbS5kZXZlbG9wbWVudC5qcyIoZXhwb3J0cykgewogICAgICAidXNlIHN0cmljdCI7CiAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgKGZ1bmN0aW9uKCkgewogICAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgICAgaWYgKHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQobmV3IEVycm9yKCkpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIFJlYWN0NSA9IHJlcXVpcmVfcmVhY3QoKTsKICAgICAgICAgIHZhciBTY2hlZHVsZXIgPSByZXF1aXJlX3NjaGVkdWxlcigpOwogICAgICAgICAgdmFyIFJlYWN0U2hhcmVkSW50ZXJuYWxzID0gUmVhY3Q1Ll9fU0VDUkVUX0lOVEVSTkFMU19ET19OT1RfVVNFX09SX1lPVV9XSUxMX0JFX0ZJUkVEOwogICAgICAgICAgdmFyIHN1cHByZXNzV2FybmluZyA9IGZhbHNlOwogICAgICAgICAgZnVuY3Rpb24gc2V0U3VwcHJlc3NXYXJuaW5nKG5ld1N1cHByZXNzV2FybmluZykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc3VwcHJlc3NXYXJuaW5nID0gbmV3U3VwcHJlc3NXYXJuaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB3YXJuKGZvcm1hdCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCFzdXBwcmVzc1dhcm5pbmcpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4gPiAxID8gX2xlbiAtIDEgOiAwKSwgX2tleSA9IDE7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgICAgICAgICAgICAgYXJnc1tfa2V5IC0gMV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwcmludFdhcm5pbmcoIndhcm4iLCBmb3JtYXQsIGFyZ3MpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZXJyb3IoZm9ybWF0KSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIXN1cHByZXNzV2FybmluZykgewogICAgICAgICAgICAgICAgZm9yICh2YXIgX2xlbjIgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4yID4gMSA/IF9sZW4yIC0gMSA6IDApLCBfa2V5MiA9IDE7IF9rZXkyIDwgX2xlbjI7IF9rZXkyKyspIHsKICAgICAgICAgICAgICAgICAgYXJnc1tfa2V5MiAtIDFdID0gYXJndW1lbnRzW19rZXkyXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHByaW50V2FybmluZygiZXJyb3IiLCBmb3JtYXQsIGFyZ3MpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcHJpbnRXYXJuaW5nKGxldmVsLCBmb3JtYXQsIGFyZ3MpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lMiA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgICAgICAgdmFyIHN0YWNrID0gUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTIuZ2V0U3RhY2tBZGRlbmR1bSgpOwogICAgICAgICAgICAgIGlmIChzdGFjayAhPT0gIiIpIHsKICAgICAgICAgICAgICAgIGZvcm1hdCArPSAiJXMiOwogICAgICAgICAgICAgICAgYXJncyA9IGFyZ3MuY29uY2F0KFtzdGFja10pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgYXJnc1dpdGhGb3JtYXQgPSBhcmdzLm1hcChmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKGl0ZW0pOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGFyZ3NXaXRoRm9ybWF0LnVuc2hpZnQoIldhcm5pbmc6ICIgKyBmb3JtYXQpOwogICAgICAgICAgICAgIEZ1bmN0aW9uLnByb3RvdHlwZS5hcHBseS5jYWxsKGNvbnNvbGVbbGV2ZWxdLCBjb25zb2xlLCBhcmdzV2l0aEZvcm1hdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBGdW5jdGlvbkNvbXBvbmVudCA9IDA7CiAgICAgICAgICB2YXIgQ2xhc3NDb21wb25lbnQgPSAxOwogICAgICAgICAgdmFyIEluZGV0ZXJtaW5hdGVDb21wb25lbnQgPSAyOwogICAgICAgICAgdmFyIEhvc3RSb290ID0gMzsKICAgICAgICAgIHZhciBIb3N0UG9ydGFsID0gNDsKICAgICAgICAgIHZhciBIb3N0Q29tcG9uZW50ID0gNTsKICAgICAgICAgIHZhciBIb3N0VGV4dCA9IDY7CiAgICAgICAgICB2YXIgRnJhZ21lbnQgPSA3OwogICAgICAgICAgdmFyIE1vZGUgPSA4OwogICAgICAgICAgdmFyIENvbnRleHRDb25zdW1lciA9IDk7CiAgICAgICAgICB2YXIgQ29udGV4dFByb3ZpZGVyID0gMTA7CiAgICAgICAgICB2YXIgRm9yd2FyZFJlZiA9IDExOwogICAgICAgICAgdmFyIFByb2ZpbGVyID0gMTI7CiAgICAgICAgICB2YXIgU3VzcGVuc2VDb21wb25lbnQgPSAxMzsKICAgICAgICAgIHZhciBNZW1vQ29tcG9uZW50ID0gMTQ7CiAgICAgICAgICB2YXIgU2ltcGxlTWVtb0NvbXBvbmVudCA9IDE1OwogICAgICAgICAgdmFyIExhenlDb21wb25lbnQgPSAxNjsKICAgICAgICAgIHZhciBJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQgPSAxNzsKICAgICAgICAgIHZhciBEZWh5ZHJhdGVkRnJhZ21lbnQgPSAxODsKICAgICAgICAgIHZhciBTdXNwZW5zZUxpc3RDb21wb25lbnQgPSAxOTsKICAgICAgICAgIHZhciBTY29wZUNvbXBvbmVudCA9IDIxOwogICAgICAgICAgdmFyIE9mZnNjcmVlbkNvbXBvbmVudCA9IDIyOwogICAgICAgICAgdmFyIExlZ2FjeUhpZGRlbkNvbXBvbmVudCA9IDIzOwogICAgICAgICAgdmFyIENhY2hlQ29tcG9uZW50ID0gMjQ7CiAgICAgICAgICB2YXIgVHJhY2luZ01hcmtlckNvbXBvbmVudCA9IDI1OwogICAgICAgICAgdmFyIGVuYWJsZUNsaWVudFJlbmRlckZhbGxiYWNrT25UZXh0TWlzbWF0Y2ggPSB0cnVlOwogICAgICAgICAgdmFyIGVuYWJsZU5ld1JlY29uY2lsZXIgPSBmYWxzZTsKICAgICAgICAgIHZhciBlbmFibGVMYXp5Q29udGV4dFByb3BhZ2F0aW9uID0gZmFsc2U7CiAgICAgICAgICB2YXIgZW5hYmxlTGVnYWN5SGlkZGVuID0gZmFsc2U7CiAgICAgICAgICB2YXIgZW5hYmxlU3VzcGVuc2VBdm9pZFRoaXNGYWxsYmFjayA9IGZhbHNlOwogICAgICAgICAgdmFyIGRpc2FibGVDb21tZW50c0FzRE9NQ29udGFpbmVycyA9IHRydWU7CiAgICAgICAgICB2YXIgZW5hYmxlQ3VzdG9tRWxlbWVudFByb3BlcnR5U3VwcG9ydCA9IGZhbHNlOwogICAgICAgICAgdmFyIHdhcm5BYm91dFN0cmluZ1JlZnMgPSBmYWxzZTsKICAgICAgICAgIHZhciBlbmFibGVTY2hlZHVsaW5nUHJvZmlsZXIgPSB0cnVlOwogICAgICAgICAgdmFyIGVuYWJsZVByb2ZpbGVyVGltZXIgPSB0cnVlOwogICAgICAgICAgdmFyIGVuYWJsZVByb2ZpbGVyQ29tbWl0SG9va3MgPSB0cnVlOwogICAgICAgICAgdmFyIGFsbE5hdGl2ZUV2ZW50cyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICB2YXIgcmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcyA9IHt9OwogICAgICAgICAgdmFyIHBvc3NpYmxlUmVnaXN0cmF0aW9uTmFtZXMgPSB7fTsKICAgICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyVHdvUGhhc2VFdmVudChyZWdpc3RyYXRpb25OYW1lLCBkZXBlbmRlbmNpZXMpIHsKICAgICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudChyZWdpc3RyYXRpb25OYW1lLCBkZXBlbmRlbmNpZXMpOwogICAgICAgICAgICByZWdpc3RlckRpcmVjdEV2ZW50KHJlZ2lzdHJhdGlvbk5hbWUgKyAiQ2FwdHVyZSIsIGRlcGVuZGVuY2llcyk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZWdpc3RlckRpcmVjdEV2ZW50KHJlZ2lzdHJhdGlvbk5hbWUsIGRlcGVuZGVuY2llcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXNbcmVnaXN0cmF0aW9uTmFtZV0pIHsKICAgICAgICAgICAgICAgIGVycm9yKCJFdmVudFJlZ2lzdHJ5OiBNb3JlIHRoYW4gb25lIHBsdWdpbiBhdHRlbXB0ZWQgdG8gcHVibGlzaCB0aGUgc2FtZSByZWdpc3RyYXRpb24gbmFtZSwgYCVzYC4iLCByZWdpc3RyYXRpb25OYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llc1tyZWdpc3RyYXRpb25OYW1lXSA9IGRlcGVuZGVuY2llczsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBsb3dlckNhc2VkTmFtZSA9IHJlZ2lzdHJhdGlvbk5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzW2xvd2VyQ2FzZWROYW1lXSA9IHJlZ2lzdHJhdGlvbk5hbWU7CiAgICAgICAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbk5hbWUgPT09ICJvbkRvdWJsZUNsaWNrIikgewogICAgICAgICAgICAgICAgcG9zc2libGVSZWdpc3RyYXRpb25OYW1lcy5vbmRibGNsaWNrID0gcmVnaXN0cmF0aW9uTmFtZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkZXBlbmRlbmNpZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBhbGxOYXRpdmVFdmVudHMuYWRkKGRlcGVuZGVuY2llc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjYW5Vc2VET00gPSAhISh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygd2luZG93LmRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQgIT09ICJ1bmRlZmluZWQiKTsKICAgICAgICAgIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICAgICAgICBmdW5jdGlvbiB0eXBlTmFtZSh2YWx1ZSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIGhhc1RvU3RyaW5nVGFnID0gdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiBTeW1ib2wudG9TdHJpbmdUYWc7CiAgICAgICAgICAgICAgdmFyIHR5cGUyID0gaGFzVG9TdHJpbmdUYWcgJiYgdmFsdWVbU3ltYm9sLnRvU3RyaW5nVGFnXSB8fCB2YWx1ZS5jb25zdHJ1Y3Rvci5uYW1lIHx8ICJPYmplY3QiOwogICAgICAgICAgICAgIHJldHVybiB0eXBlMjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gd2lsbENvZXJjaW9uVGhyb3codmFsdWUpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiAiIiArIHZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY2hlY2tBdHRyaWJ1dGVTdHJpbmdDb2VyY2lvbih2YWx1ZSwgYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSBwcm92aWRlZCBgJXNgIGF0dHJpYnV0ZSBpcyBhbiB1bnN1cHBvcnRlZCB0eXBlICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgYXR0cmlidXRlTmFtZSwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY2hlY2tLZXlTdHJpbmdDb2VyY2lvbih2YWx1ZSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSBwcm92aWRlZCBrZXkgaXMgYW4gdW5zdXBwb3J0ZWQgdHlwZSAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHR5cGVOYW1lKHZhbHVlKSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNoZWNrUHJvcFN0cmluZ0NvZXJjaW9uKHZhbHVlLCBwcm9wTmFtZSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSBwcm92aWRlZCBgJXNgIHByb3AgaXMgYW4gdW5zdXBwb3J0ZWQgdHlwZSAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHByb3BOYW1lLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjaGVja0NTU1Byb3BlcnR5U3RyaW5nQ29lcmNpb24odmFsdWUsIHByb3BOYW1lKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAod2lsbENvZXJjaW9uVGhyb3codmFsdWUpKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIHByb3ZpZGVkIGAlc2AgQ1NTIHByb3BlcnR5IGlzIGFuIHVuc3VwcG9ydGVkIHR5cGUgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCBwcm9wTmFtZSwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY2hlY2tIdG1sU3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgcHJvdmlkZWQgSFRNTCBtYXJrdXAgdXNlcyBhIHZhbHVlIG9mIHVuc3VwcG9ydGVkIHR5cGUgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjaGVja0Zvcm1GaWVsZFZhbHVlU3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJGb3JtIGZpZWxkIHZhbHVlcyAodmFsdWUsIGNoZWNrZWQsIGRlZmF1bHRWYWx1ZSwgb3IgZGVmYXVsdENoZWNrZWQgcHJvcHMpIG11c3QgYmUgc3RyaW5ncywgbm90ICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIFJFU0VSVkVEID0gMDsKICAgICAgICAgIHZhciBTVFJJTkcgPSAxOwogICAgICAgICAgdmFyIEJPT0xFQU5JU0hfU1RSSU5HID0gMjsKICAgICAgICAgIHZhciBCT09MRUFOID0gMzsKICAgICAgICAgIHZhciBPVkVSTE9BREVEX0JPT0xFQU4gPSA0OwogICAgICAgICAgdmFyIE5VTUVSSUMgPSA1OwogICAgICAgICAgdmFyIFBPU0lUSVZFX05VTUVSSUMgPSA2OwogICAgICAgICAgdmFyIEFUVFJJQlVURV9OQU1FX1NUQVJUX0NIQVIgPSAiOkEtWl9hLXpcXHUwMEMwLVxcdTAwRDZcXHUwMEQ4LVxcdTAwRjZcXHUwMEY4LVxcdTAyRkZcXHUwMzcwLVxcdTAzN0RcXHUwMzdGLVxcdTFGRkZcXHUyMDBDLVxcdTIwMERcXHUyMDcwLVxcdTIxOEZcXHUyQzAwLVxcdTJGRUZcXHUzMDAxLVxcdUQ3RkZcXHVGOTAwLVxcdUZEQ0ZcXHVGREYwLVxcdUZGRkQiOwogICAgICAgICAgdmFyIEFUVFJJQlVURV9OQU1FX0NIQVIgPSBBVFRSSUJVVEVfTkFNRV9TVEFSVF9DSEFSICsgIlxcLS4wLTlcXHUwMEI3XFx1MDMwMC1cXHUwMzZGXFx1MjAzRi1cXHUyMDQwIjsKICAgICAgICAgIHZhciBWQUxJRF9BVFRSSUJVVEVfTkFNRV9SRUdFWCA9IG5ldyBSZWdFeHAoIl5bIiArIEFUVFJJQlVURV9OQU1FX1NUQVJUX0NIQVIgKyAiXVsiICsgQVRUUklCVVRFX05BTUVfQ0hBUiArICJdKiQiKTsKICAgICAgICAgIHZhciBpbGxlZ2FsQXR0cmlidXRlTmFtZUNhY2hlID0ge307CiAgICAgICAgICB2YXIgdmFsaWRhdGVkQXR0cmlidXRlTmFtZUNhY2hlID0ge307CiAgICAgICAgICBmdW5jdGlvbiBpc0F0dHJpYnV0ZU5hbWVTYWZlKGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwodmFsaWRhdGVkQXR0cmlidXRlTmFtZUNhY2hlLCBhdHRyaWJ1dGVOYW1lKSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGlsbGVnYWxBdHRyaWJ1dGVOYW1lQ2FjaGUsIGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChWQUxJRF9BVFRSSUJVVEVfTkFNRV9SRUdFWC50ZXN0KGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgICAgICAgdmFsaWRhdGVkQXR0cmlidXRlTmFtZUNhY2hlW2F0dHJpYnV0ZU5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbGxlZ2FsQXR0cmlidXRlTmFtZUNhY2hlW2F0dHJpYnV0ZU5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGF0dHJpYnV0ZSBuYW1lOiBgJXNgIiwgYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gc2hvdWxkSWdub3JlQXR0cmlidXRlKG5hbWUsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgICAgaWYgKHByb3BlcnR5SW5mbyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBwcm9wZXJ0eUluZm8udHlwZSA9PT0gUkVTRVJWRUQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChuYW1lLmxlbmd0aCA+IDIgJiYgKG5hbWVbMF0gPT09ICJvIiB8fCBuYW1lWzBdID09PSAiTyIpICYmIChuYW1lWzFdID09PSAibiIgfHwgbmFtZVsxXSA9PT0gIk4iKSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHNob3VsZFJlbW92ZUF0dHJpYnV0ZVdpdGhXYXJuaW5nKG5hbWUsIHZhbHVlLCBwcm9wZXJ0eUluZm8sIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8gIT09IG51bGwgJiYgcHJvcGVydHlJbmZvLnR5cGUgPT09IFJFU0VSVkVEKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN3aXRjaCAodHlwZW9mIHZhbHVlKSB7CiAgICAgICAgICAgICAgY2FzZSAiZnVuY3Rpb24iOgogICAgICAgICAgICAgIGNhc2UgInN5bWJvbCI6CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICBjYXNlICJib29sZWFuIjogewogICAgICAgICAgICAgICAgaWYgKGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8gIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuICFwcm9wZXJ0eUluZm8uYWNjZXB0c0Jvb2xlYW5zOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFyIHByZWZpeDIgPSBuYW1lLnRvTG93ZXJDYXNlKCkuc2xpY2UoMCwgNSk7CiAgICAgICAgICAgICAgICAgIHJldHVybiBwcmVmaXgyICE9PSAiZGF0YS0iICYmIHByZWZpeDIgIT09ICJhcmlhLSI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHNob3VsZFJlbW92ZUF0dHJpYnV0ZShuYW1lLCB2YWx1ZSwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdHlwZW9mIHZhbHVlID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaG91bGRSZW1vdmVBdHRyaWJ1dGVXaXRoV2FybmluZyhuYW1lLCB2YWx1ZSwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHByb3BlcnR5SW5mbyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAocHJvcGVydHlJbmZvLnR5cGUpIHsKICAgICAgICAgICAgICAgIGNhc2UgQk9PTEVBTjoKICAgICAgICAgICAgICAgICAgcmV0dXJuICF2YWx1ZTsKICAgICAgICAgICAgICAgIGNhc2UgT1ZFUkxPQURFRF9CT09MRUFOOgogICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgPT09IGZhbHNlOwogICAgICAgICAgICAgICAgY2FzZSBOVU1FUklDOgogICAgICAgICAgICAgICAgICByZXR1cm4gaXNOYU4odmFsdWUpOwogICAgICAgICAgICAgICAgY2FzZSBQT1NJVElWRV9OVU1FUklDOgogICAgICAgICAgICAgICAgICByZXR1cm4gaXNOYU4odmFsdWUpIHx8IHZhbHVlIDwgMTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0UHJvcGVydHlJbmZvKG5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIHByb3BlcnRpZXMuaGFzT3duUHJvcGVydHkobmFtZSkgPyBwcm9wZXJ0aWVzW25hbWVdIDogbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIFByb3BlcnR5SW5mb1JlY29yZChuYW1lLCB0eXBlMiwgbXVzdFVzZVByb3BlcnR5LCBhdHRyaWJ1dGVOYW1lLCBhdHRyaWJ1dGVOYW1lc3BhY2UsIHNhbml0aXplVVJMMiwgcmVtb3ZlRW1wdHlTdHJpbmcpIHsKICAgICAgICAgICAgdGhpcy5hY2NlcHRzQm9vbGVhbnMgPSB0eXBlMiA9PT0gQk9PTEVBTklTSF9TVFJJTkcgfHwgdHlwZTIgPT09IEJPT0xFQU4gfHwgdHlwZTIgPT09IE9WRVJMT0FERURfQk9PTEVBTjsKICAgICAgICAgICAgdGhpcy5hdHRyaWJ1dGVOYW1lID0gYXR0cmlidXRlTmFtZTsKICAgICAgICAgICAgdGhpcy5hdHRyaWJ1dGVOYW1lc3BhY2UgPSBhdHRyaWJ1dGVOYW1lc3BhY2U7CiAgICAgICAgICAgIHRoaXMubXVzdFVzZVByb3BlcnR5ID0gbXVzdFVzZVByb3BlcnR5OwogICAgICAgICAgICB0aGlzLnByb3BlcnR5TmFtZSA9IG5hbWU7CiAgICAgICAgICAgIHRoaXMudHlwZSA9IHR5cGUyOwogICAgICAgICAgICB0aGlzLnNhbml0aXplVVJMID0gc2FuaXRpemVVUkwyOwogICAgICAgICAgICB0aGlzLnJlbW92ZUVtcHR5U3RyaW5nID0gcmVtb3ZlRW1wdHlTdHJpbmc7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJvcGVydGllcyA9IHt9OwogICAgICAgICAgdmFyIHJlc2VydmVkUHJvcHMgPSBbCiAgICAgICAgICAgICJjaGlsZHJlbiIsCiAgICAgICAgICAgICJkYW5nZXJvdXNseVNldElubmVySFRNTCIsCiAgICAgICAgICAgIC8vIFRPRE86IFRoaXMgcHJldmVudHMgdGhlIGFzc2lnbm1lbnQgb2YgZGVmYXVsdFZhbHVlIHRvIHJlZ3VsYXIKICAgICAgICAgICAgLy8gZWxlbWVudHMgKG5vdCBqdXN0IGlucHV0cykuIE5vdyB0aGF0IFJlYWN0RE9NSW5wdXQgYXNzaWducyB0byB0aGUKICAgICAgICAgICAgLy8gZGVmYXVsdFZhbHVlIHByb3BlcnR5IC0tIGRvIHdlIG5lZWQgdGhpcz8KICAgICAgICAgICAgImRlZmF1bHRWYWx1ZSIsCiAgICAgICAgICAgICJkZWZhdWx0Q2hlY2tlZCIsCiAgICAgICAgICAgICJpbm5lckhUTUwiLAogICAgICAgICAgICAic3VwcHJlc3NDb250ZW50RWRpdGFibGVXYXJuaW5nIiwKICAgICAgICAgICAgInN1cHByZXNzSHlkcmF0aW9uV2FybmluZyIsCiAgICAgICAgICAgICJzdHlsZSIKICAgICAgICAgIF07CiAgICAgICAgICByZXNlcnZlZFByb3BzLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAgIFJFU0VSVkVELAogICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgICBmYWxzZQogICAgICAgICAgICApOwogICAgICAgICAgfSk7CiAgICAgICAgICBbWyJhY2NlcHRDaGFyc2V0IiwgImFjY2VwdC1jaGFyc2V0Il0sIFsiY2xhc3NOYW1lIiwgImNsYXNzIl0sIFsiaHRtbEZvciIsICJmb3IiXSwgWyJodHRwRXF1aXYiLCAiaHR0cC1lcXVpdiJdXS5mb3JFYWNoKGZ1bmN0aW9uKF9yZWYpIHsKICAgICAgICAgICAgdmFyIG5hbWUgPSBfcmVmWzBdLCBhdHRyaWJ1dGVOYW1lID0gX3JlZlsxXTsKICAgICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgICBTVFJJTkcsCiAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgICAgYXR0cmlidXRlTmFtZSwKICAgICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICAgICk7CiAgICAgICAgICB9KTsKICAgICAgICAgIFsiY29udGVudEVkaXRhYmxlIiwgImRyYWdnYWJsZSIsICJzcGVsbENoZWNrIiwgInZhbHVlIl0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgICAgQk9PTEVBTklTSF9TVFJJTkcsCiAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgICAgbmFtZS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICAgKTsKICAgICAgICAgIH0pOwogICAgICAgICAgWyJhdXRvUmV2ZXJzZSIsICJleHRlcm5hbFJlc291cmNlc1JlcXVpcmVkIiwgImZvY3VzYWJsZSIsICJwcmVzZXJ2ZUFscGhhIl0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgICAgQk9PTEVBTklTSF9TVFJJTkcsCiAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICAgICk7CiAgICAgICAgICB9KTsKICAgICAgICAgIFsKICAgICAgICAgICAgImFsbG93RnVsbFNjcmVlbiIsCiAgICAgICAgICAgICJhc3luYyIsCiAgICAgICAgICAgIC8vIE5vdGU6IHRoZXJlIGlzIGEgc3BlY2lhbCBjYXNlIHRoYXQgcHJldmVudHMgaXQgZnJvbSBiZWluZyB3cml0dGVuIHRvIHRoZSBET00KICAgICAgICAgICAgLy8gb24gdGhlIGNsaWVudCBzaWRlIGJlY2F1c2UgdGhlIGJyb3dzZXJzIGFyZSBpbmNvbnNpc3RlbnQuIEluc3RlYWQgd2UgY2FsbCBmb2N1cygpLgogICAgICAgICAgICAiYXV0b0ZvY3VzIiwKICAgICAgICAgICAgImF1dG9QbGF5IiwKICAgICAgICAgICAgImNvbnRyb2xzIiwKICAgICAgICAgICAgImRlZmF1bHQiLAogICAgICAgICAgICAiZGVmZXIiLAogICAgICAgICAgICAiZGlzYWJsZWQiLAogICAgICAgICAgICAiZGlzYWJsZVBpY3R1cmVJblBpY3R1cmUiLAogICAgICAgICAgICAiZGlzYWJsZVJlbW90ZVBsYXliYWNrIiwKICAgICAgICAgICAgImZvcm1Ob1ZhbGlkYXRlIiwKICAgICAgICAgICAgImhpZGRlbiIsCiAgICAgICAgICAgICJsb29wIiwKICAgICAgICAgICAgIm5vTW9kdWxlIiwKICAgICAgICAgICAgIm5vVmFsaWRhdGUiLAogICAgICAgICAgICAib3BlbiIsCiAgICAgICAgICAgICJwbGF5c0lubGluZSIsCiAgICAgICAgICAgICJyZWFkT25seSIsCiAgICAgICAgICAgICJyZXF1aXJlZCIsCiAgICAgICAgICAgICJyZXZlcnNlZCIsCiAgICAgICAgICAgICJzY29wZWQiLAogICAgICAgICAgICAic2VhbWxlc3MiLAogICAgICAgICAgICAvLyBNaWNyb2RhdGEKICAgICAgICAgICAgIml0ZW1TY29wZSIKICAgICAgICAgIF0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgICAgQk9PTEVBTiwKICAgICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgICBuYW1lLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgICBmYWxzZQogICAgICAgICAgICApOwogICAgICAgICAgfSk7CiAgICAgICAgICBbCiAgICAgICAgICAgICJjaGVja2VkIiwKICAgICAgICAgICAgLy8gTm90ZTogYG9wdGlvbi5zZWxlY3RlZGAgaXMgbm90IHVwZGF0ZWQgaWYgYHNlbGVjdC5tdWx0aXBsZWAgaXMKICAgICAgICAgICAgLy8gZGlzYWJsZWQgd2l0aCBgcmVtb3ZlQXR0cmlidXRlYC4gV2UgaGF2ZSBzcGVjaWFsIGxvZ2ljIGZvciBoYW5kbGluZyB0aGlzLgogICAgICAgICAgICAibXVsdGlwbGUiLAogICAgICAgICAgICAibXV0ZWQiLAogICAgICAgICAgICAic2VsZWN0ZWQiCiAgICAgICAgICAgIC8vIE5PVEU6IGlmIHlvdSBhZGQgYSBjYW1lbENhc2VkIHByb3AgdG8gdGhpcyBsaXN0LAogICAgICAgICAgICAvLyB5b3UnbGwgbmVlZCB0byBzZXQgYXR0cmlidXRlTmFtZSB0byBuYW1lLnRvTG93ZXJDYXNlKCkKICAgICAgICAgICAgLy8gaW5zdGVhZCBpbiB0aGUgYXNzaWdubWVudCBiZWxvdy4KICAgICAgICAgIF0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgICAgQk9PTEVBTiwKICAgICAgICAgICAgICB0cnVlLAogICAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgICBmYWxzZQogICAgICAgICAgICApOwogICAgICAgICAgfSk7CiAgICAgICAgICBbCiAgICAgICAgICAgICJjYXB0dXJlIiwKICAgICAgICAgICAgImRvd25sb2FkIgogICAgICAgICAgICAvLyBOT1RFOiBpZiB5b3UgYWRkIGEgY2FtZWxDYXNlZCBwcm9wIHRvIHRoaXMgbGlzdCwKICAgICAgICAgICAgLy8geW91J2xsIG5lZWQgdG8gc2V0IGF0dHJpYnV0ZU5hbWUgdG8gbmFtZS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAgIC8vIGluc3RlYWQgaW4gdGhlIGFzc2lnbm1lbnQgYmVsb3cuCiAgICAgICAgICBdLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAgIE9WRVJMT0FERURfQk9PTEVBTiwKICAgICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICAgKTsKICAgICAgICAgIH0pOwogICAgICAgICAgWwogICAgICAgICAgICAiY29scyIsCiAgICAgICAgICAgICJyb3dzIiwKICAgICAgICAgICAgInNpemUiLAogICAgICAgICAgICAic3BhbiIKICAgICAgICAgICAgLy8gTk9URTogaWYgeW91IGFkZCBhIGNhbWVsQ2FzZWQgcHJvcCB0byB0aGlzIGxpc3QsCiAgICAgICAgICAgIC8vIHlvdSdsbCBuZWVkIHRvIHNldCBhdHRyaWJ1dGVOYW1lIHRvIG5hbWUudG9Mb3dlckNhc2UoKQogICAgICAgICAgICAvLyBpbnN0ZWFkIGluIHRoZSBhc3NpZ25tZW50IGJlbG93LgogICAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgICBQT1NJVElWRV9OVU1FUklDLAogICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgICBmYWxzZQogICAgICAgICAgICApOwogICAgICAgICAgfSk7CiAgICAgICAgICBbInJvd1NwYW4iLCAic3RhcnQiXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgICBOVU1FUklDLAogICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICAgIG5hbWUudG9Mb3dlckNhc2UoKSwKICAgICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICAgICk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHZhciBDQU1FTElaRSA9IC9bXC1cOl0oW2Etel0pL2c7CiAgICAgICAgICB2YXIgY2FwaXRhbGl6ZSA9IGZ1bmN0aW9uKHRva2VuKSB7CiAgICAgICAgICAgIHJldHVybiB0b2tlblsxXS50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgfTsKICAgICAgICAgIFsKICAgICAgICAgICAgImFjY2VudC1oZWlnaHQiLAogICAgICAgICAgICAiYWxpZ25tZW50LWJhc2VsaW5lIiwKICAgICAgICAgICAgImFyYWJpYy1mb3JtIiwKICAgICAgICAgICAgImJhc2VsaW5lLXNoaWZ0IiwKICAgICAgICAgICAgImNhcC1oZWlnaHQiLAogICAgICAgICAgICAiY2xpcC1wYXRoIiwKICAgICAgICAgICAgImNsaXAtcnVsZSIsCiAgICAgICAgICAgICJjb2xvci1pbnRlcnBvbGF0aW9uIiwKICAgICAgICAgICAgImNvbG9yLWludGVycG9sYXRpb24tZmlsdGVycyIsCiAgICAgICAgICAgICJjb2xvci1wcm9maWxlIiwKICAgICAgICAgICAgImNvbG9yLXJlbmRlcmluZyIsCiAgICAgICAgICAgICJkb21pbmFudC1iYXNlbGluZSIsCiAgICAgICAgICAgICJlbmFibGUtYmFja2dyb3VuZCIsCiAgICAgICAgICAgICJmaWxsLW9wYWNpdHkiLAogICAgICAgICAgICAiZmlsbC1ydWxlIiwKICAgICAgICAgICAgImZsb29kLWNvbG9yIiwKICAgICAgICAgICAgImZsb29kLW9wYWNpdHkiLAogICAgICAgICAgICAiZm9udC1mYW1pbHkiLAogICAgICAgICAgICAiZm9udC1zaXplIiwKICAgICAgICAgICAgImZvbnQtc2l6ZS1hZGp1c3QiLAogICAgICAgICAgICAiZm9udC1zdHJldGNoIiwKICAgICAgICAgICAgImZvbnQtc3R5bGUiLAogICAgICAgICAgICAiZm9udC12YXJpYW50IiwKICAgICAgICAgICAgImZvbnQtd2VpZ2h0IiwKICAgICAgICAgICAgImdseXBoLW5hbWUiLAogICAgICAgICAgICAiZ2x5cGgtb3JpZW50YXRpb24taG9yaXpvbnRhbCIsCiAgICAgICAgICAgICJnbHlwaC1vcmllbnRhdGlvbi12ZXJ0aWNhbCIsCiAgICAgICAgICAgICJob3Jpei1hZHYteCIsCiAgICAgICAgICAgICJob3Jpei1vcmlnaW4teCIsCiAgICAgICAgICAgICJpbWFnZS1yZW5kZXJpbmciLAogICAgICAgICAgICAibGV0dGVyLXNwYWNpbmciLAogICAgICAgICAgICAibGlnaHRpbmctY29sb3IiLAogICAgICAgICAgICAibWFya2VyLWVuZCIsCiAgICAgICAgICAgICJtYXJrZXItbWlkIiwKICAgICAgICAgICAgIm1hcmtlci1zdGFydCIsCiAgICAgICAgICAgICJvdmVybGluZS1wb3NpdGlvbiIsCiAgICAgICAgICAgICJvdmVybGluZS10aGlja25lc3MiLAogICAgICAgICAgICAicGFpbnQtb3JkZXIiLAogICAgICAgICAgICAicGFub3NlLTEiLAogICAgICAgICAgICAicG9pbnRlci1ldmVudHMiLAogICAgICAgICAgICAicmVuZGVyaW5nLWludGVudCIsCiAgICAgICAgICAgICJzaGFwZS1yZW5kZXJpbmciLAogICAgICAgICAgICAic3RvcC1jb2xvciIsCiAgICAgICAgICAgICJzdG9wLW9wYWNpdHkiLAogICAgICAgICAgICAic3RyaWtldGhyb3VnaC1wb3NpdGlvbiIsCiAgICAgICAgICAgICJzdHJpa2V0aHJvdWdoLXRoaWNrbmVzcyIsCiAgICAgICAgICAgICJzdHJva2UtZGFzaGFycmF5IiwKICAgICAgICAgICAgInN0cm9rZS1kYXNob2Zmc2V0IiwKICAgICAgICAgICAgInN0cm9rZS1saW5lY2FwIiwKICAgICAgICAgICAgInN0cm9rZS1saW5lam9pbiIsCiAgICAgICAgICAgICJzdHJva2UtbWl0ZXJsaW1pdCIsCiAgICAgICAgICAgICJzdHJva2Utb3BhY2l0eSIsCiAgICAgICAgICAgICJzdHJva2Utd2lkdGgiLAogICAgICAgICAgICAidGV4dC1hbmNob3IiLAogICAgICAgICAgICAidGV4dC1kZWNvcmF0aW9uIiwKICAgICAgICAgICAgInRleHQtcmVuZGVyaW5nIiwKICAgICAgICAgICAgInVuZGVybGluZS1wb3NpdGlvbiIsCiAgICAgICAgICAgICJ1bmRlcmxpbmUtdGhpY2tuZXNzIiwKICAgICAgICAgICAgInVuaWNvZGUtYmlkaSIsCiAgICAgICAgICAgICJ1bmljb2RlLXJhbmdlIiwKICAgICAgICAgICAgInVuaXRzLXBlci1lbSIsCiAgICAgICAgICAgICJ2LWFscGhhYmV0aWMiLAogICAgICAgICAgICAidi1oYW5naW5nIiwKICAgICAgICAgICAgInYtaWRlb2dyYXBoaWMiLAogICAgICAgICAgICAidi1tYXRoZW1hdGljYWwiLAogICAgICAgICAgICAidmVjdG9yLWVmZmVjdCIsCiAgICAgICAgICAgICJ2ZXJ0LWFkdi15IiwKICAgICAgICAgICAgInZlcnQtb3JpZ2luLXgiLAogICAgICAgICAgICAidmVydC1vcmlnaW4teSIsCiAgICAgICAgICAgICJ3b3JkLXNwYWNpbmciLAogICAgICAgICAgICAid3JpdGluZy1tb2RlIiwKICAgICAgICAgICAgInhtbG5zOnhsaW5rIiwKICAgICAgICAgICAgIngtaGVpZ2h0IgogICAgICAgICAgICAvLyBOT1RFOiBpZiB5b3UgYWRkIGEgY2FtZWxDYXNlZCBwcm9wIHRvIHRoaXMgbGlzdCwKICAgICAgICAgICAgLy8geW91J2xsIG5lZWQgdG8gc2V0IGF0dHJpYnV0ZU5hbWUgdG8gbmFtZS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAgIC8vIGluc3RlYWQgaW4gdGhlIGFzc2lnbm1lbnQgYmVsb3cuCiAgICAgICAgICBdLmZvckVhY2goZnVuY3Rpb24oYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgICB2YXIgbmFtZSA9IGF0dHJpYnV0ZU5hbWUucmVwbGFjZShDQU1FTElaRSwgY2FwaXRhbGl6ZSk7CiAgICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgICAgU1RSSU5HLAogICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUsCiAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICAgICk7CiAgICAgICAgICB9KTsKICAgICAgICAgIFsKICAgICAgICAgICAgInhsaW5rOmFjdHVhdGUiLAogICAgICAgICAgICAieGxpbms6YXJjcm9sZSIsCiAgICAgICAgICAgICJ4bGluazpyb2xlIiwKICAgICAgICAgICAgInhsaW5rOnNob3ciLAogICAgICAgICAgICAieGxpbms6dGl0bGUiLAogICAgICAgICAgICAieGxpbms6dHlwZSIKICAgICAgICAgICAgLy8gTk9URTogaWYgeW91IGFkZCBhIGNhbWVsQ2FzZWQgcHJvcCB0byB0aGlzIGxpc3QsCiAgICAgICAgICAgIC8vIHlvdSdsbCBuZWVkIHRvIHNldCBhdHRyaWJ1dGVOYW1lIHRvIG5hbWUudG9Mb3dlckNhc2UoKQogICAgICAgICAgICAvLyBpbnN0ZWFkIGluIHRoZSBhc3NpZ25tZW50IGJlbG93LgogICAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICAgICAgdmFyIG5hbWUgPSBhdHRyaWJ1dGVOYW1lLnJlcGxhY2UoQ0FNRUxJWkUsIGNhcGl0YWxpemUpOwogICAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAgIFNUUklORywKICAgICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLAogICAgICAgICAgICAgICJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiwKICAgICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICAgICk7CiAgICAgICAgICB9KTsKICAgICAgICAgIFsKICAgICAgICAgICAgInhtbDpiYXNlIiwKICAgICAgICAgICAgInhtbDpsYW5nIiwKICAgICAgICAgICAgInhtbDpzcGFjZSIKICAgICAgICAgICAgLy8gTk9URTogaWYgeW91IGFkZCBhIGNhbWVsQ2FzZWQgcHJvcCB0byB0aGlzIGxpc3QsCiAgICAgICAgICAgIC8vIHlvdSdsbCBuZWVkIHRvIHNldCBhdHRyaWJ1dGVOYW1lIHRvIG5hbWUudG9Mb3dlckNhc2UoKQogICAgICAgICAgICAvLyBpbnN0ZWFkIGluIHRoZSBhc3NpZ25tZW50IGJlbG93LgogICAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICAgICAgdmFyIG5hbWUgPSBhdHRyaWJ1dGVOYW1lLnJlcGxhY2UoQ0FNRUxJWkUsIGNhcGl0YWxpemUpOwogICAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAgIFNUUklORywKICAgICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLAogICAgICAgICAgICAgICJodHRwOi8vd3d3LnczLm9yZy9YTUwvMTk5OC9uYW1lc3BhY2UiLAogICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICAgKTsKICAgICAgICAgIH0pOwogICAgICAgICAgWyJ0YWJJbmRleCIsICJjcm9zc09yaWdpbiJdLmZvckVhY2goZnVuY3Rpb24oYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgICBwcm9wZXJ0aWVzW2F0dHJpYnV0ZU5hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLAogICAgICAgICAgICAgIFNUUklORywKICAgICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgICBmYWxzZQogICAgICAgICAgICApOwogICAgICAgICAgfSk7CiAgICAgICAgICB2YXIgeGxpbmtIcmVmID0gInhsaW5rSHJlZiI7CiAgICAgICAgICBwcm9wZXJ0aWVzW3hsaW5rSHJlZl0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICAieGxpbmtIcmVmIiwKICAgICAgICAgICAgU1RSSU5HLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgICJ4bGluazpocmVmIiwKICAgICAgICAgICAgImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiLAogICAgICAgICAgICB0cnVlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICAgIFsic3JjIiwgImhyZWYiLCAiYWN0aW9uIiwgImZvcm1BY3Rpb24iXS5mb3JFYWNoKGZ1bmN0aW9uKGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICAgICAgcHJvcGVydGllc1thdHRyaWJ1dGVOYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgICAgYXR0cmlidXRlTmFtZSwKICAgICAgICAgICAgICBTVFJJTkcsCiAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgICAgYXR0cmlidXRlTmFtZS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICAgIHRydWUsCiAgICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgICB0cnVlCiAgICAgICAgICAgICk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHZhciBpc0phdmFTY3JpcHRQcm90b2NvbCA9IC9eW1x1MDAwMC1cdTAwMUYgXSpqW1xyXG5cdF0qYVtcclxuXHRdKnZbXHJcblx0XSphW1xyXG5cdF0qc1tcclxuXHRdKmNbXHJcblx0XSpyW1xyXG5cdF0qaVtcclxuXHRdKnBbXHJcblx0XSp0W1xyXG5cdF0qXDovaTsKICAgICAgICAgIHZhciBkaWRXYXJuID0gZmFsc2U7CiAgICAgICAgICBmdW5jdGlvbiBzYW5pdGl6ZVVSTCh1cmwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghZGlkV2FybiAmJiBpc0phdmFTY3JpcHRQcm90b2NvbC50ZXN0KHVybCkpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm4gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIkEgZnV0dXJlIHZlcnNpb24gb2YgUmVhY3Qgd2lsbCBibG9jayBqYXZhc2NyaXB0OiBVUkxzIGFzIGEgc2VjdXJpdHkgcHJlY2F1dGlvbi4gVXNlIGV2ZW50IGhhbmRsZXJzIGluc3RlYWQgaWYgeW91IGNhbi4gSWYgeW91IG5lZWQgdG8gZ2VuZXJhdGUgdW5zYWZlIEhUTUwgdHJ5IHVzaW5nIGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MIGluc3RlYWQuIFJlYWN0IHdhcyBwYXNzZWQgJXMuIiwgSlNPTi5zdHJpbmdpZnkodXJsKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRWYWx1ZUZvclByb3BlcnR5KG5vZGUsIG5hbWUsIGV4cGVjdGVkLCBwcm9wZXJ0eUluZm8pIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8ubXVzdFVzZVByb3BlcnR5KSB7CiAgICAgICAgICAgICAgICB2YXIgcHJvcGVydHlOYW1lID0gcHJvcGVydHlJbmZvLnByb3BlcnR5TmFtZTsKICAgICAgICAgICAgICAgIHJldHVybiBub2RlW3Byb3BlcnR5TmFtZV07CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgY2hlY2tBdHRyaWJ1dGVTdHJpbmdDb2VyY2lvbihleHBlY3RlZCwgbmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvLnNhbml0aXplVVJMKSB7CiAgICAgICAgICAgICAgICAgIHNhbml0aXplVVJMKCIiICsgZXhwZWN0ZWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZU5hbWUgPSBwcm9wZXJ0eUluZm8uYXR0cmlidXRlTmFtZTsKICAgICAgICAgICAgICAgIHZhciBzdHJpbmdWYWx1ZSA9IG51bGw7CiAgICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvLnR5cGUgPT09IE9WRVJMT0FERURfQk9PTEVBTikgewogICAgICAgICAgICAgICAgICBpZiAobm9kZS5oYXNBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBub2RlLmdldEF0dHJpYnV0ZShhdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09ICIiKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHNob3VsZFJlbW92ZUF0dHJpYnV0ZShuYW1lLCBleHBlY3RlZCwgcHJvcGVydHlJbmZvLCBmYWxzZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSAiIiArIGV4cGVjdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXhwZWN0ZWQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLmhhc0F0dHJpYnV0ZShhdHRyaWJ1dGVOYW1lKSkgewogICAgICAgICAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlKG5hbWUsIGV4cGVjdGVkLCBwcm9wZXJ0eUluZm8sIGZhbHNlKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlLmdldEF0dHJpYnV0ZShhdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvLnR5cGUgPT09IEJPT0xFQU4pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXhwZWN0ZWQ7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc3RyaW5nVmFsdWUgPSBub2RlLmdldEF0dHJpYnV0ZShhdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChzaG91bGRSZW1vdmVBdHRyaWJ1dGUobmFtZSwgZXhwZWN0ZWQsIHByb3BlcnR5SW5mbywgZmFsc2UpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBzdHJpbmdWYWx1ZSA9PT0gbnVsbCA/IGV4cGVjdGVkIDogc3RyaW5nVmFsdWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmluZ1ZhbHVlID09PSAiIiArIGV4cGVjdGVkKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBleHBlY3RlZDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBzdHJpbmdWYWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldFZhbHVlRm9yQXR0cmlidXRlKG5vZGUsIG5hbWUsIGV4cGVjdGVkLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCFpc0F0dHJpYnV0ZU5hbWVTYWZlKG5hbWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghbm9kZS5oYXNBdHRyaWJ1dGUobmFtZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBleHBlY3RlZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHZhbHVlID0gbm9kZS5nZXRBdHRyaWJ1dGUobmFtZSk7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tBdHRyaWJ1dGVTdHJpbmdDb2VyY2lvbihleHBlY3RlZCwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gIiIgKyBleHBlY3RlZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGV4cGVjdGVkOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHNldFZhbHVlRm9yUHJvcGVydHkobm9kZSwgbmFtZSwgdmFsdWUsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICAgIHZhciBwcm9wZXJ0eUluZm8gPSBnZXRQcm9wZXJ0eUluZm8obmFtZSk7CiAgICAgICAgICAgIGlmIChzaG91bGRJZ25vcmVBdHRyaWJ1dGUobmFtZSwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNob3VsZFJlbW92ZUF0dHJpYnV0ZShuYW1lLCB2YWx1ZSwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykpIHsKICAgICAgICAgICAgICB2YWx1ZSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzQ3VzdG9tQ29tcG9uZW50VGFnIHx8IHByb3BlcnR5SW5mbyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChpc0F0dHJpYnV0ZU5hbWVTYWZlKG5hbWUpKSB7CiAgICAgICAgICAgICAgICB2YXIgX2F0dHJpYnV0ZU5hbWUgPSBuYW1lOwogICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIG5vZGUucmVtb3ZlQXR0cmlidXRlKF9hdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBjaGVja0F0dHJpYnV0ZVN0cmluZ0NvZXJjaW9uKHZhbHVlLCBuYW1lKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBub2RlLnNldEF0dHJpYnV0ZShfYXR0cmlidXRlTmFtZSwgIiIgKyB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbXVzdFVzZVByb3BlcnR5ID0gcHJvcGVydHlJbmZvLm11c3RVc2VQcm9wZXJ0eTsKICAgICAgICAgICAgaWYgKG11c3RVc2VQcm9wZXJ0eSkgewogICAgICAgICAgICAgIHZhciBwcm9wZXJ0eU5hbWUgPSBwcm9wZXJ0eUluZm8ucHJvcGVydHlOYW1lOwogICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHR5cGUyID0gcHJvcGVydHlJbmZvLnR5cGU7CiAgICAgICAgICAgICAgICBub2RlW3Byb3BlcnR5TmFtZV0gPSB0eXBlMiA9PT0gQk9PTEVBTiA/IGZhbHNlIDogIiI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5vZGVbcHJvcGVydHlOYW1lXSA9IHZhbHVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZU5hbWUgPSBwcm9wZXJ0eUluZm8uYXR0cmlidXRlTmFtZSwgYXR0cmlidXRlTmFtZXNwYWNlID0gcHJvcGVydHlJbmZvLmF0dHJpYnV0ZU5hbWVzcGFjZTsKICAgICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgbm9kZS5yZW1vdmVBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF90eXBlID0gcHJvcGVydHlJbmZvLnR5cGU7CiAgICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZVZhbHVlOwogICAgICAgICAgICAgIGlmIChfdHlwZSA9PT0gQk9PTEVBTiB8fCBfdHlwZSA9PT0gT1ZFUkxPQURFRF9CT09MRUFOICYmIHZhbHVlID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVWYWx1ZSA9ICIiOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBjaGVja0F0dHJpYnV0ZVN0cmluZ0NvZXJjaW9uKHZhbHVlLCBhdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBhdHRyaWJ1dGVWYWx1ZSA9ICIiICsgdmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvLnNhbml0aXplVVJMKSB7CiAgICAgICAgICAgICAgICAgIHNhbml0aXplVVJMKGF0dHJpYnV0ZVZhbHVlLnRvU3RyaW5nKCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoYXR0cmlidXRlTmFtZXNwYWNlKSB7CiAgICAgICAgICAgICAgICBub2RlLnNldEF0dHJpYnV0ZU5TKGF0dHJpYnV0ZU5hbWVzcGFjZSwgYXR0cmlidXRlTmFtZSwgYXR0cmlidXRlVmFsdWUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBub2RlLnNldEF0dHJpYnV0ZShhdHRyaWJ1dGVOYW1lLCBhdHRyaWJ1dGVWYWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgUkVBQ1RfRUxFTUVOVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZWxlbWVudCIpOwogICAgICAgICAgdmFyIFJFQUNUX1BPUlRBTF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucG9ydGFsIik7CiAgICAgICAgICB2YXIgUkVBQ1RfRlJBR01FTlRfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmZyYWdtZW50Iik7CiAgICAgICAgICB2YXIgUkVBQ1RfU1RSSUNUX01PREVfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN0cmljdF9tb2RlIik7CiAgICAgICAgICB2YXIgUkVBQ1RfUFJPRklMRVJfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnByb2ZpbGVyIik7CiAgICAgICAgICB2YXIgUkVBQ1RfUFJPVklERVJfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnByb3ZpZGVyIik7CiAgICAgICAgICB2YXIgUkVBQ1RfQ09OVEVYVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuY29udGV4dCIpOwogICAgICAgICAgdmFyIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5mb3J3YXJkX3JlZiIpOwogICAgICAgICAgdmFyIFJFQUNUX1NVU1BFTlNFX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5zdXNwZW5zZSIpOwogICAgICAgICAgdmFyIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlX2xpc3QiKTsKICAgICAgICAgIHZhciBSRUFDVF9NRU1PX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5tZW1vIik7CiAgICAgICAgICB2YXIgUkVBQ1RfTEFaWV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QubGF6eSIpOwogICAgICAgICAgdmFyIFJFQUNUX1NDT1BFX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5zY29wZSIpOwogICAgICAgICAgdmFyIFJFQUNUX0RFQlVHX1RSQUNJTkdfTU9ERV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZGVidWdfdHJhY2VfbW9kZSIpOwogICAgICAgICAgdmFyIFJFQUNUX09GRlNDUkVFTl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Qub2Zmc2NyZWVuIik7CiAgICAgICAgICB2YXIgUkVBQ1RfTEVHQUNZX0hJRERFTl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QubGVnYWN5X2hpZGRlbiIpOwogICAgICAgICAgdmFyIFJFQUNUX0NBQ0hFX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5jYWNoZSIpOwogICAgICAgICAgdmFyIFJFQUNUX1RSQUNJTkdfTUFSS0VSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC50cmFjaW5nX21hcmtlciIpOwogICAgICAgICAgdmFyIE1BWUJFX0lURVJBVE9SX1NZTUJPTCA9IFN5bWJvbC5pdGVyYXRvcjsKICAgICAgICAgIHZhciBGQVVYX0lURVJBVE9SX1NZTUJPTCA9ICJAQGl0ZXJhdG9yIjsKICAgICAgICAgIGZ1bmN0aW9uIGdldEl0ZXJhdG9yRm4obWF5YmVJdGVyYWJsZSkgewogICAgICAgICAgICBpZiAobWF5YmVJdGVyYWJsZSA9PT0gbnVsbCB8fCB0eXBlb2YgbWF5YmVJdGVyYWJsZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbWF5YmVJdGVyYXRvciA9IE1BWUJFX0lURVJBVE9SX1NZTUJPTCAmJiBtYXliZUl0ZXJhYmxlW01BWUJFX0lURVJBVE9SX1NZTUJPTF0gfHwgbWF5YmVJdGVyYWJsZVtGQVVYX0lURVJBVE9SX1NZTUJPTF07CiAgICAgICAgICAgIGlmICh0eXBlb2YgbWF5YmVJdGVyYXRvciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHJldHVybiBtYXliZUl0ZXJhdG9yOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGFzc2lnbiA9IE9iamVjdC5hc3NpZ247CiAgICAgICAgICB2YXIgZGlzYWJsZWREZXB0aCA9IDA7CiAgICAgICAgICB2YXIgcHJldkxvZzsKICAgICAgICAgIHZhciBwcmV2SW5mbzsKICAgICAgICAgIHZhciBwcmV2V2FybjsKICAgICAgICAgIHZhciBwcmV2RXJyb3I7CiAgICAgICAgICB2YXIgcHJldkdyb3VwOwogICAgICAgICAgdmFyIHByZXZHcm91cENvbGxhcHNlZDsKICAgICAgICAgIHZhciBwcmV2R3JvdXBFbmQ7CiAgICAgICAgICBmdW5jdGlvbiBkaXNhYmxlZExvZygpIHsKICAgICAgICAgIH0KICAgICAgICAgIGRpc2FibGVkTG9nLl9fcmVhY3REaXNhYmxlZExvZyA9IHRydWU7CiAgICAgICAgICBmdW5jdGlvbiBkaXNhYmxlTG9ncygpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgICBwcmV2TG9nID0gY29uc29sZS5sb2c7CiAgICAgICAgICAgICAgICBwcmV2SW5mbyA9IGNvbnNvbGUuaW5mbzsKICAgICAgICAgICAgICAgIHByZXZXYXJuID0gY29uc29sZS53YXJuOwogICAgICAgICAgICAgICAgcHJldkVycm9yID0gY29uc29sZS5lcnJvcjsKICAgICAgICAgICAgICAgIHByZXZHcm91cCA9IGNvbnNvbGUuZ3JvdXA7CiAgICAgICAgICAgICAgICBwcmV2R3JvdXBDb2xsYXBzZWQgPSBjb25zb2xlLmdyb3VwQ29sbGFwc2VkOwogICAgICAgICAgICAgICAgcHJldkdyb3VwRW5kID0gY29uc29sZS5ncm91cEVuZDsKICAgICAgICAgICAgICAgIHZhciBwcm9wcyA9IHsKICAgICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgICB2YWx1ZTogZGlzYWJsZWRMb2csCiAgICAgICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoY29uc29sZSwgewogICAgICAgICAgICAgICAgICBpbmZvOiBwcm9wcywKICAgICAgICAgICAgICAgICAgbG9nOiBwcm9wcywKICAgICAgICAgICAgICAgICAgd2FybjogcHJvcHMsCiAgICAgICAgICAgICAgICAgIGVycm9yOiBwcm9wcywKICAgICAgICAgICAgICAgICAgZ3JvdXA6IHByb3BzLAogICAgICAgICAgICAgICAgICBncm91cENvbGxhcHNlZDogcHJvcHMsCiAgICAgICAgICAgICAgICAgIGdyb3VwRW5kOiBwcm9wcwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRpc2FibGVkRGVwdGgrKzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVlbmFibGVMb2dzKCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZGlzYWJsZWREZXB0aC0tOwogICAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJvcHMgPSB7CiAgICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhjb25zb2xlLCB7CiAgICAgICAgICAgICAgICAgIGxvZzogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2TG9nCiAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICBpbmZvOiBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZJbmZvCiAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICB3YXJuOiBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZXYXJuCiAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICBlcnJvcjogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2RXJyb3IKICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgIGdyb3VwOiBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cAogICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgZ3JvdXBDb2xsYXBzZWQ6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwQ29sbGFwc2VkCiAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICBncm91cEVuZDogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2R3JvdXBFbmQKICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA8IDApIHsKICAgICAgICAgICAgICAgIGVycm9yKCJkaXNhYmxlZERlcHRoIGZlbGwgYmVsb3cgemVyby4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudERpc3BhdGNoZXI7CiAgICAgICAgICB2YXIgcHJlZml4OwogICAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUobmFtZSwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAocHJlZml4ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSB4Mi5zdGFjay50cmltKCkubWF0Y2goL1xuKCAqKGF0ICk/KS8pOwogICAgICAgICAgICAgICAgICBwcmVmaXggPSBtYXRjaCAmJiBtYXRjaFsxXSB8fCAiIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuICJcbiIgKyBwcmVmaXggKyBuYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcmVlbnRyeSA9IGZhbHNlOwogICAgICAgICAgdmFyIGNvbXBvbmVudEZyYW1lQ2FjaGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBQb3NzaWJseVdlYWtNYXAgPSB0eXBlb2YgV2Vha01hcCA9PT0gImZ1bmN0aW9uIiA/IFdlYWtNYXAgOiBNYXA7CiAgICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUgPSBuZXcgUG9zc2libHlXZWFrTWFwKCk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKGZuLCBjb25zdHJ1Y3QpIHsKICAgICAgICAgICAgaWYgKCFmbiB8fCByZWVudHJ5KSB7CiAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgZnJhbWUyID0gY29tcG9uZW50RnJhbWVDYWNoZS5nZXQoZm4pOwogICAgICAgICAgICAgIGlmIChmcmFtZTIgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZyYW1lMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNvbnRyb2w7CiAgICAgICAgICAgIHJlZW50cnkgPSB0cnVlOwogICAgICAgICAgICB2YXIgcHJldmlvdXNQcmVwYXJlU3RhY2tUcmFjZSA9IEVycm9yLnByZXBhcmVTdGFja1RyYWNlOwogICAgICAgICAgICBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZSA9IHZvaWQgMDsKICAgICAgICAgICAgdmFyIHByZXZpb3VzRGlzcGF0Y2hlcjsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHByZXZpb3VzRGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICAgIGRpc2FibGVMb2dzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBpZiAoY29uc3RydWN0KSB7CiAgICAgICAgICAgICAgICB2YXIgRmFrZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShGYWtlLnByb3RvdHlwZSwgInByb3BzIiwgewogICAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSAib2JqZWN0IiAmJiBSZWZsZWN0LmNvbnN0cnVjdCkgewogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIFJlZmxlY3QuY29uc3RydWN0KEZha2UsIFtdKTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgICAgICBjb250cm9sID0geDI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgUmVmbGVjdC5jb25zdHJ1Y3QoZm4sIFtdLCBGYWtlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgRmFrZS5jYWxsKCk7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgICAgY29udHJvbCA9IHgyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGZuLmNhbGwoRmFrZS5wcm90b3R5cGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgICAgY29udHJvbCA9IHgyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm4oKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKHNhbXBsZSkgewogICAgICAgICAgICAgIGlmIChzYW1wbGUgJiYgY29udHJvbCAmJiB0eXBlb2Ygc2FtcGxlLnN0YWNrID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgdmFyIHNhbXBsZUxpbmVzID0gc2FtcGxlLnN0YWNrLnNwbGl0KCJcbiIpOwogICAgICAgICAgICAgICAgdmFyIGNvbnRyb2xMaW5lcyA9IGNvbnRyb2wuc3RhY2suc3BsaXQoIlxuIik7CiAgICAgICAgICAgICAgICB2YXIgcyA9IHNhbXBsZUxpbmVzLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgICB2YXIgYzIgPSBjb250cm9sTGluZXMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICAgIHdoaWxlIChzID49IDEgJiYgYzIgPj0gMCAmJiBzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2MyXSkgewogICAgICAgICAgICAgICAgICBjMi0tOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm9yICg7IHMgPj0gMSAmJiBjMiA+PSAwOyBzLS0sIGMyLS0pIHsKICAgICAgICAgICAgICAgICAgaWYgKHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbYzJdKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHMgIT09IDEgfHwgYzIgIT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgICAgcy0tOwogICAgICAgICAgICAgICAgICAgICAgICBjMi0tOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYzIgPCAwIHx8IHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbYzJdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIF9mcmFtZSA9ICJcbiIgKyBzYW1wbGVMaW5lc1tzXS5yZXBsYWNlKCIgYXQgbmV3ICIsICIgYXQgIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuLmRpc3BsYXlOYW1lICYmIF9mcmFtZS5pbmNsdWRlcygiPGFub255bW91cz4iKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2ZyYW1lID0gX2ZyYW1lLnJlcGxhY2UoIjxhbm9ueW1vdXM+IiwgZm4uZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUuc2V0KGZuLCBfZnJhbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2ZyYW1lOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlIChzID49IDEgJiYgYzIgPj0gMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIHJlZW50cnkgPSBmYWxzZTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQgPSBwcmV2aW91c0Rpc3BhdGNoZXI7CiAgICAgICAgICAgICAgICByZWVuYWJsZUxvZ3MoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgRXJyb3IucHJlcGFyZVN0YWNrVHJhY2UgPSBwcmV2aW91c1ByZXBhcmVTdGFja1RyYWNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBuYW1lID0gZm4gPyBmbi5kaXNwbGF5TmFtZSB8fCBmbi5uYW1lIDogIiI7CiAgICAgICAgICAgIHZhciBzeW50aGV0aWNGcmFtZSA9IG5hbWUgPyBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZShuYW1lKSA6ICIiOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZS5zZXQoZm4sIHN5bnRoZXRpY0ZyYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN5bnRoZXRpY0ZyYW1lOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVDbGFzc0NvbXBvbmVudEZyYW1lKGN0b3IsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUoY3RvciwgdHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlRnVuY3Rpb25Db21wb25lbnRGcmFtZShmbiwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShmbiwgZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzaG91bGRDb25zdHJ1Y3QoQ29tcG9uZW50KSB7CiAgICAgICAgICAgIHZhciBwcm90b3R5cGUgPSBDb21wb25lbnQucHJvdG90eXBlOwogICAgICAgICAgICByZXR1cm4gISEocHJvdG90eXBlICYmIHByb3RvdHlwZS5pc1JlYWN0Q29tcG9uZW50KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVih0eXBlMiwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICAgIGlmICh0eXBlMiA9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZTIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZSh0eXBlMiwgc2hvdWxkQ29uc3RydWN0KHR5cGUyKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZTIgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKHR5cGUyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzd2l0Y2ggKHR5cGUyKSB7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZSIpOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZUxpc3QiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUyID09PSAib2JqZWN0IikgewogICAgICAgICAgICAgIHN3aXRjaCAodHlwZTIuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRToKICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlRnVuY3Rpb25Db21wb25lbnRGcmFtZSh0eXBlMi5yZW5kZXIpOwogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEU6CiAgICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYodHlwZTIudHlwZSwgc291cmNlLCBvd25lckZuKTsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gdHlwZTI7CiAgICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgICAgdmFyIGluaXQyID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKGluaXQyKHBheWxvYWQpLCBzb3VyY2UsIG93bmVyRm4pOwogICAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlRmliZXIoZmliZXIpIHsKICAgICAgICAgICAgdmFyIG93bmVyID0gZmliZXIuX2RlYnVnT3duZXIgPyBmaWJlci5fZGVidWdPd25lci50eXBlIDogbnVsbDsKICAgICAgICAgICAgdmFyIHNvdXJjZSA9IGZpYmVyLl9kZWJ1Z1NvdXJjZTsKICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoZmliZXIudHlwZSk7CiAgICAgICAgICAgICAgY2FzZSBMYXp5Q29tcG9uZW50OgogICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJMYXp5Iik7CiAgICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDoKICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2UiKTsKICAgICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDoKICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2VMaXN0Iik7CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEluZGV0ZXJtaW5hdGVDb21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlRnVuY3Rpb25Db21wb25lbnRGcmFtZShmaWJlci50eXBlKTsKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKGZpYmVyLnR5cGUucmVuZGVyKTsKICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQ2xhc3NDb21wb25lbnRGcmFtZShmaWJlci50eXBlKTsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRTdGFja0J5RmliZXJJbkRldkFuZFByb2Qod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdmFyIGluZm8gPSAiIjsKICAgICAgICAgICAgICB2YXIgbm9kZSA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICBpbmZvICs9IGRlc2NyaWJlRmliZXIobm9kZSk7CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgfSB3aGlsZSAobm9kZSk7CiAgICAgICAgICAgICAgcmV0dXJuIGluZm87CiAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJcbkVycm9yIGdlbmVyYXRpbmcgc3RhY2s6ICIgKyB4Mi5tZXNzYWdlICsgIlxuIiArIHgyLnN0YWNrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRXcmFwcGVkTmFtZShvdXRlclR5cGUsIGlubmVyVHlwZSwgd3JhcHBlck5hbWUpIHsKICAgICAgICAgICAgdmFyIGRpc3BsYXlOYW1lID0gb3V0ZXJUeXBlLmRpc3BsYXlOYW1lOwogICAgICAgICAgICBpZiAoZGlzcGxheU5hbWUpIHsKICAgICAgICAgICAgICByZXR1cm4gZGlzcGxheU5hbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGZ1bmN0aW9uTmFtZSA9IGlubmVyVHlwZS5kaXNwbGF5TmFtZSB8fCBpbm5lclR5cGUubmFtZSB8fCAiIjsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uTmFtZSAhPT0gIiIgPyB3cmFwcGVyTmFtZSArICIoIiArIGZ1bmN0aW9uTmFtZSArICIpIiA6IHdyYXBwZXJOYW1lOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0Q29udGV4dE5hbWUodHlwZTIpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGUyLmRpc3BsYXlOYW1lIHx8ICJDb250ZXh0IjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlMikgewogICAgICAgICAgICBpZiAodHlwZTIgPT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUyLnRhZyA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJSZWNlaXZlZCBhbiB1bmV4cGVjdGVkIG9iamVjdCBpbiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoKS4gVGhpcyBpcyBsaWtlbHkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHR5cGUyLmRpc3BsYXlOYW1lIHx8IHR5cGUyLm5hbWUgfHwgbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUyID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHJldHVybiB0eXBlMjsKICAgICAgICAgICAgfQogICAgICAgICAgICBzd2l0Y2ggKHR5cGUyKSB7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GUkFHTUVOVF9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuICJGcmFnbWVudCI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiAiUG9ydGFsIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BST0ZJTEVSX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gIlByb2ZpbGVyIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1NUUklDVF9NT0RFX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gIlN0cmljdE1vZGUiOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiAiU3VzcGVuc2UiOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZUxpc3QiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZTIgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgc3dpdGNoICh0eXBlMi4kJHR5cGVvZikgewogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9DT05URVhUX1RZUEU6CiAgICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gdHlwZTI7CiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZShjb250ZXh0KSArICIuQ29uc3VtZXIiOwogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QUk9WSURFUl9UWVBFOgogICAgICAgICAgICAgICAgICB2YXIgcHJvdmlkZXIgPSB0eXBlMjsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lKHByb3ZpZGVyLl9jb250ZXh0KSArICIuUHJvdmlkZXIiOwogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFOgogICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0V3JhcHBlZE5hbWUodHlwZTIsIHR5cGUyLnJlbmRlciwgIkZvcndhcmRSZWYiKTsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTUVNT19UWVBFOgogICAgICAgICAgICAgICAgICB2YXIgb3V0ZXJOYW1lID0gdHlwZTIuZGlzcGxheU5hbWUgfHwgbnVsbDsKICAgICAgICAgICAgICAgICAgaWYgKG91dGVyTmFtZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBvdXRlck5hbWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlMi50eXBlKSB8fCAiTWVtbyI7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgICB2YXIgbGF6eUNvbXBvbmVudCA9IHR5cGUyOwogICAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IGxhenlDb21wb25lbnQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICAgIHZhciBpbml0MiA9IGxhenlDb21wb25lbnQuX2luaXQ7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShpbml0MihwYXlsb2FkKSk7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRXcmFwcGVkTmFtZSQxKG91dGVyVHlwZSwgaW5uZXJUeXBlLCB3cmFwcGVyTmFtZSkgewogICAgICAgICAgICB2YXIgZnVuY3Rpb25OYW1lID0gaW5uZXJUeXBlLmRpc3BsYXlOYW1lIHx8IGlubmVyVHlwZS5uYW1lIHx8ICIiOwogICAgICAgICAgICByZXR1cm4gb3V0ZXJUeXBlLmRpc3BsYXlOYW1lIHx8IChmdW5jdGlvbk5hbWUgIT09ICIiID8gd3JhcHBlck5hbWUgKyAiKCIgKyBmdW5jdGlvbk5hbWUgKyAiKSIgOiB3cmFwcGVyTmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRDb250ZXh0TmFtZSQxKHR5cGUyKSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlMi5kaXNwbGF5TmFtZSB8fCAiQ29udGV4dCI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB7CiAgICAgICAgICAgIHZhciB0YWcgPSBmaWJlci50YWcsIHR5cGUyID0gZmliZXIudHlwZTsKICAgICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgICBjYXNlIENhY2hlQ29tcG9uZW50OgogICAgICAgICAgICAgICAgcmV0dXJuICJDYWNoZSI7CiAgICAgICAgICAgICAgY2FzZSBDb250ZXh0Q29uc3VtZXI6CiAgICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IHR5cGUyOwogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lJDEoY29udGV4dCkgKyAiLkNvbnN1bWVyIjsKICAgICAgICAgICAgICBjYXNlIENvbnRleHRQcm92aWRlcjoKICAgICAgICAgICAgICAgIHZhciBwcm92aWRlciA9IHR5cGUyOwogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lJDEocHJvdmlkZXIuX2NvbnRleHQpICsgIi5Qcm92aWRlciI7CiAgICAgICAgICAgICAgY2FzZSBEZWh5ZHJhdGVkRnJhZ21lbnQ6CiAgICAgICAgICAgICAgICByZXR1cm4gIkRlaHlkcmF0ZWRGcmFnbWVudCI7CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOgogICAgICAgICAgICAgICAgcmV0dXJuIGdldFdyYXBwZWROYW1lJDEodHlwZTIsIHR5cGUyLnJlbmRlciwgIkZvcndhcmRSZWYiKTsKICAgICAgICAgICAgICBjYXNlIEZyYWdtZW50OgogICAgICAgICAgICAgICAgcmV0dXJuICJGcmFnbWVudCI7CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgICAgcmV0dXJuIHR5cGUyOwogICAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICAgIHJldHVybiAiUG9ydGFsIjsKICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgICAgcmV0dXJuICJSb290IjsKICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgICAgcmV0dXJuICJUZXh0IjsKICAgICAgICAgICAgICBjYXNlIExhenlDb21wb25lbnQ6CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUyKTsKICAgICAgICAgICAgICBjYXNlIE1vZGU6CiAgICAgICAgICAgICAgICBpZiAodHlwZTIgPT09IFJFQUNUX1NUUklDVF9NT0RFX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuICJTdHJpY3RNb2RlIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiAiTW9kZSI7CiAgICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6CiAgICAgICAgICAgICAgICByZXR1cm4gIk9mZnNjcmVlbiI7CiAgICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICAgIHJldHVybiAiUHJvZmlsZXIiOwogICAgICAgICAgICAgIGNhc2UgU2NvcGVDb21wb25lbnQ6CiAgICAgICAgICAgICAgICByZXR1cm4gIlNjb3BlIjsKICAgICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OgogICAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZSI7CiAgICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlTGlzdCI7CiAgICAgICAgICAgICAgY2FzZSBUcmFjaW5nTWFya2VyQ29tcG9uZW50OgogICAgICAgICAgICAgICAgcmV0dXJuICJUcmFjaW5nTWFya2VyIjsKICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBJbmRldGVybWluYXRlQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0eXBlMi5kaXNwbGF5TmFtZSB8fCB0eXBlMi5uYW1lIHx8IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUyID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICByZXR1cm4gdHlwZTI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICAgIHZhciBjdXJyZW50ID0gbnVsbDsKICAgICAgICAgIHZhciBpc1JlbmRlcmluZyA9IGZhbHNlOwogICAgICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lSW5EZXZPck51bGwoKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBvd25lciA9IGN1cnJlbnQuX2RlYnVnT3duZXI7CiAgICAgICAgICAgICAgaWYgKG93bmVyICE9PSBudWxsICYmIHR5cGVvZiBvd25lciAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKG93bmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50RmliZXJTdGFja0luRGV2KCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGdldFN0YWNrQnlGaWJlckluRGV2QW5kUHJvZChjdXJyZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVzZXRDdXJyZW50RmliZXIoKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldEN1cnJlbnRTdGFjayA9IG51bGw7CiAgICAgICAgICAgICAgY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgICAgaXNSZW5kZXJpbmcgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gc2V0Q3VycmVudEZpYmVyKGZpYmVyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldEN1cnJlbnRTdGFjayA9IGZpYmVyID09PSBudWxsID8gbnVsbCA6IGdldEN1cnJlbnRGaWJlclN0YWNrSW5EZXY7CiAgICAgICAgICAgICAgY3VycmVudCA9IGZpYmVyOwogICAgICAgICAgICAgIGlzUmVuZGVyaW5nID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRGaWJlcigpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHJldHVybiBjdXJyZW50OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzZXRJc1JlbmRlcmluZyhyZW5kZXJpbmcpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlzUmVuZGVyaW5nID0gcmVuZGVyaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB0b1N0cmluZyh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gIiIgKyB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldFRvU3RyaW5nVmFsdWUodmFsdWUpIHsKICAgICAgICAgICAgc3dpdGNoICh0eXBlb2YgdmFsdWUpIHsKICAgICAgICAgICAgICBjYXNlICJib29sZWFuIjoKICAgICAgICAgICAgICBjYXNlICJudW1iZXIiOgogICAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgICAgY2FzZSAidW5kZWZpbmVkIjoKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICBjYXNlICJvYmplY3QiOgogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBjaGVja0Zvcm1GaWVsZFZhbHVlU3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBoYXNSZWFkT25seVZhbHVlID0gewogICAgICAgICAgICBidXR0b246IHRydWUsCiAgICAgICAgICAgIGNoZWNrYm94OiB0cnVlLAogICAgICAgICAgICBpbWFnZTogdHJ1ZSwKICAgICAgICAgICAgaGlkZGVuOiB0cnVlLAogICAgICAgICAgICByYWRpbzogdHJ1ZSwKICAgICAgICAgICAgcmVzZXQ6IHRydWUsCiAgICAgICAgICAgIHN1Ym1pdDogdHJ1ZQogICAgICAgICAgfTsKICAgICAgICAgIGZ1bmN0aW9uIGNoZWNrQ29udHJvbGxlZFZhbHVlUHJvcHModGFnTmFtZSwgcHJvcHMpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghKGhhc1JlYWRPbmx5VmFsdWVbcHJvcHMudHlwZV0gfHwgcHJvcHMub25DaGFuZ2UgfHwgcHJvcHMub25JbnB1dCB8fCBwcm9wcy5yZWFkT25seSB8fCBwcm9wcy5kaXNhYmxlZCB8fCBwcm9wcy52YWx1ZSA9PSBudWxsKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIllvdSBwcm92aWRlZCBhIGB2YWx1ZWAgcHJvcCB0byBhIGZvcm0gZmllbGQgd2l0aG91dCBhbiBgb25DaGFuZ2VgIGhhbmRsZXIuIFRoaXMgd2lsbCByZW5kZXIgYSByZWFkLW9ubHkgZmllbGQuIElmIHRoZSBmaWVsZCBzaG91bGQgYmUgbXV0YWJsZSB1c2UgYGRlZmF1bHRWYWx1ZWAuIE90aGVyd2lzZSwgc2V0IGVpdGhlciBgb25DaGFuZ2VgIG9yIGByZWFkT25seWAuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghKHByb3BzLm9uQ2hhbmdlIHx8IHByb3BzLnJlYWRPbmx5IHx8IHByb3BzLmRpc2FibGVkIHx8IHByb3BzLmNoZWNrZWQgPT0gbnVsbCkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJZb3UgcHJvdmlkZWQgYSBgY2hlY2tlZGAgcHJvcCB0byBhIGZvcm0gZmllbGQgd2l0aG91dCBhbiBgb25DaGFuZ2VgIGhhbmRsZXIuIFRoaXMgd2lsbCByZW5kZXIgYSByZWFkLW9ubHkgZmllbGQuIElmIHRoZSBmaWVsZCBzaG91bGQgYmUgbXV0YWJsZSB1c2UgYGRlZmF1bHRDaGVja2VkYC4gT3RoZXJ3aXNlLCBzZXQgZWl0aGVyIGBvbkNoYW5nZWAgb3IgYHJlYWRPbmx5YC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGlzQ2hlY2thYmxlKGVsZW0pIHsKICAgICAgICAgICAgdmFyIHR5cGUyID0gZWxlbS50eXBlOwogICAgICAgICAgICB2YXIgbm9kZU5hbWUgPSBlbGVtLm5vZGVOYW1lOwogICAgICAgICAgICByZXR1cm4gbm9kZU5hbWUgJiYgbm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiAmJiAodHlwZTIgPT09ICJjaGVja2JveCIgfHwgdHlwZTIgPT09ICJyYWRpbyIpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0VHJhY2tlcihub2RlKSB7CiAgICAgICAgICAgIHJldHVybiBub2RlLl92YWx1ZVRyYWNrZXI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBkZXRhY2hUcmFja2VyKG5vZGUpIHsKICAgICAgICAgICAgbm9kZS5fdmFsdWVUcmFja2VyID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldFZhbHVlRnJvbU5vZGUobm9kZSkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSAiIjsKICAgICAgICAgICAgaWYgKCFub2RlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc0NoZWNrYWJsZShub2RlKSkgewogICAgICAgICAgICAgIHZhbHVlID0gbm9kZS5jaGVja2VkID8gInRydWUiIDogImZhbHNlIjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YWx1ZSA9IG5vZGUudmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdHJhY2tWYWx1ZU9uTm9kZShub2RlKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZUZpZWxkID0gaXNDaGVja2FibGUobm9kZSkgPyAiY2hlY2tlZCIgOiAidmFsdWUiOwogICAgICAgICAgICB2YXIgZGVzY3JpcHRvciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iobm9kZS5jb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHZhbHVlRmllbGQpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY2hlY2tGb3JtRmllbGRWYWx1ZVN0cmluZ0NvZXJjaW9uKG5vZGVbdmFsdWVGaWVsZF0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjdXJyZW50VmFsdWUgPSAiIiArIG5vZGVbdmFsdWVGaWVsZF07CiAgICAgICAgICAgIGlmIChub2RlLmhhc093blByb3BlcnR5KHZhbHVlRmllbGQpIHx8IHR5cGVvZiBkZXNjcmlwdG9yID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgZGVzY3JpcHRvci5nZXQgIT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGRlc2NyaXB0b3Iuc2V0ICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBnZXQ0ID0gZGVzY3JpcHRvci5nZXQsIHNldDQgPSBkZXNjcmlwdG9yLnNldDsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG5vZGUsIHZhbHVlRmllbGQsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBnZXQ0LmNhbGwodGhpcyk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGNoZWNrRm9ybUZpZWxkVmFsdWVTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdXJyZW50VmFsdWUgPSAiIiArIHZhbHVlOwogICAgICAgICAgICAgICAgc2V0NC5jYWxsKHRoaXMsIHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobm9kZSwgdmFsdWVGaWVsZCwgewogICAgICAgICAgICAgIGVudW1lcmFibGU6IGRlc2NyaXB0b3IuZW51bWVyYWJsZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdmFyIHRyYWNrZXIgPSB7CiAgICAgICAgICAgICAgZ2V0VmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHNldFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBjaGVja0Zvcm1GaWVsZFZhbHVlU3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3VycmVudFZhbHVlID0gIiIgKyB2YWx1ZTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHN0b3BUcmFja2luZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBkZXRhY2hUcmFja2VyKG5vZGUpOwogICAgICAgICAgICAgICAgZGVsZXRlIG5vZGVbdmFsdWVGaWVsZF07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4gdHJhY2tlcjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHRyYWNrKG5vZGUpIHsKICAgICAgICAgICAgaWYgKGdldFRyYWNrZXIobm9kZSkpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZS5fdmFsdWVUcmFja2VyID0gdHJhY2tWYWx1ZU9uTm9kZShub2RlKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVZhbHVlSWZDaGFuZ2VkKG5vZGUpIHsKICAgICAgICAgICAgaWYgKCFub2RlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0cmFja2VyID0gZ2V0VHJhY2tlcihub2RlKTsKICAgICAgICAgICAgaWYgKCF0cmFja2VyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGxhc3RWYWx1ZSA9IHRyYWNrZXIuZ2V0VmFsdWUoKTsKICAgICAgICAgICAgdmFyIG5leHRWYWx1ZSA9IGdldFZhbHVlRnJvbU5vZGUobm9kZSk7CiAgICAgICAgICAgIGlmIChuZXh0VmFsdWUgIT09IGxhc3RWYWx1ZSkgewogICAgICAgICAgICAgIHRyYWNrZXIuc2V0VmFsdWUobmV4dFZhbHVlKTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRBY3RpdmVFbGVtZW50KGRvYykgewogICAgICAgICAgICBkb2MgPSBkb2MgfHwgKHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgPyBkb2N1bWVudCA6IHZvaWQgMCk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZG9jID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgcmV0dXJuIGRvYy5hY3RpdmVFbGVtZW50IHx8IGRvYy5ib2R5OwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGRvYy5ib2R5OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlID0gZmFsc2U7CiAgICAgICAgICB2YXIgZGlkV2FybkNoZWNrZWREZWZhdWx0Q2hlY2tlZCA9IGZhbHNlOwogICAgICAgICAgdmFyIGRpZFdhcm5Db250cm9sbGVkVG9VbmNvbnRyb2xsZWQgPSBmYWxzZTsKICAgICAgICAgIHZhciBkaWRXYXJuVW5jb250cm9sbGVkVG9Db250cm9sbGVkID0gZmFsc2U7CiAgICAgICAgICBmdW5jdGlvbiBpc0NvbnRyb2xsZWQocHJvcHMpIHsKICAgICAgICAgICAgdmFyIHVzZXNDaGVja2VkID0gcHJvcHMudHlwZSA9PT0gImNoZWNrYm94IiB8fCBwcm9wcy50eXBlID09PSAicmFkaW8iOwogICAgICAgICAgICByZXR1cm4gdXNlc0NoZWNrZWQgPyBwcm9wcy5jaGVja2VkICE9IG51bGwgOiBwcm9wcy52YWx1ZSAhPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0SG9zdFByb3BzKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgICAgdmFyIGNoZWNrZWQgPSBwcm9wcy5jaGVja2VkOwogICAgICAgICAgICB2YXIgaG9zdFByb3BzID0gYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgIGRlZmF1bHRDaGVja2VkOiB2b2lkIDAsCiAgICAgICAgICAgICAgZGVmYXVsdFZhbHVlOiB2b2lkIDAsCiAgICAgICAgICAgICAgdmFsdWU6IHZvaWQgMCwKICAgICAgICAgICAgICBjaGVja2VkOiBjaGVja2VkICE9IG51bGwgPyBjaGVja2VkIDogbm9kZS5fd3JhcHBlclN0YXRlLmluaXRpYWxDaGVja2VkCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gaG9zdFByb3BzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaW5pdFdyYXBwZXJTdGF0ZShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY2hlY2tDb250cm9sbGVkVmFsdWVQcm9wcygiaW5wdXQiLCBwcm9wcyk7CiAgICAgICAgICAgICAgaWYgKHByb3BzLmNoZWNrZWQgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0Q2hlY2tlZCAhPT0gdm9pZCAwICYmICFkaWRXYXJuQ2hlY2tlZERlZmF1bHRDaGVja2VkKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMgY29udGFpbnMgYW4gaW5wdXQgb2YgdHlwZSAlcyB3aXRoIGJvdGggY2hlY2tlZCBhbmQgZGVmYXVsdENoZWNrZWQgcHJvcHMuIElucHV0IGVsZW1lbnRzIG11c3QgYmUgZWl0aGVyIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIChzcGVjaWZ5IGVpdGhlciB0aGUgY2hlY2tlZCBwcm9wLCBvciB0aGUgZGVmYXVsdENoZWNrZWQgcHJvcCwgYnV0IG5vdCBib3RoKS4gRGVjaWRlIGJldHdlZW4gdXNpbmcgYSBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCBpbnB1dCBlbGVtZW50IGFuZCByZW1vdmUgb25lIG9mIHRoZXNlIHByb3BzLiBNb3JlIGluZm86IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9jb250cm9sbGVkLWNvbXBvbmVudHMiLCBnZXRDdXJyZW50RmliZXJPd25lck5hbWVJbkRldk9yTnVsbCgpIHx8ICJBIGNvbXBvbmVudCIsIHByb3BzLnR5cGUpOwogICAgICAgICAgICAgICAgZGlkV2FybkNoZWNrZWREZWZhdWx0Q2hlY2tlZCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChwcm9wcy52YWx1ZSAhPT0gdm9pZCAwICYmIHByb3BzLmRlZmF1bHRWYWx1ZSAhPT0gdm9pZCAwICYmICFkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUpIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyBjb250YWlucyBhbiBpbnB1dCBvZiB0eXBlICVzIHdpdGggYm90aCB2YWx1ZSBhbmQgZGVmYXVsdFZhbHVlIHByb3BzLiBJbnB1dCBlbGVtZW50cyBtdXN0IGJlIGVpdGhlciBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCAoc3BlY2lmeSBlaXRoZXIgdGhlIHZhbHVlIHByb3AsIG9yIHRoZSBkZWZhdWx0VmFsdWUgcHJvcCwgYnV0IG5vdCBib3RoKS4gRGVjaWRlIGJldHdlZW4gdXNpbmcgYSBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCBpbnB1dCBlbGVtZW50IGFuZCByZW1vdmUgb25lIG9mIHRoZXNlIHByb3BzLiBNb3JlIGluZm86IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9jb250cm9sbGVkLWNvbXBvbmVudHMiLCBnZXRDdXJyZW50RmliZXJPd25lck5hbWVJbkRldk9yTnVsbCgpIHx8ICJBIGNvbXBvbmVudCIsIHByb3BzLnR5cGUpOwogICAgICAgICAgICAgICAgZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgICB2YXIgZGVmYXVsdFZhbHVlID0gcHJvcHMuZGVmYXVsdFZhbHVlID09IG51bGwgPyAiIiA6IHByb3BzLmRlZmF1bHRWYWx1ZTsKICAgICAgICAgICAgbm9kZS5fd3JhcHBlclN0YXRlID0gewogICAgICAgICAgICAgIGluaXRpYWxDaGVja2VkOiBwcm9wcy5jaGVja2VkICE9IG51bGwgPyBwcm9wcy5jaGVja2VkIDogcHJvcHMuZGVmYXVsdENoZWNrZWQsCiAgICAgICAgICAgICAgaW5pdGlhbFZhbHVlOiBnZXRUb1N0cmluZ1ZhbHVlKHByb3BzLnZhbHVlICE9IG51bGwgPyBwcm9wcy52YWx1ZSA6IGRlZmF1bHRWYWx1ZSksCiAgICAgICAgICAgICAgY29udHJvbGxlZDogaXNDb250cm9sbGVkKHByb3BzKQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ2hlY2tlZChlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICAgIHZhciBjaGVja2VkID0gcHJvcHMuY2hlY2tlZDsKICAgICAgICAgICAgaWYgKGNoZWNrZWQgIT0gbnVsbCkgewogICAgICAgICAgICAgIHNldFZhbHVlRm9yUHJvcGVydHkobm9kZSwgImNoZWNrZWQiLCBjaGVja2VkLCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVdyYXBwZXIoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIGNvbnRyb2xsZWQgPSBpc0NvbnRyb2xsZWQocHJvcHMpOwogICAgICAgICAgICAgIGlmICghbm9kZS5fd3JhcHBlclN0YXRlLmNvbnRyb2xsZWQgJiYgY29udHJvbGxlZCAmJiAhZGlkV2FyblVuY29udHJvbGxlZFRvQ29udHJvbGxlZCkgewogICAgICAgICAgICAgICAgZXJyb3IoIkEgY29tcG9uZW50IGlzIGNoYW5naW5nIGFuIHVuY29udHJvbGxlZCBpbnB1dCB0byBiZSBjb250cm9sbGVkLiBUaGlzIGlzIGxpa2VseSBjYXVzZWQgYnkgdGhlIHZhbHVlIGNoYW5naW5nIGZyb20gdW5kZWZpbmVkIHRvIGEgZGVmaW5lZCB2YWx1ZSwgd2hpY2ggc2hvdWxkIG5vdCBoYXBwZW4uIERlY2lkZSBiZXR3ZWVuIHVzaW5nIGEgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgaW5wdXQgZWxlbWVudCBmb3IgdGhlIGxpZmV0aW1lIG9mIHRoZSBjb21wb25lbnQuIE1vcmUgaW5mbzogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2NvbnRyb2xsZWQtY29tcG9uZW50cyIpOwogICAgICAgICAgICAgICAgZGlkV2FyblVuY29udHJvbGxlZFRvQ29udHJvbGxlZCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChub2RlLl93cmFwcGVyU3RhdGUuY29udHJvbGxlZCAmJiAhY29udHJvbGxlZCAmJiAhZGlkV2FybkNvbnRyb2xsZWRUb1VuY29udHJvbGxlZCkgewogICAgICAgICAgICAgICAgZXJyb3IoIkEgY29tcG9uZW50IGlzIGNoYW5naW5nIGEgY29udHJvbGxlZCBpbnB1dCB0byBiZSB1bmNvbnRyb2xsZWQuIFRoaXMgaXMgbGlrZWx5IGNhdXNlZCBieSB0aGUgdmFsdWUgY2hhbmdpbmcgZnJvbSBhIGRlZmluZWQgdG8gdW5kZWZpbmVkLCB3aGljaCBzaG91bGQgbm90IGhhcHBlbi4gRGVjaWRlIGJldHdlZW4gdXNpbmcgYSBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCBpbnB1dCBlbGVtZW50IGZvciB0aGUgbGlmZXRpbWUgb2YgdGhlIGNvbXBvbmVudC4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQ29udHJvbGxlZFRvVW5jb250cm9sbGVkID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlQ2hlY2tlZChlbGVtZW50LCBwcm9wcyk7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IGdldFRvU3RyaW5nVmFsdWUocHJvcHMudmFsdWUpOwogICAgICAgICAgICB2YXIgdHlwZTIgPSBwcm9wcy50eXBlOwogICAgICAgICAgICBpZiAodmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICAgIGlmICh0eXBlMiA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gMCAmJiBub2RlLnZhbHVlID09PSAiIiB8fCAvLyBXZSBleHBsaWNpdGx5IHdhbnQgdG8gY29lcmNlIHRvIG51bWJlciBoZXJlIGlmIHBvc3NpYmxlLgogICAgICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lCiAgICAgICAgICAgICAgICBub2RlLnZhbHVlICE9IHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgIG5vZGUudmFsdWUgPSB0b1N0cmluZyh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLnZhbHVlICE9PSB0b1N0cmluZyh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIG5vZGUudmFsdWUgPSB0b1N0cmluZyh2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUyID09PSAic3VibWl0IiB8fCB0eXBlMiA9PT0gInJlc2V0IikgewogICAgICAgICAgICAgIG5vZGUucmVtb3ZlQXR0cmlidXRlKCJ2YWx1ZSIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHByb3BzLmhhc093blByb3BlcnR5KCJ2YWx1ZSIpKSB7CiAgICAgICAgICAgICAgICBzZXREZWZhdWx0VmFsdWUobm9kZSwgcHJvcHMudHlwZSwgdmFsdWUpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcHMuaGFzT3duUHJvcGVydHkoImRlZmF1bHRWYWx1ZSIpKSB7CiAgICAgICAgICAgICAgICBzZXREZWZhdWx0VmFsdWUobm9kZSwgcHJvcHMudHlwZSwgZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy5kZWZhdWx0VmFsdWUpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChwcm9wcy5jaGVja2VkID09IG51bGwgJiYgcHJvcHMuZGVmYXVsdENoZWNrZWQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgbm9kZS5kZWZhdWx0Q2hlY2tlZCA9ICEhcHJvcHMuZGVmYXVsdENoZWNrZWQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwb3N0TW91bnRXcmFwcGVyKGVsZW1lbnQsIHByb3BzLCBpc0h5ZHJhdGluZzIpIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgICBpZiAocHJvcHMuaGFzT3duUHJvcGVydHkoInZhbHVlIikgfHwgcHJvcHMuaGFzT3duUHJvcGVydHkoImRlZmF1bHRWYWx1ZSIpKSB7CiAgICAgICAgICAgICAgdmFyIHR5cGUyID0gcHJvcHMudHlwZTsKICAgICAgICAgICAgICB2YXIgaXNCdXR0b24gPSB0eXBlMiA9PT0gInN1Ym1pdCIgfHwgdHlwZTIgPT09ICJyZXNldCI7CiAgICAgICAgICAgICAgaWYgKGlzQnV0dG9uICYmIChwcm9wcy52YWx1ZSA9PT0gdm9pZCAwIHx8IHByb3BzLnZhbHVlID09PSBudWxsKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgaW5pdGlhbFZhbHVlID0gdG9TdHJpbmcobm9kZS5fd3JhcHBlclN0YXRlLmluaXRpYWxWYWx1ZSk7CiAgICAgICAgICAgICAgaWYgKCFpc0h5ZHJhdGluZzIpIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKGluaXRpYWxWYWx1ZSAhPT0gbm9kZS52YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIG5vZGUudmFsdWUgPSBpbml0aWFsVmFsdWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbm9kZS5kZWZhdWx0VmFsdWUgPSBpbml0aWFsVmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBuYW1lID0gbm9kZS5uYW1lOwogICAgICAgICAgICBpZiAobmFtZSAhPT0gIiIpIHsKICAgICAgICAgICAgICBub2RlLm5hbWUgPSAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbm9kZS5kZWZhdWx0Q2hlY2tlZCA9ICFub2RlLmRlZmF1bHRDaGVja2VkOwogICAgICAgICAgICAgIG5vZGUuZGVmYXVsdENoZWNrZWQgPSAhIW5vZGUuX3dyYXBwZXJTdGF0ZS5pbml0aWFsQ2hlY2tlZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobmFtZSAhPT0gIiIpIHsKICAgICAgICAgICAgICBub2RlLm5hbWUgPSBuYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZXN0b3JlQ29udHJvbGxlZFN0YXRlKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgICAgdXBkYXRlV3JhcHBlcihub2RlLCBwcm9wcyk7CiAgICAgICAgICAgIHVwZGF0ZU5hbWVkQ291c2lucyhub2RlLCBwcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVOYW1lZENvdXNpbnMocm9vdE5vZGUsIHByb3BzKSB7CiAgICAgICAgICAgIHZhciBuYW1lID0gcHJvcHMubmFtZTsKICAgICAgICAgICAgaWYgKHByb3BzLnR5cGUgPT09ICJyYWRpbyIgJiYgbmFtZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHF1ZXJ5Um9vdCA9IHJvb3ROb2RlOwogICAgICAgICAgICAgIHdoaWxlIChxdWVyeVJvb3QucGFyZW50Tm9kZSkgewogICAgICAgICAgICAgICAgcXVlcnlSb290ID0gcXVlcnlSb290LnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24obmFtZSwgIm5hbWUiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGdyb3VwID0gcXVlcnlSb290LnF1ZXJ5U2VsZWN0b3JBbGwoImlucHV0W25hbWU9IiArIEpTT04uc3RyaW5naWZ5KCIiICsgbmFtZSkgKyAnXVt0eXBlPSJyYWRpbyJdJyk7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBncm91cC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIG90aGVyTm9kZSA9IGdyb3VwW2ldOwogICAgICAgICAgICAgICAgaWYgKG90aGVyTm9kZSA9PT0gcm9vdE5vZGUgfHwgb3RoZXJOb2RlLmZvcm0gIT09IHJvb3ROb2RlLmZvcm0pIHsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgb3RoZXJQcm9wcyA9IGdldEZpYmVyQ3VycmVudFByb3BzRnJvbU5vZGUob3RoZXJOb2RlKTsKICAgICAgICAgICAgICAgIGlmICghb3RoZXJQcm9wcykgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJlYWN0RE9NSW5wdXQ6IE1peGluZyBSZWFjdCBhbmQgbm9uLVJlYWN0IHJhZGlvIGlucHV0cyB3aXRoIHRoZSBzYW1lIGBuYW1lYCBpcyBub3Qgc3VwcG9ydGVkLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdXBkYXRlVmFsdWVJZkNoYW5nZWQob3RoZXJOb2RlKTsKICAgICAgICAgICAgICAgIHVwZGF0ZVdyYXBwZXIob3RoZXJOb2RlLCBvdGhlclByb3BzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHNldERlZmF1bHRWYWx1ZShub2RlLCB0eXBlMiwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgIC8vIEZvY3VzZWQgbnVtYmVyIGlucHV0cyBzeW5jaHJvbml6ZSBvbiBibHVyLiBTZWUgQ2hhbmdlRXZlbnRQbHVnaW4uanMKICAgICAgICAgICAgICB0eXBlMiAhPT0gIm51bWJlciIgfHwgZ2V0QWN0aXZlRWxlbWVudChub2RlLm93bmVyRG9jdW1lbnQpICE9PSBub2RlCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IHRvU3RyaW5nKG5vZGUuX3dyYXBwZXJTdGF0ZS5pbml0aWFsVmFsdWUpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5kZWZhdWx0VmFsdWUgIT09IHRvU3RyaW5nKHZhbHVlKSkgewogICAgICAgICAgICAgICAgbm9kZS5kZWZhdWx0VmFsdWUgPSB0b1N0cmluZyh2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZGlkV2FyblNlbGVjdGVkU2V0T25PcHRpb24gPSBmYWxzZTsKICAgICAgICAgIHZhciBkaWRXYXJuSW52YWxpZENoaWxkID0gZmFsc2U7CiAgICAgICAgICB2YXIgZGlkV2FybkludmFsaWRJbm5lckhUTUwgPSBmYWxzZTsKICAgICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcHMoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChwcm9wcy52YWx1ZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHByb3BzLmNoaWxkcmVuID09PSAib2JqZWN0IiAmJiBwcm9wcy5jaGlsZHJlbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBSZWFjdDUuQ2hpbGRyZW4uZm9yRWFjaChwcm9wcy5jaGlsZHJlbiwgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGQgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNoaWxkID09PSAic3RyaW5nIiB8fCB0eXBlb2YgY2hpbGQgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkludmFsaWRDaGlsZCkgewogICAgICAgICAgICAgICAgICAgICAgZGlkV2FybkludmFsaWRDaGlsZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiQ2Fubm90IGluZmVyIHRoZSBvcHRpb24gdmFsdWUgb2YgY29tcGxleCBjaGlsZHJlbi4gUGFzcyBhIGB2YWx1ZWAgcHJvcCBvciB1c2UgYSBwbGFpbiBzdHJpbmcgYXMgY2hpbGRyZW4gdG8gPG9wdGlvbj4uIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5JbnZhbGlkSW5uZXJIVE1MKSB7CiAgICAgICAgICAgICAgICAgICAgZGlkV2FybkludmFsaWRJbm5lckhUTUwgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGVycm9yKCJQYXNzIGEgYHZhbHVlYCBwcm9wIGlmIHlvdSBzZXQgZGFuZ2Vyb3VzbHlJbm5lckhUTUwgc28gUmVhY3Qga25vd3Mgd2hpY2ggdmFsdWUgc2hvdWxkIGJlIHNlbGVjdGVkLiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChwcm9wcy5zZWxlY3RlZCAhPSBudWxsICYmICFkaWRXYXJuU2VsZWN0ZWRTZXRPbk9wdGlvbikgewogICAgICAgICAgICAgICAgZXJyb3IoIlVzZSB0aGUgYGRlZmF1bHRWYWx1ZWAgb3IgYHZhbHVlYCBwcm9wcyBvbiA8c2VsZWN0PiBpbnN0ZWFkIG9mIHNldHRpbmcgYHNlbGVjdGVkYCBvbiA8b3B0aW9uPi4iKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5TZWxlY3RlZFNldE9uT3B0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHBvc3RNb3VudFdyYXBwZXIkMShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCJ2YWx1ZSIsIHRvU3RyaW5nKGdldFRvU3RyaW5nVmFsdWUocHJvcHMudmFsdWUpKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBpc0FycmF5SW1wbCA9IEFycmF5LmlzQXJyYXk7CiAgICAgICAgICBmdW5jdGlvbiBpc0FycmF5KGEyKSB7CiAgICAgICAgICAgIHJldHVybiBpc0FycmF5SW1wbChhMik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlJDE7CiAgICAgICAgICB7CiAgICAgICAgICAgIGRpZFdhcm5WYWx1ZURlZmF1bHRWYWx1ZSQxID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKSB7CiAgICAgICAgICAgIHZhciBvd25lck5hbWUgPSBnZXRDdXJyZW50RmliZXJPd25lck5hbWVJbkRldk9yTnVsbCgpOwogICAgICAgICAgICBpZiAob3duZXJOYW1lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgYCIgKyBvd25lck5hbWUgKyAiYC4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB2YWx1ZVByb3BOYW1lcyA9IFsidmFsdWUiLCAiZGVmYXVsdFZhbHVlIl07CiAgICAgICAgICBmdW5jdGlvbiBjaGVja1NlbGVjdFByb3BUeXBlcyhwcm9wcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY2hlY2tDb250cm9sbGVkVmFsdWVQcm9wcygic2VsZWN0IiwgcHJvcHMpOwogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdmFsdWVQcm9wTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBwcm9wTmFtZSA9IHZhbHVlUHJvcE5hbWVzW2ldOwogICAgICAgICAgICAgICAgaWYgKHByb3BzW3Byb3BOYW1lXSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHByb3BOYW1lSXNBcnJheSA9IGlzQXJyYXkocHJvcHNbcHJvcE5hbWVdKTsKICAgICAgICAgICAgICAgIGlmIChwcm9wcy5tdWx0aXBsZSAmJiAhcHJvcE5hbWVJc0FycmF5KSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgYCVzYCBwcm9wIHN1cHBsaWVkIHRvIDxzZWxlY3Q+IG11c3QgYmUgYW4gYXJyYXkgaWYgYG11bHRpcGxlYCBpcyB0cnVlLiVzIiwgcHJvcE5hbWUsIGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIXByb3BzLm11bHRpcGxlICYmIHByb3BOYW1lSXNBcnJheSkgewogICAgICAgICAgICAgICAgICBlcnJvcigiVGhlIGAlc2AgcHJvcCBzdXBwbGllZCB0byA8c2VsZWN0PiBtdXN0IGJlIGEgc2NhbGFyIHZhbHVlIGlmIGBtdWx0aXBsZWAgaXMgZmFsc2UuJXMiLCBwcm9wTmFtZSwgZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlT3B0aW9ucyhub2RlLCBtdWx0aXBsZSwgcHJvcFZhbHVlLCBzZXREZWZhdWx0U2VsZWN0ZWQpIHsKICAgICAgICAgICAgdmFyIG9wdGlvbnMyID0gbm9kZS5vcHRpb25zOwogICAgICAgICAgICBpZiAobXVsdGlwbGUpIHsKICAgICAgICAgICAgICB2YXIgc2VsZWN0ZWRWYWx1ZXMgPSBwcm9wVmFsdWU7CiAgICAgICAgICAgICAgdmFyIHNlbGVjdGVkVmFsdWUgPSB7fTsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNlbGVjdGVkVmFsdWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBzZWxlY3RlZFZhbHVlWyIkIiArIHNlbGVjdGVkVmFsdWVzW2ldXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBvcHRpb25zMi5sZW5ndGg7IF9pKyspIHsKICAgICAgICAgICAgICAgIHZhciBzZWxlY3RlZCA9IHNlbGVjdGVkVmFsdWUuaGFzT3duUHJvcGVydHkoIiQiICsgb3B0aW9uczJbX2ldLnZhbHVlKTsKICAgICAgICAgICAgICAgIGlmIChvcHRpb25zMltfaV0uc2VsZWN0ZWQgIT09IHNlbGVjdGVkKSB7CiAgICAgICAgICAgICAgICAgIG9wdGlvbnMyW19pXS5zZWxlY3RlZCA9IHNlbGVjdGVkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHNlbGVjdGVkICYmIHNldERlZmF1bHRTZWxlY3RlZCkgewogICAgICAgICAgICAgICAgICBvcHRpb25zMltfaV0uZGVmYXVsdFNlbGVjdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9zZWxlY3RlZFZhbHVlID0gdG9TdHJpbmcoZ2V0VG9TdHJpbmdWYWx1ZShwcm9wVmFsdWUpKTsKICAgICAgICAgICAgICB2YXIgZGVmYXVsdFNlbGVjdGVkID0gbnVsbDsKICAgICAgICAgICAgICBmb3IgKHZhciBfaTIgPSAwOyBfaTIgPCBvcHRpb25zMi5sZW5ndGg7IF9pMisrKSB7CiAgICAgICAgICAgICAgICBpZiAob3B0aW9uczJbX2kyXS52YWx1ZSA9PT0gX3NlbGVjdGVkVmFsdWUpIHsKICAgICAgICAgICAgICAgICAgb3B0aW9uczJbX2kyXS5zZWxlY3RlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGlmIChzZXREZWZhdWx0U2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICBvcHRpb25zMltfaTJdLmRlZmF1bHRTZWxlY3RlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGRlZmF1bHRTZWxlY3RlZCA9PT0gbnVsbCAmJiAhb3B0aW9uczJbX2kyXS5kaXNhYmxlZCkgewogICAgICAgICAgICAgICAgICBkZWZhdWx0U2VsZWN0ZWQgPSBvcHRpb25zMltfaTJdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZGVmYXVsdFNlbGVjdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBkZWZhdWx0U2VsZWN0ZWQuc2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0SG9zdFByb3BzJDEoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgICAgcmV0dXJuIGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICB2YWx1ZTogdm9pZCAwCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaW5pdFdyYXBwZXJTdGF0ZSQxKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNoZWNrU2VsZWN0UHJvcFR5cGVzKHByb3BzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlLl93cmFwcGVyU3RhdGUgPSB7CiAgICAgICAgICAgICAgd2FzTXVsdGlwbGU6ICEhcHJvcHMubXVsdGlwbGUKICAgICAgICAgICAgfTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChwcm9wcy52YWx1ZSAhPT0gdm9pZCAwICYmIHByb3BzLmRlZmF1bHRWYWx1ZSAhPT0gdm9pZCAwICYmICFkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUkMSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlNlbGVjdCBlbGVtZW50cyBtdXN0IGJlIGVpdGhlciBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCAoc3BlY2lmeSBlaXRoZXIgdGhlIHZhbHVlIHByb3AsIG9yIHRoZSBkZWZhdWx0VmFsdWUgcHJvcCwgYnV0IG5vdCBib3RoKS4gRGVjaWRlIGJldHdlZW4gdXNpbmcgYSBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCBzZWxlY3QgZWxlbWVudCBhbmQgcmVtb3ZlIG9uZSBvZiB0aGVzZSBwcm9wcy4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIik7CiAgICAgICAgICAgICAgICBkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUkMSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwb3N0TW91bnRXcmFwcGVyJDIoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgICBub2RlLm11bHRpcGxlID0gISFwcm9wcy5tdWx0aXBsZTsKICAgICAgICAgICAgdmFyIHZhbHVlID0gcHJvcHMudmFsdWU7CiAgICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgdXBkYXRlT3B0aW9ucyhub2RlLCAhIXByb3BzLm11bHRpcGxlLCB2YWx1ZSwgZmFsc2UpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BzLmRlZmF1bHRWYWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgdXBkYXRlT3B0aW9ucyhub2RlLCAhIXByb3BzLm11bHRpcGxlLCBwcm9wcy5kZWZhdWx0VmFsdWUsIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwb3N0VXBkYXRlV3JhcHBlcihlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICAgIHZhciB3YXNNdWx0aXBsZSA9IG5vZGUuX3dyYXBwZXJTdGF0ZS53YXNNdWx0aXBsZTsKICAgICAgICAgICAgbm9kZS5fd3JhcHBlclN0YXRlLndhc011bHRpcGxlID0gISFwcm9wcy5tdWx0aXBsZTsKICAgICAgICAgICAgdmFyIHZhbHVlID0gcHJvcHMudmFsdWU7CiAgICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgdXBkYXRlT3B0aW9ucyhub2RlLCAhIXByb3BzLm11bHRpcGxlLCB2YWx1ZSwgZmFsc2UpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHdhc011bHRpcGxlICE9PSAhIXByb3BzLm11bHRpcGxlKSB7CiAgICAgICAgICAgICAgaWYgKHByb3BzLmRlZmF1bHRWYWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICB1cGRhdGVPcHRpb25zKG5vZGUsICEhcHJvcHMubXVsdGlwbGUsIHByb3BzLmRlZmF1bHRWYWx1ZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHVwZGF0ZU9wdGlvbnMobm9kZSwgISFwcm9wcy5tdWx0aXBsZSwgcHJvcHMubXVsdGlwbGUgPyBbXSA6ICIiLCBmYWxzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZXN0b3JlQ29udHJvbGxlZFN0YXRlJDEoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgICB2YXIgdmFsdWUgPSBwcm9wcy52YWx1ZTsKICAgICAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgICB1cGRhdGVPcHRpb25zKG5vZGUsICEhcHJvcHMubXVsdGlwbGUsIHZhbHVlLCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBkaWRXYXJuVmFsRGVmYXVsdFZhbCA9IGZhbHNlOwogICAgICAgICAgZnVuY3Rpb24gZ2V0SG9zdFByb3BzJDIoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgICBpZiAocHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiYGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MYCBkb2VzIG5vdCBtYWtlIHNlbnNlIG9uIDx0ZXh0YXJlYT4uIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGhvc3RQcm9wcyA9IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICB2YWx1ZTogdm9pZCAwLAogICAgICAgICAgICAgIGRlZmF1bHRWYWx1ZTogdm9pZCAwLAogICAgICAgICAgICAgIGNoaWxkcmVuOiB0b1N0cmluZyhub2RlLl93cmFwcGVyU3RhdGUuaW5pdGlhbFZhbHVlKQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIGhvc3RQcm9wczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGluaXRXcmFwcGVyU3RhdGUkMihlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjaGVja0NvbnRyb2xsZWRWYWx1ZVByb3BzKCJ0ZXh0YXJlYSIsIHByb3BzKTsKICAgICAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0VmFsdWUgIT09IHZvaWQgMCAmJiAhZGlkV2FyblZhbERlZmF1bHRWYWwpIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyBjb250YWlucyBhIHRleHRhcmVhIHdpdGggYm90aCB2YWx1ZSBhbmQgZGVmYXVsdFZhbHVlIHByb3BzLiBUZXh0YXJlYSBlbGVtZW50cyBtdXN0IGJlIGVpdGhlciBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCAoc3BlY2lmeSBlaXRoZXIgdGhlIHZhbHVlIHByb3AsIG9yIHRoZSBkZWZhdWx0VmFsdWUgcHJvcCwgYnV0IG5vdCBib3RoKS4gRGVjaWRlIGJldHdlZW4gdXNpbmcgYSBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCB0ZXh0YXJlYSBhbmQgcmVtb3ZlIG9uZSBvZiB0aGVzZSBwcm9wcy4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIiwgZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lSW5EZXZPck51bGwoKSB8fCAiQSBjb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5WYWxEZWZhdWx0VmFsID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGluaXRpYWxWYWx1ZSA9IHByb3BzLnZhbHVlOwogICAgICAgICAgICBpZiAoaW5pdGlhbFZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgY2hpbGRyZW4yID0gcHJvcHMuY2hpbGRyZW4sIGRlZmF1bHRWYWx1ZSA9IHByb3BzLmRlZmF1bHRWYWx1ZTsKICAgICAgICAgICAgICBpZiAoY2hpbGRyZW4yICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlVzZSB0aGUgYGRlZmF1bHRWYWx1ZWAgb3IgYHZhbHVlYCBwcm9wcyBpbnN0ZWFkIG9mIHNldHRpbmcgY2hpbGRyZW4gb24gPHRleHRhcmVhPi4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKGRlZmF1bHRWYWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJZiB5b3Ugc3VwcGx5IGBkZWZhdWx0VmFsdWVgIG9uIGEgPHRleHRhcmVhPiwgZG8gbm90IHBhc3MgY2hpbGRyZW4uIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkoY2hpbGRyZW4yKSkgewogICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZHJlbjIubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCI8dGV4dGFyZWE+IGNhbiBvbmx5IGhhdmUgYXQgbW9zdCBvbmUgY2hpbGQuIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuMiA9IGNoaWxkcmVuMlswXTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBkZWZhdWx0VmFsdWUgPSBjaGlsZHJlbjI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChkZWZhdWx0VmFsdWUgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZGVmYXVsdFZhbHVlID0gIiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGluaXRpYWxWYWx1ZSA9IGRlZmF1bHRWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlLl93cmFwcGVyU3RhdGUgPSB7CiAgICAgICAgICAgICAgaW5pdGlhbFZhbHVlOiBnZXRUb1N0cmluZ1ZhbHVlKGluaXRpYWxWYWx1ZSkKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVdyYXBwZXIkMShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IGdldFRvU3RyaW5nVmFsdWUocHJvcHMudmFsdWUpOwogICAgICAgICAgICB2YXIgZGVmYXVsdFZhbHVlID0gZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy5kZWZhdWx0VmFsdWUpOwogICAgICAgICAgICBpZiAodmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IHRvU3RyaW5nKHZhbHVlKTsKICAgICAgICAgICAgICBpZiAobmV3VmFsdWUgIT09IG5vZGUudmFsdWUpIHsKICAgICAgICAgICAgICAgIG5vZGUudmFsdWUgPSBuZXdWYWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHByb3BzLmRlZmF1bHRWYWx1ZSA9PSBudWxsICYmIG5vZGUuZGVmYXVsdFZhbHVlICE9PSBuZXdWYWx1ZSkgewogICAgICAgICAgICAgICAgbm9kZS5kZWZhdWx0VmFsdWUgPSBuZXdWYWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRlZmF1bHRWYWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgbm9kZS5kZWZhdWx0VmFsdWUgPSB0b1N0cmluZyhkZWZhdWx0VmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwb3N0TW91bnRXcmFwcGVyJDMoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgICB2YXIgdGV4dENvbnRlbnQgPSBub2RlLnRleHRDb250ZW50OwogICAgICAgICAgICBpZiAodGV4dENvbnRlbnQgPT09IG5vZGUuX3dyYXBwZXJTdGF0ZS5pbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgICBpZiAodGV4dENvbnRlbnQgIT09ICIiICYmIHRleHRDb250ZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBub2RlLnZhbHVlID0gdGV4dENvbnRlbnQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZXN0b3JlQ29udHJvbGxlZFN0YXRlJDIoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgICAgdXBkYXRlV3JhcHBlciQxKGVsZW1lbnQsIHByb3BzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBIVE1MX05BTUVTUEFDRSA9ICJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIjsKICAgICAgICAgIHZhciBNQVRIX05BTUVTUEFDRSA9ICJodHRwOi8vd3d3LnczLm9yZy8xOTk4L01hdGgvTWF0aE1MIjsKICAgICAgICAgIHZhciBTVkdfTkFNRVNQQUNFID0gImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIjsKICAgICAgICAgIGZ1bmN0aW9uIGdldEludHJpbnNpY05hbWVzcGFjZSh0eXBlMikgewogICAgICAgICAgICBzd2l0Y2ggKHR5cGUyKSB7CiAgICAgICAgICAgICAgY2FzZSAic3ZnIjoKICAgICAgICAgICAgICAgIHJldHVybiBTVkdfTkFNRVNQQUNFOwogICAgICAgICAgICAgIGNhc2UgIm1hdGgiOgogICAgICAgICAgICAgICAgcmV0dXJuIE1BVEhfTkFNRVNQQUNFOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gSFRNTF9OQU1FU1BBQ0U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldENoaWxkTmFtZXNwYWNlKHBhcmVudE5hbWVzcGFjZSwgdHlwZTIpIHsKICAgICAgICAgICAgaWYgKHBhcmVudE5hbWVzcGFjZSA9PSBudWxsIHx8IHBhcmVudE5hbWVzcGFjZSA9PT0gSFRNTF9OQU1FU1BBQ0UpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0SW50cmluc2ljTmFtZXNwYWNlKHR5cGUyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocGFyZW50TmFtZXNwYWNlID09PSBTVkdfTkFNRVNQQUNFICYmIHR5cGUyID09PSAiZm9yZWlnbk9iamVjdCIpIHsKICAgICAgICAgICAgICByZXR1cm4gSFRNTF9OQU1FU1BBQ0U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHBhcmVudE5hbWVzcGFjZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjcmVhdGVNaWNyb3NvZnRVbnNhZmVMb2NhbEZ1bmN0aW9uID0gZnVuY3Rpb24oZnVuYykgewogICAgICAgICAgICBpZiAodHlwZW9mIE1TQXBwICE9PSAidW5kZWZpbmVkIiAmJiBNU0FwcC5leGVjVW5zYWZlTG9jYWxGdW5jdGlvbikgewogICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihhcmcwLCBhcmcxLCBhcmcyLCBhcmczKSB7CiAgICAgICAgICAgICAgICBNU0FwcC5leGVjVW5zYWZlTG9jYWxGdW5jdGlvbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmMoYXJnMCwgYXJnMSwgYXJnMiwgYXJnMyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBmdW5jOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHJldXNhYmxlU1ZHQ29udGFpbmVyOwogICAgICAgICAgdmFyIHNldElubmVySFRNTCA9IGNyZWF0ZU1pY3Jvc29mdFVuc2FmZUxvY2FsRnVuY3Rpb24oZnVuY3Rpb24obm9kZSwgaHRtbCkgewogICAgICAgICAgICBpZiAobm9kZS5uYW1lc3BhY2VVUkkgPT09IFNWR19OQU1FU1BBQ0UpIHsKICAgICAgICAgICAgICBpZiAoISgiaW5uZXJIVE1MIiBpbiBub2RlKSkgewogICAgICAgICAgICAgICAgcmV1c2FibGVTVkdDb250YWluZXIgPSByZXVzYWJsZVNWR0NvbnRhaW5lciB8fCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgICAgICAgIHJldXNhYmxlU1ZHQ29udGFpbmVyLmlubmVySFRNTCA9ICI8c3ZnPiIgKyBodG1sLnZhbHVlT2YoKS50b1N0cmluZygpICsgIjwvc3ZnPiI7CiAgICAgICAgICAgICAgICB2YXIgc3ZnTm9kZTIgPSByZXVzYWJsZVNWR0NvbnRhaW5lci5maXJzdENoaWxkOwogICAgICAgICAgICAgICAgd2hpbGUgKG5vZGUuZmlyc3RDaGlsZCkgewogICAgICAgICAgICAgICAgICBub2RlLnJlbW92ZUNoaWxkKG5vZGUuZmlyc3RDaGlsZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB3aGlsZSAoc3ZnTm9kZTIuZmlyc3RDaGlsZCkgewogICAgICAgICAgICAgICAgICBub2RlLmFwcGVuZENoaWxkKHN2Z05vZGUyLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlLmlubmVySFRNTCA9IGh0bWw7CiAgICAgICAgICB9KTsKICAgICAgICAgIHZhciBFTEVNRU5UX05PREUgPSAxOwogICAgICAgICAgdmFyIFRFWFRfTk9ERSA9IDM7CiAgICAgICAgICB2YXIgQ09NTUVOVF9OT0RFID0gODsKICAgICAgICAgIHZhciBET0NVTUVOVF9OT0RFID0gOTsKICAgICAgICAgIHZhciBET0NVTUVOVF9GUkFHTUVOVF9OT0RFID0gMTE7CiAgICAgICAgICB2YXIgc2V0VGV4dENvbnRlbnQgPSBmdW5jdGlvbihub2RlLCB0ZXh0KSB7CiAgICAgICAgICAgIGlmICh0ZXh0KSB7CiAgICAgICAgICAgICAgdmFyIGZpcnN0Q2hpbGQgPSBub2RlLmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgICAgaWYgKGZpcnN0Q2hpbGQgJiYgZmlyc3RDaGlsZCA9PT0gbm9kZS5sYXN0Q2hpbGQgJiYgZmlyc3RDaGlsZC5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFKSB7CiAgICAgICAgICAgICAgICBmaXJzdENoaWxkLm5vZGVWYWx1ZSA9IHRleHQ7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUudGV4dENvbnRlbnQgPSB0ZXh0OwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBzaG9ydGhhbmRUb0xvbmdoYW5kID0gewogICAgICAgICAgICBhbmltYXRpb246IFsiYW5pbWF0aW9uRGVsYXkiLCAiYW5pbWF0aW9uRGlyZWN0aW9uIiwgImFuaW1hdGlvbkR1cmF0aW9uIiwgImFuaW1hdGlvbkZpbGxNb2RlIiwgImFuaW1hdGlvbkl0ZXJhdGlvbkNvdW50IiwgImFuaW1hdGlvbk5hbWUiLCAiYW5pbWF0aW9uUGxheVN0YXRlIiwgImFuaW1hdGlvblRpbWluZ0Z1bmN0aW9uIl0sCiAgICAgICAgICAgIGJhY2tncm91bmQ6IFsiYmFja2dyb3VuZEF0dGFjaG1lbnQiLCAiYmFja2dyb3VuZENsaXAiLCAiYmFja2dyb3VuZENvbG9yIiwgImJhY2tncm91bmRJbWFnZSIsICJiYWNrZ3JvdW5kT3JpZ2luIiwgImJhY2tncm91bmRQb3NpdGlvblgiLCAiYmFja2dyb3VuZFBvc2l0aW9uWSIsICJiYWNrZ3JvdW5kUmVwZWF0IiwgImJhY2tncm91bmRTaXplIl0sCiAgICAgICAgICAgIGJhY2tncm91bmRQb3NpdGlvbjogWyJiYWNrZ3JvdW5kUG9zaXRpb25YIiwgImJhY2tncm91bmRQb3NpdGlvblkiXSwKICAgICAgICAgICAgYm9yZGVyOiBbImJvcmRlckJvdHRvbUNvbG9yIiwgImJvcmRlckJvdHRvbVN0eWxlIiwgImJvcmRlckJvdHRvbVdpZHRoIiwgImJvcmRlckltYWdlT3V0c2V0IiwgImJvcmRlckltYWdlUmVwZWF0IiwgImJvcmRlckltYWdlU2xpY2UiLCAiYm9yZGVySW1hZ2VTb3VyY2UiLCAiYm9yZGVySW1hZ2VXaWR0aCIsICJib3JkZXJMZWZ0Q29sb3IiLCAiYm9yZGVyTGVmdFN0eWxlIiwgImJvcmRlckxlZnRXaWR0aCIsICJib3JkZXJSaWdodENvbG9yIiwgImJvcmRlclJpZ2h0U3R5bGUiLCAiYm9yZGVyUmlnaHRXaWR0aCIsICJib3JkZXJUb3BDb2xvciIsICJib3JkZXJUb3BTdHlsZSIsICJib3JkZXJUb3BXaWR0aCJdLAogICAgICAgICAgICBib3JkZXJCbG9ja0VuZDogWyJib3JkZXJCbG9ja0VuZENvbG9yIiwgImJvcmRlckJsb2NrRW5kU3R5bGUiLCAiYm9yZGVyQmxvY2tFbmRXaWR0aCJdLAogICAgICAgICAgICBib3JkZXJCbG9ja1N0YXJ0OiBbImJvcmRlckJsb2NrU3RhcnRDb2xvciIsICJib3JkZXJCbG9ja1N0YXJ0U3R5bGUiLCAiYm9yZGVyQmxvY2tTdGFydFdpZHRoIl0sCiAgICAgICAgICAgIGJvcmRlckJvdHRvbTogWyJib3JkZXJCb3R0b21Db2xvciIsICJib3JkZXJCb3R0b21TdHlsZSIsICJib3JkZXJCb3R0b21XaWR0aCJdLAogICAgICAgICAgICBib3JkZXJDb2xvcjogWyJib3JkZXJCb3R0b21Db2xvciIsICJib3JkZXJMZWZ0Q29sb3IiLCAiYm9yZGVyUmlnaHRDb2xvciIsICJib3JkZXJUb3BDb2xvciJdLAogICAgICAgICAgICBib3JkZXJJbWFnZTogWyJib3JkZXJJbWFnZU91dHNldCIsICJib3JkZXJJbWFnZVJlcGVhdCIsICJib3JkZXJJbWFnZVNsaWNlIiwgImJvcmRlckltYWdlU291cmNlIiwgImJvcmRlckltYWdlV2lkdGgiXSwKICAgICAgICAgICAgYm9yZGVySW5saW5lRW5kOiBbImJvcmRlcklubGluZUVuZENvbG9yIiwgImJvcmRlcklubGluZUVuZFN0eWxlIiwgImJvcmRlcklubGluZUVuZFdpZHRoIl0sCiAgICAgICAgICAgIGJvcmRlcklubGluZVN0YXJ0OiBbImJvcmRlcklubGluZVN0YXJ0Q29sb3IiLCAiYm9yZGVySW5saW5lU3RhcnRTdHlsZSIsICJib3JkZXJJbmxpbmVTdGFydFdpZHRoIl0sCiAgICAgICAgICAgIGJvcmRlckxlZnQ6IFsiYm9yZGVyTGVmdENvbG9yIiwgImJvcmRlckxlZnRTdHlsZSIsICJib3JkZXJMZWZ0V2lkdGgiXSwKICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiBbImJvcmRlckJvdHRvbUxlZnRSYWRpdXMiLCAiYm9yZGVyQm90dG9tUmlnaHRSYWRpdXMiLCAiYm9yZGVyVG9wTGVmdFJhZGl1cyIsICJib3JkZXJUb3BSaWdodFJhZGl1cyJdLAogICAgICAgICAgICBib3JkZXJSaWdodDogWyJib3JkZXJSaWdodENvbG9yIiwgImJvcmRlclJpZ2h0U3R5bGUiLCAiYm9yZGVyUmlnaHRXaWR0aCJdLAogICAgICAgICAgICBib3JkZXJTdHlsZTogWyJib3JkZXJCb3R0b21TdHlsZSIsICJib3JkZXJMZWZ0U3R5bGUiLCAiYm9yZGVyUmlnaHRTdHlsZSIsICJib3JkZXJUb3BTdHlsZSJdLAogICAgICAgICAgICBib3JkZXJUb3A6IFsiYm9yZGVyVG9wQ29sb3IiLCAiYm9yZGVyVG9wU3R5bGUiLCAiYm9yZGVyVG9wV2lkdGgiXSwKICAgICAgICAgICAgYm9yZGVyV2lkdGg6IFsiYm9yZGVyQm90dG9tV2lkdGgiLCAiYm9yZGVyTGVmdFdpZHRoIiwgImJvcmRlclJpZ2h0V2lkdGgiLCAiYm9yZGVyVG9wV2lkdGgiXSwKICAgICAgICAgICAgY29sdW1uUnVsZTogWyJjb2x1bW5SdWxlQ29sb3IiLCAiY29sdW1uUnVsZVN0eWxlIiwgImNvbHVtblJ1bGVXaWR0aCJdLAogICAgICAgICAgICBjb2x1bW5zOiBbImNvbHVtbkNvdW50IiwgImNvbHVtbldpZHRoIl0sCiAgICAgICAgICAgIGZsZXg6IFsiZmxleEJhc2lzIiwgImZsZXhHcm93IiwgImZsZXhTaHJpbmsiXSwKICAgICAgICAgICAgZmxleEZsb3c6IFsiZmxleERpcmVjdGlvbiIsICJmbGV4V3JhcCJdLAogICAgICAgICAgICBmb250OiBbImZvbnRGYW1pbHkiLCAiZm9udEZlYXR1cmVTZXR0aW5ncyIsICJmb250S2VybmluZyIsICJmb250TGFuZ3VhZ2VPdmVycmlkZSIsICJmb250U2l6ZSIsICJmb250U2l6ZUFkanVzdCIsICJmb250U3RyZXRjaCIsICJmb250U3R5bGUiLCAiZm9udFZhcmlhbnQiLCAiZm9udFZhcmlhbnRBbHRlcm5hdGVzIiwgImZvbnRWYXJpYW50Q2FwcyIsICJmb250VmFyaWFudEVhc3RBc2lhbiIsICJmb250VmFyaWFudExpZ2F0dXJlcyIsICJmb250VmFyaWFudE51bWVyaWMiLCAiZm9udFZhcmlhbnRQb3NpdGlvbiIsICJmb250V2VpZ2h0IiwgImxpbmVIZWlnaHQiXSwKICAgICAgICAgICAgZm9udFZhcmlhbnQ6IFsiZm9udFZhcmlhbnRBbHRlcm5hdGVzIiwgImZvbnRWYXJpYW50Q2FwcyIsICJmb250VmFyaWFudEVhc3RBc2lhbiIsICJmb250VmFyaWFudExpZ2F0dXJlcyIsICJmb250VmFyaWFudE51bWVyaWMiLCAiZm9udFZhcmlhbnRQb3NpdGlvbiJdLAogICAgICAgICAgICBnYXA6IFsiY29sdW1uR2FwIiwgInJvd0dhcCJdLAogICAgICAgICAgICBncmlkOiBbImdyaWRBdXRvQ29sdW1ucyIsICJncmlkQXV0b0Zsb3ciLCAiZ3JpZEF1dG9Sb3dzIiwgImdyaWRUZW1wbGF0ZUFyZWFzIiwgImdyaWRUZW1wbGF0ZUNvbHVtbnMiLCAiZ3JpZFRlbXBsYXRlUm93cyJdLAogICAgICAgICAgICBncmlkQXJlYTogWyJncmlkQ29sdW1uRW5kIiwgImdyaWRDb2x1bW5TdGFydCIsICJncmlkUm93RW5kIiwgImdyaWRSb3dTdGFydCJdLAogICAgICAgICAgICBncmlkQ29sdW1uOiBbImdyaWRDb2x1bW5FbmQiLCAiZ3JpZENvbHVtblN0YXJ0Il0sCiAgICAgICAgICAgIGdyaWRDb2x1bW5HYXA6IFsiY29sdW1uR2FwIl0sCiAgICAgICAgICAgIGdyaWRHYXA6IFsiY29sdW1uR2FwIiwgInJvd0dhcCJdLAogICAgICAgICAgICBncmlkUm93OiBbImdyaWRSb3dFbmQiLCAiZ3JpZFJvd1N0YXJ0Il0sCiAgICAgICAgICAgIGdyaWRSb3dHYXA6IFsicm93R2FwIl0sCiAgICAgICAgICAgIGdyaWRUZW1wbGF0ZTogWyJncmlkVGVtcGxhdGVBcmVhcyIsICJncmlkVGVtcGxhdGVDb2x1bW5zIiwgImdyaWRUZW1wbGF0ZVJvd3MiXSwKICAgICAgICAgICAgbGlzdFN0eWxlOiBbImxpc3RTdHlsZUltYWdlIiwgImxpc3RTdHlsZVBvc2l0aW9uIiwgImxpc3RTdHlsZVR5cGUiXSwKICAgICAgICAgICAgbWFyZ2luOiBbIm1hcmdpbkJvdHRvbSIsICJtYXJnaW5MZWZ0IiwgIm1hcmdpblJpZ2h0IiwgIm1hcmdpblRvcCJdLAogICAgICAgICAgICBtYXJrZXI6IFsibWFya2VyRW5kIiwgIm1hcmtlck1pZCIsICJtYXJrZXJTdGFydCJdLAogICAgICAgICAgICBtYXNrOiBbIm1hc2tDbGlwIiwgIm1hc2tDb21wb3NpdGUiLCAibWFza0ltYWdlIiwgIm1hc2tNb2RlIiwgIm1hc2tPcmlnaW4iLCAibWFza1Bvc2l0aW9uWCIsICJtYXNrUG9zaXRpb25ZIiwgIm1hc2tSZXBlYXQiLCAibWFza1NpemUiXSwKICAgICAgICAgICAgbWFza1Bvc2l0aW9uOiBbIm1hc2tQb3NpdGlvblgiLCAibWFza1Bvc2l0aW9uWSJdLAogICAgICAgICAgICBvdXRsaW5lOiBbIm91dGxpbmVDb2xvciIsICJvdXRsaW5lU3R5bGUiLCAib3V0bGluZVdpZHRoIl0sCiAgICAgICAgICAgIG92ZXJmbG93OiBbIm92ZXJmbG93WCIsICJvdmVyZmxvd1kiXSwKICAgICAgICAgICAgcGFkZGluZzogWyJwYWRkaW5nQm90dG9tIiwgInBhZGRpbmdMZWZ0IiwgInBhZGRpbmdSaWdodCIsICJwYWRkaW5nVG9wIl0sCiAgICAgICAgICAgIHBsYWNlQ29udGVudDogWyJhbGlnbkNvbnRlbnQiLCAianVzdGlmeUNvbnRlbnQiXSwKICAgICAgICAgICAgcGxhY2VJdGVtczogWyJhbGlnbkl0ZW1zIiwgImp1c3RpZnlJdGVtcyJdLAogICAgICAgICAgICBwbGFjZVNlbGY6IFsiYWxpZ25TZWxmIiwgImp1c3RpZnlTZWxmIl0sCiAgICAgICAgICAgIHRleHREZWNvcmF0aW9uOiBbInRleHREZWNvcmF0aW9uQ29sb3IiLCAidGV4dERlY29yYXRpb25MaW5lIiwgInRleHREZWNvcmF0aW9uU3R5bGUiXSwKICAgICAgICAgICAgdGV4dEVtcGhhc2lzOiBbInRleHRFbXBoYXNpc0NvbG9yIiwgInRleHRFbXBoYXNpc1N0eWxlIl0sCiAgICAgICAgICAgIHRyYW5zaXRpb246IFsidHJhbnNpdGlvbkRlbGF5IiwgInRyYW5zaXRpb25EdXJhdGlvbiIsICJ0cmFuc2l0aW9uUHJvcGVydHkiLCAidHJhbnNpdGlvblRpbWluZ0Z1bmN0aW9uIl0sCiAgICAgICAgICAgIHdvcmRXcmFwOiBbIm92ZXJmbG93V3JhcCJdCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGlzVW5pdGxlc3NOdW1iZXIgPSB7CiAgICAgICAgICAgIGFuaW1hdGlvbkl0ZXJhdGlvbkNvdW50OiB0cnVlLAogICAgICAgICAgICBhc3BlY3RSYXRpbzogdHJ1ZSwKICAgICAgICAgICAgYm9yZGVySW1hZ2VPdXRzZXQ6IHRydWUsCiAgICAgICAgICAgIGJvcmRlckltYWdlU2xpY2U6IHRydWUsCiAgICAgICAgICAgIGJvcmRlckltYWdlV2lkdGg6IHRydWUsCiAgICAgICAgICAgIGJveEZsZXg6IHRydWUsCiAgICAgICAgICAgIGJveEZsZXhHcm91cDogdHJ1ZSwKICAgICAgICAgICAgYm94T3JkaW5hbEdyb3VwOiB0cnVlLAogICAgICAgICAgICBjb2x1bW5Db3VudDogdHJ1ZSwKICAgICAgICAgICAgY29sdW1uczogdHJ1ZSwKICAgICAgICAgICAgZmxleDogdHJ1ZSwKICAgICAgICAgICAgZmxleEdyb3c6IHRydWUsCiAgICAgICAgICAgIGZsZXhQb3NpdGl2ZTogdHJ1ZSwKICAgICAgICAgICAgZmxleFNocmluazogdHJ1ZSwKICAgICAgICAgICAgZmxleE5lZ2F0aXZlOiB0cnVlLAogICAgICAgICAgICBmbGV4T3JkZXI6IHRydWUsCiAgICAgICAgICAgIGdyaWRBcmVhOiB0cnVlLAogICAgICAgICAgICBncmlkUm93OiB0cnVlLAogICAgICAgICAgICBncmlkUm93RW5kOiB0cnVlLAogICAgICAgICAgICBncmlkUm93U3BhbjogdHJ1ZSwKICAgICAgICAgICAgZ3JpZFJvd1N0YXJ0OiB0cnVlLAogICAgICAgICAgICBncmlkQ29sdW1uOiB0cnVlLAogICAgICAgICAgICBncmlkQ29sdW1uRW5kOiB0cnVlLAogICAgICAgICAgICBncmlkQ29sdW1uU3BhbjogdHJ1ZSwKICAgICAgICAgICAgZ3JpZENvbHVtblN0YXJ0OiB0cnVlLAogICAgICAgICAgICBmb250V2VpZ2h0OiB0cnVlLAogICAgICAgICAgICBsaW5lQ2xhbXA6IHRydWUsCiAgICAgICAgICAgIGxpbmVIZWlnaHQ6IHRydWUsCiAgICAgICAgICAgIG9wYWNpdHk6IHRydWUsCiAgICAgICAgICAgIG9yZGVyOiB0cnVlLAogICAgICAgICAgICBvcnBoYW5zOiB0cnVlLAogICAgICAgICAgICB0YWJTaXplOiB0cnVlLAogICAgICAgICAgICB3aWRvd3M6IHRydWUsCiAgICAgICAgICAgIHpJbmRleDogdHJ1ZSwKICAgICAgICAgICAgem9vbTogdHJ1ZSwKICAgICAgICAgICAgLy8gU1ZHLXJlbGF0ZWQgcHJvcGVydGllcwogICAgICAgICAgICBmaWxsT3BhY2l0eTogdHJ1ZSwKICAgICAgICAgICAgZmxvb2RPcGFjaXR5OiB0cnVlLAogICAgICAgICAgICBzdG9wT3BhY2l0eTogdHJ1ZSwKICAgICAgICAgICAgc3Ryb2tlRGFzaGFycmF5OiB0cnVlLAogICAgICAgICAgICBzdHJva2VEYXNob2Zmc2V0OiB0cnVlLAogICAgICAgICAgICBzdHJva2VNaXRlcmxpbWl0OiB0cnVlLAogICAgICAgICAgICBzdHJva2VPcGFjaXR5OiB0cnVlLAogICAgICAgICAgICBzdHJva2VXaWR0aDogdHJ1ZQogICAgICAgICAgfTsKICAgICAgICAgIGZ1bmN0aW9uIHByZWZpeEtleShwcmVmaXgyLCBrZXkpIHsKICAgICAgICAgICAgcmV0dXJuIHByZWZpeDIgKyBrZXkuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBrZXkuc3Vic3RyaW5nKDEpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByZWZpeGVzID0gWyJXZWJraXQiLCAibXMiLCAiTW96IiwgIk8iXTsKICAgICAgICAgIE9iamVjdC5rZXlzKGlzVW5pdGxlc3NOdW1iZXIpLmZvckVhY2goZnVuY3Rpb24ocHJvcCkgewogICAgICAgICAgICBwcmVmaXhlcy5mb3JFYWNoKGZ1bmN0aW9uKHByZWZpeDIpIHsKICAgICAgICAgICAgICBpc1VuaXRsZXNzTnVtYmVyW3ByZWZpeEtleShwcmVmaXgyLCBwcm9wKV0gPSBpc1VuaXRsZXNzTnVtYmVyW3Byb3BdOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgICAgZnVuY3Rpb24gZGFuZ2Vyb3VzU3R5bGVWYWx1ZShuYW1lLCB2YWx1ZSwgaXNDdXN0b21Qcm9wZXJ0eSkgewogICAgICAgICAgICB2YXIgaXNFbXB0eSA9IHZhbHVlID09IG51bGwgfHwgdHlwZW9mIHZhbHVlID09PSAiYm9vbGVhbiIgfHwgdmFsdWUgPT09ICIiOwogICAgICAgICAgICBpZiAoaXNFbXB0eSkgewogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWlzQ3VzdG9tUHJvcGVydHkgJiYgdHlwZW9mIHZhbHVlID09PSAibnVtYmVyIiAmJiB2YWx1ZSAhPT0gMCAmJiAhKGlzVW5pdGxlc3NOdW1iZXIuaGFzT3duUHJvcGVydHkobmFtZSkgJiYgaXNVbml0bGVzc051bWJlcltuYW1lXSkpIHsKICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgKyAicHgiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjaGVja0NTU1Byb3BlcnR5U3RyaW5nQ29lcmNpb24odmFsdWUsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAoIiIgKyB2YWx1ZSkudHJpbSgpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHVwcGVyY2FzZVBhdHRlcm4gPSAvKFtBLVpdKS9nOwogICAgICAgICAgdmFyIG1zUGF0dGVybiA9IC9ebXMtLzsKICAgICAgICAgIGZ1bmN0aW9uIGh5cGhlbmF0ZVN0eWxlTmFtZShuYW1lKSB7CiAgICAgICAgICAgIHJldHVybiBuYW1lLnJlcGxhY2UodXBwZXJjYXNlUGF0dGVybiwgIi0kMSIpLnRvTG93ZXJDYXNlKCkucmVwbGFjZShtc1BhdHRlcm4sICItbXMtIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgd2FyblZhbGlkU3R5bGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIH07CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBiYWRWZW5kb3JlZFN0eWxlTmFtZVBhdHRlcm4gPSAvXig/OndlYmtpdHxtb3p8bylbQS1aXS87CiAgICAgICAgICAgIHZhciBtc1BhdHRlcm4kMSA9IC9eLW1zLS87CiAgICAgICAgICAgIHZhciBoeXBoZW5QYXR0ZXJuID0gLy0oLikvZzsKICAgICAgICAgICAgdmFyIGJhZFN0eWxlVmFsdWVXaXRoU2VtaWNvbG9uUGF0dGVybiA9IC87XHMqJC87CiAgICAgICAgICAgIHZhciB3YXJuZWRTdHlsZU5hbWVzID0ge307CiAgICAgICAgICAgIHZhciB3YXJuZWRTdHlsZVZhbHVlcyA9IHt9OwogICAgICAgICAgICB2YXIgd2FybmVkRm9yTmFOVmFsdWUgPSBmYWxzZTsKICAgICAgICAgICAgdmFyIHdhcm5lZEZvckluZmluaXR5VmFsdWUgPSBmYWxzZTsKICAgICAgICAgICAgdmFyIGNhbWVsaXplID0gZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKGh5cGhlblBhdHRlcm4sIGZ1bmN0aW9uKF8sIGNoYXJhY3RlcikgewogICAgICAgICAgICAgICAgcmV0dXJuIGNoYXJhY3Rlci50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgd2Fybkh5cGhlbmF0ZWRTdHlsZU5hbWUgPSBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgICAgaWYgKHdhcm5lZFN0eWxlTmFtZXMuaGFzT3duUHJvcGVydHkobmFtZSkgJiYgd2FybmVkU3R5bGVOYW1lc1tuYW1lXSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3YXJuZWRTdHlsZU5hbWVzW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICBlcnJvcigKICAgICAgICAgICAgICAgICJVbnN1cHBvcnRlZCBzdHlsZSBwcm9wZXJ0eSAlcy4gRGlkIHlvdSBtZWFuICVzPyIsCiAgICAgICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAgICAgLy8gQXMgQW5kaSBTbWl0aCBzdWdnZXN0cwogICAgICAgICAgICAgICAgLy8gKGh0dHA6Ly93d3cuYW5kaXNtaXRoLmNvbS9ibG9nLzIwMTIvMDIvbW9kZXJuaXpyLXByZWZpeGVkLyksIGFuIGAtbXNgIHByZWZpeAogICAgICAgICAgICAgICAgLy8gaXMgY29udmVydGVkIHRvIGxvd2VyY2FzZSBgbXNgLgogICAgICAgICAgICAgICAgY2FtZWxpemUobmFtZS5yZXBsYWNlKG1zUGF0dGVybiQxLCAibXMtIikpCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIHdhcm5CYWRWZW5kb3JlZFN0eWxlTmFtZSA9IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgICBpZiAod2FybmVkU3R5bGVOYW1lcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSAmJiB3YXJuZWRTdHlsZU5hbWVzW25hbWVdKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdhcm5lZFN0eWxlTmFtZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIGVycm9yKCJVbnN1cHBvcnRlZCB2ZW5kb3ItcHJlZml4ZWQgc3R5bGUgcHJvcGVydHkgJXMuIERpZCB5b3UgbWVhbiAlcz8iLCBuYW1lLCBuYW1lLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgbmFtZS5zbGljZSgxKSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciB3YXJuU3R5bGVWYWx1ZVdpdGhTZW1pY29sb24gPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICAgIGlmICh3YXJuZWRTdHlsZVZhbHVlcy5oYXNPd25Qcm9wZXJ0eSh2YWx1ZSkgJiYgd2FybmVkU3R5bGVWYWx1ZXNbdmFsdWVdKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdhcm5lZFN0eWxlVmFsdWVzW3ZhbHVlXSA9IHRydWU7CiAgICAgICAgICAgICAgZXJyb3IoYFN0eWxlIHByb3BlcnR5IHZhbHVlcyBzaG91bGRuJ3QgY29udGFpbiBhIHNlbWljb2xvbi4gVHJ5ICIlczogJXMiIGluc3RlYWQuYCwgbmFtZSwgdmFsdWUucmVwbGFjZShiYWRTdHlsZVZhbHVlV2l0aFNlbWljb2xvblBhdHRlcm4sICIiKSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciB3YXJuU3R5bGVWYWx1ZUlzTmFOID0gZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgICBpZiAod2FybmVkRm9yTmFOVmFsdWUpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2FybmVkRm9yTmFOVmFsdWUgPSB0cnVlOwogICAgICAgICAgICAgIGVycm9yKCJgTmFOYCBpcyBhbiBpbnZhbGlkIHZhbHVlIGZvciB0aGUgYCVzYCBjc3Mgc3R5bGUgcHJvcGVydHkuIiwgbmFtZSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciB3YXJuU3R5bGVWYWx1ZUlzSW5maW5pdHkgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICAgIGlmICh3YXJuZWRGb3JJbmZpbml0eVZhbHVlKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdhcm5lZEZvckluZmluaXR5VmFsdWUgPSB0cnVlOwogICAgICAgICAgICAgIGVycm9yKCJgSW5maW5pdHlgIGlzIGFuIGludmFsaWQgdmFsdWUgZm9yIHRoZSBgJXNgIGNzcyBzdHlsZSBwcm9wZXJ0eS4iLCBuYW1lKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgd2FyblZhbGlkU3R5bGUgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICAgIGlmIChuYW1lLmluZGV4T2YoIi0iKSA+IC0xKSB7CiAgICAgICAgICAgICAgICB3YXJuSHlwaGVuYXRlZFN0eWxlTmFtZShuYW1lKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGJhZFZlbmRvcmVkU3R5bGVOYW1lUGF0dGVybi50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgICB3YXJuQmFkVmVuZG9yZWRTdHlsZU5hbWUobmFtZSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChiYWRTdHlsZVZhbHVlV2l0aFNlbWljb2xvblBhdHRlcm4udGVzdCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHdhcm5TdHlsZVZhbHVlV2l0aFNlbWljb2xvbihuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNOYU4odmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgIHdhcm5TdHlsZVZhbHVlSXNOYU4obmFtZSwgdmFsdWUpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICghaXNGaW5pdGUodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgIHdhcm5TdHlsZVZhbHVlSXNJbmZpbml0eShuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgdmFyIHdhcm5WYWxpZFN0eWxlJDEgPSB3YXJuVmFsaWRTdHlsZTsKICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZURhbmdlcm91c1N0cmluZ0ZvclN0eWxlcyhzdHlsZXMpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBzZXJpYWxpemVkID0gIiI7CiAgICAgICAgICAgICAgdmFyIGRlbGltaXRlciA9ICIiOwogICAgICAgICAgICAgIGZvciAodmFyIHN0eWxlTmFtZSBpbiBzdHlsZXMpIHsKICAgICAgICAgICAgICAgIGlmICghc3R5bGVzLmhhc093blByb3BlcnR5KHN0eWxlTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgc3R5bGVWYWx1ZTIgPSBzdHlsZXNbc3R5bGVOYW1lXTsKICAgICAgICAgICAgICAgIGlmIChzdHlsZVZhbHVlMiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBpc0N1c3RvbVByb3BlcnR5ID0gc3R5bGVOYW1lLmluZGV4T2YoIi0tIikgPT09IDA7CiAgICAgICAgICAgICAgICAgIHNlcmlhbGl6ZWQgKz0gZGVsaW1pdGVyICsgKGlzQ3VzdG9tUHJvcGVydHkgPyBzdHlsZU5hbWUgOiBoeXBoZW5hdGVTdHlsZU5hbWUoc3R5bGVOYW1lKSkgKyAiOiI7CiAgICAgICAgICAgICAgICAgIHNlcmlhbGl6ZWQgKz0gZGFuZ2Vyb3VzU3R5bGVWYWx1ZShzdHlsZU5hbWUsIHN0eWxlVmFsdWUyLCBpc0N1c3RvbVByb3BlcnR5KTsKICAgICAgICAgICAgICAgICAgZGVsaW1pdGVyID0gIjsiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gc2VyaWFsaXplZCB8fCBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzZXRWYWx1ZUZvclN0eWxlcyhub2RlLCBzdHlsZXMpIHsKICAgICAgICAgICAgdmFyIHN0eWxlMiA9IG5vZGUuc3R5bGU7CiAgICAgICAgICAgIGZvciAodmFyIHN0eWxlTmFtZSBpbiBzdHlsZXMpIHsKICAgICAgICAgICAgICBpZiAoIXN0eWxlcy5oYXNPd25Qcm9wZXJ0eShzdHlsZU5hbWUpKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGlzQ3VzdG9tUHJvcGVydHkgPSBzdHlsZU5hbWUuaW5kZXhPZigiLS0iKSA9PT0gMDsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIWlzQ3VzdG9tUHJvcGVydHkpIHsKICAgICAgICAgICAgICAgICAgd2FyblZhbGlkU3R5bGUkMShzdHlsZU5hbWUsIHN0eWxlc1tzdHlsZU5hbWVdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHN0eWxlVmFsdWUyID0gZGFuZ2Vyb3VzU3R5bGVWYWx1ZShzdHlsZU5hbWUsIHN0eWxlc1tzdHlsZU5hbWVdLCBpc0N1c3RvbVByb3BlcnR5KTsKICAgICAgICAgICAgICBpZiAoc3R5bGVOYW1lID09PSAiZmxvYXQiKSB7CiAgICAgICAgICAgICAgICBzdHlsZU5hbWUgPSAiY3NzRmxvYXQiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaXNDdXN0b21Qcm9wZXJ0eSkgewogICAgICAgICAgICAgICAgc3R5bGUyLnNldFByb3BlcnR5KHN0eWxlTmFtZSwgc3R5bGVWYWx1ZTIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdHlsZTJbc3R5bGVOYW1lXSA9IHN0eWxlVmFsdWUyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaXNWYWx1ZUVtcHR5KHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PSBudWxsIHx8IHR5cGVvZiB2YWx1ZSA9PT0gImJvb2xlYW4iIHx8IHZhbHVlID09PSAiIjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGV4cGFuZFNob3J0aGFuZE1hcChzdHlsZXMpIHsKICAgICAgICAgICAgdmFyIGV4cGFuZGVkID0ge307CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBzdHlsZXMpIHsKICAgICAgICAgICAgICB2YXIgbG9uZ2hhbmRzID0gc2hvcnRoYW5kVG9Mb25naGFuZFtrZXldIHx8IFtrZXldOwogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbG9uZ2hhbmRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBleHBhbmRlZFtsb25naGFuZHNbaV1dID0ga2V5OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZXhwYW5kZWQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVNob3J0aGFuZFByb3BlcnR5Q29sbGlzaW9uSW5EZXYoc3R5bGVVcGRhdGVzLCBuZXh0U3R5bGVzKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIW5leHRTdHlsZXMpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGV4cGFuZGVkVXBkYXRlcyA9IGV4cGFuZFNob3J0aGFuZE1hcChzdHlsZVVwZGF0ZXMpOwogICAgICAgICAgICAgIHZhciBleHBhbmRlZFN0eWxlcyA9IGV4cGFuZFNob3J0aGFuZE1hcChuZXh0U3R5bGVzKTsKICAgICAgICAgICAgICB2YXIgd2FybmVkQWJvdXQgPSB7fTsKICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gZXhwYW5kZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxLZXkgPSBleHBhbmRlZFVwZGF0ZXNba2V5XTsKICAgICAgICAgICAgICAgIHZhciBjb3JyZWN0T3JpZ2luYWxLZXkgPSBleHBhbmRlZFN0eWxlc1trZXldOwogICAgICAgICAgICAgICAgaWYgKGNvcnJlY3RPcmlnaW5hbEtleSAmJiBvcmlnaW5hbEtleSAhPT0gY29ycmVjdE9yaWdpbmFsS2V5KSB7CiAgICAgICAgICAgICAgICAgIHZhciB3YXJuaW5nS2V5ID0gb3JpZ2luYWxLZXkgKyAiLCIgKyBjb3JyZWN0T3JpZ2luYWxLZXk7CiAgICAgICAgICAgICAgICAgIGlmICh3YXJuZWRBYm91dFt3YXJuaW5nS2V5XSkgewogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHdhcm5lZEFib3V0W3dhcm5pbmdLZXldID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzIGEgc3R5bGUgcHJvcGVydHkgZHVyaW5nIHJlcmVuZGVyICglcykgd2hlbiBhIGNvbmZsaWN0aW5nIHByb3BlcnR5IGlzIHNldCAoJXMpIGNhbiBsZWFkIHRvIHN0eWxpbmcgYnVncy4gVG8gYXZvaWQgdGhpcywgZG9uJ3QgbWl4IHNob3J0aGFuZCBhbmQgbm9uLXNob3J0aGFuZCBwcm9wZXJ0aWVzIGZvciB0aGUgc2FtZSB2YWx1ZTsgaW5zdGVhZCwgcmVwbGFjZSB0aGUgc2hvcnRoYW5kIHdpdGggc2VwYXJhdGUgdmFsdWVzLiIsIGlzVmFsdWVFbXB0eShzdHlsZVVwZGF0ZXNbb3JpZ2luYWxLZXldKSA/ICJSZW1vdmluZyIgOiAiVXBkYXRpbmciLCBvcmlnaW5hbEtleSwgY29ycmVjdE9yaWdpbmFsS2V5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBvbWl0dGVkQ2xvc2VUYWdzID0gewogICAgICAgICAgICBhcmVhOiB0cnVlLAogICAgICAgICAgICBiYXNlOiB0cnVlLAogICAgICAgICAgICBicjogdHJ1ZSwKICAgICAgICAgICAgY29sOiB0cnVlLAogICAgICAgICAgICBlbWJlZDogdHJ1ZSwKICAgICAgICAgICAgaHI6IHRydWUsCiAgICAgICAgICAgIGltZzogdHJ1ZSwKICAgICAgICAgICAgaW5wdXQ6IHRydWUsCiAgICAgICAgICAgIGtleWdlbjogdHJ1ZSwKICAgICAgICAgICAgbGluazogdHJ1ZSwKICAgICAgICAgICAgbWV0YTogdHJ1ZSwKICAgICAgICAgICAgcGFyYW06IHRydWUsCiAgICAgICAgICAgIHNvdXJjZTogdHJ1ZSwKICAgICAgICAgICAgdHJhY2s6IHRydWUsCiAgICAgICAgICAgIHdicjogdHJ1ZQogICAgICAgICAgICAvLyBOT1RFOiBtZW51aXRlbSdzIGNsb3NlIHRhZyBzaG91bGQgYmUgb21pdHRlZCwgYnV0IHRoYXQgY2F1c2VzIHByb2JsZW1zLgogICAgICAgICAgfTsKICAgICAgICAgIHZhciB2b2lkRWxlbWVudFRhZ3MgPSBhc3NpZ24oewogICAgICAgICAgICBtZW51aXRlbTogdHJ1ZQogICAgICAgICAgfSwgb21pdHRlZENsb3NlVGFncyk7CiAgICAgICAgICB2YXIgSFRNTCA9ICJfX2h0bWwiOwogICAgICAgICAgZnVuY3Rpb24gYXNzZXJ0VmFsaWRQcm9wcyh0YWcsIHByb3BzKSB7CiAgICAgICAgICAgIGlmICghcHJvcHMpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZvaWRFbGVtZW50VGFnc1t0YWddKSB7CiAgICAgICAgICAgICAgaWYgKHByb3BzLmNoaWxkcmVuICE9IG51bGwgfHwgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHRhZyArICIgaXMgYSB2b2lkIGVsZW1lbnQgdGFnIGFuZCBtdXN0IG5laXRoZXIgaGF2ZSBgY2hpbGRyZW5gIG5vciB1c2UgYGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MYC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MICE9IG51bGwpIHsKICAgICAgICAgICAgICBpZiAocHJvcHMuY2hpbGRyZW4gIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW4gb25seSBzZXQgb25lIG9mIGBjaGlsZHJlbmAgb3IgYHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MYC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCAhPT0gIm9iamVjdCIgfHwgIShIVE1MIGluIHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MKSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUxgIG11c3QgYmUgaW4gdGhlIGZvcm0gYHtfX2h0bWw6IC4uLn1gLiBQbGVhc2UgdmlzaXQgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2Rhbmdlcm91c2x5LXNldC1pbm5lci1odG1sIGZvciBtb3JlIGluZm9ybWF0aW9uLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCFwcm9wcy5zdXBwcmVzc0NvbnRlbnRFZGl0YWJsZVdhcm5pbmcgJiYgcHJvcHMuY29udGVudEVkaXRhYmxlICYmIHByb3BzLmNoaWxkcmVuICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJBIGNvbXBvbmVudCBpcyBgY29udGVudEVkaXRhYmxlYCBhbmQgY29udGFpbnMgYGNoaWxkcmVuYCBtYW5hZ2VkIGJ5IFJlYWN0LiBJdCBpcyBub3cgeW91ciByZXNwb25zaWJpbGl0eSB0byBndWFyYW50ZWUgdGhhdCBub25lIG9mIHRob3NlIG5vZGVzIGFyZSB1bmV4cGVjdGVkbHkgbW9kaWZpZWQgb3IgZHVwbGljYXRlZC4gVGhpcyBpcyBwcm9iYWJseSBub3QgaW50ZW50aW9uYWwuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wcy5zdHlsZSAhPSBudWxsICYmIHR5cGVvZiBwcm9wcy5zdHlsZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSBgc3R5bGVgIHByb3AgZXhwZWN0cyBhIG1hcHBpbmcgZnJvbSBzdHlsZSBwcm9wZXJ0aWVzIHRvIHZhbHVlcywgbm90IGEgc3RyaW5nLiBGb3IgZXhhbXBsZSwgc3R5bGU9e3ttYXJnaW5SaWdodDogc3BhY2luZyArICdlbSd9fSB3aGVuIHVzaW5nIEpTWC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaXNDdXN0b21Db21wb25lbnQodGFnTmFtZSwgcHJvcHMpIHsKICAgICAgICAgICAgaWYgKHRhZ05hbWUuaW5kZXhPZigiLSIpID09PSAtMSkgewogICAgICAgICAgICAgIHJldHVybiB0eXBlb2YgcHJvcHMuaXMgPT09ICJzdHJpbmciOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN3aXRjaCAodGFnTmFtZSkgewogICAgICAgICAgICAgIGNhc2UgImFubm90YXRpb24teG1sIjoKICAgICAgICAgICAgICBjYXNlICJjb2xvci1wcm9maWxlIjoKICAgICAgICAgICAgICBjYXNlICJmb250LWZhY2UiOgogICAgICAgICAgICAgIGNhc2UgImZvbnQtZmFjZS1zcmMiOgogICAgICAgICAgICAgIGNhc2UgImZvbnQtZmFjZS11cmkiOgogICAgICAgICAgICAgIGNhc2UgImZvbnQtZmFjZS1mb3JtYXQiOgogICAgICAgICAgICAgIGNhc2UgImZvbnQtZmFjZS1uYW1lIjoKICAgICAgICAgICAgICBjYXNlICJtaXNzaW5nLWdseXBoIjoKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBwb3NzaWJsZVN0YW5kYXJkTmFtZXMgPSB7CiAgICAgICAgICAgIC8vIEhUTUwKICAgICAgICAgICAgYWNjZXB0OiAiYWNjZXB0IiwKICAgICAgICAgICAgYWNjZXB0Y2hhcnNldDogImFjY2VwdENoYXJzZXQiLAogICAgICAgICAgICAiYWNjZXB0LWNoYXJzZXQiOiAiYWNjZXB0Q2hhcnNldCIsCiAgICAgICAgICAgIGFjY2Vzc2tleTogImFjY2Vzc0tleSIsCiAgICAgICAgICAgIGFjdGlvbjogImFjdGlvbiIsCiAgICAgICAgICAgIGFsbG93ZnVsbHNjcmVlbjogImFsbG93RnVsbFNjcmVlbiIsCiAgICAgICAgICAgIGFsdDogImFsdCIsCiAgICAgICAgICAgIGFzOiAiYXMiLAogICAgICAgICAgICBhc3luYzogImFzeW5jIiwKICAgICAgICAgICAgYXV0b2NhcGl0YWxpemU6ICJhdXRvQ2FwaXRhbGl6ZSIsCiAgICAgICAgICAgIGF1dG9jb21wbGV0ZTogImF1dG9Db21wbGV0ZSIsCiAgICAgICAgICAgIGF1dG9jb3JyZWN0OiAiYXV0b0NvcnJlY3QiLAogICAgICAgICAgICBhdXRvZm9jdXM6ICJhdXRvRm9jdXMiLAogICAgICAgICAgICBhdXRvcGxheTogImF1dG9QbGF5IiwKICAgICAgICAgICAgYXV0b3NhdmU6ICJhdXRvU2F2ZSIsCiAgICAgICAgICAgIGNhcHR1cmU6ICJjYXB0dXJlIiwKICAgICAgICAgICAgY2VsbHBhZGRpbmc6ICJjZWxsUGFkZGluZyIsCiAgICAgICAgICAgIGNlbGxzcGFjaW5nOiAiY2VsbFNwYWNpbmciLAogICAgICAgICAgICBjaGFsbGVuZ2U6ICJjaGFsbGVuZ2UiLAogICAgICAgICAgICBjaGFyc2V0OiAiY2hhclNldCIsCiAgICAgICAgICAgIGNoZWNrZWQ6ICJjaGVja2VkIiwKICAgICAgICAgICAgY2hpbGRyZW46ICJjaGlsZHJlbiIsCiAgICAgICAgICAgIGNpdGU6ICJjaXRlIiwKICAgICAgICAgICAgY2xhc3M6ICJjbGFzc05hbWUiLAogICAgICAgICAgICBjbGFzc2lkOiAiY2xhc3NJRCIsCiAgICAgICAgICAgIGNsYXNzbmFtZTogImNsYXNzTmFtZSIsCiAgICAgICAgICAgIGNvbHM6ICJjb2xzIiwKICAgICAgICAgICAgY29sc3BhbjogImNvbFNwYW4iLAogICAgICAgICAgICBjb250ZW50OiAiY29udGVudCIsCiAgICAgICAgICAgIGNvbnRlbnRlZGl0YWJsZTogImNvbnRlbnRFZGl0YWJsZSIsCiAgICAgICAgICAgIGNvbnRleHRtZW51OiAiY29udGV4dE1lbnUiLAogICAgICAgICAgICBjb250cm9sczogImNvbnRyb2xzIiwKICAgICAgICAgICAgY29udHJvbHNsaXN0OiAiY29udHJvbHNMaXN0IiwKICAgICAgICAgICAgY29vcmRzOiAiY29vcmRzIiwKICAgICAgICAgICAgY3Jvc3NvcmlnaW46ICJjcm9zc09yaWdpbiIsCiAgICAgICAgICAgIGRhbmdlcm91c2x5c2V0aW5uZXJodG1sOiAiZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwiLAogICAgICAgICAgICBkYXRhOiAiZGF0YSIsCiAgICAgICAgICAgIGRhdGV0aW1lOiAiZGF0ZVRpbWUiLAogICAgICAgICAgICBkZWZhdWx0OiAiZGVmYXVsdCIsCiAgICAgICAgICAgIGRlZmF1bHRjaGVja2VkOiAiZGVmYXVsdENoZWNrZWQiLAogICAgICAgICAgICBkZWZhdWx0dmFsdWU6ICJkZWZhdWx0VmFsdWUiLAogICAgICAgICAgICBkZWZlcjogImRlZmVyIiwKICAgICAgICAgICAgZGlyOiAiZGlyIiwKICAgICAgICAgICAgZGlzYWJsZWQ6ICJkaXNhYmxlZCIsCiAgICAgICAgICAgIGRpc2FibGVwaWN0dXJlaW5waWN0dXJlOiAiZGlzYWJsZVBpY3R1cmVJblBpY3R1cmUiLAogICAgICAgICAgICBkaXNhYmxlcmVtb3RlcGxheWJhY2s6ICJkaXNhYmxlUmVtb3RlUGxheWJhY2siLAogICAgICAgICAgICBkb3dubG9hZDogImRvd25sb2FkIiwKICAgICAgICAgICAgZHJhZ2dhYmxlOiAiZHJhZ2dhYmxlIiwKICAgICAgICAgICAgZW5jdHlwZTogImVuY1R5cGUiLAogICAgICAgICAgICBlbnRlcmtleWhpbnQ6ICJlbnRlcktleUhpbnQiLAogICAgICAgICAgICBmb3I6ICJodG1sRm9yIiwKICAgICAgICAgICAgZm9ybTogImZvcm0iLAogICAgICAgICAgICBmb3JtbWV0aG9kOiAiZm9ybU1ldGhvZCIsCiAgICAgICAgICAgIGZvcm1hY3Rpb246ICJmb3JtQWN0aW9uIiwKICAgICAgICAgICAgZm9ybWVuY3R5cGU6ICJmb3JtRW5jVHlwZSIsCiAgICAgICAgICAgIGZvcm1ub3ZhbGlkYXRlOiAiZm9ybU5vVmFsaWRhdGUiLAogICAgICAgICAgICBmb3JtdGFyZ2V0OiAiZm9ybVRhcmdldCIsCiAgICAgICAgICAgIGZyYW1lYm9yZGVyOiAiZnJhbWVCb3JkZXIiLAogICAgICAgICAgICBoZWFkZXJzOiAiaGVhZGVycyIsCiAgICAgICAgICAgIGhlaWdodDogImhlaWdodCIsCiAgICAgICAgICAgIGhpZGRlbjogImhpZGRlbiIsCiAgICAgICAgICAgIGhpZ2g6ICJoaWdoIiwKICAgICAgICAgICAgaHJlZjogImhyZWYiLAogICAgICAgICAgICBocmVmbGFuZzogImhyZWZMYW5nIiwKICAgICAgICAgICAgaHRtbGZvcjogImh0bWxGb3IiLAogICAgICAgICAgICBodHRwZXF1aXY6ICJodHRwRXF1aXYiLAogICAgICAgICAgICAiaHR0cC1lcXVpdiI6ICJodHRwRXF1aXYiLAogICAgICAgICAgICBpY29uOiAiaWNvbiIsCiAgICAgICAgICAgIGlkOiAiaWQiLAogICAgICAgICAgICBpbWFnZXNpemVzOiAiaW1hZ2VTaXplcyIsCiAgICAgICAgICAgIGltYWdlc3Jjc2V0OiAiaW1hZ2VTcmNTZXQiLAogICAgICAgICAgICBpbm5lcmh0bWw6ICJpbm5lckhUTUwiLAogICAgICAgICAgICBpbnB1dG1vZGU6ICJpbnB1dE1vZGUiLAogICAgICAgICAgICBpbnRlZ3JpdHk6ICJpbnRlZ3JpdHkiLAogICAgICAgICAgICBpczogImlzIiwKICAgICAgICAgICAgaXRlbWlkOiAiaXRlbUlEIiwKICAgICAgICAgICAgaXRlbXByb3A6ICJpdGVtUHJvcCIsCiAgICAgICAgICAgIGl0ZW1yZWY6ICJpdGVtUmVmIiwKICAgICAgICAgICAgaXRlbXNjb3BlOiAiaXRlbVNjb3BlIiwKICAgICAgICAgICAgaXRlbXR5cGU6ICJpdGVtVHlwZSIsCiAgICAgICAgICAgIGtleXBhcmFtczogImtleVBhcmFtcyIsCiAgICAgICAgICAgIGtleXR5cGU6ICJrZXlUeXBlIiwKICAgICAgICAgICAga2luZDogImtpbmQiLAogICAgICAgICAgICBsYWJlbDogImxhYmVsIiwKICAgICAgICAgICAgbGFuZzogImxhbmciLAogICAgICAgICAgICBsaXN0OiAibGlzdCIsCiAgICAgICAgICAgIGxvb3A6ICJsb29wIiwKICAgICAgICAgICAgbG93OiAibG93IiwKICAgICAgICAgICAgbWFuaWZlc3Q6ICJtYW5pZmVzdCIsCiAgICAgICAgICAgIG1hcmdpbndpZHRoOiAibWFyZ2luV2lkdGgiLAogICAgICAgICAgICBtYXJnaW5oZWlnaHQ6ICJtYXJnaW5IZWlnaHQiLAogICAgICAgICAgICBtYXg6ICJtYXgiLAogICAgICAgICAgICBtYXhsZW5ndGg6ICJtYXhMZW5ndGgiLAogICAgICAgICAgICBtZWRpYTogIm1lZGlhIiwKICAgICAgICAgICAgbWVkaWFncm91cDogIm1lZGlhR3JvdXAiLAogICAgICAgICAgICBtZXRob2Q6ICJtZXRob2QiLAogICAgICAgICAgICBtaW46ICJtaW4iLAogICAgICAgICAgICBtaW5sZW5ndGg6ICJtaW5MZW5ndGgiLAogICAgICAgICAgICBtdWx0aXBsZTogIm11bHRpcGxlIiwKICAgICAgICAgICAgbXV0ZWQ6ICJtdXRlZCIsCiAgICAgICAgICAgIG5hbWU6ICJuYW1lIiwKICAgICAgICAgICAgbm9tb2R1bGU6ICJub01vZHVsZSIsCiAgICAgICAgICAgIG5vbmNlOiAibm9uY2UiLAogICAgICAgICAgICBub3ZhbGlkYXRlOiAibm9WYWxpZGF0ZSIsCiAgICAgICAgICAgIG9wZW46ICJvcGVuIiwKICAgICAgICAgICAgb3B0aW11bTogIm9wdGltdW0iLAogICAgICAgICAgICBwYXR0ZXJuOiAicGF0dGVybiIsCiAgICAgICAgICAgIHBsYWNlaG9sZGVyOiAicGxhY2Vob2xkZXIiLAogICAgICAgICAgICBwbGF5c2lubGluZTogInBsYXlzSW5saW5lIiwKICAgICAgICAgICAgcG9zdGVyOiAicG9zdGVyIiwKICAgICAgICAgICAgcHJlbG9hZDogInByZWxvYWQiLAogICAgICAgICAgICBwcm9maWxlOiAicHJvZmlsZSIsCiAgICAgICAgICAgIHJhZGlvZ3JvdXA6ICJyYWRpb0dyb3VwIiwKICAgICAgICAgICAgcmVhZG9ubHk6ICJyZWFkT25seSIsCiAgICAgICAgICAgIHJlZmVycmVycG9saWN5OiAicmVmZXJyZXJQb2xpY3kiLAogICAgICAgICAgICByZWw6ICJyZWwiLAogICAgICAgICAgICByZXF1aXJlZDogInJlcXVpcmVkIiwKICAgICAgICAgICAgcmV2ZXJzZWQ6ICJyZXZlcnNlZCIsCiAgICAgICAgICAgIHJvbGU6ICJyb2xlIiwKICAgICAgICAgICAgcm93czogInJvd3MiLAogICAgICAgICAgICByb3dzcGFuOiAicm93U3BhbiIsCiAgICAgICAgICAgIHNhbmRib3g6ICJzYW5kYm94IiwKICAgICAgICAgICAgc2NvcGU6ICJzY29wZSIsCiAgICAgICAgICAgIHNjb3BlZDogInNjb3BlZCIsCiAgICAgICAgICAgIHNjcm9sbGluZzogInNjcm9sbGluZyIsCiAgICAgICAgICAgIHNlYW1sZXNzOiAic2VhbWxlc3MiLAogICAgICAgICAgICBzZWxlY3RlZDogInNlbGVjdGVkIiwKICAgICAgICAgICAgc2hhcGU6ICJzaGFwZSIsCiAgICAgICAgICAgIHNpemU6ICJzaXplIiwKICAgICAgICAgICAgc2l6ZXM6ICJzaXplcyIsCiAgICAgICAgICAgIHNwYW46ICJzcGFuIiwKICAgICAgICAgICAgc3BlbGxjaGVjazogInNwZWxsQ2hlY2siLAogICAgICAgICAgICBzcmM6ICJzcmMiLAogICAgICAgICAgICBzcmNkb2M6ICJzcmNEb2MiLAogICAgICAgICAgICBzcmNsYW5nOiAic3JjTGFuZyIsCiAgICAgICAgICAgIHNyY3NldDogInNyY1NldCIsCiAgICAgICAgICAgIHN0YXJ0OiAic3RhcnQiLAogICAgICAgICAgICBzdGVwOiAic3RlcCIsCiAgICAgICAgICAgIHN0eWxlOiAic3R5bGUiLAogICAgICAgICAgICBzdW1tYXJ5OiAic3VtbWFyeSIsCiAgICAgICAgICAgIHRhYmluZGV4OiAidGFiSW5kZXgiLAogICAgICAgICAgICB0YXJnZXQ6ICJ0YXJnZXQiLAogICAgICAgICAgICB0aXRsZTogInRpdGxlIiwKICAgICAgICAgICAgdHlwZTogInR5cGUiLAogICAgICAgICAgICB1c2VtYXA6ICJ1c2VNYXAiLAogICAgICAgICAgICB2YWx1ZTogInZhbHVlIiwKICAgICAgICAgICAgd2lkdGg6ICJ3aWR0aCIsCiAgICAgICAgICAgIHdtb2RlOiAid21vZGUiLAogICAgICAgICAgICB3cmFwOiAid3JhcCIsCiAgICAgICAgICAgIC8vIFNWRwogICAgICAgICAgICBhYm91dDogImFib3V0IiwKICAgICAgICAgICAgYWNjZW50aGVpZ2h0OiAiYWNjZW50SGVpZ2h0IiwKICAgICAgICAgICAgImFjY2VudC1oZWlnaHQiOiAiYWNjZW50SGVpZ2h0IiwKICAgICAgICAgICAgYWNjdW11bGF0ZTogImFjY3VtdWxhdGUiLAogICAgICAgICAgICBhZGRpdGl2ZTogImFkZGl0aXZlIiwKICAgICAgICAgICAgYWxpZ25tZW50YmFzZWxpbmU6ICJhbGlnbm1lbnRCYXNlbGluZSIsCiAgICAgICAgICAgICJhbGlnbm1lbnQtYmFzZWxpbmUiOiAiYWxpZ25tZW50QmFzZWxpbmUiLAogICAgICAgICAgICBhbGxvd3Jlb3JkZXI6ICJhbGxvd1Jlb3JkZXIiLAogICAgICAgICAgICBhbHBoYWJldGljOiAiYWxwaGFiZXRpYyIsCiAgICAgICAgICAgIGFtcGxpdHVkZTogImFtcGxpdHVkZSIsCiAgICAgICAgICAgIGFyYWJpY2Zvcm06ICJhcmFiaWNGb3JtIiwKICAgICAgICAgICAgImFyYWJpYy1mb3JtIjogImFyYWJpY0Zvcm0iLAogICAgICAgICAgICBhc2NlbnQ6ICJhc2NlbnQiLAogICAgICAgICAgICBhdHRyaWJ1dGVuYW1lOiAiYXR0cmlidXRlTmFtZSIsCiAgICAgICAgICAgIGF0dHJpYnV0ZXR5cGU6ICJhdHRyaWJ1dGVUeXBlIiwKICAgICAgICAgICAgYXV0b3JldmVyc2U6ICJhdXRvUmV2ZXJzZSIsCiAgICAgICAgICAgIGF6aW11dGg6ICJhemltdXRoIiwKICAgICAgICAgICAgYmFzZWZyZXF1ZW5jeTogImJhc2VGcmVxdWVuY3kiLAogICAgICAgICAgICBiYXNlbGluZXNoaWZ0OiAiYmFzZWxpbmVTaGlmdCIsCiAgICAgICAgICAgICJiYXNlbGluZS1zaGlmdCI6ICJiYXNlbGluZVNoaWZ0IiwKICAgICAgICAgICAgYmFzZXByb2ZpbGU6ICJiYXNlUHJvZmlsZSIsCiAgICAgICAgICAgIGJib3g6ICJiYm94IiwKICAgICAgICAgICAgYmVnaW46ICJiZWdpbiIsCiAgICAgICAgICAgIGJpYXM6ICJiaWFzIiwKICAgICAgICAgICAgYnk6ICJieSIsCiAgICAgICAgICAgIGNhbGNtb2RlOiAiY2FsY01vZGUiLAogICAgICAgICAgICBjYXBoZWlnaHQ6ICJjYXBIZWlnaHQiLAogICAgICAgICAgICAiY2FwLWhlaWdodCI6ICJjYXBIZWlnaHQiLAogICAgICAgICAgICBjbGlwOiAiY2xpcCIsCiAgICAgICAgICAgIGNsaXBwYXRoOiAiY2xpcFBhdGgiLAogICAgICAgICAgICAiY2xpcC1wYXRoIjogImNsaXBQYXRoIiwKICAgICAgICAgICAgY2xpcHBhdGh1bml0czogImNsaXBQYXRoVW5pdHMiLAogICAgICAgICAgICBjbGlwcnVsZTogImNsaXBSdWxlIiwKICAgICAgICAgICAgImNsaXAtcnVsZSI6ICJjbGlwUnVsZSIsCiAgICAgICAgICAgIGNvbG9yOiAiY29sb3IiLAogICAgICAgICAgICBjb2xvcmludGVycG9sYXRpb246ICJjb2xvckludGVycG9sYXRpb24iLAogICAgICAgICAgICAiY29sb3ItaW50ZXJwb2xhdGlvbiI6ICJjb2xvckludGVycG9sYXRpb24iLAogICAgICAgICAgICBjb2xvcmludGVycG9sYXRpb25maWx0ZXJzOiAiY29sb3JJbnRlcnBvbGF0aW9uRmlsdGVycyIsCiAgICAgICAgICAgICJjb2xvci1pbnRlcnBvbGF0aW9uLWZpbHRlcnMiOiAiY29sb3JJbnRlcnBvbGF0aW9uRmlsdGVycyIsCiAgICAgICAgICAgIGNvbG9ycHJvZmlsZTogImNvbG9yUHJvZmlsZSIsCiAgICAgICAgICAgICJjb2xvci1wcm9maWxlIjogImNvbG9yUHJvZmlsZSIsCiAgICAgICAgICAgIGNvbG9ycmVuZGVyaW5nOiAiY29sb3JSZW5kZXJpbmciLAogICAgICAgICAgICAiY29sb3ItcmVuZGVyaW5nIjogImNvbG9yUmVuZGVyaW5nIiwKICAgICAgICAgICAgY29udGVudHNjcmlwdHR5cGU6ICJjb250ZW50U2NyaXB0VHlwZSIsCiAgICAgICAgICAgIGNvbnRlbnRzdHlsZXR5cGU6ICJjb250ZW50U3R5bGVUeXBlIiwKICAgICAgICAgICAgY3Vyc29yOiAiY3Vyc29yIiwKICAgICAgICAgICAgY3g6ICJjeCIsCiAgICAgICAgICAgIGN5OiAiY3kiLAogICAgICAgICAgICBkOiAiZCIsCiAgICAgICAgICAgIGRhdGF0eXBlOiAiZGF0YXR5cGUiLAogICAgICAgICAgICBkZWNlbGVyYXRlOiAiZGVjZWxlcmF0ZSIsCiAgICAgICAgICAgIGRlc2NlbnQ6ICJkZXNjZW50IiwKICAgICAgICAgICAgZGlmZnVzZWNvbnN0YW50OiAiZGlmZnVzZUNvbnN0YW50IiwKICAgICAgICAgICAgZGlyZWN0aW9uOiAiZGlyZWN0aW9uIiwKICAgICAgICAgICAgZGlzcGxheTogImRpc3BsYXkiLAogICAgICAgICAgICBkaXZpc29yOiAiZGl2aXNvciIsCiAgICAgICAgICAgIGRvbWluYW50YmFzZWxpbmU6ICJkb21pbmFudEJhc2VsaW5lIiwKICAgICAgICAgICAgImRvbWluYW50LWJhc2VsaW5lIjogImRvbWluYW50QmFzZWxpbmUiLAogICAgICAgICAgICBkdXI6ICJkdXIiLAogICAgICAgICAgICBkeDogImR4IiwKICAgICAgICAgICAgZHk6ICJkeSIsCiAgICAgICAgICAgIGVkZ2Vtb2RlOiAiZWRnZU1vZGUiLAogICAgICAgICAgICBlbGV2YXRpb246ICJlbGV2YXRpb24iLAogICAgICAgICAgICBlbmFibGViYWNrZ3JvdW5kOiAiZW5hYmxlQmFja2dyb3VuZCIsCiAgICAgICAgICAgICJlbmFibGUtYmFja2dyb3VuZCI6ICJlbmFibGVCYWNrZ3JvdW5kIiwKICAgICAgICAgICAgZW5kOiAiZW5kIiwKICAgICAgICAgICAgZXhwb25lbnQ6ICJleHBvbmVudCIsCiAgICAgICAgICAgIGV4dGVybmFscmVzb3VyY2VzcmVxdWlyZWQ6ICJleHRlcm5hbFJlc291cmNlc1JlcXVpcmVkIiwKICAgICAgICAgICAgZmlsbDogImZpbGwiLAogICAgICAgICAgICBmaWxsb3BhY2l0eTogImZpbGxPcGFjaXR5IiwKICAgICAgICAgICAgImZpbGwtb3BhY2l0eSI6ICJmaWxsT3BhY2l0eSIsCiAgICAgICAgICAgIGZpbGxydWxlOiAiZmlsbFJ1bGUiLAogICAgICAgICAgICAiZmlsbC1ydWxlIjogImZpbGxSdWxlIiwKICAgICAgICAgICAgZmlsdGVyOiAiZmlsdGVyIiwKICAgICAgICAgICAgZmlsdGVycmVzOiAiZmlsdGVyUmVzIiwKICAgICAgICAgICAgZmlsdGVydW5pdHM6ICJmaWx0ZXJVbml0cyIsCiAgICAgICAgICAgIGZsb29kb3BhY2l0eTogImZsb29kT3BhY2l0eSIsCiAgICAgICAgICAgICJmbG9vZC1vcGFjaXR5IjogImZsb29kT3BhY2l0eSIsCiAgICAgICAgICAgIGZsb29kY29sb3I6ICJmbG9vZENvbG9yIiwKICAgICAgICAgICAgImZsb29kLWNvbG9yIjogImZsb29kQ29sb3IiLAogICAgICAgICAgICBmb2N1c2FibGU6ICJmb2N1c2FibGUiLAogICAgICAgICAgICBmb250ZmFtaWx5OiAiZm9udEZhbWlseSIsCiAgICAgICAgICAgICJmb250LWZhbWlseSI6ICJmb250RmFtaWx5IiwKICAgICAgICAgICAgZm9udHNpemU6ICJmb250U2l6ZSIsCiAgICAgICAgICAgICJmb250LXNpemUiOiAiZm9udFNpemUiLAogICAgICAgICAgICBmb250c2l6ZWFkanVzdDogImZvbnRTaXplQWRqdXN0IiwKICAgICAgICAgICAgImZvbnQtc2l6ZS1hZGp1c3QiOiAiZm9udFNpemVBZGp1c3QiLAogICAgICAgICAgICBmb250c3RyZXRjaDogImZvbnRTdHJldGNoIiwKICAgICAgICAgICAgImZvbnQtc3RyZXRjaCI6ICJmb250U3RyZXRjaCIsCiAgICAgICAgICAgIGZvbnRzdHlsZTogImZvbnRTdHlsZSIsCiAgICAgICAgICAgICJmb250LXN0eWxlIjogImZvbnRTdHlsZSIsCiAgICAgICAgICAgIGZvbnR2YXJpYW50OiAiZm9udFZhcmlhbnQiLAogICAgICAgICAgICAiZm9udC12YXJpYW50IjogImZvbnRWYXJpYW50IiwKICAgICAgICAgICAgZm9udHdlaWdodDogImZvbnRXZWlnaHQiLAogICAgICAgICAgICAiZm9udC13ZWlnaHQiOiAiZm9udFdlaWdodCIsCiAgICAgICAgICAgIGZvcm1hdDogImZvcm1hdCIsCiAgICAgICAgICAgIGZyb206ICJmcm9tIiwKICAgICAgICAgICAgZng6ICJmeCIsCiAgICAgICAgICAgIGZ5OiAiZnkiLAogICAgICAgICAgICBnMTogImcxIiwKICAgICAgICAgICAgZzI6ICJnMiIsCiAgICAgICAgICAgIGdseXBobmFtZTogImdseXBoTmFtZSIsCiAgICAgICAgICAgICJnbHlwaC1uYW1lIjogImdseXBoTmFtZSIsCiAgICAgICAgICAgIGdseXBob3JpZW50YXRpb25ob3Jpem9udGFsOiAiZ2x5cGhPcmllbnRhdGlvbkhvcml6b250YWwiLAogICAgICAgICAgICAiZ2x5cGgtb3JpZW50YXRpb24taG9yaXpvbnRhbCI6ICJnbHlwaE9yaWVudGF0aW9uSG9yaXpvbnRhbCIsCiAgICAgICAgICAgIGdseXBob3JpZW50YXRpb252ZXJ0aWNhbDogImdseXBoT3JpZW50YXRpb25WZXJ0aWNhbCIsCiAgICAgICAgICAgICJnbHlwaC1vcmllbnRhdGlvbi12ZXJ0aWNhbCI6ICJnbHlwaE9yaWVudGF0aW9uVmVydGljYWwiLAogICAgICAgICAgICBnbHlwaHJlZjogImdseXBoUmVmIiwKICAgICAgICAgICAgZ3JhZGllbnR0cmFuc2Zvcm06ICJncmFkaWVudFRyYW5zZm9ybSIsCiAgICAgICAgICAgIGdyYWRpZW50dW5pdHM6ICJncmFkaWVudFVuaXRzIiwKICAgICAgICAgICAgaGFuZ2luZzogImhhbmdpbmciLAogICAgICAgICAgICBob3JpemFkdng6ICJob3JpekFkdlgiLAogICAgICAgICAgICAiaG9yaXotYWR2LXgiOiAiaG9yaXpBZHZYIiwKICAgICAgICAgICAgaG9yaXpvcmlnaW54OiAiaG9yaXpPcmlnaW5YIiwKICAgICAgICAgICAgImhvcml6LW9yaWdpbi14IjogImhvcml6T3JpZ2luWCIsCiAgICAgICAgICAgIGlkZW9ncmFwaGljOiAiaWRlb2dyYXBoaWMiLAogICAgICAgICAgICBpbWFnZXJlbmRlcmluZzogImltYWdlUmVuZGVyaW5nIiwKICAgICAgICAgICAgImltYWdlLXJlbmRlcmluZyI6ICJpbWFnZVJlbmRlcmluZyIsCiAgICAgICAgICAgIGluMjogImluMiIsCiAgICAgICAgICAgIGluOiAiaW4iLAogICAgICAgICAgICBpbmxpc3Q6ICJpbmxpc3QiLAogICAgICAgICAgICBpbnRlcmNlcHQ6ICJpbnRlcmNlcHQiLAogICAgICAgICAgICBrMTogImsxIiwKICAgICAgICAgICAgazI6ICJrMiIsCiAgICAgICAgICAgIGszOiAiazMiLAogICAgICAgICAgICBrNDogIms0IiwKICAgICAgICAgICAgazogImsiLAogICAgICAgICAgICBrZXJuZWxtYXRyaXg6ICJrZXJuZWxNYXRyaXgiLAogICAgICAgICAgICBrZXJuZWx1bml0bGVuZ3RoOiAia2VybmVsVW5pdExlbmd0aCIsCiAgICAgICAgICAgIGtlcm5pbmc6ICJrZXJuaW5nIiwKICAgICAgICAgICAga2V5cG9pbnRzOiAia2V5UG9pbnRzIiwKICAgICAgICAgICAga2V5c3BsaW5lczogImtleVNwbGluZXMiLAogICAgICAgICAgICBrZXl0aW1lczogImtleVRpbWVzIiwKICAgICAgICAgICAgbGVuZ3RoYWRqdXN0OiAibGVuZ3RoQWRqdXN0IiwKICAgICAgICAgICAgbGV0dGVyc3BhY2luZzogImxldHRlclNwYWNpbmciLAogICAgICAgICAgICAibGV0dGVyLXNwYWNpbmciOiAibGV0dGVyU3BhY2luZyIsCiAgICAgICAgICAgIGxpZ2h0aW5nY29sb3I6ICJsaWdodGluZ0NvbG9yIiwKICAgICAgICAgICAgImxpZ2h0aW5nLWNvbG9yIjogImxpZ2h0aW5nQ29sb3IiLAogICAgICAgICAgICBsaW1pdGluZ2NvbmVhbmdsZTogImxpbWl0aW5nQ29uZUFuZ2xlIiwKICAgICAgICAgICAgbG9jYWw6ICJsb2NhbCIsCiAgICAgICAgICAgIG1hcmtlcmVuZDogIm1hcmtlckVuZCIsCiAgICAgICAgICAgICJtYXJrZXItZW5kIjogIm1hcmtlckVuZCIsCiAgICAgICAgICAgIG1hcmtlcmhlaWdodDogIm1hcmtlckhlaWdodCIsCiAgICAgICAgICAgIG1hcmtlcm1pZDogIm1hcmtlck1pZCIsCiAgICAgICAgICAgICJtYXJrZXItbWlkIjogIm1hcmtlck1pZCIsCiAgICAgICAgICAgIG1hcmtlcnN0YXJ0OiAibWFya2VyU3RhcnQiLAogICAgICAgICAgICAibWFya2VyLXN0YXJ0IjogIm1hcmtlclN0YXJ0IiwKICAgICAgICAgICAgbWFya2VydW5pdHM6ICJtYXJrZXJVbml0cyIsCiAgICAgICAgICAgIG1hcmtlcndpZHRoOiAibWFya2VyV2lkdGgiLAogICAgICAgICAgICBtYXNrOiAibWFzayIsCiAgICAgICAgICAgIG1hc2tjb250ZW50dW5pdHM6ICJtYXNrQ29udGVudFVuaXRzIiwKICAgICAgICAgICAgbWFza3VuaXRzOiAibWFza1VuaXRzIiwKICAgICAgICAgICAgbWF0aGVtYXRpY2FsOiAibWF0aGVtYXRpY2FsIiwKICAgICAgICAgICAgbW9kZTogIm1vZGUiLAogICAgICAgICAgICBudW1vY3RhdmVzOiAibnVtT2N0YXZlcyIsCiAgICAgICAgICAgIG9mZnNldDogIm9mZnNldCIsCiAgICAgICAgICAgIG9wYWNpdHk6ICJvcGFjaXR5IiwKICAgICAgICAgICAgb3BlcmF0b3I6ICJvcGVyYXRvciIsCiAgICAgICAgICAgIG9yZGVyOiAib3JkZXIiLAogICAgICAgICAgICBvcmllbnQ6ICJvcmllbnQiLAogICAgICAgICAgICBvcmllbnRhdGlvbjogIm9yaWVudGF0aW9uIiwKICAgICAgICAgICAgb3JpZ2luOiAib3JpZ2luIiwKICAgICAgICAgICAgb3ZlcmZsb3c6ICJvdmVyZmxvdyIsCiAgICAgICAgICAgIG92ZXJsaW5lcG9zaXRpb246ICJvdmVybGluZVBvc2l0aW9uIiwKICAgICAgICAgICAgIm92ZXJsaW5lLXBvc2l0aW9uIjogIm92ZXJsaW5lUG9zaXRpb24iLAogICAgICAgICAgICBvdmVybGluZXRoaWNrbmVzczogIm92ZXJsaW5lVGhpY2tuZXNzIiwKICAgICAgICAgICAgIm92ZXJsaW5lLXRoaWNrbmVzcyI6ICJvdmVybGluZVRoaWNrbmVzcyIsCiAgICAgICAgICAgIHBhaW50b3JkZXI6ICJwYWludE9yZGVyIiwKICAgICAgICAgICAgInBhaW50LW9yZGVyIjogInBhaW50T3JkZXIiLAogICAgICAgICAgICBwYW5vc2UxOiAicGFub3NlMSIsCiAgICAgICAgICAgICJwYW5vc2UtMSI6ICJwYW5vc2UxIiwKICAgICAgICAgICAgcGF0aGxlbmd0aDogInBhdGhMZW5ndGgiLAogICAgICAgICAgICBwYXR0ZXJuY29udGVudHVuaXRzOiAicGF0dGVybkNvbnRlbnRVbml0cyIsCiAgICAgICAgICAgIHBhdHRlcm50cmFuc2Zvcm06ICJwYXR0ZXJuVHJhbnNmb3JtIiwKICAgICAgICAgICAgcGF0dGVybnVuaXRzOiAicGF0dGVyblVuaXRzIiwKICAgICAgICAgICAgcG9pbnRlcmV2ZW50czogInBvaW50ZXJFdmVudHMiLAogICAgICAgICAgICAicG9pbnRlci1ldmVudHMiOiAicG9pbnRlckV2ZW50cyIsCiAgICAgICAgICAgIHBvaW50czogInBvaW50cyIsCiAgICAgICAgICAgIHBvaW50c2F0eDogInBvaW50c0F0WCIsCiAgICAgICAgICAgIHBvaW50c2F0eTogInBvaW50c0F0WSIsCiAgICAgICAgICAgIHBvaW50c2F0ejogInBvaW50c0F0WiIsCiAgICAgICAgICAgIHByZWZpeDogInByZWZpeCIsCiAgICAgICAgICAgIHByZXNlcnZlYWxwaGE6ICJwcmVzZXJ2ZUFscGhhIiwKICAgICAgICAgICAgcHJlc2VydmVhc3BlY3RyYXRpbzogInByZXNlcnZlQXNwZWN0UmF0aW8iLAogICAgICAgICAgICBwcmltaXRpdmV1bml0czogInByaW1pdGl2ZVVuaXRzIiwKICAgICAgICAgICAgcHJvcGVydHk6ICJwcm9wZXJ0eSIsCiAgICAgICAgICAgIHI6ICJyIiwKICAgICAgICAgICAgcmFkaXVzOiAicmFkaXVzIiwKICAgICAgICAgICAgcmVmeDogInJlZlgiLAogICAgICAgICAgICByZWZ5OiAicmVmWSIsCiAgICAgICAgICAgIHJlbmRlcmluZ2ludGVudDogInJlbmRlcmluZ0ludGVudCIsCiAgICAgICAgICAgICJyZW5kZXJpbmctaW50ZW50IjogInJlbmRlcmluZ0ludGVudCIsCiAgICAgICAgICAgIHJlcGVhdGNvdW50OiAicmVwZWF0Q291bnQiLAogICAgICAgICAgICByZXBlYXRkdXI6ICJyZXBlYXREdXIiLAogICAgICAgICAgICByZXF1aXJlZGV4dGVuc2lvbnM6ICJyZXF1aXJlZEV4dGVuc2lvbnMiLAogICAgICAgICAgICByZXF1aXJlZGZlYXR1cmVzOiAicmVxdWlyZWRGZWF0dXJlcyIsCiAgICAgICAgICAgIHJlc291cmNlOiAicmVzb3VyY2UiLAogICAgICAgICAgICByZXN0YXJ0OiAicmVzdGFydCIsCiAgICAgICAgICAgIHJlc3VsdDogInJlc3VsdCIsCiAgICAgICAgICAgIHJlc3VsdHM6ICJyZXN1bHRzIiwKICAgICAgICAgICAgcm90YXRlOiAicm90YXRlIiwKICAgICAgICAgICAgcng6ICJyeCIsCiAgICAgICAgICAgIHJ5OiAicnkiLAogICAgICAgICAgICBzY2FsZTogInNjYWxlIiwKICAgICAgICAgICAgc2VjdXJpdHk6ICJzZWN1cml0eSIsCiAgICAgICAgICAgIHNlZWQ6ICJzZWVkIiwKICAgICAgICAgICAgc2hhcGVyZW5kZXJpbmc6ICJzaGFwZVJlbmRlcmluZyIsCiAgICAgICAgICAgICJzaGFwZS1yZW5kZXJpbmciOiAic2hhcGVSZW5kZXJpbmciLAogICAgICAgICAgICBzbG9wZTogInNsb3BlIiwKICAgICAgICAgICAgc3BhY2luZzogInNwYWNpbmciLAogICAgICAgICAgICBzcGVjdWxhcmNvbnN0YW50OiAic3BlY3VsYXJDb25zdGFudCIsCiAgICAgICAgICAgIHNwZWN1bGFyZXhwb25lbnQ6ICJzcGVjdWxhckV4cG9uZW50IiwKICAgICAgICAgICAgc3BlZWQ6ICJzcGVlZCIsCiAgICAgICAgICAgIHNwcmVhZG1ldGhvZDogInNwcmVhZE1ldGhvZCIsCiAgICAgICAgICAgIHN0YXJ0b2Zmc2V0OiAic3RhcnRPZmZzZXQiLAogICAgICAgICAgICBzdGRkZXZpYXRpb246ICJzdGREZXZpYXRpb24iLAogICAgICAgICAgICBzdGVtaDogInN0ZW1oIiwKICAgICAgICAgICAgc3RlbXY6ICJzdGVtdiIsCiAgICAgICAgICAgIHN0aXRjaHRpbGVzOiAic3RpdGNoVGlsZXMiLAogICAgICAgICAgICBzdG9wY29sb3I6ICJzdG9wQ29sb3IiLAogICAgICAgICAgICAic3RvcC1jb2xvciI6ICJzdG9wQ29sb3IiLAogICAgICAgICAgICBzdG9wb3BhY2l0eTogInN0b3BPcGFjaXR5IiwKICAgICAgICAgICAgInN0b3Atb3BhY2l0eSI6ICJzdG9wT3BhY2l0eSIsCiAgICAgICAgICAgIHN0cmlrZXRocm91Z2hwb3NpdGlvbjogInN0cmlrZXRocm91Z2hQb3NpdGlvbiIsCiAgICAgICAgICAgICJzdHJpa2V0aHJvdWdoLXBvc2l0aW9uIjogInN0cmlrZXRocm91Z2hQb3NpdGlvbiIsCiAgICAgICAgICAgIHN0cmlrZXRocm91Z2h0aGlja25lc3M6ICJzdHJpa2V0aHJvdWdoVGhpY2tuZXNzIiwKICAgICAgICAgICAgInN0cmlrZXRocm91Z2gtdGhpY2tuZXNzIjogInN0cmlrZXRocm91Z2hUaGlja25lc3MiLAogICAgICAgICAgICBzdHJpbmc6ICJzdHJpbmciLAogICAgICAgICAgICBzdHJva2U6ICJzdHJva2UiLAogICAgICAgICAgICBzdHJva2VkYXNoYXJyYXk6ICJzdHJva2VEYXNoYXJyYXkiLAogICAgICAgICAgICAic3Ryb2tlLWRhc2hhcnJheSI6ICJzdHJva2VEYXNoYXJyYXkiLAogICAgICAgICAgICBzdHJva2VkYXNob2Zmc2V0OiAic3Ryb2tlRGFzaG9mZnNldCIsCiAgICAgICAgICAgICJzdHJva2UtZGFzaG9mZnNldCI6ICJzdHJva2VEYXNob2Zmc2V0IiwKICAgICAgICAgICAgc3Ryb2tlbGluZWNhcDogInN0cm9rZUxpbmVjYXAiLAogICAgICAgICAgICAic3Ryb2tlLWxpbmVjYXAiOiAic3Ryb2tlTGluZWNhcCIsCiAgICAgICAgICAgIHN0cm9rZWxpbmVqb2luOiAic3Ryb2tlTGluZWpvaW4iLAogICAgICAgICAgICAic3Ryb2tlLWxpbmVqb2luIjogInN0cm9rZUxpbmVqb2luIiwKICAgICAgICAgICAgc3Ryb2tlbWl0ZXJsaW1pdDogInN0cm9rZU1pdGVybGltaXQiLAogICAgICAgICAgICAic3Ryb2tlLW1pdGVybGltaXQiOiAic3Ryb2tlTWl0ZXJsaW1pdCIsCiAgICAgICAgICAgIHN0cm9rZXdpZHRoOiAic3Ryb2tlV2lkdGgiLAogICAgICAgICAgICAic3Ryb2tlLXdpZHRoIjogInN0cm9rZVdpZHRoIiwKICAgICAgICAgICAgc3Ryb2tlb3BhY2l0eTogInN0cm9rZU9wYWNpdHkiLAogICAgICAgICAgICAic3Ryb2tlLW9wYWNpdHkiOiAic3Ryb2tlT3BhY2l0eSIsCiAgICAgICAgICAgIHN1cHByZXNzY29udGVudGVkaXRhYmxld2FybmluZzogInN1cHByZXNzQ29udGVudEVkaXRhYmxlV2FybmluZyIsCiAgICAgICAgICAgIHN1cHByZXNzaHlkcmF0aW9ud2FybmluZzogInN1cHByZXNzSHlkcmF0aW9uV2FybmluZyIsCiAgICAgICAgICAgIHN1cmZhY2VzY2FsZTogInN1cmZhY2VTY2FsZSIsCiAgICAgICAgICAgIHN5c3RlbWxhbmd1YWdlOiAic3lzdGVtTGFuZ3VhZ2UiLAogICAgICAgICAgICB0YWJsZXZhbHVlczogInRhYmxlVmFsdWVzIiwKICAgICAgICAgICAgdGFyZ2V0eDogInRhcmdldFgiLAogICAgICAgICAgICB0YXJnZXR5OiAidGFyZ2V0WSIsCiAgICAgICAgICAgIHRleHRhbmNob3I6ICJ0ZXh0QW5jaG9yIiwKICAgICAgICAgICAgInRleHQtYW5jaG9yIjogInRleHRBbmNob3IiLAogICAgICAgICAgICB0ZXh0ZGVjb3JhdGlvbjogInRleHREZWNvcmF0aW9uIiwKICAgICAgICAgICAgInRleHQtZGVjb3JhdGlvbiI6ICJ0ZXh0RGVjb3JhdGlvbiIsCiAgICAgICAgICAgIHRleHRsZW5ndGg6ICJ0ZXh0TGVuZ3RoIiwKICAgICAgICAgICAgdGV4dHJlbmRlcmluZzogInRleHRSZW5kZXJpbmciLAogICAgICAgICAgICAidGV4dC1yZW5kZXJpbmciOiAidGV4dFJlbmRlcmluZyIsCiAgICAgICAgICAgIHRvOiAidG8iLAogICAgICAgICAgICB0cmFuc2Zvcm06ICJ0cmFuc2Zvcm0iLAogICAgICAgICAgICB0eXBlb2Y6ICJ0eXBlb2YiLAogICAgICAgICAgICB1MTogInUxIiwKICAgICAgICAgICAgdTI6ICJ1MiIsCiAgICAgICAgICAgIHVuZGVybGluZXBvc2l0aW9uOiAidW5kZXJsaW5lUG9zaXRpb24iLAogICAgICAgICAgICAidW5kZXJsaW5lLXBvc2l0aW9uIjogInVuZGVybGluZVBvc2l0aW9uIiwKICAgICAgICAgICAgdW5kZXJsaW5ldGhpY2tuZXNzOiAidW5kZXJsaW5lVGhpY2tuZXNzIiwKICAgICAgICAgICAgInVuZGVybGluZS10aGlja25lc3MiOiAidW5kZXJsaW5lVGhpY2tuZXNzIiwKICAgICAgICAgICAgdW5pY29kZTogInVuaWNvZGUiLAogICAgICAgICAgICB1bmljb2RlYmlkaTogInVuaWNvZGVCaWRpIiwKICAgICAgICAgICAgInVuaWNvZGUtYmlkaSI6ICJ1bmljb2RlQmlkaSIsCiAgICAgICAgICAgIHVuaWNvZGVyYW5nZTogInVuaWNvZGVSYW5nZSIsCiAgICAgICAgICAgICJ1bmljb2RlLXJhbmdlIjogInVuaWNvZGVSYW5nZSIsCiAgICAgICAgICAgIHVuaXRzcGVyZW06ICJ1bml0c1BlckVtIiwKICAgICAgICAgICAgInVuaXRzLXBlci1lbSI6ICJ1bml0c1BlckVtIiwKICAgICAgICAgICAgdW5zZWxlY3RhYmxlOiAidW5zZWxlY3RhYmxlIiwKICAgICAgICAgICAgdmFscGhhYmV0aWM6ICJ2QWxwaGFiZXRpYyIsCiAgICAgICAgICAgICJ2LWFscGhhYmV0aWMiOiAidkFscGhhYmV0aWMiLAogICAgICAgICAgICB2YWx1ZXM6ICJ2YWx1ZXMiLAogICAgICAgICAgICB2ZWN0b3JlZmZlY3Q6ICJ2ZWN0b3JFZmZlY3QiLAogICAgICAgICAgICAidmVjdG9yLWVmZmVjdCI6ICJ2ZWN0b3JFZmZlY3QiLAogICAgICAgICAgICB2ZXJzaW9uOiAidmVyc2lvbiIsCiAgICAgICAgICAgIHZlcnRhZHZ5OiAidmVydEFkdlkiLAogICAgICAgICAgICAidmVydC1hZHYteSI6ICJ2ZXJ0QWR2WSIsCiAgICAgICAgICAgIHZlcnRvcmlnaW54OiAidmVydE9yaWdpblgiLAogICAgICAgICAgICAidmVydC1vcmlnaW4teCI6ICJ2ZXJ0T3JpZ2luWCIsCiAgICAgICAgICAgIHZlcnRvcmlnaW55OiAidmVydE9yaWdpblkiLAogICAgICAgICAgICAidmVydC1vcmlnaW4teSI6ICJ2ZXJ0T3JpZ2luWSIsCiAgICAgICAgICAgIHZoYW5naW5nOiAidkhhbmdpbmciLAogICAgICAgICAgICAidi1oYW5naW5nIjogInZIYW5naW5nIiwKICAgICAgICAgICAgdmlkZW9ncmFwaGljOiAidklkZW9ncmFwaGljIiwKICAgICAgICAgICAgInYtaWRlb2dyYXBoaWMiOiAidklkZW9ncmFwaGljIiwKICAgICAgICAgICAgdmlld2JveDogInZpZXdCb3giLAogICAgICAgICAgICB2aWV3dGFyZ2V0OiAidmlld1RhcmdldCIsCiAgICAgICAgICAgIHZpc2liaWxpdHk6ICJ2aXNpYmlsaXR5IiwKICAgICAgICAgICAgdm1hdGhlbWF0aWNhbDogInZNYXRoZW1hdGljYWwiLAogICAgICAgICAgICAidi1tYXRoZW1hdGljYWwiOiAidk1hdGhlbWF0aWNhbCIsCiAgICAgICAgICAgIHZvY2FiOiAidm9jYWIiLAogICAgICAgICAgICB3aWR0aHM6ICJ3aWR0aHMiLAogICAgICAgICAgICB3b3Jkc3BhY2luZzogIndvcmRTcGFjaW5nIiwKICAgICAgICAgICAgIndvcmQtc3BhY2luZyI6ICJ3b3JkU3BhY2luZyIsCiAgICAgICAgICAgIHdyaXRpbmdtb2RlOiAid3JpdGluZ01vZGUiLAogICAgICAgICAgICAid3JpdGluZy1tb2RlIjogIndyaXRpbmdNb2RlIiwKICAgICAgICAgICAgeDE6ICJ4MSIsCiAgICAgICAgICAgIHgyOiAieDIiLAogICAgICAgICAgICB4OiAieCIsCiAgICAgICAgICAgIHhjaGFubmVsc2VsZWN0b3I6ICJ4Q2hhbm5lbFNlbGVjdG9yIiwKICAgICAgICAgICAgeGhlaWdodDogInhIZWlnaHQiLAogICAgICAgICAgICAieC1oZWlnaHQiOiAieEhlaWdodCIsCiAgICAgICAgICAgIHhsaW5rYWN0dWF0ZTogInhsaW5rQWN0dWF0ZSIsCiAgICAgICAgICAgICJ4bGluazphY3R1YXRlIjogInhsaW5rQWN0dWF0ZSIsCiAgICAgICAgICAgIHhsaW5rYXJjcm9sZTogInhsaW5rQXJjcm9sZSIsCiAgICAgICAgICAgICJ4bGluazphcmNyb2xlIjogInhsaW5rQXJjcm9sZSIsCiAgICAgICAgICAgIHhsaW5raHJlZjogInhsaW5rSHJlZiIsCiAgICAgICAgICAgICJ4bGluazpocmVmIjogInhsaW5rSHJlZiIsCiAgICAgICAgICAgIHhsaW5rcm9sZTogInhsaW5rUm9sZSIsCiAgICAgICAgICAgICJ4bGluazpyb2xlIjogInhsaW5rUm9sZSIsCiAgICAgICAgICAgIHhsaW5rc2hvdzogInhsaW5rU2hvdyIsCiAgICAgICAgICAgICJ4bGluazpzaG93IjogInhsaW5rU2hvdyIsCiAgICAgICAgICAgIHhsaW5rdGl0bGU6ICJ4bGlua1RpdGxlIiwKICAgICAgICAgICAgInhsaW5rOnRpdGxlIjogInhsaW5rVGl0bGUiLAogICAgICAgICAgICB4bGlua3R5cGU6ICJ4bGlua1R5cGUiLAogICAgICAgICAgICAieGxpbms6dHlwZSI6ICJ4bGlua1R5cGUiLAogICAgICAgICAgICB4bWxiYXNlOiAieG1sQmFzZSIsCiAgICAgICAgICAgICJ4bWw6YmFzZSI6ICJ4bWxCYXNlIiwKICAgICAgICAgICAgeG1sbGFuZzogInhtbExhbmciLAogICAgICAgICAgICAieG1sOmxhbmciOiAieG1sTGFuZyIsCiAgICAgICAgICAgIHhtbG5zOiAieG1sbnMiLAogICAgICAgICAgICAieG1sOnNwYWNlIjogInhtbFNwYWNlIiwKICAgICAgICAgICAgeG1sbnN4bGluazogInhtbG5zWGxpbmsiLAogICAgICAgICAgICAieG1sbnM6eGxpbmsiOiAieG1sbnNYbGluayIsCiAgICAgICAgICAgIHhtbHNwYWNlOiAieG1sU3BhY2UiLAogICAgICAgICAgICB5MTogInkxIiwKICAgICAgICAgICAgeTI6ICJ5MiIsCiAgICAgICAgICAgIHk6ICJ5IiwKICAgICAgICAgICAgeWNoYW5uZWxzZWxlY3RvcjogInlDaGFubmVsU2VsZWN0b3IiLAogICAgICAgICAgICB6OiAieiIsCiAgICAgICAgICAgIHpvb21hbmRwYW46ICJ6b29tQW5kUGFuIgogICAgICAgICAgfTsKICAgICAgICAgIHZhciBhcmlhUHJvcGVydGllcyA9IHsKICAgICAgICAgICAgImFyaWEtY3VycmVudCI6IDAsCiAgICAgICAgICAgIC8vIHN0YXRlCiAgICAgICAgICAgICJhcmlhLWRlc2NyaXB0aW9uIjogMCwKICAgICAgICAgICAgImFyaWEtZGV0YWlscyI6IDAsCiAgICAgICAgICAgICJhcmlhLWRpc2FibGVkIjogMCwKICAgICAgICAgICAgLy8gc3RhdGUKICAgICAgICAgICAgImFyaWEtaGlkZGVuIjogMCwKICAgICAgICAgICAgLy8gc3RhdGUKICAgICAgICAgICAgImFyaWEtaW52YWxpZCI6IDAsCiAgICAgICAgICAgIC8vIHN0YXRlCiAgICAgICAgICAgICJhcmlhLWtleXNob3J0Y3V0cyI6IDAsCiAgICAgICAgICAgICJhcmlhLWxhYmVsIjogMCwKICAgICAgICAgICAgImFyaWEtcm9sZWRlc2NyaXB0aW9uIjogMCwKICAgICAgICAgICAgLy8gV2lkZ2V0IEF0dHJpYnV0ZXMKICAgICAgICAgICAgImFyaWEtYXV0b2NvbXBsZXRlIjogMCwKICAgICAgICAgICAgImFyaWEtY2hlY2tlZCI6IDAsCiAgICAgICAgICAgICJhcmlhLWV4cGFuZGVkIjogMCwKICAgICAgICAgICAgImFyaWEtaGFzcG9wdXAiOiAwLAogICAgICAgICAgICAiYXJpYS1sZXZlbCI6IDAsCiAgICAgICAgICAgICJhcmlhLW1vZGFsIjogMCwKICAgICAgICAgICAgImFyaWEtbXVsdGlsaW5lIjogMCwKICAgICAgICAgICAgImFyaWEtbXVsdGlzZWxlY3RhYmxlIjogMCwKICAgICAgICAgICAgImFyaWEtb3JpZW50YXRpb24iOiAwLAogICAgICAgICAgICAiYXJpYS1wbGFjZWhvbGRlciI6IDAsCiAgICAgICAgICAgICJhcmlhLXByZXNzZWQiOiAwLAogICAgICAgICAgICAiYXJpYS1yZWFkb25seSI6IDAsCiAgICAgICAgICAgICJhcmlhLXJlcXVpcmVkIjogMCwKICAgICAgICAgICAgImFyaWEtc2VsZWN0ZWQiOiAwLAogICAgICAgICAgICAiYXJpYS1zb3J0IjogMCwKICAgICAgICAgICAgImFyaWEtdmFsdWVtYXgiOiAwLAogICAgICAgICAgICAiYXJpYS12YWx1ZW1pbiI6IDAsCiAgICAgICAgICAgICJhcmlhLXZhbHVlbm93IjogMCwKICAgICAgICAgICAgImFyaWEtdmFsdWV0ZXh0IjogMCwKICAgICAgICAgICAgLy8gTGl2ZSBSZWdpb24gQXR0cmlidXRlcwogICAgICAgICAgICAiYXJpYS1hdG9taWMiOiAwLAogICAgICAgICAgICAiYXJpYS1idXN5IjogMCwKICAgICAgICAgICAgImFyaWEtbGl2ZSI6IDAsCiAgICAgICAgICAgICJhcmlhLXJlbGV2YW50IjogMCwKICAgICAgICAgICAgLy8gRHJhZy1hbmQtRHJvcCBBdHRyaWJ1dGVzCiAgICAgICAgICAgICJhcmlhLWRyb3BlZmZlY3QiOiAwLAogICAgICAgICAgICAiYXJpYS1ncmFiYmVkIjogMCwKICAgICAgICAgICAgLy8gUmVsYXRpb25zaGlwIEF0dHJpYnV0ZXMKICAgICAgICAgICAgImFyaWEtYWN0aXZlZGVzY2VuZGFudCI6IDAsCiAgICAgICAgICAgICJhcmlhLWNvbGNvdW50IjogMCwKICAgICAgICAgICAgImFyaWEtY29saW5kZXgiOiAwLAogICAgICAgICAgICAiYXJpYS1jb2xzcGFuIjogMCwKICAgICAgICAgICAgImFyaWEtY29udHJvbHMiOiAwLAogICAgICAgICAgICAiYXJpYS1kZXNjcmliZWRieSI6IDAsCiAgICAgICAgICAgICJhcmlhLWVycm9ybWVzc2FnZSI6IDAsCiAgICAgICAgICAgICJhcmlhLWZsb3d0byI6IDAsCiAgICAgICAgICAgICJhcmlhLWxhYmVsbGVkYnkiOiAwLAogICAgICAgICAgICAiYXJpYS1vd25zIjogMCwKICAgICAgICAgICAgImFyaWEtcG9zaW5zZXQiOiAwLAogICAgICAgICAgICAiYXJpYS1yb3djb3VudCI6IDAsCiAgICAgICAgICAgICJhcmlhLXJvd2luZGV4IjogMCwKICAgICAgICAgICAgImFyaWEtcm93c3BhbiI6IDAsCiAgICAgICAgICAgICJhcmlhLXNldHNpemUiOiAwCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHdhcm5lZFByb3BlcnRpZXMgPSB7fTsKICAgICAgICAgIHZhciByQVJJQSA9IG5ldyBSZWdFeHAoIl4oYXJpYSktWyIgKyBBVFRSSUJVVEVfTkFNRV9DSEFSICsgIl0qJCIpOwogICAgICAgICAgdmFyIHJBUklBQ2FtZWwgPSBuZXcgUmVnRXhwKCJeKGFyaWEpW0EtWl1bIiArIEFUVFJJQlVURV9OQU1FX0NIQVIgKyAiXSokIik7CiAgICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVByb3BlcnR5KHRhZ05hbWUsIG5hbWUpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHdhcm5lZFByb3BlcnRpZXMsIG5hbWUpICYmIHdhcm5lZFByb3BlcnRpZXNbbmFtZV0pIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAockFSSUFDYW1lbC50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJpYU5hbWUgPSAiYXJpYS0iICsgbmFtZS5zbGljZSg0KS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgdmFyIGNvcnJlY3ROYW1lID0gYXJpYVByb3BlcnRpZXMuaGFzT3duUHJvcGVydHkoYXJpYU5hbWUpID8gYXJpYU5hbWUgOiBudWxsOwogICAgICAgICAgICAgICAgaWYgKGNvcnJlY3ROYW1lID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgQVJJQSBhdHRyaWJ1dGUgYCVzYC4gQVJJQSBhdHRyaWJ1dGVzIGZvbGxvdyB0aGUgcGF0dGVybiBhcmlhLSogYW5kIG11c3QgYmUgbG93ZXJjYXNlLiIsIG5hbWUpOwogICAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAobmFtZSAhPT0gY29ycmVjdE5hbWUpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgQVJJQSBhdHRyaWJ1dGUgYCVzYC4gRGlkIHlvdSBtZWFuIGAlc2A/IiwgbmFtZSwgY29ycmVjdE5hbWUpOwogICAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChyQVJJQS50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgICB2YXIgbG93ZXJDYXNlZE5hbWUgPSBuYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICB2YXIgc3RhbmRhcmROYW1lID0gYXJpYVByb3BlcnRpZXMuaGFzT3duUHJvcGVydHkobG93ZXJDYXNlZE5hbWUpID8gbG93ZXJDYXNlZE5hbWUgOiBudWxsOwogICAgICAgICAgICAgICAgaWYgKHN0YW5kYXJkTmFtZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAobmFtZSAhPT0gc3RhbmRhcmROYW1lKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJVbmtub3duIEFSSUEgYXR0cmlidXRlIGAlc2AuIERpZCB5b3UgbWVhbiBgJXNgPyIsIG5hbWUsIHN0YW5kYXJkTmFtZSk7CiAgICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB3YXJuSW52YWxpZEFSSUFQcm9wcyh0eXBlMiwgcHJvcHMpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBpbnZhbGlkUHJvcHMgPSBbXTsKICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gcHJvcHMpIHsKICAgICAgICAgICAgICAgIHZhciBpc1ZhbGlkID0gdmFsaWRhdGVQcm9wZXJ0eSh0eXBlMiwga2V5KTsKICAgICAgICAgICAgICAgIGlmICghaXNWYWxpZCkgewogICAgICAgICAgICAgICAgICBpbnZhbGlkUHJvcHMucHVzaChrZXkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgdW5rbm93blByb3BTdHJpbmcgPSBpbnZhbGlkUHJvcHMubWFwKGZ1bmN0aW9uKHByb3ApIHsKICAgICAgICAgICAgICAgIHJldHVybiAiYCIgKyBwcm9wICsgImAiOwogICAgICAgICAgICAgIH0pLmpvaW4oIiwgIik7CiAgICAgICAgICAgICAgaWYgKGludmFsaWRQcm9wcy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGFyaWEgcHJvcCAlcyBvbiA8JXM+IHRhZy4gRm9yIGRldGFpbHMsIHNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaW52YWxpZC1hcmlhLXByb3BzIiwgdW5rbm93blByb3BTdHJpbmcsIHR5cGUyKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGludmFsaWRQcm9wcy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBhcmlhIHByb3BzICVzIG9uIDwlcz4gdGFnLiBGb3IgZGV0YWlscywgc2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9pbnZhbGlkLWFyaWEtcHJvcHMiLCB1bmtub3duUHJvcFN0cmluZywgdHlwZTIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wZXJ0aWVzKHR5cGUyLCBwcm9wcykgewogICAgICAgICAgICBpZiAoaXNDdXN0b21Db21wb25lbnQodHlwZTIsIHByb3BzKSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuSW52YWxpZEFSSUFQcm9wcyh0eXBlMiwgcHJvcHMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRpZFdhcm5WYWx1ZU51bGwgPSBmYWxzZTsKICAgICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcGVydGllcyQxKHR5cGUyLCBwcm9wcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGUyICE9PSAiaW5wdXQiICYmIHR5cGUyICE9PSAidGV4dGFyZWEiICYmIHR5cGUyICE9PSAic2VsZWN0IikgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocHJvcHMgIT0gbnVsbCAmJiBwcm9wcy52YWx1ZSA9PT0gbnVsbCAmJiAhZGlkV2FyblZhbHVlTnVsbCkgewogICAgICAgICAgICAgICAgZGlkV2FyblZhbHVlTnVsbCA9IHRydWU7CiAgICAgICAgICAgICAgICBpZiAodHlwZTIgPT09ICJzZWxlY3QiICYmIHByb3BzLm11bHRpcGxlKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJgdmFsdWVgIHByb3Agb24gYCVzYCBzaG91bGQgbm90IGJlIG51bGwuIENvbnNpZGVyIHVzaW5nIGFuIGVtcHR5IGFycmF5IHdoZW4gYG11bHRpcGxlYCBpcyBzZXQgdG8gYHRydWVgIHRvIGNsZWFyIHRoZSBjb21wb25lbnQgb3IgYHVuZGVmaW5lZGAgZm9yIHVuY29udHJvbGxlZCBjb21wb25lbnRzLiIsIHR5cGUyKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJgdmFsdWVgIHByb3Agb24gYCVzYCBzaG91bGQgbm90IGJlIG51bGwuIENvbnNpZGVyIHVzaW5nIGFuIGVtcHR5IHN0cmluZyB0byBjbGVhciB0aGUgY29tcG9uZW50IG9yIGB1bmRlZmluZWRgIGZvciB1bmNvbnRyb2xsZWQgY29tcG9uZW50cy4iLCB0eXBlMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdmFsaWRhdGVQcm9wZXJ0eSQxID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICB2YXIgd2FybmVkUHJvcGVydGllcyQxID0ge307CiAgICAgICAgICAgIHZhciBFVkVOVF9OQU1FX1JFR0VYID0gL15vbi4vOwogICAgICAgICAgICB2YXIgSU5WQUxJRF9FVkVOVF9OQU1FX1JFR0VYID0gL15vblteQS1aXS87CiAgICAgICAgICAgIHZhciByQVJJQSQxID0gbmV3IFJlZ0V4cCgiXihhcmlhKS1bIiArIEFUVFJJQlVURV9OQU1FX0NIQVIgKyAiXSokIik7CiAgICAgICAgICAgIHZhciByQVJJQUNhbWVsJDEgPSBuZXcgUmVnRXhwKCJeKGFyaWEpW0EtWl1bIiArIEFUVFJJQlVURV9OQU1FX0NIQVIgKyAiXSokIik7CiAgICAgICAgICAgIHZhbGlkYXRlUHJvcGVydHkkMSA9IGZ1bmN0aW9uKHRhZ05hbWUsIG5hbWUsIHZhbHVlLCBldmVudFJlZ2lzdHJ5KSB7CiAgICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwod2FybmVkUHJvcGVydGllcyQxLCBuYW1lKSAmJiB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0pIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgbG93ZXJDYXNlZE5hbWUgPSBuYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgaWYgKGxvd2VyQ2FzZWROYW1lID09PSAib25mb2N1c2luIiB8fCBsb3dlckNhc2VkTmFtZSA9PT0gIm9uZm9jdXNvdXQiKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgdXNlcyBvbkZvY3VzIGFuZCBvbkJsdXIgaW5zdGVhZCBvZiBvbkZvY3VzSW4gYW5kIG9uRm9jdXNPdXQuIEFsbCBSZWFjdCBldmVudHMgYXJlIG5vcm1hbGl6ZWQgdG8gYnViYmxlLCBzbyBvbkZvY3VzSW4gYW5kIG9uRm9jdXNPdXQgYXJlIG5vdCBuZWVkZWQvc3VwcG9ydGVkIGJ5IFJlYWN0LiIpOwogICAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZXZlbnRSZWdpc3RyeSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llczIgPSBldmVudFJlZ2lzdHJ5LnJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMsIHBvc3NpYmxlUmVnaXN0cmF0aW9uTmFtZXMyID0gZXZlbnRSZWdpc3RyeS5wb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzOwogICAgICAgICAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMyLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbk5hbWUgPSBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzMi5oYXNPd25Qcm9wZXJ0eShsb3dlckNhc2VkTmFtZSkgPyBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzMltsb3dlckNhc2VkTmFtZV0gOiBudWxsOwogICAgICAgICAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbk5hbWUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBldmVudCBoYW5kbGVyIHByb3BlcnR5IGAlc2AuIERpZCB5b3UgbWVhbiBgJXNgPyIsIG5hbWUsIHJlZ2lzdHJhdGlvbk5hbWUpOwogICAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChFVkVOVF9OQU1FX1JFR0VYLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlVua25vd24gZXZlbnQgaGFuZGxlciBwcm9wZXJ0eSBgJXNgLiBJdCB3aWxsIGJlIGlnbm9yZWQuIiwgbmFtZSk7CiAgICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoRVZFTlRfTkFNRV9SRUdFWC50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgICBpZiAoSU5WQUxJRF9FVkVOVF9OQU1FX1JFR0VYLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgZXZlbnQgaGFuZGxlciBwcm9wZXJ0eSBgJXNgLiBSZWFjdCBldmVudHMgdXNlIHRoZSBjYW1lbENhc2UgbmFtaW5nIGNvbnZlbnRpb24sIGZvciBleGFtcGxlIGBvbkNsaWNrYC4iLCBuYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHJBUklBJDEudGVzdChuYW1lKSB8fCByQVJJQUNhbWVsJDEudGVzdChuYW1lKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChsb3dlckNhc2VkTmFtZSA9PT0gImlubmVyaHRtbCIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJEaXJlY3RseSBzZXR0aW5nIHByb3BlcnR5IGBpbm5lckhUTUxgIGlzIG5vdCBwZXJtaXR0ZWQuIEZvciBtb3JlIGluZm9ybWF0aW9uLCBsb29rdXAgZG9jdW1lbnRhdGlvbiBvbiBgZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUxgLiIpOwogICAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobG93ZXJDYXNlZE5hbWUgPT09ICJhcmlhIikgewogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSBgYXJpYWAgYXR0cmlidXRlIGlzIHJlc2VydmVkIGZvciBmdXR1cmUgdXNlIGluIFJlYWN0LiBQYXNzIGluZGl2aWR1YWwgYGFyaWEtYCBhdHRyaWJ1dGVzIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChsb3dlckNhc2VkTmFtZSA9PT0gImlzIiAmJiB2YWx1ZSAhPT0gbnVsbCAmJiB2YWx1ZSAhPT0gdm9pZCAwICYmIHR5cGVvZiB2YWx1ZSAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJSZWNlaXZlZCBhIGAlc2AgZm9yIGEgc3RyaW5nIGF0dHJpYnV0ZSBgaXNgLiBJZiB0aGlzIGlzIGV4cGVjdGVkLCBjYXN0IHRoZSB2YWx1ZSB0byBhIHN0cmluZy4iLCB0eXBlb2YgdmFsdWUpOwogICAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAibnVtYmVyIiAmJiBpc05hTih2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJSZWNlaXZlZCBOYU4gZm9yIHRoZSBgJXNgIGF0dHJpYnV0ZS4gSWYgdGhpcyBpcyBleHBlY3RlZCwgY2FzdCB0aGUgdmFsdWUgdG8gYSBzdHJpbmcuIiwgbmFtZSk7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBwcm9wZXJ0eUluZm8gPSBnZXRQcm9wZXJ0eUluZm8obmFtZSk7CiAgICAgICAgICAgICAgdmFyIGlzUmVzZXJ2ZWQgPSBwcm9wZXJ0eUluZm8gIT09IG51bGwgJiYgcHJvcGVydHlJbmZvLnR5cGUgPT09IFJFU0VSVkVEOwogICAgICAgICAgICAgIGlmIChwb3NzaWJsZVN0YW5kYXJkTmFtZXMuaGFzT3duUHJvcGVydHkobG93ZXJDYXNlZE5hbWUpKSB7CiAgICAgICAgICAgICAgICB2YXIgc3RhbmRhcmROYW1lID0gcG9zc2libGVTdGFuZGFyZE5hbWVzW2xvd2VyQ2FzZWROYW1lXTsKICAgICAgICAgICAgICAgIGlmIChzdGFuZGFyZE5hbWUgIT09IG5hbWUpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgRE9NIHByb3BlcnR5IGAlc2AuIERpZCB5b3UgbWVhbiBgJXNgPyIsIG5hbWUsIHN0YW5kYXJkTmFtZSk7CiAgICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWlzUmVzZXJ2ZWQgJiYgbmFtZSAhPT0gbG93ZXJDYXNlZE5hbWUpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBkb2VzIG5vdCByZWNvZ25pemUgdGhlIGAlc2AgcHJvcCBvbiBhIERPTSBlbGVtZW50LiBJZiB5b3UgaW50ZW50aW9uYWxseSB3YW50IGl0IHRvIGFwcGVhciBpbiB0aGUgRE9NIGFzIGEgY3VzdG9tIGF0dHJpYnV0ZSwgc3BlbGwgaXQgYXMgbG93ZXJjYXNlIGAlc2AgaW5zdGVhZC4gSWYgeW91IGFjY2lkZW50YWxseSBwYXNzZWQgaXQgZnJvbSBhIHBhcmVudCBjb21wb25lbnQsIHJlbW92ZSBpdCBmcm9tIHRoZSBET00gZWxlbWVudC4iLCBuYW1lLCBsb3dlckNhc2VkTmFtZSk7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJib29sZWFuIiAmJiBzaG91bGRSZW1vdmVBdHRyaWJ1dGVXaXRoV2FybmluZyhuYW1lLCB2YWx1ZSwgcHJvcGVydHlJbmZvLCBmYWxzZSkpIHsKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICBlcnJvcignUmVjZWl2ZWQgYCVzYCBmb3IgYSBub24tYm9vbGVhbiBhdHRyaWJ1dGUgYCVzYC5cblxuSWYgeW91IHdhbnQgdG8gd3JpdGUgaXQgdG8gdGhlIERPTSwgcGFzcyBhIHN0cmluZyBpbnN0ZWFkOiAlcz0iJXMiIG9yICVzPXt2YWx1ZS50b1N0cmluZygpfS4nLCB2YWx1ZSwgbmFtZSwgbmFtZSwgdmFsdWUsIG5hbWUpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoJ1JlY2VpdmVkIGAlc2AgZm9yIGEgbm9uLWJvb2xlYW4gYXR0cmlidXRlIGAlc2AuXG5cbklmIHlvdSB3YW50IHRvIHdyaXRlIGl0IHRvIHRoZSBET00sIHBhc3MgYSBzdHJpbmcgaW5zdGVhZDogJXM9IiVzIiBvciAlcz17dmFsdWUudG9TdHJpbmcoKX0uXG5cbklmIHlvdSB1c2VkIHRvIGNvbmRpdGlvbmFsbHkgb21pdCBpdCB3aXRoICVzPXtjb25kaXRpb24gJiYgdmFsdWV9LCBwYXNzICVzPXtjb25kaXRpb24gPyB2YWx1ZSA6IHVuZGVmaW5lZH0gaW5zdGVhZC4nLCB2YWx1ZSwgbmFtZSwgbmFtZSwgdmFsdWUsIG5hbWUsIG5hbWUsIG5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaXNSZXNlcnZlZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChzaG91bGRSZW1vdmVBdHRyaWJ1dGVXaXRoV2FybmluZyhuYW1lLCB2YWx1ZSwgcHJvcGVydHlJbmZvLCBmYWxzZSkpIHsKICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgodmFsdWUgPT09ICJmYWxzZSIgfHwgdmFsdWUgPT09ICJ0cnVlIikgJiYgcHJvcGVydHlJbmZvICE9PSBudWxsICYmIHByb3BlcnR5SW5mby50eXBlID09PSBCT09MRUFOKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiUmVjZWl2ZWQgdGhlIHN0cmluZyBgJXNgIGZvciB0aGUgYm9vbGVhbiBhdHRyaWJ1dGUgYCVzYC4gJXMgRGlkIHlvdSBtZWFuICVzPXslc30/IiwgdmFsdWUsIG5hbWUsIHZhbHVlID09PSAiZmFsc2UiID8gIlRoZSBicm93c2VyIHdpbGwgaW50ZXJwcmV0IGl0IGFzIGEgdHJ1dGh5IHZhbHVlLiIgOiAnQWx0aG91Z2ggdGhpcyB3b3JrcywgaXQgd2lsbCBub3Qgd29yayBhcyBleHBlY3RlZCBpZiB5b3UgcGFzcyB0aGUgc3RyaW5nICJmYWxzZSIuJywgbmFtZSwgdmFsdWUpOwogICAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB3YXJuVW5rbm93blByb3BlcnRpZXMgPSBmdW5jdGlvbih0eXBlMiwgcHJvcHMsIGV2ZW50UmVnaXN0cnkpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciB1bmtub3duUHJvcHMgPSBbXTsKICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gcHJvcHMpIHsKICAgICAgICAgICAgICAgIHZhciBpc1ZhbGlkID0gdmFsaWRhdGVQcm9wZXJ0eSQxKHR5cGUyLCBrZXksIHByb3BzW2tleV0sIGV2ZW50UmVnaXN0cnkpOwogICAgICAgICAgICAgICAgaWYgKCFpc1ZhbGlkKSB7CiAgICAgICAgICAgICAgICAgIHVua25vd25Qcm9wcy5wdXNoKGtleSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciB1bmtub3duUHJvcFN0cmluZyA9IHVua25vd25Qcm9wcy5tYXAoZnVuY3Rpb24ocHJvcCkgewogICAgICAgICAgICAgICAgcmV0dXJuICJgIiArIHByb3AgKyAiYCI7CiAgICAgICAgICAgICAgfSkuam9pbigiLCAiKTsKICAgICAgICAgICAgICBpZiAodW5rbm93blByb3BzLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgdmFsdWUgZm9yIHByb3AgJXMgb24gPCVzPiB0YWcuIEVpdGhlciByZW1vdmUgaXQgZnJvbSB0aGUgZWxlbWVudCwgb3IgcGFzcyBhIHN0cmluZyBvciBudW1iZXIgdmFsdWUgdG8ga2VlcCBpdCBpbiB0aGUgRE9NLiBGb3IgZGV0YWlscywgc2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9hdHRyaWJ1dGUtYmVoYXZpb3IgIiwgdW5rbm93blByb3BTdHJpbmcsIHR5cGUyKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHVua25vd25Qcm9wcy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCB2YWx1ZXMgZm9yIHByb3BzICVzIG9uIDwlcz4gdGFnLiBFaXRoZXIgcmVtb3ZlIHRoZW0gZnJvbSB0aGUgZWxlbWVudCwgb3IgcGFzcyBhIHN0cmluZyBvciBudW1iZXIgdmFsdWUgdG8ga2VlcCB0aGVtIGluIHRoZSBET00uIEZvciBkZXRhaWxzLCBzZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2F0dHJpYnV0ZS1iZWhhdmlvciAiLCB1bmtub3duUHJvcFN0cmluZywgdHlwZTIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcGVydGllcyQyKHR5cGUyLCBwcm9wcywgZXZlbnRSZWdpc3RyeSkgewogICAgICAgICAgICBpZiAoaXNDdXN0b21Db21wb25lbnQodHlwZTIsIHByb3BzKSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuVW5rbm93blByb3BlcnRpZXModHlwZTIsIHByb3BzLCBldmVudFJlZ2lzdHJ5KTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBJU19FVkVOVF9IQU5ETEVfTk9OX01BTkFHRURfTk9ERSA9IDE7CiAgICAgICAgICB2YXIgSVNfTk9OX0RFTEVHQVRFRCA9IDEgPDwgMTsKICAgICAgICAgIHZhciBJU19DQVBUVVJFX1BIQVNFID0gMSA8PCAyOwogICAgICAgICAgdmFyIFNIT1VMRF9OT1RfUFJPQ0VTU19QT0xZRklMTF9FVkVOVF9QTFVHSU5TID0gSVNfRVZFTlRfSEFORExFX05PTl9NQU5BR0VEX05PREUgfCBJU19OT05fREVMRUdBVEVEIHwgSVNfQ0FQVFVSRV9QSEFTRTsKICAgICAgICAgIHZhciBjdXJyZW50UmVwbGF5aW5nRXZlbnQgPSBudWxsOwogICAgICAgICAgZnVuY3Rpb24gc2V0UmVwbGF5aW5nRXZlbnQoZXZlbnQpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChjdXJyZW50UmVwbGF5aW5nRXZlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCBjdXJyZW50bHkgcmVwbGF5aW5nIGV2ZW50IHRvIGJlIG51bGwuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGN1cnJlbnRSZXBsYXlpbmdFdmVudCA9IGV2ZW50OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVzZXRSZXBsYXlpbmdFdmVudCgpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChjdXJyZW50UmVwbGF5aW5nRXZlbnQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCBjdXJyZW50bHkgcmVwbGF5aW5nIGV2ZW50IHRvIG5vdCBiZSBudWxsLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjdXJyZW50UmVwbGF5aW5nRXZlbnQgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaXNSZXBsYXlpbmdFdmVudChldmVudCkgewogICAgICAgICAgICByZXR1cm4gZXZlbnQgPT09IGN1cnJlbnRSZXBsYXlpbmdFdmVudDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldEV2ZW50VGFyZ2V0KG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICAgIHZhciB0YXJnZXQgPSBuYXRpdmVFdmVudC50YXJnZXQgfHwgbmF0aXZlRXZlbnQuc3JjRWxlbWVudCB8fCB3aW5kb3c7CiAgICAgICAgICAgIGlmICh0YXJnZXQuY29ycmVzcG9uZGluZ1VzZUVsZW1lbnQpIHsKICAgICAgICAgICAgICB0YXJnZXQgPSB0YXJnZXQuY29ycmVzcG9uZGluZ1VzZUVsZW1lbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRhcmdldC5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFID8gdGFyZ2V0LnBhcmVudE5vZGUgOiB0YXJnZXQ7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcmVzdG9yZUltcGwgPSBudWxsOwogICAgICAgICAgdmFyIHJlc3RvcmVUYXJnZXQgPSBudWxsOwogICAgICAgICAgdmFyIHJlc3RvcmVRdWV1ZSA9IG51bGw7CiAgICAgICAgICBmdW5jdGlvbiByZXN0b3JlU3RhdGVPZlRhcmdldCh0YXJnZXQpIHsKICAgICAgICAgICAgdmFyIGludGVybmFsSW5zdGFuY2UgPSBnZXRJbnN0YW5jZUZyb21Ob2RlKHRhcmdldCk7CiAgICAgICAgICAgIGlmICghaW50ZXJuYWxJbnN0YW5jZSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHJlc3RvcmVJbXBsICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJzZXRSZXN0b3JlSW1wbGVtZW50YXRpb24oKSBuZWVkcyB0byBiZSBjYWxsZWQgdG8gaGFuZGxlIGEgdGFyZ2V0IGZvciBjb250cm9sbGVkIGV2ZW50cy4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gaW50ZXJuYWxJbnN0YW5jZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmIChzdGF0ZU5vZGUpIHsKICAgICAgICAgICAgICB2YXIgX3Byb3BzID0gZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZShzdGF0ZU5vZGUpOwogICAgICAgICAgICAgIHJlc3RvcmVJbXBsKGludGVybmFsSW5zdGFuY2Uuc3RhdGVOb2RlLCBpbnRlcm5hbEluc3RhbmNlLnR5cGUsIF9wcm9wcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHNldFJlc3RvcmVJbXBsZW1lbnRhdGlvbihpbXBsKSB7CiAgICAgICAgICAgIHJlc3RvcmVJbXBsID0gaW1wbDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGVucXVldWVTdGF0ZVJlc3RvcmUodGFyZ2V0KSB7CiAgICAgICAgICAgIGlmIChyZXN0b3JlVGFyZ2V0KSB7CiAgICAgICAgICAgICAgaWYgKHJlc3RvcmVRdWV1ZSkgewogICAgICAgICAgICAgICAgcmVzdG9yZVF1ZXVlLnB1c2godGFyZ2V0KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVzdG9yZVF1ZXVlID0gW3RhcmdldF07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc3RvcmVUYXJnZXQgPSB0YXJnZXQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG5lZWRzU3RhdGVSZXN0b3JlKCkgewogICAgICAgICAgICByZXR1cm4gcmVzdG9yZVRhcmdldCAhPT0gbnVsbCB8fCByZXN0b3JlUXVldWUgIT09IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZXN0b3JlU3RhdGVJZk5lZWRlZCgpIHsKICAgICAgICAgICAgaWYgKCFyZXN0b3JlVGFyZ2V0KSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0YXJnZXQgPSByZXN0b3JlVGFyZ2V0OwogICAgICAgICAgICB2YXIgcXVldWVkVGFyZ2V0cyA9IHJlc3RvcmVRdWV1ZTsKICAgICAgICAgICAgcmVzdG9yZVRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIHJlc3RvcmVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgIHJlc3RvcmVTdGF0ZU9mVGFyZ2V0KHRhcmdldCk7CiAgICAgICAgICAgIGlmIChxdWV1ZWRUYXJnZXRzKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBxdWV1ZWRUYXJnZXRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICByZXN0b3JlU3RhdGVPZlRhcmdldChxdWV1ZWRUYXJnZXRzW2ldKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBiYXRjaGVkVXBkYXRlc0ltcGwgPSBmdW5jdGlvbihmbiwgYm9va2tlZXBpbmcpIHsKICAgICAgICAgICAgcmV0dXJuIGZuKGJvb2trZWVwaW5nKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZmx1c2hTeW5jSW1wbCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgfTsKICAgICAgICAgIHZhciBpc0luc2lkZUV2ZW50SGFuZGxlciA9IGZhbHNlOwogICAgICAgICAgZnVuY3Rpb24gZmluaXNoRXZlbnRIYW5kbGVyKCkgewogICAgICAgICAgICB2YXIgY29udHJvbGxlZENvbXBvbmVudHNIYXZlUGVuZGluZ1VwZGF0ZXMgPSBuZWVkc1N0YXRlUmVzdG9yZSgpOwogICAgICAgICAgICBpZiAoY29udHJvbGxlZENvbXBvbmVudHNIYXZlUGVuZGluZ1VwZGF0ZXMpIHsKICAgICAgICAgICAgICBmbHVzaFN5bmNJbXBsKCk7CiAgICAgICAgICAgICAgcmVzdG9yZVN0YXRlSWZOZWVkZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gYmF0Y2hlZFVwZGF0ZXMoZm4sIGEyLCBiKSB7CiAgICAgICAgICAgIGlmIChpc0luc2lkZUV2ZW50SGFuZGxlcikgewogICAgICAgICAgICAgIHJldHVybiBmbihhMiwgYik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaXNJbnNpZGVFdmVudEhhbmRsZXIgPSB0cnVlOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHJldHVybiBiYXRjaGVkVXBkYXRlc0ltcGwoZm4sIGEyLCBiKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBpc0luc2lkZUV2ZW50SGFuZGxlciA9IGZhbHNlOwogICAgICAgICAgICAgIGZpbmlzaEV2ZW50SGFuZGxlcigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzZXRCYXRjaGluZ0ltcGxlbWVudGF0aW9uKF9iYXRjaGVkVXBkYXRlc0ltcGwsIF9kaXNjcmV0ZVVwZGF0ZXNJbXBsLCBfZmx1c2hTeW5jSW1wbCkgewogICAgICAgICAgICBiYXRjaGVkVXBkYXRlc0ltcGwgPSBfYmF0Y2hlZFVwZGF0ZXNJbXBsOwogICAgICAgICAgICBmbHVzaFN5bmNJbXBsID0gX2ZsdXNoU3luY0ltcGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpc0ludGVyYWN0aXZlKHRhZykgewogICAgICAgICAgICByZXR1cm4gdGFnID09PSAiYnV0dG9uIiB8fCB0YWcgPT09ICJpbnB1dCIgfHwgdGFnID09PSAic2VsZWN0IiB8fCB0YWcgPT09ICJ0ZXh0YXJlYSI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzaG91bGRQcmV2ZW50TW91c2VFdmVudChuYW1lLCB0eXBlMiwgcHJvcHMpIHsKICAgICAgICAgICAgc3dpdGNoIChuYW1lKSB7CiAgICAgICAgICAgICAgY2FzZSAib25DbGljayI6CiAgICAgICAgICAgICAgY2FzZSAib25DbGlja0NhcHR1cmUiOgogICAgICAgICAgICAgIGNhc2UgIm9uRG91YmxlQ2xpY2siOgogICAgICAgICAgICAgIGNhc2UgIm9uRG91YmxlQ2xpY2tDYXB0dXJlIjoKICAgICAgICAgICAgICBjYXNlICJvbk1vdXNlRG93biI6CiAgICAgICAgICAgICAgY2FzZSAib25Nb3VzZURvd25DYXB0dXJlIjoKICAgICAgICAgICAgICBjYXNlICJvbk1vdXNlTW92ZSI6CiAgICAgICAgICAgICAgY2FzZSAib25Nb3VzZU1vdmVDYXB0dXJlIjoKICAgICAgICAgICAgICBjYXNlICJvbk1vdXNlVXAiOgogICAgICAgICAgICAgIGNhc2UgIm9uTW91c2VVcENhcHR1cmUiOgogICAgICAgICAgICAgIGNhc2UgIm9uTW91c2VFbnRlciI6CiAgICAgICAgICAgICAgICByZXR1cm4gISEocHJvcHMuZGlzYWJsZWQgJiYgaXNJbnRlcmFjdGl2ZSh0eXBlMikpOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldExpc3RlbmVyKGluc3QsIHJlZ2lzdHJhdGlvbk5hbWUpIHsKICAgICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IGluc3Quc3RhdGVOb2RlOwogICAgICAgICAgICBpZiAoc3RhdGVOb2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByb3BzID0gZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZShzdGF0ZU5vZGUpOwogICAgICAgICAgICBpZiAocHJvcHMgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbGlzdGVuZXIgPSBwcm9wc1tyZWdpc3RyYXRpb25OYW1lXTsKICAgICAgICAgICAgaWYgKHNob3VsZFByZXZlbnRNb3VzZUV2ZW50KHJlZ2lzdHJhdGlvbk5hbWUsIGluc3QudHlwZSwgcHJvcHMpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxpc3RlbmVyICYmIHR5cGVvZiBsaXN0ZW5lciAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgYCIgKyByZWdpc3RyYXRpb25OYW1lICsgImAgbGlzdGVuZXIgdG8gYmUgYSBmdW5jdGlvbiwgaW5zdGVhZCBnb3QgYSB2YWx1ZSBvZiBgIiArIHR5cGVvZiBsaXN0ZW5lciArICJgIHR5cGUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxpc3RlbmVyOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHBhc3NpdmVCcm93c2VyRXZlbnRzU3VwcG9ydGVkID0gZmFsc2U7CiAgICAgICAgICBpZiAoY2FuVXNlRE9NKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSB7fTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob3B0aW9ucywgInBhc3NpdmUiLCB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBwYXNzaXZlQnJvd3NlckV2ZW50c1N1cHBvcnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInRlc3QiLCBvcHRpb25zLCBvcHRpb25zKTsKICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigidGVzdCIsIG9wdGlvbnMsIG9wdGlvbnMpOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgcGFzc2l2ZUJyb3dzZXJFdmVudHNTdXBwb3J0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaW52b2tlR3VhcmRlZENhbGxiYWNrUHJvZChuYW1lLCBmdW5jLCBjb250ZXh0LCBhMiwgYiwgYzIsIGQsIGUsIGYpIHsKICAgICAgICAgICAgdmFyIGZ1bmNBcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAzKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBmdW5jLmFwcGx5KGNvbnRleHQsIGZ1bmNBcmdzKTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgdGhpcy5vbkVycm9yKGVycm9yMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnZva2VHdWFyZGVkQ2FsbGJhY2tJbXBsID0gaW52b2tlR3VhcmRlZENhbGxiYWNrUHJvZDsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiB3aW5kb3cuZGlzcGF0Y2hFdmVudCA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgZG9jdW1lbnQgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBkb2N1bWVudC5jcmVhdGVFdmVudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBmYWtlTm9kZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInJlYWN0Iik7CiAgICAgICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrSW1wbCA9IGZ1bmN0aW9uIGludm9rZUd1YXJkZWRDYWxsYmFja0RldihuYW1lLCBmdW5jLCBjb250ZXh0LCBhMiwgYiwgYzIsIGQsIGUsIGYpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZG9jdW1lbnQgPT09ICJ1bmRlZmluZWQiIHx8IGRvY3VtZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlIGBkb2N1bWVudGAgZ2xvYmFsIHdhcyBkZWZpbmVkIHdoZW4gUmVhY3Qgd2FzIGluaXRpYWxpemVkLCBidXQgaXMgbm90IGRlZmluZWQgYW55bW9yZS4gVGhpcyBjYW4gaGFwcGVuIGluIGEgdGVzdCBlbnZpcm9ubWVudCBpZiBhIGNvbXBvbmVudCBzY2hlZHVsZXMgYW4gdXBkYXRlIGZyb20gYW4gYXN5bmNocm9ub3VzIGNhbGxiYWNrLCBidXQgdGhlIHRlc3QgaGFzIGFscmVhZHkgZmluaXNoZWQgcnVubmluZy4gVG8gc29sdmUgdGhpcywgeW91IGNhbiBlaXRoZXIgdW5tb3VudCB0aGUgY29tcG9uZW50IGF0IHRoZSBlbmQgb2YgeW91ciB0ZXN0IChhbmQgZW5zdXJlIHRoYXQgYW55IGFzeW5jaHJvbm91cyBvcGVyYXRpb25zIGdldCBjYW5jZWxlZCBpbiBgY29tcG9uZW50V2lsbFVubW91bnRgKSwgb3IgeW91IGNhbiBjaGFuZ2UgdGhlIHRlc3QgaXRzZWxmIHRvIGJlIGFzeW5jaHJvbm91cy4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBldnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgiRXZlbnQiKTsKICAgICAgICAgICAgICAgIHZhciBkaWRDYWxsID0gZmFsc2U7CiAgICAgICAgICAgICAgICB2YXIgZGlkRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgdmFyIHdpbmRvd0V2ZW50ID0gd2luZG93LmV2ZW50OwogICAgICAgICAgICAgICAgdmFyIHdpbmRvd0V2ZW50RGVzY3JpcHRvciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iod2luZG93LCAiZXZlbnQiKTsKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVBZnRlckRpc3BhdGNoKCkgewogICAgICAgICAgICAgICAgICBmYWtlTm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKGV2dFR5cGUsIGNhbGxDYWxsYmFjazIsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB3aW5kb3cuZXZlbnQgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5oYXNPd25Qcm9wZXJ0eSgiZXZlbnQiKSkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5ldmVudCA9IHdpbmRvd0V2ZW50OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgZnVuY0FyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDMpOwogICAgICAgICAgICAgICAgZnVuY3Rpb24gY2FsbENhbGxiYWNrMigpIHsKICAgICAgICAgICAgICAgICAgZGlkQ2FsbCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIHJlc3RvcmVBZnRlckRpc3BhdGNoKCk7CiAgICAgICAgICAgICAgICAgIGZ1bmMuYXBwbHkoY29udGV4dCwgZnVuY0FyZ3MpOwogICAgICAgICAgICAgICAgICBkaWRFcnJvciA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGVycm9yMjsKICAgICAgICAgICAgICAgIHZhciBkaWRTZXRFcnJvciA9IGZhbHNlOwogICAgICAgICAgICAgICAgdmFyIGlzQ3Jvc3NPcmlnaW5FcnJvciA9IGZhbHNlOwogICAgICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlV2luZG93RXJyb3IoZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IyID0gZXZlbnQuZXJyb3I7CiAgICAgICAgICAgICAgICAgIGRpZFNldEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgaWYgKGVycm9yMiA9PT0gbnVsbCAmJiBldmVudC5jb2xubyA9PT0gMCAmJiBldmVudC5saW5lbm8gPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBpc0Nyb3NzT3JpZ2luRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChldmVudC5kZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yMiAhPSBudWxsICYmIHR5cGVvZiBlcnJvcjIgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjIuX3N1cHByZXNzTG9nZ2luZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChpbm5lcikgewogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGV2dFR5cGUgPSAicmVhY3QtIiArIChuYW1lID8gbmFtZSA6ICJpbnZva2VndWFyZGVkY2FsbGJhY2siKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJlcnJvciIsIGhhbmRsZVdpbmRvd0Vycm9yKTsKICAgICAgICAgICAgICAgIGZha2VOb2RlLmFkZEV2ZW50TGlzdGVuZXIoZXZ0VHlwZSwgY2FsbENhbGxiYWNrMiwgZmFsc2UpOwogICAgICAgICAgICAgICAgZXZ0LmluaXRFdmVudChldnRUeXBlLCBmYWxzZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgZmFrZU5vZGUuZGlzcGF0Y2hFdmVudChldnQpOwogICAgICAgICAgICAgICAgaWYgKHdpbmRvd0V2ZW50RGVzY3JpcHRvcikgewogICAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkod2luZG93LCAiZXZlbnQiLCB3aW5kb3dFdmVudERlc2NyaXB0b3IpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGRpZENhbGwgJiYgZGlkRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFkaWRTZXRFcnJvcikgewogICAgICAgICAgICAgICAgICAgIGVycm9yMiA9IG5ldyBFcnJvcihgQW4gZXJyb3Igd2FzIHRocm93biBpbnNpZGUgb25lIG9mIHlvdXIgY29tcG9uZW50cywgYnV0IFJlYWN0IGRvZXNuJ3Qga25vdyB3aGF0IGl0IHdhcy4gVGhpcyBpcyBsaWtlbHkgZHVlIHRvIGJyb3dzZXIgZmxha2luZXNzLiBSZWFjdCBkb2VzIGl0cyBiZXN0IHRvIHByZXNlcnZlIHRoZSAiUGF1c2Ugb24gZXhjZXB0aW9ucyIgYmVoYXZpb3Igb2YgdGhlIERldlRvb2xzLCB3aGljaCByZXF1aXJlcyBzb21lIERFVi1tb2RlIG9ubHkgdHJpY2tzLiBJdCdzIHBvc3NpYmxlIHRoYXQgdGhlc2UgZG9uJ3Qgd29yayBpbiB5b3VyIGJyb3dzZXIuIFRyeSB0cmlnZ2VyaW5nIHRoZSBlcnJvciBpbiBwcm9kdWN0aW9uIG1vZGUsIG9yIHN3aXRjaGluZyB0byBhIG1vZGVybiBicm93c2VyLiBJZiB5b3Ugc3VzcGVjdCB0aGF0IHRoaXMgaXMgYWN0dWFsbHkgYW4gaXNzdWUgd2l0aCBSZWFjdCwgcGxlYXNlIGZpbGUgYW4gaXNzdWUuYCk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNDcm9zc09yaWdpbkVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IyID0gbmV3IEVycm9yKCJBIGNyb3NzLW9yaWdpbiBlcnJvciB3YXMgdGhyb3duLiBSZWFjdCBkb2Vzbid0IGhhdmUgYWNjZXNzIHRvIHRoZSBhY3R1YWwgZXJyb3Igb2JqZWN0IGluIGRldmVsb3BtZW50LiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2Nyb3Nzb3JpZ2luLWVycm9yIGZvciBtb3JlIGluZm9ybWF0aW9uLiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHRoaXMub25FcnJvcihlcnJvcjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoImVycm9yIiwgaGFuZGxlV2luZG93RXJyb3IpOwogICAgICAgICAgICAgICAgaWYgKCFkaWRDYWxsKSB7CiAgICAgICAgICAgICAgICAgIHJlc3RvcmVBZnRlckRpc3BhdGNoKCk7CiAgICAgICAgICAgICAgICAgIHJldHVybiBpbnZva2VHdWFyZGVkQ2FsbGJhY2tQcm9kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGludm9rZUd1YXJkZWRDYWxsYmFja0ltcGwkMSA9IGludm9rZUd1YXJkZWRDYWxsYmFja0ltcGw7CiAgICAgICAgICB2YXIgaGFzRXJyb3IgPSBmYWxzZTsKICAgICAgICAgIHZhciBjYXVnaHRFcnJvciA9IG51bGw7CiAgICAgICAgICB2YXIgaGFzUmV0aHJvd0Vycm9yID0gZmFsc2U7CiAgICAgICAgICB2YXIgcmV0aHJvd0Vycm9yID0gbnVsbDsKICAgICAgICAgIHZhciByZXBvcnRlciA9IHsKICAgICAgICAgICAgb25FcnJvcjogZnVuY3Rpb24oZXJyb3IyKSB7CiAgICAgICAgICAgICAgaGFzRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgIGNhdWdodEVycm9yID0gZXJyb3IyOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgZnVuY3Rpb24gaW52b2tlR3VhcmRlZENhbGxiYWNrKG5hbWUsIGZ1bmMsIGNvbnRleHQsIGEyLCBiLCBjMiwgZCwgZSwgZikgewogICAgICAgICAgICBoYXNFcnJvciA9IGZhbHNlOwogICAgICAgICAgICBjYXVnaHRFcnJvciA9IG51bGw7CiAgICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFja0ltcGwkMS5hcHBseShyZXBvcnRlciwgYXJndW1lbnRzKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGludm9rZUd1YXJkZWRDYWxsYmFja0FuZENhdGNoRmlyc3RFcnJvcihuYW1lLCBmdW5jLCBjb250ZXh0LCBhMiwgYiwgYzIsIGQsIGUsIGYpIHsKICAgICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIGlmIChoYXNFcnJvcikgewogICAgICAgICAgICAgIHZhciBlcnJvcjIgPSBjbGVhckNhdWdodEVycm9yKCk7CiAgICAgICAgICAgICAgaWYgKCFoYXNSZXRocm93RXJyb3IpIHsKICAgICAgICAgICAgICAgIGhhc1JldGhyb3dFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICByZXRocm93RXJyb3IgPSBlcnJvcjI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZXRocm93Q2F1Z2h0RXJyb3IoKSB7CiAgICAgICAgICAgIGlmIChoYXNSZXRocm93RXJyb3IpIHsKICAgICAgICAgICAgICB2YXIgZXJyb3IyID0gcmV0aHJvd0Vycm9yOwogICAgICAgICAgICAgIGhhc1JldGhyb3dFcnJvciA9IGZhbHNlOwogICAgICAgICAgICAgIHJldGhyb3dFcnJvciA9IG51bGw7CiAgICAgICAgICAgICAgdGhyb3cgZXJyb3IyOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBoYXNDYXVnaHRFcnJvcigpIHsKICAgICAgICAgICAgcmV0dXJuIGhhc0Vycm9yOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY2xlYXJDYXVnaHRFcnJvcigpIHsKICAgICAgICAgICAgaWYgKGhhc0Vycm9yKSB7CiAgICAgICAgICAgICAgdmFyIGVycm9yMiA9IGNhdWdodEVycm9yOwogICAgICAgICAgICAgIGhhc0Vycm9yID0gZmFsc2U7CiAgICAgICAgICAgICAgY2F1Z2h0RXJyb3IgPSBudWxsOwogICAgICAgICAgICAgIHJldHVybiBlcnJvcjI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJjbGVhckNhdWdodEVycm9yIHdhcyBjYWxsZWQgYnV0IG5vIGVycm9yIHdhcyBjYXB0dXJlZC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0MyhrZXkpIHsKICAgICAgICAgICAgcmV0dXJuIGtleS5fcmVhY3RJbnRlcm5hbHM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBoYXMoa2V5KSB7CiAgICAgICAgICAgIHJldHVybiBrZXkuX3JlYWN0SW50ZXJuYWxzICE9PSB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzZXQzKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAga2V5Ll9yZWFjdEludGVybmFscyA9IHZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIE5vRmxhZ3MgPSAoCiAgICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgIDAKICAgICAgICAgICk7CiAgICAgICAgICB2YXIgUGVyZm9ybWVkV29yayA9ICgKICAgICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgMQogICAgICAgICAgKTsKICAgICAgICAgIHZhciBQbGFjZW1lbnQgPSAoCiAgICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAyCiAgICAgICAgICApOwogICAgICAgICAgdmFyIFVwZGF0ZSA9ICgKICAgICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgIDQKICAgICAgICAgICk7CiAgICAgICAgICB2YXIgQ2hpbGREZWxldGlvbiA9ICgKICAgICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgMTYKICAgICAgICAgICk7CiAgICAgICAgICB2YXIgQ29udGVudFJlc2V0ID0gKAogICAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgMzIKICAgICAgICAgICk7CiAgICAgICAgICB2YXIgQ2FsbGJhY2sgPSAoCiAgICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgNjQKICAgICAgICAgICk7CiAgICAgICAgICB2YXIgRGlkQ2FwdHVyZSA9ICgKICAgICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgMTI4CiAgICAgICAgICApOwogICAgICAgICAgdmFyIEZvcmNlQ2xpZW50UmVuZGVyID0gKAogICAgICAgICAgICAvKiAgICAgICAgICAgICovCiAgICAgICAgICAgIDI1NgogICAgICAgICAgKTsKICAgICAgICAgIHZhciBSZWYgPSAoCiAgICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICA1MTIKICAgICAgICAgICk7CiAgICAgICAgICB2YXIgU25hcHNob3QgPSAoCiAgICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgMTAyNAogICAgICAgICAgKTsKICAgICAgICAgIHZhciBQYXNzaXZlID0gKAogICAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAyMDQ4CiAgICAgICAgICApOwogICAgICAgICAgdmFyIEh5ZHJhdGluZyA9ICgKICAgICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgIDQwOTYKICAgICAgICAgICk7CiAgICAgICAgICB2YXIgVmlzaWJpbGl0eSA9ICgKICAgICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgODE5MgogICAgICAgICAgKTsKICAgICAgICAgIHZhciBTdG9yZUNvbnNpc3RlbmN5ID0gKAogICAgICAgICAgICAvKiAgICAgICAgICAgICAqLwogICAgICAgICAgICAxNjM4NAogICAgICAgICAgKTsKICAgICAgICAgIHZhciBMaWZlY3ljbGVFZmZlY3RNYXNrID0gUGFzc2l2ZSB8IFVwZGF0ZSB8IENhbGxiYWNrIHwgUmVmIHwgU25hcHNob3QgfCBTdG9yZUNvbnNpc3RlbmN5OwogICAgICAgICAgdmFyIEhvc3RFZmZlY3RNYXNrID0gKAogICAgICAgICAgICAvKiAgICAgICAgICAgICAgICovCiAgICAgICAgICAgIDMyNzY3CiAgICAgICAgICApOwogICAgICAgICAgdmFyIEluY29tcGxldGUgPSAoCiAgICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgIDMyNzY4CiAgICAgICAgICApOwogICAgICAgICAgdmFyIFNob3VsZENhcHR1cmUgPSAoCiAgICAgICAgICAgIC8qICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgIDY1NTM2CiAgICAgICAgICApOwogICAgICAgICAgdmFyIEZvcmNlVXBkYXRlRm9yTGVnYWN5U3VzcGVuc2UgPSAoCiAgICAgICAgICAgIC8qICovCiAgICAgICAgICAgIDEzMTA3MgogICAgICAgICAgKTsKICAgICAgICAgIHZhciBGb3JrZWQgPSAoCiAgICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAxMDQ4NTc2CiAgICAgICAgICApOwogICAgICAgICAgdmFyIFJlZlN0YXRpYyA9ICgKICAgICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgIDIwOTcxNTIKICAgICAgICAgICk7CiAgICAgICAgICB2YXIgTGF5b3V0U3RhdGljID0gKAogICAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgNDE5NDMwNAogICAgICAgICAgKTsKICAgICAgICAgIHZhciBQYXNzaXZlU3RhdGljID0gKAogICAgICAgICAgICAvKiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICA4Mzg4NjA4CiAgICAgICAgICApOwogICAgICAgICAgdmFyIE1vdW50TGF5b3V0RGV2ID0gKAogICAgICAgICAgICAvKiAgICAgICAgICAgICAgICovCiAgICAgICAgICAgIDE2Nzc3MjE2CiAgICAgICAgICApOwogICAgICAgICAgdmFyIE1vdW50UGFzc2l2ZURldiA9ICgKICAgICAgICAgICAgLyogICAgICAgICAgICAgICovCiAgICAgICAgICAgIDMzNTU0NDMyCiAgICAgICAgICApOwogICAgICAgICAgdmFyIEJlZm9yZU11dGF0aW9uTWFzayA9ICgKICAgICAgICAgICAgLy8gVE9ETzogUmVtb3ZlIFVwZGF0ZSBmbGFnIGZyb20gYmVmb3JlIG11dGF0aW9uIHBoYXNlIGJ5IHJlLWxhbmRpbmcgVmlzaWJpbGl0eQogICAgICAgICAgICAvLyBmbGFnIGxvZ2ljIChzZWUgIzIwMDQzKQogICAgICAgICAgICBVcGRhdGUgfCBTbmFwc2hvdCB8IDAKICAgICAgICAgICk7CiAgICAgICAgICB2YXIgTXV0YXRpb25NYXNrID0gUGxhY2VtZW50IHwgVXBkYXRlIHwgQ2hpbGREZWxldGlvbiB8IENvbnRlbnRSZXNldCB8IFJlZiB8IEh5ZHJhdGluZyB8IFZpc2liaWxpdHk7CiAgICAgICAgICB2YXIgTGF5b3V0TWFzayA9IFVwZGF0ZSB8IENhbGxiYWNrIHwgUmVmIHwgVmlzaWJpbGl0eTsKICAgICAgICAgIHZhciBQYXNzaXZlTWFzayA9IFBhc3NpdmUgfCBDaGlsZERlbGV0aW9uOwogICAgICAgICAgdmFyIFN0YXRpY01hc2sgPSBMYXlvdXRTdGF0aWMgfCBQYXNzaXZlU3RhdGljIHwgUmVmU3RhdGljOwogICAgICAgICAgdmFyIFJlYWN0Q3VycmVudE93bmVyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50T3duZXI7CiAgICAgICAgICBmdW5jdGlvbiBnZXROZWFyZXN0TW91bnRlZEZpYmVyKGZpYmVyKSB7CiAgICAgICAgICAgIHZhciBub2RlID0gZmliZXI7CiAgICAgICAgICAgIHZhciBuZWFyZXN0TW91bnRlZCA9IGZpYmVyOwogICAgICAgICAgICBpZiAoIWZpYmVyLmFsdGVybmF0ZSkgewogICAgICAgICAgICAgIHZhciBuZXh0Tm9kZSA9IG5vZGU7CiAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgbm9kZSA9IG5leHROb2RlOwogICAgICAgICAgICAgICAgaWYgKChub2RlLmZsYWdzICYgKFBsYWNlbWVudCB8IEh5ZHJhdGluZykpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICAgIG5lYXJlc3RNb3VudGVkID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBuZXh0Tm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgIH0gd2hpbGUgKG5leHROb2RlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB3aGlsZSAobm9kZS5yZXR1cm4pIHsKICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICAgIHJldHVybiBuZWFyZXN0TW91bnRlZDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldFN1c3BlbnNlSW5zdGFuY2VGcm9tRmliZXIoZmliZXIpIHsKICAgICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlU3RhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBjdXJyZW50MiA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBzdXNwZW5zZVN0YXRlID0gY3VycmVudDIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlU3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0Q29udGFpbmVyRnJvbUZpYmVyKGZpYmVyKSB7CiAgICAgICAgICAgIHJldHVybiBmaWJlci50YWcgPT09IEhvc3RSb290ID8gZmliZXIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8gOiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaXNGaWJlck1vdW50ZWQoZmliZXIpIHsKICAgICAgICAgICAgcmV0dXJuIGdldE5lYXJlc3RNb3VudGVkRmliZXIoZmliZXIpID09PSBmaWJlcjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGlzTW91bnRlZChjb21wb25lbnQpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBvd25lciA9IFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQ7CiAgICAgICAgICAgICAgaWYgKG93bmVyICE9PSBudWxsICYmIG93bmVyLnRhZyA9PT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgIHZhciBvd25lckZpYmVyID0gb3duZXI7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBvd25lckZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmICghaW5zdGFuY2UuX3dhcm5lZEFib3V0UmVmc0luUmVuZGVyKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCIlcyBpcyBhY2Nlc3NpbmcgaXNNb3VudGVkIGluc2lkZSBpdHMgcmVuZGVyKCkgZnVuY3Rpb24uIHJlbmRlcigpIHNob3VsZCBiZSBhIHB1cmUgZnVuY3Rpb24gb2YgcHJvcHMgYW5kIHN0YXRlLiBJdCBzaG91bGQgbmV2ZXIgYWNjZXNzIHNvbWV0aGluZyB0aGF0IHJlcXVpcmVzIHN0YWxlIGRhdGEgZnJvbSB0aGUgcHJldmlvdXMgcmVuZGVyLCBzdWNoIGFzIHJlZnMuIE1vdmUgdGhpcyBsb2dpYyB0byBjb21wb25lbnREaWRNb3VudCBhbmQgY29tcG9uZW50RGlkVXBkYXRlIGluc3RlYWQuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihvd25lckZpYmVyKSB8fCAiQSBjb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGluc3RhbmNlLl93YXJuZWRBYm91dFJlZnNJblJlbmRlciA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBmaWJlciA9IGdldDMoY29tcG9uZW50KTsKICAgICAgICAgICAgaWYgKCFmaWJlcikgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZ2V0TmVhcmVzdE1vdW50ZWRGaWJlcihmaWJlcikgPT09IGZpYmVyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gYXNzZXJ0SXNNb3VudGVkKGZpYmVyKSB7CiAgICAgICAgICAgIGlmIChnZXROZWFyZXN0TW91bnRlZEZpYmVyKGZpYmVyKSAhPT0gZmliZXIpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byBmaW5kIG5vZGUgb24gYW4gdW5tb3VudGVkIGNvbXBvbmVudC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZmluZEN1cnJlbnRGaWJlclVzaW5nU2xvd1BhdGgoZmliZXIpIHsKICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKCFhbHRlcm5hdGUpIHsKICAgICAgICAgICAgICB2YXIgbmVhcmVzdE1vdW50ZWQgPSBnZXROZWFyZXN0TW91bnRlZEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgICBpZiAobmVhcmVzdE1vdW50ZWQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5hYmxlIHRvIGZpbmQgbm9kZSBvbiBhbiB1bm1vdW50ZWQgY29tcG9uZW50LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobmVhcmVzdE1vdW50ZWQgIT09IGZpYmVyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhMiA9IGZpYmVyOwogICAgICAgICAgICB2YXIgYiA9IGFsdGVybmF0ZTsKICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICB2YXIgcGFyZW50QSA9IGEyLnJldHVybjsKICAgICAgICAgICAgICBpZiAocGFyZW50QSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBwYXJlbnRCID0gcGFyZW50QS5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgaWYgKHBhcmVudEIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBuZXh0UGFyZW50ID0gcGFyZW50QS5yZXR1cm47CiAgICAgICAgICAgICAgICBpZiAobmV4dFBhcmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBhMiA9IGIgPSBuZXh0UGFyZW50OwogICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocGFyZW50QS5jaGlsZCA9PT0gcGFyZW50Qi5jaGlsZCkgewogICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gcGFyZW50QS5jaGlsZDsKICAgICAgICAgICAgICAgIHdoaWxlIChjaGlsZCkgewogICAgICAgICAgICAgICAgICBpZiAoY2hpbGQgPT09IGEyKSB7CiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0SXNNb3VudGVkKHBhcmVudEEpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoY2hpbGQgPT09IGIpIHsKICAgICAgICAgICAgICAgICAgICBhc3NlcnRJc01vdW50ZWQocGFyZW50QSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFsdGVybmF0ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byBmaW5kIG5vZGUgb24gYW4gdW5tb3VudGVkIGNvbXBvbmVudC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGEyLnJldHVybiAhPT0gYi5yZXR1cm4pIHsKICAgICAgICAgICAgICAgIGEyID0gcGFyZW50QTsKICAgICAgICAgICAgICAgIGIgPSBwYXJlbnRCOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgZGlkRmluZENoaWxkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB2YXIgX2NoaWxkID0gcGFyZW50QS5jaGlsZDsKICAgICAgICAgICAgICAgIHdoaWxlIChfY2hpbGQpIHsKICAgICAgICAgICAgICAgICAgaWYgKF9jaGlsZCA9PT0gYTIpIHsKICAgICAgICAgICAgICAgICAgICBkaWRGaW5kQ2hpbGQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGEyID0gcGFyZW50QTsKICAgICAgICAgICAgICAgICAgICBiID0gcGFyZW50QjsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoX2NoaWxkID09PSBiKSB7CiAgICAgICAgICAgICAgICAgICAgZGlkRmluZENoaWxkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBiID0gcGFyZW50QTsKICAgICAgICAgICAgICAgICAgICBhMiA9IHBhcmVudEI7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgX2NoaWxkID0gX2NoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIWRpZEZpbmRDaGlsZCkgewogICAgICAgICAgICAgICAgICBfY2hpbGQgPSBwYXJlbnRCLmNoaWxkOwogICAgICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9jaGlsZCA9PT0gYTIpIHsKICAgICAgICAgICAgICAgICAgICAgIGRpZEZpbmRDaGlsZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICBhMiA9IHBhcmVudEI7CiAgICAgICAgICAgICAgICAgICAgICBiID0gcGFyZW50QTsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoX2NoaWxkID09PSBiKSB7CiAgICAgICAgICAgICAgICAgICAgICBkaWRGaW5kQ2hpbGQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgYiA9IHBhcmVudEI7CiAgICAgICAgICAgICAgICAgICAgICBhMiA9IHBhcmVudEE7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgX2NoaWxkID0gX2NoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKCFkaWRGaW5kQ2hpbGQpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNoaWxkIHdhcyBub3QgZm91bmQgaW4gZWl0aGVyIHBhcmVudCBzZXQuIFRoaXMgaW5kaWNhdGVzIGEgYnVnIGluIFJlYWN0IHJlbGF0ZWQgdG8gdGhlIHJldHVybiBwb2ludGVyLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoYTIuYWx0ZXJuYXRlICE9PSBiKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJldHVybiBmaWJlcnMgc2hvdWxkIGFsd2F5cyBiZSBlYWNoIG90aGVycycgYWx0ZXJuYXRlcy4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGEyLnRhZyAhPT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byBmaW5kIG5vZGUgb24gYW4gdW5tb3VudGVkIGNvbXBvbmVudC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYTIuc3RhdGVOb2RlLmN1cnJlbnQgPT09IGEyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBhbHRlcm5hdGU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBmaW5kQ3VycmVudEhvc3RGaWJlcihwYXJlbnQpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRQYXJlbnQgPSBmaW5kQ3VycmVudEZpYmVyVXNpbmdTbG93UGF0aChwYXJlbnQpOwogICAgICAgICAgICByZXR1cm4gY3VycmVudFBhcmVudCAhPT0gbnVsbCA/IGZpbmRDdXJyZW50SG9zdEZpYmVySW1wbChjdXJyZW50UGFyZW50KSA6IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBmaW5kQ3VycmVudEhvc3RGaWJlckltcGwobm9kZSkgewogICAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgbm9kZS50YWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNoaWxkID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG1hdGNoID0gZmluZEN1cnJlbnRIb3N0RmliZXJJbXBsKGNoaWxkKTsKICAgICAgICAgICAgICBpZiAobWF0Y2ggIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZmluZEN1cnJlbnRIb3N0RmliZXJXaXRoTm9Qb3J0YWxzKHBhcmVudCkgewogICAgICAgICAgICB2YXIgY3VycmVudFBhcmVudCA9IGZpbmRDdXJyZW50RmliZXJVc2luZ1Nsb3dQYXRoKHBhcmVudCk7CiAgICAgICAgICAgIHJldHVybiBjdXJyZW50UGFyZW50ICE9PSBudWxsID8gZmluZEN1cnJlbnRIb3N0RmliZXJXaXRoTm9Qb3J0YWxzSW1wbChjdXJyZW50UGFyZW50KSA6IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBmaW5kQ3VycmVudEhvc3RGaWJlcldpdGhOb1BvcnRhbHNJbXBsKG5vZGUpIHsKICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IG5vZGUudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjaGlsZCA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChjaGlsZC50YWcgIT09IEhvc3RQb3J0YWwpIHsKICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFsc0ltcGwoY2hpbGQpOwogICAgICAgICAgICAgICAgaWYgKG1hdGNoICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHNjaGVkdWxlQ2FsbGJhY2sgPSBTY2hlZHVsZXIudW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjazsKICAgICAgICAgIHZhciBjYW5jZWxDYWxsYmFjayA9IFNjaGVkdWxlci51bnN0YWJsZV9jYW5jZWxDYWxsYmFjazsKICAgICAgICAgIHZhciBzaG91bGRZaWVsZCA9IFNjaGVkdWxlci51bnN0YWJsZV9zaG91bGRZaWVsZDsKICAgICAgICAgIHZhciByZXF1ZXN0UGFpbnQgPSBTY2hlZHVsZXIudW5zdGFibGVfcmVxdWVzdFBhaW50OwogICAgICAgICAgdmFyIG5vdzIgPSBTY2hlZHVsZXIudW5zdGFibGVfbm93OwogICAgICAgICAgdmFyIGdldEN1cnJlbnRQcmlvcml0eUxldmVsID0gU2NoZWR1bGVyLnVuc3RhYmxlX2dldEN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgICAgdmFyIEltbWVkaWF0ZVByaW9yaXR5ID0gU2NoZWR1bGVyLnVuc3RhYmxlX0ltbWVkaWF0ZVByaW9yaXR5OwogICAgICAgICAgdmFyIFVzZXJCbG9ja2luZ1ByaW9yaXR5ID0gU2NoZWR1bGVyLnVuc3RhYmxlX1VzZXJCbG9ja2luZ1ByaW9yaXR5OwogICAgICAgICAgdmFyIE5vcm1hbFByaW9yaXR5ID0gU2NoZWR1bGVyLnVuc3RhYmxlX05vcm1hbFByaW9yaXR5OwogICAgICAgICAgdmFyIExvd1ByaW9yaXR5ID0gU2NoZWR1bGVyLnVuc3RhYmxlX0xvd1ByaW9yaXR5OwogICAgICAgICAgdmFyIElkbGVQcmlvcml0eSA9IFNjaGVkdWxlci51bnN0YWJsZV9JZGxlUHJpb3JpdHk7CiAgICAgICAgICB2YXIgdW5zdGFibGVfeWllbGRWYWx1ZSA9IFNjaGVkdWxlci51bnN0YWJsZV95aWVsZFZhbHVlOwogICAgICAgICAgdmFyIHVuc3RhYmxlX3NldERpc2FibGVZaWVsZFZhbHVlID0gU2NoZWR1bGVyLnVuc3RhYmxlX3NldERpc2FibGVZaWVsZFZhbHVlOwogICAgICAgICAgdmFyIHJlbmRlcmVySUQgPSBudWxsOwogICAgICAgICAgdmFyIGluamVjdGVkSG9vayA9IG51bGw7CiAgICAgICAgICB2YXIgaW5qZWN0ZWRQcm9maWxpbmdIb29rcyA9IG51bGw7CiAgICAgICAgICB2YXIgaGFzTG9nZ2VkRXJyb3IgPSBmYWxzZTsKICAgICAgICAgIHZhciBpc0RldlRvb2xzUHJlc2VudCA9IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gIT09ICJ1bmRlZmluZWQiOwogICAgICAgICAgZnVuY3Rpb24gaW5qZWN0SW50ZXJuYWxzKGludGVybmFscykgewogICAgICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGhvb2sgPSBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX187CiAgICAgICAgICAgIGlmIChob29rLmlzRGlzYWJsZWQpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWhvb2suc3VwcG9ydHNGaWJlcikgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgaW5zdGFsbGVkIHZlcnNpb24gb2YgUmVhY3QgRGV2VG9vbHMgaXMgdG9vIG9sZCBhbmQgd2lsbCBub3Qgd29yayB3aXRoIHRoZSBjdXJyZW50IHZlcnNpb24gb2YgUmVhY3QuIFBsZWFzZSB1cGRhdGUgUmVhY3QgRGV2VG9vbHMuIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9yZWFjdC1kZXZ0b29scyIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGlmIChlbmFibGVTY2hlZHVsaW5nUHJvZmlsZXIpIHsKICAgICAgICAgICAgICAgIGludGVybmFscyA9IGFzc2lnbih7fSwgaW50ZXJuYWxzLCB7CiAgICAgICAgICAgICAgICAgIGdldExhbmVMYWJlbE1hcCwKICAgICAgICAgICAgICAgICAgaW5qZWN0UHJvZmlsaW5nSG9va3MKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZW5kZXJlcklEID0gaG9vay5pbmplY3QoaW50ZXJuYWxzKTsKICAgICAgICAgICAgICBpbmplY3RlZEhvb2sgPSBob29rOwogICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgaW5zdHJ1bWVudGF0aW9uIGVuY291bnRlcmVkIGFuIGVycm9yOiAlcy4iLCBlcnIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaG9vay5jaGVja0RDRSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gb25TY2hlZHVsZVJvb3Qocm9vdDMsIGNoaWxkcmVuMikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGluamVjdGVkSG9vayAmJiB0eXBlb2YgaW5qZWN0ZWRIb29rLm9uU2NoZWR1bGVGaWJlclJvb3QgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGluamVjdGVkSG9vay5vblNjaGVkdWxlRmliZXJSb290KHJlbmRlcmVySUQsIHJvb3QzLCBjaGlsZHJlbjIpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgICAgIGlmICghaGFzTG9nZ2VkRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICBoYXNMb2dnZWRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGluc3RydW1lbnRhdGlvbiBlbmNvdW50ZXJlZCBhbiBlcnJvcjogJXMiLCBlcnIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBvbkNvbW1pdFJvb3Qocm9vdDMsIGV2ZW50UHJpb3JpdHkpIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkSG9vayAmJiB0eXBlb2YgaW5qZWN0ZWRIb29rLm9uQ29tbWl0RmliZXJSb290ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHZhciBkaWRFcnJvciA9IChyb290My5jdXJyZW50LmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICBpZiAoZW5hYmxlUHJvZmlsZXJUaW1lcikgewogICAgICAgICAgICAgICAgICB2YXIgc2NoZWR1bGVyUHJpb3JpdHk7CiAgICAgICAgICAgICAgICAgIHN3aXRjaCAoZXZlbnRQcmlvcml0eSkgewogICAgICAgICAgICAgICAgICAgIGNhc2UgRGlzY3JldGVFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHkgPSBJbW1lZGlhdGVQcmlvcml0eTsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgQ29udGludW91c0V2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eSA9IFVzZXJCbG9ja2luZ1ByaW9yaXR5OwogICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBEZWZhdWx0RXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5ID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIElkbGVFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHkgPSBJZGxlUHJpb3JpdHk7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHkgPSBOb3JtYWxQcmlvcml0eTsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGluamVjdGVkSG9vay5vbkNvbW1pdEZpYmVyUm9vdChyZW5kZXJlcklELCByb290Mywgc2NoZWR1bGVyUHJpb3JpdHksIGRpZEVycm9yKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGluamVjdGVkSG9vay5vbkNvbW1pdEZpYmVyUm9vdChyZW5kZXJlcklELCByb290Mywgdm9pZCAwLCBkaWRFcnJvcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICghaGFzTG9nZ2VkRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICBoYXNMb2dnZWRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGluc3RydW1lbnRhdGlvbiBlbmNvdW50ZXJlZCBhbiBlcnJvcjogJXMiLCBlcnIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBvblBvc3RDb21taXRSb290KHJvb3QzKSB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZEhvb2sgJiYgdHlwZW9mIGluamVjdGVkSG9vay5vblBvc3RDb21taXRGaWJlclJvb3QgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgaW5qZWN0ZWRIb29rLm9uUG9zdENvbW1pdEZpYmVyUm9vdChyZW5kZXJlcklELCByb290Myk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICghaGFzTG9nZ2VkRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICBoYXNMb2dnZWRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGluc3RydW1lbnRhdGlvbiBlbmNvdW50ZXJlZCBhbiBlcnJvcjogJXMiLCBlcnIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBvbkNvbW1pdFVubW91bnQoZmliZXIpIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkSG9vayAmJiB0eXBlb2YgaW5qZWN0ZWRIb29rLm9uQ29tbWl0RmliZXJVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGluamVjdGVkSG9vay5vbkNvbW1pdEZpYmVyVW5tb3VudChyZW5kZXJlcklELCBmaWJlcik7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICghaGFzTG9nZ2VkRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICBoYXNMb2dnZWRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGluc3RydW1lbnRhdGlvbiBlbmNvdW50ZXJlZCBhbiBlcnJvcjogJXMiLCBlcnIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhuZXdJc1N0cmljdE1vZGUpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgdW5zdGFibGVfeWllbGRWYWx1ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdW5zdGFibGVfc2V0RGlzYWJsZVlpZWxkVmFsdWUobmV3SXNTdHJpY3RNb2RlKTsKICAgICAgICAgICAgICAgIHNldFN1cHByZXNzV2FybmluZyhuZXdJc1N0cmljdE1vZGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaW5qZWN0ZWRIb29rICYmIHR5cGVvZiBpbmplY3RlZEhvb2suc2V0U3RyaWN0TW9kZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgaW5qZWN0ZWRIb29rLnNldFN0cmljdE1vZGUocmVuZGVyZXJJRCwgbmV3SXNTdHJpY3RNb2RlKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFoYXNMb2dnZWRFcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgaGFzTG9nZ2VkRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGluc3RydW1lbnRhdGlvbiBlbmNvdW50ZXJlZCBhbiBlcnJvcjogJXMiLCBlcnIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaW5qZWN0UHJvZmlsaW5nSG9va3MocHJvZmlsaW5nSG9va3MpIHsKICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcyA9IHByb2ZpbGluZ0hvb2tzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0TGFuZUxhYmVsTWFwKCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIG1hcCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgICAgICAgdmFyIGxhbmUgPSAxOwogICAgICAgICAgICAgIGZvciAodmFyIGluZGV4MyA9IDA7IGluZGV4MyA8IFRvdGFsTGFuZXM7IGluZGV4MysrKSB7CiAgICAgICAgICAgICAgICB2YXIgbGFiZWwgPSBnZXRMYWJlbEZvckxhbmUobGFuZSk7CiAgICAgICAgICAgICAgICBtYXAuc2V0KGxhbmUsIGxhYmVsKTsKICAgICAgICAgICAgICAgIGxhbmUgKj0gMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIG1hcDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbWFya0NvbW1pdFN0YXJ0ZWQobGFuZXMpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21taXRTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21taXRTdGFydGVkKGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG1hcmtDb21taXRTdG9wcGVkKCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbW1pdFN0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbW1pdFN0b3BwZWQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKGZpYmVyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZChmaWJlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RhcnRlZChmaWJlcikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0YXJ0ZWQoZmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0b3BwZWQoKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RhcnRlZChmaWJlcikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdFVubW91bnRTdGFydGVkKGZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0b3BwZWQoKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdFVubW91bnRTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0YXJ0ZWQoZmliZXIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdE1vdW50U3RhcnRlZChmaWJlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdG9wcGVkKCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdE1vdW50U3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdG9wcGVkKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0YXJ0ZWQoZmliZXIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0YXJ0ZWQoZmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdG9wcGVkKCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudEVycm9yZWQoZmliZXIsIHRocm93blZhbHVlLCBsYW5lcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudEVycm9yZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudEVycm9yZWQoZmliZXIsIHRocm93blZhbHVlLCBsYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50U3VzcGVuZGVkKGZpYmVyLCB3YWtlYWJsZSwgbGFuZXMpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRTdXNwZW5kZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFN1c3BlbmRlZChmaWJlciwgd2FrZWFibGUsIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG1hcmtMYXlvdXRFZmZlY3RzU3RhcnRlZChsYW5lcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0xheW91dEVmZmVjdHNTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtMYXlvdXRFZmZlY3RzU3RhcnRlZChsYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtYXJrTGF5b3V0RWZmZWN0c1N0b3BwZWQoKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrTGF5b3V0RWZmZWN0c1N0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0xheW91dEVmZmVjdHNTdG9wcGVkKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtYXJrUGFzc2l2ZUVmZmVjdHNTdGFydGVkKGxhbmVzKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUGFzc2l2ZUVmZmVjdHNTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtQYXNzaXZlRWZmZWN0c1N0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbWFya1Bhc3NpdmVFZmZlY3RzU3RvcHBlZCgpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtQYXNzaXZlRWZmZWN0c1N0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1Bhc3NpdmVFZmZlY3RzU3RvcHBlZCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbWFya1JlbmRlclN0YXJ0ZWQobGFuZXMpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJTdGFydGVkKGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG1hcmtSZW5kZXJZaWVsZGVkKCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlcllpZWxkZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlcllpZWxkZWQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG1hcmtSZW5kZXJTdG9wcGVkKCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlclN0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlclN0b3BwZWQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG1hcmtSZW5kZXJTY2hlZHVsZWQobGFuZSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlclNjaGVkdWxlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyU2NoZWR1bGVkKGxhbmUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbWFya0ZvcmNlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrRm9yY2VVcGRhdGVTY2hlZHVsZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0ZvcmNlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG1hcmtTdGF0ZVVwZGF0ZVNjaGVkdWxlZChmaWJlciwgbGFuZSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1N0YXRlVXBkYXRlU2NoZWR1bGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtTdGF0ZVVwZGF0ZVNjaGVkdWxlZChmaWJlciwgbGFuZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgTm9Nb2RlID0gKAogICAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAwCiAgICAgICAgICApOwogICAgICAgICAgdmFyIENvbmN1cnJlbnRNb2RlID0gKAogICAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgMQogICAgICAgICAgKTsKICAgICAgICAgIHZhciBQcm9maWxlTW9kZSA9ICgKICAgICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgIDIKICAgICAgICAgICk7CiAgICAgICAgICB2YXIgU3RyaWN0TGVnYWN5TW9kZSA9ICgKICAgICAgICAgICAgLyogICAgICAgICAgICAgICAqLwogICAgICAgICAgICA4CiAgICAgICAgICApOwogICAgICAgICAgdmFyIFN0cmljdEVmZmVjdHNNb2RlID0gKAogICAgICAgICAgICAvKiAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgMTYKICAgICAgICAgICk7CiAgICAgICAgICB2YXIgY2x6MzIgPSBNYXRoLmNsejMyID8gTWF0aC5jbHozMiA6IGNsejMyRmFsbGJhY2s7CiAgICAgICAgICB2YXIgbG9nID0gTWF0aC5sb2c7CiAgICAgICAgICB2YXIgTE4yID0gTWF0aC5MTjI7CiAgICAgICAgICBmdW5jdGlvbiBjbHozMkZhbGxiYWNrKHgyKSB7CiAgICAgICAgICAgIHZhciBhc1VpbnQgPSB4MiA+Pj4gMDsKICAgICAgICAgICAgaWYgKGFzVWludCA9PT0gMCkgewogICAgICAgICAgICAgIHJldHVybiAzMjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gMzEgLSAobG9nKGFzVWludCkgLyBMTjIgfCAwKSB8IDA7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgVG90YWxMYW5lcyA9IDMxOwogICAgICAgICAgdmFyIE5vTGFuZXMgPSAoCiAgICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgMAogICAgICAgICAgKTsKICAgICAgICAgIHZhciBOb0xhbmUgPSAoCiAgICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAwCiAgICAgICAgICApOwogICAgICAgICAgdmFyIFN5bmNMYW5lID0gKAogICAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgIDEKICAgICAgICAgICk7CiAgICAgICAgICB2YXIgSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZSA9ICgKICAgICAgICAgICAgLyogICAgKi8KICAgICAgICAgICAgMgogICAgICAgICAgKTsKICAgICAgICAgIHZhciBJbnB1dENvbnRpbnVvdXNMYW5lID0gKAogICAgICAgICAgICAvKiAgICAgICAgICAgICAqLwogICAgICAgICAgICA0CiAgICAgICAgICApOwogICAgICAgICAgdmFyIERlZmF1bHRIeWRyYXRpb25MYW5lID0gKAogICAgICAgICAgICAvKiAgICAgICAgICAgICovCiAgICAgICAgICAgIDgKICAgICAgICAgICk7CiAgICAgICAgICB2YXIgRGVmYXVsdExhbmUgPSAoCiAgICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgMTYKICAgICAgICAgICk7CiAgICAgICAgICB2YXIgVHJhbnNpdGlvbkh5ZHJhdGlvbkxhbmUgPSAoCiAgICAgICAgICAgIC8qICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgIDMyCiAgICAgICAgICApOwogICAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lcyA9ICgKICAgICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgIDQxOTQyNDAKICAgICAgICAgICk7CiAgICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxID0gKAogICAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgIDY0CiAgICAgICAgICApOwogICAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMiA9ICgKICAgICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAxMjgKICAgICAgICAgICk7CiAgICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUzID0gKAogICAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgIDI1NgogICAgICAgICAgKTsKICAgICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTQgPSAoCiAgICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgNTEyCiAgICAgICAgICApOwogICAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lNSA9ICgKICAgICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAxMDI0CiAgICAgICAgICApOwogICAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lNiA9ICgKICAgICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAyMDQ4CiAgICAgICAgICApOwogICAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lNyA9ICgKICAgICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICA0MDk2CiAgICAgICAgICApOwogICAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lOCA9ICgKICAgICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICA4MTkyCiAgICAgICAgICApOwogICAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lOSA9ICgKICAgICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAxNjM4NAogICAgICAgICAgKTsKICAgICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTEwID0gKAogICAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgMzI3NjgKICAgICAgICAgICk7CiAgICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxMSA9ICgKICAgICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgIDY1NTM2CiAgICAgICAgICApOwogICAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMTIgPSAoCiAgICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAxMzEwNzIKICAgICAgICAgICk7CiAgICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxMyA9ICgKICAgICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgIDI2MjE0NAogICAgICAgICAgKTsKICAgICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTE0ID0gKAogICAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgNTI0Mjg4CiAgICAgICAgICApOwogICAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMTUgPSAoCiAgICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAxMDQ4NTc2CiAgICAgICAgICApOwogICAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMTYgPSAoCiAgICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAyMDk3MTUyCiAgICAgICAgICApOwogICAgICAgICAgdmFyIFJldHJ5TGFuZXMgPSAoCiAgICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgIDEzMDAyMzQyNAogICAgICAgICAgKTsKICAgICAgICAgIHZhciBSZXRyeUxhbmUxID0gKAogICAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgNDE5NDMwNAogICAgICAgICAgKTsKICAgICAgICAgIHZhciBSZXRyeUxhbmUyID0gKAogICAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgODM4ODYwOAogICAgICAgICAgKTsKICAgICAgICAgIHZhciBSZXRyeUxhbmUzID0gKAogICAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgMTY3NzcyMTYKICAgICAgICAgICk7CiAgICAgICAgICB2YXIgUmV0cnlMYW5lNCA9ICgKICAgICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgIDMzNTU0NDMyCiAgICAgICAgICApOwogICAgICAgICAgdmFyIFJldHJ5TGFuZTUgPSAoCiAgICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICA2NzEwODg2NAogICAgICAgICAgKTsKICAgICAgICAgIHZhciBTb21lUmV0cnlMYW5lID0gUmV0cnlMYW5lMTsKICAgICAgICAgIHZhciBTZWxlY3RpdmVIeWRyYXRpb25MYW5lID0gKAogICAgICAgICAgICAvKiAgICAgICAgICAqLwogICAgICAgICAgICAxMzQyMTc3MjgKICAgICAgICAgICk7CiAgICAgICAgICB2YXIgTm9uSWRsZUxhbmVzID0gKAogICAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgMjY4NDM1NDU1CiAgICAgICAgICApOwogICAgICAgICAgdmFyIElkbGVIeWRyYXRpb25MYW5lID0gKAogICAgICAgICAgICAvKiAgICAgICAgICAgICAgICovCiAgICAgICAgICAgIDI2ODQzNTQ1NgogICAgICAgICAgKTsKICAgICAgICAgIHZhciBJZGxlTGFuZSA9ICgKICAgICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICA1MzY4NzA5MTIKICAgICAgICAgICk7CiAgICAgICAgICB2YXIgT2Zmc2NyZWVuTGFuZSA9ICgKICAgICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgMTA3Mzc0MTgyNAogICAgICAgICAgKTsKICAgICAgICAgIGZ1bmN0aW9uIGdldExhYmVsRm9yTGFuZShsYW5lKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAobGFuZSAmIFN5bmNMYW5lKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIlN5bmMiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobGFuZSAmIElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmUpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiSW5wdXRDb250aW51b3VzSHlkcmF0aW9uIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGxhbmUgJiBJbnB1dENvbnRpbnVvdXNMYW5lKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIklucHV0Q29udGludW91cyI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChsYW5lICYgRGVmYXVsdEh5ZHJhdGlvbkxhbmUpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiRGVmYXVsdEh5ZHJhdGlvbiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChsYW5lICYgRGVmYXVsdExhbmUpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiRGVmYXVsdCI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChsYW5lICYgVHJhbnNpdGlvbkh5ZHJhdGlvbkxhbmUpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiVHJhbnNpdGlvbkh5ZHJhdGlvbiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChsYW5lICYgVHJhbnNpdGlvbkxhbmVzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIlRyYW5zaXRpb24iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobGFuZSAmIFJldHJ5TGFuZXMpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiUmV0cnkiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobGFuZSAmIFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmUpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiU2VsZWN0aXZlSHlkcmF0aW9uIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGxhbmUgJiBJZGxlSHlkcmF0aW9uTGFuZSkgewogICAgICAgICAgICAgICAgcmV0dXJuICJJZGxlSHlkcmF0aW9uIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGxhbmUgJiBJZGxlTGFuZSkgewogICAgICAgICAgICAgICAgcmV0dXJuICJJZGxlIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGxhbmUgJiBPZmZzY3JlZW5MYW5lKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIk9mZnNjcmVlbiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgTm9UaW1lc3RhbXAgPSAtMTsKICAgICAgICAgIHZhciBuZXh0VHJhbnNpdGlvbkxhbmUgPSBUcmFuc2l0aW9uTGFuZTE7CiAgICAgICAgICB2YXIgbmV4dFJldHJ5TGFuZSA9IFJldHJ5TGFuZTE7CiAgICAgICAgICBmdW5jdGlvbiBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lcyhsYW5lcykgewogICAgICAgICAgICBzd2l0Y2ggKGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobGFuZXMpKSB7CiAgICAgICAgICAgICAgY2FzZSBTeW5jTGFuZToKICAgICAgICAgICAgICAgIHJldHVybiBTeW5jTGFuZTsKICAgICAgICAgICAgICBjYXNlIElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgICAgICByZXR1cm4gSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgICBjYXNlIElucHV0Q29udGludW91c0xhbmU6CiAgICAgICAgICAgICAgICByZXR1cm4gSW5wdXRDb250aW51b3VzTGFuZTsKICAgICAgICAgICAgICBjYXNlIERlZmF1bHRIeWRyYXRpb25MYW5lOgogICAgICAgICAgICAgICAgcmV0dXJuIERlZmF1bHRIeWRyYXRpb25MYW5lOwogICAgICAgICAgICAgIGNhc2UgRGVmYXVsdExhbmU6CiAgICAgICAgICAgICAgICByZXR1cm4gRGVmYXVsdExhbmU7CiAgICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uSHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgICAgIHJldHVybiBUcmFuc2l0aW9uSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMToKICAgICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMjoKICAgICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMzoKICAgICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNDoKICAgICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNToKICAgICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNjoKICAgICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNzoKICAgICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lODoKICAgICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lOToKICAgICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTA6CiAgICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTExOgogICAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMjoKICAgICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTM6CiAgICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE0OgogICAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNToKICAgICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTY6CiAgICAgICAgICAgICAgICByZXR1cm4gbGFuZXMgJiBUcmFuc2l0aW9uTGFuZXM7CiAgICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUxOgogICAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMjoKICAgICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTM6CiAgICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmU0OgogICAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lNToKICAgICAgICAgICAgICAgIHJldHVybiBsYW5lcyAmIFJldHJ5TGFuZXM7CiAgICAgICAgICAgICAgY2FzZSBTZWxlY3RpdmVIeWRyYXRpb25MYW5lOgogICAgICAgICAgICAgICAgcmV0dXJuIFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgICAgY2FzZSBJZGxlSHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgICAgIHJldHVybiBJZGxlSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgICBjYXNlIElkbGVMYW5lOgogICAgICAgICAgICAgICAgcmV0dXJuIElkbGVMYW5lOwogICAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuTGFuZToKICAgICAgICAgICAgICAgIHJldHVybiBPZmZzY3JlZW5MYW5lOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJTaG91bGQgaGF2ZSBmb3VuZCBtYXRjaGluZyBsYW5lcy4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBsYW5lczsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0TmV4dExhbmVzKHJvb3QzLCB3aXBMYW5lcykgewogICAgICAgICAgICB2YXIgcGVuZGluZ0xhbmVzID0gcm9vdDMucGVuZGluZ0xhbmVzOwogICAgICAgICAgICBpZiAocGVuZGluZ0xhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgcmV0dXJuIE5vTGFuZXM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5leHRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIHZhciBzdXNwZW5kZWRMYW5lcyA9IHJvb3QzLnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgICB2YXIgcGluZ2VkTGFuZXMgPSByb290My5waW5nZWRMYW5lczsKICAgICAgICAgICAgdmFyIG5vbklkbGVQZW5kaW5nTGFuZXMgPSBwZW5kaW5nTGFuZXMgJiBOb25JZGxlTGFuZXM7CiAgICAgICAgICAgIGlmIChub25JZGxlUGVuZGluZ0xhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgdmFyIG5vbklkbGVVbmJsb2NrZWRMYW5lcyA9IG5vbklkbGVQZW5kaW5nTGFuZXMgJiB+c3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICAgICAgaWYgKG5vbklkbGVVbmJsb2NrZWRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgbmV4dExhbmVzID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXMobm9uSWRsZVVuYmxvY2tlZExhbmVzKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIG5vbklkbGVQaW5nZWRMYW5lcyA9IG5vbklkbGVQZW5kaW5nTGFuZXMgJiBwaW5nZWRMYW5lczsKICAgICAgICAgICAgICAgIGlmIChub25JZGxlUGluZ2VkTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICAgICAgbmV4dExhbmVzID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXMobm9uSWRsZVBpbmdlZExhbmVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHVuYmxvY2tlZExhbmVzID0gcGVuZGluZ0xhbmVzICYgfnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgICAgIGlmICh1bmJsb2NrZWRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgbmV4dExhbmVzID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXModW5ibG9ja2VkTGFuZXMpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAocGluZ2VkTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICAgICAgbmV4dExhbmVzID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXMocGluZ2VkTGFuZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobmV4dExhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgcmV0dXJuIE5vTGFuZXM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdpcExhbmVzICE9PSBOb0xhbmVzICYmIHdpcExhbmVzICE9PSBuZXh0TGFuZXMgJiYgLy8gSWYgd2UgYWxyZWFkeSBzdXNwZW5kZWQgd2l0aCBhIGRlbGF5LCB0aGVuIGludGVycnVwdGluZyBpcyBmaW5lLiBEb24ndAogICAgICAgICAgICAvLyBib3RoZXIgd2FpdGluZyB1bnRpbCB0aGUgcm9vdCBpcyBjb21wbGV0ZS4KICAgICAgICAgICAgKHdpcExhbmVzICYgc3VzcGVuZGVkTGFuZXMpID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgdmFyIG5leHRMYW5lID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZShuZXh0TGFuZXMpOwogICAgICAgICAgICAgIHZhciB3aXBMYW5lID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZSh3aXBMYW5lcyk7CiAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgLy8gVGVzdHMgd2hldGhlciB0aGUgbmV4dCBsYW5lIGlzIGVxdWFsIG9yIGxvd2VyIHByaW9yaXR5IHRoYW4gdGhlIHdpcAogICAgICAgICAgICAgICAgLy8gb25lLiBUaGlzIHdvcmtzIGJlY2F1c2UgdGhlIGJpdHMgZGVjcmVhc2UgaW4gcHJpb3JpdHkgYXMgeW91IGdvIGxlZnQuCiAgICAgICAgICAgICAgICBuZXh0TGFuZSA+PSB3aXBMYW5lIHx8IC8vIERlZmF1bHQgcHJpb3JpdHkgdXBkYXRlcyBzaG91bGQgbm90IGludGVycnVwdCB0cmFuc2l0aW9uIHVwZGF0ZXMuIFRoZQogICAgICAgICAgICAgICAgLy8gb25seSBkaWZmZXJlbmNlIGJldHdlZW4gZGVmYXVsdCB1cGRhdGVzIGFuZCB0cmFuc2l0aW9uIHVwZGF0ZXMgaXMgdGhhdAogICAgICAgICAgICAgICAgLy8gZGVmYXVsdCB1cGRhdGVzIGRvIG5vdCBzdXBwb3J0IHJlZnJlc2ggdHJhbnNpdGlvbnMuCiAgICAgICAgICAgICAgICBuZXh0TGFuZSA9PT0gRGVmYXVsdExhbmUgJiYgKHdpcExhbmUgJiBUcmFuc2l0aW9uTGFuZXMpICE9PSBOb0xhbmVzCiAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gd2lwTGFuZXM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgobmV4dExhbmVzICYgSW5wdXRDb250aW51b3VzTGFuZSkgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICBuZXh0TGFuZXMgfD0gcGVuZGluZ0xhbmVzICYgRGVmYXVsdExhbmU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGVudGFuZ2xlZExhbmVzID0gcm9vdDMuZW50YW5nbGVkTGFuZXM7CiAgICAgICAgICAgIGlmIChlbnRhbmdsZWRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgIHZhciBlbnRhbmdsZW1lbnRzID0gcm9vdDMuZW50YW5nbGVtZW50czsKICAgICAgICAgICAgICB2YXIgbGFuZXMgPSBuZXh0TGFuZXMgJiBlbnRhbmdsZWRMYW5lczsKICAgICAgICAgICAgICB3aGlsZSAobGFuZXMgPiAwKSB7CiAgICAgICAgICAgICAgICB2YXIgaW5kZXgzID0gcGlja0FyYml0cmFyeUxhbmVJbmRleChsYW5lcyk7CiAgICAgICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgzOwogICAgICAgICAgICAgICAgbmV4dExhbmVzIHw9IGVudGFuZ2xlbWVudHNbaW5kZXgzXTsKICAgICAgICAgICAgICAgIGxhbmVzICY9IH5sYW5lOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV4dExhbmVzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0TW9zdFJlY2VudEV2ZW50VGltZShyb290MywgbGFuZXMpIHsKICAgICAgICAgICAgdmFyIGV2ZW50VGltZXMgPSByb290My5ldmVudFRpbWVzOwogICAgICAgICAgICB2YXIgbW9zdFJlY2VudEV2ZW50VGltZSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgICB3aGlsZSAobGFuZXMgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIGluZGV4MyA9IHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpOwogICAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDM7CiAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IGV2ZW50VGltZXNbaW5kZXgzXTsKICAgICAgICAgICAgICBpZiAoZXZlbnRUaW1lID4gbW9zdFJlY2VudEV2ZW50VGltZSkgewogICAgICAgICAgICAgICAgbW9zdFJlY2VudEV2ZW50VGltZSA9IGV2ZW50VGltZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbGFuZXMgJj0gfmxhbmU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1vc3RSZWNlbnRFdmVudFRpbWU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjb21wdXRlRXhwaXJhdGlvblRpbWUobGFuZSwgY3VycmVudFRpbWUpIHsKICAgICAgICAgICAgc3dpdGNoIChsYW5lKSB7CiAgICAgICAgICAgICAgY2FzZSBTeW5jTGFuZToKICAgICAgICAgICAgICBjYXNlIElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgICAgY2FzZSBJbnB1dENvbnRpbnVvdXNMYW5lOgogICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRUaW1lICsgMjUwOwogICAgICAgICAgICAgIGNhc2UgRGVmYXVsdEh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgICAgY2FzZSBEZWZhdWx0TGFuZToKICAgICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25IeWRyYXRpb25MYW5lOgogICAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxOgogICAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUyOgogICAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUzOgogICAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU0OgogICAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU1OgogICAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU2OgogICAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU3OgogICAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU4OgogICAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU5OgogICAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMDoKICAgICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTE6CiAgICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEyOgogICAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMzoKICAgICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTQ6CiAgICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE1OgogICAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNjoKICAgICAgICAgICAgICAgIHJldHVybiBjdXJyZW50VGltZSArIDVlMzsKICAgICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTE6CiAgICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUyOgogICAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMzoKICAgICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTQ6CiAgICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmU1OgogICAgICAgICAgICAgICAgcmV0dXJuIE5vVGltZXN0YW1wOwogICAgICAgICAgICAgIGNhc2UgU2VsZWN0aXZlSHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgICBjYXNlIElkbGVIeWRyYXRpb25MYW5lOgogICAgICAgICAgICAgIGNhc2UgSWRsZUxhbmU6CiAgICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5MYW5lOgogICAgICAgICAgICAgICAgcmV0dXJuIE5vVGltZXN0YW1wOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJTaG91bGQgaGF2ZSBmb3VuZCBtYXRjaGluZyBsYW5lcy4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBOb1RpbWVzdGFtcDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbWFya1N0YXJ2ZWRMYW5lc0FzRXhwaXJlZChyb290MywgY3VycmVudFRpbWUpIHsKICAgICAgICAgICAgdmFyIHBlbmRpbmdMYW5lcyA9IHJvb3QzLnBlbmRpbmdMYW5lczsKICAgICAgICAgICAgdmFyIHN1c3BlbmRlZExhbmVzID0gcm9vdDMuc3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICAgIHZhciBwaW5nZWRMYW5lcyA9IHJvb3QzLnBpbmdlZExhbmVzOwogICAgICAgICAgICB2YXIgZXhwaXJhdGlvblRpbWVzID0gcm9vdDMuZXhwaXJhdGlvblRpbWVzOwogICAgICAgICAgICB2YXIgbGFuZXMgPSBwZW5kaW5nTGFuZXM7CiAgICAgICAgICAgIHdoaWxlIChsYW5lcyA+IDApIHsKICAgICAgICAgICAgICB2YXIgaW5kZXgzID0gcGlja0FyYml0cmFyeUxhbmVJbmRleChsYW5lcyk7CiAgICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MzsKICAgICAgICAgICAgICB2YXIgZXhwaXJhdGlvblRpbWUgPSBleHBpcmF0aW9uVGltZXNbaW5kZXgzXTsKICAgICAgICAgICAgICBpZiAoZXhwaXJhdGlvblRpbWUgPT09IE5vVGltZXN0YW1wKSB7CiAgICAgICAgICAgICAgICBpZiAoKGxhbmUgJiBzdXNwZW5kZWRMYW5lcykgPT09IE5vTGFuZXMgfHwgKGxhbmUgJiBwaW5nZWRMYW5lcykgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICAgICAgZXhwaXJhdGlvblRpbWVzW2luZGV4M10gPSBjb21wdXRlRXhwaXJhdGlvblRpbWUobGFuZSwgY3VycmVudFRpbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoZXhwaXJhdGlvblRpbWUgPD0gY3VycmVudFRpbWUpIHsKICAgICAgICAgICAgICAgIHJvb3QzLmV4cGlyZWRMYW5lcyB8PSBsYW5lOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0SGlnaGVzdFByaW9yaXR5UGVuZGluZ0xhbmVzKHJvb3QzKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lcyhyb290My5wZW5kaW5nTGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0TGFuZXNUb1JldHJ5U3luY2hyb25vdXNseU9uRXJyb3Iocm9vdDMpIHsKICAgICAgICAgICAgdmFyIGV2ZXJ5dGhpbmdCdXRPZmZzY3JlZW4gPSByb290My5wZW5kaW5nTGFuZXMgJiB+T2Zmc2NyZWVuTGFuZTsKICAgICAgICAgICAgaWYgKGV2ZXJ5dGhpbmdCdXRPZmZzY3JlZW4gIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICByZXR1cm4gZXZlcnl0aGluZ0J1dE9mZnNjcmVlbjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZXZlcnl0aGluZ0J1dE9mZnNjcmVlbiAmIE9mZnNjcmVlbkxhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gT2Zmc2NyZWVuTGFuZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzU3luY0xhbmUobGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIChsYW5lcyAmIFN5bmNMYW5lKSAhPT0gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzTm9uSWRsZVdvcmsobGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIChsYW5lcyAmIE5vbklkbGVMYW5lcykgIT09IE5vTGFuZXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpbmNsdWRlc09ubHlSZXRyaWVzKGxhbmVzKSB7CiAgICAgICAgICAgIHJldHVybiAobGFuZXMgJiBSZXRyeUxhbmVzKSA9PT0gbGFuZXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpbmNsdWRlc09ubHlOb25VcmdlbnRMYW5lcyhsYW5lcykgewogICAgICAgICAgICB2YXIgVXJnZW50TGFuZXMgPSBTeW5jTGFuZSB8IElucHV0Q29udGludW91c0xhbmUgfCBEZWZhdWx0TGFuZTsKICAgICAgICAgICAgcmV0dXJuIChsYW5lcyAmIFVyZ2VudExhbmVzKSA9PT0gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzT25seVRyYW5zaXRpb25zKGxhbmVzKSB7CiAgICAgICAgICAgIHJldHVybiAobGFuZXMgJiBUcmFuc2l0aW9uTGFuZXMpID09PSBsYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzQmxvY2tpbmdMYW5lKHJvb3QzLCBsYW5lcykgewogICAgICAgICAgICB2YXIgU3luY0RlZmF1bHRMYW5lcyA9IElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmUgfCBJbnB1dENvbnRpbnVvdXNMYW5lIHwgRGVmYXVsdEh5ZHJhdGlvbkxhbmUgfCBEZWZhdWx0TGFuZTsKICAgICAgICAgICAgcmV0dXJuIChsYW5lcyAmIFN5bmNEZWZhdWx0TGFuZXMpICE9PSBOb0xhbmVzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNFeHBpcmVkTGFuZShyb290MywgbGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIChsYW5lcyAmIHJvb3QzLmV4cGlyZWRMYW5lcykgIT09IE5vTGFuZXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpc1RyYW5zaXRpb25MYW5lKGxhbmUpIHsKICAgICAgICAgICAgcmV0dXJuIChsYW5lICYgVHJhbnNpdGlvbkxhbmVzKSAhPT0gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNsYWltTmV4dFRyYW5zaXRpb25MYW5lKCkgewogICAgICAgICAgICB2YXIgbGFuZSA9IG5leHRUcmFuc2l0aW9uTGFuZTsKICAgICAgICAgICAgbmV4dFRyYW5zaXRpb25MYW5lIDw8PSAxOwogICAgICAgICAgICBpZiAoKG5leHRUcmFuc2l0aW9uTGFuZSAmIFRyYW5zaXRpb25MYW5lcykgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICBuZXh0VHJhbnNpdGlvbkxhbmUgPSBUcmFuc2l0aW9uTGFuZTE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxhbmU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjbGFpbU5leHRSZXRyeUxhbmUoKSB7CiAgICAgICAgICAgIHZhciBsYW5lID0gbmV4dFJldHJ5TGFuZTsKICAgICAgICAgICAgbmV4dFJldHJ5TGFuZSA8PD0gMTsKICAgICAgICAgICAgaWYgKChuZXh0UmV0cnlMYW5lICYgUmV0cnlMYW5lcykgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICBuZXh0UmV0cnlMYW5lID0gUmV0cnlMYW5lMTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIGxhbmVzICYgLWxhbmVzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcGlja0FyYml0cmFyeUxhbmUobGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcGlja0FyYml0cmFyeUxhbmVJbmRleChsYW5lcykgewogICAgICAgICAgICByZXR1cm4gMzEgLSBjbHozMihsYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBsYW5lVG9JbmRleChsYW5lKSB7CiAgICAgICAgICAgIHJldHVybiBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmUpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNTb21lTGFuZShhMiwgYikgewogICAgICAgICAgICByZXR1cm4gKGEyICYgYikgIT09IE5vTGFuZXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpc1N1YnNldE9mTGFuZXMoc2V0NCwgc3Vic2V0KSB7CiAgICAgICAgICAgIHJldHVybiAoc2V0NCAmIHN1YnNldCkgPT09IHN1YnNldDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG1lcmdlTGFuZXMoYTIsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGEyIHwgYjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlbW92ZUxhbmVzKHNldDQsIHN1YnNldCkgewogICAgICAgICAgICByZXR1cm4gc2V0NCAmIH5zdWJzZXQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpbnRlcnNlY3RMYW5lcyhhMiwgYikgewogICAgICAgICAgICByZXR1cm4gYTIgJiBiOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbGFuZVRvTGFuZXMobGFuZSkgewogICAgICAgICAgICByZXR1cm4gbGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGhpZ2hlclByaW9yaXR5TGFuZShhMiwgYikgewogICAgICAgICAgICByZXR1cm4gYTIgIT09IE5vTGFuZSAmJiBhMiA8IGIgPyBhMiA6IGI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVMYW5lTWFwKGluaXRpYWwpIHsKICAgICAgICAgICAgdmFyIGxhbmVNYXAgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBUb3RhbExhbmVzOyBpKyspIHsKICAgICAgICAgICAgICBsYW5lTWFwLnB1c2goaW5pdGlhbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxhbmVNYXA7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtYXJrUm9vdFVwZGF0ZWQocm9vdDMsIHVwZGF0ZUxhbmUsIGV2ZW50VGltZSkgewogICAgICAgICAgICByb290My5wZW5kaW5nTGFuZXMgfD0gdXBkYXRlTGFuZTsKICAgICAgICAgICAgaWYgKHVwZGF0ZUxhbmUgIT09IElkbGVMYW5lKSB7CiAgICAgICAgICAgICAgcm9vdDMuc3VzcGVuZGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICAgIHJvb3QzLnBpbmdlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZXZlbnRUaW1lcyA9IHJvb3QzLmV2ZW50VGltZXM7CiAgICAgICAgICAgIHZhciBpbmRleDMgPSBsYW5lVG9JbmRleCh1cGRhdGVMYW5lKTsKICAgICAgICAgICAgZXZlbnRUaW1lc1tpbmRleDNdID0gZXZlbnRUaW1lOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RTdXNwZW5kZWQocm9vdDMsIHN1c3BlbmRlZExhbmVzKSB7CiAgICAgICAgICAgIHJvb3QzLnN1c3BlbmRlZExhbmVzIHw9IHN1c3BlbmRlZExhbmVzOwogICAgICAgICAgICByb290My5waW5nZWRMYW5lcyAmPSB+c3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICAgIHZhciBleHBpcmF0aW9uVGltZXMgPSByb290My5leHBpcmF0aW9uVGltZXM7CiAgICAgICAgICAgIHZhciBsYW5lcyA9IHN1c3BlbmRlZExhbmVzOwogICAgICAgICAgICB3aGlsZSAobGFuZXMgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIGluZGV4MyA9IHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpOwogICAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDM7CiAgICAgICAgICAgICAgZXhwaXJhdGlvblRpbWVzW2luZGV4M10gPSBOb1RpbWVzdGFtcDsKICAgICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RQaW5nZWQocm9vdDMsIHBpbmdlZExhbmVzLCBldmVudFRpbWUpIHsKICAgICAgICAgICAgcm9vdDMucGluZ2VkTGFuZXMgfD0gcm9vdDMuc3VzcGVuZGVkTGFuZXMgJiBwaW5nZWRMYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG1hcmtSb290RmluaXNoZWQocm9vdDMsIHJlbWFpbmluZ0xhbmVzKSB7CiAgICAgICAgICAgIHZhciBub0xvbmdlclBlbmRpbmdMYW5lcyA9IHJvb3QzLnBlbmRpbmdMYW5lcyAmIH5yZW1haW5pbmdMYW5lczsKICAgICAgICAgICAgcm9vdDMucGVuZGluZ0xhbmVzID0gcmVtYWluaW5nTGFuZXM7CiAgICAgICAgICAgIHJvb3QzLnN1c3BlbmRlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgcm9vdDMucGluZ2VkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICByb290My5leHBpcmVkTGFuZXMgJj0gcmVtYWluaW5nTGFuZXM7CiAgICAgICAgICAgIHJvb3QzLm11dGFibGVSZWFkTGFuZXMgJj0gcmVtYWluaW5nTGFuZXM7CiAgICAgICAgICAgIHJvb3QzLmVudGFuZ2xlZExhbmVzICY9IHJlbWFpbmluZ0xhbmVzOwogICAgICAgICAgICB2YXIgZW50YW5nbGVtZW50cyA9IHJvb3QzLmVudGFuZ2xlbWVudHM7CiAgICAgICAgICAgIHZhciBldmVudFRpbWVzID0gcm9vdDMuZXZlbnRUaW1lczsKICAgICAgICAgICAgdmFyIGV4cGlyYXRpb25UaW1lcyA9IHJvb3QzLmV4cGlyYXRpb25UaW1lczsKICAgICAgICAgICAgdmFyIGxhbmVzID0gbm9Mb25nZXJQZW5kaW5nTGFuZXM7CiAgICAgICAgICAgIHdoaWxlIChsYW5lcyA+IDApIHsKICAgICAgICAgICAgICB2YXIgaW5kZXgzID0gcGlja0FyYml0cmFyeUxhbmVJbmRleChsYW5lcyk7CiAgICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MzsKICAgICAgICAgICAgICBlbnRhbmdsZW1lbnRzW2luZGV4M10gPSBOb0xhbmVzOwogICAgICAgICAgICAgIGV2ZW50VGltZXNbaW5kZXgzXSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgICAgIGV4cGlyYXRpb25UaW1lc1tpbmRleDNdID0gTm9UaW1lc3RhbXA7CiAgICAgICAgICAgICAgbGFuZXMgJj0gfmxhbmU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG1hcmtSb290RW50YW5nbGVkKHJvb3QzLCBlbnRhbmdsZWRMYW5lcykgewogICAgICAgICAgICB2YXIgcm9vdEVudGFuZ2xlZExhbmVzID0gcm9vdDMuZW50YW5nbGVkTGFuZXMgfD0gZW50YW5nbGVkTGFuZXM7CiAgICAgICAgICAgIHZhciBlbnRhbmdsZW1lbnRzID0gcm9vdDMuZW50YW5nbGVtZW50czsKICAgICAgICAgICAgdmFyIGxhbmVzID0gcm9vdEVudGFuZ2xlZExhbmVzOwogICAgICAgICAgICB3aGlsZSAobGFuZXMpIHsKICAgICAgICAgICAgICB2YXIgaW5kZXgzID0gcGlja0FyYml0cmFyeUxhbmVJbmRleChsYW5lcyk7CiAgICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MzsKICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAvLyBJcyB0aGlzIG9uZSBvZiB0aGUgbmV3bHkgZW50YW5nbGVkIGxhbmVzPwogICAgICAgICAgICAgICAgbGFuZSAmIGVudGFuZ2xlZExhbmVzIHwgLy8gSXMgdGhpcyBsYW5lIHRyYW5zaXRpdmVseSBlbnRhbmdsZWQgd2l0aCB0aGUgbmV3bHkgZW50YW5nbGVkIGxhbmVzPwogICAgICAgICAgICAgICAgZW50YW5nbGVtZW50c1tpbmRleDNdICYgZW50YW5nbGVkTGFuZXMKICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgIGVudGFuZ2xlbWVudHNbaW5kZXgzXSB8PSBlbnRhbmdsZWRMYW5lczsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbGFuZXMgJj0gfmxhbmU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldEJ1bXBlZExhbmVGb3JIeWRyYXRpb24ocm9vdDMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgICB2YXIgcmVuZGVyTGFuZSA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmUocmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgdmFyIGxhbmU7CiAgICAgICAgICAgIHN3aXRjaCAocmVuZGVyTGFuZSkgewogICAgICAgICAgICAgIGNhc2UgSW5wdXRDb250aW51b3VzTGFuZToKICAgICAgICAgICAgICAgIGxhbmUgPSBJbnB1dENvbnRpbnVvdXNIeWRyYXRpb25MYW5lOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBEZWZhdWx0TGFuZToKICAgICAgICAgICAgICAgIGxhbmUgPSBEZWZhdWx0SHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxOgogICAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUyOgogICAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUzOgogICAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU0OgogICAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU1OgogICAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU2OgogICAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU3OgogICAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU4OgogICAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU5OgogICAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMDoKICAgICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTE6CiAgICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEyOgogICAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMzoKICAgICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTQ6CiAgICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE1OgogICAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNjoKICAgICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTE6CiAgICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUyOgogICAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMzoKICAgICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTQ6CiAgICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmU1OgogICAgICAgICAgICAgICAgbGFuZSA9IFRyYW5zaXRpb25IeWRyYXRpb25MYW5lOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBJZGxlTGFuZToKICAgICAgICAgICAgICAgIGxhbmUgPSBJZGxlSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBsYW5lID0gTm9MYW5lOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKChsYW5lICYgKHJvb3QzLnN1c3BlbmRlZExhbmVzIHwgcmVuZGVyTGFuZXMyKSkgIT09IE5vTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiBOb0xhbmU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxhbmU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBhZGRGaWJlclRvTGFuZXNNYXAocm9vdDMsIGZpYmVyLCBsYW5lcykgewogICAgICAgICAgICBpZiAoIWlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwZW5kaW5nVXBkYXRlcnNMYW5lTWFwID0gcm9vdDMucGVuZGluZ1VwZGF0ZXJzTGFuZU1hcDsKICAgICAgICAgICAgd2hpbGUgKGxhbmVzID4gMCkgewogICAgICAgICAgICAgIHZhciBpbmRleDMgPSBsYW5lVG9JbmRleChsYW5lcyk7CiAgICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MzsKICAgICAgICAgICAgICB2YXIgdXBkYXRlcnMgPSBwZW5kaW5nVXBkYXRlcnNMYW5lTWFwW2luZGV4M107CiAgICAgICAgICAgICAgdXBkYXRlcnMuYWRkKGZpYmVyKTsKICAgICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbW92ZVBlbmRpbmdGaWJlcnNUb01lbW9pemVkKHJvb3QzLCBsYW5lcykgewogICAgICAgICAgICBpZiAoIWlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwZW5kaW5nVXBkYXRlcnNMYW5lTWFwID0gcm9vdDMucGVuZGluZ1VwZGF0ZXJzTGFuZU1hcDsKICAgICAgICAgICAgdmFyIG1lbW9pemVkVXBkYXRlcnMgPSByb290My5tZW1vaXplZFVwZGF0ZXJzOwogICAgICAgICAgICB3aGlsZSAobGFuZXMgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIGluZGV4MyA9IGxhbmVUb0luZGV4KGxhbmVzKTsKICAgICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgzOwogICAgICAgICAgICAgIHZhciB1cGRhdGVycyA9IHBlbmRpbmdVcGRhdGVyc0xhbmVNYXBbaW5kZXgzXTsKICAgICAgICAgICAgICBpZiAodXBkYXRlcnMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgIHVwZGF0ZXJzLmZvckVhY2goZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICAgICAgaWYgKGFsdGVybmF0ZSA9PT0gbnVsbCB8fCAhbWVtb2l6ZWRVcGRhdGVycy5oYXMoYWx0ZXJuYXRlKSkgewogICAgICAgICAgICAgICAgICAgIG1lbW9pemVkVXBkYXRlcnMuYWRkKGZpYmVyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB1cGRhdGVycy5jbGVhcigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0VHJhbnNpdGlvbnNGb3JMYW5lcyhyb290MywgbGFuZXMpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgRGlzY3JldGVFdmVudFByaW9yaXR5ID0gU3luY0xhbmU7CiAgICAgICAgICB2YXIgQ29udGludW91c0V2ZW50UHJpb3JpdHkgPSBJbnB1dENvbnRpbnVvdXNMYW5lOwogICAgICAgICAgdmFyIERlZmF1bHRFdmVudFByaW9yaXR5ID0gRGVmYXVsdExhbmU7CiAgICAgICAgICB2YXIgSWRsZUV2ZW50UHJpb3JpdHkgPSBJZGxlTGFuZTsKICAgICAgICAgIHZhciBjdXJyZW50VXBkYXRlUHJpb3JpdHkgPSBOb0xhbmU7CiAgICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKSB7CiAgICAgICAgICAgIHJldHVybiBjdXJyZW50VXBkYXRlUHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkobmV3UHJpb3JpdHkpIHsKICAgICAgICAgICAgY3VycmVudFVwZGF0ZVByaW9yaXR5ID0gbmV3UHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBydW5XaXRoUHJpb3JpdHkocHJpb3JpdHksIGZuKSB7CiAgICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gY3VycmVudFVwZGF0ZVByaW9yaXR5OwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGN1cnJlbnRVcGRhdGVQcmlvcml0eSA9IHByaW9yaXR5OwogICAgICAgICAgICAgIHJldHVybiBmbigpOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIGN1cnJlbnRVcGRhdGVQcmlvcml0eSA9IHByZXZpb3VzUHJpb3JpdHk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGhpZ2hlckV2ZW50UHJpb3JpdHkoYTIsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGEyICE9PSAwICYmIGEyIDwgYiA/IGEyIDogYjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGxvd2VyRXZlbnRQcmlvcml0eShhMiwgYikgewogICAgICAgICAgICByZXR1cm4gYTIgPT09IDAgfHwgYTIgPiBiID8gYTIgOiBiOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaXNIaWdoZXJFdmVudFByaW9yaXR5KGEyLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBhMiAhPT0gMCAmJiBhMiA8IGI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBsYW5lc1RvRXZlbnRQcmlvcml0eShsYW5lcykgewogICAgICAgICAgICB2YXIgbGFuZSA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobGFuZXMpOwogICAgICAgICAgICBpZiAoIWlzSGlnaGVyRXZlbnRQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHksIGxhbmUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIERpc2NyZXRlRXZlbnRQcmlvcml0eTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWlzSGlnaGVyRXZlbnRQcmlvcml0eShDb250aW51b3VzRXZlbnRQcmlvcml0eSwgbGFuZSkpIHsKICAgICAgICAgICAgICByZXR1cm4gQ29udGludW91c0V2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluY2x1ZGVzTm9uSWRsZVdvcmsobGFuZSkpIHsKICAgICAgICAgICAgICByZXR1cm4gRGVmYXVsdEV2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIElkbGVFdmVudFByaW9yaXR5OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaXNSb290RGVoeWRyYXRlZChyb290MykgewogICAgICAgICAgICB2YXIgY3VycmVudFN0YXRlID0gcm9vdDMuY3VycmVudC5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICByZXR1cm4gY3VycmVudFN0YXRlLmlzRGVoeWRyYXRlZDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBfYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uOwogICAgICAgICAgZnVuY3Rpb24gc2V0QXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uKGZuKSB7CiAgICAgICAgICAgIF9hdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24gPSBmbjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRTeW5jaHJvbm91c0h5ZHJhdGlvbihmaWJlcikgewogICAgICAgICAgICBfYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uKGZpYmVyKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbjsKICAgICAgICAgIGZ1bmN0aW9uIHNldEF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uKGZuKSB7CiAgICAgICAgICAgIGF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uID0gZm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgYXR0ZW1wdEh5ZHJhdGlvbkF0Q3VycmVudFByaW9yaXR5OwogICAgICAgICAgZnVuY3Rpb24gc2V0QXR0ZW1wdEh5ZHJhdGlvbkF0Q3VycmVudFByaW9yaXR5KGZuKSB7CiAgICAgICAgICAgIGF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eSA9IGZuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSQxOwogICAgICAgICAgZnVuY3Rpb24gc2V0R2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KGZuKSB7CiAgICAgICAgICAgIGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSQxID0gZm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgYXR0ZW1wdEh5ZHJhdGlvbkF0UHJpb3JpdHk7CiAgICAgICAgICBmdW5jdGlvbiBzZXRBdHRlbXB0SHlkcmF0aW9uQXRQcmlvcml0eShmbikgewogICAgICAgICAgICBhdHRlbXB0SHlkcmF0aW9uQXRQcmlvcml0eSA9IGZuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGhhc1NjaGVkdWxlZFJlcGxheUF0dGVtcHQgPSBmYWxzZTsKICAgICAgICAgIHZhciBxdWV1ZWREaXNjcmV0ZUV2ZW50cyA9IFtdOwogICAgICAgICAgdmFyIHF1ZXVlZEZvY3VzID0gbnVsbDsKICAgICAgICAgIHZhciBxdWV1ZWREcmFnID0gbnVsbDsKICAgICAgICAgIHZhciBxdWV1ZWRNb3VzZSA9IG51bGw7CiAgICAgICAgICB2YXIgcXVldWVkUG9pbnRlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgICAgdmFyIHF1ZXVlZFBvaW50ZXJDYXB0dXJlcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgICB2YXIgcXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzID0gW107CiAgICAgICAgICB2YXIgZGlzY3JldGVSZXBsYXlhYmxlRXZlbnRzID0gWwogICAgICAgICAgICAibW91c2Vkb3duIiwKICAgICAgICAgICAgIm1vdXNldXAiLAogICAgICAgICAgICAidG91Y2hjYW5jZWwiLAogICAgICAgICAgICAidG91Y2hlbmQiLAogICAgICAgICAgICAidG91Y2hzdGFydCIsCiAgICAgICAgICAgICJhdXhjbGljayIsCiAgICAgICAgICAgICJkYmxjbGljayIsCiAgICAgICAgICAgICJwb2ludGVyY2FuY2VsIiwKICAgICAgICAgICAgInBvaW50ZXJkb3duIiwKICAgICAgICAgICAgInBvaW50ZXJ1cCIsCiAgICAgICAgICAgICJkcmFnZW5kIiwKICAgICAgICAgICAgImRyYWdzdGFydCIsCiAgICAgICAgICAgICJkcm9wIiwKICAgICAgICAgICAgImNvbXBvc2l0aW9uZW5kIiwKICAgICAgICAgICAgImNvbXBvc2l0aW9uc3RhcnQiLAogICAgICAgICAgICAia2V5ZG93biIsCiAgICAgICAgICAgICJrZXlwcmVzcyIsCiAgICAgICAgICAgICJrZXl1cCIsCiAgICAgICAgICAgICJpbnB1dCIsCiAgICAgICAgICAgICJ0ZXh0SW5wdXQiLAogICAgICAgICAgICAvLyBJbnRlbnRpb25hbGx5IGNhbWVsQ2FzZQogICAgICAgICAgICAiY29weSIsCiAgICAgICAgICAgICJjdXQiLAogICAgICAgICAgICAicGFzdGUiLAogICAgICAgICAgICAiY2xpY2siLAogICAgICAgICAgICAiY2hhbmdlIiwKICAgICAgICAgICAgImNvbnRleHRtZW51IiwKICAgICAgICAgICAgInJlc2V0IiwKICAgICAgICAgICAgInN1Ym1pdCIKICAgICAgICAgIF07CiAgICAgICAgICBmdW5jdGlvbiBpc0Rpc2NyZXRlRXZlbnRUaGF0UmVxdWlyZXNIeWRyYXRpb24oZXZlbnRUeXBlKSB7CiAgICAgICAgICAgIHJldHVybiBkaXNjcmV0ZVJlcGxheWFibGVFdmVudHMuaW5kZXhPZihldmVudFR5cGUpID4gLTE7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVRdWV1ZWRSZXBsYXlhYmxlRXZlbnQoYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBibG9ja2VkT24sCiAgICAgICAgICAgICAgZG9tRXZlbnROYW1lLAogICAgICAgICAgICAgIGV2ZW50U3lzdGVtRmxhZ3MsCiAgICAgICAgICAgICAgbmF0aXZlRXZlbnQsCiAgICAgICAgICAgICAgdGFyZ2V0Q29udGFpbmVyczogW3RhcmdldENvbnRhaW5lcl0KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNsZWFySWZDb250aW51b3VzRXZlbnQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICAgIGNhc2UgImZvY3VzaW4iOgogICAgICAgICAgICAgIGNhc2UgImZvY3Vzb3V0IjoKICAgICAgICAgICAgICAgIHF1ZXVlZEZvY3VzID0gbnVsbDsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgImRyYWdlbnRlciI6CiAgICAgICAgICAgICAgY2FzZSAiZHJhZ2xlYXZlIjoKICAgICAgICAgICAgICAgIHF1ZXVlZERyYWcgPSBudWxsOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAibW91c2VvdmVyIjoKICAgICAgICAgICAgICBjYXNlICJtb3VzZW91dCI6CiAgICAgICAgICAgICAgICBxdWV1ZWRNb3VzZSA9IG51bGw7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJwb2ludGVyb3ZlciI6CiAgICAgICAgICAgICAgY2FzZSAicG9pbnRlcm91dCI6IHsKICAgICAgICAgICAgICAgIHZhciBwb2ludGVySWQgPSBuYXRpdmVFdmVudC5wb2ludGVySWQ7CiAgICAgICAgICAgICAgICBxdWV1ZWRQb2ludGVycy5kZWxldGUocG9pbnRlcklkKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlICJnb3Rwb2ludGVyY2FwdHVyZSI6CiAgICAgICAgICAgICAgY2FzZSAibG9zdHBvaW50ZXJjYXB0dXJlIjogewogICAgICAgICAgICAgICAgdmFyIF9wb2ludGVySWQgPSBuYXRpdmVFdmVudC5wb2ludGVySWQ7CiAgICAgICAgICAgICAgICBxdWV1ZWRQb2ludGVyQ2FwdHVyZXMuZGVsZXRlKF9wb2ludGVySWQpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBhY2N1bXVsYXRlT3JDcmVhdGVDb250aW51b3VzUXVldWVkUmVwbGF5YWJsZUV2ZW50KGV4aXN0aW5nUXVldWVkRXZlbnQsIGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICAgIGlmIChleGlzdGluZ1F1ZXVlZEV2ZW50ID09PSBudWxsIHx8IGV4aXN0aW5nUXVldWVkRXZlbnQubmF0aXZlRXZlbnQgIT09IG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICAgICAgdmFyIHF1ZXVlZEV2ZW50ID0gY3JlYXRlUXVldWVkUmVwbGF5YWJsZUV2ZW50KGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgICBpZiAoYmxvY2tlZE9uICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgX2ZpYmVyMiA9IGdldEluc3RhbmNlRnJvbU5vZGUoYmxvY2tlZE9uKTsKICAgICAgICAgICAgICAgIGlmIChfZmliZXIyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uKF9maWJlcjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcXVldWVkRXZlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZXhpc3RpbmdRdWV1ZWRFdmVudC5ldmVudFN5c3RlbUZsYWdzIHw9IGV2ZW50U3lzdGVtRmxhZ3M7CiAgICAgICAgICAgIHZhciB0YXJnZXRDb250YWluZXJzID0gZXhpc3RpbmdRdWV1ZWRFdmVudC50YXJnZXRDb250YWluZXJzOwogICAgICAgICAgICBpZiAodGFyZ2V0Q29udGFpbmVyICE9PSBudWxsICYmIHRhcmdldENvbnRhaW5lcnMuaW5kZXhPZih0YXJnZXRDb250YWluZXIpID09PSAtMSkgewogICAgICAgICAgICAgIHRhcmdldENvbnRhaW5lcnMucHVzaCh0YXJnZXRDb250YWluZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBleGlzdGluZ1F1ZXVlZEV2ZW50OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcXVldWVJZkNvbnRpbnVvdXNFdmVudChibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICAgIGNhc2UgImZvY3VzaW4iOiB7CiAgICAgICAgICAgICAgICB2YXIgZm9jdXNFdmVudCA9IG5hdGl2ZUV2ZW50OwogICAgICAgICAgICAgICAgcXVldWVkRm9jdXMgPSBhY2N1bXVsYXRlT3JDcmVhdGVDb250aW51b3VzUXVldWVkUmVwbGF5YWJsZUV2ZW50KHF1ZXVlZEZvY3VzLCBibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBmb2N1c0V2ZW50KTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlICJkcmFnZW50ZXIiOiB7CiAgICAgICAgICAgICAgICB2YXIgZHJhZ0V2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgICBxdWV1ZWREcmFnID0gYWNjdW11bGF0ZU9yQ3JlYXRlQ29udGludW91c1F1ZXVlZFJlcGxheWFibGVFdmVudChxdWV1ZWREcmFnLCBibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBkcmFnRXZlbnQpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgIm1vdXNlb3ZlciI6IHsKICAgICAgICAgICAgICAgIHZhciBtb3VzZUV2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgICBxdWV1ZWRNb3VzZSA9IGFjY3VtdWxhdGVPckNyZWF0ZUNvbnRpbnVvdXNRdWV1ZWRSZXBsYXlhYmxlRXZlbnQocXVldWVkTW91c2UsIGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG1vdXNlRXZlbnQpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgInBvaW50ZXJvdmVyIjogewogICAgICAgICAgICAgICAgdmFyIHBvaW50ZXJFdmVudCA9IG5hdGl2ZUV2ZW50OwogICAgICAgICAgICAgICAgdmFyIHBvaW50ZXJJZCA9IHBvaW50ZXJFdmVudC5wb2ludGVySWQ7CiAgICAgICAgICAgICAgICBxdWV1ZWRQb2ludGVycy5zZXQocG9pbnRlcklkLCBhY2N1bXVsYXRlT3JDcmVhdGVDb250aW51b3VzUXVldWVkUmVwbGF5YWJsZUV2ZW50KHF1ZXVlZFBvaW50ZXJzLmdldChwb2ludGVySWQpIHx8IG51bGwsIGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIHBvaW50ZXJFdmVudCkpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgImdvdHBvaW50ZXJjYXB0dXJlIjogewogICAgICAgICAgICAgICAgdmFyIF9wb2ludGVyRXZlbnQgPSBuYXRpdmVFdmVudDsKICAgICAgICAgICAgICAgIHZhciBfcG9pbnRlcklkMiA9IF9wb2ludGVyRXZlbnQucG9pbnRlcklkOwogICAgICAgICAgICAgICAgcXVldWVkUG9pbnRlckNhcHR1cmVzLnNldChfcG9pbnRlcklkMiwgYWNjdW11bGF0ZU9yQ3JlYXRlQ29udGludW91c1F1ZXVlZFJlcGxheWFibGVFdmVudChxdWV1ZWRQb2ludGVyQ2FwdHVyZXMuZ2V0KF9wb2ludGVySWQyKSB8fCBudWxsLCBibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBfcG9pbnRlckV2ZW50KSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0KHF1ZXVlZFRhcmdldCkgewogICAgICAgICAgICB2YXIgdGFyZ2V0SW5zdCA9IGdldENsb3Nlc3RJbnN0YW5jZUZyb21Ob2RlKHF1ZXVlZFRhcmdldC50YXJnZXQpOwogICAgICAgICAgICBpZiAodGFyZ2V0SW5zdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBuZWFyZXN0TW91bnRlZCA9IGdldE5lYXJlc3RNb3VudGVkRmliZXIodGFyZ2V0SW5zdCk7CiAgICAgICAgICAgICAgaWYgKG5lYXJlc3RNb3VudGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgdGFnID0gbmVhcmVzdE1vdW50ZWQudGFnOwogICAgICAgICAgICAgICAgaWYgKHRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZ2V0U3VzcGVuc2VJbnN0YW5jZUZyb21GaWJlcihuZWFyZXN0TW91bnRlZCk7CiAgICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHF1ZXVlZFRhcmdldC5ibG9ja2VkT24gPSBpbnN0YW5jZTsKICAgICAgICAgICAgICAgICAgICBhdHRlbXB0SHlkcmF0aW9uQXRQcmlvcml0eShxdWV1ZWRUYXJnZXQucHJpb3JpdHksIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgYXR0ZW1wdEh5ZHJhdGlvbkF0Q3VycmVudFByaW9yaXR5KG5lYXJlc3RNb3VudGVkKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBuZWFyZXN0TW91bnRlZC5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIGlmIChpc1Jvb3REZWh5ZHJhdGVkKHJvb3QzKSkgewogICAgICAgICAgICAgICAgICAgIHF1ZXVlZFRhcmdldC5ibG9ja2VkT24gPSBnZXRDb250YWluZXJGcm9tRmliZXIobmVhcmVzdE1vdW50ZWQpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBxdWV1ZWRUYXJnZXQuYmxvY2tlZE9uID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHF1ZXVlRXhwbGljaXRIeWRyYXRpb25UYXJnZXQodGFyZ2V0KSB7CiAgICAgICAgICAgIHZhciB1cGRhdGVQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSQxKCk7CiAgICAgICAgICAgIHZhciBxdWV1ZWRUYXJnZXQgPSB7CiAgICAgICAgICAgICAgYmxvY2tlZE9uOiBudWxsLAogICAgICAgICAgICAgIHRhcmdldCwKICAgICAgICAgICAgICBwcmlvcml0eTogdXBkYXRlUHJpb3JpdHkKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIGkgPSAwOwogICAgICAgICAgICBmb3IgKDsgaSA8IHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGlmICghaXNIaWdoZXJFdmVudFByaW9yaXR5KHVwZGF0ZVByaW9yaXR5LCBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHNbaV0ucHJpb3JpdHkpKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzLnNwbGljZShpLCAwLCBxdWV1ZWRUYXJnZXQpOwogICAgICAgICAgICBpZiAoaSA9PT0gMCkgewogICAgICAgICAgICAgIGF0dGVtcHRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldChxdWV1ZWRUYXJnZXQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50KHF1ZXVlZEV2ZW50KSB7CiAgICAgICAgICAgIGlmIChxdWV1ZWRFdmVudC5ibG9ja2VkT24gIT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRhcmdldENvbnRhaW5lcnMgPSBxdWV1ZWRFdmVudC50YXJnZXRDb250YWluZXJzOwogICAgICAgICAgICB3aGlsZSAodGFyZ2V0Q29udGFpbmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgdmFyIHRhcmdldENvbnRhaW5lciA9IHRhcmdldENvbnRhaW5lcnNbMF07CiAgICAgICAgICAgICAgdmFyIG5leHRCbG9ja2VkT24gPSBmaW5kSW5zdGFuY2VCbG9ja2luZ0V2ZW50KHF1ZXVlZEV2ZW50LmRvbUV2ZW50TmFtZSwgcXVldWVkRXZlbnQuZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBxdWV1ZWRFdmVudC5uYXRpdmVFdmVudCk7CiAgICAgICAgICAgICAgaWYgKG5leHRCbG9ja2VkT24gPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdmFyIG5hdGl2ZUV2ZW50ID0gcXVldWVkRXZlbnQubmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgICAgIHZhciBuYXRpdmVFdmVudENsb25lID0gbmV3IG5hdGl2ZUV2ZW50LmNvbnN0cnVjdG9yKG5hdGl2ZUV2ZW50LnR5cGUsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgICAgICAgc2V0UmVwbGF5aW5nRXZlbnQobmF0aXZlRXZlbnRDbG9uZSk7CiAgICAgICAgICAgICAgICAgIG5hdGl2ZUV2ZW50LnRhcmdldC5kaXNwYXRjaEV2ZW50KG5hdGl2ZUV2ZW50Q2xvbmUpOwogICAgICAgICAgICAgICAgICByZXNldFJlcGxheWluZ0V2ZW50KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBfZmliZXIzID0gZ2V0SW5zdGFuY2VGcm9tTm9kZShuZXh0QmxvY2tlZE9uKTsKICAgICAgICAgICAgICAgIGlmIChfZmliZXIzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uKF9maWJlcjMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcXVldWVkRXZlbnQuYmxvY2tlZE9uID0gbmV4dEJsb2NrZWRPbjsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGFyZ2V0Q29udGFpbmVycy5zaGlmdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudEluTWFwKHF1ZXVlZEV2ZW50LCBrZXksIG1hcCkgewogICAgICAgICAgICBpZiAoYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudChxdWV1ZWRFdmVudCkpIHsKICAgICAgICAgICAgICBtYXAuZGVsZXRlKGtleSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlcGxheVVuYmxvY2tlZEV2ZW50cygpIHsKICAgICAgICAgICAgaGFzU2NoZWR1bGVkUmVwbGF5QXR0ZW1wdCA9IGZhbHNlOwogICAgICAgICAgICBpZiAocXVldWVkRm9jdXMgIT09IG51bGwgJiYgYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudChxdWV1ZWRGb2N1cykpIHsKICAgICAgICAgICAgICBxdWV1ZWRGb2N1cyA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHF1ZXVlZERyYWcgIT09IG51bGwgJiYgYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudChxdWV1ZWREcmFnKSkgewogICAgICAgICAgICAgIHF1ZXVlZERyYWcgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChxdWV1ZWRNb3VzZSAhPT0gbnVsbCAmJiBhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50KHF1ZXVlZE1vdXNlKSkgewogICAgICAgICAgICAgIHF1ZXVlZE1vdXNlID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBxdWV1ZWRQb2ludGVycy5mb3JFYWNoKGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnRJbk1hcCk7CiAgICAgICAgICAgIHF1ZXVlZFBvaW50ZXJDYXB0dXJlcy5mb3JFYWNoKGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnRJbk1hcCk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZUNhbGxiYWNrSWZVbmJsb2NrZWQocXVldWVkRXZlbnQsIHVuYmxvY2tlZCkgewogICAgICAgICAgICBpZiAocXVldWVkRXZlbnQuYmxvY2tlZE9uID09PSB1bmJsb2NrZWQpIHsKICAgICAgICAgICAgICBxdWV1ZWRFdmVudC5ibG9ja2VkT24gPSBudWxsOwogICAgICAgICAgICAgIGlmICghaGFzU2NoZWR1bGVkUmVwbGF5QXR0ZW1wdCkgewogICAgICAgICAgICAgICAgaGFzU2NoZWR1bGVkUmVwbGF5QXR0ZW1wdCA9IHRydWU7CiAgICAgICAgICAgICAgICBTY2hlZHVsZXIudW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjayhTY2hlZHVsZXIudW5zdGFibGVfTm9ybWFsUHJpb3JpdHksIHJlcGxheVVuYmxvY2tlZEV2ZW50cyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZXRyeUlmQmxvY2tlZE9uKHVuYmxvY2tlZCkgewogICAgICAgICAgICBpZiAocXVldWVkRGlzY3JldGVFdmVudHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2tJZlVuYmxvY2tlZChxdWV1ZWREaXNjcmV0ZUV2ZW50c1swXSwgdW5ibG9ja2VkKTsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IHF1ZXVlZERpc2NyZXRlRXZlbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgcXVldWVkRXZlbnQgPSBxdWV1ZWREaXNjcmV0ZUV2ZW50c1tpXTsKICAgICAgICAgICAgICAgIGlmIChxdWV1ZWRFdmVudC5ibG9ja2VkT24gPT09IHVuYmxvY2tlZCkgewogICAgICAgICAgICAgICAgICBxdWV1ZWRFdmVudC5ibG9ja2VkT24gPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocXVldWVkRm9jdXMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzY2hlZHVsZUNhbGxiYWNrSWZVbmJsb2NrZWQocXVldWVkRm9jdXMsIHVuYmxvY2tlZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHF1ZXVlZERyYWcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzY2hlZHVsZUNhbGxiYWNrSWZVbmJsb2NrZWQocXVldWVkRHJhZywgdW5ibG9ja2VkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocXVldWVkTW91c2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzY2hlZHVsZUNhbGxiYWNrSWZVbmJsb2NrZWQocXVldWVkTW91c2UsIHVuYmxvY2tlZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHVuYmxvY2sgPSBmdW5jdGlvbihxdWV1ZWRFdmVudDIpIHsKICAgICAgICAgICAgICByZXR1cm4gc2NoZWR1bGVDYWxsYmFja0lmVW5ibG9ja2VkKHF1ZXVlZEV2ZW50MiwgdW5ibG9ja2VkKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcXVldWVkUG9pbnRlcnMuZm9yRWFjaCh1bmJsb2NrKTsKICAgICAgICAgICAgcXVldWVkUG9pbnRlckNhcHR1cmVzLmZvckVhY2godW5ibG9jayk7CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHMubGVuZ3RoOyBfaSsrKSB7CiAgICAgICAgICAgICAgdmFyIHF1ZXVlZFRhcmdldCA9IHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0c1tfaV07CiAgICAgICAgICAgICAgaWYgKHF1ZXVlZFRhcmdldC5ibG9ja2VkT24gPT09IHVuYmxvY2tlZCkgewogICAgICAgICAgICAgICAgcXVldWVkVGFyZ2V0LmJsb2NrZWRPbiA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlIChxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHZhciBuZXh0RXhwbGljaXRUYXJnZXQgPSBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHNbMF07CiAgICAgICAgICAgICAgaWYgKG5leHRFeHBsaWNpdFRhcmdldC5ibG9ja2VkT24gIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhdHRlbXB0RXhwbGljaXRIeWRyYXRpb25UYXJnZXQobmV4dEV4cGxpY2l0VGFyZ2V0KTsKICAgICAgICAgICAgICAgIGlmIChuZXh0RXhwbGljaXRUYXJnZXQuYmxvY2tlZE9uID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0cy5zaGlmdCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50QmF0Y2hDb25maWc7CiAgICAgICAgICB2YXIgX2VuYWJsZWQgPSB0cnVlOwogICAgICAgICAgZnVuY3Rpb24gc2V0RW5hYmxlZChlbmFibGVkKSB7CiAgICAgICAgICAgIF9lbmFibGVkID0gISFlbmFibGVkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaXNFbmFibGVkKCkgewogICAgICAgICAgICByZXR1cm4gX2VuYWJsZWQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVFdmVudExpc3RlbmVyV3JhcHBlcldpdGhQcmlvcml0eSh0YXJnZXRDb250YWluZXIsIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncykgewogICAgICAgICAgICB2YXIgZXZlbnRQcmlvcml0eSA9IGdldEV2ZW50UHJpb3JpdHkoZG9tRXZlbnROYW1lKTsKICAgICAgICAgICAgdmFyIGxpc3RlbmVyV3JhcHBlcjsKICAgICAgICAgICAgc3dpdGNoIChldmVudFByaW9yaXR5KSB7CiAgICAgICAgICAgICAgY2FzZSBEaXNjcmV0ZUV2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICBsaXN0ZW5lcldyYXBwZXIgPSBkaXNwYXRjaERpc2NyZXRlRXZlbnQ7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIENvbnRpbnVvdXNFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgbGlzdGVuZXJXcmFwcGVyID0gZGlzcGF0Y2hDb250aW51b3VzRXZlbnQ7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIERlZmF1bHRFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBsaXN0ZW5lcldyYXBwZXIgPSBkaXNwYXRjaEV2ZW50MjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBsaXN0ZW5lcldyYXBwZXIuYmluZChudWxsLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcik7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaERpc2NyZXRlRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBjb250YWluZXIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb247CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb24gPSBudWxsOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICAgIGRpc3BhdGNoRXZlbnQyKGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgY29udGFpbmVyLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZGlzcGF0Y2hDb250aW51b3VzRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBjb250YWluZXIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb247CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb24gPSBudWxsOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShDb250aW51b3VzRXZlbnRQcmlvcml0eSk7CiAgICAgICAgICAgICAgZGlzcGF0Y2hFdmVudDIoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBjb250YWluZXIsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaEV2ZW50Mihkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgICAgaWYgKCFfZW5hYmxlZCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZGlzcGF0Y2hFdmVudFdpdGhFbmFibGVDYXB0dXJlUGhhc2VTZWxlY3RpdmVIeWRyYXRpb25XaXRob3V0RGlzY3JldGVFdmVudFJlcGxheShkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaEV2ZW50V2l0aEVuYWJsZUNhcHR1cmVQaGFzZVNlbGVjdGl2ZUh5ZHJhdGlvbldpdGhvdXREaXNjcmV0ZUV2ZW50UmVwbGF5KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgICB2YXIgYmxvY2tlZE9uID0gZmluZEluc3RhbmNlQmxvY2tpbmdFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgICBpZiAoYmxvY2tlZE9uID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZGlzcGF0Y2hFdmVudEZvclBsdWdpbkV2ZW50U3lzdGVtKGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgbmF0aXZlRXZlbnQsIHJldHVybl90YXJnZXRJbnN0LCB0YXJnZXRDb250YWluZXIpOwogICAgICAgICAgICAgIGNsZWFySWZDb250aW51b3VzRXZlbnQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChxdWV1ZUlmQ29udGludW91c0V2ZW50KGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KSkgewogICAgICAgICAgICAgIG5hdGl2ZUV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjbGVhcklmQ29udGludW91c0V2ZW50KGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgICBpZiAoZXZlbnRTeXN0ZW1GbGFncyAmIElTX0NBUFRVUkVfUEhBU0UgJiYgaXNEaXNjcmV0ZUV2ZW50VGhhdFJlcXVpcmVzSHlkcmF0aW9uKGRvbUV2ZW50TmFtZSkpIHsKICAgICAgICAgICAgICB3aGlsZSAoYmxvY2tlZE9uICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgZmliZXIgPSBnZXRJbnN0YW5jZUZyb21Ob2RlKGJsb2NrZWRPbik7CiAgICAgICAgICAgICAgICBpZiAoZmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uKGZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBuZXh0QmxvY2tlZE9uID0gZmluZEluc3RhbmNlQmxvY2tpbmdFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgICAgICAgaWYgKG5leHRCbG9ja2VkT24gPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZGlzcGF0Y2hFdmVudEZvclBsdWdpbkV2ZW50U3lzdGVtKGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgbmF0aXZlRXZlbnQsIHJldHVybl90YXJnZXRJbnN0LCB0YXJnZXRDb250YWluZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG5leHRCbG9ja2VkT24gPT09IGJsb2NrZWRPbikgewogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJsb2NrZWRPbiA9IG5leHRCbG9ja2VkT247CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChibG9ja2VkT24gIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG5hdGl2ZUV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlzcGF0Y2hFdmVudEZvclBsdWdpbkV2ZW50U3lzdGVtKGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgbmF0aXZlRXZlbnQsIG51bGwsIHRhcmdldENvbnRhaW5lcik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcmV0dXJuX3RhcmdldEluc3QgPSBudWxsOwogICAgICAgICAgZnVuY3Rpb24gZmluZEluc3RhbmNlQmxvY2tpbmdFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuX3RhcmdldEluc3QgPSBudWxsOwogICAgICAgICAgICB2YXIgbmF0aXZlRXZlbnRUYXJnZXQgPSBnZXRFdmVudFRhcmdldChuYXRpdmVFdmVudCk7CiAgICAgICAgICAgIHZhciB0YXJnZXRJbnN0ID0gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUobmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICBpZiAodGFyZ2V0SW5zdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBuZWFyZXN0TW91bnRlZCA9IGdldE5lYXJlc3RNb3VudGVkRmliZXIodGFyZ2V0SW5zdCk7CiAgICAgICAgICAgICAgaWYgKG5lYXJlc3RNb3VudGVkID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRJbnN0ID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHRhZyA9IG5lYXJlc3RNb3VudGVkLnRhZzsKICAgICAgICAgICAgICAgIGlmICh0YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGdldFN1c3BlbnNlSW5zdGFuY2VGcm9tRmliZXIobmVhcmVzdE1vdW50ZWQpOwogICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdGFyZ2V0SW5zdCA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gbmVhcmVzdE1vdW50ZWQuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBpZiAoaXNSb290RGVoeWRyYXRlZChyb290MykpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGFpbmVyRnJvbUZpYmVyKG5lYXJlc3RNb3VudGVkKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB0YXJnZXRJbnN0ID0gbnVsbDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobmVhcmVzdE1vdW50ZWQgIT09IHRhcmdldEluc3QpIHsKICAgICAgICAgICAgICAgICAgdGFyZ2V0SW5zdCA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybl90YXJnZXRJbnN0ID0gdGFyZ2V0SW5zdDsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRFdmVudFByaW9yaXR5KGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICAgIGNhc2UgImNhbmNlbCI6CiAgICAgICAgICAgICAgY2FzZSAiY2xpY2siOgogICAgICAgICAgICAgIGNhc2UgImNsb3NlIjoKICAgICAgICAgICAgICBjYXNlICJjb250ZXh0bWVudSI6CiAgICAgICAgICAgICAgY2FzZSAiY29weSI6CiAgICAgICAgICAgICAgY2FzZSAiY3V0IjoKICAgICAgICAgICAgICBjYXNlICJhdXhjbGljayI6CiAgICAgICAgICAgICAgY2FzZSAiZGJsY2xpY2siOgogICAgICAgICAgICAgIGNhc2UgImRyYWdlbmQiOgogICAgICAgICAgICAgIGNhc2UgImRyYWdzdGFydCI6CiAgICAgICAgICAgICAgY2FzZSAiZHJvcCI6CiAgICAgICAgICAgICAgY2FzZSAiZm9jdXNpbiI6CiAgICAgICAgICAgICAgY2FzZSAiZm9jdXNvdXQiOgogICAgICAgICAgICAgIGNhc2UgImlucHV0IjoKICAgICAgICAgICAgICBjYXNlICJpbnZhbGlkIjoKICAgICAgICAgICAgICBjYXNlICJrZXlkb3duIjoKICAgICAgICAgICAgICBjYXNlICJrZXlwcmVzcyI6CiAgICAgICAgICAgICAgY2FzZSAia2V5dXAiOgogICAgICAgICAgICAgIGNhc2UgIm1vdXNlZG93biI6CiAgICAgICAgICAgICAgY2FzZSAibW91c2V1cCI6CiAgICAgICAgICAgICAgY2FzZSAicGFzdGUiOgogICAgICAgICAgICAgIGNhc2UgInBhdXNlIjoKICAgICAgICAgICAgICBjYXNlICJwbGF5IjoKICAgICAgICAgICAgICBjYXNlICJwb2ludGVyY2FuY2VsIjoKICAgICAgICAgICAgICBjYXNlICJwb2ludGVyZG93biI6CiAgICAgICAgICAgICAgY2FzZSAicG9pbnRlcnVwIjoKICAgICAgICAgICAgICBjYXNlICJyYXRlY2hhbmdlIjoKICAgICAgICAgICAgICBjYXNlICJyZXNldCI6CiAgICAgICAgICAgICAgY2FzZSAicmVzaXplIjoKICAgICAgICAgICAgICBjYXNlICJzZWVrZWQiOgogICAgICAgICAgICAgIGNhc2UgInN1Ym1pdCI6CiAgICAgICAgICAgICAgY2FzZSAidG91Y2hjYW5jZWwiOgogICAgICAgICAgICAgIGNhc2UgInRvdWNoZW5kIjoKICAgICAgICAgICAgICBjYXNlICJ0b3VjaHN0YXJ0IjoKICAgICAgICAgICAgICBjYXNlICJ2b2x1bWVjaGFuZ2UiOgogICAgICAgICAgICAgIGNhc2UgImNoYW5nZSI6CiAgICAgICAgICAgICAgY2FzZSAic2VsZWN0aW9uY2hhbmdlIjoKICAgICAgICAgICAgICBjYXNlICJ0ZXh0SW5wdXQiOgogICAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uc3RhcnQiOgogICAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uZW5kIjoKICAgICAgICAgICAgICBjYXNlICJjb21wb3NpdGlvbnVwZGF0ZSI6CiAgICAgICAgICAgICAgY2FzZSAiYmVmb3JlYmx1ciI6CiAgICAgICAgICAgICAgY2FzZSAiYWZ0ZXJibHVyIjoKICAgICAgICAgICAgICBjYXNlICJiZWZvcmVpbnB1dCI6CiAgICAgICAgICAgICAgY2FzZSAiYmx1ciI6CiAgICAgICAgICAgICAgY2FzZSAiZnVsbHNjcmVlbmNoYW5nZSI6CiAgICAgICAgICAgICAgY2FzZSAiZm9jdXMiOgogICAgICAgICAgICAgIGNhc2UgImhhc2hjaGFuZ2UiOgogICAgICAgICAgICAgIGNhc2UgInBvcHN0YXRlIjoKICAgICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgIGNhc2UgInNlbGVjdHN0YXJ0IjoKICAgICAgICAgICAgICAgIHJldHVybiBEaXNjcmV0ZUV2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgICAgY2FzZSAiZHJhZyI6CiAgICAgICAgICAgICAgY2FzZSAiZHJhZ2VudGVyIjoKICAgICAgICAgICAgICBjYXNlICJkcmFnZXhpdCI6CiAgICAgICAgICAgICAgY2FzZSAiZHJhZ2xlYXZlIjoKICAgICAgICAgICAgICBjYXNlICJkcmFnb3ZlciI6CiAgICAgICAgICAgICAgY2FzZSAibW91c2Vtb3ZlIjoKICAgICAgICAgICAgICBjYXNlICJtb3VzZW91dCI6CiAgICAgICAgICAgICAgY2FzZSAibW91c2VvdmVyIjoKICAgICAgICAgICAgICBjYXNlICJwb2ludGVybW92ZSI6CiAgICAgICAgICAgICAgY2FzZSAicG9pbnRlcm91dCI6CiAgICAgICAgICAgICAgY2FzZSAicG9pbnRlcm92ZXIiOgogICAgICAgICAgICAgIGNhc2UgInNjcm9sbCI6CiAgICAgICAgICAgICAgY2FzZSAidG9nZ2xlIjoKICAgICAgICAgICAgICBjYXNlICJ0b3VjaG1vdmUiOgogICAgICAgICAgICAgIGNhc2UgIndoZWVsIjoKICAgICAgICAgICAgICBjYXNlICJtb3VzZWVudGVyIjoKICAgICAgICAgICAgICBjYXNlICJtb3VzZWxlYXZlIjoKICAgICAgICAgICAgICBjYXNlICJwb2ludGVyZW50ZXIiOgogICAgICAgICAgICAgIGNhc2UgInBvaW50ZXJsZWF2ZSI6CiAgICAgICAgICAgICAgICByZXR1cm4gQ29udGludW91c0V2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgICAgY2FzZSAibWVzc2FnZSI6IHsKICAgICAgICAgICAgICAgIHZhciBzY2hlZHVsZXJQcmlvcml0eSA9IGdldEN1cnJlbnRQcmlvcml0eUxldmVsKCk7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKHNjaGVkdWxlclByaW9yaXR5KSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgSW1tZWRpYXRlUHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIERpc2NyZXRlRXZlbnRQcmlvcml0eTsKICAgICAgICAgICAgICAgICAgY2FzZSBVc2VyQmxvY2tpbmdQcmlvcml0eToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gQ29udGludW91c0V2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgICAgICAgIGNhc2UgTm9ybWFsUHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgIGNhc2UgTG93UHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIERlZmF1bHRFdmVudFByaW9yaXR5OwogICAgICAgICAgICAgICAgICBjYXNlIElkbGVQcmlvcml0eToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gSWRsZUV2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIERlZmF1bHRFdmVudFByaW9yaXR5OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgcmV0dXJuIERlZmF1bHRFdmVudFByaW9yaXR5OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBhZGRFdmVudEJ1YmJsZUxpc3RlbmVyKHRhcmdldCwgZXZlbnRUeXBlLCBsaXN0ZW5lcikgewogICAgICAgICAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGxpc3RlbmVyLCBmYWxzZSk7CiAgICAgICAgICAgIHJldHVybiBsaXN0ZW5lcjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGFkZEV2ZW50Q2FwdHVyZUxpc3RlbmVyKHRhcmdldCwgZXZlbnRUeXBlLCBsaXN0ZW5lcikgewogICAgICAgICAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGxpc3RlbmVyLCB0cnVlKTsKICAgICAgICAgICAgcmV0dXJuIGxpc3RlbmVyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gYWRkRXZlbnRDYXB0dXJlTGlzdGVuZXJXaXRoUGFzc2l2ZUZsYWcodGFyZ2V0LCBldmVudFR5cGUsIGxpc3RlbmVyLCBwYXNzaXZlKSB7CiAgICAgICAgICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgbGlzdGVuZXIsIHsKICAgICAgICAgICAgICBjYXB0dXJlOiB0cnVlLAogICAgICAgICAgICAgIHBhc3NpdmUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBsaXN0ZW5lcjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGFkZEV2ZW50QnViYmxlTGlzdGVuZXJXaXRoUGFzc2l2ZUZsYWcodGFyZ2V0LCBldmVudFR5cGUsIGxpc3RlbmVyLCBwYXNzaXZlKSB7CiAgICAgICAgICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgbGlzdGVuZXIsIHsKICAgICAgICAgICAgICBwYXNzaXZlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gbGlzdGVuZXI7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcm9vdDIgPSBudWxsOwogICAgICAgICAgdmFyIHN0YXJ0VGV4dCA9IG51bGw7CiAgICAgICAgICB2YXIgZmFsbGJhY2tUZXh0ID0gbnVsbDsKICAgICAgICAgIGZ1bmN0aW9uIGluaXRpYWxpemUobmF0aXZlRXZlbnRUYXJnZXQpIHsKICAgICAgICAgICAgcm9vdDIgPSBuYXRpdmVFdmVudFRhcmdldDsKICAgICAgICAgICAgc3RhcnRUZXh0ID0gZ2V0VGV4dCgpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlc2V0KCkgewogICAgICAgICAgICByb290MiA9IG51bGw7CiAgICAgICAgICAgIHN0YXJ0VGV4dCA9IG51bGw7CiAgICAgICAgICAgIGZhbGxiYWNrVGV4dCA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXREYXRhKCkgewogICAgICAgICAgICBpZiAoZmFsbGJhY2tUZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbGxiYWNrVGV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc3RhcnQyOwogICAgICAgICAgICB2YXIgc3RhcnRWYWx1ZSA9IHN0YXJ0VGV4dDsKICAgICAgICAgICAgdmFyIHN0YXJ0TGVuZ3RoID0gc3RhcnRWYWx1ZS5sZW5ndGg7CiAgICAgICAgICAgIHZhciBlbmQ7CiAgICAgICAgICAgIHZhciBlbmRWYWx1ZSA9IGdldFRleHQoKTsKICAgICAgICAgICAgdmFyIGVuZExlbmd0aCA9IGVuZFZhbHVlLmxlbmd0aDsKICAgICAgICAgICAgZm9yIChzdGFydDIgPSAwOyBzdGFydDIgPCBzdGFydExlbmd0aDsgc3RhcnQyKyspIHsKICAgICAgICAgICAgICBpZiAoc3RhcnRWYWx1ZVtzdGFydDJdICE9PSBlbmRWYWx1ZVtzdGFydDJdKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG1pbkVuZCA9IHN0YXJ0TGVuZ3RoIC0gc3RhcnQyOwogICAgICAgICAgICBmb3IgKGVuZCA9IDE7IGVuZCA8PSBtaW5FbmQ7IGVuZCsrKSB7CiAgICAgICAgICAgICAgaWYgKHN0YXJ0VmFsdWVbc3RhcnRMZW5ndGggLSBlbmRdICE9PSBlbmRWYWx1ZVtlbmRMZW5ndGggLSBlbmRdKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNsaWNlVGFpbCA9IGVuZCA+IDEgPyAxIC0gZW5kIDogdm9pZCAwOwogICAgICAgICAgICBmYWxsYmFja1RleHQgPSBlbmRWYWx1ZS5zbGljZShzdGFydDIsIHNsaWNlVGFpbCk7CiAgICAgICAgICAgIHJldHVybiBmYWxsYmFja1RleHQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRUZXh0KCkgewogICAgICAgICAgICBpZiAoInZhbHVlIiBpbiByb290MikgewogICAgICAgICAgICAgIHJldHVybiByb290Mi52YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcm9vdDIudGV4dENvbnRlbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRFdmVudENoYXJDb2RlKG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICAgIHZhciBjaGFyQ29kZTsKICAgICAgICAgICAgdmFyIGtleUNvZGUgPSBuYXRpdmVFdmVudC5rZXlDb2RlOwogICAgICAgICAgICBpZiAoImNoYXJDb2RlIiBpbiBuYXRpdmVFdmVudCkgewogICAgICAgICAgICAgIGNoYXJDb2RlID0gbmF0aXZlRXZlbnQuY2hhckNvZGU7CiAgICAgICAgICAgICAgaWYgKGNoYXJDb2RlID09PSAwICYmIGtleUNvZGUgPT09IDEzKSB7CiAgICAgICAgICAgICAgICBjaGFyQ29kZSA9IDEzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjaGFyQ29kZSA9IGtleUNvZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNoYXJDb2RlID09PSAxMCkgewogICAgICAgICAgICAgIGNoYXJDb2RlID0gMTM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNoYXJDb2RlID49IDMyIHx8IGNoYXJDb2RlID09PSAxMykgewogICAgICAgICAgICAgIHJldHVybiBjaGFyQ29kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGZ1bmN0aW9uVGhhdFJldHVybnNUcnVlKCkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGZ1bmN0aW9uVGhhdFJldHVybnNGYWxzZSgpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY3JlYXRlU3ludGhldGljRXZlbnQoSW50ZXJmYWNlKSB7CiAgICAgICAgICAgIGZ1bmN0aW9uIFN5bnRoZXRpY0Jhc2VFdmVudChyZWFjdE5hbWUsIHJlYWN0RXZlbnRUeXBlLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpIHsKICAgICAgICAgICAgICB0aGlzLl9yZWFjdE5hbWUgPSByZWFjdE5hbWU7CiAgICAgICAgICAgICAgdGhpcy5fdGFyZ2V0SW5zdCA9IHRhcmdldEluc3Q7CiAgICAgICAgICAgICAgdGhpcy50eXBlID0gcmVhY3RFdmVudFR5cGU7CiAgICAgICAgICAgICAgdGhpcy5uYXRpdmVFdmVudCA9IG5hdGl2ZUV2ZW50OwogICAgICAgICAgICAgIHRoaXMudGFyZ2V0ID0gbmF0aXZlRXZlbnRUYXJnZXQ7CiAgICAgICAgICAgICAgdGhpcy5jdXJyZW50VGFyZ2V0ID0gbnVsbDsKICAgICAgICAgICAgICBmb3IgKHZhciBfcHJvcE5hbWUgaW4gSW50ZXJmYWNlKSB7CiAgICAgICAgICAgICAgICBpZiAoIUludGVyZmFjZS5oYXNPd25Qcm9wZXJ0eShfcHJvcE5hbWUpKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG5vcm1hbGl6ZSA9IEludGVyZmFjZVtfcHJvcE5hbWVdOwogICAgICAgICAgICAgICAgaWYgKG5vcm1hbGl6ZSkgewogICAgICAgICAgICAgICAgICB0aGlzW19wcm9wTmFtZV0gPSBub3JtYWxpemUobmF0aXZlRXZlbnQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdGhpc1tfcHJvcE5hbWVdID0gbmF0aXZlRXZlbnRbX3Byb3BOYW1lXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGRlZmF1bHRQcmV2ZW50ZWQgPSBuYXRpdmVFdmVudC5kZWZhdWx0UHJldmVudGVkICE9IG51bGwgPyBuYXRpdmVFdmVudC5kZWZhdWx0UHJldmVudGVkIDogbmF0aXZlRXZlbnQucmV0dXJuVmFsdWUgPT09IGZhbHNlOwogICAgICAgICAgICAgIGlmIChkZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IGZ1bmN0aW9uVGhhdFJldHVybnNUcnVlOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IGZ1bmN0aW9uVGhhdFJldHVybnNGYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5pc1Byb3BhZ2F0aW9uU3RvcHBlZCA9IGZ1bmN0aW9uVGhhdFJldHVybnNGYWxzZTsKICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQogICAgICAgICAgICBhc3NpZ24oU3ludGhldGljQmFzZUV2ZW50LnByb3RvdHlwZSwgewogICAgICAgICAgICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRoaXMuZGVmYXVsdFByZXZlbnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSB0aGlzLm5hdGl2ZUV2ZW50OwogICAgICAgICAgICAgICAgaWYgKCFldmVudCkgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZXZlbnQucHJldmVudERlZmF1bHQpIHsKICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGV2ZW50LnJldHVyblZhbHVlICE9PSAidW5rbm93biIpIHsKICAgICAgICAgICAgICAgICAgZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gZnVuY3Rpb25UaGF0UmV0dXJuc1RydWU7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gdGhpcy5uYXRpdmVFdmVudDsKICAgICAgICAgICAgICAgIGlmICghZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGV2ZW50LnN0b3BQcm9wYWdhdGlvbikgewogICAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGV2ZW50LmNhbmNlbEJ1YmJsZSAhPT0gInVua25vd24iKSB7CiAgICAgICAgICAgICAgICAgIGV2ZW50LmNhbmNlbEJ1YmJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLmlzUHJvcGFnYXRpb25TdG9wcGVkID0gZnVuY3Rpb25UaGF0UmV0dXJuc1RydWU7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgKiBXZSByZWxlYXNlIGFsbCBkaXNwYXRjaGVkIGBTeW50aGV0aWNFdmVudGBzIGFmdGVyIGVhY2ggZXZlbnQgbG9vcCwgYWRkaW5nCiAgICAgICAgICAgICAgICogdGhlbSBiYWNrIGludG8gdGhlIHBvb2wuIFRoaXMgYWxsb3dzIGEgd2F5IHRvIGhvbGQgb250byBhIHJlZmVyZW5jZSB0aGF0CiAgICAgICAgICAgICAgICogd29uJ3QgYmUgYWRkZWQgYmFjayBpbnRvIHRoZSBwb29sLgogICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgIHBlcnNpc3Q6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICogQ2hlY2tzIGlmIHRoaXMgZXZlbnQgc2hvdWxkIGJlIHJlbGVhc2VkIGJhY2sgaW50byB0aGUgcG9vbC4KICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhpcyBzaG91bGQgbm90IGJlIHJlbGVhc2VkLCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgaXNQZXJzaXN0ZW50OiBmdW5jdGlvblRoYXRSZXR1cm5zVHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIFN5bnRoZXRpY0Jhc2VFdmVudDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBFdmVudEludGVyZmFjZSA9IHsKICAgICAgICAgICAgZXZlbnRQaGFzZTogMCwKICAgICAgICAgICAgYnViYmxlczogMCwKICAgICAgICAgICAgY2FuY2VsYWJsZTogMCwKICAgICAgICAgICAgdGltZVN0YW1wOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICAgIHJldHVybiBldmVudC50aW1lU3RhbXAgfHwgRGF0ZS5ub3coKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZGVmYXVsdFByZXZlbnRlZDogMCwKICAgICAgICAgICAgaXNUcnVzdGVkOiAwCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIFN5bnRoZXRpY0V2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoRXZlbnRJbnRlcmZhY2UpOwogICAgICAgICAgdmFyIFVJRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24oe30sIEV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICAgIHZpZXc6IDAsCiAgICAgICAgICAgIGRldGFpbDogMAogICAgICAgICAgfSk7CiAgICAgICAgICB2YXIgU3ludGhldGljVUlFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KFVJRXZlbnRJbnRlcmZhY2UpOwogICAgICAgICAgdmFyIGxhc3RNb3ZlbWVudFg7CiAgICAgICAgICB2YXIgbGFzdE1vdmVtZW50WTsKICAgICAgICAgIHZhciBsYXN0TW91c2VFdmVudDsKICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU1vdXNlTW92ZW1lbnRQb2x5ZmlsbFN0YXRlKGV2ZW50KSB7CiAgICAgICAgICAgIGlmIChldmVudCAhPT0gbGFzdE1vdXNlRXZlbnQpIHsKICAgICAgICAgICAgICBpZiAobGFzdE1vdXNlRXZlbnQgJiYgZXZlbnQudHlwZSA9PT0gIm1vdXNlbW92ZSIpIHsKICAgICAgICAgICAgICAgIGxhc3RNb3ZlbWVudFggPSBldmVudC5zY3JlZW5YIC0gbGFzdE1vdXNlRXZlbnQuc2NyZWVuWDsKICAgICAgICAgICAgICAgIGxhc3RNb3ZlbWVudFkgPSBldmVudC5zY3JlZW5ZIC0gbGFzdE1vdXNlRXZlbnQuc2NyZWVuWTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbGFzdE1vdmVtZW50WCA9IDA7CiAgICAgICAgICAgICAgICBsYXN0TW92ZW1lbnRZID0gMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbGFzdE1vdXNlRXZlbnQgPSBldmVudDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIE1vdXNlRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24oe30sIFVJRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgICAgc2NyZWVuWDogMCwKICAgICAgICAgICAgc2NyZWVuWTogMCwKICAgICAgICAgICAgY2xpZW50WDogMCwKICAgICAgICAgICAgY2xpZW50WTogMCwKICAgICAgICAgICAgcGFnZVg6IDAsCiAgICAgICAgICAgIHBhZ2VZOiAwLAogICAgICAgICAgICBjdHJsS2V5OiAwLAogICAgICAgICAgICBzaGlmdEtleTogMCwKICAgICAgICAgICAgYWx0S2V5OiAwLAogICAgICAgICAgICBtZXRhS2V5OiAwLAogICAgICAgICAgICBnZXRNb2RpZmllclN0YXRlOiBnZXRFdmVudE1vZGlmaWVyU3RhdGUsCiAgICAgICAgICAgIGJ1dHRvbjogMCwKICAgICAgICAgICAgYnV0dG9uczogMCwKICAgICAgICAgICAgcmVsYXRlZFRhcmdldDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgICBpZiAoZXZlbnQucmVsYXRlZFRhcmdldCA9PT0gdm9pZCAwKQogICAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50LmZyb21FbGVtZW50ID09PSBldmVudC5zcmNFbGVtZW50ID8gZXZlbnQudG9FbGVtZW50IDogZXZlbnQuZnJvbUVsZW1lbnQ7CiAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50LnJlbGF0ZWRUYXJnZXQ7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG1vdmVtZW50WDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgICBpZiAoIm1vdmVtZW50WCIgaW4gZXZlbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBldmVudC5tb3ZlbWVudFg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVwZGF0ZU1vdXNlTW92ZW1lbnRQb2x5ZmlsbFN0YXRlKGV2ZW50KTsKICAgICAgICAgICAgICByZXR1cm4gbGFzdE1vdmVtZW50WDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgbW92ZW1lbnRZOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICAgIGlmICgibW92ZW1lbnRZIiBpbiBldmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50Lm1vdmVtZW50WTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGxhc3RNb3ZlbWVudFk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgdmFyIFN5bnRoZXRpY01vdXNlRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChNb3VzZUV2ZW50SW50ZXJmYWNlKTsKICAgICAgICAgIHZhciBEcmFnRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24oe30sIE1vdXNlRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgICAgZGF0YVRyYW5zZmVyOiAwCiAgICAgICAgICB9KTsKICAgICAgICAgIHZhciBTeW50aGV0aWNEcmFnRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChEcmFnRXZlbnRJbnRlcmZhY2UpOwogICAgICAgICAgdmFyIEZvY3VzRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24oe30sIFVJRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgICAgcmVsYXRlZFRhcmdldDogMAogICAgICAgICAgfSk7CiAgICAgICAgICB2YXIgU3ludGhldGljRm9jdXNFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KEZvY3VzRXZlbnRJbnRlcmZhY2UpOwogICAgICAgICAgdmFyIEFuaW1hdGlvbkV2ZW50SW50ZXJmYWNlID0gYXNzaWduKHt9LCBFdmVudEludGVyZmFjZSwgewogICAgICAgICAgICBhbmltYXRpb25OYW1lOiAwLAogICAgICAgICAgICBlbGFwc2VkVGltZTogMCwKICAgICAgICAgICAgcHNldWRvRWxlbWVudDogMAogICAgICAgICAgfSk7CiAgICAgICAgICB2YXIgU3ludGhldGljQW5pbWF0aW9uRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChBbmltYXRpb25FdmVudEludGVyZmFjZSk7CiAgICAgICAgICB2YXIgQ2xpcGJvYXJkRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24oe30sIEV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICAgIGNsaXBib2FyZERhdGE6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgICAgcmV0dXJuICJjbGlwYm9hcmREYXRhIiBpbiBldmVudCA/IGV2ZW50LmNsaXBib2FyZERhdGEgOiB3aW5kb3cuY2xpcGJvYXJkRGF0YTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICB2YXIgU3ludGhldGljQ2xpcGJvYXJkRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChDbGlwYm9hcmRFdmVudEludGVyZmFjZSk7CiAgICAgICAgICB2YXIgQ29tcG9zaXRpb25FdmVudEludGVyZmFjZSA9IGFzc2lnbih7fSwgRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgICAgZGF0YTogMAogICAgICAgICAgfSk7CiAgICAgICAgICB2YXIgU3ludGhldGljQ29tcG9zaXRpb25FdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KENvbXBvc2l0aW9uRXZlbnRJbnRlcmZhY2UpOwogICAgICAgICAgdmFyIFN5bnRoZXRpY0lucHV0RXZlbnQgPSBTeW50aGV0aWNDb21wb3NpdGlvbkV2ZW50OwogICAgICAgICAgdmFyIG5vcm1hbGl6ZUtleSA9IHsKICAgICAgICAgICAgRXNjOiAiRXNjYXBlIiwKICAgICAgICAgICAgU3BhY2ViYXI6ICIgIiwKICAgICAgICAgICAgTGVmdDogIkFycm93TGVmdCIsCiAgICAgICAgICAgIFVwOiAiQXJyb3dVcCIsCiAgICAgICAgICAgIFJpZ2h0OiAiQXJyb3dSaWdodCIsCiAgICAgICAgICAgIERvd246ICJBcnJvd0Rvd24iLAogICAgICAgICAgICBEZWw6ICJEZWxldGUiLAogICAgICAgICAgICBXaW46ICJPUyIsCiAgICAgICAgICAgIE1lbnU6ICJDb250ZXh0TWVudSIsCiAgICAgICAgICAgIEFwcHM6ICJDb250ZXh0TWVudSIsCiAgICAgICAgICAgIFNjcm9sbDogIlNjcm9sbExvY2siLAogICAgICAgICAgICBNb3pQcmludGFibGVLZXk6ICJVbmlkZW50aWZpZWQiCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHRyYW5zbGF0ZVRvS2V5ID0gewogICAgICAgICAgICAiOCI6ICJCYWNrc3BhY2UiLAogICAgICAgICAgICAiOSI6ICJUYWIiLAogICAgICAgICAgICAiMTIiOiAiQ2xlYXIiLAogICAgICAgICAgICAiMTMiOiAiRW50ZXIiLAogICAgICAgICAgICAiMTYiOiAiU2hpZnQiLAogICAgICAgICAgICAiMTciOiAiQ29udHJvbCIsCiAgICAgICAgICAgICIxOCI6ICJBbHQiLAogICAgICAgICAgICAiMTkiOiAiUGF1c2UiLAogICAgICAgICAgICAiMjAiOiAiQ2Fwc0xvY2siLAogICAgICAgICAgICAiMjciOiAiRXNjYXBlIiwKICAgICAgICAgICAgIjMyIjogIiAiLAogICAgICAgICAgICAiMzMiOiAiUGFnZVVwIiwKICAgICAgICAgICAgIjM0IjogIlBhZ2VEb3duIiwKICAgICAgICAgICAgIjM1IjogIkVuZCIsCiAgICAgICAgICAgICIzNiI6ICJIb21lIiwKICAgICAgICAgICAgIjM3IjogIkFycm93TGVmdCIsCiAgICAgICAgICAgICIzOCI6ICJBcnJvd1VwIiwKICAgICAgICAgICAgIjM5IjogIkFycm93UmlnaHQiLAogICAgICAgICAgICAiNDAiOiAiQXJyb3dEb3duIiwKICAgICAgICAgICAgIjQ1IjogIkluc2VydCIsCiAgICAgICAgICAgICI0NiI6ICJEZWxldGUiLAogICAgICAgICAgICAiMTEyIjogIkYxIiwKICAgICAgICAgICAgIjExMyI6ICJGMiIsCiAgICAgICAgICAgICIxMTQiOiAiRjMiLAogICAgICAgICAgICAiMTE1IjogIkY0IiwKICAgICAgICAgICAgIjExNiI6ICJGNSIsCiAgICAgICAgICAgICIxMTciOiAiRjYiLAogICAgICAgICAgICAiMTE4IjogIkY3IiwKICAgICAgICAgICAgIjExOSI6ICJGOCIsCiAgICAgICAgICAgICIxMjAiOiAiRjkiLAogICAgICAgICAgICAiMTIxIjogIkYxMCIsCiAgICAgICAgICAgICIxMjIiOiAiRjExIiwKICAgICAgICAgICAgIjEyMyI6ICJGMTIiLAogICAgICAgICAgICAiMTQ0IjogIk51bUxvY2siLAogICAgICAgICAgICAiMTQ1IjogIlNjcm9sbExvY2siLAogICAgICAgICAgICAiMjI0IjogIk1ldGEiCiAgICAgICAgICB9OwogICAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRLZXkobmF0aXZlRXZlbnQpIHsKICAgICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50LmtleSkgewogICAgICAgICAgICAgIHZhciBrZXkgPSBub3JtYWxpemVLZXlbbmF0aXZlRXZlbnQua2V5XSB8fCBuYXRpdmVFdmVudC5rZXk7CiAgICAgICAgICAgICAgaWYgKGtleSAhPT0gIlVuaWRlbnRpZmllZCIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBrZXk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChuYXRpdmVFdmVudC50eXBlID09PSAia2V5cHJlc3MiKSB7CiAgICAgICAgICAgICAgdmFyIGNoYXJDb2RlID0gZ2V0RXZlbnRDaGFyQ29kZShuYXRpdmVFdmVudCk7CiAgICAgICAgICAgICAgcmV0dXJuIGNoYXJDb2RlID09PSAxMyA/ICJFbnRlciIgOiBTdHJpbmcuZnJvbUNoYXJDb2RlKGNoYXJDb2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobmF0aXZlRXZlbnQudHlwZSA9PT0gImtleWRvd24iIHx8IG5hdGl2ZUV2ZW50LnR5cGUgPT09ICJrZXl1cCIpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJhbnNsYXRlVG9LZXlbbmF0aXZlRXZlbnQua2V5Q29kZV0gfHwgIlVuaWRlbnRpZmllZCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG1vZGlmaWVyS2V5VG9Qcm9wID0gewogICAgICAgICAgICBBbHQ6ICJhbHRLZXkiLAogICAgICAgICAgICBDb250cm9sOiAiY3RybEtleSIsCiAgICAgICAgICAgIE1ldGE6ICJtZXRhS2V5IiwKICAgICAgICAgICAgU2hpZnQ6ICJzaGlmdEtleSIKICAgICAgICAgIH07CiAgICAgICAgICBmdW5jdGlvbiBtb2RpZmllclN0YXRlR2V0dGVyKGtleUFyZykgewogICAgICAgICAgICB2YXIgc3ludGhldGljRXZlbnQgPSB0aGlzOwogICAgICAgICAgICB2YXIgbmF0aXZlRXZlbnQgPSBzeW50aGV0aWNFdmVudC5uYXRpdmVFdmVudDsKICAgICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50LmdldE1vZGlmaWVyU3RhdGUpIHsKICAgICAgICAgICAgICByZXR1cm4gbmF0aXZlRXZlbnQuZ2V0TW9kaWZpZXJTdGF0ZShrZXlBcmcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBrZXlQcm9wID0gbW9kaWZpZXJLZXlUb1Byb3Bba2V5QXJnXTsKICAgICAgICAgICAgcmV0dXJuIGtleVByb3AgPyAhIW5hdGl2ZUV2ZW50W2tleVByb3BdIDogZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRFdmVudE1vZGlmaWVyU3RhdGUobmF0aXZlRXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIG1vZGlmaWVyU3RhdGVHZXR0ZXI7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgS2V5Ym9hcmRFdmVudEludGVyZmFjZSA9IGFzc2lnbih7fSwgVUlFdmVudEludGVyZmFjZSwgewogICAgICAgICAgICBrZXk6IGdldEV2ZW50S2V5LAogICAgICAgICAgICBjb2RlOiAwLAogICAgICAgICAgICBsb2NhdGlvbjogMCwKICAgICAgICAgICAgY3RybEtleTogMCwKICAgICAgICAgICAgc2hpZnRLZXk6IDAsCiAgICAgICAgICAgIGFsdEtleTogMCwKICAgICAgICAgICAgbWV0YUtleTogMCwKICAgICAgICAgICAgcmVwZWF0OiAwLAogICAgICAgICAgICBsb2NhbGU6IDAsCiAgICAgICAgICAgIGdldE1vZGlmaWVyU3RhdGU6IGdldEV2ZW50TW9kaWZpZXJTdGF0ZSwKICAgICAgICAgICAgLy8gTGVnYWN5IEludGVyZmFjZQogICAgICAgICAgICBjaGFyQ29kZTogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgICBpZiAoZXZlbnQudHlwZSA9PT0gImtleXByZXNzIikgewogICAgICAgICAgICAgICAgcmV0dXJuIGdldEV2ZW50Q2hhckNvZGUoZXZlbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAga2V5Q29kZTogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgICBpZiAoZXZlbnQudHlwZSA9PT0gImtleWRvd24iIHx8IGV2ZW50LnR5cGUgPT09ICJrZXl1cCIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBldmVudC5rZXlDb2RlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgd2hpY2g6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09ICJrZXlwcmVzcyIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBnZXRFdmVudENoYXJDb2RlKGV2ZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09ICJrZXlkb3duIiB8fCBldmVudC50eXBlID09PSAia2V5dXAiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZXZlbnQua2V5Q29kZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgdmFyIFN5bnRoZXRpY0tleWJvYXJkRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChLZXlib2FyZEV2ZW50SW50ZXJmYWNlKTsKICAgICAgICAgIHZhciBQb2ludGVyRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24oe30sIE1vdXNlRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgICAgcG9pbnRlcklkOiAwLAogICAgICAgICAgICB3aWR0aDogMCwKICAgICAgICAgICAgaGVpZ2h0OiAwLAogICAgICAgICAgICBwcmVzc3VyZTogMCwKICAgICAgICAgICAgdGFuZ2VudGlhbFByZXNzdXJlOiAwLAogICAgICAgICAgICB0aWx0WDogMCwKICAgICAgICAgICAgdGlsdFk6IDAsCiAgICAgICAgICAgIHR3aXN0OiAwLAogICAgICAgICAgICBwb2ludGVyVHlwZTogMCwKICAgICAgICAgICAgaXNQcmltYXJ5OiAwCiAgICAgICAgICB9KTsKICAgICAgICAgIHZhciBTeW50aGV0aWNQb2ludGVyRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChQb2ludGVyRXZlbnRJbnRlcmZhY2UpOwogICAgICAgICAgdmFyIFRvdWNoRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24oe30sIFVJRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgICAgdG91Y2hlczogMCwKICAgICAgICAgICAgdGFyZ2V0VG91Y2hlczogMCwKICAgICAgICAgICAgY2hhbmdlZFRvdWNoZXM6IDAsCiAgICAgICAgICAgIGFsdEtleTogMCwKICAgICAgICAgICAgbWV0YUtleTogMCwKICAgICAgICAgICAgY3RybEtleTogMCwKICAgICAgICAgICAgc2hpZnRLZXk6IDAsCiAgICAgICAgICAgIGdldE1vZGlmaWVyU3RhdGU6IGdldEV2ZW50TW9kaWZpZXJTdGF0ZQogICAgICAgICAgfSk7CiAgICAgICAgICB2YXIgU3ludGhldGljVG91Y2hFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KFRvdWNoRXZlbnRJbnRlcmZhY2UpOwogICAgICAgICAgdmFyIFRyYW5zaXRpb25FdmVudEludGVyZmFjZSA9IGFzc2lnbih7fSwgRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgICAgcHJvcGVydHlOYW1lOiAwLAogICAgICAgICAgICBlbGFwc2VkVGltZTogMCwKICAgICAgICAgICAgcHNldWRvRWxlbWVudDogMAogICAgICAgICAgfSk7CiAgICAgICAgICB2YXIgU3ludGhldGljVHJhbnNpdGlvbkV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoVHJhbnNpdGlvbkV2ZW50SW50ZXJmYWNlKTsKICAgICAgICAgIHZhciBXaGVlbEV2ZW50SW50ZXJmYWNlID0gYXNzaWduKHt9LCBNb3VzZUV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICAgIGRlbHRhWDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgICByZXR1cm4gImRlbHRhWCIgaW4gZXZlbnQgPyBldmVudC5kZWx0YVggOiAoCiAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayB0byBgd2hlZWxEZWx0YVhgIGZvciBXZWJraXQgYW5kIG5vcm1hbGl6ZSAocmlnaHQgaXMgcG9zaXRpdmUpLgogICAgICAgICAgICAgICAgIndoZWVsRGVsdGFYIiBpbiBldmVudCA/IC1ldmVudC53aGVlbERlbHRhWCA6IDAKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9LAogICAgICAgICAgICBkZWx0YVk6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgICAgcmV0dXJuICJkZWx0YVkiIGluIGV2ZW50ID8gZXZlbnQuZGVsdGFZIDogKAogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgdG8gYHdoZWVsRGVsdGFZYCBmb3IgV2Via2l0IGFuZCBub3JtYWxpemUgKGRvd24gaXMgcG9zaXRpdmUpLgogICAgICAgICAgICAgICAgIndoZWVsRGVsdGFZIiBpbiBldmVudCA/IC1ldmVudC53aGVlbERlbHRhWSA6ICgKICAgICAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgdG8gYHdoZWVsRGVsdGFgIGZvciBJRTw5IGFuZCBub3JtYWxpemUgKGRvd24gaXMgcG9zaXRpdmUpLgogICAgICAgICAgICAgICAgICAid2hlZWxEZWx0YSIgaW4gZXZlbnQgPyAtZXZlbnQud2hlZWxEZWx0YSA6IDAKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9LAogICAgICAgICAgICBkZWx0YVo6IDAsCiAgICAgICAgICAgIC8vIEJyb3dzZXJzIHdpdGhvdXQgImRlbHRhTW9kZSIgaXMgcmVwb3J0aW5nIGluIHJhdyB3aGVlbCBkZWx0YSB3aGVyZSBvbmUKICAgICAgICAgICAgLy8gbm90Y2ggb24gdGhlIHNjcm9sbCBpcyBhbHdheXMgKy8tIDEyMCwgcm91Z2hseSBlcXVpdmFsZW50IHRvIHBpeGVscy4KICAgICAgICAgICAgLy8gQSBnb29kIGFwcHJveGltYXRpb24gb2YgRE9NX0RFTFRBX0xJTkUgKDEpIGlzIDUlIG9mIHZpZXdwb3J0IHNpemUgb3IKICAgICAgICAgICAgLy8gfjQwIHBpeGVscywgZm9yIERPTV9ERUxUQV9TQ1JFRU4gKDIpIGl0IGlzIDg3LjUlIG9mIHZpZXdwb3J0IHNpemUuCiAgICAgICAgICAgIGRlbHRhTW9kZTogMAogICAgICAgICAgfSk7CiAgICAgICAgICB2YXIgU3ludGhldGljV2hlZWxFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KFdoZWVsRXZlbnRJbnRlcmZhY2UpOwogICAgICAgICAgdmFyIEVORF9LRVlDT0RFUyA9IFs5LCAxMywgMjcsIDMyXTsKICAgICAgICAgIHZhciBTVEFSVF9LRVlDT0RFID0gMjI5OwogICAgICAgICAgdmFyIGNhblVzZUNvbXBvc2l0aW9uRXZlbnQgPSBjYW5Vc2VET00gJiYgIkNvbXBvc2l0aW9uRXZlbnQiIGluIHdpbmRvdzsKICAgICAgICAgIHZhciBkb2N1bWVudE1vZGUgPSBudWxsOwogICAgICAgICAgaWYgKGNhblVzZURPTSAmJiAiZG9jdW1lbnRNb2RlIiBpbiBkb2N1bWVudCkgewogICAgICAgICAgICBkb2N1bWVudE1vZGUgPSBkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY2FuVXNlVGV4dElucHV0RXZlbnQgPSBjYW5Vc2VET00gJiYgIlRleHRFdmVudCIgaW4gd2luZG93ICYmICFkb2N1bWVudE1vZGU7CiAgICAgICAgICB2YXIgdXNlRmFsbGJhY2tDb21wb3NpdGlvbkRhdGEgPSBjYW5Vc2VET00gJiYgKCFjYW5Vc2VDb21wb3NpdGlvbkV2ZW50IHx8IGRvY3VtZW50TW9kZSAmJiBkb2N1bWVudE1vZGUgPiA4ICYmIGRvY3VtZW50TW9kZSA8PSAxMSk7CiAgICAgICAgICB2YXIgU1BBQ0VCQVJfQ09ERSA9IDMyOwogICAgICAgICAgdmFyIFNQQUNFQkFSX0NIQVIgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKFNQQUNFQkFSX0NPREUpOwogICAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJFdmVudHMoKSB7CiAgICAgICAgICAgIHJlZ2lzdGVyVHdvUGhhc2VFdmVudCgib25CZWZvcmVJbnB1dCIsIFsiY29tcG9zaXRpb25lbmQiLCAia2V5cHJlc3MiLCAidGV4dElucHV0IiwgInBhc3RlIl0pOwogICAgICAgICAgICByZWdpc3RlclR3b1BoYXNlRXZlbnQoIm9uQ29tcG9zaXRpb25FbmQiLCBbImNvbXBvc2l0aW9uZW5kIiwgImZvY3Vzb3V0IiwgImtleWRvd24iLCAia2V5cHJlc3MiLCAia2V5dXAiLCAibW91c2Vkb3duIl0pOwogICAgICAgICAgICByZWdpc3RlclR3b1BoYXNlRXZlbnQoIm9uQ29tcG9zaXRpb25TdGFydCIsIFsiY29tcG9zaXRpb25zdGFydCIsICJmb2N1c291dCIsICJrZXlkb3duIiwgImtleXByZXNzIiwgImtleXVwIiwgIm1vdXNlZG93biJdKTsKICAgICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KCJvbkNvbXBvc2l0aW9uVXBkYXRlIiwgWyJjb21wb3NpdGlvbnVwZGF0ZSIsICJmb2N1c291dCIsICJrZXlkb3duIiwgImtleXByZXNzIiwgImtleXVwIiwgIm1vdXNlZG93biJdKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBoYXNTcGFjZUtleXByZXNzID0gZmFsc2U7CiAgICAgICAgICBmdW5jdGlvbiBpc0tleXByZXNzQ29tbWFuZChuYXRpdmVFdmVudCkgewogICAgICAgICAgICByZXR1cm4gKG5hdGl2ZUV2ZW50LmN0cmxLZXkgfHwgbmF0aXZlRXZlbnQuYWx0S2V5IHx8IG5hdGl2ZUV2ZW50Lm1ldGFLZXkpICYmIC8vIGN0cmxLZXkgJiYgYWx0S2V5IGlzIGVxdWl2YWxlbnQgdG8gQWx0R3IsIGFuZCBpcyBub3QgYSBjb21tYW5kLgogICAgICAgICAgICAhKG5hdGl2ZUV2ZW50LmN0cmxLZXkgJiYgbmF0aXZlRXZlbnQuYWx0S2V5KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldENvbXBvc2l0aW9uRXZlbnRUeXBlKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uc3RhcnQiOgogICAgICAgICAgICAgICAgcmV0dXJuICJvbkNvbXBvc2l0aW9uU3RhcnQiOwogICAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiAib25Db21wb3NpdGlvbkVuZCI7CiAgICAgICAgICAgICAgY2FzZSAiY29tcG9zaXRpb251cGRhdGUiOgogICAgICAgICAgICAgICAgcmV0dXJuICJvbkNvbXBvc2l0aW9uVXBkYXRlIjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaXNGYWxsYmFja0NvbXBvc2l0aW9uU3RhcnQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgICByZXR1cm4gZG9tRXZlbnROYW1lID09PSAia2V5ZG93biIgJiYgbmF0aXZlRXZlbnQua2V5Q29kZSA9PT0gU1RBUlRfS0VZQ09ERTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGlzRmFsbGJhY2tDb21wb3NpdGlvbkVuZChkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgICAgY2FzZSAia2V5dXAiOgogICAgICAgICAgICAgICAgcmV0dXJuIEVORF9LRVlDT0RFUy5pbmRleE9mKG5hdGl2ZUV2ZW50LmtleUNvZGUpICE9PSAtMTsKICAgICAgICAgICAgICBjYXNlICJrZXlkb3duIjoKICAgICAgICAgICAgICAgIHJldHVybiBuYXRpdmVFdmVudC5rZXlDb2RlICE9PSBTVEFSVF9LRVlDT0RFOwogICAgICAgICAgICAgIGNhc2UgImtleXByZXNzIjoKICAgICAgICAgICAgICBjYXNlICJtb3VzZWRvd24iOgogICAgICAgICAgICAgIGNhc2UgImZvY3Vzb3V0IjoKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldERhdGFGcm9tQ3VzdG9tRXZlbnQobmF0aXZlRXZlbnQpIHsKICAgICAgICAgICAgdmFyIGRldGFpbCA9IG5hdGl2ZUV2ZW50LmRldGFpbDsKICAgICAgICAgICAgaWYgKHR5cGVvZiBkZXRhaWwgPT09ICJvYmplY3QiICYmICJkYXRhIiBpbiBkZXRhaWwpIHsKICAgICAgICAgICAgICByZXR1cm4gZGV0YWlsLmRhdGE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpc1VzaW5nS29yZWFuSU1FKG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiBuYXRpdmVFdmVudC5sb2NhbGUgPT09ICJrbyI7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaXNDb21wb3NpbmcgPSBmYWxzZTsKICAgICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RDb21wb3NpdGlvbkV2ZW50KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICAgIHZhciBldmVudFR5cGU7CiAgICAgICAgICAgIHZhciBmYWxsYmFja0RhdGE7CiAgICAgICAgICAgIGlmIChjYW5Vc2VDb21wb3NpdGlvbkV2ZW50KSB7CiAgICAgICAgICAgICAgZXZlbnRUeXBlID0gZ2V0Q29tcG9zaXRpb25FdmVudFR5cGUoZG9tRXZlbnROYW1lKTsKICAgICAgICAgICAgfSBlbHNlIGlmICghaXNDb21wb3NpbmcpIHsKICAgICAgICAgICAgICBpZiAoaXNGYWxsYmFja0NvbXBvc2l0aW9uU3RhcnQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgICAgIGV2ZW50VHlwZSA9ICJvbkNvbXBvc2l0aW9uU3RhcnQiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChpc0ZhbGxiYWNrQ29tcG9zaXRpb25FbmQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgICBldmVudFR5cGUgPSAib25Db21wb3NpdGlvbkVuZCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFldmVudFR5cGUpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodXNlRmFsbGJhY2tDb21wb3NpdGlvbkRhdGEgJiYgIWlzVXNpbmdLb3JlYW5JTUUobmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgICAgaWYgKCFpc0NvbXBvc2luZyAmJiBldmVudFR5cGUgPT09ICJvbkNvbXBvc2l0aW9uU3RhcnQiKSB7CiAgICAgICAgICAgICAgICBpc0NvbXBvc2luZyA9IGluaXRpYWxpemUobmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoZXZlbnRUeXBlID09PSAib25Db21wb3NpdGlvbkVuZCIpIHsKICAgICAgICAgICAgICAgIGlmIChpc0NvbXBvc2luZykgewogICAgICAgICAgICAgICAgICBmYWxsYmFja0RhdGEgPSBnZXREYXRhKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBhY2N1bXVsYXRlVHdvUGhhc2VMaXN0ZW5lcnModGFyZ2V0SW5zdCwgZXZlbnRUeXBlKTsKICAgICAgICAgICAgaWYgKGxpc3RlbmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gbmV3IFN5bnRoZXRpY0NvbXBvc2l0aW9uRXZlbnQoZXZlbnRUeXBlLCBkb21FdmVudE5hbWUsIG51bGwsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgICAgZGlzcGF0Y2hRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICAgIGV2ZW50LAogICAgICAgICAgICAgICAgbGlzdGVuZXJzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgaWYgKGZhbGxiYWNrRGF0YSkgewogICAgICAgICAgICAgICAgZXZlbnQuZGF0YSA9IGZhbGxiYWNrRGF0YTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGN1c3RvbURhdGEgPSBnZXREYXRhRnJvbUN1c3RvbUV2ZW50KG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgICAgIGlmIChjdXN0b21EYXRhICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGV2ZW50LmRhdGEgPSBjdXN0b21EYXRhOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0TmF0aXZlQmVmb3JlSW5wdXRDaGFycyhkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgICAgY2FzZSAiY29tcG9zaXRpb25lbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIGdldERhdGFGcm9tQ3VzdG9tRXZlbnQobmF0aXZlRXZlbnQpOwogICAgICAgICAgICAgIGNhc2UgImtleXByZXNzIjoKICAgICAgICAgICAgICAgIHZhciB3aGljaCA9IG5hdGl2ZUV2ZW50LndoaWNoOwogICAgICAgICAgICAgICAgaWYgKHdoaWNoICE9PSBTUEFDRUJBUl9DT0RFKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaGFzU3BhY2VLZXlwcmVzcyA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gU1BBQ0VCQVJfQ0hBUjsKICAgICAgICAgICAgICBjYXNlICJ0ZXh0SW5wdXQiOgogICAgICAgICAgICAgICAgdmFyIGNoYXJzID0gbmF0aXZlRXZlbnQuZGF0YTsKICAgICAgICAgICAgICAgIGlmIChjaGFycyA9PT0gU1BBQ0VCQVJfQ0hBUiAmJiBoYXNTcGFjZUtleXByZXNzKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGNoYXJzOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0RmFsbGJhY2tCZWZvcmVJbnB1dENoYXJzKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgICAgaWYgKGlzQ29tcG9zaW5nKSB7CiAgICAgICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gImNvbXBvc2l0aW9uZW5kIiB8fCAhY2FuVXNlQ29tcG9zaXRpb25FdmVudCAmJiBpc0ZhbGxiYWNrQ29tcG9zaXRpb25FbmQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgICAgIHZhciBjaGFycyA9IGdldERhdGEoKTsKICAgICAgICAgICAgICAgIHJlc2V0KCk7CiAgICAgICAgICAgICAgICBpc0NvbXBvc2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgcmV0dXJuIGNoYXJzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICAgIGNhc2UgInBhc3RlIjoKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIGNhc2UgImtleXByZXNzIjoKICAgICAgICAgICAgICAgIGlmICghaXNLZXlwcmVzc0NvbW1hbmQobmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgICAgICAgIGlmIChuYXRpdmVFdmVudC5jaGFyICYmIG5hdGl2ZUV2ZW50LmNoYXIubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBuYXRpdmVFdmVudC5jaGFyOwogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5hdGl2ZUV2ZW50LndoaWNoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUobmF0aXZlRXZlbnQud2hpY2gpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICBjYXNlICJjb21wb3NpdGlvbmVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gdXNlRmFsbGJhY2tDb21wb3NpdGlvbkRhdGEgJiYgIWlzVXNpbmdLb3JlYW5JTUUobmF0aXZlRXZlbnQpID8gbnVsbCA6IG5hdGl2ZUV2ZW50LmRhdGE7CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBleHRyYWN0QmVmb3JlSW5wdXRFdmVudChkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCkgewogICAgICAgICAgICB2YXIgY2hhcnM7CiAgICAgICAgICAgIGlmIChjYW5Vc2VUZXh0SW5wdXRFdmVudCkgewogICAgICAgICAgICAgIGNoYXJzID0gZ2V0TmF0aXZlQmVmb3JlSW5wdXRDaGFycyhkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjaGFycyA9IGdldEZhbGxiYWNrQmVmb3JlSW5wdXRDaGFycyhkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWNoYXJzKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGxpc3RlbmVycyA9IGFjY3VtdWxhdGVUd29QaGFzZUxpc3RlbmVycyh0YXJnZXRJbnN0LCAib25CZWZvcmVJbnB1dCIpOwogICAgICAgICAgICBpZiAobGlzdGVuZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICB2YXIgZXZlbnQgPSBuZXcgU3ludGhldGljSW5wdXRFdmVudCgib25CZWZvcmVJbnB1dCIsICJiZWZvcmVpbnB1dCIsIG51bGwsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgICAgZGlzcGF0Y2hRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICAgIGV2ZW50LAogICAgICAgICAgICAgICAgbGlzdGVuZXJzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgZXZlbnQuZGF0YSA9IGNoYXJzOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBleHRyYWN0RXZlbnRzKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgICAgZXh0cmFjdENvbXBvc2l0aW9uRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICBleHRyYWN0QmVmb3JlSW5wdXRFdmVudChkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc3VwcG9ydGVkSW5wdXRUeXBlcyA9IHsKICAgICAgICAgICAgY29sb3I6IHRydWUsCiAgICAgICAgICAgIGRhdGU6IHRydWUsCiAgICAgICAgICAgIGRhdGV0aW1lOiB0cnVlLAogICAgICAgICAgICAiZGF0ZXRpbWUtbG9jYWwiOiB0cnVlLAogICAgICAgICAgICBlbWFpbDogdHJ1ZSwKICAgICAgICAgICAgbW9udGg6IHRydWUsCiAgICAgICAgICAgIG51bWJlcjogdHJ1ZSwKICAgICAgICAgICAgcGFzc3dvcmQ6IHRydWUsCiAgICAgICAgICAgIHJhbmdlOiB0cnVlLAogICAgICAgICAgICBzZWFyY2g6IHRydWUsCiAgICAgICAgICAgIHRlbDogdHJ1ZSwKICAgICAgICAgICAgdGV4dDogdHJ1ZSwKICAgICAgICAgICAgdGltZTogdHJ1ZSwKICAgICAgICAgICAgdXJsOiB0cnVlLAogICAgICAgICAgICB3ZWVrOiB0cnVlCiAgICAgICAgICB9OwogICAgICAgICAgZnVuY3Rpb24gaXNUZXh0SW5wdXRFbGVtZW50KGVsZW0pIHsKICAgICAgICAgICAgdmFyIG5vZGVOYW1lID0gZWxlbSAmJiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgaWYgKG5vZGVOYW1lID09PSAiaW5wdXQiKSB7CiAgICAgICAgICAgICAgcmV0dXJuICEhc3VwcG9ydGVkSW5wdXRUeXBlc1tlbGVtLnR5cGVdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChub2RlTmFtZSA9PT0gInRleHRhcmVhIikgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGlzRXZlbnRTdXBwb3J0ZWQoZXZlbnROYW1lU3VmZml4KSB7CiAgICAgICAgICAgIGlmICghY2FuVXNlRE9NKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBldmVudE5hbWUgPSAib24iICsgZXZlbnROYW1lU3VmZml4OwogICAgICAgICAgICB2YXIgaXNTdXBwb3J0ZWQgPSBldmVudE5hbWUgaW4gZG9jdW1lbnQ7CiAgICAgICAgICAgIGlmICghaXNTdXBwb3J0ZWQpIHsKICAgICAgICAgICAgICB2YXIgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKGV2ZW50TmFtZSwgInJldHVybjsiKTsKICAgICAgICAgICAgICBpc1N1cHBvcnRlZCA9IHR5cGVvZiBlbGVtZW50W2V2ZW50TmFtZV0gPT09ICJmdW5jdGlvbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGlzU3VwcG9ydGVkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJFdmVudHMkMSgpIHsKICAgICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KCJvbkNoYW5nZSIsIFsiY2hhbmdlIiwgImNsaWNrIiwgImZvY3VzaW4iLCAiZm9jdXNvdXQiLCAiaW5wdXQiLCAia2V5ZG93biIsICJrZXl1cCIsICJzZWxlY3Rpb25jaGFuZ2UiXSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVBbmRBY2N1bXVsYXRlQ2hhbmdlRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgaW5zdCwgbmF0aXZlRXZlbnQsIHRhcmdldCkgewogICAgICAgICAgICBlbnF1ZXVlU3RhdGVSZXN0b3JlKHRhcmdldCk7CiAgICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBhY2N1bXVsYXRlVHdvUGhhc2VMaXN0ZW5lcnMoaW5zdCwgIm9uQ2hhbmdlIik7CiAgICAgICAgICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHZhciBldmVudCA9IG5ldyBTeW50aGV0aWNFdmVudCgib25DaGFuZ2UiLCAiY2hhbmdlIiwgbnVsbCwgbmF0aXZlRXZlbnQsIHRhcmdldCk7CiAgICAgICAgICAgICAgZGlzcGF0Y2hRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICAgIGV2ZW50LAogICAgICAgICAgICAgICAgbGlzdGVuZXJzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBhY3RpdmVFbGVtZW50ID0gbnVsbDsKICAgICAgICAgIHZhciBhY3RpdmVFbGVtZW50SW5zdCA9IG51bGw7CiAgICAgICAgICBmdW5jdGlvbiBzaG91bGRVc2VDaGFuZ2VFdmVudChlbGVtKSB7CiAgICAgICAgICAgIHZhciBub2RlTmFtZSA9IGVsZW0ubm9kZU5hbWUgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICByZXR1cm4gbm9kZU5hbWUgPT09ICJzZWxlY3QiIHx8IG5vZGVOYW1lID09PSAiaW5wdXQiICYmIGVsZW0udHlwZSA9PT0gImZpbGUiOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbWFudWFsRGlzcGF0Y2hDaGFuZ2VFdmVudChuYXRpdmVFdmVudCkgewogICAgICAgICAgICB2YXIgZGlzcGF0Y2hRdWV1ZSA9IFtdOwogICAgICAgICAgICBjcmVhdGVBbmRBY2N1bXVsYXRlQ2hhbmdlRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgYWN0aXZlRWxlbWVudEluc3QsIG5hdGl2ZUV2ZW50LCBnZXRFdmVudFRhcmdldChuYXRpdmVFdmVudCkpOwogICAgICAgICAgICBiYXRjaGVkVXBkYXRlcyhydW5FdmVudEluQmF0Y2gsIGRpc3BhdGNoUXVldWUpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcnVuRXZlbnRJbkJhdGNoKGRpc3BhdGNoUXVldWUpIHsKICAgICAgICAgICAgcHJvY2Vzc0Rpc3BhdGNoUXVldWUoZGlzcGF0Y2hRdWV1ZSwgMCk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRJbnN0SWZWYWx1ZUNoYW5nZWQodGFyZ2V0SW5zdCkgewogICAgICAgICAgICB2YXIgdGFyZ2V0Tm9kZSA9IGdldE5vZGVGcm9tSW5zdGFuY2UodGFyZ2V0SW5zdCk7CiAgICAgICAgICAgIGlmICh1cGRhdGVWYWx1ZUlmQ2hhbmdlZCh0YXJnZXROb2RlKSkgewogICAgICAgICAgICAgIHJldHVybiB0YXJnZXRJbnN0OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRUYXJnZXRJbnN0Rm9yQ2hhbmdlRXZlbnQoZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0KSB7CiAgICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJjaGFuZ2UiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldEluc3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBpc0lucHV0RXZlbnRTdXBwb3J0ZWQgPSBmYWxzZTsKICAgICAgICAgIGlmIChjYW5Vc2VET00pIHsKICAgICAgICAgICAgaXNJbnB1dEV2ZW50U3VwcG9ydGVkID0gaXNFdmVudFN1cHBvcnRlZCgiaW5wdXQiKSAmJiAoIWRvY3VtZW50LmRvY3VtZW50TW9kZSB8fCBkb2N1bWVudC5kb2N1bWVudE1vZGUgPiA5KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHN0YXJ0V2F0Y2hpbmdGb3JWYWx1ZUNoYW5nZSh0YXJnZXQsIHRhcmdldEluc3QpIHsKICAgICAgICAgICAgYWN0aXZlRWxlbWVudCA9IHRhcmdldDsKICAgICAgICAgICAgYWN0aXZlRWxlbWVudEluc3QgPSB0YXJnZXRJbnN0OwogICAgICAgICAgICBhY3RpdmVFbGVtZW50LmF0dGFjaEV2ZW50KCJvbnByb3BlcnR5Y2hhbmdlIiwgaGFuZGxlUHJvcGVydHlDaGFuZ2UpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gc3RvcFdhdGNoaW5nRm9yVmFsdWVDaGFuZ2UoKSB7CiAgICAgICAgICAgIGlmICghYWN0aXZlRWxlbWVudCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBhY3RpdmVFbGVtZW50LmRldGFjaEV2ZW50KCJvbnByb3BlcnR5Y2hhbmdlIiwgaGFuZGxlUHJvcGVydHlDaGFuZ2UpOwogICAgICAgICAgICBhY3RpdmVFbGVtZW50ID0gbnVsbDsKICAgICAgICAgICAgYWN0aXZlRWxlbWVudEluc3QgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaGFuZGxlUHJvcGVydHlDaGFuZ2UobmF0aXZlRXZlbnQpIHsKICAgICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50LnByb3BlcnR5TmFtZSAhPT0gInZhbHVlIikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZ2V0SW5zdElmVmFsdWVDaGFuZ2VkKGFjdGl2ZUVsZW1lbnRJbnN0KSkgewogICAgICAgICAgICAgIG1hbnVhbERpc3BhdGNoQ2hhbmdlRXZlbnQobmF0aXZlRXZlbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVFdmVudHNGb3JJbnB1dEV2ZW50UG9seWZpbGwoZG9tRXZlbnROYW1lLCB0YXJnZXQsIHRhcmdldEluc3QpIHsKICAgICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gImZvY3VzaW4iKSB7CiAgICAgICAgICAgICAgc3RvcFdhdGNoaW5nRm9yVmFsdWVDaGFuZ2UoKTsKICAgICAgICAgICAgICBzdGFydFdhdGNoaW5nRm9yVmFsdWVDaGFuZ2UodGFyZ2V0LCB0YXJnZXRJbnN0KTsKICAgICAgICAgICAgfSBlbHNlIGlmIChkb21FdmVudE5hbWUgPT09ICJmb2N1c291dCIpIHsKICAgICAgICAgICAgICBzdG9wV2F0Y2hpbmdGb3JWYWx1ZUNoYW5nZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRUYXJnZXRJbnN0Rm9ySW5wdXRFdmVudFBvbHlmaWxsKGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAic2VsZWN0aW9uY2hhbmdlIiB8fCBkb21FdmVudE5hbWUgPT09ICJrZXl1cCIgfHwgZG9tRXZlbnROYW1lID09PSAia2V5ZG93biIpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0SW5zdElmVmFsdWVDaGFuZ2VkKGFjdGl2ZUVsZW1lbnRJbnN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gc2hvdWxkVXNlQ2xpY2tFdmVudChlbGVtKSB7CiAgICAgICAgICAgIHZhciBub2RlTmFtZSA9IGVsZW0ubm9kZU5hbWU7CiAgICAgICAgICAgIHJldHVybiBub2RlTmFtZSAmJiBub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiaW5wdXQiICYmIChlbGVtLnR5cGUgPT09ICJjaGVja2JveCIgfHwgZWxlbS50eXBlID09PSAicmFkaW8iKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldFRhcmdldEluc3RGb3JDbGlja0V2ZW50KGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAiY2xpY2siKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdldEluc3RJZlZhbHVlQ2hhbmdlZCh0YXJnZXRJbnN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0VGFyZ2V0SW5zdEZvcklucHV0T3JDaGFuZ2VFdmVudChkb21FdmVudE5hbWUsIHRhcmdldEluc3QpIHsKICAgICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gImlucHV0IiB8fCBkb21FdmVudE5hbWUgPT09ICJjaGFuZ2UiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdldEluc3RJZlZhbHVlQ2hhbmdlZCh0YXJnZXRJbnN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaGFuZGxlQ29udHJvbGxlZElucHV0Qmx1cihub2RlKSB7CiAgICAgICAgICAgIHZhciBzdGF0ZSA9IG5vZGUuX3dyYXBwZXJTdGF0ZTsKICAgICAgICAgICAgaWYgKCFzdGF0ZSB8fCAhc3RhdGUuY29udHJvbGxlZCB8fCBub2RlLnR5cGUgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzZXREZWZhdWx0VmFsdWUobm9kZSwgIm51bWJlciIsIG5vZGUudmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBleHRyYWN0RXZlbnRzJDEoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgICB2YXIgdGFyZ2V0Tm9kZSA9IHRhcmdldEluc3QgPyBnZXROb2RlRnJvbUluc3RhbmNlKHRhcmdldEluc3QpIDogd2luZG93OwogICAgICAgICAgICB2YXIgZ2V0VGFyZ2V0SW5zdEZ1bmMsIGhhbmRsZUV2ZW50RnVuYzsKICAgICAgICAgICAgaWYgKHNob3VsZFVzZUNoYW5nZUV2ZW50KHRhcmdldE5vZGUpKSB7CiAgICAgICAgICAgICAgZ2V0VGFyZ2V0SW5zdEZ1bmMgPSBnZXRUYXJnZXRJbnN0Rm9yQ2hhbmdlRXZlbnQ7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNUZXh0SW5wdXRFbGVtZW50KHRhcmdldE5vZGUpKSB7CiAgICAgICAgICAgICAgaWYgKGlzSW5wdXRFdmVudFN1cHBvcnRlZCkgewogICAgICAgICAgICAgICAgZ2V0VGFyZ2V0SW5zdEZ1bmMgPSBnZXRUYXJnZXRJbnN0Rm9ySW5wdXRPckNoYW5nZUV2ZW50OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBnZXRUYXJnZXRJbnN0RnVuYyA9IGdldFRhcmdldEluc3RGb3JJbnB1dEV2ZW50UG9seWZpbGw7CiAgICAgICAgICAgICAgICBoYW5kbGVFdmVudEZ1bmMgPSBoYW5kbGVFdmVudHNGb3JJbnB1dEV2ZW50UG9seWZpbGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHNob3VsZFVzZUNsaWNrRXZlbnQodGFyZ2V0Tm9kZSkpIHsKICAgICAgICAgICAgICBnZXRUYXJnZXRJbnN0RnVuYyA9IGdldFRhcmdldEluc3RGb3JDbGlja0V2ZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChnZXRUYXJnZXRJbnN0RnVuYykgewogICAgICAgICAgICAgIHZhciBpbnN0ID0gZ2V0VGFyZ2V0SW5zdEZ1bmMoZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0KTsKICAgICAgICAgICAgICBpZiAoaW5zdCkgewogICAgICAgICAgICAgICAgY3JlYXRlQW5kQWNjdW11bGF0ZUNoYW5nZUV2ZW50KGRpc3BhdGNoUXVldWUsIGluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChoYW5kbGVFdmVudEZ1bmMpIHsKICAgICAgICAgICAgICBoYW5kbGVFdmVudEZ1bmMoZG9tRXZlbnROYW1lLCB0YXJnZXROb2RlLCB0YXJnZXRJbnN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAiZm9jdXNvdXQiKSB7CiAgICAgICAgICAgICAgaGFuZGxlQ29udHJvbGxlZElucHV0Qmx1cih0YXJnZXROb2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJFdmVudHMkMigpIHsKICAgICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudCgib25Nb3VzZUVudGVyIiwgWyJtb3VzZW91dCIsICJtb3VzZW92ZXIiXSk7CiAgICAgICAgICAgIHJlZ2lzdGVyRGlyZWN0RXZlbnQoIm9uTW91c2VMZWF2ZSIsIFsibW91c2VvdXQiLCAibW91c2VvdmVyIl0pOwogICAgICAgICAgICByZWdpc3RlckRpcmVjdEV2ZW50KCJvblBvaW50ZXJFbnRlciIsIFsicG9pbnRlcm91dCIsICJwb2ludGVyb3ZlciJdKTsKICAgICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudCgib25Qb2ludGVyTGVhdmUiLCBbInBvaW50ZXJvdXQiLCAicG9pbnRlcm92ZXIiXSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBleHRyYWN0RXZlbnRzJDIoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgICB2YXIgaXNPdmVyRXZlbnQgPSBkb21FdmVudE5hbWUgPT09ICJtb3VzZW92ZXIiIHx8IGRvbUV2ZW50TmFtZSA9PT0gInBvaW50ZXJvdmVyIjsKICAgICAgICAgICAgdmFyIGlzT3V0RXZlbnQgPSBkb21FdmVudE5hbWUgPT09ICJtb3VzZW91dCIgfHwgZG9tRXZlbnROYW1lID09PSAicG9pbnRlcm91dCI7CiAgICAgICAgICAgIGlmIChpc092ZXJFdmVudCAmJiAhaXNSZXBsYXlpbmdFdmVudChuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgICB2YXIgcmVsYXRlZCA9IG5hdGl2ZUV2ZW50LnJlbGF0ZWRUYXJnZXQgfHwgbmF0aXZlRXZlbnQuZnJvbUVsZW1lbnQ7CiAgICAgICAgICAgICAgaWYgKHJlbGF0ZWQpIHsKICAgICAgICAgICAgICAgIGlmIChnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZShyZWxhdGVkKSB8fCBpc0NvbnRhaW5lck1hcmtlZEFzUm9vdChyZWxhdGVkKSkgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghaXNPdXRFdmVudCAmJiAhaXNPdmVyRXZlbnQpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHdpbjsKICAgICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50VGFyZ2V0LndpbmRvdyA9PT0gbmF0aXZlRXZlbnRUYXJnZXQpIHsKICAgICAgICAgICAgICB3aW4gPSBuYXRpdmVFdmVudFRhcmdldDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgZG9jID0gbmF0aXZlRXZlbnRUYXJnZXQub3duZXJEb2N1bWVudDsKICAgICAgICAgICAgICBpZiAoZG9jKSB7CiAgICAgICAgICAgICAgICB3aW4gPSBkb2MuZGVmYXVsdFZpZXcgfHwgZG9jLnBhcmVudFdpbmRvdzsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgd2luID0gd2luZG93OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZnJvbTsKICAgICAgICAgICAgdmFyIHRvOwogICAgICAgICAgICBpZiAoaXNPdXRFdmVudCkgewogICAgICAgICAgICAgIHZhciBfcmVsYXRlZCA9IG5hdGl2ZUV2ZW50LnJlbGF0ZWRUYXJnZXQgfHwgbmF0aXZlRXZlbnQudG9FbGVtZW50OwogICAgICAgICAgICAgIGZyb20gPSB0YXJnZXRJbnN0OwogICAgICAgICAgICAgIHRvID0gX3JlbGF0ZWQgPyBnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZShfcmVsYXRlZCkgOiBudWxsOwogICAgICAgICAgICAgIGlmICh0byAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIG5lYXJlc3RNb3VudGVkID0gZ2V0TmVhcmVzdE1vdW50ZWRGaWJlcih0byk7CiAgICAgICAgICAgICAgICBpZiAodG8gIT09IG5lYXJlc3RNb3VudGVkIHx8IHRvLnRhZyAhPT0gSG9zdENvbXBvbmVudCAmJiB0by50YWcgIT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgICAgICAgIHRvID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZnJvbSA9IG51bGw7CiAgICAgICAgICAgICAgdG8gPSB0YXJnZXRJbnN0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmcm9tID09PSB0bykgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljTW91c2VFdmVudDsKICAgICAgICAgICAgdmFyIGxlYXZlRXZlbnRUeXBlID0gIm9uTW91c2VMZWF2ZSI7CiAgICAgICAgICAgIHZhciBlbnRlckV2ZW50VHlwZSA9ICJvbk1vdXNlRW50ZXIiOwogICAgICAgICAgICB2YXIgZXZlbnRUeXBlUHJlZml4ID0gIm1vdXNlIjsKICAgICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gInBvaW50ZXJvdXQiIHx8IGRvbUV2ZW50TmFtZSA9PT0gInBvaW50ZXJvdmVyIikgewogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY1BvaW50ZXJFdmVudDsKICAgICAgICAgICAgICBsZWF2ZUV2ZW50VHlwZSA9ICJvblBvaW50ZXJMZWF2ZSI7CiAgICAgICAgICAgICAgZW50ZXJFdmVudFR5cGUgPSAib25Qb2ludGVyRW50ZXIiOwogICAgICAgICAgICAgIGV2ZW50VHlwZVByZWZpeCA9ICJwb2ludGVyIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZnJvbU5vZGUgPSBmcm9tID09IG51bGwgPyB3aW4gOiBnZXROb2RlRnJvbUluc3RhbmNlKGZyb20pOwogICAgICAgICAgICB2YXIgdG9Ob2RlID0gdG8gPT0gbnVsbCA/IHdpbiA6IGdldE5vZGVGcm9tSW5zdGFuY2UodG8pOwogICAgICAgICAgICB2YXIgbGVhdmUgPSBuZXcgU3ludGhldGljRXZlbnRDdG9yKGxlYXZlRXZlbnRUeXBlLCBldmVudFR5cGVQcmVmaXggKyAibGVhdmUiLCBmcm9tLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICBsZWF2ZS50YXJnZXQgPSBmcm9tTm9kZTsKICAgICAgICAgICAgbGVhdmUucmVsYXRlZFRhcmdldCA9IHRvTm9kZTsKICAgICAgICAgICAgdmFyIGVudGVyID0gbnVsbDsKICAgICAgICAgICAgdmFyIG5hdGl2ZVRhcmdldEluc3QgPSBnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZShuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgIGlmIChuYXRpdmVUYXJnZXRJbnN0ID09PSB0YXJnZXRJbnN0KSB7CiAgICAgICAgICAgICAgdmFyIGVudGVyRXZlbnQgPSBuZXcgU3ludGhldGljRXZlbnRDdG9yKGVudGVyRXZlbnRUeXBlLCBldmVudFR5cGVQcmVmaXggKyAiZW50ZXIiLCB0bywgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgICBlbnRlckV2ZW50LnRhcmdldCA9IHRvTm9kZTsKICAgICAgICAgICAgICBlbnRlckV2ZW50LnJlbGF0ZWRUYXJnZXQgPSBmcm9tTm9kZTsKICAgICAgICAgICAgICBlbnRlciA9IGVudGVyRXZlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYWNjdW11bGF0ZUVudGVyTGVhdmVUd29QaGFzZUxpc3RlbmVycyhkaXNwYXRjaFF1ZXVlLCBsZWF2ZSwgZW50ZXIsIGZyb20sIHRvKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGlzKHgyLCB5MikgewogICAgICAgICAgICByZXR1cm4geDIgPT09IHkyICYmICh4MiAhPT0gMCB8fCAxIC8geDIgPT09IDEgLyB5MikgfHwgeDIgIT09IHgyICYmIHkyICE9PSB5MjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBvYmplY3RJcyA9IHR5cGVvZiBPYmplY3QuaXMgPT09ICJmdW5jdGlvbiIgPyBPYmplY3QuaXMgOiBpczsKICAgICAgICAgIGZ1bmN0aW9uIHNoYWxsb3dFcXVhbChvYmpBLCBvYmpCKSB7CiAgICAgICAgICAgIGlmIChvYmplY3RJcyhvYmpBLCBvYmpCKSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2Ygb2JqQSAhPT0gIm9iamVjdCIgfHwgb2JqQSA9PT0gbnVsbCB8fCB0eXBlb2Ygb2JqQiAhPT0gIm9iamVjdCIgfHwgb2JqQiA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIga2V5c0EgPSBPYmplY3Qua2V5cyhvYmpBKTsKICAgICAgICAgICAgdmFyIGtleXNCID0gT2JqZWN0LmtleXMob2JqQik7CiAgICAgICAgICAgIGlmIChrZXlzQS5sZW5ndGggIT09IGtleXNCLmxlbmd0aCkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXNBLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnRLZXkgPSBrZXlzQVtpXTsKICAgICAgICAgICAgICBpZiAoIWhhc093blByb3BlcnR5LmNhbGwob2JqQiwgY3VycmVudEtleSkgfHwgIW9iamVjdElzKG9iakFbY3VycmVudEtleV0sIG9iakJbY3VycmVudEtleV0pKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0TGVhZk5vZGUobm9kZSkgewogICAgICAgICAgICB3aGlsZSAobm9kZSAmJiBub2RlLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5maXJzdENoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0U2libGluZ05vZGUobm9kZSkgewogICAgICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgICAgIGlmIChub2RlLm5leHRTaWJsaW5nKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbm9kZS5uZXh0U2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0Tm9kZUZvckNoYXJhY3Rlck9mZnNldChyb290Mywgb2Zmc2V0KSB7CiAgICAgICAgICAgIHZhciBub2RlID0gZ2V0TGVhZk5vZGUocm9vdDMpOwogICAgICAgICAgICB2YXIgbm9kZVN0YXJ0ID0gMDsKICAgICAgICAgICAgdmFyIG5vZGVFbmQgPSAwOwogICAgICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSBURVhUX05PREUpIHsKICAgICAgICAgICAgICAgIG5vZGVFbmQgPSBub2RlU3RhcnQgKyBub2RlLnRleHRDb250ZW50Lmxlbmd0aDsKICAgICAgICAgICAgICAgIGlmIChub2RlU3RhcnQgPD0gb2Zmc2V0ICYmIG5vZGVFbmQgPj0gb2Zmc2V0KSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgbm9kZSwKICAgICAgICAgICAgICAgICAgICBvZmZzZXQ6IG9mZnNldCAtIG5vZGVTdGFydAogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbm9kZVN0YXJ0ID0gbm9kZUVuZDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IGdldExlYWZOb2RlKGdldFNpYmxpbmdOb2RlKG5vZGUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0T2Zmc2V0cyhvdXRlck5vZGUpIHsKICAgICAgICAgICAgdmFyIG93bmVyRG9jdW1lbnQgPSBvdXRlck5vZGUub3duZXJEb2N1bWVudDsKICAgICAgICAgICAgdmFyIHdpbiA9IG93bmVyRG9jdW1lbnQgJiYgb3duZXJEb2N1bWVudC5kZWZhdWx0VmlldyB8fCB3aW5kb3c7CiAgICAgICAgICAgIHZhciBzZWxlY3Rpb24yID0gd2luLmdldFNlbGVjdGlvbiAmJiB3aW4uZ2V0U2VsZWN0aW9uKCk7CiAgICAgICAgICAgIGlmICghc2VsZWN0aW9uMiB8fCBzZWxlY3Rpb24yLnJhbmdlQ291bnQgPT09IDApIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYW5jaG9yTm9kZSA9IHNlbGVjdGlvbjIuYW5jaG9yTm9kZSwgYW5jaG9yT2Zmc2V0ID0gc2VsZWN0aW9uMi5hbmNob3JPZmZzZXQsIGZvY3VzTm9kZSA9IHNlbGVjdGlvbjIuZm9jdXNOb2RlLCBmb2N1c09mZnNldCA9IHNlbGVjdGlvbjIuZm9jdXNPZmZzZXQ7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgYW5jaG9yTm9kZS5ub2RlVHlwZTsKICAgICAgICAgICAgICBmb2N1c05vZGUubm9kZVR5cGU7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZ2V0TW9kZXJuT2Zmc2V0c0Zyb21Qb2ludHMob3V0ZXJOb2RlLCBhbmNob3JOb2RlLCBhbmNob3JPZmZzZXQsIGZvY3VzTm9kZSwgZm9jdXNPZmZzZXQpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0TW9kZXJuT2Zmc2V0c0Zyb21Qb2ludHMob3V0ZXJOb2RlLCBhbmNob3JOb2RlLCBhbmNob3JPZmZzZXQsIGZvY3VzTm9kZSwgZm9jdXNPZmZzZXQpIHsKICAgICAgICAgICAgdmFyIGxlbmd0aCA9IDA7CiAgICAgICAgICAgIHZhciBzdGFydDIgPSAtMTsKICAgICAgICAgICAgdmFyIGVuZCA9IC0xOwogICAgICAgICAgICB2YXIgaW5kZXhXaXRoaW5BbmNob3IgPSAwOwogICAgICAgICAgICB2YXIgaW5kZXhXaXRoaW5Gb2N1cyA9IDA7CiAgICAgICAgICAgIHZhciBub2RlID0gb3V0ZXJOb2RlOwogICAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IG51bGw7CiAgICAgICAgICAgIG91dGVyOgogICAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgICB2YXIgbmV4dCA9IG51bGw7CiAgICAgICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gYW5jaG9yTm9kZSAmJiAoYW5jaG9yT2Zmc2V0ID09PSAwIHx8IG5vZGUubm9kZVR5cGUgPT09IFRFWFRfTk9ERSkpIHsKICAgICAgICAgICAgICAgICAgICBzdGFydDIgPSBsZW5ndGggKyBhbmNob3JPZmZzZXQ7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IGZvY3VzTm9kZSAmJiAoZm9jdXNPZmZzZXQgPT09IDAgfHwgbm9kZS5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFKSkgewogICAgICAgICAgICAgICAgICAgIGVuZCA9IGxlbmd0aCArIGZvY3VzT2Zmc2V0OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSBURVhUX05PREUpIHsKICAgICAgICAgICAgICAgICAgICBsZW5ndGggKz0gbm9kZS5ub2RlVmFsdWUubGVuZ3RoOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICgobmV4dCA9IG5vZGUuZmlyc3RDaGlsZCkgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBwYXJlbnROb2RlID0gbm9kZTsKICAgICAgICAgICAgICAgICAgbm9kZSA9IG5leHQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gb3V0ZXJOb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgb3V0ZXI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudE5vZGUgPT09IGFuY2hvck5vZGUgJiYgKytpbmRleFdpdGhpbkFuY2hvciA9PT0gYW5jaG9yT2Zmc2V0KSB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnQyID0gbGVuZ3RoOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnROb2RlID09PSBmb2N1c05vZGUgJiYgKytpbmRleFdpdGhpbkZvY3VzID09PSBmb2N1c09mZnNldCkgewogICAgICAgICAgICAgICAgICAgIGVuZCA9IGxlbmd0aDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoKG5leHQgPSBub2RlLm5leHRTaWJsaW5nKSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIG5vZGUgPSBwYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICBwYXJlbnROb2RlID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbm9kZSA9IG5leHQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc3RhcnQyID09PSAtMSB8fCBlbmQgPT09IC0xKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBzdGFydDogc3RhcnQyLAogICAgICAgICAgICAgIGVuZAogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gc2V0T2Zmc2V0cyhub2RlLCBvZmZzZXRzKSB7CiAgICAgICAgICAgIHZhciBkb2MgPSBub2RlLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQ7CiAgICAgICAgICAgIHZhciB3aW4gPSBkb2MgJiYgZG9jLmRlZmF1bHRWaWV3IHx8IHdpbmRvdzsKICAgICAgICAgICAgaWYgKCF3aW4uZ2V0U2VsZWN0aW9uKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzZWxlY3Rpb24yID0gd2luLmdldFNlbGVjdGlvbigpOwogICAgICAgICAgICB2YXIgbGVuZ3RoID0gbm9kZS50ZXh0Q29udGVudC5sZW5ndGg7CiAgICAgICAgICAgIHZhciBzdGFydDIgPSBNYXRoLm1pbihvZmZzZXRzLnN0YXJ0LCBsZW5ndGgpOwogICAgICAgICAgICB2YXIgZW5kID0gb2Zmc2V0cy5lbmQgPT09IHZvaWQgMCA/IHN0YXJ0MiA6IE1hdGgubWluKG9mZnNldHMuZW5kLCBsZW5ndGgpOwogICAgICAgICAgICBpZiAoIXNlbGVjdGlvbjIuZXh0ZW5kICYmIHN0YXJ0MiA+IGVuZCkgewogICAgICAgICAgICAgIHZhciB0ZW1wID0gZW5kOwogICAgICAgICAgICAgIGVuZCA9IHN0YXJ0MjsKICAgICAgICAgICAgICBzdGFydDIgPSB0ZW1wOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzdGFydE1hcmtlciA9IGdldE5vZGVGb3JDaGFyYWN0ZXJPZmZzZXQobm9kZSwgc3RhcnQyKTsKICAgICAgICAgICAgdmFyIGVuZE1hcmtlciA9IGdldE5vZGVGb3JDaGFyYWN0ZXJPZmZzZXQobm9kZSwgZW5kKTsKICAgICAgICAgICAgaWYgKHN0YXJ0TWFya2VyICYmIGVuZE1hcmtlcikgewogICAgICAgICAgICAgIGlmIChzZWxlY3Rpb24yLnJhbmdlQ291bnQgPT09IDEgJiYgc2VsZWN0aW9uMi5hbmNob3JOb2RlID09PSBzdGFydE1hcmtlci5ub2RlICYmIHNlbGVjdGlvbjIuYW5jaG9yT2Zmc2V0ID09PSBzdGFydE1hcmtlci5vZmZzZXQgJiYgc2VsZWN0aW9uMi5mb2N1c05vZGUgPT09IGVuZE1hcmtlci5ub2RlICYmIHNlbGVjdGlvbjIuZm9jdXNPZmZzZXQgPT09IGVuZE1hcmtlci5vZmZzZXQpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHJhbmdlID0gZG9jLmNyZWF0ZVJhbmdlKCk7CiAgICAgICAgICAgICAgcmFuZ2Uuc2V0U3RhcnQoc3RhcnRNYXJrZXIubm9kZSwgc3RhcnRNYXJrZXIub2Zmc2V0KTsKICAgICAgICAgICAgICBzZWxlY3Rpb24yLnJlbW92ZUFsbFJhbmdlcygpOwogICAgICAgICAgICAgIGlmIChzdGFydDIgPiBlbmQpIHsKICAgICAgICAgICAgICAgIHNlbGVjdGlvbjIuYWRkUmFuZ2UocmFuZ2UpOwogICAgICAgICAgICAgICAgc2VsZWN0aW9uMi5leHRlbmQoZW5kTWFya2VyLm5vZGUsIGVuZE1hcmtlci5vZmZzZXQpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByYW5nZS5zZXRFbmQoZW5kTWFya2VyLm5vZGUsIGVuZE1hcmtlci5vZmZzZXQpOwogICAgICAgICAgICAgICAgc2VsZWN0aW9uMi5hZGRSYW5nZShyYW5nZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpc1RleHROb2RlKG5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIG5vZGUgJiYgbm9kZS5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY29udGFpbnNOb2RlKG91dGVyTm9kZSwgaW5uZXJOb2RlKSB7CiAgICAgICAgICAgIGlmICghb3V0ZXJOb2RlIHx8ICFpbm5lck5vZGUpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gZWxzZSBpZiAob3V0ZXJOb2RlID09PSBpbm5lck5vZGUpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc1RleHROb2RlKG91dGVyTm9kZSkpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNUZXh0Tm9kZShpbm5lck5vZGUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5zTm9kZShvdXRlck5vZGUsIGlubmVyTm9kZS5wYXJlbnROb2RlKTsKICAgICAgICAgICAgfSBlbHNlIGlmICgiY29udGFpbnMiIGluIG91dGVyTm9kZSkgewogICAgICAgICAgICAgIHJldHVybiBvdXRlck5vZGUuY29udGFpbnMoaW5uZXJOb2RlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChvdXRlck5vZGUuY29tcGFyZURvY3VtZW50UG9zaXRpb24pIHsKICAgICAgICAgICAgICByZXR1cm4gISEob3V0ZXJOb2RlLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKGlubmVyTm9kZSkgJiAxNik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpc0luRG9jdW1lbnQobm9kZSkgewogICAgICAgICAgICByZXR1cm4gbm9kZSAmJiBub2RlLm93bmVyRG9jdW1lbnQgJiYgY29udGFpbnNOb2RlKG5vZGUub3duZXJEb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsIG5vZGUpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaXNTYW1lT3JpZ2luRnJhbWUoaWZyYW1lKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBpZnJhbWUuY29udGVudFdpbmRvdy5sb2NhdGlvbi5ocmVmID09PSAic3RyaW5nIjsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRBY3RpdmVFbGVtZW50RGVlcCgpIHsKICAgICAgICAgICAgdmFyIHdpbiA9IHdpbmRvdzsKICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBnZXRBY3RpdmVFbGVtZW50KCk7CiAgICAgICAgICAgIHdoaWxlIChlbGVtZW50IGluc3RhbmNlb2Ygd2luLkhUTUxJRnJhbWVFbGVtZW50KSB7CiAgICAgICAgICAgICAgaWYgKGlzU2FtZU9yaWdpbkZyYW1lKGVsZW1lbnQpKSB7CiAgICAgICAgICAgICAgICB3aW4gPSBlbGVtZW50LmNvbnRlbnRXaW5kb3c7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbGVtZW50ID0gZ2V0QWN0aXZlRWxlbWVudCh3aW4uZG9jdW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaGFzU2VsZWN0aW9uQ2FwYWJpbGl0aWVzKGVsZW0pIHsKICAgICAgICAgICAgdmFyIG5vZGVOYW1lID0gZWxlbSAmJiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgcmV0dXJuIG5vZGVOYW1lICYmIChub2RlTmFtZSA9PT0gImlucHV0IiAmJiAoZWxlbS50eXBlID09PSAidGV4dCIgfHwgZWxlbS50eXBlID09PSAic2VhcmNoIiB8fCBlbGVtLnR5cGUgPT09ICJ0ZWwiIHx8IGVsZW0udHlwZSA9PT0gInVybCIgfHwgZWxlbS50eXBlID09PSAicGFzc3dvcmQiKSB8fCBub2RlTmFtZSA9PT0gInRleHRhcmVhIiB8fCBlbGVtLmNvbnRlbnRFZGl0YWJsZSA9PT0gInRydWUiKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldFNlbGVjdGlvbkluZm9ybWF0aW9uKCkgewogICAgICAgICAgICB2YXIgZm9jdXNlZEVsZW0gPSBnZXRBY3RpdmVFbGVtZW50RGVlcCgpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIGZvY3VzZWRFbGVtLAogICAgICAgICAgICAgIHNlbGVjdGlvblJhbmdlOiBoYXNTZWxlY3Rpb25DYXBhYmlsaXRpZXMoZm9jdXNlZEVsZW0pID8gZ2V0U2VsZWN0aW9uKGZvY3VzZWRFbGVtKSA6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVTZWxlY3Rpb24ocHJpb3JTZWxlY3Rpb25JbmZvcm1hdGlvbikgewogICAgICAgICAgICB2YXIgY3VyRm9jdXNlZEVsZW0gPSBnZXRBY3RpdmVFbGVtZW50RGVlcCgpOwogICAgICAgICAgICB2YXIgcHJpb3JGb2N1c2VkRWxlbSA9IHByaW9yU2VsZWN0aW9uSW5mb3JtYXRpb24uZm9jdXNlZEVsZW07CiAgICAgICAgICAgIHZhciBwcmlvclNlbGVjdGlvblJhbmdlID0gcHJpb3JTZWxlY3Rpb25JbmZvcm1hdGlvbi5zZWxlY3Rpb25SYW5nZTsKICAgICAgICAgICAgaWYgKGN1ckZvY3VzZWRFbGVtICE9PSBwcmlvckZvY3VzZWRFbGVtICYmIGlzSW5Eb2N1bWVudChwcmlvckZvY3VzZWRFbGVtKSkgewogICAgICAgICAgICAgIGlmIChwcmlvclNlbGVjdGlvblJhbmdlICE9PSBudWxsICYmIGhhc1NlbGVjdGlvbkNhcGFiaWxpdGllcyhwcmlvckZvY3VzZWRFbGVtKSkgewogICAgICAgICAgICAgICAgc2V0U2VsZWN0aW9uKHByaW9yRm9jdXNlZEVsZW0sIHByaW9yU2VsZWN0aW9uUmFuZ2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgYW5jZXN0b3JzID0gW107CiAgICAgICAgICAgICAgdmFyIGFuY2VzdG9yID0gcHJpb3JGb2N1c2VkRWxlbTsKICAgICAgICAgICAgICB3aGlsZSAoYW5jZXN0b3IgPSBhbmNlc3Rvci5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgICBpZiAoYW5jZXN0b3Iubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSkgewogICAgICAgICAgICAgICAgICBhbmNlc3RvcnMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudDogYW5jZXN0b3IsCiAgICAgICAgICAgICAgICAgICAgbGVmdDogYW5jZXN0b3Iuc2Nyb2xsTGVmdCwKICAgICAgICAgICAgICAgICAgICB0b3A6IGFuY2VzdG9yLnNjcm9sbFRvcAogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwcmlvckZvY3VzZWRFbGVtLmZvY3VzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBwcmlvckZvY3VzZWRFbGVtLmZvY3VzKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYW5jZXN0b3JzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgaW5mbyA9IGFuY2VzdG9yc1tpXTsKICAgICAgICAgICAgICAgIGluZm8uZWxlbWVudC5zY3JvbGxMZWZ0ID0gaW5mby5sZWZ0OwogICAgICAgICAgICAgICAgaW5mby5lbGVtZW50LnNjcm9sbFRvcCA9IGluZm8udG9wOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0U2VsZWN0aW9uKGlucHV0KSB7CiAgICAgICAgICAgIHZhciBzZWxlY3Rpb24yOwogICAgICAgICAgICBpZiAoInNlbGVjdGlvblN0YXJ0IiBpbiBpbnB1dCkgewogICAgICAgICAgICAgIHNlbGVjdGlvbjIgPSB7CiAgICAgICAgICAgICAgICBzdGFydDogaW5wdXQuc2VsZWN0aW9uU3RhcnQsCiAgICAgICAgICAgICAgICBlbmQ6IGlucHV0LnNlbGVjdGlvbkVuZAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2VsZWN0aW9uMiA9IGdldE9mZnNldHMoaW5wdXQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzZWxlY3Rpb24yIHx8IHsKICAgICAgICAgICAgICBzdGFydDogMCwKICAgICAgICAgICAgICBlbmQ6IDAKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHNldFNlbGVjdGlvbihpbnB1dCwgb2Zmc2V0cykgewogICAgICAgICAgICB2YXIgc3RhcnQyID0gb2Zmc2V0cy5zdGFydDsKICAgICAgICAgICAgdmFyIGVuZCA9IG9mZnNldHMuZW5kOwogICAgICAgICAgICBpZiAoZW5kID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICBlbmQgPSBzdGFydDI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCJzZWxlY3Rpb25TdGFydCIgaW4gaW5wdXQpIHsKICAgICAgICAgICAgICBpbnB1dC5zZWxlY3Rpb25TdGFydCA9IHN0YXJ0MjsKICAgICAgICAgICAgICBpbnB1dC5zZWxlY3Rpb25FbmQgPSBNYXRoLm1pbihlbmQsIGlucHV0LnZhbHVlLmxlbmd0aCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2V0T2Zmc2V0cyhpbnB1dCwgb2Zmc2V0cyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBza2lwU2VsZWN0aW9uQ2hhbmdlRXZlbnQgPSBjYW5Vc2VET00gJiYgImRvY3VtZW50TW9kZSIgaW4gZG9jdW1lbnQgJiYgZG9jdW1lbnQuZG9jdW1lbnRNb2RlIDw9IDExOwogICAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJFdmVudHMkMygpIHsKICAgICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KCJvblNlbGVjdCIsIFsiZm9jdXNvdXQiLCAiY29udGV4dG1lbnUiLCAiZHJhZ2VuZCIsICJmb2N1c2luIiwgImtleWRvd24iLCAia2V5dXAiLCAibW91c2Vkb3duIiwgIm1vdXNldXAiLCAic2VsZWN0aW9uY2hhbmdlIl0pOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGFjdGl2ZUVsZW1lbnQkMSA9IG51bGw7CiAgICAgICAgICB2YXIgYWN0aXZlRWxlbWVudEluc3QkMSA9IG51bGw7CiAgICAgICAgICB2YXIgbGFzdFNlbGVjdGlvbiA9IG51bGw7CiAgICAgICAgICB2YXIgbW91c2VEb3duID0gZmFsc2U7CiAgICAgICAgICBmdW5jdGlvbiBnZXRTZWxlY3Rpb24kMShub2RlKSB7CiAgICAgICAgICAgIGlmICgic2VsZWN0aW9uU3RhcnQiIGluIG5vZGUgJiYgaGFzU2VsZWN0aW9uQ2FwYWJpbGl0aWVzKG5vZGUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIHN0YXJ0OiBub2RlLnNlbGVjdGlvblN0YXJ0LAogICAgICAgICAgICAgICAgZW5kOiBub2RlLnNlbGVjdGlvbkVuZAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHdpbiA9IG5vZGUub3duZXJEb2N1bWVudCAmJiBub2RlLm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXcgfHwgd2luZG93OwogICAgICAgICAgICAgIHZhciBzZWxlY3Rpb24yID0gd2luLmdldFNlbGVjdGlvbigpOwogICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBhbmNob3JOb2RlOiBzZWxlY3Rpb24yLmFuY2hvck5vZGUsCiAgICAgICAgICAgICAgICBhbmNob3JPZmZzZXQ6IHNlbGVjdGlvbjIuYW5jaG9yT2Zmc2V0LAogICAgICAgICAgICAgICAgZm9jdXNOb2RlOiBzZWxlY3Rpb24yLmZvY3VzTm9kZSwKICAgICAgICAgICAgICAgIGZvY3VzT2Zmc2V0OiBzZWxlY3Rpb24yLmZvY3VzT2Zmc2V0CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRUYXJnZXREb2N1bWVudChldmVudFRhcmdldCkgewogICAgICAgICAgICByZXR1cm4gZXZlbnRUYXJnZXQud2luZG93ID09PSBldmVudFRhcmdldCA/IGV2ZW50VGFyZ2V0LmRvY3VtZW50IDogZXZlbnRUYXJnZXQubm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUgPyBldmVudFRhcmdldCA6IGV2ZW50VGFyZ2V0Lm93bmVyRG9jdW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjb25zdHJ1Y3RTZWxlY3RFdmVudChkaXNwYXRjaFF1ZXVlLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpIHsKICAgICAgICAgICAgdmFyIGRvYyA9IGdldEV2ZW50VGFyZ2V0RG9jdW1lbnQobmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICBpZiAobW91c2VEb3duIHx8IGFjdGl2ZUVsZW1lbnQkMSA9PSBudWxsIHx8IGFjdGl2ZUVsZW1lbnQkMSAhPT0gZ2V0QWN0aXZlRWxlbWVudChkb2MpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjdXJyZW50U2VsZWN0aW9uID0gZ2V0U2VsZWN0aW9uJDEoYWN0aXZlRWxlbWVudCQxKTsKICAgICAgICAgICAgaWYgKCFsYXN0U2VsZWN0aW9uIHx8ICFzaGFsbG93RXF1YWwobGFzdFNlbGVjdGlvbiwgY3VycmVudFNlbGVjdGlvbikpIHsKICAgICAgICAgICAgICBsYXN0U2VsZWN0aW9uID0gY3VycmVudFNlbGVjdGlvbjsKICAgICAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gYWNjdW11bGF0ZVR3b1BoYXNlTGlzdGVuZXJzKGFjdGl2ZUVsZW1lbnRJbnN0JDEsICJvblNlbGVjdCIpOwogICAgICAgICAgICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gbmV3IFN5bnRoZXRpY0V2ZW50KCJvblNlbGVjdCIsICJzZWxlY3QiLCBudWxsLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICAgICAgZGlzcGF0Y2hRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICAgICAgZXZlbnQsCiAgICAgICAgICAgICAgICAgIGxpc3RlbmVycwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBldmVudC50YXJnZXQgPSBhY3RpdmVFbGVtZW50JDE7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBleHRyYWN0RXZlbnRzJDMoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgICB2YXIgdGFyZ2V0Tm9kZSA9IHRhcmdldEluc3QgPyBnZXROb2RlRnJvbUluc3RhbmNlKHRhcmdldEluc3QpIDogd2luZG93OwogICAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICAgIGNhc2UgImZvY3VzaW4iOgogICAgICAgICAgICAgICAgaWYgKGlzVGV4dElucHV0RWxlbWVudCh0YXJnZXROb2RlKSB8fCB0YXJnZXROb2RlLmNvbnRlbnRFZGl0YWJsZSA9PT0gInRydWUiKSB7CiAgICAgICAgICAgICAgICAgIGFjdGl2ZUVsZW1lbnQkMSA9IHRhcmdldE5vZGU7CiAgICAgICAgICAgICAgICAgIGFjdGl2ZUVsZW1lbnRJbnN0JDEgPSB0YXJnZXRJbnN0OwogICAgICAgICAgICAgICAgICBsYXN0U2VsZWN0aW9uID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgImZvY3Vzb3V0IjoKICAgICAgICAgICAgICAgIGFjdGl2ZUVsZW1lbnQkMSA9IG51bGw7CiAgICAgICAgICAgICAgICBhY3RpdmVFbGVtZW50SW5zdCQxID0gbnVsbDsKICAgICAgICAgICAgICAgIGxhc3RTZWxlY3Rpb24gPSBudWxsOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAibW91c2Vkb3duIjoKICAgICAgICAgICAgICAgIG1vdXNlRG93biA9IHRydWU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJjb250ZXh0bWVudSI6CiAgICAgICAgICAgICAgY2FzZSAibW91c2V1cCI6CiAgICAgICAgICAgICAgY2FzZSAiZHJhZ2VuZCI6CiAgICAgICAgICAgICAgICBtb3VzZURvd24gPSBmYWxzZTsKICAgICAgICAgICAgICAgIGNvbnN0cnVjdFNlbGVjdEV2ZW50KGRpc3BhdGNoUXVldWUsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJzZWxlY3Rpb25jaGFuZ2UiOgogICAgICAgICAgICAgICAgaWYgKHNraXBTZWxlY3Rpb25DaGFuZ2VFdmVudCkgewogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlICJrZXlkb3duIjoKICAgICAgICAgICAgICBjYXNlICJrZXl1cCI6CiAgICAgICAgICAgICAgICBjb25zdHJ1Y3RTZWxlY3RFdmVudChkaXNwYXRjaFF1ZXVlLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtYWtlUHJlZml4TWFwKHN0eWxlUHJvcCwgZXZlbnROYW1lKSB7CiAgICAgICAgICAgIHZhciBwcmVmaXhlczIgPSB7fTsKICAgICAgICAgICAgcHJlZml4ZXMyW3N0eWxlUHJvcC50b0xvd2VyQ2FzZSgpXSA9IGV2ZW50TmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBwcmVmaXhlczJbIldlYmtpdCIgKyBzdHlsZVByb3BdID0gIndlYmtpdCIgKyBldmVudE5hbWU7CiAgICAgICAgICAgIHByZWZpeGVzMlsiTW96IiArIHN0eWxlUHJvcF0gPSAibW96IiArIGV2ZW50TmFtZTsKICAgICAgICAgICAgcmV0dXJuIHByZWZpeGVzMjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB2ZW5kb3JQcmVmaXhlcyA9IHsKICAgICAgICAgICAgYW5pbWF0aW9uZW5kOiBtYWtlUHJlZml4TWFwKCJBbmltYXRpb24iLCAiQW5pbWF0aW9uRW5kIiksCiAgICAgICAgICAgIGFuaW1hdGlvbml0ZXJhdGlvbjogbWFrZVByZWZpeE1hcCgiQW5pbWF0aW9uIiwgIkFuaW1hdGlvbkl0ZXJhdGlvbiIpLAogICAgICAgICAgICBhbmltYXRpb25zdGFydDogbWFrZVByZWZpeE1hcCgiQW5pbWF0aW9uIiwgIkFuaW1hdGlvblN0YXJ0IiksCiAgICAgICAgICAgIHRyYW5zaXRpb25lbmQ6IG1ha2VQcmVmaXhNYXAoIlRyYW5zaXRpb24iLCAiVHJhbnNpdGlvbkVuZCIpCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHByZWZpeGVkRXZlbnROYW1lcyA9IHt9OwogICAgICAgICAgdmFyIHN0eWxlID0ge307CiAgICAgICAgICBpZiAoY2FuVXNlRE9NKSB7CiAgICAgICAgICAgIHN0eWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iikuc3R5bGU7CiAgICAgICAgICAgIGlmICghKCJBbmltYXRpb25FdmVudCIgaW4gd2luZG93KSkgewogICAgICAgICAgICAgIGRlbGV0ZSB2ZW5kb3JQcmVmaXhlcy5hbmltYXRpb25lbmQuYW5pbWF0aW9uOwogICAgICAgICAgICAgIGRlbGV0ZSB2ZW5kb3JQcmVmaXhlcy5hbmltYXRpb25pdGVyYXRpb24uYW5pbWF0aW9uOwogICAgICAgICAgICAgIGRlbGV0ZSB2ZW5kb3JQcmVmaXhlcy5hbmltYXRpb25zdGFydC5hbmltYXRpb247CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCEoIlRyYW5zaXRpb25FdmVudCIgaW4gd2luZG93KSkgewogICAgICAgICAgICAgIGRlbGV0ZSB2ZW5kb3JQcmVmaXhlcy50cmFuc2l0aW9uZW5kLnRyYW5zaXRpb247CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldFZlbmRvclByZWZpeGVkRXZlbnROYW1lKGV2ZW50TmFtZSkgewogICAgICAgICAgICBpZiAocHJlZml4ZWRFdmVudE5hbWVzW2V2ZW50TmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm4gcHJlZml4ZWRFdmVudE5hbWVzW2V2ZW50TmFtZV07CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIXZlbmRvclByZWZpeGVzW2V2ZW50TmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm4gZXZlbnROYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwcmVmaXhNYXAgPSB2ZW5kb3JQcmVmaXhlc1tldmVudE5hbWVdOwogICAgICAgICAgICBmb3IgKHZhciBzdHlsZVByb3AgaW4gcHJlZml4TWFwKSB7CiAgICAgICAgICAgICAgaWYgKHByZWZpeE1hcC5oYXNPd25Qcm9wZXJ0eShzdHlsZVByb3ApICYmIHN0eWxlUHJvcCBpbiBzdHlsZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHByZWZpeGVkRXZlbnROYW1lc1tldmVudE5hbWVdID0gcHJlZml4TWFwW3N0eWxlUHJvcF07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBldmVudE5hbWU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgQU5JTUFUSU9OX0VORCA9IGdldFZlbmRvclByZWZpeGVkRXZlbnROYW1lKCJhbmltYXRpb25lbmQiKTsKICAgICAgICAgIHZhciBBTklNQVRJT05fSVRFUkFUSU9OID0gZ2V0VmVuZG9yUHJlZml4ZWRFdmVudE5hbWUoImFuaW1hdGlvbml0ZXJhdGlvbiIpOwogICAgICAgICAgdmFyIEFOSU1BVElPTl9TVEFSVCA9IGdldFZlbmRvclByZWZpeGVkRXZlbnROYW1lKCJhbmltYXRpb25zdGFydCIpOwogICAgICAgICAgdmFyIFRSQU5TSVRJT05fRU5EID0gZ2V0VmVuZG9yUHJlZml4ZWRFdmVudE5hbWUoInRyYW5zaXRpb25lbmQiKTsKICAgICAgICAgIHZhciB0b3BMZXZlbEV2ZW50c1RvUmVhY3ROYW1lcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgICB2YXIgc2ltcGxlRXZlbnRQbHVnaW5FdmVudHMgPSBbImFib3J0IiwgImF1eENsaWNrIiwgImNhbmNlbCIsICJjYW5QbGF5IiwgImNhblBsYXlUaHJvdWdoIiwgImNsaWNrIiwgImNsb3NlIiwgImNvbnRleHRNZW51IiwgImNvcHkiLCAiY3V0IiwgImRyYWciLCAiZHJhZ0VuZCIsICJkcmFnRW50ZXIiLCAiZHJhZ0V4aXQiLCAiZHJhZ0xlYXZlIiwgImRyYWdPdmVyIiwgImRyYWdTdGFydCIsICJkcm9wIiwgImR1cmF0aW9uQ2hhbmdlIiwgImVtcHRpZWQiLCAiZW5jcnlwdGVkIiwgImVuZGVkIiwgImVycm9yIiwgImdvdFBvaW50ZXJDYXB0dXJlIiwgImlucHV0IiwgImludmFsaWQiLCAia2V5RG93biIsICJrZXlQcmVzcyIsICJrZXlVcCIsICJsb2FkIiwgImxvYWRlZERhdGEiLCAibG9hZGVkTWV0YWRhdGEiLCAibG9hZFN0YXJ0IiwgImxvc3RQb2ludGVyQ2FwdHVyZSIsICJtb3VzZURvd24iLCAibW91c2VNb3ZlIiwgIm1vdXNlT3V0IiwgIm1vdXNlT3ZlciIsICJtb3VzZVVwIiwgInBhc3RlIiwgInBhdXNlIiwgInBsYXkiLCAicGxheWluZyIsICJwb2ludGVyQ2FuY2VsIiwgInBvaW50ZXJEb3duIiwgInBvaW50ZXJNb3ZlIiwgInBvaW50ZXJPdXQiLCAicG9pbnRlck92ZXIiLCAicG9pbnRlclVwIiwgInByb2dyZXNzIiwgInJhdGVDaGFuZ2UiLCAicmVzZXQiLCAicmVzaXplIiwgInNlZWtlZCIsICJzZWVraW5nIiwgInN0YWxsZWQiLCAic3VibWl0IiwgInN1c3BlbmQiLCAidGltZVVwZGF0ZSIsICJ0b3VjaENhbmNlbCIsICJ0b3VjaEVuZCIsICJ0b3VjaFN0YXJ0IiwgInZvbHVtZUNoYW5nZSIsICJzY3JvbGwiLCAidG9nZ2xlIiwgInRvdWNoTW92ZSIsICJ3YWl0aW5nIiwgIndoZWVsIl07CiAgICAgICAgICBmdW5jdGlvbiByZWdpc3RlclNpbXBsZUV2ZW50KGRvbUV2ZW50TmFtZSwgcmVhY3ROYW1lKSB7CiAgICAgICAgICAgIHRvcExldmVsRXZlbnRzVG9SZWFjdE5hbWVzLnNldChkb21FdmVudE5hbWUsIHJlYWN0TmFtZSk7CiAgICAgICAgICAgIHJlZ2lzdGVyVHdvUGhhc2VFdmVudChyZWFjdE5hbWUsIFtkb21FdmVudE5hbWVdKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyU2ltcGxlRXZlbnRzKCkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNpbXBsZUV2ZW50UGx1Z2luRXZlbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGV2ZW50TmFtZSA9IHNpbXBsZUV2ZW50UGx1Z2luRXZlbnRzW2ldOwogICAgICAgICAgICAgIHZhciBkb21FdmVudE5hbWUgPSBldmVudE5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICB2YXIgY2FwaXRhbGl6ZWRFdmVudCA9IGV2ZW50TmFtZVswXS50b1VwcGVyQ2FzZSgpICsgZXZlbnROYW1lLnNsaWNlKDEpOwogICAgICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoZG9tRXZlbnROYW1lLCAib24iICsgY2FwaXRhbGl6ZWRFdmVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudChBTklNQVRJT05fRU5ELCAib25BbmltYXRpb25FbmQiKTsKICAgICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudChBTklNQVRJT05fSVRFUkFUSU9OLCAib25BbmltYXRpb25JdGVyYXRpb24iKTsKICAgICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudChBTklNQVRJT05fU1RBUlQsICJvbkFuaW1hdGlvblN0YXJ0Iik7CiAgICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoImRibGNsaWNrIiwgIm9uRG91YmxlQ2xpY2siKTsKICAgICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudCgiZm9jdXNpbiIsICJvbkZvY3VzIik7CiAgICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoImZvY3Vzb3V0IiwgIm9uQmx1ciIpOwogICAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KFRSQU5TSVRJT05fRU5ELCAib25UcmFuc2l0aW9uRW5kIik7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBleHRyYWN0RXZlbnRzJDQoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgICB2YXIgcmVhY3ROYW1lID0gdG9wTGV2ZWxFdmVudHNUb1JlYWN0TmFtZXMuZ2V0KGRvbUV2ZW50TmFtZSk7CiAgICAgICAgICAgIGlmIChyZWFjdE5hbWUgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljRXZlbnQ7CiAgICAgICAgICAgIHZhciByZWFjdEV2ZW50VHlwZSA9IGRvbUV2ZW50TmFtZTsKICAgICAgICAgICAgc3dpdGNoIChkb21FdmVudE5hbWUpIHsKICAgICAgICAgICAgICBjYXNlICJrZXlwcmVzcyI6CiAgICAgICAgICAgICAgICBpZiAoZ2V0RXZlbnRDaGFyQ29kZShuYXRpdmVFdmVudCkgPT09IDApIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgImtleWRvd24iOgogICAgICAgICAgICAgIGNhc2UgImtleXVwIjoKICAgICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0tleWJvYXJkRXZlbnQ7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJmb2N1c2luIjoKICAgICAgICAgICAgICAgIHJlYWN0RXZlbnRUeXBlID0gImZvY3VzIjsKICAgICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0ZvY3VzRXZlbnQ7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJmb2N1c291dCI6CiAgICAgICAgICAgICAgICByZWFjdEV2ZW50VHlwZSA9ICJibHVyIjsKICAgICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0ZvY3VzRXZlbnQ7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJiZWZvcmVibHVyIjoKICAgICAgICAgICAgICBjYXNlICJhZnRlcmJsdXIiOgogICAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljRm9jdXNFdmVudDsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgImNsaWNrIjoKICAgICAgICAgICAgICAgIGlmIChuYXRpdmVFdmVudC5idXR0b24gPT09IDIpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgImF1eGNsaWNrIjoKICAgICAgICAgICAgICBjYXNlICJkYmxjbGljayI6CiAgICAgICAgICAgICAgY2FzZSAibW91c2Vkb3duIjoKICAgICAgICAgICAgICBjYXNlICJtb3VzZW1vdmUiOgogICAgICAgICAgICAgIGNhc2UgIm1vdXNldXAiOgogICAgICAgICAgICAgIGNhc2UgIm1vdXNlb3V0IjoKICAgICAgICAgICAgICBjYXNlICJtb3VzZW92ZXIiOgogICAgICAgICAgICAgIGNhc2UgImNvbnRleHRtZW51IjoKICAgICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY01vdXNlRXZlbnQ7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJkcmFnIjoKICAgICAgICAgICAgICBjYXNlICJkcmFnZW5kIjoKICAgICAgICAgICAgICBjYXNlICJkcmFnZW50ZXIiOgogICAgICAgICAgICAgIGNhc2UgImRyYWdleGl0IjoKICAgICAgICAgICAgICBjYXNlICJkcmFnbGVhdmUiOgogICAgICAgICAgICAgIGNhc2UgImRyYWdvdmVyIjoKICAgICAgICAgICAgICBjYXNlICJkcmFnc3RhcnQiOgogICAgICAgICAgICAgIGNhc2UgImRyb3AiOgogICAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljRHJhZ0V2ZW50OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAidG91Y2hjYW5jZWwiOgogICAgICAgICAgICAgIGNhc2UgInRvdWNoZW5kIjoKICAgICAgICAgICAgICBjYXNlICJ0b3VjaG1vdmUiOgogICAgICAgICAgICAgIGNhc2UgInRvdWNoc3RhcnQiOgogICAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljVG91Y2hFdmVudDsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgQU5JTUFUSU9OX0VORDoKICAgICAgICAgICAgICBjYXNlIEFOSU1BVElPTl9JVEVSQVRJT046CiAgICAgICAgICAgICAgY2FzZSBBTklNQVRJT05fU1RBUlQ6CiAgICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNBbmltYXRpb25FdmVudDsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgVFJBTlNJVElPTl9FTkQ6CiAgICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNUcmFuc2l0aW9uRXZlbnQ7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJzY3JvbGwiOgogICAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljVUlFdmVudDsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgIndoZWVsIjoKICAgICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY1doZWVsRXZlbnQ7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJjb3B5IjoKICAgICAgICAgICAgICBjYXNlICJjdXQiOgogICAgICAgICAgICAgIGNhc2UgInBhc3RlIjoKICAgICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0NsaXBib2FyZEV2ZW50OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAiZ290cG9pbnRlcmNhcHR1cmUiOgogICAgICAgICAgICAgIGNhc2UgImxvc3Rwb2ludGVyY2FwdHVyZSI6CiAgICAgICAgICAgICAgY2FzZSAicG9pbnRlcmNhbmNlbCI6CiAgICAgICAgICAgICAgY2FzZSAicG9pbnRlcmRvd24iOgogICAgICAgICAgICAgIGNhc2UgInBvaW50ZXJtb3ZlIjoKICAgICAgICAgICAgICBjYXNlICJwb2ludGVyb3V0IjoKICAgICAgICAgICAgICBjYXNlICJwb2ludGVyb3ZlciI6CiAgICAgICAgICAgICAgY2FzZSAicG9pbnRlcnVwIjoKICAgICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY1BvaW50ZXJFdmVudDsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpbkNhcHR1cmVQaGFzZSA9IChldmVudFN5c3RlbUZsYWdzICYgSVNfQ0FQVFVSRV9QSEFTRSkgIT09IDA7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgYWNjdW11bGF0ZVRhcmdldE9ubHkgPSAhaW5DYXB0dXJlUGhhc2UgJiYgLy8gVE9ETzogaWRlYWxseSwgd2UnZCBldmVudHVhbGx5IGFkZCBhbGwgZXZlbnRzIGZyb20KICAgICAgICAgICAgICAvLyBub25EZWxlZ2F0ZWRFdmVudHMgbGlzdCBpbiBET01QbHVnaW5FdmVudFN5c3RlbS4KICAgICAgICAgICAgICAvLyBUaGVuIHdlIGNhbiByZW1vdmUgdGhpcyBzcGVjaWFsIGxpc3QuCiAgICAgICAgICAgICAgLy8gVGhpcyBpcyBhIGJyZWFraW5nIGNoYW5nZSB0aGF0IGNhbiB3YWl0IHVudGlsIFJlYWN0IDE4LgogICAgICAgICAgICAgIGRvbUV2ZW50TmFtZSA9PT0gInNjcm9sbCI7CiAgICAgICAgICAgICAgdmFyIF9saXN0ZW5lcnMgPSBhY2N1bXVsYXRlU2luZ2xlUGhhc2VMaXN0ZW5lcnModGFyZ2V0SW5zdCwgcmVhY3ROYW1lLCBuYXRpdmVFdmVudC50eXBlLCBpbkNhcHR1cmVQaGFzZSwgYWNjdW11bGF0ZVRhcmdldE9ubHkpOwogICAgICAgICAgICAgIGlmIChfbGlzdGVuZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIHZhciBfZXZlbnQgPSBuZXcgU3ludGhldGljRXZlbnRDdG9yKHJlYWN0TmFtZSwgcmVhY3RFdmVudFR5cGUsIG51bGwsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgICAgICBkaXNwYXRjaFF1ZXVlLnB1c2goewogICAgICAgICAgICAgICAgICBldmVudDogX2V2ZW50LAogICAgICAgICAgICAgICAgICBsaXN0ZW5lcnM6IF9saXN0ZW5lcnMKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudHMoKTsKICAgICAgICAgIHJlZ2lzdGVyRXZlbnRzJDIoKTsKICAgICAgICAgIHJlZ2lzdGVyRXZlbnRzJDEoKTsKICAgICAgICAgIHJlZ2lzdGVyRXZlbnRzJDMoKTsKICAgICAgICAgIHJlZ2lzdGVyRXZlbnRzKCk7CiAgICAgICAgICBmdW5jdGlvbiBleHRyYWN0RXZlbnRzJDUoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgICBleHRyYWN0RXZlbnRzJDQoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MpOwogICAgICAgICAgICB2YXIgc2hvdWxkUHJvY2Vzc1BvbHlmaWxsUGx1Z2lucyA9IChldmVudFN5c3RlbUZsYWdzICYgU0hPVUxEX05PVF9QUk9DRVNTX1BPTFlGSUxMX0VWRU5UX1BMVUdJTlMpID09PSAwOwogICAgICAgICAgICBpZiAoc2hvdWxkUHJvY2Vzc1BvbHlmaWxsUGx1Z2lucykgewogICAgICAgICAgICAgIGV4dHJhY3RFdmVudHMkMihkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgICAgZXh0cmFjdEV2ZW50cyQxKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgICBleHRyYWN0RXZlbnRzJDMoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICAgIGV4dHJhY3RFdmVudHMoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWVkaWFFdmVudFR5cGVzID0gWyJhYm9ydCIsICJjYW5wbGF5IiwgImNhbnBsYXl0aHJvdWdoIiwgImR1cmF0aW9uY2hhbmdlIiwgImVtcHRpZWQiLCAiZW5jcnlwdGVkIiwgImVuZGVkIiwgImVycm9yIiwgImxvYWRlZGRhdGEiLCAibG9hZGVkbWV0YWRhdGEiLCAibG9hZHN0YXJ0IiwgInBhdXNlIiwgInBsYXkiLCAicGxheWluZyIsICJwcm9ncmVzcyIsICJyYXRlY2hhbmdlIiwgInJlc2l6ZSIsICJzZWVrZWQiLCAic2Vla2luZyIsICJzdGFsbGVkIiwgInN1c3BlbmQiLCAidGltZXVwZGF0ZSIsICJ2b2x1bWVjaGFuZ2UiLCAid2FpdGluZyJdOwogICAgICAgICAgdmFyIG5vbkRlbGVnYXRlZEV2ZW50cyA9IG5ldyBTZXQoWyJjYW5jZWwiLCAiY2xvc2UiLCAiaW52YWxpZCIsICJsb2FkIiwgInNjcm9sbCIsICJ0b2dnbGUiXS5jb25jYXQobWVkaWFFdmVudFR5cGVzKSk7CiAgICAgICAgICBmdW5jdGlvbiBleGVjdXRlRGlzcGF0Y2goZXZlbnQsIGxpc3RlbmVyLCBjdXJyZW50VGFyZ2V0KSB7CiAgICAgICAgICAgIHZhciB0eXBlMiA9IGV2ZW50LnR5cGUgfHwgInVua25vd24tZXZlbnQiOwogICAgICAgICAgICBldmVudC5jdXJyZW50VGFyZ2V0ID0gY3VycmVudFRhcmdldDsKICAgICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrQW5kQ2F0Y2hGaXJzdEVycm9yKHR5cGUyLCBsaXN0ZW5lciwgdm9pZCAwLCBldmVudCk7CiAgICAgICAgICAgIGV2ZW50LmN1cnJlbnRUYXJnZXQgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcHJvY2Vzc0Rpc3BhdGNoUXVldWVJdGVtc0luT3JkZXIoZXZlbnQsIGRpc3BhdGNoTGlzdGVuZXJzLCBpbkNhcHR1cmVQaGFzZSkgewogICAgICAgICAgICB2YXIgcHJldmlvdXNJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKGluQ2FwdHVyZVBoYXNlKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IGRpc3BhdGNoTGlzdGVuZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICB2YXIgX2Rpc3BhdGNoTGlzdGVuZXJzJGkgPSBkaXNwYXRjaExpc3RlbmVyc1tpXSwgaW5zdGFuY2UgPSBfZGlzcGF0Y2hMaXN0ZW5lcnMkaS5pbnN0YW5jZSwgY3VycmVudFRhcmdldCA9IF9kaXNwYXRjaExpc3RlbmVycyRpLmN1cnJlbnRUYXJnZXQsIGxpc3RlbmVyID0gX2Rpc3BhdGNoTGlzdGVuZXJzJGkubGlzdGVuZXI7CiAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UgIT09IHByZXZpb3VzSW5zdGFuY2UgJiYgZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSkgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBleGVjdXRlRGlzcGF0Y2goZXZlbnQsIGxpc3RlbmVyLCBjdXJyZW50VGFyZ2V0KTsKICAgICAgICAgICAgICAgIHByZXZpb3VzSW5zdGFuY2UgPSBpbnN0YW5jZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IGRpc3BhdGNoTGlzdGVuZXJzLmxlbmd0aDsgX2krKykgewogICAgICAgICAgICAgICAgdmFyIF9kaXNwYXRjaExpc3RlbmVycyRfaSA9IGRpc3BhdGNoTGlzdGVuZXJzW19pXSwgX2luc3RhbmNlID0gX2Rpc3BhdGNoTGlzdGVuZXJzJF9pLmluc3RhbmNlLCBfY3VycmVudFRhcmdldCA9IF9kaXNwYXRjaExpc3RlbmVycyRfaS5jdXJyZW50VGFyZ2V0LCBfbGlzdGVuZXIgPSBfZGlzcGF0Y2hMaXN0ZW5lcnMkX2kubGlzdGVuZXI7CiAgICAgICAgICAgICAgICBpZiAoX2luc3RhbmNlICE9PSBwcmV2aW91c0luc3RhbmNlICYmIGV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZXhlY3V0ZURpc3BhdGNoKGV2ZW50LCBfbGlzdGVuZXIsIF9jdXJyZW50VGFyZ2V0KTsKICAgICAgICAgICAgICAgIHByZXZpb3VzSW5zdGFuY2UgPSBfaW5zdGFuY2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwcm9jZXNzRGlzcGF0Y2hRdWV1ZShkaXNwYXRjaFF1ZXVlLCBldmVudFN5c3RlbUZsYWdzKSB7CiAgICAgICAgICAgIHZhciBpbkNhcHR1cmVQaGFzZSA9IChldmVudFN5c3RlbUZsYWdzICYgSVNfQ0FQVFVSRV9QSEFTRSkgIT09IDA7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGlzcGF0Y2hRdWV1ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBfZGlzcGF0Y2hRdWV1ZSRpID0gZGlzcGF0Y2hRdWV1ZVtpXSwgZXZlbnQgPSBfZGlzcGF0Y2hRdWV1ZSRpLmV2ZW50LCBsaXN0ZW5lcnMgPSBfZGlzcGF0Y2hRdWV1ZSRpLmxpc3RlbmVyczsKICAgICAgICAgICAgICBwcm9jZXNzRGlzcGF0Y2hRdWV1ZUl0ZW1zSW5PcmRlcihldmVudCwgbGlzdGVuZXJzLCBpbkNhcHR1cmVQaGFzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0aHJvd0NhdWdodEVycm9yKCk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaEV2ZW50c0ZvclBsdWdpbnMoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBuYXRpdmVFdmVudCwgdGFyZ2V0SW5zdCwgdGFyZ2V0Q29udGFpbmVyKSB7CiAgICAgICAgICAgIHZhciBuYXRpdmVFdmVudFRhcmdldCA9IGdldEV2ZW50VGFyZ2V0KG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgdmFyIGRpc3BhdGNoUXVldWUgPSBbXTsKICAgICAgICAgICAgZXh0cmFjdEV2ZW50cyQ1KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzKTsKICAgICAgICAgICAgcHJvY2Vzc0Rpc3BhdGNoUXVldWUoZGlzcGF0Y2hRdWV1ZSwgZXZlbnRTeXN0ZW1GbGFncyk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KGRvbUV2ZW50TmFtZSwgdGFyZ2V0RWxlbWVudCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCFub25EZWxlZ2F0ZWRFdmVudHMuaGFzKGRvbUV2ZW50TmFtZSkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCdEaWQgbm90IGV4cGVjdCBhIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoKSBjYWxsIGZvciAiJXMiLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4nLCBkb21FdmVudE5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaXNDYXB0dXJlUGhhc2VMaXN0ZW5lciA9IGZhbHNlOwogICAgICAgICAgICB2YXIgbGlzdGVuZXJTZXQgPSBnZXRFdmVudExpc3RlbmVyU2V0KHRhcmdldEVsZW1lbnQpOwogICAgICAgICAgICB2YXIgbGlzdGVuZXJTZXRLZXkgPSBnZXRMaXN0ZW5lclNldEtleShkb21FdmVudE5hbWUsIGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpOwogICAgICAgICAgICBpZiAoIWxpc3RlbmVyU2V0LmhhcyhsaXN0ZW5lclNldEtleSkpIHsKICAgICAgICAgICAgICBhZGRUcmFwcGVkRXZlbnRMaXN0ZW5lcih0YXJnZXRFbGVtZW50LCBkb21FdmVudE5hbWUsIElTX05PTl9ERUxFR0FURUQsIGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpOwogICAgICAgICAgICAgIGxpc3RlbmVyU2V0LmFkZChsaXN0ZW5lclNldEtleSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGxpc3RlblRvTmF0aXZlRXZlbnQoZG9tRXZlbnROYW1lLCBpc0NhcHR1cmVQaGFzZUxpc3RlbmVyLCB0YXJnZXQpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChub25EZWxlZ2F0ZWRFdmVudHMuaGFzKGRvbUV2ZW50TmFtZSkgJiYgIWlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCdEaWQgbm90IGV4cGVjdCBhIGxpc3RlblRvTmF0aXZlRXZlbnQoKSBjYWxsIGZvciAiJXMiIGluIHRoZSBidWJibGUgcGhhc2UuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLicsIGRvbUV2ZW50TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBldmVudFN5c3RlbUZsYWdzID0gMDsKICAgICAgICAgICAgaWYgKGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpIHsKICAgICAgICAgICAgICBldmVudFN5c3RlbUZsYWdzIHw9IElTX0NBUFRVUkVfUEhBU0U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYWRkVHJhcHBlZEV2ZW50TGlzdGVuZXIodGFyZ2V0LCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGxpc3RlbmluZ01hcmtlciA9ICJfcmVhY3RMaXN0ZW5pbmciICsgTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc2xpY2UoMik7CiAgICAgICAgICBmdW5jdGlvbiBsaXN0ZW5Ub0FsbFN1cHBvcnRlZEV2ZW50cyhyb290Q29udGFpbmVyRWxlbWVudCkgewogICAgICAgICAgICBpZiAoIXJvb3RDb250YWluZXJFbGVtZW50W2xpc3RlbmluZ01hcmtlcl0pIHsKICAgICAgICAgICAgICByb290Q29udGFpbmVyRWxlbWVudFtsaXN0ZW5pbmdNYXJrZXJdID0gdHJ1ZTsKICAgICAgICAgICAgICBhbGxOYXRpdmVFdmVudHMuZm9yRWFjaChmdW5jdGlvbihkb21FdmVudE5hbWUpIHsKICAgICAgICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgIT09ICJzZWxlY3Rpb25jaGFuZ2UiKSB7CiAgICAgICAgICAgICAgICAgIGlmICghbm9uRGVsZWdhdGVkRXZlbnRzLmhhcyhkb21FdmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgbGlzdGVuVG9OYXRpdmVFdmVudChkb21FdmVudE5hbWUsIGZhbHNlLCByb290Q29udGFpbmVyRWxlbWVudCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgbGlzdGVuVG9OYXRpdmVFdmVudChkb21FdmVudE5hbWUsIHRydWUsIHJvb3RDb250YWluZXJFbGVtZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB2YXIgb3duZXJEb2N1bWVudCA9IHJvb3RDb250YWluZXJFbGVtZW50Lm5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFID8gcm9vdENvbnRhaW5lckVsZW1lbnQgOiByb290Q29udGFpbmVyRWxlbWVudC5vd25lckRvY3VtZW50OwogICAgICAgICAgICAgIGlmIChvd25lckRvY3VtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoIW93bmVyRG9jdW1lbnRbbGlzdGVuaW5nTWFya2VyXSkgewogICAgICAgICAgICAgICAgICBvd25lckRvY3VtZW50W2xpc3RlbmluZ01hcmtlcl0gPSB0cnVlOwogICAgICAgICAgICAgICAgICBsaXN0ZW5Ub05hdGl2ZUV2ZW50KCJzZWxlY3Rpb25jaGFuZ2UiLCBmYWxzZSwgb3duZXJEb2N1bWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBhZGRUcmFwcGVkRXZlbnRMaXN0ZW5lcih0YXJnZXRDb250YWluZXIsIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgaXNDYXB0dXJlUGhhc2VMaXN0ZW5lciwgaXNEZWZlcnJlZExpc3RlbmVyRm9yTGVnYWN5RkJTdXBwb3J0KSB7CiAgICAgICAgICAgIHZhciBsaXN0ZW5lciA9IGNyZWF0ZUV2ZW50TGlzdGVuZXJXcmFwcGVyV2l0aFByaW9yaXR5KHRhcmdldENvbnRhaW5lciwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzKTsKICAgICAgICAgICAgdmFyIGlzUGFzc2l2ZUxpc3RlbmVyID0gdm9pZCAwOwogICAgICAgICAgICBpZiAocGFzc2l2ZUJyb3dzZXJFdmVudHNTdXBwb3J0ZWQpIHsKICAgICAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAidG91Y2hzdGFydCIgfHwgZG9tRXZlbnROYW1lID09PSAidG91Y2htb3ZlIiB8fCBkb21FdmVudE5hbWUgPT09ICJ3aGVlbCIpIHsKICAgICAgICAgICAgICAgIGlzUGFzc2l2ZUxpc3RlbmVyID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGFyZ2V0Q29udGFpbmVyID0gdGFyZ2V0Q29udGFpbmVyOwogICAgICAgICAgICB2YXIgdW5zdWJzY3JpYmVMaXN0ZW5lcjsKICAgICAgICAgICAgaWYgKGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpIHsKICAgICAgICAgICAgICBpZiAoaXNQYXNzaXZlTGlzdGVuZXIgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgdW5zdWJzY3JpYmVMaXN0ZW5lciA9IGFkZEV2ZW50Q2FwdHVyZUxpc3RlbmVyV2l0aFBhc3NpdmVGbGFnKHRhcmdldENvbnRhaW5lciwgZG9tRXZlbnROYW1lLCBsaXN0ZW5lciwgaXNQYXNzaXZlTGlzdGVuZXIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB1bnN1YnNjcmliZUxpc3RlbmVyID0gYWRkRXZlbnRDYXB0dXJlTGlzdGVuZXIodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGxpc3RlbmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKGlzUGFzc2l2ZUxpc3RlbmVyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHVuc3Vic2NyaWJlTGlzdGVuZXIgPSBhZGRFdmVudEJ1YmJsZUxpc3RlbmVyV2l0aFBhc3NpdmVGbGFnKHRhcmdldENvbnRhaW5lciwgZG9tRXZlbnROYW1lLCBsaXN0ZW5lciwgaXNQYXNzaXZlTGlzdGVuZXIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB1bnN1YnNjcmliZUxpc3RlbmVyID0gYWRkRXZlbnRCdWJibGVMaXN0ZW5lcih0YXJnZXRDb250YWluZXIsIGRvbUV2ZW50TmFtZSwgbGlzdGVuZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaXNNYXRjaGluZ1Jvb3RDb250YWluZXIoZ3JhbmRDb250YWluZXIsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgICByZXR1cm4gZ3JhbmRDb250YWluZXIgPT09IHRhcmdldENvbnRhaW5lciB8fCBncmFuZENvbnRhaW5lci5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFICYmIGdyYW5kQ29udGFpbmVyLnBhcmVudE5vZGUgPT09IHRhcmdldENvbnRhaW5lcjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoRXZlbnRGb3JQbHVnaW5FdmVudFN5c3RlbShkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIG5hdGl2ZUV2ZW50LCB0YXJnZXRJbnN0LCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgICAgdmFyIGFuY2VzdG9ySW5zdCA9IHRhcmdldEluc3Q7CiAgICAgICAgICAgIGlmICgoZXZlbnRTeXN0ZW1GbGFncyAmIElTX0VWRU5UX0hBTkRMRV9OT05fTUFOQUdFRF9OT0RFKSA9PT0gMCAmJiAoZXZlbnRTeXN0ZW1GbGFncyAmIElTX05PTl9ERUxFR0FURUQpID09PSAwKSB7CiAgICAgICAgICAgICAgdmFyIHRhcmdldENvbnRhaW5lck5vZGUgPSB0YXJnZXRDb250YWluZXI7CiAgICAgICAgICAgICAgaWYgKHRhcmdldEluc3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBub2RlID0gdGFyZ2V0SW5zdDsKICAgICAgICAgICAgICAgIG1haW5Mb29wOgogICAgICAgICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChub2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHZhciBub2RlVGFnID0gbm9kZS50YWc7CiAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGVUYWcgPT09IEhvc3RSb290IHx8IG5vZGVUYWcgPT09IEhvc3RQb3J0YWwpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBjb250YWluZXIgPSBub2RlLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGlzTWF0Y2hpbmdSb290Q29udGFpbmVyKGNvbnRhaW5lciwgdGFyZ2V0Q29udGFpbmVyTm9kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZVRhZyA9PT0gSG9zdFBvcnRhbCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZ3JhbmROb2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChncmFuZE5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZ3JhbmRUYWcgPSBncmFuZE5vZGUudGFnOwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChncmFuZFRhZyA9PT0gSG9zdFJvb3QgfHwgZ3JhbmRUYWcgPT09IEhvc3RQb3J0YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBncmFuZENvbnRhaW5lciA9IGdyYW5kTm9kZS5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc01hdGNoaW5nUm9vdENvbnRhaW5lcihncmFuZENvbnRhaW5lciwgdGFyZ2V0Q29udGFpbmVyTm9kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBncmFuZE5vZGUgPSBncmFuZE5vZGUucmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoY29udGFpbmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnROb2RlID0gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUoY29udGFpbmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudE5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFRhZyA9IHBhcmVudE5vZGUudGFnOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50VGFnID09PSBIb3N0Q29tcG9uZW50IHx8IHBhcmVudFRhZyA9PT0gSG9zdFRleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gYW5jZXN0b3JJbnN0ID0gcGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZSBtYWluTG9vcDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXIgPSBjb250YWluZXIucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGJhdGNoZWRVcGRhdGVzKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBkaXNwYXRjaEV2ZW50c0ZvclBsdWdpbnMoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBuYXRpdmVFdmVudCwgYW5jZXN0b3JJbnN0KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVEaXNwYXRjaExpc3RlbmVyKGluc3RhbmNlLCBsaXN0ZW5lciwgY3VycmVudFRhcmdldCkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIGluc3RhbmNlLAogICAgICAgICAgICAgIGxpc3RlbmVyLAogICAgICAgICAgICAgIGN1cnJlbnRUYXJnZXQKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGFjY3VtdWxhdGVTaW5nbGVQaGFzZUxpc3RlbmVycyh0YXJnZXRGaWJlciwgcmVhY3ROYW1lLCBuYXRpdmVFdmVudFR5cGUsIGluQ2FwdHVyZVBoYXNlLCBhY2N1bXVsYXRlVGFyZ2V0T25seSwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgICAgdmFyIGNhcHR1cmVOYW1lID0gcmVhY3ROYW1lICE9PSBudWxsID8gcmVhY3ROYW1lICsgIkNhcHR1cmUiIDogbnVsbDsKICAgICAgICAgICAgdmFyIHJlYWN0RXZlbnROYW1lID0gaW5DYXB0dXJlUGhhc2UgPyBjYXB0dXJlTmFtZSA6IHJlYWN0TmFtZTsKICAgICAgICAgICAgdmFyIGxpc3RlbmVycyA9IFtdOwogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB0YXJnZXRGaWJlcjsKICAgICAgICAgICAgdmFyIGxhc3RIb3N0Q29tcG9uZW50ID0gbnVsbDsKICAgICAgICAgICAgd2hpbGUgKGluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIF9pbnN0YW5jZTIgPSBpbnN0YW5jZSwgc3RhdGVOb2RlID0gX2luc3RhbmNlMi5zdGF0ZU5vZGUsIHRhZyA9IF9pbnN0YW5jZTIudGFnOwogICAgICAgICAgICAgIGlmICh0YWcgPT09IEhvc3RDb21wb25lbnQgJiYgc3RhdGVOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBsYXN0SG9zdENvbXBvbmVudCA9IHN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmIChyZWFjdEV2ZW50TmFtZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgbGlzdGVuZXIgPSBnZXRMaXN0ZW5lcihpbnN0YW5jZSwgcmVhY3RFdmVudE5hbWUpOwogICAgICAgICAgICAgICAgICBpZiAobGlzdGVuZXIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGxpc3RlbmVycy5wdXNoKGNyZWF0ZURpc3BhdGNoTGlzdGVuZXIoaW5zdGFuY2UsIGxpc3RlbmVyLCBsYXN0SG9zdENvbXBvbmVudCkpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChhY2N1bXVsYXRlVGFyZ2V0T25seSkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGluc3RhbmNlID0gaW5zdGFuY2UucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBsaXN0ZW5lcnM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBhY2N1bXVsYXRlVHdvUGhhc2VMaXN0ZW5lcnModGFyZ2V0RmliZXIsIHJlYWN0TmFtZSkgewogICAgICAgICAgICB2YXIgY2FwdHVyZU5hbWUgPSByZWFjdE5hbWUgKyAiQ2FwdHVyZSI7CiAgICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBbXTsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gdGFyZ2V0RmliZXI7CiAgICAgICAgICAgIHdoaWxlIChpbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBfaW5zdGFuY2UzID0gaW5zdGFuY2UsIHN0YXRlTm9kZSA9IF9pbnN0YW5jZTMuc3RhdGVOb2RlLCB0YWcgPSBfaW5zdGFuY2UzLnRhZzsKICAgICAgICAgICAgICBpZiAodGFnID09PSBIb3N0Q29tcG9uZW50ICYmIHN0YXRlTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRUYXJnZXQgPSBzdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICB2YXIgY2FwdHVyZUxpc3RlbmVyID0gZ2V0TGlzdGVuZXIoaW5zdGFuY2UsIGNhcHR1cmVOYW1lKTsKICAgICAgICAgICAgICAgIGlmIChjYXB0dXJlTGlzdGVuZXIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMudW5zaGlmdChjcmVhdGVEaXNwYXRjaExpc3RlbmVyKGluc3RhbmNlLCBjYXB0dXJlTGlzdGVuZXIsIGN1cnJlbnRUYXJnZXQpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBidWJibGVMaXN0ZW5lciA9IGdldExpc3RlbmVyKGluc3RhbmNlLCByZWFjdE5hbWUpOwogICAgICAgICAgICAgICAgaWYgKGJ1YmJsZUxpc3RlbmVyICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzLnB1c2goY3JlYXRlRGlzcGF0Y2hMaXN0ZW5lcihpbnN0YW5jZSwgYnViYmxlTGlzdGVuZXIsIGN1cnJlbnRUYXJnZXQpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaW5zdGFuY2UgPSBpbnN0YW5jZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxpc3RlbmVyczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldFBhcmVudChpbnN0KSB7CiAgICAgICAgICAgIGlmIChpbnN0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIGluc3QgPSBpbnN0LnJldHVybjsKICAgICAgICAgICAgfSB3aGlsZSAoaW5zdCAmJiBpbnN0LnRhZyAhPT0gSG9zdENvbXBvbmVudCk7CiAgICAgICAgICAgIGlmIChpbnN0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGluc3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRMb3dlc3RDb21tb25BbmNlc3RvcihpbnN0QSwgaW5zdEIpIHsKICAgICAgICAgICAgdmFyIG5vZGVBID0gaW5zdEE7CiAgICAgICAgICAgIHZhciBub2RlQiA9IGluc3RCOwogICAgICAgICAgICB2YXIgZGVwdGhBID0gMDsKICAgICAgICAgICAgZm9yICh2YXIgdGVtcEEgPSBub2RlQTsgdGVtcEE7IHRlbXBBID0gZ2V0UGFyZW50KHRlbXBBKSkgewogICAgICAgICAgICAgIGRlcHRoQSsrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkZXB0aEIgPSAwOwogICAgICAgICAgICBmb3IgKHZhciB0ZW1wQiA9IG5vZGVCOyB0ZW1wQjsgdGVtcEIgPSBnZXRQYXJlbnQodGVtcEIpKSB7CiAgICAgICAgICAgICAgZGVwdGhCKys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKGRlcHRoQSAtIGRlcHRoQiA+IDApIHsKICAgICAgICAgICAgICBub2RlQSA9IGdldFBhcmVudChub2RlQSk7CiAgICAgICAgICAgICAgZGVwdGhBLS07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKGRlcHRoQiAtIGRlcHRoQSA+IDApIHsKICAgICAgICAgICAgICBub2RlQiA9IGdldFBhcmVudChub2RlQik7CiAgICAgICAgICAgICAgZGVwdGhCLS07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGRlcHRoID0gZGVwdGhBOwogICAgICAgICAgICB3aGlsZSAoZGVwdGgtLSkgewogICAgICAgICAgICAgIGlmIChub2RlQSA9PT0gbm9kZUIgfHwgbm9kZUIgIT09IG51bGwgJiYgbm9kZUEgPT09IG5vZGVCLmFsdGVybmF0ZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG5vZGVBOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlQSA9IGdldFBhcmVudChub2RlQSk7CiAgICAgICAgICAgICAgbm9kZUIgPSBnZXRQYXJlbnQobm9kZUIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gYWNjdW11bGF0ZUVudGVyTGVhdmVMaXN0ZW5lcnNGb3JFdmVudChkaXNwYXRjaFF1ZXVlLCBldmVudCwgdGFyZ2V0LCBjb21tb24sIGluQ2FwdHVyZVBoYXNlKSB7CiAgICAgICAgICAgIHZhciByZWdpc3RyYXRpb25OYW1lID0gZXZlbnQuX3JlYWN0TmFtZTsKICAgICAgICAgICAgdmFyIGxpc3RlbmVycyA9IFtdOwogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB0YXJnZXQ7CiAgICAgICAgICAgIHdoaWxlIChpbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChpbnN0YW5jZSA9PT0gY29tbW9uKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIF9pbnN0YW5jZTQgPSBpbnN0YW5jZSwgYWx0ZXJuYXRlID0gX2luc3RhbmNlNC5hbHRlcm5hdGUsIHN0YXRlTm9kZSA9IF9pbnN0YW5jZTQuc3RhdGVOb2RlLCB0YWcgPSBfaW5zdGFuY2U0LnRhZzsKICAgICAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsICYmIGFsdGVybmF0ZSA9PT0gY29tbW9uKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHRhZyA9PT0gSG9zdENvbXBvbmVudCAmJiBzdGF0ZU5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBjdXJyZW50VGFyZ2V0ID0gc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgaWYgKGluQ2FwdHVyZVBoYXNlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjYXB0dXJlTGlzdGVuZXIgPSBnZXRMaXN0ZW5lcihpbnN0YW5jZSwgcmVnaXN0cmF0aW9uTmFtZSk7CiAgICAgICAgICAgICAgICAgIGlmIChjYXB0dXJlTGlzdGVuZXIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGxpc3RlbmVycy51bnNoaWZ0KGNyZWF0ZURpc3BhdGNoTGlzdGVuZXIoaW5zdGFuY2UsIGNhcHR1cmVMaXN0ZW5lciwgY3VycmVudFRhcmdldCkpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFpbkNhcHR1cmVQaGFzZSkgewogICAgICAgICAgICAgICAgICB2YXIgYnViYmxlTGlzdGVuZXIgPSBnZXRMaXN0ZW5lcihpbnN0YW5jZSwgcmVnaXN0cmF0aW9uTmFtZSk7CiAgICAgICAgICAgICAgICAgIGlmIChidWJibGVMaXN0ZW5lciAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzLnB1c2goY3JlYXRlRGlzcGF0Y2hMaXN0ZW5lcihpbnN0YW5jZSwgYnViYmxlTGlzdGVuZXIsIGN1cnJlbnRUYXJnZXQpKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpbnN0YW5jZSA9IGluc3RhbmNlLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGlzdGVuZXJzLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICAgIGRpc3BhdGNoUXVldWUucHVzaCh7CiAgICAgICAgICAgICAgICBldmVudCwKICAgICAgICAgICAgICAgIGxpc3RlbmVycwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBhY2N1bXVsYXRlRW50ZXJMZWF2ZVR3b1BoYXNlTGlzdGVuZXJzKGRpc3BhdGNoUXVldWUsIGxlYXZlRXZlbnQsIGVudGVyRXZlbnQsIGZyb20sIHRvKSB7CiAgICAgICAgICAgIHZhciBjb21tb24gPSBmcm9tICYmIHRvID8gZ2V0TG93ZXN0Q29tbW9uQW5jZXN0b3IoZnJvbSwgdG8pIDogbnVsbDsKICAgICAgICAgICAgaWYgKGZyb20gIT09IG51bGwpIHsKICAgICAgICAgICAgICBhY2N1bXVsYXRlRW50ZXJMZWF2ZUxpc3RlbmVyc0ZvckV2ZW50KGRpc3BhdGNoUXVldWUsIGxlYXZlRXZlbnQsIGZyb20sIGNvbW1vbiwgZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0byAhPT0gbnVsbCAmJiBlbnRlckV2ZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgYWNjdW11bGF0ZUVudGVyTGVhdmVMaXN0ZW5lcnNGb3JFdmVudChkaXNwYXRjaFF1ZXVlLCBlbnRlckV2ZW50LCB0bywgY29tbW9uLCB0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0TGlzdGVuZXJTZXRLZXkoZG9tRXZlbnROYW1lLCBjYXB0dXJlKSB7CiAgICAgICAgICAgIHJldHVybiBkb21FdmVudE5hbWUgKyAiX18iICsgKGNhcHR1cmUgPyAiY2FwdHVyZSIgOiAiYnViYmxlIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSBmYWxzZTsKICAgICAgICAgIHZhciBEQU5HRVJPVVNMWV9TRVRfSU5ORVJfSFRNTCA9ICJkYW5nZXJvdXNseVNldElubmVySFRNTCI7CiAgICAgICAgICB2YXIgU1VQUFJFU1NfQ09OVEVOVF9FRElUQUJMRV9XQVJOSU5HID0gInN1cHByZXNzQ29udGVudEVkaXRhYmxlV2FybmluZyI7CiAgICAgICAgICB2YXIgU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkcgPSAic3VwcHJlc3NIeWRyYXRpb25XYXJuaW5nIjsKICAgICAgICAgIHZhciBBVVRPRk9DVVMgPSAiYXV0b0ZvY3VzIjsKICAgICAgICAgIHZhciBDSElMRFJFTiA9ICJjaGlsZHJlbiI7CiAgICAgICAgICB2YXIgU1RZTEUgPSAic3R5bGUiOwogICAgICAgICAgdmFyIEhUTUwkMSA9ICJfX2h0bWwiOwogICAgICAgICAgdmFyIHdhcm5lZFVua25vd25UYWdzOwogICAgICAgICAgdmFyIHZhbGlkYXRlUHJvcGVydGllc0luRGV2ZWxvcG1lbnQ7CiAgICAgICAgICB2YXIgd2FybkZvclByb3BEaWZmZXJlbmNlOwogICAgICAgICAgdmFyIHdhcm5Gb3JFeHRyYUF0dHJpYnV0ZXM7CiAgICAgICAgICB2YXIgd2FybkZvckludmFsaWRFdmVudExpc3RlbmVyOwogICAgICAgICAgdmFyIGNhbkRpZmZTdHlsZUZvckh5ZHJhdGlvbldhcm5pbmc7CiAgICAgICAgICB2YXIgbm9ybWFsaXplSFRNTDsKICAgICAgICAgIHsKICAgICAgICAgICAgd2FybmVkVW5rbm93blRhZ3MgPSB7CiAgICAgICAgICAgICAgLy8gVGhlcmUgYXJlIHdvcmtpbmcgcG9seWZpbGxzIGZvciA8ZGlhbG9nPi4gTGV0IHBlb3BsZSB1c2UgaXQuCiAgICAgICAgICAgICAgZGlhbG9nOiB0cnVlLAogICAgICAgICAgICAgIC8vIEVsZWN0cm9uIHNoaXBzIGEgY3VzdG9tIDx3ZWJ2aWV3PiB0YWcgdG8gZGlzcGxheSBleHRlcm5hbCB3ZWIgY29udGVudCBpbgogICAgICAgICAgICAgIC8vIGFuIGlzb2xhdGVkIGZyYW1lIGFuZCBwcm9jZXNzLgogICAgICAgICAgICAgIC8vIFRoaXMgdGFnIGlzIG5vdCBwcmVzZW50IGluIG5vbiBFbGVjdHJvbiBlbnZpcm9ubWVudHMgc3VjaCBhcyBKU0RvbSB3aGljaAogICAgICAgICAgICAgIC8vIGlzIG9mdGVuIHVzZWQgZm9yIHRlc3RpbmcgcHVycG9zZXMuCiAgICAgICAgICAgICAgLy8gQHNlZSBodHRwczovL2VsZWN0cm9uanMub3JnL2RvY3MvYXBpL3dlYnZpZXctdGFnCiAgICAgICAgICAgICAgd2VidmlldzogdHJ1ZQogICAgICAgICAgICB9OwogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXNJbkRldmVsb3BtZW50ID0gZnVuY3Rpb24odHlwZTIsIHByb3BzKSB7CiAgICAgICAgICAgICAgdmFsaWRhdGVQcm9wZXJ0aWVzKHR5cGUyLCBwcm9wcyk7CiAgICAgICAgICAgICAgdmFsaWRhdGVQcm9wZXJ0aWVzJDEodHlwZTIsIHByb3BzKTsKICAgICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXMkMih0eXBlMiwgcHJvcHMsIHsKICAgICAgICAgICAgICAgIHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMsCiAgICAgICAgICAgICAgICBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGNhbkRpZmZTdHlsZUZvckh5ZHJhdGlvbldhcm5pbmcgPSBjYW5Vc2VET00gJiYgIWRvY3VtZW50LmRvY3VtZW50TW9kZTsKICAgICAgICAgICAgd2FybkZvclByb3BEaWZmZXJlbmNlID0gZnVuY3Rpb24ocHJvcE5hbWUsIHNlcnZlclZhbHVlLCBjbGllbnRWYWx1ZSkgewogICAgICAgICAgICAgIGlmIChkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbikgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgbm9ybWFsaXplZENsaWVudFZhbHVlID0gbm9ybWFsaXplTWFya3VwRm9yVGV4dE9yQXR0cmlidXRlKGNsaWVudFZhbHVlKTsKICAgICAgICAgICAgICB2YXIgbm9ybWFsaXplZFNlcnZlclZhbHVlID0gbm9ybWFsaXplTWFya3VwRm9yVGV4dE9yQXR0cmlidXRlKHNlcnZlclZhbHVlKTsKICAgICAgICAgICAgICBpZiAobm9ybWFsaXplZFNlcnZlclZhbHVlID09PSBub3JtYWxpemVkQ2xpZW50VmFsdWUpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSB0cnVlOwogICAgICAgICAgICAgIGVycm9yKCJQcm9wIGAlc2AgZGlkIG5vdCBtYXRjaC4gU2VydmVyOiAlcyBDbGllbnQ6ICVzIiwgcHJvcE5hbWUsIEpTT04uc3RyaW5naWZ5KG5vcm1hbGl6ZWRTZXJ2ZXJWYWx1ZSksIEpTT04uc3RyaW5naWZ5KG5vcm1hbGl6ZWRDbGllbnRWYWx1ZSkpOwogICAgICAgICAgICB9OwogICAgICAgICAgICB3YXJuRm9yRXh0cmFBdHRyaWJ1dGVzID0gZnVuY3Rpb24oYXR0cmlidXRlTmFtZXMpIHsKICAgICAgICAgICAgICBpZiAoZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSB0cnVlOwogICAgICAgICAgICAgIHZhciBuYW1lcyA9IFtdOwogICAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWVzLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICAgICAgbmFtZXMucHVzaChuYW1lKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBlcnJvcigiRXh0cmEgYXR0cmlidXRlcyBmcm9tIHRoZSBzZXJ2ZXI6ICVzIiwgbmFtZXMpOwogICAgICAgICAgICB9OwogICAgICAgICAgICB3YXJuRm9ySW52YWxpZEV2ZW50TGlzdGVuZXIgPSBmdW5jdGlvbihyZWdpc3RyYXRpb25OYW1lLCBsaXN0ZW5lcikgewogICAgICAgICAgICAgIGlmIChsaXN0ZW5lciA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCBgJXNgIGxpc3RlbmVyIHRvIGJlIGEgZnVuY3Rpb24sIGluc3RlYWQgZ290IGBmYWxzZWAuXG5cbklmIHlvdSB1c2VkIHRvIGNvbmRpdGlvbmFsbHkgb21pdCBpdCB3aXRoICVzPXtjb25kaXRpb24gJiYgdmFsdWV9LCBwYXNzICVzPXtjb25kaXRpb24gPyB2YWx1ZSA6IHVuZGVmaW5lZH0gaW5zdGVhZC4iLCByZWdpc3RyYXRpb25OYW1lLCByZWdpc3RyYXRpb25OYW1lLCByZWdpc3RyYXRpb25OYW1lKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIGAlc2AgbGlzdGVuZXIgdG8gYmUgYSBmdW5jdGlvbiwgaW5zdGVhZCBnb3QgYSB2YWx1ZSBvZiBgJXNgIHR5cGUuIiwgcmVnaXN0cmF0aW9uTmFtZSwgdHlwZW9mIGxpc3RlbmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIG5vcm1hbGl6ZUhUTUwgPSBmdW5jdGlvbihwYXJlbnQsIGh0bWwpIHsKICAgICAgICAgICAgICB2YXIgdGVzdEVsZW1lbnQgPSBwYXJlbnQubmFtZXNwYWNlVVJJID09PSBIVE1MX05BTUVTUEFDRSA/IHBhcmVudC5vd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQocGFyZW50LnRhZ05hbWUpIDogcGFyZW50Lm93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKHBhcmVudC5uYW1lc3BhY2VVUkksIHBhcmVudC50YWdOYW1lKTsKICAgICAgICAgICAgICB0ZXN0RWxlbWVudC5pbm5lckhUTUwgPSBodG1sOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0RWxlbWVudC5pbm5lckhUTUw7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgTk9STUFMSVpFX05FV0xJTkVTX1JFR0VYID0gL1xyXG4/L2c7CiAgICAgICAgICB2YXIgTk9STUFMSVpFX05VTExfQU5EX1JFUExBQ0VNRU5UX1JFR0VYID0gL1x1MDAwMHxcdUZGRkQvZzsKICAgICAgICAgIGZ1bmN0aW9uIG5vcm1hbGl6ZU1hcmt1cEZvclRleHRPckF0dHJpYnV0ZShtYXJrdXApIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNoZWNrSHRtbFN0cmluZ0NvZXJjaW9uKG1hcmt1cCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG1hcmt1cFN0cmluZyA9IHR5cGVvZiBtYXJrdXAgPT09ICJzdHJpbmciID8gbWFya3VwIDogIiIgKyBtYXJrdXA7CiAgICAgICAgICAgIHJldHVybiBtYXJrdXBTdHJpbmcucmVwbGFjZShOT1JNQUxJWkVfTkVXTElORVNfUkVHRVgsICJcbiIpLnJlcGxhY2UoTk9STUFMSVpFX05VTExfQU5EX1JFUExBQ0VNRU5UX1JFR0VYLCAiIik7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjaGVja0ZvclVubWF0Y2hlZFRleHQoc2VydmVyVGV4dCwgY2xpZW50VGV4dCwgaXNDb25jdXJyZW50TW9kZSwgc2hvdWxkV2FybkRldikgewogICAgICAgICAgICB2YXIgbm9ybWFsaXplZENsaWVudFRleHQgPSBub3JtYWxpemVNYXJrdXBGb3JUZXh0T3JBdHRyaWJ1dGUoY2xpZW50VGV4dCk7CiAgICAgICAgICAgIHZhciBub3JtYWxpemVkU2VydmVyVGV4dCA9IG5vcm1hbGl6ZU1hcmt1cEZvclRleHRPckF0dHJpYnV0ZShzZXJ2ZXJUZXh0KTsKICAgICAgICAgICAgaWYgKG5vcm1hbGl6ZWRTZXJ2ZXJUZXh0ID09PSBub3JtYWxpemVkQ2xpZW50VGV4dCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2hvdWxkV2FybkRldikgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICAgICAgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSB0cnVlOwogICAgICAgICAgICAgICAgICBlcnJvcignVGV4dCBjb250ZW50IGRpZCBub3QgbWF0Y2guIFNlcnZlcjogIiVzIiBDbGllbnQ6ICIlcyInLCBub3JtYWxpemVkU2VydmVyVGV4dCwgbm9ybWFsaXplZENsaWVudFRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNDb25jdXJyZW50TW9kZSAmJiBlbmFibGVDbGllbnRSZW5kZXJGYWxsYmFja09uVGV4dE1pc21hdGNoKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUZXh0IGNvbnRlbnQgZG9lcyBub3QgbWF0Y2ggc2VydmVyLXJlbmRlcmVkIEhUTUwuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldE93bmVyRG9jdW1lbnRGcm9tUm9vdENvbnRhaW5lcihyb290Q29udGFpbmVyRWxlbWVudCkgewogICAgICAgICAgICByZXR1cm4gcm9vdENvbnRhaW5lckVsZW1lbnQubm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUgPyByb290Q29udGFpbmVyRWxlbWVudCA6IHJvb3RDb250YWluZXJFbGVtZW50Lm93bmVyRG9jdW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBub29wMigpIHsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHRyYXBDbGlja09uTm9uSW50ZXJhY3RpdmVFbGVtZW50KG5vZGUpIHsKICAgICAgICAgICAgbm9kZS5vbmNsaWNrID0gbm9vcDI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzZXRJbml0aWFsRE9NUHJvcGVydGllcyh0YWcsIGRvbUVsZW1lbnQsIHJvb3RDb250YWluZXJFbGVtZW50LCBuZXh0UHJvcHMsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICAgIGZvciAodmFyIHByb3BLZXkgaW4gbmV4dFByb3BzKSB7CiAgICAgICAgICAgICAgaWYgKCFuZXh0UHJvcHMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgbmV4dFByb3AgPSBuZXh0UHJvcHNbcHJvcEtleV07CiAgICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09IFNUWUxFKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmIChuZXh0UHJvcCkgewogICAgICAgICAgICAgICAgICAgIE9iamVjdC5mcmVlemUobmV4dFByb3ApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzZXRWYWx1ZUZvclN0eWxlcyhkb21FbGVtZW50LCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBEQU5HRVJPVVNMWV9TRVRfSU5ORVJfSFRNTCkgewogICAgICAgICAgICAgICAgdmFyIG5leHRIdG1sID0gbmV4dFByb3AgPyBuZXh0UHJvcFtIVE1MJDFdIDogdm9pZCAwOwogICAgICAgICAgICAgICAgaWYgKG5leHRIdG1sICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgc2V0SW5uZXJIVE1MKGRvbUVsZW1lbnQsIG5leHRIdG1sKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IENISUxEUkVOKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG5leHRQcm9wID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICB2YXIgY2FuU2V0VGV4dENvbnRlbnQgPSB0YWcgIT09ICJ0ZXh0YXJlYSIgfHwgbmV4dFByb3AgIT09ICIiOwogICAgICAgICAgICAgICAgICBpZiAoY2FuU2V0VGV4dENvbnRlbnQpIHsKICAgICAgICAgICAgICAgICAgICBzZXRUZXh0Q29udGVudChkb21FbGVtZW50LCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG5leHRQcm9wID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgICBzZXRUZXh0Q29udGVudChkb21FbGVtZW50LCAiIiArIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IFNVUFBSRVNTX0NPTlRFTlRfRURJVEFCTEVfV0FSTklORyB8fCBwcm9wS2V5ID09PSBTVVBQUkVTU19IWURSQVRJT05fV0FSTklORykKICAgICAgICAgICAgICAgIDsKICAgICAgICAgICAgICBlbHNlIGlmIChwcm9wS2V5ID09PSBBVVRPRk9DVVMpCiAgICAgICAgICAgICAgICA7CiAgICAgICAgICAgICAgZWxzZSBpZiAocmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcy5oYXNPd25Qcm9wZXJ0eShwcm9wS2V5KSkgewogICAgICAgICAgICAgICAgaWYgKG5leHRQcm9wICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHdhcm5Gb3JJbnZhbGlkRXZlbnRMaXN0ZW5lcihwcm9wS2V5LCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09ICJvblNjcm9sbCIpIHsKICAgICAgICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJzY3JvbGwiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAobmV4dFByb3AgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2V0VmFsdWVGb3JQcm9wZXJ0eShkb21FbGVtZW50LCBwcm9wS2V5LCBuZXh0UHJvcCwgaXNDdXN0b21Db21wb25lbnRUYWcpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlRE9NUHJvcGVydGllcyhkb21FbGVtZW50LCB1cGRhdGVQYXlsb2FkLCB3YXNDdXN0b21Db21wb25lbnRUYWcsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdXBkYXRlUGF5bG9hZC5sZW5ndGg7IGkgKz0gMikgewogICAgICAgICAgICAgIHZhciBwcm9wS2V5ID0gdXBkYXRlUGF5bG9hZFtpXTsKICAgICAgICAgICAgICB2YXIgcHJvcFZhbHVlID0gdXBkYXRlUGF5bG9hZFtpICsgMV07CiAgICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09IFNUWUxFKSB7CiAgICAgICAgICAgICAgICBzZXRWYWx1ZUZvclN0eWxlcyhkb21FbGVtZW50LCBwcm9wVmFsdWUpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwpIHsKICAgICAgICAgICAgICAgIHNldElubmVySFRNTChkb21FbGVtZW50LCBwcm9wVmFsdWUpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gQ0hJTERSRU4pIHsKICAgICAgICAgICAgICAgIHNldFRleHRDb250ZW50KGRvbUVsZW1lbnQsIHByb3BWYWx1ZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNldFZhbHVlRm9yUHJvcGVydHkoZG9tRWxlbWVudCwgcHJvcEtleSwgcHJvcFZhbHVlLCBpc0N1c3RvbUNvbXBvbmVudFRhZyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVFbGVtZW50KHR5cGUyLCBwcm9wcywgcm9vdENvbnRhaW5lckVsZW1lbnQsIHBhcmVudE5hbWVzcGFjZSkgewogICAgICAgICAgICB2YXIgaXNDdXN0b21Db21wb25lbnRUYWc7CiAgICAgICAgICAgIHZhciBvd25lckRvY3VtZW50ID0gZ2V0T3duZXJEb2N1bWVudEZyb21Sb290Q29udGFpbmVyKHJvb3RDb250YWluZXJFbGVtZW50KTsKICAgICAgICAgICAgdmFyIGRvbUVsZW1lbnQ7CiAgICAgICAgICAgIHZhciBuYW1lc3BhY2VVUkkgPSBwYXJlbnROYW1lc3BhY2U7CiAgICAgICAgICAgIGlmIChuYW1lc3BhY2VVUkkgPT09IEhUTUxfTkFNRVNQQUNFKSB7CiAgICAgICAgICAgICAgbmFtZXNwYWNlVVJJID0gZ2V0SW50cmluc2ljTmFtZXNwYWNlKHR5cGUyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobmFtZXNwYWNlVVJJID09PSBIVE1MX05BTUVTUEFDRSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlzQ3VzdG9tQ29tcG9uZW50VGFnID0gaXNDdXN0b21Db21wb25lbnQodHlwZTIsIHByb3BzKTsKICAgICAgICAgICAgICAgIGlmICghaXNDdXN0b21Db21wb25lbnRUYWcgJiYgdHlwZTIgIT09IHR5cGUyLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIjwlcyAvPiBpcyB1c2luZyBpbmNvcnJlY3QgY2FzaW5nLiBVc2UgUGFzY2FsQ2FzZSBmb3IgUmVhY3QgY29tcG9uZW50cywgb3IgbG93ZXJjYXNlIGZvciBIVE1MIGVsZW1lbnRzLiIsIHR5cGUyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGUyID09PSAic2NyaXB0IikgewogICAgICAgICAgICAgICAgdmFyIGRpdiA9IG93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgICAgICBkaXYuaW5uZXJIVE1MID0gIjxzY3JpcHQ+PFwvc2NyaXB0PiI7CiAgICAgICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IGRpdi5maXJzdENoaWxkOwogICAgICAgICAgICAgICAgZG9tRWxlbWVudCA9IGRpdi5yZW1vdmVDaGlsZChmaXJzdENoaWxkKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBwcm9wcy5pcyA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIGRvbUVsZW1lbnQgPSBvd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodHlwZTIsIHsKICAgICAgICAgICAgICAgICAgaXM6IHByb3BzLmlzCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZG9tRWxlbWVudCA9IG93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0eXBlMik7CiAgICAgICAgICAgICAgICBpZiAodHlwZTIgPT09ICJzZWxlY3QiKSB7CiAgICAgICAgICAgICAgICAgIHZhciBub2RlID0gZG9tRWxlbWVudDsKICAgICAgICAgICAgICAgICAgaWYgKHByb3BzLm11bHRpcGxlKSB7CiAgICAgICAgICAgICAgICAgICAgbm9kZS5tdWx0aXBsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcHMuc2l6ZSkgewogICAgICAgICAgICAgICAgICAgIG5vZGUuc2l6ZSA9IHByb3BzLnNpemU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZG9tRWxlbWVudCA9IG93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKG5hbWVzcGFjZVVSSSwgdHlwZTIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAobmFtZXNwYWNlVVJJID09PSBIVE1MX05BTUVTUEFDRSkgewogICAgICAgICAgICAgICAgaWYgKCFpc0N1c3RvbUNvbXBvbmVudFRhZyAmJiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoZG9tRWxlbWVudCkgPT09ICJbb2JqZWN0IEhUTUxVbmtub3duRWxlbWVudF0iICYmICFoYXNPd25Qcm9wZXJ0eS5jYWxsKHdhcm5lZFVua25vd25UYWdzLCB0eXBlMikpIHsKICAgICAgICAgICAgICAgICAgd2FybmVkVW5rbm93blRhZ3NbdHlwZTJdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlRoZSB0YWcgPCVzPiBpcyB1bnJlY29nbml6ZWQgaW4gdGhpcyBicm93c2VyLiBJZiB5b3UgbWVhbnQgdG8gcmVuZGVyIGEgUmVhY3QgY29tcG9uZW50LCBzdGFydCBpdHMgbmFtZSB3aXRoIGFuIHVwcGVyY2FzZSBsZXR0ZXIuIiwgdHlwZTIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZG9tRWxlbWVudDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVRleHROb2RlKHRleHQsIHJvb3RDb250YWluZXJFbGVtZW50KSB7CiAgICAgICAgICAgIHJldHVybiBnZXRPd25lckRvY3VtZW50RnJvbVJvb3RDb250YWluZXIocm9vdENvbnRhaW5lckVsZW1lbnQpLmNyZWF0ZVRleHROb2RlKHRleHQpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gc2V0SW5pdGlhbFByb3BlcnRpZXMoZG9tRWxlbWVudCwgdGFnLCByYXdQcm9wcywgcm9vdENvbnRhaW5lckVsZW1lbnQpIHsKICAgICAgICAgICAgdmFyIGlzQ3VzdG9tQ29tcG9uZW50VGFnID0gaXNDdXN0b21Db21wb25lbnQodGFnLCByYXdQcm9wcyk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXNJbkRldmVsb3BtZW50KHRhZywgcmF3UHJvcHMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwcm9wczsKICAgICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgICBjYXNlICJkaWFsb2ciOgogICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiY2FuY2VsIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJjbG9zZSIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgImlmcmFtZSI6CiAgICAgICAgICAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgICAgICAgICBjYXNlICJlbWJlZCI6CiAgICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJsb2FkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgICBwcm9wcyA9IHJhd1Byb3BzOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAidmlkZW8iOgogICAgICAgICAgICAgIGNhc2UgImF1ZGlvIjoKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbWVkaWFFdmVudFR5cGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQobWVkaWFFdmVudFR5cGVzW2ldLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJzb3VyY2UiOgogICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiZXJyb3IiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJpbWciOgogICAgICAgICAgICAgIGNhc2UgImltYWdlIjoKICAgICAgICAgICAgICBjYXNlICJsaW5rIjoKICAgICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImVycm9yIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJsb2FkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgICBwcm9wcyA9IHJhd1Byb3BzOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAiZGV0YWlscyI6CiAgICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJ0b2dnbGUiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgICBpbml0V3JhcHBlclN0YXRlKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICAgIHByb3BzID0gZ2V0SG9zdFByb3BzKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImludmFsaWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgIm9wdGlvbiI6CiAgICAgICAgICAgICAgICB2YWxpZGF0ZVByb3BzKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgICAgaW5pdFdyYXBwZXJTdGF0ZSQxKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICAgIHByb3BzID0gZ2V0SG9zdFByb3BzJDEoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiaW52YWxpZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgICAgaW5pdFdyYXBwZXJTdGF0ZSQyKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICAgIHByb3BzID0gZ2V0SG9zdFByb3BzJDIoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiaW52YWxpZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYXNzZXJ0VmFsaWRQcm9wcyh0YWcsIHByb3BzKTsKICAgICAgICAgICAgc2V0SW5pdGlhbERPTVByb3BlcnRpZXModGFnLCBkb21FbGVtZW50LCByb290Q29udGFpbmVyRWxlbWVudCwgcHJvcHMsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKTsKICAgICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgICB0cmFjayhkb21FbGVtZW50KTsKICAgICAgICAgICAgICAgIHBvc3RNb3VudFdyYXBwZXIoZG9tRWxlbWVudCwgcmF3UHJvcHMsIGZhbHNlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICAgIHRyYWNrKGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgICAgcG9zdE1vdW50V3JhcHBlciQzKGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAib3B0aW9uIjoKICAgICAgICAgICAgICAgIHBvc3RNb3VudFdyYXBwZXIkMShkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgICAgcG9zdE1vdW50V3JhcHBlciQyKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHByb3BzLm9uQ2xpY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgdHJhcENsaWNrT25Ob25JbnRlcmFjdGl2ZUVsZW1lbnQoZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZGlmZlByb3BlcnRpZXMoZG9tRWxlbWVudCwgdGFnLCBsYXN0UmF3UHJvcHMsIG5leHRSYXdQcm9wcywgcm9vdENvbnRhaW5lckVsZW1lbnQpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllc0luRGV2ZWxvcG1lbnQodGFnLCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB1cGRhdGVQYXlsb2FkID0gbnVsbDsKICAgICAgICAgICAgdmFyIGxhc3RQcm9wczsKICAgICAgICAgICAgdmFyIG5leHRQcm9wczsKICAgICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgICBsYXN0UHJvcHMgPSBnZXRIb3N0UHJvcHMoZG9tRWxlbWVudCwgbGFzdFJhd1Byb3BzKTsKICAgICAgICAgICAgICAgIG5leHRQcm9wcyA9IGdldEhvc3RQcm9wcyhkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtdOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgICAgIGxhc3RQcm9wcyA9IGdldEhvc3RQcm9wcyQxKGRvbUVsZW1lbnQsIGxhc3RSYXdQcm9wcyk7CiAgICAgICAgICAgICAgICBuZXh0UHJvcHMgPSBnZXRIb3N0UHJvcHMkMShkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtdOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgICAgbGFzdFByb3BzID0gZ2V0SG9zdFByb3BzJDIoZG9tRWxlbWVudCwgbGFzdFJhd1Byb3BzKTsKICAgICAgICAgICAgICAgIG5leHRQcm9wcyA9IGdldEhvc3RQcm9wcyQyKGRvbUVsZW1lbnQsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gW107CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgbGFzdFByb3BzID0gbGFzdFJhd1Byb3BzOwogICAgICAgICAgICAgICAgbmV4dFByb3BzID0gbmV4dFJhd1Byb3BzOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBsYXN0UHJvcHMub25DbGljayAhPT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgbmV4dFByb3BzLm9uQ2xpY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgdHJhcENsaWNrT25Ob25JbnRlcmFjdGl2ZUVsZW1lbnQoZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBhc3NlcnRWYWxpZFByb3BzKHRhZywgbmV4dFByb3BzKTsKICAgICAgICAgICAgdmFyIHByb3BLZXk7CiAgICAgICAgICAgIHZhciBzdHlsZU5hbWU7CiAgICAgICAgICAgIHZhciBzdHlsZVVwZGF0ZXMgPSBudWxsOwogICAgICAgICAgICBmb3IgKHByb3BLZXkgaW4gbGFzdFByb3BzKSB7CiAgICAgICAgICAgICAgaWYgKG5leHRQcm9wcy5oYXNPd25Qcm9wZXJ0eShwcm9wS2V5KSB8fCAhbGFzdFByb3BzLmhhc093blByb3BlcnR5KHByb3BLZXkpIHx8IGxhc3RQcm9wc1twcm9wS2V5XSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09IFNUWUxFKSB7CiAgICAgICAgICAgICAgICB2YXIgbGFzdFN0eWxlID0gbGFzdFByb3BzW3Byb3BLZXldOwogICAgICAgICAgICAgICAgZm9yIChzdHlsZU5hbWUgaW4gbGFzdFN0eWxlKSB7CiAgICAgICAgICAgICAgICAgIGlmIChsYXN0U3R5bGUuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSkgewogICAgICAgICAgICAgICAgICAgIGlmICghc3R5bGVVcGRhdGVzKSB7CiAgICAgICAgICAgICAgICAgICAgICBzdHlsZVVwZGF0ZXMgPSB7fTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgc3R5bGVVcGRhdGVzW3N0eWxlTmFtZV0gPSAiIjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwgfHwgcHJvcEtleSA9PT0gQ0hJTERSRU4pCiAgICAgICAgICAgICAgICA7CiAgICAgICAgICAgICAgZWxzZSBpZiAocHJvcEtleSA9PT0gU1VQUFJFU1NfQ09OVEVOVF9FRElUQUJMRV9XQVJOSU5HIHx8IHByb3BLZXkgPT09IFNVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HKQogICAgICAgICAgICAgICAgOwogICAgICAgICAgICAgIGVsc2UgaWYgKHByb3BLZXkgPT09IEFVVE9GT0NVUykKICAgICAgICAgICAgICAgIDsKICAgICAgICAgICAgICBlbHNlIGlmIChyZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzLmhhc093blByb3BlcnR5KHByb3BLZXkpKSB7CiAgICAgICAgICAgICAgICBpZiAoIXVwZGF0ZVBheWxvYWQpIHsKICAgICAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAodXBkYXRlUGF5bG9hZCA9IHVwZGF0ZVBheWxvYWQgfHwgW10pLnB1c2gocHJvcEtleSwgbnVsbCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAocHJvcEtleSBpbiBuZXh0UHJvcHMpIHsKICAgICAgICAgICAgICB2YXIgbmV4dFByb3AgPSBuZXh0UHJvcHNbcHJvcEtleV07CiAgICAgICAgICAgICAgdmFyIGxhc3RQcm9wID0gbGFzdFByb3BzICE9IG51bGwgPyBsYXN0UHJvcHNbcHJvcEtleV0gOiB2b2lkIDA7CiAgICAgICAgICAgICAgaWYgKCFuZXh0UHJvcHMuaGFzT3duUHJvcGVydHkocHJvcEtleSkgfHwgbmV4dFByb3AgPT09IGxhc3RQcm9wIHx8IG5leHRQcm9wID09IG51bGwgJiYgbGFzdFByb3AgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSBTVFlMRSkgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAobmV4dFByb3ApIHsKICAgICAgICAgICAgICAgICAgICBPYmplY3QuZnJlZXplKG5leHRQcm9wKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGxhc3RQcm9wKSB7CiAgICAgICAgICAgICAgICAgIGZvciAoc3R5bGVOYW1lIGluIGxhc3RQcm9wKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGxhc3RQcm9wLmhhc093blByb3BlcnR5KHN0eWxlTmFtZSkgJiYgKCFuZXh0UHJvcCB8fCAhbmV4dFByb3AuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSkpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmICghc3R5bGVVcGRhdGVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlVXBkYXRlcyA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgc3R5bGVVcGRhdGVzW3N0eWxlTmFtZV0gPSAiIjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZm9yIChzdHlsZU5hbWUgaW4gbmV4dFByb3ApIHsKICAgICAgICAgICAgICAgICAgICBpZiAobmV4dFByb3AuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSAmJiBsYXN0UHJvcFtzdHlsZU5hbWVdICE9PSBuZXh0UHJvcFtzdHlsZU5hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIXN0eWxlVXBkYXRlcykgewogICAgICAgICAgICAgICAgICAgICAgICBzdHlsZVVwZGF0ZXMgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIHN0eWxlVXBkYXRlc1tzdHlsZU5hbWVdID0gbmV4dFByb3Bbc3R5bGVOYW1lXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGlmICghc3R5bGVVcGRhdGVzKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF1cGRhdGVQYXlsb2FkKSB7CiAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gW107CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQucHVzaChwcm9wS2V5LCBzdHlsZVVwZGF0ZXMpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHN0eWxlVXBkYXRlcyA9IG5leHRQcm9wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwpIHsKICAgICAgICAgICAgICAgIHZhciBuZXh0SHRtbCA9IG5leHRQcm9wID8gbmV4dFByb3BbSFRNTCQxXSA6IHZvaWQgMDsKICAgICAgICAgICAgICAgIHZhciBsYXN0SHRtbCA9IGxhc3RQcm9wID8gbGFzdFByb3BbSFRNTCQxXSA6IHZvaWQgMDsKICAgICAgICAgICAgICAgIGlmIChuZXh0SHRtbCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGlmIChsYXN0SHRtbCAhPT0gbmV4dEh0bWwpIHsKICAgICAgICAgICAgICAgICAgICAodXBkYXRlUGF5bG9hZCA9IHVwZGF0ZVBheWxvYWQgfHwgW10pLnB1c2gocHJvcEtleSwgbmV4dEh0bWwpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBDSElMRFJFTikgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCA9PT0gInN0cmluZyIgfHwgdHlwZW9mIG5leHRQcm9wID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgICAodXBkYXRlUGF5bG9hZCA9IHVwZGF0ZVBheWxvYWQgfHwgW10pLnB1c2gocHJvcEtleSwgIiIgKyBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBTVVBQUkVTU19DT05URU5UX0VESVRBQkxFX1dBUk5JTkcgfHwgcHJvcEtleSA9PT0gU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkcpCiAgICAgICAgICAgICAgICA7CiAgICAgICAgICAgICAgZWxzZSBpZiAocmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcy5oYXNPd25Qcm9wZXJ0eShwcm9wS2V5KSkgewogICAgICAgICAgICAgICAgaWYgKG5leHRQcm9wICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHdhcm5Gb3JJbnZhbGlkRXZlbnRMaXN0ZW5lcihwcm9wS2V5LCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09ICJvblNjcm9sbCIpIHsKICAgICAgICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJzY3JvbGwiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCF1cGRhdGVQYXlsb2FkICYmIGxhc3RQcm9wICE9PSBuZXh0UHJvcCkgewogICAgICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gW107CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICh1cGRhdGVQYXlsb2FkID0gdXBkYXRlUGF5bG9hZCB8fCBbXSkucHVzaChwcm9wS2V5LCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzdHlsZVVwZGF0ZXMpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YWxpZGF0ZVNob3J0aGFuZFByb3BlcnR5Q29sbGlzaW9uSW5EZXYoc3R5bGVVcGRhdGVzLCBuZXh0UHJvcHNbU1RZTEVdKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgKHVwZGF0ZVBheWxvYWQgPSB1cGRhdGVQYXlsb2FkIHx8IFtdKS5wdXNoKFNUWUxFLCBzdHlsZVVwZGF0ZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVQYXlsb2FkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlUHJvcGVydGllcyhkb21FbGVtZW50LCB1cGRhdGVQYXlsb2FkLCB0YWcsIGxhc3RSYXdQcm9wcywgbmV4dFJhd1Byb3BzKSB7CiAgICAgICAgICAgIGlmICh0YWcgPT09ICJpbnB1dCIgJiYgbmV4dFJhd1Byb3BzLnR5cGUgPT09ICJyYWRpbyIgJiYgbmV4dFJhd1Byb3BzLm5hbWUgIT0gbnVsbCkgewogICAgICAgICAgICAgIHVwZGF0ZUNoZWNrZWQoZG9tRWxlbWVudCwgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgd2FzQ3VzdG9tQ29tcG9uZW50VGFnID0gaXNDdXN0b21Db21wb25lbnQodGFnLCBsYXN0UmF3UHJvcHMpOwogICAgICAgICAgICB2YXIgaXNDdXN0b21Db21wb25lbnRUYWcgPSBpc0N1c3RvbUNvbXBvbmVudCh0YWcsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICAgIHVwZGF0ZURPTVByb3BlcnRpZXMoZG9tRWxlbWVudCwgdXBkYXRlUGF5bG9hZCwgd2FzQ3VzdG9tQ29tcG9uZW50VGFnLCBpc0N1c3RvbUNvbXBvbmVudFRhZyk7CiAgICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgICAgdXBkYXRlV3JhcHBlcihkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgICAgdXBkYXRlV3JhcHBlciQxKGRvbUVsZW1lbnQsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgICAgcG9zdFVwZGF0ZVdyYXBwZXIoZG9tRWxlbWVudCwgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRQb3NzaWJsZVN0YW5kYXJkTmFtZShwcm9wTmFtZSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIGxvd2VyQ2FzZWROYW1lID0gcHJvcE5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICBpZiAoIXBvc3NpYmxlU3RhbmRhcmROYW1lcy5oYXNPd25Qcm9wZXJ0eShsb3dlckNhc2VkTmFtZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcG9zc2libGVTdGFuZGFyZE5hbWVzW2xvd2VyQ2FzZWROYW1lXSB8fCBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBkaWZmSHlkcmF0ZWRQcm9wZXJ0aWVzKGRvbUVsZW1lbnQsIHRhZywgcmF3UHJvcHMsIHBhcmVudE5hbWVzcGFjZSwgcm9vdENvbnRhaW5lckVsZW1lbnQsIGlzQ29uY3VycmVudE1vZGUsIHNob3VsZFdhcm5EZXYpIHsKICAgICAgICAgICAgdmFyIGlzQ3VzdG9tQ29tcG9uZW50VGFnOwogICAgICAgICAgICB2YXIgZXh0cmFBdHRyaWJ1dGVOYW1lczsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlzQ3VzdG9tQ29tcG9uZW50VGFnID0gaXNDdXN0b21Db21wb25lbnQodGFnLCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgdmFsaWRhdGVQcm9wZXJ0aWVzSW5EZXZlbG9wbWVudCh0YWcsIHJhd1Byb3BzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICAgIGNhc2UgImRpYWxvZyI6CiAgICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJjYW5jZWwiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImNsb3NlIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJpZnJhbWUiOgogICAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgY2FzZSAiZW1iZWQiOgogICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgibG9hZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAidmlkZW8iOgogICAgICAgICAgICAgIGNhc2UgImF1ZGlvIjoKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbWVkaWFFdmVudFR5cGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQobWVkaWFFdmVudFR5cGVzW2ldLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgInNvdXJjZSI6CiAgICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJlcnJvciIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAiaW1nIjoKICAgICAgICAgICAgICBjYXNlICJpbWFnZSI6CiAgICAgICAgICAgICAgY2FzZSAibGluayI6CiAgICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJlcnJvciIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgibG9hZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAiZGV0YWlscyI6CiAgICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJ0b2dnbGUiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgImlucHV0IjoKICAgICAgICAgICAgICAgIGluaXRXcmFwcGVyU3RhdGUoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiaW52YWxpZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAib3B0aW9uIjoKICAgICAgICAgICAgICAgIHZhbGlkYXRlUHJvcHMoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgICAgIGluaXRXcmFwcGVyU3RhdGUkMShkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJpbnZhbGlkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgICBpbml0V3JhcHBlclN0YXRlJDIoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiaW52YWxpZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYXNzZXJ0VmFsaWRQcm9wcyh0YWcsIHJhd1Byb3BzKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgIHZhciBhdHRyaWJ1dGVzID0gZG9tRWxlbWVudC5hdHRyaWJ1dGVzOwogICAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBhdHRyaWJ1dGVzLmxlbmd0aDsgX2krKykgewogICAgICAgICAgICAgICAgdmFyIG5hbWUgPSBhdHRyaWJ1dGVzW19pXS5uYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKG5hbWUpIHsKICAgICAgICAgICAgICAgICAgY2FzZSAidmFsdWUiOgogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlICJjaGVja2VkIjoKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAic2VsZWN0ZWQiOgogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuYWRkKGF0dHJpYnV0ZXNbX2ldLm5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdXBkYXRlUGF5bG9hZCA9IG51bGw7CiAgICAgICAgICAgIGZvciAodmFyIHByb3BLZXkgaW4gcmF3UHJvcHMpIHsKICAgICAgICAgICAgICBpZiAoIXJhd1Byb3BzLmhhc093blByb3BlcnR5KHByb3BLZXkpKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG5leHRQcm9wID0gcmF3UHJvcHNbcHJvcEtleV07CiAgICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09IENISUxEUkVOKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG5leHRQcm9wID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICBpZiAoZG9tRWxlbWVudC50ZXh0Q29udGVudCAhPT0gbmV4dFByb3ApIHsKICAgICAgICAgICAgICAgICAgICBpZiAocmF3UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkddICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICBjaGVja0ZvclVubWF0Y2hlZFRleHQoZG9tRWxlbWVudC50ZXh0Q29udGVudCwgbmV4dFByb3AsIGlzQ29uY3VycmVudE1vZGUsIHNob3VsZFdhcm5EZXYpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gW0NISUxEUkVOLCBuZXh0UHJvcF07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG5leHRQcm9wID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgICBpZiAoZG9tRWxlbWVudC50ZXh0Q29udGVudCAhPT0gIiIgKyBuZXh0UHJvcCkgewogICAgICAgICAgICAgICAgICAgIGlmIChyYXdQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklOR10gIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgIGNoZWNrRm9yVW5tYXRjaGVkVGV4dChkb21FbGVtZW50LnRleHRDb250ZW50LCBuZXh0UHJvcCwgaXNDb25jdXJyZW50TW9kZSwgc2hvdWxkV2FybkRldik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbQ0hJTERSRU4sICIiICsgbmV4dFByb3BdOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzLmhhc093blByb3BlcnR5KHByb3BLZXkpKSB7CiAgICAgICAgICAgICAgICBpZiAobmV4dFByb3AgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG5leHRQcm9wICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgd2FybkZvckludmFsaWRFdmVudExpc3RlbmVyKHByb3BLZXksIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAocHJvcEtleSA9PT0gIm9uU2Nyb2xsIikgewogICAgICAgICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoInNjcm9sbCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChzaG91bGRXYXJuRGV2ICYmIHRydWUgJiYgLy8gQ29udmluY2UgRmxvdyB3ZSd2ZSBjYWxjdWxhdGVkIGl0IChpdCdzIERFVi1vbmx5IGluIHRoaXMgbWV0aG9kLikKICAgICAgICAgICAgICB0eXBlb2YgaXNDdXN0b21Db21wb25lbnRUYWcgPT09ICJib29sZWFuIikgewogICAgICAgICAgICAgICAgdmFyIHNlcnZlclZhbHVlID0gdm9pZCAwOwogICAgICAgICAgICAgICAgdmFyIHByb3BlcnR5SW5mbyA9IGlzQ3VzdG9tQ29tcG9uZW50VGFnICYmIGVuYWJsZUN1c3RvbUVsZW1lbnRQcm9wZXJ0eVN1cHBvcnQgPyBudWxsIDogZ2V0UHJvcGVydHlJbmZvKHByb3BLZXkpOwogICAgICAgICAgICAgICAgaWYgKHJhd1Byb3BzW1NVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HXSA9PT0gdHJ1ZSkKICAgICAgICAgICAgICAgICAgOwogICAgICAgICAgICAgICAgZWxzZSBpZiAocHJvcEtleSA9PT0gU1VQUFJFU1NfQ09OVEVOVF9FRElUQUJMRV9XQVJOSU5HIHx8IHByb3BLZXkgPT09IFNVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HIHx8IC8vIENvbnRyb2xsZWQgYXR0cmlidXRlcyBhcmUgbm90IHZhbGlkYXRlZAogICAgICAgICAgICAgICAgLy8gVE9ETzogT25seSBpZ25vcmUgdGhlbSBvbiBjb250cm9sbGVkIHRhZ3MuCiAgICAgICAgICAgICAgICBwcm9wS2V5ID09PSAidmFsdWUiIHx8IHByb3BLZXkgPT09ICJjaGVja2VkIiB8fCBwcm9wS2V5ID09PSAic2VsZWN0ZWQiKQogICAgICAgICAgICAgICAgICA7CiAgICAgICAgICAgICAgICBlbHNlIGlmIChwcm9wS2V5ID09PSBEQU5HRVJPVVNMWV9TRVRfSU5ORVJfSFRNTCkgewogICAgICAgICAgICAgICAgICB2YXIgc2VydmVySFRNTCA9IGRvbUVsZW1lbnQuaW5uZXJIVE1MOwogICAgICAgICAgICAgICAgICB2YXIgbmV4dEh0bWwgPSBuZXh0UHJvcCA/IG5leHRQcm9wW0hUTUwkMV0gOiB2b2lkIDA7CiAgICAgICAgICAgICAgICAgIGlmIChuZXh0SHRtbCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGV4cGVjdGVkSFRNTCA9IG5vcm1hbGl6ZUhUTUwoZG9tRWxlbWVudCwgbmV4dEh0bWwpOwogICAgICAgICAgICAgICAgICAgIGlmIChleHBlY3RlZEhUTUwgIT09IHNlcnZlckhUTUwpIHsKICAgICAgICAgICAgICAgICAgICAgIHdhcm5Gb3JQcm9wRGlmZmVyZW5jZShwcm9wS2V5LCBzZXJ2ZXJIVE1MLCBleHBlY3RlZEhUTUwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBTVFlMRSkgewogICAgICAgICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzLmRlbGV0ZShwcm9wS2V5KTsKICAgICAgICAgICAgICAgICAgaWYgKGNhbkRpZmZTdHlsZUZvckh5ZHJhdGlvbldhcm5pbmcpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZXhwZWN0ZWRTdHlsZSA9IGNyZWF0ZURhbmdlcm91c1N0cmluZ0ZvclN0eWxlcyhuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICAgICAgc2VydmVyVmFsdWUgPSBkb21FbGVtZW50LmdldEF0dHJpYnV0ZSgic3R5bGUiKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZXhwZWN0ZWRTdHlsZSAhPT0gc2VydmVyVmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgIHdhcm5Gb3JQcm9wRGlmZmVyZW5jZShwcm9wS2V5LCBzZXJ2ZXJWYWx1ZSwgZXhwZWN0ZWRTdHlsZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzQ3VzdG9tQ29tcG9uZW50VGFnICYmICFlbmFibGVDdXN0b21FbGVtZW50UHJvcGVydHlTdXBwb3J0KSB7CiAgICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuZGVsZXRlKHByb3BLZXkudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICAgIHNlcnZlclZhbHVlID0gZ2V0VmFsdWVGb3JBdHRyaWJ1dGUoZG9tRWxlbWVudCwgcHJvcEtleSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgICBpZiAobmV4dFByb3AgIT09IHNlcnZlclZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgd2FybkZvclByb3BEaWZmZXJlbmNlKHByb3BLZXksIHNlcnZlclZhbHVlLCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIXNob3VsZElnbm9yZUF0dHJpYnV0ZShwcm9wS2V5LCBwcm9wZXJ0eUluZm8sIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSAmJiAhc2hvdWxkUmVtb3ZlQXR0cmlidXRlKHByb3BLZXksIG5leHRQcm9wLCBwcm9wZXJ0eUluZm8sIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSkgewogICAgICAgICAgICAgICAgICB2YXIgaXNNaXNtYXRjaER1ZVRvQmFkQ2FzaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8gIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzLmRlbGV0ZShwcm9wZXJ0eUluZm8uYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgc2VydmVyVmFsdWUgPSBnZXRWYWx1ZUZvclByb3BlcnR5KGRvbUVsZW1lbnQsIHByb3BLZXksIG5leHRQcm9wLCBwcm9wZXJ0eUluZm8pOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhciBvd25OYW1lc3BhY2UgPSBwYXJlbnROYW1lc3BhY2U7CiAgICAgICAgICAgICAgICAgICAgaWYgKG93bk5hbWVzcGFjZSA9PT0gSFRNTF9OQU1FU1BBQ0UpIHsKICAgICAgICAgICAgICAgICAgICAgIG93bk5hbWVzcGFjZSA9IGdldEludHJpbnNpY05hbWVzcGFjZSh0YWcpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAob3duTmFtZXNwYWNlID09PSBIVE1MX05BTUVTUEFDRSkgewogICAgICAgICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5kZWxldGUocHJvcEtleS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgdmFyIHN0YW5kYXJkTmFtZSA9IGdldFBvc3NpYmxlU3RhbmRhcmROYW1lKHByb3BLZXkpOwogICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YW5kYXJkTmFtZSAhPT0gbnVsbCAmJiBzdGFuZGFyZE5hbWUgIT09IHByb3BLZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaXNNaXNtYXRjaER1ZVRvQmFkQ2FzaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5kZWxldGUoc3RhbmRhcmROYW1lKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuZGVsZXRlKHByb3BLZXkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzZXJ2ZXJWYWx1ZSA9IGdldFZhbHVlRm9yQXR0cmlidXRlKGRvbUVsZW1lbnQsIHByb3BLZXksIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgZG9udFdhcm5DdXN0b21FbGVtZW50ID0gZW5hYmxlQ3VzdG9tRWxlbWVudFByb3BlcnR5U3VwcG9ydDsKICAgICAgICAgICAgICAgICAgaWYgKCFkb250V2FybkN1c3RvbUVsZW1lbnQgJiYgbmV4dFByb3AgIT09IHNlcnZlclZhbHVlICYmICFpc01pc21hdGNoRHVlVG9CYWRDYXNpbmcpIHsKICAgICAgICAgICAgICAgICAgICB3YXJuRm9yUHJvcERpZmZlcmVuY2UocHJvcEtleSwgc2VydmVyVmFsdWUsIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHNob3VsZFdhcm5EZXYpIHsKICAgICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgICAgLy8gJEZsb3dGaXhNZSAtIFNob3VsZCBiZSBpbmZlcnJlZCBhcyBub3QgdW5kZWZpbmVkLgogICAgICAgICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzLnNpemUgPiAwICYmIHJhd1Byb3BzW1NVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HXSAhPT0gdHJ1ZQogICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgIHdhcm5Gb3JFeHRyYUF0dHJpYnV0ZXMoZXh0cmFBdHRyaWJ1dGVOYW1lcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgICAgdHJhY2soZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgICBwb3N0TW91bnRXcmFwcGVyKGRvbUVsZW1lbnQsIHJhd1Byb3BzLCB0cnVlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICAgIHRyYWNrKGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgICAgcG9zdE1vdW50V3JhcHBlciQzKGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgICBjYXNlICJvcHRpb24iOgogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmF3UHJvcHMub25DbGljayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICB0cmFwQ2xpY2tPbk5vbkludGVyYWN0aXZlRWxlbWVudChkb21FbGVtZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVQYXlsb2FkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZGlmZkh5ZHJhdGVkVGV4dCh0ZXh0Tm9kZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgICB2YXIgaXNEaWZmZXJlbnQgPSB0ZXh0Tm9kZS5ub2RlVmFsdWUgIT09IHRleHQ7CiAgICAgICAgICAgIHJldHVybiBpc0RpZmZlcmVudDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHdhcm5Gb3JEZWxldGVkSHlkcmF0YWJsZUVsZW1lbnQocGFyZW50Tm9kZSwgY2hpbGQpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbikgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgZXJyb3IoIkRpZCBub3QgZXhwZWN0IHNlcnZlciBIVE1MIHRvIGNvbnRhaW4gYSA8JXM+IGluIDwlcz4uIiwgY2hpbGQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwgcGFyZW50Tm9kZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gd2FybkZvckRlbGV0ZWRIeWRyYXRhYmxlVGV4dChwYXJlbnROb2RlLCBjaGlsZCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICBlcnJvcignRGlkIG5vdCBleHBlY3Qgc2VydmVyIEhUTUwgdG8gY29udGFpbiB0aGUgdGV4dCBub2RlICIlcyIgaW4gPCVzPi4nLCBjaGlsZC5ub2RlVmFsdWUsIHBhcmVudE5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkRWxlbWVudChwYXJlbnROb2RlLCB0YWcsIHByb3BzKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSB0cnVlOwogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCBzZXJ2ZXIgSFRNTCB0byBjb250YWluIGEgbWF0Y2hpbmcgPCVzPiBpbiA8JXM+LiIsIHRhZywgcGFyZW50Tm9kZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gd2FybkZvckluc2VydGVkSHlkcmF0ZWRUZXh0KHBhcmVudE5vZGUsIHRleHQpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh0ZXh0ID09PSAiIikgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSB0cnVlOwogICAgICAgICAgICAgIGVycm9yKCdFeHBlY3RlZCBzZXJ2ZXIgSFRNTCB0byBjb250YWluIGEgbWF0Y2hpbmcgdGV4dCBub2RlIGZvciAiJXMiIGluIDwlcz4uJywgdGV4dCwgcGFyZW50Tm9kZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVzdG9yZUNvbnRyb2xsZWRTdGF0ZSQzKGRvbUVsZW1lbnQsIHRhZywgcHJvcHMpIHsKICAgICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgICByZXN0b3JlQ29udHJvbGxlZFN0YXRlKGRvbUVsZW1lbnQsIHByb3BzKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgICByZXN0b3JlQ29udHJvbGxlZFN0YXRlJDIoZG9tRWxlbWVudCwgcHJvcHMpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgICAgICByZXN0b3JlQ29udHJvbGxlZFN0YXRlJDEoZG9tRWxlbWVudCwgcHJvcHMpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdmFsaWRhdGVET01OZXN0aW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHVwZGF0ZWRBbmNlc3RvckluZm8gPSBmdW5jdGlvbigpIHsKICAgICAgICAgIH07CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBzcGVjaWFsVGFncyA9IFsiYWRkcmVzcyIsICJhcHBsZXQiLCAiYXJlYSIsICJhcnRpY2xlIiwgImFzaWRlIiwgImJhc2UiLCAiYmFzZWZvbnQiLCAiYmdzb3VuZCIsICJibG9ja3F1b3RlIiwgImJvZHkiLCAiYnIiLCAiYnV0dG9uIiwgImNhcHRpb24iLCAiY2VudGVyIiwgImNvbCIsICJjb2xncm91cCIsICJkZCIsICJkZXRhaWxzIiwgImRpciIsICJkaXYiLCAiZGwiLCAiZHQiLCAiZW1iZWQiLCAiZmllbGRzZXQiLCAiZmlnY2FwdGlvbiIsICJmaWd1cmUiLCAiZm9vdGVyIiwgImZvcm0iLCAiZnJhbWUiLCAiZnJhbWVzZXQiLCAiaDEiLCAiaDIiLCAiaDMiLCAiaDQiLCAiaDUiLCAiaDYiLCAiaGVhZCIsICJoZWFkZXIiLCAiaGdyb3VwIiwgImhyIiwgImh0bWwiLCAiaWZyYW1lIiwgImltZyIsICJpbnB1dCIsICJpc2luZGV4IiwgImxpIiwgImxpbmsiLCAibGlzdGluZyIsICJtYWluIiwgIm1hcnF1ZWUiLCAibWVudSIsICJtZW51aXRlbSIsICJtZXRhIiwgIm5hdiIsICJub2VtYmVkIiwgIm5vZnJhbWVzIiwgIm5vc2NyaXB0IiwgIm9iamVjdCIsICJvbCIsICJwIiwgInBhcmFtIiwgInBsYWludGV4dCIsICJwcmUiLCAic2NyaXB0IiwgInNlY3Rpb24iLCAic2VsZWN0IiwgInNvdXJjZSIsICJzdHlsZSIsICJzdW1tYXJ5IiwgInRhYmxlIiwgInRib2R5IiwgInRkIiwgInRlbXBsYXRlIiwgInRleHRhcmVhIiwgInRmb290IiwgInRoIiwgInRoZWFkIiwgInRpdGxlIiwgInRyIiwgInRyYWNrIiwgInVsIiwgIndiciIsICJ4bXAiXTsKICAgICAgICAgICAgdmFyIGluU2NvcGVUYWdzID0gWwogICAgICAgICAgICAgICJhcHBsZXQiLAogICAgICAgICAgICAgICJjYXB0aW9uIiwKICAgICAgICAgICAgICAiaHRtbCIsCiAgICAgICAgICAgICAgInRhYmxlIiwKICAgICAgICAgICAgICAidGQiLAogICAgICAgICAgICAgICJ0aCIsCiAgICAgICAgICAgICAgIm1hcnF1ZWUiLAogICAgICAgICAgICAgICJvYmplY3QiLAogICAgICAgICAgICAgICJ0ZW1wbGF0ZSIsCiAgICAgICAgICAgICAgLy8gaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy9tdWx0aXBhZ2Uvc3ludGF4Lmh0bWwjaHRtbC1pbnRlZ3JhdGlvbi1wb2ludAogICAgICAgICAgICAgIC8vIFRPRE86IERpc3Rpbmd1aXNoIGJ5IG5hbWVzcGFjZSBoZXJlIC0tIGZvciA8dGl0bGU+LCBpbmNsdWRpbmcgaXQgaGVyZQogICAgICAgICAgICAgIC8vIGVycnMgb24gdGhlIHNpZGUgb2YgZmV3ZXIgd2FybmluZ3MKICAgICAgICAgICAgICAiZm9yZWlnbk9iamVjdCIsCiAgICAgICAgICAgICAgImRlc2MiLAogICAgICAgICAgICAgICJ0aXRsZSIKICAgICAgICAgICAgXTsKICAgICAgICAgICAgdmFyIGJ1dHRvblNjb3BlVGFncyA9IGluU2NvcGVUYWdzLmNvbmNhdChbImJ1dHRvbiJdKTsKICAgICAgICAgICAgdmFyIGltcGxpZWRFbmRUYWdzID0gWyJkZCIsICJkdCIsICJsaSIsICJvcHRpb24iLCAib3B0Z3JvdXAiLCAicCIsICJycCIsICJydCJdOwogICAgICAgICAgICB2YXIgZW1wdHlBbmNlc3RvckluZm8gPSB7CiAgICAgICAgICAgICAgY3VycmVudDogbnVsbCwKICAgICAgICAgICAgICBmb3JtVGFnOiBudWxsLAogICAgICAgICAgICAgIGFUYWdJblNjb3BlOiBudWxsLAogICAgICAgICAgICAgIGJ1dHRvblRhZ0luU2NvcGU6IG51bGwsCiAgICAgICAgICAgICAgbm9iclRhZ0luU2NvcGU6IG51bGwsCiAgICAgICAgICAgICAgcFRhZ0luQnV0dG9uU2NvcGU6IG51bGwsCiAgICAgICAgICAgICAgbGlzdEl0ZW1UYWdBdXRvY2xvc2luZzogbnVsbCwKICAgICAgICAgICAgICBkbEl0ZW1UYWdBdXRvY2xvc2luZzogbnVsbAogICAgICAgICAgICB9OwogICAgICAgICAgICB1cGRhdGVkQW5jZXN0b3JJbmZvID0gZnVuY3Rpb24ob2xkSW5mbywgdGFnKSB7CiAgICAgICAgICAgICAgdmFyIGFuY2VzdG9ySW5mbyA9IGFzc2lnbih7fSwgb2xkSW5mbyB8fCBlbXB0eUFuY2VzdG9ySW5mbyk7CiAgICAgICAgICAgICAgdmFyIGluZm8gPSB7CiAgICAgICAgICAgICAgICB0YWcKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGlmIChpblNjb3BlVGFncy5pbmRleE9mKHRhZykgIT09IC0xKSB7CiAgICAgICAgICAgICAgICBhbmNlc3RvckluZm8uYVRhZ0luU2NvcGUgPSBudWxsOwogICAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmJ1dHRvblRhZ0luU2NvcGUgPSBudWxsOwogICAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLm5vYnJUYWdJblNjb3BlID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGJ1dHRvblNjb3BlVGFncy5pbmRleE9mKHRhZykgIT09IC0xKSB7CiAgICAgICAgICAgICAgICBhbmNlc3RvckluZm8ucFRhZ0luQnV0dG9uU2NvcGUgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoc3BlY2lhbFRhZ3MuaW5kZXhPZih0YWcpICE9PSAtMSAmJiB0YWcgIT09ICJhZGRyZXNzIiAmJiB0YWcgIT09ICJkaXYiICYmIHRhZyAhPT0gInAiKSB7CiAgICAgICAgICAgICAgICBhbmNlc3RvckluZm8ubGlzdEl0ZW1UYWdBdXRvY2xvc2luZyA9IG51bGw7CiAgICAgICAgICAgICAgICBhbmNlc3RvckluZm8uZGxJdGVtVGFnQXV0b2Nsb3NpbmcgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBhbmNlc3RvckluZm8uY3VycmVudCA9IGluZm87CiAgICAgICAgICAgICAgaWYgKHRhZyA9PT0gImZvcm0iKSB7CiAgICAgICAgICAgICAgICBhbmNlc3RvckluZm8uZm9ybVRhZyA9IGluZm87CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0YWcgPT09ICJhIikgewogICAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmFUYWdJblNjb3BlID0gaW5mbzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHRhZyA9PT0gImJ1dHRvbiIpIHsKICAgICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5idXR0b25UYWdJblNjb3BlID0gaW5mbzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHRhZyA9PT0gIm5vYnIiKSB7CiAgICAgICAgICAgICAgICBhbmNlc3RvckluZm8ubm9iclRhZ0luU2NvcGUgPSBpbmZvOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodGFnID09PSAicCIpIHsKICAgICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5wVGFnSW5CdXR0b25TY29wZSA9IGluZm87CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0YWcgPT09ICJsaSIpIHsKICAgICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5saXN0SXRlbVRhZ0F1dG9jbG9zaW5nID0gaW5mbzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHRhZyA9PT0gImRkIiB8fCB0YWcgPT09ICJkdCIpIHsKICAgICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5kbEl0ZW1UYWdBdXRvY2xvc2luZyA9IGluZm87CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm87CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciBpc1RhZ1ZhbGlkV2l0aFBhcmVudCA9IGZ1bmN0aW9uKHRhZywgcGFyZW50VGFnKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChwYXJlbnRUYWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJvcHRpb24iIHx8IHRhZyA9PT0gIm9wdGdyb3VwIiB8fCB0YWcgPT09ICIjdGV4dCI7CiAgICAgICAgICAgICAgICBjYXNlICJvcHRncm91cCI6CiAgICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJvcHRpb24iIHx8IHRhZyA9PT0gIiN0ZXh0IjsKICAgICAgICAgICAgICAgIGNhc2UgIm9wdGlvbiI6CiAgICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICIjdGV4dCI7CiAgICAgICAgICAgICAgICBjYXNlICJ0ciI6CiAgICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJ0aCIgfHwgdGFnID09PSAidGQiIHx8IHRhZyA9PT0gInN0eWxlIiB8fCB0YWcgPT09ICJzY3JpcHQiIHx8IHRhZyA9PT0gInRlbXBsYXRlIjsKICAgICAgICAgICAgICAgIGNhc2UgInRib2R5IjoKICAgICAgICAgICAgICAgIGNhc2UgInRoZWFkIjoKICAgICAgICAgICAgICAgIGNhc2UgInRmb290IjoKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gInRyIiB8fCB0YWcgPT09ICJzdHlsZSIgfHwgdGFnID09PSAic2NyaXB0IiB8fCB0YWcgPT09ICJ0ZW1wbGF0ZSI7CiAgICAgICAgICAgICAgICBjYXNlICJjb2xncm91cCI6CiAgICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJjb2wiIHx8IHRhZyA9PT0gInRlbXBsYXRlIjsKICAgICAgICAgICAgICAgIGNhc2UgInRhYmxlIjoKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gImNhcHRpb24iIHx8IHRhZyA9PT0gImNvbGdyb3VwIiB8fCB0YWcgPT09ICJ0Ym9keSIgfHwgdGFnID09PSAidGZvb3QiIHx8IHRhZyA9PT0gInRoZWFkIiB8fCB0YWcgPT09ICJzdHlsZSIgfHwgdGFnID09PSAic2NyaXB0IiB8fCB0YWcgPT09ICJ0ZW1wbGF0ZSI7CiAgICAgICAgICAgICAgICBjYXNlICJoZWFkIjoKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gImJhc2UiIHx8IHRhZyA9PT0gImJhc2Vmb250IiB8fCB0YWcgPT09ICJiZ3NvdW5kIiB8fCB0YWcgPT09ICJsaW5rIiB8fCB0YWcgPT09ICJtZXRhIiB8fCB0YWcgPT09ICJ0aXRsZSIgfHwgdGFnID09PSAibm9zY3JpcHQiIHx8IHRhZyA9PT0gIm5vZnJhbWVzIiB8fCB0YWcgPT09ICJzdHlsZSIgfHwgdGFnID09PSAic2NyaXB0IiB8fCB0YWcgPT09ICJ0ZW1wbGF0ZSI7CiAgICAgICAgICAgICAgICBjYXNlICJodG1sIjoKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gImhlYWQiIHx8IHRhZyA9PT0gImJvZHkiIHx8IHRhZyA9PT0gImZyYW1lc2V0IjsKICAgICAgICAgICAgICAgIGNhc2UgImZyYW1lc2V0IjoKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gImZyYW1lIjsKICAgICAgICAgICAgICAgIGNhc2UgIiNkb2N1bWVudCI6CiAgICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJodG1sIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgImgxIjoKICAgICAgICAgICAgICAgIGNhc2UgImgyIjoKICAgICAgICAgICAgICAgIGNhc2UgImgzIjoKICAgICAgICAgICAgICAgIGNhc2UgImg0IjoKICAgICAgICAgICAgICAgIGNhc2UgImg1IjoKICAgICAgICAgICAgICAgIGNhc2UgImg2IjoKICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhcmVudFRhZyAhPT0gImgxIiAmJiBwYXJlbnRUYWcgIT09ICJoMiIgJiYgcGFyZW50VGFnICE9PSAiaDMiICYmIHBhcmVudFRhZyAhPT0gImg0IiAmJiBwYXJlbnRUYWcgIT09ICJoNSIgJiYgcGFyZW50VGFnICE9PSAiaDYiOwogICAgICAgICAgICAgICAgY2FzZSAicnAiOgogICAgICAgICAgICAgICAgY2FzZSAicnQiOgogICAgICAgICAgICAgICAgICByZXR1cm4gaW1wbGllZEVuZFRhZ3MuaW5kZXhPZihwYXJlbnRUYWcpID09PSAtMTsKICAgICAgICAgICAgICAgIGNhc2UgImJvZHkiOgogICAgICAgICAgICAgICAgY2FzZSAiY2FwdGlvbiI6CiAgICAgICAgICAgICAgICBjYXNlICJjb2wiOgogICAgICAgICAgICAgICAgY2FzZSAiY29sZ3JvdXAiOgogICAgICAgICAgICAgICAgY2FzZSAiZnJhbWVzZXQiOgogICAgICAgICAgICAgICAgY2FzZSAiZnJhbWUiOgogICAgICAgICAgICAgICAgY2FzZSAiaGVhZCI6CiAgICAgICAgICAgICAgICBjYXNlICJodG1sIjoKICAgICAgICAgICAgICAgIGNhc2UgInRib2R5IjoKICAgICAgICAgICAgICAgIGNhc2UgInRkIjoKICAgICAgICAgICAgICAgIGNhc2UgInRmb290IjoKICAgICAgICAgICAgICAgIGNhc2UgInRoIjoKICAgICAgICAgICAgICAgIGNhc2UgInRoZWFkIjoKICAgICAgICAgICAgICAgIGNhc2UgInRyIjoKICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhcmVudFRhZyA9PSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIGZpbmRJbnZhbGlkQW5jZXN0b3JGb3JUYWcgPSBmdW5jdGlvbih0YWcsIGFuY2VzdG9ySW5mbykgewogICAgICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgICAgICBjYXNlICJhZGRyZXNzIjoKICAgICAgICAgICAgICAgIGNhc2UgImFydGljbGUiOgogICAgICAgICAgICAgICAgY2FzZSAiYXNpZGUiOgogICAgICAgICAgICAgICAgY2FzZSAiYmxvY2txdW90ZSI6CiAgICAgICAgICAgICAgICBjYXNlICJjZW50ZXIiOgogICAgICAgICAgICAgICAgY2FzZSAiZGV0YWlscyI6CiAgICAgICAgICAgICAgICBjYXNlICJkaWFsb2ciOgogICAgICAgICAgICAgICAgY2FzZSAiZGlyIjoKICAgICAgICAgICAgICAgIGNhc2UgImRpdiI6CiAgICAgICAgICAgICAgICBjYXNlICJkbCI6CiAgICAgICAgICAgICAgICBjYXNlICJmaWVsZHNldCI6CiAgICAgICAgICAgICAgICBjYXNlICJmaWdjYXB0aW9uIjoKICAgICAgICAgICAgICAgIGNhc2UgImZpZ3VyZSI6CiAgICAgICAgICAgICAgICBjYXNlICJmb290ZXIiOgogICAgICAgICAgICAgICAgY2FzZSAiaGVhZGVyIjoKICAgICAgICAgICAgICAgIGNhc2UgImhncm91cCI6CiAgICAgICAgICAgICAgICBjYXNlICJtYWluIjoKICAgICAgICAgICAgICAgIGNhc2UgIm1lbnUiOgogICAgICAgICAgICAgICAgY2FzZSAibmF2IjoKICAgICAgICAgICAgICAgIGNhc2UgIm9sIjoKICAgICAgICAgICAgICAgIGNhc2UgInAiOgogICAgICAgICAgICAgICAgY2FzZSAic2VjdGlvbiI6CiAgICAgICAgICAgICAgICBjYXNlICJzdW1tYXJ5IjoKICAgICAgICAgICAgICAgIGNhc2UgInVsIjoKICAgICAgICAgICAgICAgIGNhc2UgInByZSI6CiAgICAgICAgICAgICAgICBjYXNlICJsaXN0aW5nIjoKICAgICAgICAgICAgICAgIGNhc2UgInRhYmxlIjoKICAgICAgICAgICAgICAgIGNhc2UgImhyIjoKICAgICAgICAgICAgICAgIGNhc2UgInhtcCI6CiAgICAgICAgICAgICAgICBjYXNlICJoMSI6CiAgICAgICAgICAgICAgICBjYXNlICJoMiI6CiAgICAgICAgICAgICAgICBjYXNlICJoMyI6CiAgICAgICAgICAgICAgICBjYXNlICJoNCI6CiAgICAgICAgICAgICAgICBjYXNlICJoNSI6CiAgICAgICAgICAgICAgICBjYXNlICJoNiI6CiAgICAgICAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm8ucFRhZ0luQnV0dG9uU2NvcGU7CiAgICAgICAgICAgICAgICBjYXNlICJmb3JtIjoKICAgICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5mb3JtVGFnIHx8IGFuY2VzdG9ySW5mby5wVGFnSW5CdXR0b25TY29wZTsKICAgICAgICAgICAgICAgIGNhc2UgImxpIjoKICAgICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5saXN0SXRlbVRhZ0F1dG9jbG9zaW5nOwogICAgICAgICAgICAgICAgY2FzZSAiZGQiOgogICAgICAgICAgICAgICAgY2FzZSAiZHQiOgogICAgICAgICAgICAgICAgICByZXR1cm4gYW5jZXN0b3JJbmZvLmRsSXRlbVRhZ0F1dG9jbG9zaW5nOwogICAgICAgICAgICAgICAgY2FzZSAiYnV0dG9uIjoKICAgICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5idXR0b25UYWdJblNjb3BlOwogICAgICAgICAgICAgICAgY2FzZSAiYSI6CiAgICAgICAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm8uYVRhZ0luU2NvcGU7CiAgICAgICAgICAgICAgICBjYXNlICJub2JyIjoKICAgICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5ub2JyVGFnSW5TY29wZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciBkaWRXYXJuJDEgPSB7fTsKICAgICAgICAgICAgdmFsaWRhdGVET01OZXN0aW5nID0gZnVuY3Rpb24oY2hpbGRUYWcsIGNoaWxkVGV4dCwgYW5jZXN0b3JJbmZvKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvID0gYW5jZXN0b3JJbmZvIHx8IGVtcHR5QW5jZXN0b3JJbmZvOwogICAgICAgICAgICAgIHZhciBwYXJlbnRJbmZvID0gYW5jZXN0b3JJbmZvLmN1cnJlbnQ7CiAgICAgICAgICAgICAgdmFyIHBhcmVudFRhZyA9IHBhcmVudEluZm8gJiYgcGFyZW50SW5mby50YWc7CiAgICAgICAgICAgICAgaWYgKGNoaWxkVGV4dCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoY2hpbGRUYWcgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBlcnJvcigidmFsaWRhdGVET01OZXN0aW5nOiB3aGVuIGNoaWxkVGV4dCBpcyBwYXNzZWQsIGNoaWxkVGFnIHNob3VsZCBiZSBudWxsIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjaGlsZFRhZyA9ICIjdGV4dCI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBpbnZhbGlkUGFyZW50ID0gaXNUYWdWYWxpZFdpdGhQYXJlbnQoY2hpbGRUYWcsIHBhcmVudFRhZykgPyBudWxsIDogcGFyZW50SW5mbzsKICAgICAgICAgICAgICB2YXIgaW52YWxpZEFuY2VzdG9yID0gaW52YWxpZFBhcmVudCA/IG51bGwgOiBmaW5kSW52YWxpZEFuY2VzdG9yRm9yVGFnKGNoaWxkVGFnLCBhbmNlc3RvckluZm8pOwogICAgICAgICAgICAgIHZhciBpbnZhbGlkUGFyZW50T3JBbmNlc3RvciA9IGludmFsaWRQYXJlbnQgfHwgaW52YWxpZEFuY2VzdG9yOwogICAgICAgICAgICAgIGlmICghaW52YWxpZFBhcmVudE9yQW5jZXN0b3IpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGFuY2VzdG9yVGFnID0gaW52YWxpZFBhcmVudE9yQW5jZXN0b3IudGFnOwogICAgICAgICAgICAgIHZhciB3YXJuS2V5ID0gISFpbnZhbGlkUGFyZW50ICsgInwiICsgY2hpbGRUYWcgKyAifCIgKyBhbmNlc3RvclRhZzsKICAgICAgICAgICAgICBpZiAoZGlkV2FybiQxW3dhcm5LZXldKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRpZFdhcm4kMVt3YXJuS2V5XSA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIHRhZ0Rpc3BsYXlOYW1lID0gY2hpbGRUYWc7CiAgICAgICAgICAgICAgdmFyIHdoaXRlc3BhY2VJbmZvID0gIiI7CiAgICAgICAgICAgICAgaWYgKGNoaWxkVGFnID09PSAiI3RleHQiKSB7CiAgICAgICAgICAgICAgICBpZiAoL1xTLy50ZXN0KGNoaWxkVGV4dCkpIHsKICAgICAgICAgICAgICAgICAgdGFnRGlzcGxheU5hbWUgPSAiVGV4dCBub2RlcyI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0YWdEaXNwbGF5TmFtZSA9ICJXaGl0ZXNwYWNlIHRleHQgbm9kZXMiOwogICAgICAgICAgICAgICAgICB3aGl0ZXNwYWNlSW5mbyA9ICIgTWFrZSBzdXJlIHlvdSBkb24ndCBoYXZlIGFueSBleHRyYSB3aGl0ZXNwYWNlIGJldHdlZW4gdGFncyBvbiBlYWNoIGxpbmUgb2YgeW91ciBzb3VyY2UgY29kZS4iOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0YWdEaXNwbGF5TmFtZSA9ICI8IiArIGNoaWxkVGFnICsgIj4iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaW52YWxpZFBhcmVudCkgewogICAgICAgICAgICAgICAgdmFyIGluZm8gPSAiIjsKICAgICAgICAgICAgICAgIGlmIChhbmNlc3RvclRhZyA9PT0gInRhYmxlIiAmJiBjaGlsZFRhZyA9PT0gInRyIikgewogICAgICAgICAgICAgICAgICBpbmZvICs9ICIgQWRkIGEgPHRib2R5PiwgPHRoZWFkPiBvciA8dGZvb3Q+IHRvIHlvdXIgY29kZSB0byBtYXRjaCB0aGUgRE9NIHRyZWUgZ2VuZXJhdGVkIGJ5IHRoZSBicm93c2VyLiI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlcnJvcigidmFsaWRhdGVET01OZXN0aW5nKC4uLik6ICVzIGNhbm5vdCBhcHBlYXIgYXMgYSBjaGlsZCBvZiA8JXM+LiVzJXMiLCB0YWdEaXNwbGF5TmFtZSwgYW5jZXN0b3JUYWcsIHdoaXRlc3BhY2VJbmZvLCBpbmZvKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZXJyb3IoInZhbGlkYXRlRE9NTmVzdGluZyguLi4pOiAlcyBjYW5ub3QgYXBwZWFyIGFzIGEgZGVzY2VuZGFudCBvZiA8JXM+LiIsIHRhZ0Rpc3BsYXlOYW1lLCBhbmNlc3RvclRhZyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgdmFyIFNVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HJDEgPSAic3VwcHJlc3NIeWRyYXRpb25XYXJuaW5nIjsKICAgICAgICAgIHZhciBTVVNQRU5TRV9TVEFSVF9EQVRBID0gIiQiOwogICAgICAgICAgdmFyIFNVU1BFTlNFX0VORF9EQVRBID0gIi8kIjsKICAgICAgICAgIHZhciBTVVNQRU5TRV9QRU5ESU5HX1NUQVJUX0RBVEEgPSAiJD8iOwogICAgICAgICAgdmFyIFNVU1BFTlNFX0ZBTExCQUNLX1NUQVJUX0RBVEEgPSAiJCEiOwogICAgICAgICAgdmFyIFNUWUxFJDEgPSAic3R5bGUiOwogICAgICAgICAgdmFyIGV2ZW50c0VuYWJsZWQgPSBudWxsOwogICAgICAgICAgdmFyIHNlbGVjdGlvbkluZm9ybWF0aW9uID0gbnVsbDsKICAgICAgICAgIGZ1bmN0aW9uIGdldFJvb3RIb3N0Q29udGV4dChyb290Q29udGFpbmVySW5zdGFuY2UpIHsKICAgICAgICAgICAgdmFyIHR5cGUyOwogICAgICAgICAgICB2YXIgbmFtZXNwYWNlOwogICAgICAgICAgICB2YXIgbm9kZVR5cGUgPSByb290Q29udGFpbmVySW5zdGFuY2Uubm9kZVR5cGU7CiAgICAgICAgICAgIHN3aXRjaCAobm9kZVR5cGUpIHsKICAgICAgICAgICAgICBjYXNlIERPQ1VNRU5UX05PREU6CiAgICAgICAgICAgICAgY2FzZSBET0NVTUVOVF9GUkFHTUVOVF9OT0RFOiB7CiAgICAgICAgICAgICAgICB0eXBlMiA9IG5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFID8gIiNkb2N1bWVudCIgOiAiI2ZyYWdtZW50IjsKICAgICAgICAgICAgICAgIHZhciByb290MyA9IHJvb3RDb250YWluZXJJbnN0YW5jZS5kb2N1bWVudEVsZW1lbnQ7CiAgICAgICAgICAgICAgICBuYW1lc3BhY2UgPSByb290MyA/IHJvb3QzLm5hbWVzcGFjZVVSSSA6IGdldENoaWxkTmFtZXNwYWNlKG51bGwsICIiKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICAgICAgICB2YXIgY29udGFpbmVyID0gbm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSA/IHJvb3RDb250YWluZXJJbnN0YW5jZS5wYXJlbnROb2RlIDogcm9vdENvbnRhaW5lckluc3RhbmNlOwogICAgICAgICAgICAgICAgdmFyIG93bk5hbWVzcGFjZSA9IGNvbnRhaW5lci5uYW1lc3BhY2VVUkkgfHwgbnVsbDsKICAgICAgICAgICAgICAgIHR5cGUyID0gY29udGFpbmVyLnRhZ05hbWU7CiAgICAgICAgICAgICAgICBuYW1lc3BhY2UgPSBnZXRDaGlsZE5hbWVzcGFjZShvd25OYW1lc3BhY2UsIHR5cGUyKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIHZhbGlkYXRlZFRhZyA9IHR5cGUyLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgdmFyIGFuY2VzdG9ySW5mbyA9IHVwZGF0ZWRBbmNlc3RvckluZm8obnVsbCwgdmFsaWRhdGVkVGFnKTsKICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgbmFtZXNwYWNlLAogICAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0Q2hpbGRIb3N0Q29udGV4dChwYXJlbnRIb3N0Q29udGV4dCwgdHlwZTIsIHJvb3RDb250YWluZXJJbnN0YW5jZSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIHBhcmVudEhvc3RDb250ZXh0RGV2ID0gcGFyZW50SG9zdENvbnRleHQ7CiAgICAgICAgICAgICAgdmFyIG5hbWVzcGFjZSA9IGdldENoaWxkTmFtZXNwYWNlKHBhcmVudEhvc3RDb250ZXh0RGV2Lm5hbWVzcGFjZSwgdHlwZTIpOwogICAgICAgICAgICAgIHZhciBhbmNlc3RvckluZm8gPSB1cGRhdGVkQW5jZXN0b3JJbmZvKHBhcmVudEhvc3RDb250ZXh0RGV2LmFuY2VzdG9ySW5mbywgdHlwZTIpOwogICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBuYW1lc3BhY2UsCiAgICAgICAgICAgICAgICBhbmNlc3RvckluZm8KICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRQdWJsaWNJbnN0YW5jZShpbnN0YW5jZSkgewogICAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwcmVwYXJlRm9yQ29tbWl0KGNvbnRhaW5lckluZm8pIHsKICAgICAgICAgICAgZXZlbnRzRW5hYmxlZCA9IGlzRW5hYmxlZCgpOwogICAgICAgICAgICBzZWxlY3Rpb25JbmZvcm1hdGlvbiA9IGdldFNlbGVjdGlvbkluZm9ybWF0aW9uKCk7CiAgICAgICAgICAgIHZhciBhY3RpdmVJbnN0YW5jZSA9IG51bGw7CiAgICAgICAgICAgIHNldEVuYWJsZWQoZmFsc2UpOwogICAgICAgICAgICByZXR1cm4gYWN0aXZlSW5zdGFuY2U7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZXNldEFmdGVyQ29tbWl0KGNvbnRhaW5lckluZm8pIHsKICAgICAgICAgICAgcmVzdG9yZVNlbGVjdGlvbihzZWxlY3Rpb25JbmZvcm1hdGlvbik7CiAgICAgICAgICAgIHNldEVuYWJsZWQoZXZlbnRzRW5hYmxlZCk7CiAgICAgICAgICAgIGV2ZW50c0VuYWJsZWQgPSBudWxsOwogICAgICAgICAgICBzZWxlY3Rpb25JbmZvcm1hdGlvbiA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVJbnN0YW5jZSh0eXBlMiwgcHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgaG9zdENvbnRleHQsIGludGVybmFsSW5zdGFuY2VIYW5kbGUpIHsKICAgICAgICAgICAgdmFyIHBhcmVudE5hbWVzcGFjZTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBob3N0Q29udGV4dERldiA9IGhvc3RDb250ZXh0OwogICAgICAgICAgICAgIHZhbGlkYXRlRE9NTmVzdGluZyh0eXBlMiwgbnVsbCwgaG9zdENvbnRleHREZXYuYW5jZXN0b3JJbmZvKTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHByb3BzLmNoaWxkcmVuID09PSAic3RyaW5nIiB8fCB0eXBlb2YgcHJvcHMuY2hpbGRyZW4gPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICB2YXIgc3RyaW5nID0gIiIgKyBwcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICAgIHZhciBvd25BbmNlc3RvckluZm8gPSB1cGRhdGVkQW5jZXN0b3JJbmZvKGhvc3RDb250ZXh0RGV2LmFuY2VzdG9ySW5mbywgdHlwZTIpOwogICAgICAgICAgICAgICAgdmFsaWRhdGVET01OZXN0aW5nKG51bGwsIHN0cmluZywgb3duQW5jZXN0b3JJbmZvKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcGFyZW50TmFtZXNwYWNlID0gaG9zdENvbnRleHREZXYubmFtZXNwYWNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkb21FbGVtZW50ID0gY3JlYXRlRWxlbWVudCh0eXBlMiwgcHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgcGFyZW50TmFtZXNwYWNlKTsKICAgICAgICAgICAgcHJlY2FjaGVGaWJlck5vZGUoaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgIHVwZGF0ZUZpYmVyUHJvcHMoZG9tRWxlbWVudCwgcHJvcHMpOwogICAgICAgICAgICByZXR1cm4gZG9tRWxlbWVudDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGFwcGVuZEluaXRpYWxDaGlsZChwYXJlbnRJbnN0YW5jZSwgY2hpbGQpIHsKICAgICAgICAgICAgcGFyZW50SW5zdGFuY2UuYXBwZW5kQ2hpbGQoY2hpbGQpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZmluYWxpemVJbml0aWFsQ2hpbGRyZW4oZG9tRWxlbWVudCwgdHlwZTIsIHByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0KSB7CiAgICAgICAgICAgIHNldEluaXRpYWxQcm9wZXJ0aWVzKGRvbUVsZW1lbnQsIHR5cGUyLCBwcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlKTsKICAgICAgICAgICAgc3dpdGNoICh0eXBlMikgewogICAgICAgICAgICAgIGNhc2UgImJ1dHRvbiI6CiAgICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgICAgcmV0dXJuICEhcHJvcHMuYXV0b0ZvY3VzOwogICAgICAgICAgICAgIGNhc2UgImltZyI6CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwcmVwYXJlVXBkYXRlKGRvbUVsZW1lbnQsIHR5cGUyLCBvbGRQcm9wcywgbmV3UHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgaG9zdENvbnRleHQpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBob3N0Q29udGV4dERldiA9IGhvc3RDb250ZXh0OwogICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3UHJvcHMuY2hpbGRyZW4gIT09IHR5cGVvZiBvbGRQcm9wcy5jaGlsZHJlbiAmJiAodHlwZW9mIG5ld1Byb3BzLmNoaWxkcmVuID09PSAic3RyaW5nIiB8fCB0eXBlb2YgbmV3UHJvcHMuY2hpbGRyZW4gPT09ICJudW1iZXIiKSkgewogICAgICAgICAgICAgICAgdmFyIHN0cmluZyA9ICIiICsgbmV3UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgICAgICB2YXIgb3duQW5jZXN0b3JJbmZvID0gdXBkYXRlZEFuY2VzdG9ySW5mbyhob3N0Q29udGV4dERldi5hbmNlc3RvckluZm8sIHR5cGUyKTsKICAgICAgICAgICAgICAgIHZhbGlkYXRlRE9NTmVzdGluZyhudWxsLCBzdHJpbmcsIG93bkFuY2VzdG9ySW5mbyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBkaWZmUHJvcGVydGllcyhkb21FbGVtZW50LCB0eXBlMiwgb2xkUHJvcHMsIG5ld1Byb3BzKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHNob3VsZFNldFRleHRDb250ZW50KHR5cGUyLCBwcm9wcykgewogICAgICAgICAgICByZXR1cm4gdHlwZTIgPT09ICJ0ZXh0YXJlYSIgfHwgdHlwZTIgPT09ICJub3NjcmlwdCIgfHwgdHlwZW9mIHByb3BzLmNoaWxkcmVuID09PSAic3RyaW5nIiB8fCB0eXBlb2YgcHJvcHMuY2hpbGRyZW4gPT09ICJudW1iZXIiIHx8IHR5cGVvZiBwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCA9PT0gIm9iamVjdCIgJiYgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT09IG51bGwgJiYgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwuX19odG1sICE9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVUZXh0SW5zdGFuY2UodGV4dCwgcm9vdENvbnRhaW5lckluc3RhbmNlLCBob3N0Q29udGV4dCwgaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIGhvc3RDb250ZXh0RGV2ID0gaG9zdENvbnRleHQ7CiAgICAgICAgICAgICAgdmFsaWRhdGVET01OZXN0aW5nKG51bGwsIHRleHQsIGhvc3RDb250ZXh0RGV2LmFuY2VzdG9ySW5mbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRleHROb2RlID0gY3JlYXRlVGV4dE5vZGUodGV4dCwgcm9vdENvbnRhaW5lckluc3RhbmNlKTsKICAgICAgICAgICAgcHJlY2FjaGVGaWJlck5vZGUoaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSwgdGV4dE5vZGUpOwogICAgICAgICAgICByZXR1cm4gdGV4dE5vZGU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50RXZlbnRQcmlvcml0eSgpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRFdmVudCA9IHdpbmRvdy5ldmVudDsKICAgICAgICAgICAgaWYgKGN1cnJlbnRFdmVudCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIERlZmF1bHRFdmVudFByaW9yaXR5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBnZXRFdmVudFByaW9yaXR5KGN1cnJlbnRFdmVudC50eXBlKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzY2hlZHVsZVRpbWVvdXQgPSB0eXBlb2Ygc2V0VGltZW91dCA9PT0gImZ1bmN0aW9uIiA/IHNldFRpbWVvdXQgOiB2b2lkIDA7CiAgICAgICAgICB2YXIgY2FuY2VsVGltZW91dCA9IHR5cGVvZiBjbGVhclRpbWVvdXQgPT09ICJmdW5jdGlvbiIgPyBjbGVhclRpbWVvdXQgOiB2b2lkIDA7CiAgICAgICAgICB2YXIgbm9UaW1lb3V0ID0gLTE7CiAgICAgICAgICB2YXIgbG9jYWxQcm9taXNlID0gdHlwZW9mIFByb21pc2UgPT09ICJmdW5jdGlvbiIgPyBQcm9taXNlIDogdm9pZCAwOwogICAgICAgICAgdmFyIHNjaGVkdWxlTWljcm90YXNrID0gdHlwZW9mIHF1ZXVlTWljcm90YXNrID09PSAiZnVuY3Rpb24iID8gcXVldWVNaWNyb3Rhc2sgOiB0eXBlb2YgbG9jYWxQcm9taXNlICE9PSAidW5kZWZpbmVkIiA/IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHJldHVybiBsb2NhbFByb21pc2UucmVzb2x2ZShudWxsKS50aGVuKGNhbGxiYWNrKS5jYXRjaChoYW5kbGVFcnJvckluTmV4dFRpY2spOwogICAgICAgICAgfSA6IHNjaGVkdWxlVGltZW91dDsKICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZUVycm9ySW5OZXh0VGljayhlcnJvcjIpIHsKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY29tbWl0TW91bnQoZG9tRWxlbWVudCwgdHlwZTIsIG5ld1Byb3BzLCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlKSB7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZTIpIHsKICAgICAgICAgICAgICBjYXNlICJidXR0b24iOgogICAgICAgICAgICAgIGNhc2UgImlucHV0IjoKICAgICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICAgIGlmIChuZXdQcm9wcy5hdXRvRm9jdXMpIHsKICAgICAgICAgICAgICAgICAgZG9tRWxlbWVudC5mb2N1cygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIGNhc2UgImltZyI6IHsKICAgICAgICAgICAgICAgIGlmIChuZXdQcm9wcy5zcmMpIHsKICAgICAgICAgICAgICAgICAgZG9tRWxlbWVudC5zcmMgPSBuZXdQcm9wcy5zcmM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjb21taXRVcGRhdGUoZG9tRWxlbWVudCwgdXBkYXRlUGF5bG9hZCwgdHlwZTIsIG9sZFByb3BzLCBuZXdQcm9wcywgaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSkgewogICAgICAgICAgICB1cGRhdGVQcm9wZXJ0aWVzKGRvbUVsZW1lbnQsIHVwZGF0ZVBheWxvYWQsIHR5cGUyLCBvbGRQcm9wcywgbmV3UHJvcHMpOwogICAgICAgICAgICB1cGRhdGVGaWJlclByb3BzKGRvbUVsZW1lbnQsIG5ld1Byb3BzKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlc2V0VGV4dENvbnRlbnQoZG9tRWxlbWVudCkgewogICAgICAgICAgICBzZXRUZXh0Q29udGVudChkb21FbGVtZW50LCAiIik7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjb21taXRUZXh0VXBkYXRlKHRleHRJbnN0YW5jZSwgb2xkVGV4dCwgbmV3VGV4dCkgewogICAgICAgICAgICB0ZXh0SW5zdGFuY2Uubm9kZVZhbHVlID0gbmV3VGV4dDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGFwcGVuZENoaWxkKHBhcmVudEluc3RhbmNlLCBjaGlsZCkgewogICAgICAgICAgICBwYXJlbnRJbnN0YW5jZS5hcHBlbmRDaGlsZChjaGlsZCk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBhcHBlbmRDaGlsZFRvQ29udGFpbmVyKGNvbnRhaW5lciwgY2hpbGQpIHsKICAgICAgICAgICAgdmFyIHBhcmVudE5vZGU7CiAgICAgICAgICAgIGlmIChjb250YWluZXIubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHBhcmVudE5vZGUgPSBjb250YWluZXIucGFyZW50Tm9kZTsKICAgICAgICAgICAgICBwYXJlbnROb2RlLmluc2VydEJlZm9yZShjaGlsZCwgY29udGFpbmVyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwYXJlbnROb2RlID0gY29udGFpbmVyOwogICAgICAgICAgICAgIHBhcmVudE5vZGUuYXBwZW5kQ2hpbGQoY2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByZWFjdFJvb3RDb250YWluZXIgPSBjb250YWluZXIuX3JlYWN0Um9vdENvbnRhaW5lcjsKICAgICAgICAgICAgaWYgKChyZWFjdFJvb3RDb250YWluZXIgPT09IG51bGwgfHwgcmVhY3RSb290Q29udGFpbmVyID09PSB2b2lkIDApICYmIHBhcmVudE5vZGUub25jbGljayA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRyYXBDbGlja09uTm9uSW50ZXJhY3RpdmVFbGVtZW50KHBhcmVudE5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpbnNlcnRCZWZvcmUocGFyZW50SW5zdGFuY2UsIGNoaWxkLCBiZWZvcmVDaGlsZCkgewogICAgICAgICAgICBwYXJlbnRJbnN0YW5jZS5pbnNlcnRCZWZvcmUoY2hpbGQsIGJlZm9yZUNoaWxkKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGluc2VydEluQ29udGFpbmVyQmVmb3JlKGNvbnRhaW5lciwgY2hpbGQsIGJlZm9yZUNoaWxkKSB7CiAgICAgICAgICAgIGlmIChjb250YWluZXIubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIGNvbnRhaW5lci5wYXJlbnROb2RlLmluc2VydEJlZm9yZShjaGlsZCwgYmVmb3JlQ2hpbGQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNvbnRhaW5lci5pbnNlcnRCZWZvcmUoY2hpbGQsIGJlZm9yZUNoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVtb3ZlQ2hpbGQocGFyZW50SW5zdGFuY2UsIGNoaWxkKSB7CiAgICAgICAgICAgIHBhcmVudEluc3RhbmNlLnJlbW92ZUNoaWxkKGNoaWxkKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlbW92ZUNoaWxkRnJvbUNvbnRhaW5lcihjb250YWluZXIsIGNoaWxkKSB7CiAgICAgICAgICAgIGlmIChjb250YWluZXIubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIGNvbnRhaW5lci5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGNoaWxkKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb250YWluZXIucmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjbGVhclN1c3BlbnNlQm91bmRhcnkocGFyZW50SW5zdGFuY2UsIHN1c3BlbnNlSW5zdGFuY2UpIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSBzdXNwZW5zZUluc3RhbmNlOwogICAgICAgICAgICB2YXIgZGVwdGggPSAwOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgdmFyIG5leHROb2RlID0gbm9kZS5uZXh0U2libGluZzsKICAgICAgICAgICAgICBwYXJlbnRJbnN0YW5jZS5yZW1vdmVDaGlsZChub2RlKTsKICAgICAgICAgICAgICBpZiAobmV4dE5vZGUgJiYgbmV4dE5vZGUubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgICAgdmFyIGRhdGEgPSBuZXh0Tm9kZS5kYXRhOwogICAgICAgICAgICAgICAgaWYgKGRhdGEgPT09IFNVU1BFTlNFX0VORF9EQVRBKSB7CiAgICAgICAgICAgICAgICAgIGlmIChkZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIHBhcmVudEluc3RhbmNlLnJlbW92ZUNoaWxkKG5leHROb2RlKTsKICAgICAgICAgICAgICAgICAgICByZXRyeUlmQmxvY2tlZE9uKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBkZXB0aC0tOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRhdGEgPT09IFNVU1BFTlNFX1NUQVJUX0RBVEEgfHwgZGF0YSA9PT0gU1VTUEVOU0VfUEVORElOR19TVEFSVF9EQVRBIHx8IGRhdGEgPT09IFNVU1BFTlNFX0ZBTExCQUNLX1NUQVJUX0RBVEEpIHsKICAgICAgICAgICAgICAgICAgZGVwdGgrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IG5leHROb2RlOwogICAgICAgICAgICB9IHdoaWxlIChub2RlKTsKICAgICAgICAgICAgcmV0cnlJZkJsb2NrZWRPbihzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNsZWFyU3VzcGVuc2VCb3VuZGFyeUZyb21Db250YWluZXIoY29udGFpbmVyLCBzdXNwZW5zZUluc3RhbmNlKSB7CiAgICAgICAgICAgIGlmIChjb250YWluZXIubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIGNsZWFyU3VzcGVuc2VCb3VuZGFyeShjb250YWluZXIucGFyZW50Tm9kZSwgc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY29udGFpbmVyLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgICBjbGVhclN1c3BlbnNlQm91bmRhcnkoY29udGFpbmVyLCBzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXRyeUlmQmxvY2tlZE9uKGNvbnRhaW5lcik7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBoaWRlSW5zdGFuY2UoaW5zdGFuY2UpIHsKICAgICAgICAgICAgaW5zdGFuY2UgPSBpbnN0YW5jZTsKICAgICAgICAgICAgdmFyIHN0eWxlMiA9IGluc3RhbmNlLnN0eWxlOwogICAgICAgICAgICBpZiAodHlwZW9mIHN0eWxlMi5zZXRQcm9wZXJ0eSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHN0eWxlMi5zZXRQcm9wZXJ0eSgiZGlzcGxheSIsICJub25lIiwgImltcG9ydGFudCIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0eWxlMi5kaXNwbGF5ID0gIm5vbmUiOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBoaWRlVGV4dEluc3RhbmNlKHRleHRJbnN0YW5jZSkgewogICAgICAgICAgICB0ZXh0SW5zdGFuY2Uubm9kZVZhbHVlID0gIiI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1bmhpZGVJbnN0YW5jZShpbnN0YW5jZSwgcHJvcHMpIHsKICAgICAgICAgICAgaW5zdGFuY2UgPSBpbnN0YW5jZTsKICAgICAgICAgICAgdmFyIHN0eWxlUHJvcCA9IHByb3BzW1NUWUxFJDFdOwogICAgICAgICAgICB2YXIgZGlzcGxheSA9IHN0eWxlUHJvcCAhPT0gdm9pZCAwICYmIHN0eWxlUHJvcCAhPT0gbnVsbCAmJiBzdHlsZVByb3AuaGFzT3duUHJvcGVydHkoImRpc3BsYXkiKSA/IHN0eWxlUHJvcC5kaXNwbGF5IDogbnVsbDsKICAgICAgICAgICAgaW5zdGFuY2Uuc3R5bGUuZGlzcGxheSA9IGRhbmdlcm91c1N0eWxlVmFsdWUoImRpc3BsYXkiLCBkaXNwbGF5KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVuaGlkZVRleHRJbnN0YW5jZSh0ZXh0SW5zdGFuY2UsIHRleHQpIHsKICAgICAgICAgICAgdGV4dEluc3RhbmNlLm5vZGVWYWx1ZSA9IHRleHQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjbGVhckNvbnRhaW5lcihjb250YWluZXIpIHsKICAgICAgICAgICAgaWYgKGNvbnRhaW5lci5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgY29udGFpbmVyLnRleHRDb250ZW50ID0gIiI7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY29udGFpbmVyLm5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgaWYgKGNvbnRhaW5lci5kb2N1bWVudEVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIGNvbnRhaW5lci5yZW1vdmVDaGlsZChjb250YWluZXIuZG9jdW1lbnRFbGVtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNhbkh5ZHJhdGVJbnN0YW5jZShpbnN0YW5jZSwgdHlwZTIsIHByb3BzKSB7CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSAhPT0gRUxFTUVOVF9OT0RFIHx8IHR5cGUyLnRvTG93ZXJDYXNlKCkgIT09IGluc3RhbmNlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjYW5IeWRyYXRlVGV4dEluc3RhbmNlKGluc3RhbmNlLCB0ZXh0KSB7CiAgICAgICAgICAgIGlmICh0ZXh0ID09PSAiIiB8fCBpbnN0YW5jZS5ub2RlVHlwZSAhPT0gVEVYVF9OT0RFKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY2FuSHlkcmF0ZVN1c3BlbnNlSW5zdGFuY2UoaW5zdGFuY2UpIHsKICAgICAgICAgICAgaWYgKGluc3RhbmNlLm5vZGVUeXBlICE9PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpc1N1c3BlbnNlSW5zdGFuY2VQZW5kaW5nKGluc3RhbmNlKSB7CiAgICAgICAgICAgIHJldHVybiBpbnN0YW5jZS5kYXRhID09PSBTVVNQRU5TRV9QRU5ESU5HX1NUQVJUX0RBVEE7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpc1N1c3BlbnNlSW5zdGFuY2VGYWxsYmFjayhpbnN0YW5jZSkgewogICAgICAgICAgICByZXR1cm4gaW5zdGFuY2UuZGF0YSA9PT0gU1VTUEVOU0VfRkFMTEJBQ0tfU1RBUlRfREFUQTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldFN1c3BlbnNlSW5zdGFuY2VGYWxsYmFja0Vycm9yRGV0YWlscyhpbnN0YW5jZSkgewogICAgICAgICAgICB2YXIgZGF0YXNldCA9IGluc3RhbmNlLm5leHRTaWJsaW5nICYmIGluc3RhbmNlLm5leHRTaWJsaW5nLmRhdGFzZXQ7CiAgICAgICAgICAgIHZhciBkaWdlc3QsIG1lc3NhZ2UsIHN0YWNrOwogICAgICAgICAgICBpZiAoZGF0YXNldCkgewogICAgICAgICAgICAgIGRpZ2VzdCA9IGRhdGFzZXQuZGdzdDsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBtZXNzYWdlID0gZGF0YXNldC5tc2c7CiAgICAgICAgICAgICAgICBzdGFjayA9IGRhdGFzZXQuc3RjazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBtZXNzYWdlLAogICAgICAgICAgICAgICAgZGlnZXN0LAogICAgICAgICAgICAgICAgc3RhY2sKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZWdpc3RlclN1c3BlbnNlSW5zdGFuY2VSZXRyeShpbnN0YW5jZSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgaW5zdGFuY2UuX3JlYWN0UmV0cnkgPSBjYWxsYmFjazsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldE5leHRIeWRyYXRhYmxlKG5vZGUpIHsKICAgICAgICAgICAgZm9yICg7IG5vZGUgIT0gbnVsbDsgbm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpIHsKICAgICAgICAgICAgICB2YXIgbm9kZVR5cGUgPSBub2RlLm5vZGVUeXBlOwogICAgICAgICAgICAgIGlmIChub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFIHx8IG5vZGVUeXBlID09PSBURVhUX05PREUpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgICAgdmFyIG5vZGVEYXRhID0gbm9kZS5kYXRhOwogICAgICAgICAgICAgICAgaWYgKG5vZGVEYXRhID09PSBTVVNQRU5TRV9TVEFSVF9EQVRBIHx8IG5vZGVEYXRhID09PSBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBIHx8IG5vZGVEYXRhID09PSBTVVNQRU5TRV9QRU5ESU5HX1NUQVJUX0RBVEEpIHsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAobm9kZURhdGEgPT09IFNVU1BFTlNFX0VORF9EQVRBKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldE5leHRIeWRyYXRhYmxlU2libGluZyhpbnN0YW5jZSkgewogICAgICAgICAgICByZXR1cm4gZ2V0TmV4dEh5ZHJhdGFibGUoaW5zdGFuY2UubmV4dFNpYmxpbmcpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0Rmlyc3RIeWRyYXRhYmxlQ2hpbGQocGFyZW50SW5zdGFuY2UpIHsKICAgICAgICAgICAgcmV0dXJuIGdldE5leHRIeWRyYXRhYmxlKHBhcmVudEluc3RhbmNlLmZpcnN0Q2hpbGQpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0Rmlyc3RIeWRyYXRhYmxlQ2hpbGRXaXRoaW5Db250YWluZXIocGFyZW50Q29udGFpbmVyKSB7CiAgICAgICAgICAgIHJldHVybiBnZXROZXh0SHlkcmF0YWJsZShwYXJlbnRDb250YWluZXIuZmlyc3RDaGlsZCk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRGaXJzdEh5ZHJhdGFibGVDaGlsZFdpdGhpblN1c3BlbnNlSW5zdGFuY2UocGFyZW50SW5zdGFuY2UpIHsKICAgICAgICAgICAgcmV0dXJuIGdldE5leHRIeWRyYXRhYmxlKHBhcmVudEluc3RhbmNlLm5leHRTaWJsaW5nKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGh5ZHJhdGVJbnN0YW5jZShpbnN0YW5jZSwgdHlwZTIsIHByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0LCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCBzaG91bGRXYXJuRGV2KSB7CiAgICAgICAgICAgIHByZWNhY2hlRmliZXJOb2RlKGludGVybmFsSW5zdGFuY2VIYW5kbGUsIGluc3RhbmNlKTsKICAgICAgICAgICAgdXBkYXRlRmliZXJQcm9wcyhpbnN0YW5jZSwgcHJvcHMpOwogICAgICAgICAgICB2YXIgcGFyZW50TmFtZXNwYWNlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIGhvc3RDb250ZXh0RGV2ID0gaG9zdENvbnRleHQ7CiAgICAgICAgICAgICAgcGFyZW50TmFtZXNwYWNlID0gaG9zdENvbnRleHREZXYubmFtZXNwYWNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpc0NvbmN1cnJlbnRNb2RlID0gKGludGVybmFsSW5zdGFuY2VIYW5kbGUubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlOwogICAgICAgICAgICByZXR1cm4gZGlmZkh5ZHJhdGVkUHJvcGVydGllcyhpbnN0YW5jZSwgdHlwZTIsIHByb3BzLCBwYXJlbnROYW1lc3BhY2UsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgaXNDb25jdXJyZW50TW9kZSwgc2hvdWxkV2FybkRldik7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBoeWRyYXRlVGV4dEluc3RhbmNlKHRleHRJbnN0YW5jZSwgdGV4dCwgaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSwgc2hvdWxkV2FybkRldikgewogICAgICAgICAgICBwcmVjYWNoZUZpYmVyTm9kZShpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCB0ZXh0SW5zdGFuY2UpOwogICAgICAgICAgICB2YXIgaXNDb25jdXJyZW50TW9kZSA9IChpbnRlcm5hbEluc3RhbmNlSGFuZGxlLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgICAgcmV0dXJuIGRpZmZIeWRyYXRlZFRleHQodGV4dEluc3RhbmNlLCB0ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGh5ZHJhdGVTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UsIGludGVybmFsSW5zdGFuY2VIYW5kbGUpIHsKICAgICAgICAgICAgcHJlY2FjaGVGaWJlck5vZGUoaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSwgc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXROZXh0SHlkcmF0YWJsZUluc3RhbmNlQWZ0ZXJTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UpIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSBzdXNwZW5zZUluc3RhbmNlLm5leHRTaWJsaW5nOwogICAgICAgICAgICB2YXIgZGVwdGggPSAwOwogICAgICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgICAgIHZhciBkYXRhID0gbm9kZS5kYXRhOwogICAgICAgICAgICAgICAgaWYgKGRhdGEgPT09IFNVU1BFTlNFX0VORF9EQVRBKSB7CiAgICAgICAgICAgICAgICAgIGlmIChkZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXROZXh0SHlkcmF0YWJsZVNpYmxpbmcobm9kZSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZGVwdGgtLTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhID09PSBTVVNQRU5TRV9TVEFSVF9EQVRBIHx8IGRhdGEgPT09IFNVU1BFTlNFX0ZBTExCQUNLX1NUQVJUX0RBVEEgfHwgZGF0YSA9PT0gU1VTUEVOU0VfUEVORElOR19TVEFSVF9EQVRBKSB7CiAgICAgICAgICAgICAgICAgIGRlcHRoKys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBub2RlLm5leHRTaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0UGFyZW50U3VzcGVuc2VJbnN0YW5jZSh0YXJnZXRJbnN0YW5jZSkgewogICAgICAgICAgICB2YXIgbm9kZSA9IHRhcmdldEluc3RhbmNlLnByZXZpb3VzU2libGluZzsKICAgICAgICAgICAgdmFyIGRlcHRoID0gMDsKICAgICAgICAgICAgd2hpbGUgKG5vZGUpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IG5vZGUuZGF0YTsKICAgICAgICAgICAgICAgIGlmIChkYXRhID09PSBTVVNQRU5TRV9TVEFSVF9EQVRBIHx8IGRhdGEgPT09IFNVU1BFTlNFX0ZBTExCQUNLX1NUQVJUX0RBVEEgfHwgZGF0YSA9PT0gU1VTUEVOU0VfUEVORElOR19TVEFSVF9EQVRBKSB7CiAgICAgICAgICAgICAgICAgIGlmIChkZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGRlcHRoLS07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGF0YSA9PT0gU1VTUEVOU0VfRU5EX0RBVEEpIHsKICAgICAgICAgICAgICAgICAgZGVwdGgrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY29tbWl0SHlkcmF0ZWRDb250YWluZXIoY29udGFpbmVyKSB7CiAgICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oY29udGFpbmVyKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNvbW1pdEh5ZHJhdGVkU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKSB7CiAgICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzaG91bGREZWxldGVVbmh5ZHJhdGVkVGFpbEluc3RhbmNlcyhwYXJlbnRUeXBlKSB7CiAgICAgICAgICAgIHJldHVybiBwYXJlbnRUeXBlICE9PSAiaGVhZCIgJiYgcGFyZW50VHlwZSAhPT0gImJvZHkiOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZGlkTm90TWF0Y2hIeWRyYXRlZENvbnRhaW5lclRleHRJbnN0YW5jZShwYXJlbnRDb250YWluZXIsIHRleHRJbnN0YW5jZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgICB2YXIgc2hvdWxkV2FybkRldiA9IHRydWU7CiAgICAgICAgICAgIGNoZWNrRm9yVW5tYXRjaGVkVGV4dCh0ZXh0SW5zdGFuY2Uubm9kZVZhbHVlLCB0ZXh0LCBpc0NvbmN1cnJlbnRNb2RlLCBzaG91bGRXYXJuRGV2KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGRpZE5vdE1hdGNoSHlkcmF0ZWRUZXh0SW5zdGFuY2UocGFyZW50VHlwZSwgcGFyZW50UHJvcHMsIHBhcmVudEluc3RhbmNlLCB0ZXh0SW5zdGFuY2UsIHRleHQsIGlzQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgICAgaWYgKHBhcmVudFByb3BzW1NVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HJDFdICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgdmFyIHNob3VsZFdhcm5EZXYgPSB0cnVlOwogICAgICAgICAgICAgIGNoZWNrRm9yVW5tYXRjaGVkVGV4dCh0ZXh0SW5zdGFuY2Uubm9kZVZhbHVlLCB0ZXh0LCBpc0NvbmN1cnJlbnRNb2RlLCBzaG91bGRXYXJuRGV2KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZGlkTm90SHlkcmF0ZUluc3RhbmNlV2l0aGluQ29udGFpbmVyKHBhcmVudENvbnRhaW5lciwgaW5zdGFuY2UpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVFbGVtZW50KHBhcmVudENvbnRhaW5lciwgaW5zdGFuY2UpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkKICAgICAgICAgICAgICAgIDsKICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHdhcm5Gb3JEZWxldGVkSHlkcmF0YWJsZVRleHQocGFyZW50Q29udGFpbmVyLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBkaWROb3RIeWRyYXRlSW5zdGFuY2VXaXRoaW5TdXNwZW5zZUluc3RhbmNlKHBhcmVudEluc3RhbmNlLCBpbnN0YW5jZSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBwYXJlbnRJbnN0YW5jZS5wYXJlbnROb2RlOwogICAgICAgICAgICAgIGlmIChwYXJlbnROb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSkgewogICAgICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVFbGVtZW50KHBhcmVudE5vZGUsIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkKICAgICAgICAgICAgICAgICAgOwogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgIHdhcm5Gb3JEZWxldGVkSHlkcmF0YWJsZVRleHQocGFyZW50Tm9kZSwgaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZGlkTm90SHlkcmF0ZUluc3RhbmNlKHBhcmVudFR5cGUsIHBhcmVudFByb3BzLCBwYXJlbnRJbnN0YW5jZSwgaW5zdGFuY2UsIGlzQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpc0NvbmN1cnJlbnRNb2RlIHx8IHBhcmVudFByb3BzW1NVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HJDFdICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSkgewogICAgICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVFbGVtZW50KHBhcmVudEluc3RhbmNlLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGluc3RhbmNlLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpCiAgICAgICAgICAgICAgICAgIDsKICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVUZXh0KHBhcmVudEluc3RhbmNlLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlV2l0aGluQ29udGFpbmVyKHBhcmVudENvbnRhaW5lciwgdHlwZTIsIHByb3BzKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZEVsZW1lbnQocGFyZW50Q29udGFpbmVyLCB0eXBlMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlV2l0aGluQ29udGFpbmVyKHBhcmVudENvbnRhaW5lciwgdGV4dCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgd2FybkZvckluc2VydGVkSHlkcmF0ZWRUZXh0KHBhcmVudENvbnRhaW5lciwgdGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGRpZE5vdEZpbmRIeWRyYXRhYmxlSW5zdGFuY2VXaXRoaW5TdXNwZW5zZUluc3RhbmNlKHBhcmVudEluc3RhbmNlLCB0eXBlMiwgcHJvcHMpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBwYXJlbnROb2RlID0gcGFyZW50SW5zdGFuY2UucGFyZW50Tm9kZTsKICAgICAgICAgICAgICBpZiAocGFyZW50Tm9kZSAhPT0gbnVsbCkKICAgICAgICAgICAgICAgIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkRWxlbWVudChwYXJlbnROb2RlLCB0eXBlMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlV2l0aGluU3VzcGVuc2VJbnN0YW5jZShwYXJlbnRJbnN0YW5jZSwgdGV4dCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBwYXJlbnRJbnN0YW5jZS5wYXJlbnROb2RlOwogICAgICAgICAgICAgIGlmIChwYXJlbnROb2RlICE9PSBudWxsKQogICAgICAgICAgICAgICAgd2FybkZvckluc2VydGVkSHlkcmF0ZWRUZXh0KHBhcmVudE5vZGUsIHRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlKHBhcmVudFR5cGUsIHBhcmVudFByb3BzLCBwYXJlbnRJbnN0YW5jZSwgdHlwZTIsIHByb3BzLCBpc0NvbmN1cnJlbnRNb2RlKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaXNDb25jdXJyZW50TW9kZSB8fCBwYXJlbnRQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklORyQxXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgd2FybkZvckluc2VydGVkSHlkcmF0ZWRFbGVtZW50KHBhcmVudEluc3RhbmNlLCB0eXBlMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZVRleHRJbnN0YW5jZShwYXJlbnRUeXBlLCBwYXJlbnRQcm9wcywgcGFyZW50SW5zdGFuY2UsIHRleHQsIGlzQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpc0NvbmN1cnJlbnRNb2RlIHx8IHBhcmVudFByb3BzW1NVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HJDFdICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZFRleHQocGFyZW50SW5zdGFuY2UsIHRleHQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZXJyb3JIeWRyYXRpbmdDb250YWluZXIocGFyZW50Q29udGFpbmVyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiQW4gZXJyb3Igb2NjdXJyZWQgZHVyaW5nIGh5ZHJhdGlvbi4gVGhlIHNlcnZlciBIVE1MIHdhcyByZXBsYWNlZCB3aXRoIGNsaWVudCBjb250ZW50IGluIDwlcz4uIiwgcGFyZW50Q29udGFpbmVyLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwcmVwYXJlUG9ydGFsTW91bnQocG9ydGFsSW5zdGFuY2UpIHsKICAgICAgICAgICAgbGlzdGVuVG9BbGxTdXBwb3J0ZWRFdmVudHMocG9ydGFsSW5zdGFuY2UpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHJhbmRvbUtleSA9IE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnNsaWNlKDIpOwogICAgICAgICAgdmFyIGludGVybmFsSW5zdGFuY2VLZXkgPSAiX19yZWFjdEZpYmVyJCIgKyByYW5kb21LZXk7CiAgICAgICAgICB2YXIgaW50ZXJuYWxQcm9wc0tleSA9ICJfX3JlYWN0UHJvcHMkIiArIHJhbmRvbUtleTsKICAgICAgICAgIHZhciBpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5ID0gIl9fcmVhY3RDb250YWluZXIkIiArIHJhbmRvbUtleTsKICAgICAgICAgIHZhciBpbnRlcm5hbEV2ZW50SGFuZGxlcnNLZXkgPSAiX19yZWFjdEV2ZW50cyQiICsgcmFuZG9tS2V5OwogICAgICAgICAgdmFyIGludGVybmFsRXZlbnRIYW5kbGVyTGlzdGVuZXJzS2V5ID0gIl9fcmVhY3RMaXN0ZW5lcnMkIiArIHJhbmRvbUtleTsKICAgICAgICAgIHZhciBpbnRlcm5hbEV2ZW50SGFuZGxlc1NldEtleSA9ICJfX3JlYWN0SGFuZGxlcyQiICsgcmFuZG9tS2V5OwogICAgICAgICAgZnVuY3Rpb24gZGV0YWNoRGVsZXRlZEluc3RhbmNlKG5vZGUpIHsKICAgICAgICAgICAgZGVsZXRlIG5vZGVbaW50ZXJuYWxJbnN0YW5jZUtleV07CiAgICAgICAgICAgIGRlbGV0ZSBub2RlW2ludGVybmFsUHJvcHNLZXldOwogICAgICAgICAgICBkZWxldGUgbm9kZVtpbnRlcm5hbEV2ZW50SGFuZGxlcnNLZXldOwogICAgICAgICAgICBkZWxldGUgbm9kZVtpbnRlcm5hbEV2ZW50SGFuZGxlckxpc3RlbmVyc0tleV07CiAgICAgICAgICAgIGRlbGV0ZSBub2RlW2ludGVybmFsRXZlbnRIYW5kbGVzU2V0S2V5XTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHByZWNhY2hlRmliZXJOb2RlKGhvc3RJbnN0LCBub2RlKSB7CiAgICAgICAgICAgIG5vZGVbaW50ZXJuYWxJbnN0YW5jZUtleV0gPSBob3N0SW5zdDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG1hcmtDb250YWluZXJBc1Jvb3QoaG9zdFJvb3QsIG5vZGUpIHsKICAgICAgICAgICAgbm9kZVtpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5XSA9IGhvc3RSb290OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdW5tYXJrQ29udGFpbmVyQXNSb290KG5vZGUpIHsKICAgICAgICAgICAgbm9kZVtpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5XSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpc0NvbnRhaW5lck1hcmtlZEFzUm9vdChub2RlKSB7CiAgICAgICAgICAgIHJldHVybiAhIW5vZGVbaW50ZXJuYWxDb250YWluZXJJbnN0YW5jZUtleV07CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZSh0YXJnZXROb2RlKSB7CiAgICAgICAgICAgIHZhciB0YXJnZXRJbnN0ID0gdGFyZ2V0Tm9kZVtpbnRlcm5hbEluc3RhbmNlS2V5XTsKICAgICAgICAgICAgaWYgKHRhcmdldEluc3QpIHsKICAgICAgICAgICAgICByZXR1cm4gdGFyZ2V0SW5zdDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IHRhcmdldE5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgICAgd2hpbGUgKHBhcmVudE5vZGUpIHsKICAgICAgICAgICAgICB0YXJnZXRJbnN0ID0gcGFyZW50Tm9kZVtpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5XSB8fCBwYXJlbnROb2RlW2ludGVybmFsSW5zdGFuY2VLZXldOwogICAgICAgICAgICAgIGlmICh0YXJnZXRJbnN0KSB7CiAgICAgICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gdGFyZ2V0SW5zdC5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0SW5zdC5jaGlsZCAhPT0gbnVsbCB8fCBhbHRlcm5hdGUgIT09IG51bGwgJiYgYWx0ZXJuYXRlLmNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZUluc3RhbmNlID0gZ2V0UGFyZW50U3VzcGVuc2VJbnN0YW5jZSh0YXJnZXROb2RlKTsKICAgICAgICAgICAgICAgICAgd2hpbGUgKHN1c3BlbnNlSW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0U3VzcGVuc2VJbnN0ID0gc3VzcGVuc2VJbnN0YW5jZVtpbnRlcm5hbEluc3RhbmNlS2V5XTsKICAgICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0U3VzcGVuc2VJbnN0KSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGFyZ2V0U3VzcGVuc2VJbnN0OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzdXNwZW5zZUluc3RhbmNlID0gZ2V0UGFyZW50U3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldEluc3Q7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRhcmdldE5vZGUgPSBwYXJlbnROb2RlOwogICAgICAgICAgICAgIHBhcmVudE5vZGUgPSB0YXJnZXROb2RlLnBhcmVudE5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRJbnN0YW5jZUZyb21Ob2RlKG5vZGUpIHsKICAgICAgICAgICAgdmFyIGluc3QgPSBub2RlW2ludGVybmFsSW5zdGFuY2VLZXldIHx8IG5vZGVbaW50ZXJuYWxDb250YWluZXJJbnN0YW5jZUtleV07CiAgICAgICAgICAgIGlmIChpbnN0KSB7CiAgICAgICAgICAgICAgaWYgKGluc3QudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IGluc3QudGFnID09PSBIb3N0VGV4dCB8fCBpbnN0LnRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQgfHwgaW5zdC50YWcgPT09IEhvc3RSb290KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaW5zdDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0Tm9kZUZyb21JbnN0YW5jZShpbnN0KSB7CiAgICAgICAgICAgIGlmIChpbnN0LnRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCBpbnN0LnRhZyA9PT0gSG9zdFRleHQpIHsKICAgICAgICAgICAgICByZXR1cm4gaW5zdC5zdGF0ZU5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJnZXROb2RlRnJvbUluc3RhbmNlOiBJbnZhbGlkIGFyZ3VtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZShub2RlKSB7CiAgICAgICAgICAgIHJldHVybiBub2RlW2ludGVybmFsUHJvcHNLZXldIHx8IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVGaWJlclByb3BzKG5vZGUsIHByb3BzKSB7CiAgICAgICAgICAgIG5vZGVbaW50ZXJuYWxQcm9wc0tleV0gPSBwcm9wczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldEV2ZW50TGlzdGVuZXJTZXQobm9kZSkgewogICAgICAgICAgICB2YXIgZWxlbWVudExpc3RlbmVyU2V0ID0gbm9kZVtpbnRlcm5hbEV2ZW50SGFuZGxlcnNLZXldOwogICAgICAgICAgICBpZiAoZWxlbWVudExpc3RlbmVyU2V0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICBlbGVtZW50TGlzdGVuZXJTZXQgPSBub2RlW2ludGVybmFsRXZlbnRIYW5kbGVyc0tleV0gPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBlbGVtZW50TGlzdGVuZXJTZXQ7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbG9nZ2VkVHlwZUZhaWx1cmVzID0ge307CiAgICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChlbGVtZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICAgIHZhciBzdGFjayA9IGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihlbGVtZW50LnR5cGUsIGVsZW1lbnQuX3NvdXJjZSwgb3duZXIgPyBvd25lci50eXBlIDogbnVsbCk7CiAgICAgICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEuc2V0RXh0cmFTdGFja0ZyYW1lKHN0YWNrKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxLnNldEV4dHJhU3RhY2tGcmFtZShudWxsKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNoZWNrUHJvcFR5cGVzKHR5cGVTcGVjcywgdmFsdWVzLCBsb2NhdGlvbiwgY29tcG9uZW50TmFtZSwgZWxlbWVudCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIGhhczIgPSBGdW5jdGlvbi5jYWxsLmJpbmQoaGFzT3duUHJvcGVydHkpOwogICAgICAgICAgICAgIGZvciAodmFyIHR5cGVTcGVjTmFtZSBpbiB0eXBlU3BlY3MpIHsKICAgICAgICAgICAgICAgIGlmIChoYXMyKHR5cGVTcGVjcywgdHlwZVNwZWNOYW1lKSkgewogICAgICAgICAgICAgICAgICB2YXIgZXJyb3IkMSA9IHZvaWQgMDsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgZXJyID0gRXJyb3IoKGNvbXBvbmVudE5hbWUgfHwgIlJlYWN0IGNsYXNzIikgKyAiOiAiICsgbG9jYXRpb24gKyAiIHR5cGUgYCIgKyB0eXBlU3BlY05hbWUgKyAiYCBpcyBpbnZhbGlkOyBpdCBtdXN0IGJlIGEgZnVuY3Rpb24sIHVzdWFsbHkgZnJvbSB0aGUgYHByb3AtdHlwZXNgIHBhY2thZ2UsIGJ1dCByZWNlaXZlZCBgIiArIHR5cGVvZiB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSArICJgLlRoaXMgb2Z0ZW4gaGFwcGVucyBiZWNhdXNlIG9mIHR5cG9zIHN1Y2ggYXMgYFByb3BUeXBlcy5mdW5jdGlvbmAgaW5zdGVhZCBvZiBgUHJvcFR5cGVzLmZ1bmNgLiIpOwogICAgICAgICAgICAgICAgICAgICAgZXJyLm5hbWUgPSAiSW52YXJpYW50IFZpb2xhdGlvbiI7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVycm9yJDEgPSB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSh2YWx1ZXMsIHR5cGVTcGVjTmFtZSwgY29tcG9uZW50TmFtZSwgbG9jYXRpb24sIG51bGwsICJTRUNSRVRfRE9fTk9UX1BBU1NfVEhJU19PUl9ZT1VfV0lMTF9CRV9GSVJFRCIpOwogICAgICAgICAgICAgICAgICB9IGNhdGNoIChleCkgewogICAgICAgICAgICAgICAgICAgIGVycm9yJDEgPSBleDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoZXJyb3IkMSAmJiAhKGVycm9yJDEgaW5zdGFuY2VvZiBFcnJvcikpIHsKICAgICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiJXM6IHR5cGUgc3BlY2lmaWNhdGlvbiBvZiAlcyBgJXNgIGlzIGludmFsaWQ7IHRoZSB0eXBlIGNoZWNrZXIgZnVuY3Rpb24gbXVzdCByZXR1cm4gYG51bGxgIG9yIGFuIGBFcnJvcmAgYnV0IHJldHVybmVkIGEgJXMuIFlvdSBtYXkgaGF2ZSBmb3Jnb3R0ZW4gdG8gcGFzcyBhbiBhcmd1bWVudCB0byB0aGUgdHlwZSBjaGVja2VyIGNyZWF0b3IgKGFycmF5T2YsIGluc3RhbmNlT2YsIG9iamVjdE9mLCBvbmVPZiwgb25lT2ZUeXBlLCBhbmQgc2hhcGUgYWxsIHJlcXVpcmUgYW4gYXJndW1lbnQpLiIsIGNvbXBvbmVudE5hbWUgfHwgIlJlYWN0IGNsYXNzIiwgbG9jYXRpb24sIHR5cGVTcGVjTmFtZSwgdHlwZW9mIGVycm9yJDEpOwogICAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IgJiYgIShlcnJvciQxLm1lc3NhZ2UgaW4gbG9nZ2VkVHlwZUZhaWx1cmVzKSkgewogICAgICAgICAgICAgICAgICAgIGxvZ2dlZFR5cGVGYWlsdXJlc1tlcnJvciQxLm1lc3NhZ2VdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiRmFpbGVkICVzIHR5cGU6ICVzIiwgbG9jYXRpb24sIGVycm9yJDEubWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQobnVsbCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciB2YWx1ZVN0YWNrID0gW107CiAgICAgICAgICB2YXIgZmliZXJTdGFjazsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXJTdGFjayA9IFtdOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGluZGV4MiA9IC0xOwogICAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ3Vyc29yKGRlZmF1bHRWYWx1ZSkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIGN1cnJlbnQ6IGRlZmF1bHRWYWx1ZQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcG9wKGN1cnNvciwgZmliZXIpIHsKICAgICAgICAgICAgaWYgKGluZGV4MiA8IDApIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBlcnJvcigiVW5leHBlY3RlZCBwb3AuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGZpYmVyICE9PSBmaWJlclN0YWNrW2luZGV4Ml0pIHsKICAgICAgICAgICAgICAgIGVycm9yKCJVbmV4cGVjdGVkIEZpYmVyIHBvcHBlZC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3Vyc29yLmN1cnJlbnQgPSB2YWx1ZVN0YWNrW2luZGV4Ml07CiAgICAgICAgICAgIHZhbHVlU3RhY2tbaW5kZXgyXSA9IG51bGw7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBmaWJlclN0YWNrW2luZGV4Ml0gPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGluZGV4Mi0tOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcHVzaChjdXJzb3IsIHZhbHVlLCBmaWJlcikgewogICAgICAgICAgICBpbmRleDIrKzsKICAgICAgICAgICAgdmFsdWVTdGFja1tpbmRleDJdID0gY3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBmaWJlclN0YWNrW2luZGV4Ml0gPSBmaWJlcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjdXJzb3IuY3VycmVudCA9IHZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHdhcm5lZEFib3V0TWlzc2luZ0dldENoaWxkQ29udGV4dDsKICAgICAgICAgIHsKICAgICAgICAgICAgd2FybmVkQWJvdXRNaXNzaW5nR2V0Q2hpbGRDb250ZXh0ID0ge307CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZW1wdHlDb250ZXh0T2JqZWN0ID0ge307CiAgICAgICAgICB7CiAgICAgICAgICAgIE9iamVjdC5mcmVlemUoZW1wdHlDb250ZXh0T2JqZWN0KTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjb250ZXh0U3RhY2tDdXJzb3IgPSBjcmVhdGVDdXJzb3IoZW1wdHlDb250ZXh0T2JqZWN0KTsKICAgICAgICAgIHZhciBkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKGZhbHNlKTsKICAgICAgICAgIHZhciBwcmV2aW91c0NvbnRleHQgPSBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICBmdW5jdGlvbiBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIGRpZFB1c2hPd25Db250ZXh0SWZQcm92aWRlcikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGRpZFB1c2hPd25Db250ZXh0SWZQcm92aWRlciAmJiBpc0NvbnRleHRQcm92aWRlcihDb21wb25lbnQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcHJldmlvdXNDb250ZXh0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gY29udGV4dFN0YWNrQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNhY2hlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCwgbWFza2VkQ29udGV4dCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxNZW1vaXplZFVubWFza2VkQ2hpbGRDb250ZXh0ID0gdW5tYXNrZWRDb250ZXh0OwogICAgICAgICAgICAgIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWFza2VkQ2hpbGRDb250ZXh0ID0gbWFza2VkQ29udGV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIHR5cGUyID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgdmFyIGNvbnRleHRUeXBlcyA9IHR5cGUyLmNvbnRleHRUeXBlczsKICAgICAgICAgICAgICBpZiAoIWNvbnRleHRUeXBlcykgewogICAgICAgICAgICAgICAgcmV0dXJuIGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UgJiYgaW5zdGFuY2UuX19yZWFjdEludGVybmFsTWVtb2l6ZWRVbm1hc2tlZENoaWxkQ29udGV4dCA9PT0gdW5tYXNrZWRDb250ZXh0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaW5zdGFuY2UuX19yZWFjdEludGVybmFsTWVtb2l6ZWRNYXNrZWRDaGlsZENvbnRleHQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBjb250ZXh0ID0ge307CiAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGNvbnRleHRUeXBlcykgewogICAgICAgICAgICAgICAgY29udGV4dFtrZXldID0gdW5tYXNrZWRDb250ZXh0W2tleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcih3b3JrSW5Qcm9ncmVzczIpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKGNvbnRleHRUeXBlcywgY29udGV4dCwgImNvbnRleHQiLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICBjYWNoZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCB1bm1hc2tlZENvbnRleHQsIGNvbnRleHQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gY29udGV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaGFzQ29udGV4dENoYW5nZWQoKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZXR1cm4gZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvci5jdXJyZW50OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpc0NvbnRleHRQcm92aWRlcih0eXBlMikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIGNoaWxkQ29udGV4dFR5cGVzID0gdHlwZTIuY2hpbGRDb250ZXh0VHlwZXM7CiAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkQ29udGV4dFR5cGVzICE9PSBudWxsICYmIGNoaWxkQ29udGV4dFR5cGVzICE9PSB2b2lkIDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHBvcENvbnRleHQoZmliZXIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHBvcChkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgICAgICAgcG9wKGNvbnRleHRTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwb3BUb3BMZXZlbENvbnRleHRPYmplY3QoZmliZXIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHBvcChkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgICAgICAgcG9wKGNvbnRleHRTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwdXNoVG9wTGV2ZWxDb250ZXh0T2JqZWN0KGZpYmVyLCBjb250ZXh0LCBkaWRDaGFuZ2UpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChjb250ZXh0U3RhY2tDdXJzb3IuY3VycmVudCAhPT0gZW1wdHlDb250ZXh0T2JqZWN0KSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuZXhwZWN0ZWQgY29udGV4dCBmb3VuZCBvbiBzdGFjay4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHVzaChjb250ZXh0U3RhY2tDdXJzb3IsIGNvbnRleHQsIGZpYmVyKTsKICAgICAgICAgICAgICBwdXNoKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGRpZENoYW5nZSwgZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwcm9jZXNzQ2hpbGRDb250ZXh0KGZpYmVyLCB0eXBlMiwgcGFyZW50Q29udGV4dCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIHZhciBjaGlsZENvbnRleHRUeXBlcyA9IHR5cGUyLmNoaWxkQ29udGV4dFR5cGVzOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuZ2V0Q2hpbGRDb250ZXh0ICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iOwogICAgICAgICAgICAgICAgICBpZiAoIXdhcm5lZEFib3V0TWlzc2luZ0dldENoaWxkQ29udGV4dFtjb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgICAgIHdhcm5lZEFib3V0TWlzc2luZ0dldENoaWxkQ29udGV4dFtjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzLmNoaWxkQ29udGV4dFR5cGVzIGlzIHNwZWNpZmllZCBidXQgdGhlcmUgaXMgbm8gZ2V0Q2hpbGRDb250ZXh0KCkgbWV0aG9kIG9uIHRoZSBpbnN0YW5jZS4gWW91IGNhbiBlaXRoZXIgZGVmaW5lIGdldENoaWxkQ29udGV4dCgpIG9uICVzIG9yIHJlbW92ZSBjaGlsZENvbnRleHRUeXBlcyBmcm9tIGl0LiIsIGNvbXBvbmVudE5hbWUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcGFyZW50Q29udGV4dDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGNoaWxkQ29udGV4dCA9IGluc3RhbmNlLmdldENoaWxkQ29udGV4dCgpOwogICAgICAgICAgICAgIGZvciAodmFyIGNvbnRleHRLZXkgaW4gY2hpbGRDb250ZXh0KSB7CiAgICAgICAgICAgICAgICBpZiAoIShjb250ZXh0S2V5IGluIGNoaWxkQ29udGV4dFR5cGVzKSkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJVbmtub3duIikgKyAnLmdldENoaWxkQ29udGV4dCgpOiBrZXkgIicgKyBjb250ZXh0S2V5ICsgJyIgaXMgbm90IGRlZmluZWQgaW4gY2hpbGRDb250ZXh0VHlwZXMuJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iOwogICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoY2hpbGRDb250ZXh0VHlwZXMsIGNoaWxkQ29udGV4dCwgImNoaWxkIGNvbnRleHQiLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGFzc2lnbih7fSwgcGFyZW50Q29udGV4dCwgY2hpbGRDb250ZXh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcHVzaENvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgdmFyIG1lbW9pemVkTWVyZ2VkQ2hpbGRDb250ZXh0ID0gaW5zdGFuY2UgJiYgaW5zdGFuY2UuX19yZWFjdEludGVybmFsTWVtb2l6ZWRNZXJnZWRDaGlsZENvbnRleHQgfHwgZW1wdHlDb250ZXh0T2JqZWN0OwogICAgICAgICAgICAgIHByZXZpb3VzQ29udGV4dCA9IGNvbnRleHRTdGFja0N1cnNvci5jdXJyZW50OwogICAgICAgICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yLCBtZW1vaXplZE1lcmdlZENoaWxkQ29udGV4dCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwdXNoKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IuY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaW52YWxpZGF0ZUNvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIsIHR5cGUyLCBkaWRDaGFuZ2UpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKCFpbnN0YW5jZSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCB0byBoYXZlIGFuIGluc3RhbmNlIGJ5IHRoaXMgcG9pbnQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChkaWRDaGFuZ2UpIHsKICAgICAgICAgICAgICAgIHZhciBtZXJnZWRDb250ZXh0ID0gcHJvY2Vzc0NoaWxkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHR5cGUyLCBwcmV2aW91c0NvbnRleHQpOwogICAgICAgICAgICAgICAgaW5zdGFuY2UuX19yZWFjdEludGVybmFsTWVtb2l6ZWRNZXJnZWRDaGlsZENvbnRleHQgPSBtZXJnZWRDb250ZXh0OwogICAgICAgICAgICAgICAgcG9wKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgcHVzaChjb250ZXh0U3RhY2tDdXJzb3IsIG1lcmdlZENvbnRleHQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICBwdXNoKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGRpZENoYW5nZSwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcG9wKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICBwdXNoKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGRpZENoYW5nZSwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50VW5tYXNrZWRDb250ZXh0KGZpYmVyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIWlzRmliZXJNb3VudGVkKGZpYmVyKSB8fCBmaWJlci50YWcgIT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHN1YnRyZWUgcGFyZW50IHRvIGJlIGEgbW91bnRlZCBjbGFzcyBjb21wb25lbnQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBub2RlID0gZmliZXI7CiAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgc3dpdGNoIChub2RlLnRhZykgewogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlLnN0YXRlTm9kZS5jb250ZXh0OwogICAgICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgICAgdmFyIENvbXBvbmVudCA9IG5vZGUudHlwZTsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUuc3RhdGVOb2RlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWVyZ2VkQ2hpbGRDb250ZXh0OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgIH0gd2hpbGUgKG5vZGUgIT09IG51bGwpOwogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRm91bmQgdW5leHBlY3RlZCBkZXRhY2hlZCBzdWJ0cmVlIHBhcmVudC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIExlZ2FjeVJvb3QgPSAwOwogICAgICAgICAgdmFyIENvbmN1cnJlbnRSb290ID0gMTsKICAgICAgICAgIHZhciBzeW5jUXVldWUgPSBudWxsOwogICAgICAgICAgdmFyIGluY2x1ZGVzTGVnYWN5U3luY0NhbGxiYWNrcyA9IGZhbHNlOwogICAgICAgICAgdmFyIGlzRmx1c2hpbmdTeW5jUXVldWUgPSBmYWxzZTsKICAgICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlU3luY0NhbGxiYWNrKGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGlmIChzeW5jUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICBzeW5jUXVldWUgPSBbY2FsbGJhY2tdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN5bmNRdWV1ZS5wdXNoKGNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVMZWdhY3lTeW5jQ2FsbGJhY2soY2FsbGJhY2spIHsKICAgICAgICAgICAgaW5jbHVkZXNMZWdhY3lTeW5jQ2FsbGJhY2tzID0gdHJ1ZTsKICAgICAgICAgICAgc2NoZWR1bGVTeW5jQ2FsbGJhY2soY2FsbGJhY2spOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZmx1c2hTeW5jQ2FsbGJhY2tzT25seUluTGVnYWN5TW9kZSgpIHsKICAgICAgICAgICAgaWYgKGluY2x1ZGVzTGVnYWN5U3luY0NhbGxiYWNrcykgewogICAgICAgICAgICAgIGZsdXNoU3luY0NhbGxiYWNrcygpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBmbHVzaFN5bmNDYWxsYmFja3MoKSB7CiAgICAgICAgICAgIGlmICghaXNGbHVzaGluZ1N5bmNRdWV1ZSAmJiBzeW5jUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpc0ZsdXNoaW5nU3luY1F1ZXVlID0gdHJ1ZTsKICAgICAgICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgICAgICAgdmFyIHByZXZpb3VzVXBkYXRlUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdmFyIGlzU3luYyA9IHRydWU7CiAgICAgICAgICAgICAgICB2YXIgcXVldWUgPSBzeW5jUXVldWU7CiAgICAgICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoRGlzY3JldGVFdmVudFByaW9yaXR5KTsKICAgICAgICAgICAgICAgIGZvciAoOyBpIDwgcXVldWUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gcXVldWVbaV07CiAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrKGlzU3luYyk7CiAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKGNhbGxiYWNrICE9PSBudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN5bmNRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgICBpbmNsdWRlc0xlZ2FjeVN5bmNDYWxsYmFja3MgPSBmYWxzZTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIGlmIChzeW5jUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgc3luY1F1ZXVlID0gc3luY1F1ZXVlLnNsaWNlKGkgKyAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2soSW1tZWRpYXRlUHJpb3JpdHksIGZsdXNoU3luY0NhbGxiYWNrcyk7CiAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShwcmV2aW91c1VwZGF0ZVByaW9yaXR5KTsKICAgICAgICAgICAgICAgIGlzRmx1c2hpbmdTeW5jUXVldWUgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZm9ya1N0YWNrID0gW107CiAgICAgICAgICB2YXIgZm9ya1N0YWNrSW5kZXggPSAwOwogICAgICAgICAgdmFyIHRyZWVGb3JrUHJvdmlkZXIgPSBudWxsOwogICAgICAgICAgdmFyIHRyZWVGb3JrQ291bnQgPSAwOwogICAgICAgICAgdmFyIGlkU3RhY2sgPSBbXTsKICAgICAgICAgIHZhciBpZFN0YWNrSW5kZXggPSAwOwogICAgICAgICAgdmFyIHRyZWVDb250ZXh0UHJvdmlkZXIgPSBudWxsOwogICAgICAgICAgdmFyIHRyZWVDb250ZXh0SWQgPSAxOwogICAgICAgICAgdmFyIHRyZWVDb250ZXh0T3ZlcmZsb3cgPSAiIjsKICAgICAgICAgIGZ1bmN0aW9uIGlzRm9ya2VkQ2hpbGQod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICAgIHdhcm5JZk5vdEh5ZHJhdGluZygpOwogICAgICAgICAgICByZXR1cm4gKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIEZvcmtlZCkgIT09IE5vRmxhZ3M7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRGb3Jrc0F0TGV2ZWwod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICAgIHdhcm5JZk5vdEh5ZHJhdGluZygpOwogICAgICAgICAgICByZXR1cm4gdHJlZUZvcmtDb3VudDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldFRyZWVJZCgpIHsKICAgICAgICAgICAgdmFyIG92ZXJmbG93ID0gdHJlZUNvbnRleHRPdmVyZmxvdzsKICAgICAgICAgICAgdmFyIGlkV2l0aExlYWRpbmdCaXQgPSB0cmVlQ29udGV4dElkOwogICAgICAgICAgICB2YXIgaWQyID0gaWRXaXRoTGVhZGluZ0JpdCAmIH5nZXRMZWFkaW5nQml0KGlkV2l0aExlYWRpbmdCaXQpOwogICAgICAgICAgICByZXR1cm4gaWQyLnRvU3RyaW5nKDMyKSArIG92ZXJmbG93OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcHVzaFRyZWVGb3JrKHdvcmtJblByb2dyZXNzMiwgdG90YWxDaGlsZHJlbikgewogICAgICAgICAgICB3YXJuSWZOb3RIeWRyYXRpbmcoKTsKICAgICAgICAgICAgZm9ya1N0YWNrW2ZvcmtTdGFja0luZGV4KytdID0gdHJlZUZvcmtDb3VudDsKICAgICAgICAgICAgZm9ya1N0YWNrW2ZvcmtTdGFja0luZGV4KytdID0gdHJlZUZvcmtQcm92aWRlcjsKICAgICAgICAgICAgdHJlZUZvcmtQcm92aWRlciA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgdHJlZUZvcmtDb3VudCA9IHRvdGFsQ2hpbGRyZW47CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwdXNoVHJlZUlkKHdvcmtJblByb2dyZXNzMiwgdG90YWxDaGlsZHJlbiwgaW5kZXgzKSB7CiAgICAgICAgICAgIHdhcm5JZk5vdEh5ZHJhdGluZygpOwogICAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0SWQ7CiAgICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4KytdID0gdHJlZUNvbnRleHRPdmVyZmxvdzsKICAgICAgICAgICAgaWRTdGFja1tpZFN0YWNrSW5kZXgrK10gPSB0cmVlQ29udGV4dFByb3ZpZGVyOwogICAgICAgICAgICB0cmVlQ29udGV4dFByb3ZpZGVyID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICB2YXIgYmFzZUlkV2l0aExlYWRpbmdCaXQgPSB0cmVlQ29udGV4dElkOwogICAgICAgICAgICB2YXIgYmFzZU92ZXJmbG93ID0gdHJlZUNvbnRleHRPdmVyZmxvdzsKICAgICAgICAgICAgdmFyIGJhc2VMZW5ndGggPSBnZXRCaXRMZW5ndGgoYmFzZUlkV2l0aExlYWRpbmdCaXQpIC0gMTsKICAgICAgICAgICAgdmFyIGJhc2VJZCA9IGJhc2VJZFdpdGhMZWFkaW5nQml0ICYgfigxIDw8IGJhc2VMZW5ndGgpOwogICAgICAgICAgICB2YXIgc2xvdCA9IGluZGV4MyArIDE7CiAgICAgICAgICAgIHZhciBsZW5ndGggPSBnZXRCaXRMZW5ndGgodG90YWxDaGlsZHJlbikgKyBiYXNlTGVuZ3RoOwogICAgICAgICAgICBpZiAobGVuZ3RoID4gMzApIHsKICAgICAgICAgICAgICB2YXIgbnVtYmVyT2ZPdmVyZmxvd0JpdHMgPSBiYXNlTGVuZ3RoIC0gYmFzZUxlbmd0aCAlIDU7CiAgICAgICAgICAgICAgdmFyIG5ld092ZXJmbG93Qml0cyA9ICgxIDw8IG51bWJlck9mT3ZlcmZsb3dCaXRzKSAtIDE7CiAgICAgICAgICAgICAgdmFyIG5ld092ZXJmbG93ID0gKGJhc2VJZCAmIG5ld092ZXJmbG93Qml0cykudG9TdHJpbmcoMzIpOwogICAgICAgICAgICAgIHZhciByZXN0T2ZCYXNlSWQgPSBiYXNlSWQgPj4gbnVtYmVyT2ZPdmVyZmxvd0JpdHM7CiAgICAgICAgICAgICAgdmFyIHJlc3RPZkJhc2VMZW5ndGggPSBiYXNlTGVuZ3RoIC0gbnVtYmVyT2ZPdmVyZmxvd0JpdHM7CiAgICAgICAgICAgICAgdmFyIHJlc3RPZkxlbmd0aCA9IGdldEJpdExlbmd0aCh0b3RhbENoaWxkcmVuKSArIHJlc3RPZkJhc2VMZW5ndGg7CiAgICAgICAgICAgICAgdmFyIHJlc3RPZk5ld0JpdHMgPSBzbG90IDw8IHJlc3RPZkJhc2VMZW5ndGg7CiAgICAgICAgICAgICAgdmFyIGlkMiA9IHJlc3RPZk5ld0JpdHMgfCByZXN0T2ZCYXNlSWQ7CiAgICAgICAgICAgICAgdmFyIG92ZXJmbG93ID0gbmV3T3ZlcmZsb3cgKyBiYXNlT3ZlcmZsb3c7CiAgICAgICAgICAgICAgdHJlZUNvbnRleHRJZCA9IDEgPDwgcmVzdE9mTGVuZ3RoIHwgaWQyOwogICAgICAgICAgICAgIHRyZWVDb250ZXh0T3ZlcmZsb3cgPSBvdmVyZmxvdzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgbmV3Qml0cyA9IHNsb3QgPDwgYmFzZUxlbmd0aDsKICAgICAgICAgICAgICB2YXIgX2lkID0gbmV3Qml0cyB8IGJhc2VJZDsKICAgICAgICAgICAgICB2YXIgX292ZXJmbG93ID0gYmFzZU92ZXJmbG93OwogICAgICAgICAgICAgIHRyZWVDb250ZXh0SWQgPSAxIDw8IGxlbmd0aCB8IF9pZDsKICAgICAgICAgICAgICB0cmVlQ29udGV4dE92ZXJmbG93ID0gX292ZXJmbG93OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwdXNoTWF0ZXJpYWxpemVkVHJlZUlkKHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgICB3YXJuSWZOb3RIeWRyYXRpbmcoKTsKICAgICAgICAgICAgdmFyIHJldHVybkZpYmVyID0gd29ya0luUHJvZ3Jlc3MyLnJldHVybjsKICAgICAgICAgICAgaWYgKHJldHVybkZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG51bWJlck9mRm9ya3MgPSAxOwogICAgICAgICAgICAgIHZhciBzbG90SW5kZXggPSAwOwogICAgICAgICAgICAgIHB1c2hUcmVlRm9yayh3b3JrSW5Qcm9ncmVzczIsIG51bWJlck9mRm9ya3MpOwogICAgICAgICAgICAgIHB1c2hUcmVlSWQod29ya0luUHJvZ3Jlc3MyLCBudW1iZXJPZkZvcmtzLCBzbG90SW5kZXgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRCaXRMZW5ndGgobnVtYmVyKSB7CiAgICAgICAgICAgIHJldHVybiAzMiAtIGNsejMyKG51bWJlcik7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRMZWFkaW5nQml0KGlkMikgewogICAgICAgICAgICByZXR1cm4gMSA8PCBnZXRCaXRMZW5ndGgoaWQyKSAtIDE7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwb3BUcmVlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgICAgd2hpbGUgKHdvcmtJblByb2dyZXNzMiA9PT0gdHJlZUZvcmtQcm92aWRlcikgewogICAgICAgICAgICAgIHRyZWVGb3JrUHJvdmlkZXIgPSBmb3JrU3RhY2tbLS1mb3JrU3RhY2tJbmRleF07CiAgICAgICAgICAgICAgZm9ya1N0YWNrW2ZvcmtTdGFja0luZGV4XSA9IG51bGw7CiAgICAgICAgICAgICAgdHJlZUZvcmtDb3VudCA9IGZvcmtTdGFja1stLWZvcmtTdGFja0luZGV4XTsKICAgICAgICAgICAgICBmb3JrU3RhY2tbZm9ya1N0YWNrSW5kZXhdID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAod29ya0luUHJvZ3Jlc3MyID09PSB0cmVlQ29udGV4dFByb3ZpZGVyKSB7CiAgICAgICAgICAgICAgdHJlZUNvbnRleHRQcm92aWRlciA9IGlkU3RhY2tbLS1pZFN0YWNrSW5kZXhdOwogICAgICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4XSA9IG51bGw7CiAgICAgICAgICAgICAgdHJlZUNvbnRleHRPdmVyZmxvdyA9IGlkU3RhY2tbLS1pZFN0YWNrSW5kZXhdOwogICAgICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4XSA9IG51bGw7CiAgICAgICAgICAgICAgdHJlZUNvbnRleHRJZCA9IGlkU3RhY2tbLS1pZFN0YWNrSW5kZXhdOwogICAgICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4XSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldFN1c3BlbmRlZFRyZWVDb250ZXh0KCkgewogICAgICAgICAgICB3YXJuSWZOb3RIeWRyYXRpbmcoKTsKICAgICAgICAgICAgaWYgKHRyZWVDb250ZXh0UHJvdmlkZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgaWQ6IHRyZWVDb250ZXh0SWQsCiAgICAgICAgICAgICAgICBvdmVyZmxvdzogdHJlZUNvbnRleHRPdmVyZmxvdwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVTdXNwZW5kZWRUcmVlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHN1c3BlbmRlZENvbnRleHQpIHsKICAgICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4KytdID0gdHJlZUNvbnRleHRJZDsKICAgICAgICAgICAgaWRTdGFja1tpZFN0YWNrSW5kZXgrK10gPSB0cmVlQ29udGV4dE92ZXJmbG93OwogICAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0UHJvdmlkZXI7CiAgICAgICAgICAgIHRyZWVDb250ZXh0SWQgPSBzdXNwZW5kZWRDb250ZXh0LmlkOwogICAgICAgICAgICB0cmVlQ29udGV4dE92ZXJmbG93ID0gc3VzcGVuZGVkQ29udGV4dC5vdmVyZmxvdzsKICAgICAgICAgICAgdHJlZUNvbnRleHRQcm92aWRlciA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHdhcm5JZk5vdEh5ZHJhdGluZygpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHRvIGJlIGh5ZHJhdGluZy4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBudWxsOwogICAgICAgICAgdmFyIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBudWxsOwogICAgICAgICAgdmFyIGlzSHlkcmF0aW5nID0gZmFsc2U7CiAgICAgICAgICB2YXIgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSBmYWxzZTsKICAgICAgICAgIHZhciBoeWRyYXRpb25FcnJvcnMgPSBudWxsOwogICAgICAgICAgZnVuY3Rpb24gd2FybklmSHlkcmF0aW5nKCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGlzSHlkcmF0aW5nKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiV2Ugc2hvdWxkIG5vdCBiZSBoeWRyYXRpbmcgaGVyZS4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYSBidWcuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtYXJrRGlkVGhyb3dXaGlsZUh5ZHJhdGluZ0RFVigpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGRpZFN1c3BlbmRPckVycm9yREVWID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZGlkU3VzcGVuZE9yRXJyb3JXaGlsZUh5ZHJhdGluZ0RFVigpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHJldHVybiBkaWRTdXNwZW5kT3JFcnJvckRFVjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZW50ZXJIeWRyYXRpb25TdGF0ZShmaWJlcikgewogICAgICAgICAgICB2YXIgcGFyZW50SW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkV2l0aGluQ29udGFpbmVyKHBhcmVudEluc3RhbmNlKTsKICAgICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBmaWJlcjsKICAgICAgICAgICAgaXNIeWRyYXRpbmcgPSB0cnVlOwogICAgICAgICAgICBoeWRyYXRpb25FcnJvcnMgPSBudWxsOwogICAgICAgICAgICBkaWRTdXNwZW5kT3JFcnJvckRFViA9IGZhbHNlOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlZW50ZXJIeWRyYXRpb25TdGF0ZUZyb21EZWh5ZHJhdGVkU3VzcGVuc2VJbnN0YW5jZShmaWJlciwgc3VzcGVuc2VJbnN0YW5jZSwgdHJlZUNvbnRleHQpIHsKICAgICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkV2l0aGluU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBmaWJlcjsKICAgICAgICAgICAgaXNIeWRyYXRpbmcgPSB0cnVlOwogICAgICAgICAgICBoeWRyYXRpb25FcnJvcnMgPSBudWxsOwogICAgICAgICAgICBkaWRTdXNwZW5kT3JFcnJvckRFViA9IGZhbHNlOwogICAgICAgICAgICBpZiAodHJlZUNvbnRleHQgIT09IG51bGwpIHsKICAgICAgICAgICAgICByZXN0b3JlU3VzcGVuZGVkVHJlZUNvbnRleHQoZmliZXIsIHRyZWVDb250ZXh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHdhcm5Vbmh5ZHJhdGVkSW5zdGFuY2UocmV0dXJuRmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzd2l0Y2ggKHJldHVybkZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgICAgICBkaWROb3RIeWRyYXRlSW5zdGFuY2VXaXRoaW5Db250YWluZXIocmV0dXJuRmliZXIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8sIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgICAgdmFyIGlzQ29uY3VycmVudE1vZGUgPSAocmV0dXJuRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlOwogICAgICAgICAgICAgICAgICBkaWROb3RIeWRyYXRlSW5zdGFuY2UoCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuRmliZXIudHlwZSwKICAgICAgICAgICAgICAgICAgICByZXR1cm5GaWJlci5tZW1vaXplZFByb3BzLAogICAgICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLnN0YXRlTm9kZSwKICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZSwKICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBEZWxldGUgdGhpcyBhcmd1bWVudCB3aGVuIHdlIHJlbW92ZSB0aGUgbGVnYWN5IHJvb3QgQVBJLgogICAgICAgICAgICAgICAgICAgIGlzQ29uY3VycmVudE1vZGUKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gcmV0dXJuRmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkKICAgICAgICAgICAgICAgICAgICBkaWROb3RIeWRyYXRlSW5zdGFuY2VXaXRoaW5TdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZCwgaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGRlbGV0ZUh5ZHJhdGFibGVJbnN0YW5jZShyZXR1cm5GaWJlciwgaW5zdGFuY2UpIHsKICAgICAgICAgICAgd2FyblVuaHlkcmF0ZWRJbnN0YW5jZShyZXR1cm5GaWJlciwgaW5zdGFuY2UpOwogICAgICAgICAgICB2YXIgY2hpbGRUb0RlbGV0ZSA9IGNyZWF0ZUZpYmVyRnJvbUhvc3RJbnN0YW5jZUZvckRlbGV0aW9uKCk7CiAgICAgICAgICAgIGNoaWxkVG9EZWxldGUuc3RhdGVOb2RlID0gaW5zdGFuY2U7CiAgICAgICAgICAgIGNoaWxkVG9EZWxldGUucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgIHZhciBkZWxldGlvbnMgPSByZXR1cm5GaWJlci5kZWxldGlvbnM7CiAgICAgICAgICAgIGlmIChkZWxldGlvbnMgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm5GaWJlci5kZWxldGlvbnMgPSBbY2hpbGRUb0RlbGV0ZV07CiAgICAgICAgICAgICAgcmV0dXJuRmliZXIuZmxhZ3MgfD0gQ2hpbGREZWxldGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkZWxldGlvbnMucHVzaChjaGlsZFRvRGVsZXRlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gd2Fybk5vbmh5ZHJhdGVkSW5zdGFuY2UocmV0dXJuRmliZXIsIGZpYmVyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoZGlkU3VzcGVuZE9yRXJyb3JERVYpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3dpdGNoIChyZXR1cm5GaWJlci50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudENvbnRhaW5lciA9IHJldHVybkZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICAgICAgICAgIHZhciB0eXBlMiA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJvcHMgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgICBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlV2l0aGluQ29udGFpbmVyKHBhcmVudENvbnRhaW5lciwgdHlwZTIpOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDoKICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZXh0ID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVUZXh0SW5zdGFuY2VXaXRoaW5Db250YWluZXIocGFyZW50Q29udGFpbmVyLCB0ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRUeXBlID0gcmV0dXJuRmliZXIudHlwZTsKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFByb3BzID0gcmV0dXJuRmliZXIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudEluc3RhbmNlID0gcmV0dXJuRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgICAgICAgICAgdmFyIF90eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgICAgICAgICAgICAgIHZhciBfcHJvcHMgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgaXNDb25jdXJyZW50TW9kZSA9IChyZXR1cm5GaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICAgICAgICAgICAgICBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlKAogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRUeXBlLAogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRQcm9wcywKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50SW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgICAgICAgIF90eXBlLAogICAgICAgICAgICAgICAgICAgICAgICBfcHJvcHMsCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IERlbGV0ZSB0aGlzIGFyZ3VtZW50IHdoZW4gd2UgcmVtb3ZlIHRoZSBsZWdhY3kgcm9vdCBBUEkuCiAgICAgICAgICAgICAgICAgICAgICAgIGlzQ29uY3VycmVudE1vZGUKICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDogewogICAgICAgICAgICAgICAgICAgICAgdmFyIF90ZXh0ID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgICAgdmFyIF9pc0NvbmN1cnJlbnRNb2RlID0gKHJldHVybkZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgICAgICAgICAgICAgIGRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlKAogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRUeXBlLAogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRQcm9wcywKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50SW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgICAgICAgIF90ZXh0LAogICAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBEZWxldGUgdGhpcyBhcmd1bWVudCB3aGVuIHdlIHJlbW92ZSB0aGUgbGVnYWN5IHJvb3QgQVBJLgogICAgICAgICAgICAgICAgICAgICAgICBfaXNDb25jdXJyZW50TW9kZQogICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSByZXR1cm5GaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgICB2YXIgX3BhcmVudEluc3RhbmNlID0gc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkOwogICAgICAgICAgICAgICAgICBpZiAoX3BhcmVudEluc3RhbmNlICE9PSBudWxsKQogICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfdHlwZTIgPSBmaWJlci50eXBlOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgX3Byb3BzMiA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVJbnN0YW5jZVdpdGhpblN1c3BlbnNlSW5zdGFuY2UoX3BhcmVudEluc3RhbmNlLCBfdHlwZTIpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfdGV4dDIgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgICAgIGRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlV2l0aGluU3VzcGVuc2VJbnN0YW5jZShfcGFyZW50SW5zdGFuY2UsIF90ZXh0Mik7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpbnNlcnROb25IeWRyYXRlZEluc3RhbmNlKHJldHVybkZpYmVyLCBmaWJlcikgewogICAgICAgICAgICBmaWJlci5mbGFncyA9IGZpYmVyLmZsYWdzICYgfkh5ZHJhdGluZyB8IFBsYWNlbWVudDsKICAgICAgICAgICAgd2Fybk5vbmh5ZHJhdGVkSW5zdGFuY2UocmV0dXJuRmliZXIsIGZpYmVyKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHRyeUh5ZHJhdGUoZmliZXIsIG5leHRJbnN0YW5jZSkgewogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIHR5cGUyID0gZmliZXIudHlwZTsKICAgICAgICAgICAgICAgIHZhciBwcm9wcyA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGNhbkh5ZHJhdGVJbnN0YW5jZShuZXh0SW5zdGFuY2UsIHR5cGUyKTsKICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSBpbnN0YW5jZTsKICAgICAgICAgICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBmaWJlcjsKICAgICAgICAgICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkKGluc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6IHsKICAgICAgICAgICAgICAgIHZhciB0ZXh0ID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgdmFyIHRleHRJbnN0YW5jZSA9IGNhbkh5ZHJhdGVUZXh0SW5zdGFuY2UobmV4dEluc3RhbmNlLCB0ZXh0KTsKICAgICAgICAgICAgICAgIGlmICh0ZXh0SW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gdGV4dEluc3RhbmNlOwogICAgICAgICAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IGZpYmVyOwogICAgICAgICAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZUluc3RhbmNlID0gY2FuSHlkcmF0ZVN1c3BlbnNlSW5zdGFuY2UobmV4dEluc3RhbmNlKTsKICAgICAgICAgICAgICAgIGlmIChzdXNwZW5zZUluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gewogICAgICAgICAgICAgICAgICAgIGRlaHlkcmF0ZWQ6IHN1c3BlbnNlSW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgICAgdHJlZUNvbnRleHQ6IGdldFN1c3BlbmRlZFRyZWVDb250ZXh0KCksCiAgICAgICAgICAgICAgICAgICAgcmV0cnlMYW5lOiBPZmZzY3JlZW5MYW5lCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIGZpYmVyLm1lbW9pemVkU3RhdGUgPSBzdXNwZW5zZVN0YXRlOwogICAgICAgICAgICAgICAgICB2YXIgZGVoeWRyYXRlZEZyYWdtZW50ID0gY3JlYXRlRmliZXJGcm9tRGVoeWRyYXRlZEZyYWdtZW50KHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICBkZWh5ZHJhdGVkRnJhZ21lbnQucmV0dXJuID0gZmliZXI7CiAgICAgICAgICAgICAgICAgIGZpYmVyLmNoaWxkID0gZGVoeWRyYXRlZEZyYWdtZW50OwogICAgICAgICAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IGZpYmVyOwogICAgICAgICAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHNob3VsZENsaWVudFJlbmRlck9uTWlzbWF0Y2goZmliZXIpIHsKICAgICAgICAgICAgcmV0dXJuIChmaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGUgJiYgKGZpYmVyLmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3M7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB0aHJvd09uSHlkcmF0aW9uTWlzbWF0Y2goZmliZXIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJIeWRyYXRpb24gZmFpbGVkIGJlY2F1c2UgdGhlIGluaXRpYWwgVUkgZG9lcyBub3QgbWF0Y2ggd2hhdCB3YXMgcmVuZGVyZWQgb24gdGhlIHNlcnZlci4iKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHRyeVRvQ2xhaW1OZXh0SHlkcmF0YWJsZUluc3RhbmNlKGZpYmVyKSB7CiAgICAgICAgICAgIGlmICghaXNIeWRyYXRpbmcpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5leHRJbnN0YW5jZSA9IG5leHRIeWRyYXRhYmxlSW5zdGFuY2U7CiAgICAgICAgICAgIGlmICghbmV4dEluc3RhbmNlKSB7CiAgICAgICAgICAgICAgaWYgKHNob3VsZENsaWVudFJlbmRlck9uTWlzbWF0Y2goZmliZXIpKSB7CiAgICAgICAgICAgICAgICB3YXJuTm9uaHlkcmF0ZWRJbnN0YW5jZShoeWRyYXRpb25QYXJlbnRGaWJlciwgZmliZXIpOwogICAgICAgICAgICAgICAgdGhyb3dPbkh5ZHJhdGlvbk1pc21hdGNoKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGluc2VydE5vbkh5ZHJhdGVkSW5zdGFuY2UoaHlkcmF0aW9uUGFyZW50RmliZXIsIGZpYmVyKTsKICAgICAgICAgICAgICBpc0h5ZHJhdGluZyA9IGZhbHNlOwogICAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBmaXJzdEF0dGVtcHRlZEluc3RhbmNlID0gbmV4dEluc3RhbmNlOwogICAgICAgICAgICBpZiAoIXRyeUh5ZHJhdGUoZmliZXIsIG5leHRJbnN0YW5jZSkpIHsKICAgICAgICAgICAgICBpZiAoc2hvdWxkQ2xpZW50UmVuZGVyT25NaXNtYXRjaChmaWJlcikpIHsKICAgICAgICAgICAgICAgIHdhcm5Ob25oeWRyYXRlZEluc3RhbmNlKGh5ZHJhdGlvblBhcmVudEZpYmVyLCBmaWJlcik7CiAgICAgICAgICAgICAgICB0aHJvd09uSHlkcmF0aW9uTWlzbWF0Y2goKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbmV4dEluc3RhbmNlID0gZ2V0TmV4dEh5ZHJhdGFibGVTaWJsaW5nKGZpcnN0QXR0ZW1wdGVkSW5zdGFuY2UpOwogICAgICAgICAgICAgIHZhciBwcmV2SHlkcmF0aW9uUGFyZW50RmliZXIgPSBoeWRyYXRpb25QYXJlbnRGaWJlcjsKICAgICAgICAgICAgICBpZiAoIW5leHRJbnN0YW5jZSB8fCAhdHJ5SHlkcmF0ZShmaWJlciwgbmV4dEluc3RhbmNlKSkgewogICAgICAgICAgICAgICAgaW5zZXJ0Tm9uSHlkcmF0ZWRJbnN0YW5jZShoeWRyYXRpb25QYXJlbnRGaWJlciwgZmliZXIpOwogICAgICAgICAgICAgICAgaXNIeWRyYXRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlbGV0ZUh5ZHJhdGFibGVJbnN0YW5jZShwcmV2SHlkcmF0aW9uUGFyZW50RmliZXIsIGZpcnN0QXR0ZW1wdGVkSW5zdGFuY2UpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwcmVwYXJlVG9IeWRyYXRlSG9zdEluc3RhbmNlKGZpYmVyLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0KSB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgdmFyIHNob3VsZFdhcm5JZk1pc21hdGNoRGV2ID0gIWRpZFN1c3BlbmRPckVycm9yREVWOwogICAgICAgICAgICB2YXIgdXBkYXRlUGF5bG9hZCA9IGh5ZHJhdGVJbnN0YW5jZShpbnN0YW5jZSwgZmliZXIudHlwZSwgZmliZXIubWVtb2l6ZWRQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBob3N0Q29udGV4dCwgZmliZXIsIHNob3VsZFdhcm5JZk1pc21hdGNoRGV2KTsKICAgICAgICAgICAgZmliZXIudXBkYXRlUXVldWUgPSB1cGRhdGVQYXlsb2FkOwogICAgICAgICAgICBpZiAodXBkYXRlUGF5bG9hZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHByZXBhcmVUb0h5ZHJhdGVIb3N0VGV4dEluc3RhbmNlKGZpYmVyKSB7CiAgICAgICAgICAgIHZhciB0ZXh0SW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgIHZhciB0ZXh0Q29udGVudCA9IGZpYmVyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgIHZhciBzaG91bGRVcGRhdGUgPSBoeWRyYXRlVGV4dEluc3RhbmNlKHRleHRJbnN0YW5jZSwgdGV4dENvbnRlbnQsIGZpYmVyKTsKICAgICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSkgewogICAgICAgICAgICAgIHZhciByZXR1cm5GaWJlciA9IGh5ZHJhdGlvblBhcmVudEZpYmVyOwogICAgICAgICAgICAgIGlmIChyZXR1cm5GaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc3dpdGNoIChyZXR1cm5GaWJlci50YWcpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRDb250YWluZXIgPSByZXR1cm5GaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgICB2YXIgaXNDb25jdXJyZW50TW9kZSA9IChyZXR1cm5GaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90TWF0Y2hIeWRyYXRlZENvbnRhaW5lclRleHRJbnN0YW5jZSgKICAgICAgICAgICAgICAgICAgICAgIHBhcmVudENvbnRhaW5lciwKICAgICAgICAgICAgICAgICAgICAgIHRleHRJbnN0YW5jZSwKICAgICAgICAgICAgICAgICAgICAgIHRleHRDb250ZW50LAogICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogRGVsZXRlIHRoaXMgYXJndW1lbnQgd2hlbiB3ZSByZW1vdmUgdGhlIGxlZ2FjeSByb290IEFQSS4KICAgICAgICAgICAgICAgICAgICAgIGlzQ29uY3VycmVudE1vZGUKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRUeXBlID0gcmV0dXJuRmliZXIudHlwZTsKICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50UHJvcHMgPSByZXR1cm5GaWJlci5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRJbnN0YW5jZSA9IHJldHVybkZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgICB2YXIgX2lzQ29uY3VycmVudE1vZGUyID0gKHJldHVybkZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgICAgICAgICAgICBkaWROb3RNYXRjaEh5ZHJhdGVkVGV4dEluc3RhbmNlKAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50VHlwZSwKICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFByb3BzLAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50SW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgICAgICB0ZXh0SW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgICAgICB0ZXh0Q29udGVudCwKICAgICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IERlbGV0ZSB0aGlzIGFyZ3VtZW50IHdoZW4gd2UgcmVtb3ZlIHRoZSBsZWdhY3kgcm9vdCBBUEkuCiAgICAgICAgICAgICAgICAgICAgICBfaXNDb25jdXJyZW50TW9kZTIKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzaG91bGRVcGRhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwcmVwYXJlVG9IeWRyYXRlSG9zdFN1c3BlbnNlSW5zdGFuY2UoZmliZXIpIHsKICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSBmaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICB2YXIgc3VzcGVuc2VJbnN0YW5jZSA9IHN1c3BlbnNlU3RhdGUgIT09IG51bGwgPyBzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQgOiBudWxsOwogICAgICAgICAgICBpZiAoIXN1c3BlbnNlSW5zdGFuY2UpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGhhdmUgYSBoeWRyYXRlZCBzdXNwZW5zZSBpbnN0YW5jZS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBoeWRyYXRlU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlLCBmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBza2lwUGFzdERlaHlkcmF0ZWRTdXNwZW5zZUluc3RhbmNlKGZpYmVyKSB7CiAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gZmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgdmFyIHN1c3BlbnNlSW5zdGFuY2UgPSBzdXNwZW5zZVN0YXRlICE9PSBudWxsID8gc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkIDogbnVsbDsKICAgICAgICAgICAgaWYgKCFzdXNwZW5zZUluc3RhbmNlKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCB0byBoYXZlIGEgaHlkcmF0ZWQgc3VzcGVuc2UgaW5zdGFuY2UuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGdldE5leHRIeWRyYXRhYmxlSW5zdGFuY2VBZnRlclN1c3BlbnNlSW5zdGFuY2Uoc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwb3BUb05leHRIb3N0UGFyZW50KGZpYmVyKSB7CiAgICAgICAgICAgIHZhciBwYXJlbnQgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgIHdoaWxlIChwYXJlbnQgIT09IG51bGwgJiYgcGFyZW50LnRhZyAhPT0gSG9zdENvbXBvbmVudCAmJiBwYXJlbnQudGFnICE9PSBIb3N0Um9vdCAmJiBwYXJlbnQudGFnICE9PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudC5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBwYXJlbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwb3BIeWRyYXRpb25TdGF0ZShmaWJlcikgewogICAgICAgICAgICBpZiAoZmliZXIgIT09IGh5ZHJhdGlvblBhcmVudEZpYmVyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghaXNIeWRyYXRpbmcpIHsKICAgICAgICAgICAgICBwb3BUb05leHRIb3N0UGFyZW50KGZpYmVyKTsKICAgICAgICAgICAgICBpc0h5ZHJhdGluZyA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmaWJlci50YWcgIT09IEhvc3RSb290ICYmIChmaWJlci50YWcgIT09IEhvc3RDb21wb25lbnQgfHwgc2hvdWxkRGVsZXRlVW5oeWRyYXRlZFRhaWxJbnN0YW5jZXMoZmliZXIudHlwZSkgJiYgIXNob3VsZFNldFRleHRDb250ZW50KGZpYmVyLnR5cGUsIGZpYmVyLm1lbW9pemVkUHJvcHMpKSkgewogICAgICAgICAgICAgIHZhciBuZXh0SW5zdGFuY2UgPSBuZXh0SHlkcmF0YWJsZUluc3RhbmNlOwogICAgICAgICAgICAgIGlmIChuZXh0SW5zdGFuY2UpIHsKICAgICAgICAgICAgICAgIGlmIChzaG91bGRDbGllbnRSZW5kZXJPbk1pc21hdGNoKGZpYmVyKSkgewogICAgICAgICAgICAgICAgICB3YXJuSWZVbmh5ZHJhdGVkVGFpbE5vZGVzKGZpYmVyKTsKICAgICAgICAgICAgICAgICAgdGhyb3dPbkh5ZHJhdGlvbk1pc21hdGNoKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB3aGlsZSAobmV4dEluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlSHlkcmF0YWJsZUluc3RhbmNlKGZpYmVyLCBuZXh0SW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICAgIG5leHRJbnN0YW5jZSA9IGdldE5leHRIeWRyYXRhYmxlU2libGluZyhuZXh0SW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHBvcFRvTmV4dEhvc3RQYXJlbnQoZmliZXIpOwogICAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBza2lwUGFzdERlaHlkcmF0ZWRTdXNwZW5zZUluc3RhbmNlKGZpYmVyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gaHlkcmF0aW9uUGFyZW50RmliZXIgPyBnZXROZXh0SHlkcmF0YWJsZVNpYmxpbmcoZmliZXIuc3RhdGVOb2RlKSA6IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBoYXNVbmh5ZHJhdGVkVGFpbE5vZGVzKCkgewogICAgICAgICAgICByZXR1cm4gaXNIeWRyYXRpbmcgJiYgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSAhPT0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHdhcm5JZlVuaHlkcmF0ZWRUYWlsTm9kZXMoZmliZXIpIHsKICAgICAgICAgICAgdmFyIG5leHRJbnN0YW5jZSA9IG5leHRIeWRyYXRhYmxlSW5zdGFuY2U7CiAgICAgICAgICAgIHdoaWxlIChuZXh0SW5zdGFuY2UpIHsKICAgICAgICAgICAgICB3YXJuVW5oeWRyYXRlZEluc3RhbmNlKGZpYmVyLCBuZXh0SW5zdGFuY2UpOwogICAgICAgICAgICAgIG5leHRJbnN0YW5jZSA9IGdldE5leHRIeWRyYXRhYmxlU2libGluZyhuZXh0SW5zdGFuY2UpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZXNldEh5ZHJhdGlvblN0YXRlKCkgewogICAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IG51bGw7CiAgICAgICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBudWxsOwogICAgICAgICAgICBpc0h5ZHJhdGluZyA9IGZhbHNlOwogICAgICAgICAgICBkaWRTdXNwZW5kT3JFcnJvckRFViA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBncmFkZUh5ZHJhdGlvbkVycm9yc1RvUmVjb3ZlcmFibGUoKSB7CiAgICAgICAgICAgIGlmIChoeWRyYXRpb25FcnJvcnMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBxdWV1ZVJlY292ZXJhYmxlRXJyb3JzKGh5ZHJhdGlvbkVycm9ycyk7CiAgICAgICAgICAgICAgaHlkcmF0aW9uRXJyb3JzID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0SXNIeWRyYXRpbmcoKSB7CiAgICAgICAgICAgIHJldHVybiBpc0h5ZHJhdGluZzsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHF1ZXVlSHlkcmF0aW9uRXJyb3IoZXJyb3IyKSB7CiAgICAgICAgICAgIGlmIChoeWRyYXRpb25FcnJvcnMgPT09IG51bGwpIHsKICAgICAgICAgICAgICBoeWRyYXRpb25FcnJvcnMgPSBbZXJyb3IyXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBoeWRyYXRpb25FcnJvcnMucHVzaChlcnJvcjIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudEJhdGNoQ29uZmlnOwogICAgICAgICAgdmFyIE5vVHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICBmdW5jdGlvbiByZXF1ZXN0Q3VycmVudFRyYW5zaXRpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQxLnRyYW5zaXRpb247CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MgPSB7CiAgICAgICAgICAgIHJlY29yZFVuc2FmZUxpZmVjeWNsZVdhcm5pbmdzOiBmdW5jdGlvbihmaWJlciwgaW5zdGFuY2UpIHsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZmx1c2hQZW5kaW5nVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3M6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB9LAogICAgICAgICAgICByZWNvcmRMZWdhY3lDb250ZXh0V2FybmluZzogZnVuY3Rpb24oZmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGZsdXNoTGVnYWN5Q29udGV4dFdhcm5pbmc6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB9LAogICAgICAgICAgICBkaXNjYXJkUGVuZGluZ1dhcm5pbmdzOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGZpbmRTdHJpY3RSb290ID0gZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICB2YXIgbWF5YmVTdHJpY3RSb290ID0gbnVsbDsKICAgICAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgICAgIHdoaWxlIChub2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgICBtYXliZVN0cmljdFJvb3QgPSBub2RlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gbWF5YmVTdHJpY3RSb290OwogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgc2V0VG9Tb3J0ZWRTdHJpbmcgPSBmdW5jdGlvbihzZXQ0KSB7CiAgICAgICAgICAgICAgdmFyIGFycmF5MiA9IFtdOwogICAgICAgICAgICAgIHNldDQuZm9yRWFjaChmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgYXJyYXkyLnB1c2godmFsdWUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHJldHVybiBhcnJheTIuc29ydCgpLmpvaW4oIiwgIik7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciBwZW5kaW5nQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgdmFyIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgdmFyIHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgdmFyIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzID0gW107CiAgICAgICAgICAgIHZhciBwZW5kaW5nQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzID0gW107CiAgICAgICAgICAgIHZhciBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICB2YXIgZGlkV2FybkFib3V0VW5zYWZlTGlmZWN5Y2xlcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLnJlY29yZFVuc2FmZUxpZmVjeWNsZVdhcm5pbmdzID0gZnVuY3Rpb24oZmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICAgICAgaWYgKGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuaGFzKGZpYmVyLnR5cGUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iICYmIC8vIERvbid0IHdhcm4gYWJvdXQgcmVhY3QtbGlmZWN5Y2xlcy1jb21wYXQgcG9seWZpbGxlZCBjb21wb25lbnRzLgogICAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudC5fX3N1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5nICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MucHVzaChmaWJlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChmaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSAmJiB0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iICYmIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMuX19zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGZpYmVyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlICYmIHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MucHVzaChmaWJlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVwZGF0ZSA9PT0gImZ1bmN0aW9uIiAmJiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlLl9fc3VwcHJlc3NEZXByZWNhdGlvbldhcm5pbmcgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MucHVzaChmaWJlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChmaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSAmJiB0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzLnB1c2goZmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZmx1c2hQZW5kaW5nVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3MgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgIGlmIChwZW5kaW5nQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzLmZvckVhY2goZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICAgICAgY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5zYWZlTGlmZWN5Y2xlcy5hZGQoZmliZXIudHlwZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgICBpZiAocGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzLmZvckVhY2goZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICAgICAgVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzLmFkZChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzID0gW107CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgIGlmIChwZW5kaW5nQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgICBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5zYWZlTGlmZWN5Y2xlcy5hZGQoZmliZXIudHlwZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgIGlmIChwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICAgIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5zYWZlTGlmZWN5Y2xlcy5hZGQoZmliZXIudHlwZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzID0gW107CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBjb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgIGlmIChwZW5kaW5nQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgICBjb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5zYWZlTGlmZWN5Y2xlcy5hZGQoZmliZXIudHlwZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIFVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgIGlmIChwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICAgIFVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5zYWZlTGlmZWN5Y2xlcy5hZGQoZmliZXIudHlwZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzID0gW107CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgIHZhciBzb3J0ZWROYW1lcyA9IHNldFRvU29ydGVkU3RyaW5nKFVOU0FGRV9jb21wb25lbnRXaWxsTW91bnRVbmlxdWVOYW1lcyk7CiAgICAgICAgICAgICAgICBlcnJvcigiVXNpbmcgVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCBpbiBzdHJpY3QgbW9kZSBpcyBub3QgcmVjb21tZW5kZWQgYW5kIG1heSBpbmRpY2F0ZSBidWdzIGluIHlvdXIgY29kZS4gU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMgZm9yIGRldGFpbHMuXG5cbiogTW92ZSBjb2RlIHdpdGggc2lkZSBlZmZlY3RzIHRvIGNvbXBvbmVudERpZE1vdW50LCBhbmQgc2V0IGluaXRpYWwgc3RhdGUgaW4gdGhlIGNvbnN0cnVjdG9yLlxuXG5QbGVhc2UgdXBkYXRlIHRoZSBmb2xsb3dpbmcgY29tcG9uZW50czogJXMiLCBzb3J0ZWROYW1lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgICB2YXIgX3NvcnRlZE5hbWVzID0gc2V0VG9Tb3J0ZWRTdHJpbmcoVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNVbmlxdWVOYW1lcyk7CiAgICAgICAgICAgICAgICBlcnJvcigiVXNpbmcgVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgaW4gc3RyaWN0IG1vZGUgaXMgbm90IHJlY29tbWVuZGVkIGFuZCBtYXkgaW5kaWNhdGUgYnVncyBpbiB5b3VyIGNvZGUuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvdW5zYWZlLWNvbXBvbmVudC1saWZlY3ljbGVzIGZvciBkZXRhaWxzLlxuXG4qIE1vdmUgZGF0YSBmZXRjaGluZyBjb2RlIG9yIHNpZGUgZWZmZWN0cyB0byBjb21wb25lbnREaWRVcGRhdGUuXG4qIElmIHlvdSdyZSB1cGRhdGluZyBzdGF0ZSB3aGVuZXZlciBwcm9wcyBjaGFuZ2UsIHJlZmFjdG9yIHlvdXIgY29kZSB0byB1c2UgbWVtb2l6YXRpb24gdGVjaG5pcXVlcyBvciBtb3ZlIGl0IHRvIHN0YXRpYyBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMuIExlYXJuIG1vcmUgYXQ6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9kZXJpdmVkLXN0YXRlXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIF9zb3J0ZWROYW1lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgICB2YXIgX3NvcnRlZE5hbWVzMiA9IHNldFRvU29ydGVkU3RyaW5nKFVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMpOwogICAgICAgICAgICAgICAgZXJyb3IoIlVzaW5nIFVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlIGluIHN0cmljdCBtb2RlIGlzIG5vdCByZWNvbW1lbmRlZCBhbmQgbWF5IGluZGljYXRlIGJ1Z3MgaW4geW91ciBjb2RlLiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3Vuc2FmZS1jb21wb25lbnQtbGlmZWN5Y2xlcyBmb3IgZGV0YWlscy5cblxuKiBNb3ZlIGRhdGEgZmV0Y2hpbmcgY29kZSBvciBzaWRlIGVmZmVjdHMgdG8gY29tcG9uZW50RGlkVXBkYXRlLlxuXG5QbGVhc2UgdXBkYXRlIHRoZSBmb2xsb3dpbmcgY29tcG9uZW50czogJXMiLCBfc29ydGVkTmFtZXMyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGNvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgICB2YXIgX3NvcnRlZE5hbWVzMyA9IHNldFRvU29ydGVkU3RyaW5nKGNvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzKTsKICAgICAgICAgICAgICAgIHdhcm4oImNvbXBvbmVudFdpbGxNb3VudCBoYXMgYmVlbiByZW5hbWVkLCBhbmQgaXMgbm90IHJlY29tbWVuZGVkIGZvciB1c2UuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvdW5zYWZlLWNvbXBvbmVudC1saWZlY3ljbGVzIGZvciBkZXRhaWxzLlxuXG4qIE1vdmUgY29kZSB3aXRoIHNpZGUgZWZmZWN0cyB0byBjb21wb25lbnREaWRNb3VudCwgYW5kIHNldCBpbml0aWFsIHN0YXRlIGluIHRoZSBjb25zdHJ1Y3Rvci5cbiogUmVuYW1lIGNvbXBvbmVudFdpbGxNb3VudCB0byBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50IHRvIHN1cHByZXNzIHRoaXMgd2FybmluZyBpbiBub24tc3RyaWN0IG1vZGUuIEluIFJlYWN0IDE4LngsIG9ubHkgdGhlIFVOU0FGRV8gbmFtZSB3aWxsIHdvcmsuIFRvIHJlbmFtZSBhbGwgZGVwcmVjYXRlZCBsaWZlY3ljbGVzIHRvIHRoZWlyIG5ldyBuYW1lcywgeW91IGNhbiBydW4gYG5weCByZWFjdC1jb2RlbW9kIHJlbmFtZS11bnNhZmUtbGlmZWN5Y2xlc2AgaW4geW91ciBwcm9qZWN0IHNvdXJjZSBmb2xkZXIuXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIF9zb3J0ZWROYW1lczMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgICB2YXIgX3NvcnRlZE5hbWVzNCA9IHNldFRvU29ydGVkU3RyaW5nKGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNVbmlxdWVOYW1lcyk7CiAgICAgICAgICAgICAgICB3YXJuKCJjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIGhhcyBiZWVuIHJlbmFtZWQsIGFuZCBpcyBub3QgcmVjb21tZW5kZWQgZm9yIHVzZS4gU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMgZm9yIGRldGFpbHMuXG5cbiogTW92ZSBkYXRhIGZldGNoaW5nIGNvZGUgb3Igc2lkZSBlZmZlY3RzIHRvIGNvbXBvbmVudERpZFVwZGF0ZS5cbiogSWYgeW91J3JlIHVwZGF0aW5nIHN0YXRlIHdoZW5ldmVyIHByb3BzIGNoYW5nZSwgcmVmYWN0b3IgeW91ciBjb2RlIHRvIHVzZSBtZW1vaXphdGlvbiB0ZWNobmlxdWVzIG9yIG1vdmUgaXQgdG8gc3RhdGljIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcy4gTGVhcm4gbW9yZSBhdDogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2Rlcml2ZWQtc3RhdGVcbiogUmVuYW1lIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgdG8gVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgdG8gc3VwcHJlc3MgdGhpcyB3YXJuaW5nIGluIG5vbi1zdHJpY3QgbW9kZS4gSW4gUmVhY3QgMTgueCwgb25seSB0aGUgVU5TQUZFXyBuYW1lIHdpbGwgd29yay4gVG8gcmVuYW1lIGFsbCBkZXByZWNhdGVkIGxpZmVjeWNsZXMgdG8gdGhlaXIgbmV3IG5hbWVzLCB5b3UgY2FuIHJ1biBgbnB4IHJlYWN0LWNvZGVtb2QgcmVuYW1lLXVuc2FmZS1saWZlY3ljbGVzYCBpbiB5b3VyIHByb2plY3Qgc291cmNlIGZvbGRlci5cblxuUGxlYXNlIHVwZGF0ZSB0aGUgZm9sbG93aW5nIGNvbXBvbmVudHM6ICVzIiwgX3NvcnRlZE5hbWVzNCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChjb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgIHZhciBfc29ydGVkTmFtZXM1ID0gc2V0VG9Tb3J0ZWRTdHJpbmcoY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzKTsKICAgICAgICAgICAgICAgIHdhcm4oImNvbXBvbmVudFdpbGxVcGRhdGUgaGFzIGJlZW4gcmVuYW1lZCwgYW5kIGlzIG5vdCByZWNvbW1lbmRlZCBmb3IgdXNlLiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3Vuc2FmZS1jb21wb25lbnQtbGlmZWN5Y2xlcyBmb3IgZGV0YWlscy5cblxuKiBNb3ZlIGRhdGEgZmV0Y2hpbmcgY29kZSBvciBzaWRlIGVmZmVjdHMgdG8gY29tcG9uZW50RGlkVXBkYXRlLlxuKiBSZW5hbWUgY29tcG9uZW50V2lsbFVwZGF0ZSB0byBVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZSB0byBzdXBwcmVzcyB0aGlzIHdhcm5pbmcgaW4gbm9uLXN0cmljdCBtb2RlLiBJbiBSZWFjdCAxOC54LCBvbmx5IHRoZSBVTlNBRkVfIG5hbWUgd2lsbCB3b3JrLiBUbyByZW5hbWUgYWxsIGRlcHJlY2F0ZWQgbGlmZWN5Y2xlcyB0byB0aGVpciBuZXcgbmFtZXMsIHlvdSBjYW4gcnVuIGBucHggcmVhY3QtY29kZW1vZCByZW5hbWUtdW5zYWZlLWxpZmVjeWNsZXNgIGluIHlvdXIgcHJvamVjdCBzb3VyY2UgZm9sZGVyLlxuXG5QbGVhc2UgdXBkYXRlIHRoZSBmb2xsb3dpbmcgY29tcG9uZW50czogJXMiLCBfc29ydGVkTmFtZXM1KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciBwZW5kaW5nTGVnYWN5Q29udGV4dFdhcm5pbmcgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgICAgICB2YXIgZGlkV2FybkFib3V0TGVnYWN5Q29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLnJlY29yZExlZ2FjeUNvbnRleHRXYXJuaW5nID0gZnVuY3Rpb24oZmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICAgICAgdmFyIHN0cmljdFJvb3QgPSBmaW5kU3RyaWN0Um9vdChmaWJlcik7CiAgICAgICAgICAgICAgaWYgKHN0cmljdFJvb3QgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCB0byBmaW5kIGEgU3RyaWN0TW9kZSBjb21wb25lbnQgaW4gYSBzdHJpY3QgbW9kZSB0cmVlLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZGlkV2FybkFib3V0TGVnYWN5Q29udGV4dC5oYXMoZmliZXIudHlwZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHdhcm5pbmdzRm9yUm9vdCA9IHBlbmRpbmdMZWdhY3lDb250ZXh0V2FybmluZy5nZXQoc3RyaWN0Um9vdCk7CiAgICAgICAgICAgICAgaWYgKGZpYmVyLnR5cGUuY29udGV4dFR5cGVzICE9IG51bGwgfHwgZmliZXIudHlwZS5jaGlsZENvbnRleHRUeXBlcyAhPSBudWxsIHx8IGluc3RhbmNlICE9PSBudWxsICYmIHR5cGVvZiBpbnN0YW5jZS5nZXRDaGlsZENvbnRleHQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGlmICh3YXJuaW5nc0ZvclJvb3QgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICB3YXJuaW5nc0ZvclJvb3QgPSBbXTsKICAgICAgICAgICAgICAgICAgcGVuZGluZ0xlZ2FjeUNvbnRleHRXYXJuaW5nLnNldChzdHJpY3RSb290LCB3YXJuaW5nc0ZvclJvb3QpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd2FybmluZ3NGb3JSb290LnB1c2goZmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZmx1c2hMZWdhY3lDb250ZXh0V2FybmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHBlbmRpbmdMZWdhY3lDb250ZXh0V2FybmluZy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyQXJyYXksIHN0cmljdFJvb3QpIHsKICAgICAgICAgICAgICAgIGlmIChmaWJlckFycmF5Lmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgZmlyc3RGaWJlciA9IGZpYmVyQXJyYXlbMF07CiAgICAgICAgICAgICAgICB2YXIgdW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgICAgZmliZXJBcnJheS5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICAgIHVuaXF1ZU5hbWVzLmFkZChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB2YXIgc29ydGVkTmFtZXMgPSBzZXRUb1NvcnRlZFN0cmluZyh1bmlxdWVOYW1lcyk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmlyc3RGaWJlcik7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJMZWdhY3kgY29udGV4dCBBUEkgaGFzIGJlZW4gZGV0ZWN0ZWQgd2l0aGluIGEgc3RyaWN0LW1vZGUgdHJlZS5cblxuVGhlIG9sZCBBUEkgd2lsbCBiZSBzdXBwb3J0ZWQgaW4gYWxsIDE2LnggcmVsZWFzZXMsIGJ1dCBhcHBsaWNhdGlvbnMgdXNpbmcgaXQgc2hvdWxkIG1pZ3JhdGUgdG8gdGhlIG5ldyB2ZXJzaW9uLlxuXG5QbGVhc2UgdXBkYXRlIHRoZSBmb2xsb3dpbmcgY29tcG9uZW50czogJXNcblxuTGVhcm4gbW9yZSBhYm91dCB0aGlzIHdhcm5pbmcgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2xlZ2FjeS1jb250ZXh0Iiwgc29ydGVkTmFtZXMpOwogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZGlzY2FyZFBlbmRpbmdXYXJuaW5ncyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzID0gW107CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzID0gW107CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgICBwZW5kaW5nTGVnYWN5Q29udGV4dFdhcm5pbmcgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZURlZmF1bHRQcm9wcyhDb21wb25lbnQsIGJhc2VQcm9wcykgewogICAgICAgICAgICBpZiAoQ29tcG9uZW50ICYmIENvbXBvbmVudC5kZWZhdWx0UHJvcHMpIHsKICAgICAgICAgICAgICB2YXIgcHJvcHMgPSBhc3NpZ24oe30sIGJhc2VQcm9wcyk7CiAgICAgICAgICAgICAgdmFyIGRlZmF1bHRQcm9wcyA9IENvbXBvbmVudC5kZWZhdWx0UHJvcHM7CiAgICAgICAgICAgICAgZm9yICh2YXIgcHJvcE5hbWUgaW4gZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgICAgICBpZiAocHJvcHNbcHJvcE5hbWVdID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gZGVmYXVsdFByb3BzW3Byb3BOYW1lXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHByb3BzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBiYXNlUHJvcHM7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdmFsdWVDdXJzb3IgPSBjcmVhdGVDdXJzb3IobnVsbCk7CiAgICAgICAgICB2YXIgcmVuZGVyZXJTaWdpbDsKICAgICAgICAgIHsKICAgICAgICAgICAgcmVuZGVyZXJTaWdpbCA9IHt9OwogICAgICAgICAgfQogICAgICAgICAgdmFyIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyID0gbnVsbDsKICAgICAgICAgIHZhciBsYXN0Q29udGV4dERlcGVuZGVuY3kgPSBudWxsOwogICAgICAgICAgdmFyIGxhc3RGdWxseU9ic2VydmVkQ29udGV4dCA9IG51bGw7CiAgICAgICAgICB2YXIgaXNEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFViA9IGZhbHNlOwogICAgICAgICAgZnVuY3Rpb24gcmVzZXRDb250ZXh0RGVwZW5kZW5jaWVzKCkgewogICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciA9IG51bGw7CiAgICAgICAgICAgIGxhc3RDb250ZXh0RGVwZW5kZW5jeSA9IG51bGw7CiAgICAgICAgICAgIGxhc3RGdWxseU9ic2VydmVkQ29udGV4dCA9IG51bGw7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpc0Rpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGVudGVyRGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYoKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpc0Rpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZXhpdERpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaXNEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFViA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwdXNoUHJvdmlkZXIocHJvdmlkZXJGaWJlciwgY29udGV4dCwgbmV4dFZhbHVlKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBwdXNoKHZhbHVlQ3Vyc29yLCBjb250ZXh0Ll9jdXJyZW50VmFsdWUsIHByb3ZpZGVyRmliZXIpOwogICAgICAgICAgICAgIGNvbnRleHQuX2N1cnJlbnRWYWx1ZSA9IG5leHRWYWx1ZTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoY29udGV4dC5fY3VycmVudFJlbmRlcmVyICE9PSB2b2lkIDAgJiYgY29udGV4dC5fY3VycmVudFJlbmRlcmVyICE9PSBudWxsICYmIGNvbnRleHQuX2N1cnJlbnRSZW5kZXJlciAhPT0gcmVuZGVyZXJTaWdpbCkgewogICAgICAgICAgICAgICAgICBlcnJvcigiRGV0ZWN0ZWQgbXVsdGlwbGUgcmVuZGVyZXJzIGNvbmN1cnJlbnRseSByZW5kZXJpbmcgdGhlIHNhbWUgY29udGV4dCBwcm92aWRlci4gVGhpcyBpcyBjdXJyZW50bHkgdW5zdXBwb3J0ZWQuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb250ZXh0Ll9jdXJyZW50UmVuZGVyZXIgPSByZW5kZXJlclNpZ2lsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcG9wUHJvdmlkZXIoY29udGV4dCwgcHJvdmlkZXJGaWJlcikgewogICAgICAgICAgICB2YXIgY3VycmVudFZhbHVlID0gdmFsdWVDdXJzb3IuY3VycmVudDsKICAgICAgICAgICAgcG9wKHZhbHVlQ3Vyc29yLCBwcm92aWRlckZpYmVyKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbnRleHQuX2N1cnJlbnRWYWx1ZSA9IGN1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlQ29udGV4dFdvcmtPblBhcmVudFBhdGgocGFyZW50LCByZW5kZXJMYW5lczIsIHByb3BhZ2F0aW9uUm9vdCkgewogICAgICAgICAgICB2YXIgbm9kZSA9IHBhcmVudDsKICAgICAgICAgICAgd2hpbGUgKG5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gbm9kZS5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgaWYgKCFpc1N1YnNldE9mTGFuZXMobm9kZS5jaGlsZExhbmVzLCByZW5kZXJMYW5lczIpKSB7CiAgICAgICAgICAgICAgICBub2RlLmNoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKG5vZGUuY2hpbGRMYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIGlmIChhbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgYWx0ZXJuYXRlLmNoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKGFsdGVybmF0ZS5jaGlsZExhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoYWx0ZXJuYXRlICE9PSBudWxsICYmICFpc1N1YnNldE9mTGFuZXMoYWx0ZXJuYXRlLmNoaWxkTGFuZXMsIHJlbmRlckxhbmVzMikpIHsKICAgICAgICAgICAgICAgIGFsdGVybmF0ZS5jaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhhbHRlcm5hdGUuY2hpbGRMYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IHByb3BhZ2F0aW9uUm9vdCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKG5vZGUgIT09IHByb3BhZ2F0aW9uUm9vdCkgewogICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHRvIGZpbmQgdGhlIHByb3BhZ2F0aW9uIHJvb3Qgd2hlbiBzY2hlZHVsaW5nIGNvbnRleHQgd29yay4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHByb3BhZ2F0ZUNvbnRleHRDaGFuZ2Uod29ya0luUHJvZ3Jlc3MyLCBjb250ZXh0LCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHByb3BhZ2F0ZUNvbnRleHRDaGFuZ2VfZWFnZXIod29ya0luUHJvZ3Jlc3MyLCBjb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwcm9wYWdhdGVDb250ZXh0Q2hhbmdlX2VhZ2VyKHdvcmtJblByb2dyZXNzMiwgY29udGV4dCwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgaWYgKGZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmliZXIucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlIChmaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBuZXh0RmliZXIgPSB2b2lkIDA7CiAgICAgICAgICAgICAgdmFyIGxpc3QgPSBmaWJlci5kZXBlbmRlbmNpZXM7CiAgICAgICAgICAgICAgaWYgKGxpc3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG5leHRGaWJlciA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICAgICAgdmFyIGRlcGVuZGVuY3kgPSBsaXN0LmZpcnN0Q29udGV4dDsKICAgICAgICAgICAgICAgIHdoaWxlIChkZXBlbmRlbmN5ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGlmIChkZXBlbmRlbmN5LmNvbnRleHQgPT09IGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGxhbmUgPSBwaWNrQXJiaXRyYXJ5TGFuZShyZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShOb1RpbWVzdGFtcCwgbGFuZSk7CiAgICAgICAgICAgICAgICAgICAgICB1cGRhdGUudGFnID0gRm9yY2VVcGRhdGU7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBmaWJlci51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgICAgICAgIGlmICh1cGRhdGVRdWV1ZSA9PT0gbnVsbCkKICAgICAgICAgICAgICAgICAgICAgICAgOwogICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzaGFyZWRRdWV1ZSA9IHVwZGF0ZVF1ZXVlLnNoYXJlZDsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBlbmRpbmcgPSBzaGFyZWRRdWV1ZS5wZW5kaW5nOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAocGVuZGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gcGVuZGluZy5uZXh0OwogICAgICAgICAgICAgICAgICAgICAgICAgIHBlbmRpbmcubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBzaGFyZWRRdWV1ZS5wZW5kaW5nID0gdXBkYXRlOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBmaWJlci5sYW5lcyA9IG1lcmdlTGFuZXMoZmliZXIubGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICBhbHRlcm5hdGUubGFuZXMgPSBtZXJnZUxhbmVzKGFsdGVybmF0ZS5sYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVDb250ZXh0V29ya09uUGFyZW50UGF0aChmaWJlci5yZXR1cm4sIHJlbmRlckxhbmVzMiwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgICAgICBsaXN0LmxhbmVzID0gbWVyZ2VMYW5lcyhsaXN0LmxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGRlcGVuZGVuY3kgPSBkZXBlbmRlbmN5Lm5leHQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChmaWJlci50YWcgPT09IENvbnRleHRQcm92aWRlcikgewogICAgICAgICAgICAgICAgbmV4dEZpYmVyID0gZmliZXIudHlwZSA9PT0gd29ya0luUHJvZ3Jlc3MyLnR5cGUgPyBudWxsIDogZmliZXIuY2hpbGQ7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChmaWJlci50YWcgPT09IERlaHlkcmF0ZWRGcmFnbWVudCkgewogICAgICAgICAgICAgICAgdmFyIHBhcmVudFN1c3BlbnNlID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICAgICAgaWYgKHBhcmVudFN1c3BlbnNlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiV2UganVzdCBjYW1lIGZyb20gYSBwYXJlbnQgc28gd2UgbXVzdCBoYXZlIGhhZCBhIHBhcmVudC4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBhcmVudFN1c3BlbnNlLmxhbmVzID0gbWVyZ2VMYW5lcyhwYXJlbnRTdXNwZW5zZS5sYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIHZhciBfYWx0ZXJuYXRlID0gcGFyZW50U3VzcGVuc2UuYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgaWYgKF9hbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgX2FsdGVybmF0ZS5sYW5lcyA9IG1lcmdlTGFuZXMoX2FsdGVybmF0ZS5sYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNjaGVkdWxlQ29udGV4dFdvcmtPblBhcmVudFBhdGgocGFyZW50U3VzcGVuc2UsIHJlbmRlckxhbmVzMiwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIG5leHRGaWJlciA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5leHRGaWJlciA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobmV4dEZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBuZXh0RmliZXIucmV0dXJuID0gZmliZXI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5leHRGaWJlciA9IGZpYmVyOwogICAgICAgICAgICAgICAgd2hpbGUgKG5leHRGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBpZiAobmV4dEZpYmVyID09PSB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgICAgICAgICAgICBuZXh0RmliZXIgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBzaWJsaW5nID0gbmV4dEZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBuZXh0RmliZXIucmV0dXJuOwogICAgICAgICAgICAgICAgICAgIG5leHRGaWJlciA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgbmV4dEZpYmVyID0gbmV4dEZpYmVyLnJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZmliZXIgPSBuZXh0RmliZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHByZXBhcmVUb1JlYWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICBsYXN0Q29udGV4dERlcGVuZGVuY3kgPSBudWxsOwogICAgICAgICAgICBsYXN0RnVsbHlPYnNlcnZlZENvbnRleHQgPSBudWxsOwogICAgICAgICAgICB2YXIgZGVwZW5kZW5jaWVzID0gd29ya0luUHJvZ3Jlc3MyLmRlcGVuZGVuY2llczsKICAgICAgICAgICAgaWYgKGRlcGVuZGVuY2llcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBmaXJzdENvbnRleHQgPSBkZXBlbmRlbmNpZXMuZmlyc3RDb250ZXh0OwogICAgICAgICAgICAgICAgaWYgKGZpcnN0Q29udGV4dCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBpZiAoaW5jbHVkZXNTb21lTGFuZShkZXBlbmRlbmNpZXMubGFuZXMsIHJlbmRlckxhbmVzMikpIHsKICAgICAgICAgICAgICAgICAgICBtYXJrV29ya0luUHJvZ3Jlc3NSZWNlaXZlZFVwZGF0ZSgpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGRlcGVuZGVuY2llcy5maXJzdENvbnRleHQgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVhZENvbnRleHQoY29udGV4dCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGlzRGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJDb250ZXh0IGNhbiBvbmx5IGJlIHJlYWQgd2hpbGUgUmVhY3QgaXMgcmVuZGVyaW5nLiBJbiBjbGFzc2VzLCB5b3UgY2FuIHJlYWQgaXQgaW4gdGhlIHJlbmRlciBtZXRob2Qgb3IgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLiBJbiBmdW5jdGlvbiBjb21wb25lbnRzLCB5b3UgY2FuIHJlYWQgaXQgZGlyZWN0bHkgaW4gdGhlIGZ1bmN0aW9uIGJvZHksIGJ1dCBub3QgaW5zaWRlIEhvb2tzIGxpa2UgdXNlUmVkdWNlcigpIG9yIHVzZU1lbW8oKS4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHZhbHVlID0gY29udGV4dC5fY3VycmVudFZhbHVlOwogICAgICAgICAgICBpZiAobGFzdEZ1bGx5T2JzZXJ2ZWRDb250ZXh0ID09PSBjb250ZXh0KQogICAgICAgICAgICAgIDsKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGNvbnRleHRJdGVtID0gewogICAgICAgICAgICAgICAgY29udGV4dCwKICAgICAgICAgICAgICAgIG1lbW9pemVkVmFsdWU6IHZhbHVlLAogICAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgaWYgKGxhc3RDb250ZXh0RGVwZW5kZW5jeSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ29udGV4dCBjYW4gb25seSBiZSByZWFkIHdoaWxlIFJlYWN0IGlzIHJlbmRlcmluZy4gSW4gY2xhc3NlcywgeW91IGNhbiByZWFkIGl0IGluIHRoZSByZW5kZXIgbWV0aG9kIG9yIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcy4gSW4gZnVuY3Rpb24gY29tcG9uZW50cywgeW91IGNhbiByZWFkIGl0IGRpcmVjdGx5IGluIHRoZSBmdW5jdGlvbiBib2R5LCBidXQgbm90IGluc2lkZSBIb29rcyBsaWtlIHVzZVJlZHVjZXIoKSBvciB1c2VNZW1vKCkuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsYXN0Q29udGV4dERlcGVuZGVuY3kgPSBjb250ZXh0SXRlbTsKICAgICAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyLmRlcGVuZGVuY2llcyA9IHsKICAgICAgICAgICAgICAgICAgbGFuZXM6IE5vTGFuZXMsCiAgICAgICAgICAgICAgICAgIGZpcnN0Q29udGV4dDogY29udGV4dEl0ZW0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGxhc3RDb250ZXh0RGVwZW5kZW5jeSA9IGxhc3RDb250ZXh0RGVwZW5kZW5jeS5uZXh0ID0gY29udGV4dEl0ZW07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjb25jdXJyZW50UXVldWVzID0gbnVsbDsKICAgICAgICAgIGZ1bmN0aW9uIHB1c2hDb25jdXJyZW50VXBkYXRlUXVldWUocXVldWUpIHsKICAgICAgICAgICAgaWYgKGNvbmN1cnJlbnRRdWV1ZXMgPT09IG51bGwpIHsKICAgICAgICAgICAgICBjb25jdXJyZW50UXVldWVzID0gW3F1ZXVlXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb25jdXJyZW50UXVldWVzLnB1c2gocXVldWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBmaW5pc2hRdWV1ZWluZ0NvbmN1cnJlbnRVcGRhdGVzKCkgewogICAgICAgICAgICBpZiAoY29uY3VycmVudFF1ZXVlcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY29uY3VycmVudFF1ZXVlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIHF1ZXVlID0gY29uY3VycmVudFF1ZXVlc1tpXTsKICAgICAgICAgICAgICAgIHZhciBsYXN0SW50ZXJsZWF2ZWRVcGRhdGUgPSBxdWV1ZS5pbnRlcmxlYXZlZDsKICAgICAgICAgICAgICAgIGlmIChsYXN0SW50ZXJsZWF2ZWRVcGRhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcXVldWUuaW50ZXJsZWF2ZWQgPSBudWxsOwogICAgICAgICAgICAgICAgICB2YXIgZmlyc3RJbnRlcmxlYXZlZFVwZGF0ZSA9IGxhc3RJbnRlcmxlYXZlZFVwZGF0ZS5uZXh0OwogICAgICAgICAgICAgICAgICB2YXIgbGFzdFBlbmRpbmdVcGRhdGUgPSBxdWV1ZS5wZW5kaW5nOwogICAgICAgICAgICAgICAgICBpZiAobGFzdFBlbmRpbmdVcGRhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZmlyc3RQZW5kaW5nVXBkYXRlID0gbGFzdFBlbmRpbmdVcGRhdGUubmV4dDsKICAgICAgICAgICAgICAgICAgICBsYXN0UGVuZGluZ1VwZGF0ZS5uZXh0ID0gZmlyc3RJbnRlcmxlYXZlZFVwZGF0ZTsKICAgICAgICAgICAgICAgICAgICBsYXN0SW50ZXJsZWF2ZWRVcGRhdGUubmV4dCA9IGZpcnN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBxdWV1ZS5wZW5kaW5nID0gbGFzdEludGVybGVhdmVkVXBkYXRlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb25jdXJyZW50UXVldWVzID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZUNvbmN1cnJlbnRIb29rVXBkYXRlKGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKSB7CiAgICAgICAgICAgIHZhciBpbnRlcmxlYXZlZCA9IHF1ZXVlLmludGVybGVhdmVkOwogICAgICAgICAgICBpZiAoaW50ZXJsZWF2ZWQgPT09IG51bGwpIHsKICAgICAgICAgICAgICB1cGRhdGUubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgICBwdXNoQ29uY3VycmVudFVwZGF0ZVF1ZXVlKHF1ZXVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB1cGRhdGUubmV4dCA9IGludGVybGVhdmVkLm5leHQ7CiAgICAgICAgICAgICAgaW50ZXJsZWF2ZWQubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBxdWV1ZS5pbnRlcmxlYXZlZCA9IHVwZGF0ZTsKICAgICAgICAgICAgcmV0dXJuIG1hcmtVcGRhdGVMYW5lRnJvbUZpYmVyVG9Sb290KGZpYmVyLCBsYW5lKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGVucXVldWVDb25jdXJyZW50SG9va1VwZGF0ZUFuZEVhZ2VybHlCYWlsb3V0KGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKSB7CiAgICAgICAgICAgIHZhciBpbnRlcmxlYXZlZCA9IHF1ZXVlLmludGVybGVhdmVkOwogICAgICAgICAgICBpZiAoaW50ZXJsZWF2ZWQgPT09IG51bGwpIHsKICAgICAgICAgICAgICB1cGRhdGUubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgICBwdXNoQ29uY3VycmVudFVwZGF0ZVF1ZXVlKHF1ZXVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB1cGRhdGUubmV4dCA9IGludGVybGVhdmVkLm5leHQ7CiAgICAgICAgICAgICAgaW50ZXJsZWF2ZWQubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBxdWV1ZS5pbnRlcmxlYXZlZCA9IHVwZGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGVucXVldWVDb25jdXJyZW50Q2xhc3NVcGRhdGUoZmliZXIsIHF1ZXVlLCB1cGRhdGUsIGxhbmUpIHsKICAgICAgICAgICAgdmFyIGludGVybGVhdmVkID0gcXVldWUuaW50ZXJsZWF2ZWQ7CiAgICAgICAgICAgIGlmIChpbnRlcmxlYXZlZCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICAgIHB1c2hDb25jdXJyZW50VXBkYXRlUXVldWUocXVldWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gaW50ZXJsZWF2ZWQubmV4dDsKICAgICAgICAgICAgICBpbnRlcmxlYXZlZC5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHF1ZXVlLmludGVybGVhdmVkID0gdXBkYXRlOwogICAgICAgICAgICByZXR1cm4gbWFya1VwZGF0ZUxhbmVGcm9tRmliZXJUb1Jvb3QoZmliZXIsIGxhbmUpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBsYW5lKSB7CiAgICAgICAgICAgIHJldHVybiBtYXJrVXBkYXRlTGFuZUZyb21GaWJlclRvUm9vdChmaWJlciwgbGFuZSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdW5zYWZlX21hcmtVcGRhdGVMYW5lRnJvbUZpYmVyVG9Sb290ID0gbWFya1VwZGF0ZUxhbmVGcm9tRmliZXJUb1Jvb3Q7CiAgICAgICAgICBmdW5jdGlvbiBtYXJrVXBkYXRlTGFuZUZyb21GaWJlclRvUm9vdChzb3VyY2VGaWJlciwgbGFuZSkgewogICAgICAgICAgICBzb3VyY2VGaWJlci5sYW5lcyA9IG1lcmdlTGFuZXMoc291cmNlRmliZXIubGFuZXMsIGxhbmUpOwogICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gc291cmNlRmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgYWx0ZXJuYXRlLmxhbmVzID0gbWVyZ2VMYW5lcyhhbHRlcm5hdGUubGFuZXMsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoYWx0ZXJuYXRlID09PSBudWxsICYmIChzb3VyY2VGaWJlci5mbGFncyAmIChQbGFjZW1lbnQgfCBIeWRyYXRpbmcpKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgd2FybkFib3V0VXBkYXRlT25Ob3RZZXRNb3VudGVkRmliZXJJbkRFVihzb3VyY2VGaWJlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBub2RlID0gc291cmNlRmliZXI7CiAgICAgICAgICAgIHZhciBwYXJlbnQgPSBzb3VyY2VGaWJlci5yZXR1cm47CiAgICAgICAgICAgIHdoaWxlIChwYXJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBwYXJlbnQuY2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMocGFyZW50LmNoaWxkTGFuZXMsIGxhbmUpOwogICAgICAgICAgICAgIGFsdGVybmF0ZSA9IHBhcmVudC5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgYWx0ZXJuYXRlLmNoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKGFsdGVybmF0ZS5jaGlsZExhbmVzLCBsYW5lKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKHBhcmVudC5mbGFncyAmIChQbGFjZW1lbnQgfCBIeWRyYXRpbmcpKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgICAgIHdhcm5BYm91dFVwZGF0ZU9uTm90WWV0TW91bnRlZEZpYmVySW5ERVYoc291cmNlRmliZXIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBwYXJlbnQ7CiAgICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50LnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RSb290KSB7CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgcmV0dXJuIHJvb3QzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgVXBkYXRlU3RhdGUgPSAwOwogICAgICAgICAgdmFyIFJlcGxhY2VTdGF0ZSA9IDE7CiAgICAgICAgICB2YXIgRm9yY2VVcGRhdGUgPSAyOwogICAgICAgICAgdmFyIENhcHR1cmVVcGRhdGUgPSAzOwogICAgICAgICAgdmFyIGhhc0ZvcmNlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICB2YXIgZGlkV2FyblVwZGF0ZUluc2lkZVVwZGF0ZTsKICAgICAgICAgIHZhciBjdXJyZW50bHlQcm9jZXNzaW5nUXVldWU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGRpZFdhcm5VcGRhdGVJbnNpZGVVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgY3VycmVudGx5UHJvY2Vzc2luZ1F1ZXVlID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGluaXRpYWxpemVVcGRhdGVRdWV1ZShmaWJlcikgewogICAgICAgICAgICB2YXIgcXVldWUgPSB7CiAgICAgICAgICAgICAgYmFzZVN0YXRlOiBmaWJlci5tZW1vaXplZFN0YXRlLAogICAgICAgICAgICAgIGZpcnN0QmFzZVVwZGF0ZTogbnVsbCwKICAgICAgICAgICAgICBsYXN0QmFzZVVwZGF0ZTogbnVsbCwKICAgICAgICAgICAgICBzaGFyZWQ6IHsKICAgICAgICAgICAgICAgIHBlbmRpbmc6IG51bGwsCiAgICAgICAgICAgICAgICBpbnRlcmxlYXZlZDogbnVsbCwKICAgICAgICAgICAgICAgIGxhbmVzOiBOb0xhbmVzCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBlZmZlY3RzOiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGZpYmVyLnVwZGF0ZVF1ZXVlID0gcXVldWU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjbG9uZVVwZGF0ZVF1ZXVlKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgICAgdmFyIHF1ZXVlID0gd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICB2YXIgY3VycmVudFF1ZXVlID0gY3VycmVudDIudXBkYXRlUXVldWU7CiAgICAgICAgICAgIGlmIChxdWV1ZSA9PT0gY3VycmVudFF1ZXVlKSB7CiAgICAgICAgICAgICAgdmFyIGNsb25lID0gewogICAgICAgICAgICAgICAgYmFzZVN0YXRlOiBjdXJyZW50UXVldWUuYmFzZVN0YXRlLAogICAgICAgICAgICAgICAgZmlyc3RCYXNlVXBkYXRlOiBjdXJyZW50UXVldWUuZmlyc3RCYXNlVXBkYXRlLAogICAgICAgICAgICAgICAgbGFzdEJhc2VVcGRhdGU6IGN1cnJlbnRRdWV1ZS5sYXN0QmFzZVVwZGF0ZSwKICAgICAgICAgICAgICAgIHNoYXJlZDogY3VycmVudFF1ZXVlLnNoYXJlZCwKICAgICAgICAgICAgICAgIGVmZmVjdHM6IGN1cnJlbnRRdWV1ZS5lZmZlY3RzCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBjbG9uZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY3JlYXRlVXBkYXRlKGV2ZW50VGltZSwgbGFuZSkgewogICAgICAgICAgICB2YXIgdXBkYXRlID0gewogICAgICAgICAgICAgIGV2ZW50VGltZSwKICAgICAgICAgICAgICBsYW5lLAogICAgICAgICAgICAgIHRhZzogVXBkYXRlU3RhdGUsCiAgICAgICAgICAgICAgcGF5bG9hZDogbnVsbCwKICAgICAgICAgICAgICBjYWxsYmFjazogbnVsbCwKICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJldHVybiB1cGRhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlVXBkYXRlKGZpYmVyLCB1cGRhdGUsIGxhbmUpIHsKICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gZmliZXIudXBkYXRlUXVldWU7CiAgICAgICAgICAgIGlmICh1cGRhdGVRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzaGFyZWRRdWV1ZSA9IHVwZGF0ZVF1ZXVlLnNoYXJlZDsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChjdXJyZW50bHlQcm9jZXNzaW5nUXVldWUgPT09IHNoYXJlZFF1ZXVlICYmICFkaWRXYXJuVXBkYXRlSW5zaWRlVXBkYXRlKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiQW4gdXBkYXRlIChzZXRTdGF0ZSwgcmVwbGFjZVN0YXRlLCBvciBmb3JjZVVwZGF0ZSkgd2FzIHNjaGVkdWxlZCBmcm9tIGluc2lkZSBhbiB1cGRhdGUgZnVuY3Rpb24uIFVwZGF0ZSBmdW5jdGlvbnMgc2hvdWxkIGJlIHB1cmUsIHdpdGggemVybyBzaWRlLWVmZmVjdHMuIENvbnNpZGVyIHVzaW5nIGNvbXBvbmVudERpZFVwZGF0ZSBvciBhIGNhbGxiYWNrLiIpOwogICAgICAgICAgICAgICAgZGlkV2FyblVwZGF0ZUluc2lkZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc1Vuc2FmZUNsYXNzUmVuZGVyUGhhc2VVcGRhdGUoKSkgewogICAgICAgICAgICAgIHZhciBwZW5kaW5nID0gc2hhcmVkUXVldWUucGVuZGluZzsKICAgICAgICAgICAgICBpZiAocGVuZGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdXBkYXRlLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gcGVuZGluZy5uZXh0OwogICAgICAgICAgICAgICAgcGVuZGluZy5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzaGFyZWRRdWV1ZS5wZW5kaW5nID0gdXBkYXRlOwogICAgICAgICAgICAgIHJldHVybiB1bnNhZmVfbWFya1VwZGF0ZUxhbmVGcm9tRmliZXJUb1Jvb3QoZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBlbnF1ZXVlQ29uY3VycmVudENsYXNzVXBkYXRlKGZpYmVyLCBzaGFyZWRRdWV1ZSwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZW50YW5nbGVUcmFuc2l0aW9ucyhyb290MywgZmliZXIsIGxhbmUpIHsKICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gZmliZXIudXBkYXRlUXVldWU7CiAgICAgICAgICAgIGlmICh1cGRhdGVRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2hhcmVkUXVldWUgPSB1cGRhdGVRdWV1ZS5zaGFyZWQ7CiAgICAgICAgICAgIGlmIChpc1RyYW5zaXRpb25MYW5lKGxhbmUpKSB7CiAgICAgICAgICAgICAgdmFyIHF1ZXVlTGFuZXMgPSBzaGFyZWRRdWV1ZS5sYW5lczsKICAgICAgICAgICAgICBxdWV1ZUxhbmVzID0gaW50ZXJzZWN0TGFuZXMocXVldWVMYW5lcywgcm9vdDMucGVuZGluZ0xhbmVzKTsKICAgICAgICAgICAgICB2YXIgbmV3UXVldWVMYW5lcyA9IG1lcmdlTGFuZXMocXVldWVMYW5lcywgbGFuZSk7CiAgICAgICAgICAgICAgc2hhcmVkUXVldWUubGFuZXMgPSBuZXdRdWV1ZUxhbmVzOwogICAgICAgICAgICAgIG1hcmtSb290RW50YW5nbGVkKHJvb3QzLCBuZXdRdWV1ZUxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZUNhcHR1cmVkVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgY2FwdHVyZWRVcGRhdGUpIHsKICAgICAgICAgICAgdmFyIHF1ZXVlID0gd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICB2YXIgY3VycmVudDIgPSB3b3JrSW5Qcm9ncmVzczIuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgY3VycmVudFF1ZXVlID0gY3VycmVudDIudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgaWYgKHF1ZXVlID09PSBjdXJyZW50UXVldWUpIHsKICAgICAgICAgICAgICAgIHZhciBuZXdGaXJzdCA9IG51bGw7CiAgICAgICAgICAgICAgICB2YXIgbmV3TGFzdCA9IG51bGw7CiAgICAgICAgICAgICAgICB2YXIgZmlyc3RCYXNlVXBkYXRlID0gcXVldWUuZmlyc3RCYXNlVXBkYXRlOwogICAgICAgICAgICAgICAgaWYgKGZpcnN0QmFzZVVwZGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgdXBkYXRlID0gZmlyc3RCYXNlVXBkYXRlOwogICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNsb25lID0gewogICAgICAgICAgICAgICAgICAgICAgZXZlbnRUaW1lOiB1cGRhdGUuZXZlbnRUaW1lLAogICAgICAgICAgICAgICAgICAgICAgbGFuZTogdXBkYXRlLmxhbmUsCiAgICAgICAgICAgICAgICAgICAgICB0YWc6IHVwZGF0ZS50YWcsCiAgICAgICAgICAgICAgICAgICAgICBwYXlsb2FkOiB1cGRhdGUucGF5bG9hZCwKICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrOiB1cGRhdGUuY2FsbGJhY2ssCiAgICAgICAgICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBpZiAobmV3TGFzdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgbmV3Rmlyc3QgPSBuZXdMYXN0ID0gY2xvbmU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIG5ld0xhc3QubmV4dCA9IGNsb25lOwogICAgICAgICAgICAgICAgICAgICAgbmV3TGFzdCA9IGNsb25lOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB1cGRhdGUgPSB1cGRhdGUubmV4dDsKICAgICAgICAgICAgICAgICAgfSB3aGlsZSAodXBkYXRlICE9PSBudWxsKTsKICAgICAgICAgICAgICAgICAgaWYgKG5ld0xhc3QgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBuZXdGaXJzdCA9IG5ld0xhc3QgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBuZXdMYXN0Lm5leHQgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICAgICAgICAgICAgICBuZXdMYXN0ID0gY2FwdHVyZWRVcGRhdGU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIG5ld0ZpcnN0ID0gbmV3TGFzdCA9IGNhcHR1cmVkVXBkYXRlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcXVldWUgPSB7CiAgICAgICAgICAgICAgICAgIGJhc2VTdGF0ZTogY3VycmVudFF1ZXVlLmJhc2VTdGF0ZSwKICAgICAgICAgICAgICAgICAgZmlyc3RCYXNlVXBkYXRlOiBuZXdGaXJzdCwKICAgICAgICAgICAgICAgICAgbGFzdEJhc2VVcGRhdGU6IG5ld0xhc3QsCiAgICAgICAgICAgICAgICAgIHNoYXJlZDogY3VycmVudFF1ZXVlLnNoYXJlZCwKICAgICAgICAgICAgICAgICAgZWZmZWN0czogY3VycmVudFF1ZXVlLmVmZmVjdHMKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBxdWV1ZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGxhc3RCYXNlVXBkYXRlID0gcXVldWUubGFzdEJhc2VVcGRhdGU7CiAgICAgICAgICAgIGlmIChsYXN0QmFzZVVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHF1ZXVlLmZpcnN0QmFzZVVwZGF0ZSA9IGNhcHR1cmVkVXBkYXRlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGxhc3RCYXNlVXBkYXRlLm5leHQgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBxdWV1ZS5sYXN0QmFzZVVwZGF0ZSA9IGNhcHR1cmVkVXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0U3RhdGVGcm9tVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgcXVldWUsIHVwZGF0ZSwgcHJldlN0YXRlLCBuZXh0UHJvcHMsIGluc3RhbmNlKSB7CiAgICAgICAgICAgIHN3aXRjaCAodXBkYXRlLnRhZykgewogICAgICAgICAgICAgIGNhc2UgUmVwbGFjZVN0YXRlOiB7CiAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IHVwZGF0ZS5wYXlsb2FkOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwYXlsb2FkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBlbnRlckRpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIG5leHRTdGF0ZSA9IHBheWxvYWQuY2FsbChpbnN0YW5jZSwgcHJldlN0YXRlLCBuZXh0UHJvcHMpOwogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBwYXlsb2FkLmNhbGwoaW5zdGFuY2UsIHByZXZTdGF0ZSwgbmV4dFByb3BzKTsKICAgICAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZXhpdERpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIG5leHRTdGF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBwYXlsb2FkOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENhcHR1cmVVcGRhdGU6IHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyA9IHdvcmtJblByb2dyZXNzMi5mbGFncyAmIH5TaG91bGRDYXB0dXJlIHwgRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBVcGRhdGVTdGF0ZTogewogICAgICAgICAgICAgICAgdmFyIF9wYXlsb2FkID0gdXBkYXRlLnBheWxvYWQ7CiAgICAgICAgICAgICAgICB2YXIgcGFydGlhbFN0YXRlOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBfcGF5bG9hZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZW50ZXJEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFVigpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHBhcnRpYWxTdGF0ZSA9IF9wYXlsb2FkLmNhbGwoaW5zdGFuY2UsIHByZXZTdGF0ZSwgbmV4dFByb3BzKTsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgX3BheWxvYWQuY2FsbChpbnN0YW5jZSwgcHJldlN0YXRlLCBuZXh0UHJvcHMpOwogICAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBleGl0RGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYoKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcGFydGlhbFN0YXRlID0gX3BheWxvYWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocGFydGlhbFN0YXRlID09PSBudWxsIHx8IHBhcnRpYWxTdGF0ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBwcmV2U3RhdGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gYXNzaWduKHt9LCBwcmV2U3RhdGUsIHBhcnRpYWxTdGF0ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgRm9yY2VVcGRhdGU6IHsKICAgICAgICAgICAgICAgIGhhc0ZvcmNlVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiBwcmV2U3RhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwcmV2U3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwcm9jZXNzVXBkYXRlUXVldWUod29ya0luUHJvZ3Jlc3MyLCBwcm9wcywgaW5zdGFuY2UsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgICB2YXIgcXVldWUgPSB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWU7CiAgICAgICAgICAgIGhhc0ZvcmNlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjdXJyZW50bHlQcm9jZXNzaW5nUXVldWUgPSBxdWV1ZS5zaGFyZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGZpcnN0QmFzZVVwZGF0ZSA9IHF1ZXVlLmZpcnN0QmFzZVVwZGF0ZTsKICAgICAgICAgICAgdmFyIGxhc3RCYXNlVXBkYXRlID0gcXVldWUubGFzdEJhc2VVcGRhdGU7CiAgICAgICAgICAgIHZhciBwZW5kaW5nUXVldWUgPSBxdWV1ZS5zaGFyZWQucGVuZGluZzsKICAgICAgICAgICAgaWYgKHBlbmRpbmdRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHF1ZXVlLnNoYXJlZC5wZW5kaW5nID0gbnVsbDsKICAgICAgICAgICAgICB2YXIgbGFzdFBlbmRpbmdVcGRhdGUgPSBwZW5kaW5nUXVldWU7CiAgICAgICAgICAgICAgdmFyIGZpcnN0UGVuZGluZ1VwZGF0ZSA9IGxhc3RQZW5kaW5nVXBkYXRlLm5leHQ7CiAgICAgICAgICAgICAgbGFzdFBlbmRpbmdVcGRhdGUubmV4dCA9IG51bGw7CiAgICAgICAgICAgICAgaWYgKGxhc3RCYXNlVXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBmaXJzdEJhc2VVcGRhdGUgPSBmaXJzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGxhc3RCYXNlVXBkYXRlLm5leHQgPSBmaXJzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGxhc3RCYXNlVXBkYXRlID0gbGFzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnQyID0gd29ya0luUHJvZ3Jlc3MyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBjdXJyZW50UXVldWUgPSBjdXJyZW50Mi51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgIHZhciBjdXJyZW50TGFzdEJhc2VVcGRhdGUgPSBjdXJyZW50UXVldWUubGFzdEJhc2VVcGRhdGU7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudExhc3RCYXNlVXBkYXRlICE9PSBsYXN0QmFzZVVwZGF0ZSkgewogICAgICAgICAgICAgICAgICBpZiAoY3VycmVudExhc3RCYXNlVXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudFF1ZXVlLmZpcnN0QmFzZVVwZGF0ZSA9IGZpcnN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50TGFzdEJhc2VVcGRhdGUubmV4dCA9IGZpcnN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjdXJyZW50UXVldWUubGFzdEJhc2VVcGRhdGUgPSBsYXN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZpcnN0QmFzZVVwZGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IHF1ZXVlLmJhc2VTdGF0ZTsKICAgICAgICAgICAgICB2YXIgbmV3TGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICAgIHZhciBuZXdCYXNlU3RhdGUgPSBudWxsOwogICAgICAgICAgICAgIHZhciBuZXdGaXJzdEJhc2VVcGRhdGUgPSBudWxsOwogICAgICAgICAgICAgIHZhciBuZXdMYXN0QmFzZVVwZGF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGZpcnN0QmFzZVVwZGF0ZTsKICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlTGFuZSA9IHVwZGF0ZS5sYW5lOwogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZUV2ZW50VGltZSA9IHVwZGF0ZS5ldmVudFRpbWU7CiAgICAgICAgICAgICAgICBpZiAoIWlzU3Vic2V0T2ZMYW5lcyhyZW5kZXJMYW5lczIsIHVwZGF0ZUxhbmUpKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjbG9uZSA9IHsKICAgICAgICAgICAgICAgICAgICBldmVudFRpbWU6IHVwZGF0ZUV2ZW50VGltZSwKICAgICAgICAgICAgICAgICAgICBsYW5lOiB1cGRhdGVMYW5lLAogICAgICAgICAgICAgICAgICAgIHRhZzogdXBkYXRlLnRhZywKICAgICAgICAgICAgICAgICAgICBwYXlsb2FkOiB1cGRhdGUucGF5bG9hZCwKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogdXBkYXRlLmNhbGxiYWNrLAogICAgICAgICAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgaWYgKG5ld0xhc3RCYXNlVXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgbmV3Rmlyc3RCYXNlVXBkYXRlID0gbmV3TGFzdEJhc2VVcGRhdGUgPSBjbG9uZTsKICAgICAgICAgICAgICAgICAgICBuZXdCYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBuZXdMYXN0QmFzZVVwZGF0ZSA9IG5ld0xhc3RCYXNlVXBkYXRlLm5leHQgPSBjbG9uZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBuZXdMYW5lcyA9IG1lcmdlTGFuZXMobmV3TGFuZXMsIHVwZGF0ZUxhbmUpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgaWYgKG5ld0xhc3RCYXNlVXBkYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9jbG9uZSA9IHsKICAgICAgICAgICAgICAgICAgICAgIGV2ZW50VGltZTogdXBkYXRlRXZlbnRUaW1lLAogICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyB1cGRhdGUgaXMgZ29pbmcgdG8gYmUgY29tbWl0dGVkIHNvIHdlIG5ldmVyIHdhbnQgdW5jb21taXQKICAgICAgICAgICAgICAgICAgICAgIC8vIGl0LiBVc2luZyBOb0xhbmUgd29ya3MgYmVjYXVzZSAwIGlzIGEgc3Vic2V0IG9mIGFsbCBiaXRtYXNrcywgc28KICAgICAgICAgICAgICAgICAgICAgIC8vIHRoaXMgd2lsbCBuZXZlciBiZSBza2lwcGVkIGJ5IHRoZSBjaGVjayBhYm92ZS4KICAgICAgICAgICAgICAgICAgICAgIGxhbmU6IE5vTGFuZSwKICAgICAgICAgICAgICAgICAgICAgIHRhZzogdXBkYXRlLnRhZywKICAgICAgICAgICAgICAgICAgICAgIHBheWxvYWQ6IHVwZGF0ZS5wYXlsb2FkLAogICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2s6IHVwZGF0ZS5jYWxsYmFjaywKICAgICAgICAgICAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIG5ld0xhc3RCYXNlVXBkYXRlID0gbmV3TGFzdEJhc2VVcGRhdGUubmV4dCA9IF9jbG9uZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBuZXdTdGF0ZSA9IGdldFN0YXRlRnJvbVVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIHF1ZXVlLCB1cGRhdGUsIG5ld1N0YXRlLCBwcm9wcywgaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSB1cGRhdGUuY2FsbGJhY2s7CiAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gbnVsbCAmJiAvLyBJZiB0aGUgdXBkYXRlIHdhcyBhbHJlYWR5IGNvbW1pdHRlZCwgd2Ugc2hvdWxkIG5vdCBxdWV1ZSBpdHMKICAgICAgICAgICAgICAgICAgLy8gY2FsbGJhY2sgYWdhaW4uCiAgICAgICAgICAgICAgICAgIHVwZGF0ZS5sYW5lICE9PSBOb0xhbmUpIHsKICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gQ2FsbGJhY2s7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVmZmVjdHMgPSBxdWV1ZS5lZmZlY3RzOwogICAgICAgICAgICAgICAgICAgIGlmIChlZmZlY3RzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICBxdWV1ZS5lZmZlY3RzID0gW3VwZGF0ZV07CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIGVmZmVjdHMucHVzaCh1cGRhdGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdXBkYXRlID0gdXBkYXRlLm5leHQ7CiAgICAgICAgICAgICAgICBpZiAodXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHBlbmRpbmdRdWV1ZSA9IHF1ZXVlLnNoYXJlZC5wZW5kaW5nOwogICAgICAgICAgICAgICAgICBpZiAocGVuZGluZ1F1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9sYXN0UGVuZGluZ1VwZGF0ZSA9IHBlbmRpbmdRdWV1ZTsKICAgICAgICAgICAgICAgICAgICB2YXIgX2ZpcnN0UGVuZGluZ1VwZGF0ZSA9IF9sYXN0UGVuZGluZ1VwZGF0ZS5uZXh0OwogICAgICAgICAgICAgICAgICAgIF9sYXN0UGVuZGluZ1VwZGF0ZS5uZXh0ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB1cGRhdGUgPSBfZmlyc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICAgICAgICAgIHF1ZXVlLmxhc3RCYXNlVXBkYXRlID0gX2xhc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICAgICAgICAgIHF1ZXVlLnNoYXJlZC5wZW5kaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gd2hpbGUgKHRydWUpOwogICAgICAgICAgICAgIGlmIChuZXdMYXN0QmFzZVVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgbmV3QmFzZVN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHF1ZXVlLmJhc2VTdGF0ZSA9IG5ld0Jhc2VTdGF0ZTsKICAgICAgICAgICAgICBxdWV1ZS5maXJzdEJhc2VVcGRhdGUgPSBuZXdGaXJzdEJhc2VVcGRhdGU7CiAgICAgICAgICAgICAgcXVldWUubGFzdEJhc2VVcGRhdGUgPSBuZXdMYXN0QmFzZVVwZGF0ZTsKICAgICAgICAgICAgICB2YXIgbGFzdEludGVybGVhdmVkID0gcXVldWUuc2hhcmVkLmludGVybGVhdmVkOwogICAgICAgICAgICAgIGlmIChsYXN0SW50ZXJsZWF2ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBpbnRlcmxlYXZlZCA9IGxhc3RJbnRlcmxlYXZlZDsKICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgbmV3TGFuZXMgPSBtZXJnZUxhbmVzKG5ld0xhbmVzLCBpbnRlcmxlYXZlZC5sYW5lKTsKICAgICAgICAgICAgICAgICAgaW50ZXJsZWF2ZWQgPSBpbnRlcmxlYXZlZC5uZXh0OwogICAgICAgICAgICAgICAgfSB3aGlsZSAoaW50ZXJsZWF2ZWQgIT09IGxhc3RJbnRlcmxlYXZlZCk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChmaXJzdEJhc2VVcGRhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHF1ZXVlLnNoYXJlZC5sYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG1hcmtTa2lwcGVkVXBkYXRlTGFuZXMobmV3TGFuZXMpOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IG5ld0xhbmVzOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGN1cnJlbnRseVByb2Nlc3NpbmdRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNhbGxDYWxsYmFjayhjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIGFyZ3VtZW50IHBhc3NlZCBhcyBjYWxsYmFjay4gRXhwZWN0ZWQgYSBmdW5jdGlvbi4gSW5zdGVhZCAiICsgKCJyZWNlaXZlZDogIiArIGNhbGxiYWNrKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FsbGJhY2suY2FsbChjb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlc2V0SGFzRm9yY2VVcGRhdGVCZWZvcmVQcm9jZXNzaW5nKCkgewogICAgICAgICAgICBoYXNGb3JjZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY2hlY2tIYXNGb3JjZVVwZGF0ZUFmdGVyUHJvY2Vzc2luZygpIHsKICAgICAgICAgICAgcmV0dXJuIGhhc0ZvcmNlVXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY29tbWl0VXBkYXRlUXVldWUoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFF1ZXVlLCBpbnN0YW5jZSkgewogICAgICAgICAgICB2YXIgZWZmZWN0cyA9IGZpbmlzaGVkUXVldWUuZWZmZWN0czsKICAgICAgICAgICAgZmluaXNoZWRRdWV1ZS5lZmZlY3RzID0gbnVsbDsKICAgICAgICAgICAgaWYgKGVmZmVjdHMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGVmZmVjdHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBlZmZlY3QgPSBlZmZlY3RzW2ldOwogICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gZWZmZWN0LmNhbGxiYWNrOwogICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGVmZmVjdC5jYWxsYmFjayA9IG51bGw7CiAgICAgICAgICAgICAgICAgIGNhbGxDYWxsYmFjayhjYWxsYmFjaywgaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGZha2VJbnRlcm5hbEluc3RhbmNlID0ge307CiAgICAgICAgICB2YXIgZW1wdHlSZWZzT2JqZWN0ID0gbmV3IFJlYWN0NS5Db21wb25lbnQoKS5yZWZzOwogICAgICAgICAgdmFyIGRpZFdhcm5BYm91dFN0YXRlQXNzaWdubWVudEZvckNvbXBvbmVudDsKICAgICAgICAgIHZhciBkaWRXYXJuQWJvdXRVbmluaXRpYWxpemVkU3RhdGU7CiAgICAgICAgICB2YXIgZGlkV2FybkFib3V0R2V0U25hcHNob3RCZWZvcmVVcGRhdGVXaXRob3V0RGlkVXBkYXRlOwogICAgICAgICAgdmFyIGRpZFdhcm5BYm91dExlZ2FjeUxpZmVjeWNsZXNBbmREZXJpdmVkU3RhdGU7CiAgICAgICAgICB2YXIgZGlkV2FybkFib3V0VW5kZWZpbmVkRGVyaXZlZFN0YXRlOwogICAgICAgICAgdmFyIHdhcm5PblVuZGVmaW5lZERlcml2ZWRTdGF0ZTsKICAgICAgICAgIHZhciB3YXJuT25JbnZhbGlkQ2FsbGJhY2s7CiAgICAgICAgICB2YXIgZGlkV2FybkFib3V0RGlyZWN0bHlBc3NpZ25pbmdQcm9wc1RvU3RhdGU7CiAgICAgICAgICB2YXIgZGlkV2FybkFib3V0Q29udGV4dFR5cGVBbmRDb250ZXh0VHlwZXM7CiAgICAgICAgICB2YXIgZGlkV2FybkFib3V0SW52YWxpZGF0ZUNvbnRleHRUeXBlOwogICAgICAgICAgewogICAgICAgICAgICBkaWRXYXJuQWJvdXRTdGF0ZUFzc2lnbm1lbnRGb3JDb21wb25lbnQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBkaWRXYXJuQWJvdXRVbmluaXRpYWxpemVkU3RhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBkaWRXYXJuQWJvdXRHZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZVdpdGhvdXREaWRVcGRhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBkaWRXYXJuQWJvdXRMZWdhY3lMaWZlY3ljbGVzQW5kRGVyaXZlZFN0YXRlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgZGlkV2FybkFib3V0RGlyZWN0bHlBc3NpZ25pbmdQcm9wc1RvU3RhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBkaWRXYXJuQWJvdXRVbmRlZmluZWREZXJpdmVkU3RhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBkaWRXYXJuQWJvdXRDb250ZXh0VHlwZUFuZENvbnRleHRUeXBlcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgIGRpZFdhcm5BYm91dEludmFsaWRhdGVDb250ZXh0VHlwZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgIHZhciBkaWRXYXJuT25JbnZhbGlkQ2FsbGJhY2sgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICB3YXJuT25JbnZhbGlkQ2FsbGJhY2sgPSBmdW5jdGlvbihjYWxsYmFjaywgY2FsbGVyTmFtZSkgewogICAgICAgICAgICAgIGlmIChjYWxsYmFjayA9PT0gbnVsbCB8fCB0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGtleSA9IGNhbGxlck5hbWUgKyAiXyIgKyBjYWxsYmFjazsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5PbkludmFsaWRDYWxsYmFjay5oYXMoa2V5KSkgewogICAgICAgICAgICAgICAgZGlkV2Fybk9uSW52YWxpZENhbGxiYWNrLmFkZChrZXkpOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzKC4uLik6IEV4cGVjdGVkIHRoZSBsYXN0IG9wdGlvbmFsIGBjYWxsYmFja2AgYXJndW1lbnQgdG8gYmUgYSBmdW5jdGlvbi4gSW5zdGVhZCByZWNlaXZlZDogJXMuIiwgY2FsbGVyTmFtZSwgY2FsbGJhY2spOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgd2Fybk9uVW5kZWZpbmVkRGVyaXZlZFN0YXRlID0gZnVuY3Rpb24odHlwZTIsIHBhcnRpYWxTdGF0ZSkgewogICAgICAgICAgICAgIGlmIChwYXJ0aWFsU3RhdGUgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZTIpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRVbmRlZmluZWREZXJpdmVkU3RhdGUuaGFzKGNvbXBvbmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuZGVmaW5lZERlcml2ZWRTdGF0ZS5hZGQoY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCIlcy5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMoKTogQSB2YWxpZCBzdGF0ZSBvYmplY3QgKG9yIG51bGwpIG11c3QgYmUgcmV0dXJuZWQuIFlvdSBoYXZlIHJldHVybmVkIHVuZGVmaW5lZC4iLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShmYWtlSW50ZXJuYWxJbnN0YW5jZSwgIl9wcm9jZXNzQ2hpbGRDb250ZXh0IiwgewogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiX3Byb2Nlc3NDaGlsZENvbnRleHQgaXMgbm90IGF2YWlsYWJsZSBpbiBSZWFjdCAxNisuIFRoaXMgbGlrZWx5IG1lYW5zIHlvdSBoYXZlIG11bHRpcGxlIGNvcGllcyBvZiBSZWFjdCBhbmQgYXJlIGF0dGVtcHRpbmcgdG8gbmVzdCBhIFJlYWN0IDE1IHRyZWUgaW5zaWRlIGEgUmVhY3QgMTYgdHJlZSB1c2luZyB1bnN0YWJsZV9yZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lciwgd2hpY2ggaXNuJ3Qgc3VwcG9ydGVkLiBUcnkgdG8gbWFrZSBzdXJlIHlvdSBoYXZlIG9ubHkgb25lIGNvcHkgb2YgUmVhY3QgKGFuZCBpZGVhbGx5LCBzd2l0Y2ggdG8gUmVhY3RET00uY3JlYXRlUG9ydGFsKS4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBPYmplY3QuZnJlZXplKGZha2VJbnRlcm5hbEluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGFwcGx5RGVyaXZlZFN0YXRlRnJvbVByb3BzKHdvcmtJblByb2dyZXNzMiwgY3RvciwgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLCBuZXh0UHJvcHMpIHsKICAgICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICB2YXIgcGFydGlhbFN0YXRlID0gZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzKG5leHRQcm9wcywgcHJldlN0YXRlKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcGFydGlhbFN0YXRlID0gZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzKG5leHRQcm9wcywgcHJldlN0YXRlKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2Fybk9uVW5kZWZpbmVkRGVyaXZlZFN0YXRlKGN0b3IsIHBhcnRpYWxTdGF0ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG1lbW9pemVkU3RhdGUgPSBwYXJ0aWFsU3RhdGUgPT09IG51bGwgfHwgcGFydGlhbFN0YXRlID09PSB2b2lkIDAgPyBwcmV2U3RhdGUgOiBhc3NpZ24oe30sIHByZXZTdGF0ZSwgcGFydGlhbFN0YXRlKTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBtZW1vaXplZFN0YXRlOwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLmxhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgIHVwZGF0ZVF1ZXVlLmJhc2VTdGF0ZSA9IG1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjbGFzc0NvbXBvbmVudFVwZGF0ZXIgPSB7CiAgICAgICAgICAgIGlzTW91bnRlZCwKICAgICAgICAgICAgZW5xdWV1ZVNldFN0YXRlOiBmdW5jdGlvbihpbnN0LCBwYXlsb2FkLCBjYWxsYmFjaykgewogICAgICAgICAgICAgIHZhciBmaWJlciA9IGdldDMoaW5zdCk7CiAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKTsKICAgICAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKGV2ZW50VGltZSwgbGFuZSk7CiAgICAgICAgICAgICAgdXBkYXRlLnBheWxvYWQgPSBwYXlsb2FkOwogICAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gdm9pZCAwICYmIGNhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHdhcm5PbkludmFsaWRDYWxsYmFjayhjYWxsYmFjaywgInNldFN0YXRlIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB1cGRhdGUuY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZVVwZGF0ZShmaWJlciwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgICBlbnRhbmdsZVRyYW5zaXRpb25zKHJvb3QzLCBmaWJlciwgbGFuZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1hcmtTdGF0ZVVwZGF0ZVNjaGVkdWxlZChmaWJlciwgbGFuZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBlbnF1ZXVlUmVwbGFjZVN0YXRlOiBmdW5jdGlvbihpbnN0LCBwYXlsb2FkLCBjYWxsYmFjaykgewogICAgICAgICAgICAgIHZhciBmaWJlciA9IGdldDMoaW5zdCk7CiAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKTsKICAgICAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKGV2ZW50VGltZSwgbGFuZSk7CiAgICAgICAgICAgICAgdXBkYXRlLnRhZyA9IFJlcGxhY2VTdGF0ZTsKICAgICAgICAgICAgICB1cGRhdGUucGF5bG9hZCA9IHBheWxvYWQ7CiAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrICE9PSB2b2lkIDAgJiYgY2FsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgd2Fybk9uSW52YWxpZENhbGxiYWNrKGNhbGxiYWNrLCAicmVwbGFjZVN0YXRlIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB1cGRhdGUuY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZVVwZGF0ZShmaWJlciwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgICBlbnRhbmdsZVRyYW5zaXRpb25zKHJvb3QzLCBmaWJlciwgbGFuZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1hcmtTdGF0ZVVwZGF0ZVNjaGVkdWxlZChmaWJlciwgbGFuZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBlbnF1ZXVlRm9yY2VVcGRhdGU6IGZ1bmN0aW9uKGluc3QsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgdmFyIGZpYmVyID0gZ2V0MyhpbnN0KTsKICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoZmliZXIpOwogICAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoZXZlbnRUaW1lLCBsYW5lKTsKICAgICAgICAgICAgICB1cGRhdGUudGFnID0gRm9yY2VVcGRhdGU7CiAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrICE9PSB2b2lkIDAgJiYgY2FsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgd2Fybk9uSW52YWxpZENhbGxiYWNrKGNhbGxiYWNrLCAiZm9yY2VVcGRhdGUiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlVXBkYXRlKGZpYmVyLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICAgIGVudGFuZ2xlVHJhbnNpdGlvbnMocm9vdDMsIGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWFya0ZvcmNlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBmdW5jdGlvbiBjaGVja1Nob3VsZENvbXBvbmVudFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIG9sZFByb3BzLCBuZXdQcm9wcywgb2xkU3RhdGUsIG5ld1N0YXRlLCBuZXh0Q29udGV4dCkgewogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLnNob3VsZENvbXBvbmVudFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBzaG91bGRVcGRhdGUgPSBpbnN0YW5jZS5zaG91bGRDb21wb25lbnRVcGRhdGUobmV3UHJvcHMsIG5ld1N0YXRlLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBzaG91bGRVcGRhdGUgPSBpbnN0YW5jZS5zaG91bGRDb21wb25lbnRVcGRhdGUobmV3UHJvcHMsIG5ld1N0YXRlLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc2hvdWxkVXBkYXRlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzLnNob3VsZENvbXBvbmVudFVwZGF0ZSgpOiBSZXR1cm5lZCB1bmRlZmluZWQgaW5zdGVhZCBvZiBhIGJvb2xlYW4gdmFsdWUuIE1ha2Ugc3VyZSB0byByZXR1cm4gdHJ1ZSBvciBmYWxzZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gc2hvdWxkVXBkYXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjdG9yLnByb3RvdHlwZSAmJiBjdG9yLnByb3RvdHlwZS5pc1B1cmVSZWFjdENvbXBvbmVudCkgewogICAgICAgICAgICAgIHJldHVybiAhc2hhbGxvd0VxdWFsKG9sZFByb3BzLCBuZXdQcm9wcykgfHwgIXNoYWxsb3dFcXVhbChvbGRTdGF0ZSwgbmV3U3RhdGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY2hlY2tDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgY3RvciwgbmV3UHJvcHMpIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgIHZhciByZW5kZXJQcmVzZW50ID0gaW5zdGFuY2UucmVuZGVyOwogICAgICAgICAgICAgIGlmICghcmVuZGVyUHJlc2VudCkgewogICAgICAgICAgICAgICAgaWYgKGN0b3IucHJvdG90eXBlICYmIHR5cGVvZiBjdG9yLnByb3RvdHlwZS5yZW5kZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzKC4uLik6IE5vIGByZW5kZXJgIG1ldGhvZCBmb3VuZCBvbiB0aGUgcmV0dXJuZWQgY29tcG9uZW50IGluc3RhbmNlOiBkaWQgeW91IGFjY2lkZW50YWxseSByZXR1cm4gYW4gb2JqZWN0IGZyb20gdGhlIGNvbnN0cnVjdG9yPyIsIG5hbWUpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzKC4uLik6IE5vIGByZW5kZXJgIG1ldGhvZCBmb3VuZCBvbiB0aGUgcmV0dXJuZWQgY29tcG9uZW50IGluc3RhbmNlOiB5b3UgbWF5IGhhdmUgZm9yZ290dGVuIHRvIGRlZmluZSBgcmVuZGVyYC4iLCBuYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLmdldEluaXRpYWxTdGF0ZSAmJiAhaW5zdGFuY2UuZ2V0SW5pdGlhbFN0YXRlLmlzUmVhY3RDbGFzc0FwcHJvdmVkICYmICFpbnN0YW5jZS5zdGF0ZSkgewogICAgICAgICAgICAgICAgZXJyb3IoImdldEluaXRpYWxTdGF0ZSB3YXMgZGVmaW5lZCBvbiAlcywgYSBwbGFpbiBKYXZhU2NyaXB0IGNsYXNzLiBUaGlzIGlzIG9ubHkgc3VwcG9ydGVkIGZvciBjbGFzc2VzIGNyZWF0ZWQgdXNpbmcgUmVhY3QuY3JlYXRlQ2xhc3MuIERpZCB5b3UgbWVhbiB0byBkZWZpbmUgYSBzdGF0ZSBwcm9wZXJ0eSBpbnN0ZWFkPyIsIG5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UuZ2V0RGVmYXVsdFByb3BzICYmICFpbnN0YW5jZS5nZXREZWZhdWx0UHJvcHMuaXNSZWFjdENsYXNzQXBwcm92ZWQpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJnZXREZWZhdWx0UHJvcHMgd2FzIGRlZmluZWQgb24gJXMsIGEgcGxhaW4gSmF2YVNjcmlwdCBjbGFzcy4gVGhpcyBpcyBvbmx5IHN1cHBvcnRlZCBmb3IgY2xhc3NlcyBjcmVhdGVkIHVzaW5nIFJlYWN0LmNyZWF0ZUNsYXNzLiBVc2UgYSBzdGF0aWMgcHJvcGVydHkgdG8gZGVmaW5lIGRlZmF1bHRQcm9wcyBpbnN0ZWFkLiIsIG5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UucHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgICBlcnJvcigicHJvcFR5cGVzIHdhcyBkZWZpbmVkIGFzIGFuIGluc3RhbmNlIHByb3BlcnR5IG9uICVzLiBVc2UgYSBzdGF0aWMgcHJvcGVydHkgdG8gZGVmaW5lIHByb3BUeXBlcyBpbnN0ZWFkLiIsIG5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UuY29udGV4dFR5cGUpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJjb250ZXh0VHlwZSB3YXMgZGVmaW5lZCBhcyBhbiBpbnN0YW5jZSBwcm9wZXJ0eSBvbiAlcy4gVXNlIGEgc3RhdGljIHByb3BlcnR5IHRvIGRlZmluZSBjb250ZXh0VHlwZSBpbnN0ZWFkLiIsIG5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UuY29udGV4dFR5cGVzKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJjb250ZXh0VHlwZXMgd2FzIGRlZmluZWQgYXMgYW4gaW5zdGFuY2UgcHJvcGVydHkgb24gJXMuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSB0byBkZWZpbmUgY29udGV4dFR5cGVzIGluc3RlYWQuIiwgbmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY3Rvci5jb250ZXh0VHlwZSAmJiBjdG9yLmNvbnRleHRUeXBlcyAmJiAhZGlkV2FybkFib3V0Q29udGV4dFR5cGVBbmRDb250ZXh0VHlwZXMuaGFzKGN0b3IpKSB7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dENvbnRleHRUeXBlQW5kQ29udGV4dFR5cGVzLmFkZChjdG9yKTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzIGRlY2xhcmVzIGJvdGggY29udGV4dFR5cGVzIGFuZCBjb250ZXh0VHlwZSBzdGF0aWMgcHJvcGVydGllcy4gVGhlIGxlZ2FjeSBjb250ZXh0VHlwZXMgcHJvcGVydHkgd2lsbCBiZSBpZ25vcmVkLiIsIG5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFNob3VsZFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgY29tcG9uZW50U2hvdWxkVXBkYXRlKCkuIERpZCB5b3UgbWVhbiBzaG91bGRDb21wb25lbnRVcGRhdGUoKT8gVGhlIG5hbWUgaXMgcGhyYXNlZCBhcyBhIHF1ZXN0aW9uIGJlY2F1c2UgdGhlIGZ1bmN0aW9uIGlzIGV4cGVjdGVkIHRvIHJldHVybiBhIHZhbHVlLiIsIG5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoY3Rvci5wcm90b3R5cGUgJiYgY3Rvci5wcm90b3R5cGUuaXNQdXJlUmVhY3RDb21wb25lbnQgJiYgdHlwZW9mIGluc3RhbmNlLnNob3VsZENvbXBvbmVudFVwZGF0ZSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyBoYXMgYSBtZXRob2QgY2FsbGVkIHNob3VsZENvbXBvbmVudFVwZGF0ZSgpLiBzaG91bGRDb21wb25lbnRVcGRhdGUgc2hvdWxkIG5vdCBiZSB1c2VkIHdoZW4gZXh0ZW5kaW5nIFJlYWN0LlB1cmVDb21wb25lbnQuIFBsZWFzZSBleHRlbmQgUmVhY3QuQ29tcG9uZW50IGlmIHNob3VsZENvbXBvbmVudFVwZGF0ZSBpcyB1c2VkLiIsIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSB8fCAiQSBwdXJlIGNvbXBvbmVudCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZFVubW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyBoYXMgYSBtZXRob2QgY2FsbGVkIGNvbXBvbmVudERpZFVubW91bnQoKS4gQnV0IHRoZXJlIGlzIG5vIHN1Y2ggbGlmZWN5Y2xlIG1ldGhvZC4gRGlkIHlvdSBtZWFuIGNvbXBvbmVudFdpbGxVbm1vdW50KCk/IiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMgaGFzIGEgbWV0aG9kIGNhbGxlZCBjb21wb25lbnREaWRSZWNlaXZlUHJvcHMoKS4gQnV0IHRoZXJlIGlzIG5vIHN1Y2ggbGlmZWN5Y2xlIG1ldGhvZC4gSWYgeW91IG1lYW50IHRvIHVwZGF0ZSB0aGUgc3RhdGUgaW4gcmVzcG9uc2UgdG8gY2hhbmdpbmcgcHJvcHMsIHVzZSBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKCkuIElmIHlvdSBtZWFudCB0byBmZXRjaCBkYXRhIG9yIHJ1biBzaWRlLWVmZmVjdHMgb3IgbXV0YXRpb25zIGFmdGVyIFJlYWN0IGhhcyB1cGRhdGVkIHRoZSBVSSwgdXNlIGNvbXBvbmVudERpZFVwZGF0ZSgpLiIsIG5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNpZXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyBoYXMgYSBtZXRob2QgY2FsbGVkIGNvbXBvbmVudFdpbGxSZWNpZXZlUHJvcHMoKS4gRGlkIHlvdSBtZWFuIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMoKT8iLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFJlY2lldmVQcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNpZXZlUHJvcHMoKS4gRGlkIHlvdSBtZWFuIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKCk/IiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBoYXNNdXRhdGVkUHJvcHMgPSBpbnN0YW5jZS5wcm9wcyAhPT0gbmV3UHJvcHM7CiAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnByb3BzICE9PSB2b2lkIDAgJiYgaGFzTXV0YXRlZFByb3BzKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMoLi4uKTogV2hlbiBjYWxsaW5nIHN1cGVyKCkgaW4gYCVzYCwgbWFrZSBzdXJlIHRvIHBhc3MgdXAgdGhlIHNhbWUgcHJvcHMgdGhhdCB5b3VyIGNvbXBvbmVudCdzIGNvbnN0cnVjdG9yIHdhcyBwYXNzZWQuIiwgbmFtZSwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5kZWZhdWx0UHJvcHMpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJTZXR0aW5nIGRlZmF1bHRQcm9wcyBhcyBhbiBpbnN0YW5jZSBwcm9wZXJ0eSBvbiAlcyBpcyBub3Qgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIGlnbm9yZWQuIEluc3RlYWQsIGRlZmluZSBkZWZhdWx0UHJvcHMgYXMgYSBzdGF0aWMgcHJvcGVydHkgb24gJXMuIiwgbmFtZSwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZFVwZGF0ZSAhPT0gImZ1bmN0aW9uIiAmJiAhZGlkV2FybkFib3V0R2V0U25hcHNob3RCZWZvcmVVcGRhdGVXaXRob3V0RGlkVXBkYXRlLmhhcyhjdG9yKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0R2V0U25hcHNob3RCZWZvcmVVcGRhdGVXaXRob3V0RGlkVXBkYXRlLmFkZChjdG9yKTsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUoKSBzaG91bGQgYmUgdXNlZCB3aXRoIGNvbXBvbmVudERpZFVwZGF0ZSgpLiBUaGlzIGNvbXBvbmVudCBkZWZpbmVzIGdldFNuYXBzaG90QmVmb3JlVXBkYXRlKCkgb25seS4iLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMoKSBpcyBkZWZpbmVkIGFzIGFuIGluc3RhbmNlIG1ldGhvZCBhbmQgd2lsbCBiZSBpZ25vcmVkLiBJbnN0ZWFkLCBkZWNsYXJlIGl0IGFzIGEgc3RhdGljIG1ldGhvZC4iLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yKCkgaXMgZGVmaW5lZCBhcyBhbiBpbnN0YW5jZSBtZXRob2QgYW5kIHdpbGwgYmUgaWdub3JlZC4gSW5zdGVhZCwgZGVjbGFyZSBpdCBhcyBhIHN0YXRpYyBtZXRob2QuIiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0eXBlb2YgY3Rvci5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBnZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSgpIGlzIGRlZmluZWQgYXMgYSBzdGF0aWMgbWV0aG9kIGFuZCB3aWxsIGJlIGlnbm9yZWQuIEluc3RlYWQsIGRlY2xhcmUgaXQgYXMgYW4gaW5zdGFuY2UgbWV0aG9kLiIsIG5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgX3N0YXRlID0gaW5zdGFuY2Uuc3RhdGU7CiAgICAgICAgICAgICAgaWYgKF9zdGF0ZSAmJiAodHlwZW9mIF9zdGF0ZSAhPT0gIm9iamVjdCIgfHwgaXNBcnJheShfc3RhdGUpKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzLnN0YXRlOiBtdXN0IGJlIHNldCB0byBhbiBvYmplY3Qgb3IgbnVsbCIsIG5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldENoaWxkQ29udGV4dCA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgY3Rvci5jaGlsZENvbnRleHRUeXBlcyAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcy5nZXRDaGlsZENvbnRleHQoKTogY2hpbGRDb250ZXh0VHlwZXMgbXVzdCBiZSBkZWZpbmVkIGluIG9yZGVyIHRvIHVzZSBnZXRDaGlsZENvbnRleHQoKS4iLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGFkb3B0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlKSB7CiAgICAgICAgICAgIGluc3RhbmNlLnVwZGF0ZXIgPSBjbGFzc0NvbXBvbmVudFVwZGF0ZXI7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgPSBpbnN0YW5jZTsKICAgICAgICAgICAgc2V0MyhpbnN0YW5jZSwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGluc3RhbmNlLl9yZWFjdEludGVybmFsSW5zdGFuY2UgPSBmYWtlSW50ZXJuYWxJbnN0YW5jZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY29uc3RydWN0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIHByb3BzKSB7CiAgICAgICAgICAgIHZhciBpc0xlZ2FjeUNvbnRleHRDb25zdW1lciA9IGZhbHNlOwogICAgICAgICAgICB2YXIgdW5tYXNrZWRDb250ZXh0ID0gZW1wdHlDb250ZXh0T2JqZWN0OwogICAgICAgICAgICB2YXIgY29udGV4dCA9IGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgICAgdmFyIGNvbnRleHRUeXBlID0gY3Rvci5jb250ZXh0VHlwZTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICgiY29udGV4dFR5cGUiIGluIGN0b3IpIHsKICAgICAgICAgICAgICAgIHZhciBpc1ZhbGlkID0gKAogICAgICAgICAgICAgICAgICAvLyBBbGxvdyBudWxsIGZvciBjb25kaXRpb25hbCBkZWNsYXJhdGlvbgogICAgICAgICAgICAgICAgICBjb250ZXh0VHlwZSA9PT0gbnVsbCB8fCBjb250ZXh0VHlwZSAhPT0gdm9pZCAwICYmIGNvbnRleHRUeXBlLiQkdHlwZW9mID09PSBSRUFDVF9DT05URVhUX1RZUEUgJiYgY29udGV4dFR5cGUuX2NvbnRleHQgPT09IHZvaWQgMAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIGlmICghaXNWYWxpZCAmJiAhZGlkV2FybkFib3V0SW52YWxpZGF0ZUNvbnRleHRUeXBlLmhhcyhjdG9yKSkgewogICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRJbnZhbGlkYXRlQ29udGV4dFR5cGUuYWRkKGN0b3IpOwogICAgICAgICAgICAgICAgICB2YXIgYWRkZW5kdW0gPSAiIjsKICAgICAgICAgICAgICAgICAgaWYgKGNvbnRleHRUeXBlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgICBhZGRlbmR1bSA9ICIgSG93ZXZlciwgaXQgaXMgc2V0IHRvIHVuZGVmaW5lZC4gVGhpcyBjYW4gYmUgY2F1c2VkIGJ5IGEgdHlwbyBvciBieSBtaXhpbmcgdXAgbmFtZWQgYW5kIGRlZmF1bHQgaW1wb3J0cy4gVGhpcyBjYW4gYWxzbyBoYXBwZW4gZHVlIHRvIGEgY2lyY3VsYXIgZGVwZW5kZW5jeSwgc28gdHJ5IG1vdmluZyB0aGUgY3JlYXRlQ29udGV4dCgpIGNhbGwgdG8gYSBzZXBhcmF0ZSBmaWxlLiI7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGNvbnRleHRUeXBlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBIb3dldmVyLCBpdCBpcyBzZXQgdG8gYSAiICsgdHlwZW9mIGNvbnRleHRUeXBlICsgIi4iOwogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbnRleHRUeXBlLiQkdHlwZW9mID09PSBSRUFDVF9QUk9WSURFUl9UWVBFKSB7CiAgICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIERpZCB5b3UgYWNjaWRlbnRhbGx5IHBhc3MgdGhlIENvbnRleHQuUHJvdmlkZXIgaW5zdGVhZD8iOwogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbnRleHRUeXBlLl9jb250ZXh0ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgICBhZGRlbmR1bSA9ICIgRGlkIHlvdSBhY2NpZGVudGFsbHkgcGFzcyB0aGUgQ29udGV4dC5Db25zdW1lciBpbnN0ZWFkPyI7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIEhvd2V2ZXIsIGl0IGlzIHNldCB0byBhbiBvYmplY3Qgd2l0aCBrZXlzIHsiICsgT2JqZWN0LmtleXMoY29udGV4dFR5cGUpLmpvaW4oIiwgIikgKyAifS4iOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVycm9yKCIlcyBkZWZpbmVzIGFuIGludmFsaWQgY29udGV4dFR5cGUuIGNvbnRleHRUeXBlIHNob3VsZCBwb2ludCB0byB0aGUgQ29udGV4dCBvYmplY3QgcmV0dXJuZWQgYnkgUmVhY3QuY3JlYXRlQ29udGV4dCgpLiVzIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpIHx8ICJDb21wb25lbnQiLCBhZGRlbmR1bSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgY29udGV4dFR5cGUgPT09ICJvYmplY3QiICYmIGNvbnRleHRUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgY29udGV4dCA9IHJlYWRDb250ZXh0KGNvbnRleHRUeXBlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB1bm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCB0cnVlKTsKICAgICAgICAgICAgICB2YXIgY29udGV4dFR5cGVzID0gY3Rvci5jb250ZXh0VHlwZXM7CiAgICAgICAgICAgICAgaXNMZWdhY3lDb250ZXh0Q29uc3VtZXIgPSBjb250ZXh0VHlwZXMgIT09IG51bGwgJiYgY29udGV4dFR5cGVzICE9PSB2b2lkIDA7CiAgICAgICAgICAgICAgY29udGV4dCA9IGlzTGVnYWN5Q29udGV4dENvbnN1bWVyID8gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCkgOiBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gbmV3IGN0b3IocHJvcHMsIGNvbnRleHQpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBpbnN0YW5jZSA9IG5ldyBjdG9yKHByb3BzLCBjb250ZXh0KTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBpbnN0YW5jZS5zdGF0ZSAhPT0gbnVsbCAmJiBpbnN0YW5jZS5zdGF0ZSAhPT0gdm9pZCAwID8gaW5zdGFuY2Uuc3RhdGUgOiBudWxsOwogICAgICAgICAgICBhZG9wdENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iICYmIHN0YXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0VW5pbml0aWFsaXplZFN0YXRlLmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbmluaXRpYWxpemVkU3RhdGUuYWRkKGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICBlcnJvcigiYCVzYCB1c2VzIGBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHNgIGJ1dCBpdHMgaW5pdGlhbCBzdGF0ZSBpcyAlcy4gVGhpcyBpcyBub3QgcmVjb21tZW5kZWQuIEluc3RlYWQsIGRlZmluZSB0aGUgaW5pdGlhbCBzdGF0ZSBieSBhc3NpZ25pbmcgYW4gb2JqZWN0IHRvIGB0aGlzLnN0YXRlYCBpbiB0aGUgY29uc3RydWN0b3Igb2YgYCVzYC4gVGhpcyBlbnN1cmVzIHRoYXQgYGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wc2AgYXJndW1lbnRzIGhhdmUgYSBjb25zaXN0ZW50IHNoYXBlLiIsIGNvbXBvbmVudE5hbWUsIGluc3RhbmNlLnN0YXRlID09PSBudWxsID8gIm51bGwiIDogInVuZGVmaW5lZCIsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdmFyIGZvdW5kV2lsbE1vdW50TmFtZSA9IG51bGw7CiAgICAgICAgICAgICAgICB2YXIgZm91bmRXaWxsUmVjZWl2ZVByb3BzTmFtZSA9IG51bGw7CiAgICAgICAgICAgICAgICB2YXIgZm91bmRXaWxsVXBkYXRlTmFtZSA9IG51bGw7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIiAmJiBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQuX19zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICBmb3VuZFdpbGxNb3VudE5hbWUgPSAiY29tcG9uZW50V2lsbE1vdW50IjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgZm91bmRXaWxsTW91bnROYW1lID0gIlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iICYmIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMuX19zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICBmb3VuZFdpbGxSZWNlaXZlUHJvcHNOYW1lID0gImNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMiOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgZm91bmRXaWxsUmVjZWl2ZVByb3BzTmFtZSA9ICJVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIgJiYgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVwZGF0ZS5fX3N1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5nICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgIGZvdW5kV2lsbFVwZGF0ZU5hbWUgPSAiY29tcG9uZW50V2lsbFVwZGF0ZSI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBmb3VuZFdpbGxVcGRhdGVOYW1lID0gIlVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChmb3VuZFdpbGxNb3VudE5hbWUgIT09IG51bGwgfHwgZm91bmRXaWxsUmVjZWl2ZVByb3BzTmFtZSAhPT0gbnVsbCB8fCBmb3VuZFdpbGxVcGRhdGVOYW1lICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgICAgICAgdmFyIG5ld0FwaU5hbWUgPSB0eXBlb2YgY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIgPyAiZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzKCkiIDogImdldFNuYXBzaG90QmVmb3JlVXBkYXRlKCkiOwogICAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dExlZ2FjeUxpZmVjeWNsZXNBbmREZXJpdmVkU3RhdGUuaGFzKF9jb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUxpZmVjeWNsZXNBbmREZXJpdmVkU3RhdGUuYWRkKF9jb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiVW5zYWZlIGxlZ2FjeSBsaWZlY3ljbGVzIHdpbGwgbm90IGJlIGNhbGxlZCBmb3IgY29tcG9uZW50cyB1c2luZyBuZXcgY29tcG9uZW50IEFQSXMuXG5cbiVzIHVzZXMgJXMgYnV0IGFsc28gY29udGFpbnMgdGhlIGZvbGxvd2luZyBsZWdhY3kgbGlmZWN5Y2xlczolcyVzJXNcblxuVGhlIGFib3ZlIGxpZmVjeWNsZXMgc2hvdWxkIGJlIHJlbW92ZWQuIExlYXJuIG1vcmUgYWJvdXQgdGhpcyB3YXJuaW5nIGhlcmU6XG5odHRwczovL3JlYWN0anMub3JnL2xpbmsvdW5zYWZlLWNvbXBvbmVudC1saWZlY3ljbGVzIiwgX2NvbXBvbmVudE5hbWUsIG5ld0FwaU5hbWUsIGZvdW5kV2lsbE1vdW50TmFtZSAhPT0gbnVsbCA/ICJcbiAgIiArIGZvdW5kV2lsbE1vdW50TmFtZSA6ICIiLCBmb3VuZFdpbGxSZWNlaXZlUHJvcHNOYW1lICE9PSBudWxsID8gIlxuICAiICsgZm91bmRXaWxsUmVjZWl2ZVByb3BzTmFtZSA6ICIiLCBmb3VuZFdpbGxVcGRhdGVOYW1lICE9PSBudWxsID8gIlxuICAiICsgZm91bmRXaWxsVXBkYXRlTmFtZSA6ICIiKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNMZWdhY3lDb250ZXh0Q29uc3VtZXIpIHsKICAgICAgICAgICAgICBjYWNoZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCB1bm1hc2tlZENvbnRleHQsIGNvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNhbGxDb21wb25lbnRXaWxsTW91bnQod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSkgewogICAgICAgICAgICB2YXIgb2xkU3RhdGUgPSBpbnN0YW5jZS5zdGF0ZTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9sZFN0YXRlICE9PSBpbnN0YW5jZS5zdGF0ZSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcy5jb21wb25lbnRXaWxsTW91bnQoKTogQXNzaWduaW5nIGRpcmVjdGx5IHRvIHRoaXMuc3RhdGUgaXMgZGVwcmVjYXRlZCAoZXhjZXB0IGluc2lkZSBhIGNvbXBvbmVudCdzIGNvbnN0cnVjdG9yKS4gVXNlIHNldFN0YXRlIGluc3RlYWQuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcih3b3JrSW5Qcm9ncmVzczIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2xhc3NDb21wb25lbnRVcGRhdGVyLmVucXVldWVSZXBsYWNlU3RhdGUoaW5zdGFuY2UsIGluc3RhbmNlLnN0YXRlLCBudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY2FsbENvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSwgbmV3UHJvcHMsIG5leHRDb250ZXh0KSB7CiAgICAgICAgICAgIHZhciBvbGRTdGF0ZSA9IGluc3RhbmNlLnN0YXRlOwogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5ld1Byb3BzLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5ld1Byb3BzLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLnN0YXRlICE9PSBvbGRTdGF0ZSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcih3b3JrSW5Qcm9ncmVzczIpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRTdGF0ZUFzc2lnbm1lbnRGb3JDb21wb25lbnQuaGFzKGNvbXBvbmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFN0YXRlQXNzaWdubWVudEZvckNvbXBvbmVudC5hZGQoY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCIlcy5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKCk6IEFzc2lnbmluZyBkaXJlY3RseSB0byB0aGlzLnN0YXRlIGlzIGRlcHJlY2F0ZWQgKGV4Y2VwdCBpbnNpZGUgYSBjb21wb25lbnQncyBjb25zdHJ1Y3RvcikuIFVzZSBzZXRTdGF0ZSBpbnN0ZWFkLiIsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjbGFzc0NvbXBvbmVudFVwZGF0ZXIuZW5xdWV1ZVJlcGxhY2VTdGF0ZShpbnN0YW5jZSwgaW5zdGFuY2Uuc3RhdGUsIG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtb3VudENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBuZXdQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjaGVja0NsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBuZXdQcm9wcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgaW5zdGFuY2UucHJvcHMgPSBuZXdQcm9wczsKICAgICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgaW5zdGFuY2UucmVmcyA9IGVtcHR5UmVmc09iamVjdDsKICAgICAgICAgICAgaW5pdGlhbGl6ZVVwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIHZhciBjb250ZXh0VHlwZSA9IGN0b3IuY29udGV4dFR5cGU7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY29udGV4dFR5cGUgPT09ICJvYmplY3QiICYmIGNvbnRleHRUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaW5zdGFuY2UuY29udGV4dCA9IHJlYWRDb250ZXh0KGNvbnRleHRUeXBlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgdW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgY3RvciwgdHJ1ZSk7CiAgICAgICAgICAgICAgaW5zdGFuY2UuY29udGV4dCA9IGdldE1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCB1bm1hc2tlZENvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaW5zdGFuY2Uuc3RhdGUgPT09IG5ld1Byb3BzKSB7CiAgICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0RGlyZWN0bHlBc3NpZ25pbmdQcm9wc1RvU3RhdGUuaGFzKGNvbXBvbmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dERpcmVjdGx5QXNzaWduaW5nUHJvcHNUb1N0YXRlLmFkZChjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBJdCBpcyBub3QgcmVjb21tZW5kZWQgdG8gYXNzaWduIHByb3BzIGRpcmVjdGx5IHRvIHN0YXRlIGJlY2F1c2UgdXBkYXRlcyB0byBwcm9wcyB3b24ndCBiZSByZWZsZWN0ZWQgaW4gc3RhdGUuIEluIG1vc3QgY2FzZXMsIGl0IGlzIGJldHRlciB0byB1c2UgcHJvcHMgZGlyZWN0bHkuIiwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLnJlY29yZExlZ2FjeUNvbnRleHRXYXJuaW5nKHdvcmtJblByb2dyZXNzMiwgaW5zdGFuY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5yZWNvcmRVbnNhZmVMaWZlY3ljbGVXYXJuaW5ncyh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgdmFyIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9IGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzOwogICAgICAgICAgICBpZiAodHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGFwcGx5RGVyaXZlZFN0YXRlRnJvbVByb3BzKHdvcmtJblByb2dyZXNzMiwgY3RvciwgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLCBuZXdQcm9wcyk7CiAgICAgICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzICE9PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSAhPT0gImZ1bmN0aW9uIiAmJiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikpIHsKICAgICAgICAgICAgICBjYWxsQ29tcG9uZW50V2lsbE1vdW50KHdvcmtJblByb2dyZXNzMiwgaW5zdGFuY2UpOwogICAgICAgICAgICAgIHByb2Nlc3NVcGRhdGVRdWV1ZSh3b3JrSW5Qcm9ncmVzczIsIG5ld1Byb3BzLCBpbnN0YW5jZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICBpbnN0YW5jZS5zdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgZmliZXJGbGFncyA9IFVwZGF0ZTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBmaWJlckZsYWdzIHw9IExheW91dFN0YXRpYzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdEVmZmVjdHNNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICBmaWJlckZsYWdzIHw9IE1vdW50TGF5b3V0RGV2OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gZmliZXJGbGFnczsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVzdW1lTW91bnRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgY3RvciwgbmV3UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICB2YXIgb2xkUHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgaW5zdGFuY2UucHJvcHMgPSBvbGRQcm9wczsKICAgICAgICAgICAgdmFyIG9sZENvbnRleHQgPSBpbnN0YW5jZS5jb250ZXh0OwogICAgICAgICAgICB2YXIgY29udGV4dFR5cGUgPSBjdG9yLmNvbnRleHRUeXBlOwogICAgICAgICAgICB2YXIgbmV4dENvbnRleHQgPSBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY29udGV4dFR5cGUgPT09ICJvYmplY3QiICYmIGNvbnRleHRUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgbmV4dENvbnRleHQgPSByZWFkQ29udGV4dChjb250ZXh0VHlwZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIG5leHRMZWdhY3lVbm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCB0cnVlKTsKICAgICAgICAgICAgICBuZXh0Q29udGV4dCA9IGdldE1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBuZXh0TGVnYWN5VW5tYXNrZWRDb250ZXh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID0gY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHM7CiAgICAgICAgICAgIHZhciBoYXNOZXdMaWZlY3ljbGVzID0gdHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiI7CiAgICAgICAgICAgIGlmICghaGFzTmV3TGlmZWN5Y2xlcyAmJiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSkgewogICAgICAgICAgICAgIGlmIChvbGRQcm9wcyAhPT0gbmV3UHJvcHMgfHwgb2xkQ29udGV4dCAhPT0gbmV4dENvbnRleHQpIHsKICAgICAgICAgICAgICAgIGNhbGxDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKHdvcmtJblByb2dyZXNzMiwgaW5zdGFuY2UsIG5ld1Byb3BzLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc2V0SGFzRm9yY2VVcGRhdGVCZWZvcmVQcm9jZXNzaW5nKCk7CiAgICAgICAgICAgIHZhciBvbGRTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBpbnN0YW5jZS5zdGF0ZSA9IG9sZFN0YXRlOwogICAgICAgICAgICBwcm9jZXNzVXBkYXRlUXVldWUod29ya0luUHJvZ3Jlc3MyLCBuZXdQcm9wcywgaW5zdGFuY2UsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIG5ld1N0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIGlmIChvbGRQcm9wcyA9PT0gbmV3UHJvcHMgJiYgb2xkU3RhdGUgPT09IG5ld1N0YXRlICYmICFoYXNDb250ZXh0Q2hhbmdlZCgpICYmICFjaGVja0hhc0ZvcmNlVXBkYXRlQWZ0ZXJQcm9jZXNzaW5nKCkpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB2YXIgZmliZXJGbGFncyA9IFVwZGF0ZTsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgZmliZXJGbGFncyB8PSBMYXlvdXRTdGF0aWM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgICAgZmliZXJGbGFncyB8PSBNb3VudExheW91dERldjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBmaWJlckZsYWdzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBhcHBseURlcml2ZWRTdGF0ZUZyb21Qcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcywgbmV3UHJvcHMpOwogICAgICAgICAgICAgIG5ld1N0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNob3VsZFVwZGF0ZSA9IGNoZWNrSGFzRm9yY2VVcGRhdGVBZnRlclByb2Nlc3NpbmcoKSB8fCBjaGVja1Nob3VsZENvbXBvbmVudFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIG9sZFByb3BzLCBuZXdQcm9wcywgb2xkU3RhdGUsIG5ld1N0YXRlLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgICBpZiAoIWhhc05ld0xpZmVjeWNsZXMgJiYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHZhciBfZmliZXJGbGFncyA9IFVwZGF0ZTsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgX2ZpYmVyRmxhZ3MgfD0gTGF5b3V0U3RhdGljOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdEVmZmVjdHNNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIF9maWJlckZsYWdzIHw9IE1vdW50TGF5b3V0RGV2OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IF9maWJlckZsYWdzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB2YXIgX2ZpYmVyRmxhZ3MyID0gVXBkYXRlOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBfZmliZXJGbGFnczIgfD0gTGF5b3V0U3RhdGljOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdEVmZmVjdHNNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIF9maWJlckZsYWdzMiB8PSBNb3VudExheW91dERldjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBfZmliZXJGbGFnczI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzID0gbmV3UHJvcHM7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnN0YW5jZS5wcm9wcyA9IG5ld1Byb3BzOwogICAgICAgICAgICBpbnN0YW5jZS5zdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICBpbnN0YW5jZS5jb250ZXh0ID0gbmV4dENvbnRleHQ7CiAgICAgICAgICAgIHJldHVybiBzaG91bGRVcGRhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVDbGFzc0luc3RhbmNlKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIG5ld1Byb3BzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgY2xvbmVVcGRhdGVRdWV1ZShjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgdmFyIHVucmVzb2x2ZWRPbGRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzOwogICAgICAgICAgICB2YXIgb2xkUHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIudHlwZSA9PT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID8gdW5yZXNvbHZlZE9sZFByb3BzIDogcmVzb2x2ZURlZmF1bHRQcm9wcyh3b3JrSW5Qcm9ncmVzczIudHlwZSwgdW5yZXNvbHZlZE9sZFByb3BzKTsKICAgICAgICAgICAgaW5zdGFuY2UucHJvcHMgPSBvbGRQcm9wczsKICAgICAgICAgICAgdmFyIHVucmVzb2x2ZWROZXdQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgIHZhciBvbGRDb250ZXh0ID0gaW5zdGFuY2UuY29udGV4dDsKICAgICAgICAgICAgdmFyIGNvbnRleHRUeXBlID0gY3Rvci5jb250ZXh0VHlwZTsKICAgICAgICAgICAgdmFyIG5leHRDb250ZXh0ID0gZW1wdHlDb250ZXh0T2JqZWN0OwogICAgICAgICAgICBpZiAodHlwZW9mIGNvbnRleHRUeXBlID09PSAib2JqZWN0IiAmJiBjb250ZXh0VHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5leHRDb250ZXh0ID0gcmVhZENvbnRleHQoY29udGV4dFR5cGUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBuZXh0VW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgY3RvciwgdHJ1ZSk7CiAgICAgICAgICAgICAgbmV4dENvbnRleHQgPSBnZXRNYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgbmV4dFVubWFza2VkQ29udGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9IGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzOwogICAgICAgICAgICB2YXIgaGFzTmV3TGlmZWN5Y2xlcyA9IHR5cGVvZiBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlID09PSAiZnVuY3Rpb24iOwogICAgICAgICAgICBpZiAoIWhhc05ld0xpZmVjeWNsZXMgJiYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIikpIHsKICAgICAgICAgICAgICBpZiAodW5yZXNvbHZlZE9sZFByb3BzICE9PSB1bnJlc29sdmVkTmV3UHJvcHMgfHwgb2xkQ29udGV4dCAhPT0gbmV4dENvbnRleHQpIHsKICAgICAgICAgICAgICAgIGNhbGxDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKHdvcmtJblByb2dyZXNzMiwgaW5zdGFuY2UsIG5ld1Byb3BzLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc2V0SGFzRm9yY2VVcGRhdGVCZWZvcmVQcm9jZXNzaW5nKCk7CiAgICAgICAgICAgIHZhciBvbGRTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBpbnN0YW5jZS5zdGF0ZSA9IG9sZFN0YXRlOwogICAgICAgICAgICBwcm9jZXNzVXBkYXRlUXVldWUod29ya0luUHJvZ3Jlc3MyLCBuZXdQcm9wcywgaW5zdGFuY2UsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIG5ld1N0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIGlmICh1bnJlc29sdmVkT2xkUHJvcHMgPT09IHVucmVzb2x2ZWROZXdQcm9wcyAmJiBvbGRTdGF0ZSA9PT0gbmV3U3RhdGUgJiYgIWhhc0NvbnRleHRDaGFuZ2VkKCkgJiYgIWNoZWNrSGFzRm9yY2VVcGRhdGVBZnRlclByb2Nlc3NpbmcoKSAmJiAhZW5hYmxlTGF6eUNvbnRleHRQcm9wYWdhdGlvbikgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpZiAodW5yZXNvbHZlZE9sZFByb3BzICE9PSBjdXJyZW50Mi5tZW1vaXplZFByb3BzIHx8IG9sZFN0YXRlICE9PSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGlmICh1bnJlc29sdmVkT2xkUHJvcHMgIT09IGN1cnJlbnQyLm1lbW9pemVkUHJvcHMgfHwgb2xkU3RhdGUgIT09IGN1cnJlbnQyLm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFNuYXBzaG90OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBhcHBseURlcml2ZWRTdGF0ZUZyb21Qcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcywgbmV3UHJvcHMpOwogICAgICAgICAgICAgIG5ld1N0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNob3VsZFVwZGF0ZSA9IGNoZWNrSGFzRm9yY2VVcGRhdGVBZnRlclByb2Nlc3NpbmcoKSB8fCBjaGVja1Nob3VsZENvbXBvbmVudFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIG9sZFByb3BzLCBuZXdQcm9wcywgb2xkU3RhdGUsIG5ld1N0YXRlLCBuZXh0Q29udGV4dCkgfHwgLy8gVE9ETzogSW4gc29tZSBjYXNlcywgd2UnbGwgZW5kIHVwIGNoZWNraW5nIGlmIGNvbnRleHQgaGFzIGNoYW5nZWQgdHdpY2UsCiAgICAgICAgICAgIC8vIGJvdGggYmVmb3JlIGFuZCBhZnRlciBgc2hvdWxkQ29tcG9uZW50VXBkYXRlYCBoYXMgYmVlbiBjYWxsZWQuIE5vdCBpZGVhbCwKICAgICAgICAgICAgLy8gYnV0IEknbSBsb2F0aCB0byByZWZhY3RvciB0aGlzIGZ1bmN0aW9uLiBUaGlzIG9ubHkgaGFwcGVucyBmb3IgbWVtb2l6ZWQKICAgICAgICAgICAgLy8gY29tcG9uZW50cyBzbyBpdCdzIG5vdCB0aGF0IGNvbW1vbi4KICAgICAgICAgICAgZW5hYmxlTGF6eUNvbnRleHRQcm9wYWdhdGlvbjsKICAgICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSkgewogICAgICAgICAgICAgIGlmICghaGFzTmV3TGlmZWN5Y2xlcyAmJiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iKSkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUobmV3UHJvcHMsIG5ld1N0YXRlLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlKG5ld1Byb3BzLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFNuYXBzaG90OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgaWYgKHVucmVzb2x2ZWRPbGRQcm9wcyAhPT0gY3VycmVudDIubWVtb2l6ZWRQcm9wcyB8fCBvbGRTdGF0ZSAhPT0gY3VycmVudDIubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpZiAodW5yZXNvbHZlZE9sZFByb3BzICE9PSBjdXJyZW50Mi5tZW1vaXplZFByb3BzIHx8IG9sZFN0YXRlICE9PSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBTbmFwc2hvdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMgPSBuZXdQcm9wczsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gbmV3UHJvcHM7CiAgICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgIGluc3RhbmNlLmNvbnRleHQgPSBuZXh0Q29udGV4dDsKICAgICAgICAgICAgcmV0dXJuIHNob3VsZFVwZGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBkaWRXYXJuQWJvdXRNYXBzOwogICAgICAgICAgdmFyIGRpZFdhcm5BYm91dEdlbmVyYXRvcnM7CiAgICAgICAgICB2YXIgZGlkV2FybkFib3V0U3RyaW5nUmVmczsKICAgICAgICAgIHZhciBvd25lckhhc0tleVVzZVdhcm5pbmc7CiAgICAgICAgICB2YXIgb3duZXJIYXNGdW5jdGlvblR5cGVXYXJuaW5nOwogICAgICAgICAgdmFyIHdhcm5Gb3JNaXNzaW5nS2V5ID0gZnVuY3Rpb24oY2hpbGQsIHJldHVybkZpYmVyKSB7CiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICBkaWRXYXJuQWJvdXRNYXBzID0gZmFsc2U7CiAgICAgICAgICAgIGRpZFdhcm5BYm91dEdlbmVyYXRvcnMgPSBmYWxzZTsKICAgICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmcyA9IHt9OwogICAgICAgICAgICBvd25lckhhc0tleVVzZVdhcm5pbmcgPSB7fTsKICAgICAgICAgICAgb3duZXJIYXNGdW5jdGlvblR5cGVXYXJuaW5nID0ge307CiAgICAgICAgICAgIHdhcm5Gb3JNaXNzaW5nS2V5ID0gZnVuY3Rpb24oY2hpbGQsIHJldHVybkZpYmVyKSB7CiAgICAgICAgICAgICAgaWYgKGNoaWxkID09PSBudWxsIHx8IHR5cGVvZiBjaGlsZCAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFjaGlsZC5fc3RvcmUgfHwgY2hpbGQuX3N0b3JlLnZhbGlkYXRlZCB8fCBjaGlsZC5rZXkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIGNoaWxkLl9zdG9yZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVhY3QgQ29tcG9uZW50IGluIHdhcm5Gb3JNaXNzaW5nS2V5IHNob3VsZCBoYXZlIGEgX3N0b3JlLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjaGlsZC5fc3RvcmUudmFsaWRhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIocmV0dXJuRmliZXIpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgIGlmIChvd25lckhhc0tleVVzZVdhcm5pbmdbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgb3duZXJIYXNLZXlVc2VXYXJuaW5nW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICBlcnJvcignRWFjaCBjaGlsZCBpbiBhIGxpc3Qgc2hvdWxkIGhhdmUgYSB1bmlxdWUgImtleSIgcHJvcC4gU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay93YXJuaW5nLWtleXMgZm9yIG1vcmUgaW5mb3JtYXRpb24uJyk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjb2VyY2VSZWYocmV0dXJuRmliZXIsIGN1cnJlbnQyLCBlbGVtZW50KSB7CiAgICAgICAgICAgIHZhciBtaXhlZFJlZiA9IGVsZW1lbnQucmVmOwogICAgICAgICAgICBpZiAobWl4ZWRSZWYgIT09IG51bGwgJiYgdHlwZW9mIG1peGVkUmVmICE9PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBtaXhlZFJlZiAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoKHJldHVybkZpYmVyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlIHx8IHdhcm5BYm91dFN0cmluZ1JlZnMpICYmIC8vIFdlIHdhcm4gaW4gUmVhY3RFbGVtZW50LmpzIGlmIG93bmVyIGFuZCBzZWxmIGFyZSBlcXVhbCBmb3Igc3RyaW5nIHJlZnMKICAgICAgICAgICAgICAgIC8vIGJlY2F1c2UgdGhlc2UgY2Fubm90IGJlIGF1dG9tYXRpY2FsbHkgY29udmVydGVkIHRvIGFuIGFycm93IGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAvLyB1c2luZyBhIGNvZGVtb2QuIFRoZXJlZm9yZSwgd2UgZG9uJ3QgaGF2ZSB0byB3YXJuIGFib3V0IHN0cmluZyByZWZzIGFnYWluLgogICAgICAgICAgICAgICAgIShlbGVtZW50Ll9vd25lciAmJiBlbGVtZW50Ll9zZWxmICYmIGVsZW1lbnQuX293bmVyLnN0YXRlTm9kZSAhPT0gZWxlbWVudC5fc2VsZikpIHsKICAgICAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKHJldHVybkZpYmVyKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRTdHJpbmdSZWZzW2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgZXJyb3IoJ0Egc3RyaW5nIHJlZiwgIiVzIiwgaGFzIGJlZW4gZm91bmQgd2l0aGluIGEgc3RyaWN0IG1vZGUgdHJlZS4gU3RyaW5nIHJlZnMgYXJlIGEgc291cmNlIG9mIHBvdGVudGlhbCBidWdzIGFuZCBzaG91bGQgYmUgYXZvaWRlZC4gV2UgcmVjb21tZW5kIHVzaW5nIHVzZVJlZigpIG9yIGNyZWF0ZVJlZigpIGluc3RlYWQuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLXN0cmluZy1yZWYnLCBtaXhlZFJlZik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFN0cmluZ1JlZnNbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChlbGVtZW50Ll9vd25lcikgewogICAgICAgICAgICAgICAgdmFyIG93bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICAgICAgICB2YXIgaW5zdDsKICAgICAgICAgICAgICAgIGlmIChvd25lcikgewogICAgICAgICAgICAgICAgICB2YXIgb3duZXJGaWJlciA9IG93bmVyOwogICAgICAgICAgICAgICAgICBpZiAob3duZXJGaWJlci50YWcgIT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJGdW5jdGlvbiBjb21wb25lbnRzIGNhbm5vdCBoYXZlIHN0cmluZyByZWZzLiBXZSByZWNvbW1lbmQgdXNpbmcgdXNlUmVmKCkgaW5zdGVhZC4gTGVhcm4gbW9yZSBhYm91dCB1c2luZyByZWZzIHNhZmVseSBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3RyaWN0LW1vZGUtc3RyaW5nLXJlZiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGluc3QgPSBvd25lckZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICghaW5zdCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk1pc3Npbmcgb3duZXIgZm9yIHN0cmluZyByZWYgIiArIG1peGVkUmVmICsgIi4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciByZXNvbHZlZEluc3QgPSBpbnN0OwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBjaGVja1Byb3BTdHJpbmdDb2VyY2lvbihtaXhlZFJlZiwgInJlZiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHN0cmluZ1JlZiA9ICIiICsgbWl4ZWRSZWY7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwgJiYgY3VycmVudDIucmVmICE9PSBudWxsICYmIHR5cGVvZiBjdXJyZW50Mi5yZWYgPT09ICJmdW5jdGlvbiIgJiYgY3VycmVudDIucmVmLl9zdHJpbmdSZWYgPT09IHN0cmluZ1JlZikgewogICAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudDIucmVmOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHJlZiA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgIHZhciByZWZzID0gcmVzb2x2ZWRJbnN0LnJlZnM7CiAgICAgICAgICAgICAgICAgIGlmIChyZWZzID09PSBlbXB0eVJlZnNPYmplY3QpIHsKICAgICAgICAgICAgICAgICAgICByZWZzID0gcmVzb2x2ZWRJbnN0LnJlZnMgPSB7fTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgcmVmc1tzdHJpbmdSZWZdOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJlZnNbc3RyaW5nUmVmXSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcmVmLl9zdHJpbmdSZWYgPSBzdHJpbmdSZWY7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVmOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG1peGVkUmVmICE9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHJlZiB0byBiZSBhIGZ1bmN0aW9uLCBhIHN0cmluZywgYW4gb2JqZWN0IHJldHVybmVkIGJ5IFJlYWN0LmNyZWF0ZVJlZigpLCBvciBudWxsLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFlbGVtZW50Ll9vd25lcikgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkVsZW1lbnQgcmVmIHdhcyBzcGVjaWZpZWQgYXMgYSBzdHJpbmcgKCIgKyBtaXhlZFJlZiArICIpIGJ1dCBubyBvd25lciB3YXMgc2V0LiBUaGlzIGNvdWxkIGhhcHBlbiBmb3Igb25lIG9mIHRoZSBmb2xsb3dpbmcgcmVhc29uczpcbjEuIFlvdSBtYXkgYmUgYWRkaW5nIGEgcmVmIHRvIGEgZnVuY3Rpb24gY29tcG9uZW50XG4yLiBZb3UgbWF5IGJlIGFkZGluZyBhIHJlZiB0byBhIGNvbXBvbmVudCB0aGF0IHdhcyBub3QgY3JlYXRlZCBpbnNpZGUgYSBjb21wb25lbnQncyByZW5kZXIgbWV0aG9kXG4zLiBZb3UgaGF2ZSBtdWx0aXBsZSBjb3BpZXMgb2YgUmVhY3QgbG9hZGVkXG5TZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3JlZnMtbXVzdC1oYXZlLW93bmVyIGZvciBtb3JlIGluZm9ybWF0aW9uLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbWl4ZWRSZWY7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB0aHJvd09uSW52YWxpZE9iamVjdFR5cGUocmV0dXJuRmliZXIsIG5ld0NoaWxkKSB7CiAgICAgICAgICAgIHZhciBjaGlsZFN0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChuZXdDaGlsZCk7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiT2JqZWN0cyBhcmUgbm90IHZhbGlkIGFzIGEgUmVhY3QgY2hpbGQgKGZvdW5kOiAiICsgKGNoaWxkU3RyaW5nID09PSAiW29iamVjdCBPYmplY3RdIiA/ICJvYmplY3Qgd2l0aCBrZXlzIHsiICsgT2JqZWN0LmtleXMobmV3Q2hpbGQpLmpvaW4oIiwgIikgKyAifSIgOiBjaGlsZFN0cmluZykgKyAiKS4gSWYgeW91IG1lYW50IHRvIHJlbmRlciBhIGNvbGxlY3Rpb24gb2YgY2hpbGRyZW4sIHVzZSBhbiBhcnJheSBpbnN0ZWFkLiIpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gd2Fybk9uRnVuY3Rpb25UeXBlKHJldHVybkZpYmVyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIocmV0dXJuRmliZXIpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgIGlmIChvd25lckhhc0Z1bmN0aW9uVHlwZVdhcm5pbmdbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgb3duZXJIYXNGdW5jdGlvblR5cGVXYXJuaW5nW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICBlcnJvcigiRnVuY3Rpb25zIGFyZSBub3QgdmFsaWQgYXMgYSBSZWFjdCBjaGlsZC4gVGhpcyBtYXkgaGFwcGVuIGlmIHlvdSByZXR1cm4gYSBDb21wb25lbnQgaW5zdGVhZCBvZiA8Q29tcG9uZW50IC8+IGZyb20gcmVuZGVyLiBPciBtYXliZSB5b3UgbWVhbnQgdG8gY2FsbCB0aGlzIGZ1bmN0aW9uIHJhdGhlciB0aGFuIHJldHVybiBpdC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZUxhenkobGF6eVR5cGUpIHsKICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5VHlwZS5fcGF5bG9hZDsKICAgICAgICAgICAgdmFyIGluaXQyID0gbGF6eVR5cGUuX2luaXQ7CiAgICAgICAgICAgIHJldHVybiBpbml0MihwYXlsb2FkKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIENoaWxkUmVjb25jaWxlcihzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgIGZ1bmN0aW9uIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBjaGlsZFRvRGVsZXRlKSB7CiAgICAgICAgICAgICAgaWYgKCFzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBkZWxldGlvbnMgPSByZXR1cm5GaWJlci5kZWxldGlvbnM7CiAgICAgICAgICAgICAgaWYgKGRlbGV0aW9ucyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuRmliZXIuZGVsZXRpb25zID0gW2NoaWxkVG9EZWxldGVdOwogICAgICAgICAgICAgICAgcmV0dXJuRmliZXIuZmxhZ3MgfD0gQ2hpbGREZWxldGlvbjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVsZXRpb25zLnB1c2goY2hpbGRUb0RlbGV0ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCkgewogICAgICAgICAgICAgIGlmICghc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBjaGlsZFRvRGVsZXRlID0gY3VycmVudEZpcnN0Q2hpbGQ7CiAgICAgICAgICAgICAgd2hpbGUgKGNoaWxkVG9EZWxldGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBjaGlsZFRvRGVsZXRlKTsKICAgICAgICAgICAgICAgIGNoaWxkVG9EZWxldGUgPSBjaGlsZFRvRGVsZXRlLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIG1hcFJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCkgewogICAgICAgICAgICAgIHZhciBleGlzdGluZ0NoaWxkcmVuID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICAgICAgICB2YXIgZXhpc3RpbmdDaGlsZCA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChleGlzdGluZ0NoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdDaGlsZC5rZXkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZHJlbi5zZXQoZXhpc3RpbmdDaGlsZC5rZXksIGV4aXN0aW5nQ2hpbGQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZHJlbi5zZXQoZXhpc3RpbmdDaGlsZC5pbmRleCwgZXhpc3RpbmdDaGlsZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBleGlzdGluZ0NoaWxkID0gZXhpc3RpbmdDaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZXhpc3RpbmdDaGlsZHJlbjsKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiB1c2VGaWJlcihmaWJlciwgcGVuZGluZ1Byb3BzKSB7CiAgICAgICAgICAgICAgdmFyIGNsb25lID0gY3JlYXRlV29ya0luUHJvZ3Jlc3MoZmliZXIsIHBlbmRpbmdQcm9wcyk7CiAgICAgICAgICAgICAgY2xvbmUuaW5kZXggPSAwOwogICAgICAgICAgICAgIGNsb25lLnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgICAgIHJldHVybiBjbG9uZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBwbGFjZUNoaWxkKG5ld0ZpYmVyLCBsYXN0UGxhY2VkSW5kZXgsIG5ld0luZGV4KSB7CiAgICAgICAgICAgICAgbmV3RmliZXIuaW5kZXggPSBuZXdJbmRleDsKICAgICAgICAgICAgICBpZiAoIXNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICAgIG5ld0ZpYmVyLmZsYWdzIHw9IEZvcmtlZDsKICAgICAgICAgICAgICAgIHJldHVybiBsYXN0UGxhY2VkSW5kZXg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBjdXJyZW50MiA9IG5ld0ZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBvbGRJbmRleCA9IGN1cnJlbnQyLmluZGV4OwogICAgICAgICAgICAgICAgaWYgKG9sZEluZGV4IDwgbGFzdFBsYWNlZEluZGV4KSB7CiAgICAgICAgICAgICAgICAgIG5ld0ZpYmVyLmZsYWdzIHw9IFBsYWNlbWVudDsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGxhc3RQbGFjZWRJbmRleDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBvbGRJbmRleDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmV3RmliZXIuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgICAgICAgcmV0dXJuIGxhc3RQbGFjZWRJbmRleDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gcGxhY2VTaW5nbGVDaGlsZChuZXdGaWJlcikgewogICAgICAgICAgICAgIGlmIChzaG91bGRUcmFja1NpZGVFZmZlY3RzICYmIG5ld0ZpYmVyLmFsdGVybmF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgbmV3RmliZXIuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gbmV3RmliZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gdXBkYXRlVGV4dE5vZGUocmV0dXJuRmliZXIsIGN1cnJlbnQyLCB0ZXh0Q29udGVudCwgbGFuZXMpIHsKICAgICAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwgfHwgY3VycmVudDIudGFnICE9PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21UZXh0KHRleHRDb250ZW50LCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBleGlzdGluZyA9IHVzZUZpYmVyKGN1cnJlbnQyLCB0ZXh0Q29udGVudCk7CiAgICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gdXBkYXRlRWxlbWVudChyZXR1cm5GaWJlciwgY3VycmVudDIsIGVsZW1lbnQsIGxhbmVzKSB7CiAgICAgICAgICAgICAgdmFyIGVsZW1lbnRUeXBlID0gZWxlbWVudC50eXBlOwogICAgICAgICAgICAgIGlmIChlbGVtZW50VHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZyYWdtZW50MihyZXR1cm5GaWJlciwgY3VycmVudDIsIGVsZW1lbnQucHJvcHMuY2hpbGRyZW4sIGxhbmVzLCBlbGVtZW50LmtleSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyLmVsZW1lbnRUeXBlID09PSBlbGVtZW50VHlwZSB8fCAvLyBLZWVwIHRoaXMgY2hlY2sgaW5saW5lIHNvIGl0IG9ubHkgcnVucyBvbiB0aGUgZmFsc2UgcGF0aDoKICAgICAgICAgICAgICAgIGlzQ29tcGF0aWJsZUZhbWlseUZvckhvdFJlbG9hZGluZyhjdXJyZW50MiwgZWxlbWVudCkgfHwgLy8gTGF6eSB0eXBlcyBzaG91bGQgcmVjb25jaWxlIHRoZWlyIHJlc29sdmVkIHR5cGUuCiAgICAgICAgICAgICAgICAvLyBXZSBuZWVkIHRvIGRvIHRoaXMgYWZ0ZXIgdGhlIEhvdCBSZWxvYWRpbmcgY2hlY2sgYWJvdmUsCiAgICAgICAgICAgICAgICAvLyBiZWNhdXNlIGhvdCByZWxvYWRpbmcgaGFzIGRpZmZlcmVudCBzZW1hbnRpY3MgdGhhbiBwcm9kIGJlY2F1c2UKICAgICAgICAgICAgICAgIC8vIGl0IGRvZXNuJ3QgcmVzdXNwZW5kLiBTbyB3ZSBjYW4ndCBsZXQgdGhlIGNhbGwgYmVsb3cgc3VzcGVuZC4KICAgICAgICAgICAgICAgIHR5cGVvZiBlbGVtZW50VHlwZSA9PT0gIm9iamVjdCIgJiYgZWxlbWVudFR5cGUgIT09IG51bGwgJiYgZWxlbWVudFR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0xBWllfVFlQRSAmJiByZXNvbHZlTGF6eShlbGVtZW50VHlwZSkgPT09IGN1cnJlbnQyLnR5cGUpIHsKICAgICAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY3VycmVudDIsIGVsZW1lbnQucHJvcHMpOwogICAgICAgICAgICAgICAgICBleGlzdGluZy5yZWYgPSBjb2VyY2VSZWYocmV0dXJuRmliZXIsIGN1cnJlbnQyLCBlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgZXhpc3RpbmcucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBleGlzdGluZy5fZGVidWdTb3VyY2UgPSBlbGVtZW50Ll9zb3VyY2U7CiAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmcuX2RlYnVnT3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tRWxlbWVudChlbGVtZW50LCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgY3JlYXRlZC5yZWYgPSBjb2VyY2VSZWYocmV0dXJuRmliZXIsIGN1cnJlbnQyLCBlbGVtZW50KTsKICAgICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVBvcnRhbChyZXR1cm5GaWJlciwgY3VycmVudDIsIHBvcnRhbCwgbGFuZXMpIHsKICAgICAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwgfHwgY3VycmVudDIudGFnICE9PSBIb3N0UG9ydGFsIHx8IGN1cnJlbnQyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvICE9PSBwb3J0YWwuY29udGFpbmVySW5mbyB8fCBjdXJyZW50Mi5zdGF0ZU5vZGUuaW1wbGVtZW50YXRpb24gIT09IHBvcnRhbC5pbXBsZW1lbnRhdGlvbikgewogICAgICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21Qb3J0YWwocG9ydGFsLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBleGlzdGluZyA9IHVzZUZpYmVyKGN1cnJlbnQyLCBwb3J0YWwuY2hpbGRyZW4gfHwgW10pOwogICAgICAgICAgICAgICAgZXhpc3RpbmcucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUZyYWdtZW50MihyZXR1cm5GaWJlciwgY3VycmVudDIsIGZyYWdtZW50LCBsYW5lcywga2V5KSB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsIHx8IGN1cnJlbnQyLnRhZyAhPT0gRnJhZ21lbnQpIHsKICAgICAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZnJhZ21lbnQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzLCBrZXkpOwogICAgICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjdXJyZW50MiwgZnJhZ21lbnQpOwogICAgICAgICAgICAgICAgZXhpc3RpbmcucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNoaWxkKHJldHVybkZpYmVyLCBuZXdDaGlsZCwgbGFuZXMpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAic3RyaW5nIiAmJiBuZXdDaGlsZCAhPT0gIiIgfHwgdHlwZW9mIG5ld0NoaWxkID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21UZXh0KCIiICsgbmV3Q2hpbGQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gIm9iamVjdCIgJiYgbmV3Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHN3aXRjaCAobmV3Q2hpbGQuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9FTEVNRU5UX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgICB2YXIgX2NyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21FbGVtZW50KG5ld0NoaWxkLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgICAgICAgX2NyZWF0ZWQucmVmID0gY29lcmNlUmVmKHJldHVybkZpYmVyLCBudWxsLCBuZXdDaGlsZCk7CiAgICAgICAgICAgICAgICAgICAgX2NyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jcmVhdGVkOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgICB2YXIgX2NyZWF0ZWQyID0gY3JlYXRlRmliZXJGcm9tUG9ydGFsKG5ld0NoaWxkLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgICAgICAgX2NyZWF0ZWQyLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBfY3JlYXRlZDI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IG5ld0NoaWxkLl9wYXlsb2FkOwogICAgICAgICAgICAgICAgICAgIHZhciBpbml0MiA9IG5ld0NoaWxkLl9pbml0OwogICAgICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVDaGlsZChyZXR1cm5GaWJlciwgaW5pdDIocGF5bG9hZCksIGxhbmVzKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkobmV3Q2hpbGQpIHx8IGdldEl0ZXJhdG9yRm4obmV3Q2hpbGQpKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfY3JlYXRlZDMgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChuZXdDaGlsZCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMsIG51bGwpOwogICAgICAgICAgICAgICAgICBfY3JlYXRlZDMucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICAgIHJldHVybiBfY3JlYXRlZDM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aHJvd09uSW52YWxpZE9iamVjdFR5cGUocmV0dXJuRmliZXIsIG5ld0NoaWxkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICB3YXJuT25GdW5jdGlvblR5cGUocmV0dXJuRmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVTbG90KHJldHVybkZpYmVyLCBvbGRGaWJlciwgbmV3Q2hpbGQsIGxhbmVzKSB7CiAgICAgICAgICAgICAgdmFyIGtleSA9IG9sZEZpYmVyICE9PSBudWxsID8gb2xkRmliZXIua2V5IDogbnVsbDsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAic3RyaW5nIiAmJiBuZXdDaGlsZCAhPT0gIiIgfHwgdHlwZW9mIG5ld0NoaWxkID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgaWYgKGtleSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVUZXh0Tm9kZShyZXR1cm5GaWJlciwgb2xkRmliZXIsICIiICsgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gIm9iamVjdCIgJiYgbmV3Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHN3aXRjaCAobmV3Q2hpbGQuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9FTEVNRU5UX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgICBpZiAobmV3Q2hpbGQua2V5ID09PSBrZXkpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFbGVtZW50KHJldHVybkZpYmVyLCBvbGRGaWJlciwgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgICBpZiAobmV3Q2hpbGQua2V5ID09PSBrZXkpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVQb3J0YWwocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IG5ld0NoaWxkLl9wYXlsb2FkOwogICAgICAgICAgICAgICAgICAgIHZhciBpbml0MiA9IG5ld0NoaWxkLl9pbml0OwogICAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTbG90KHJldHVybkZpYmVyLCBvbGRGaWJlciwgaW5pdDIocGF5bG9hZCksIGxhbmVzKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkobmV3Q2hpbGQpIHx8IGdldEl0ZXJhdG9yRm4obmV3Q2hpbGQpKSB7CiAgICAgICAgICAgICAgICAgIGlmIChrZXkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRnJhZ21lbnQyKHJldHVybkZpYmVyLCBvbGRGaWJlciwgbmV3Q2hpbGQsIGxhbmVzLCBudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHdhcm5PbkZ1bmN0aW9uVHlwZShyZXR1cm5GaWJlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUZyb21NYXAoZXhpc3RpbmdDaGlsZHJlbiwgcmV0dXJuRmliZXIsIG5ld0lkeCwgbmV3Q2hpbGQsIGxhbmVzKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gInN0cmluZyIgJiYgbmV3Q2hpbGQgIT09ICIiIHx8IHR5cGVvZiBuZXdDaGlsZCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgIHZhciBtYXRjaGVkRmliZXIgPSBleGlzdGluZ0NoaWxkcmVuLmdldChuZXdJZHgpIHx8IG51bGw7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlVGV4dE5vZGUocmV0dXJuRmliZXIsIG1hdGNoZWRGaWJlciwgIiIgKyBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAib2JqZWN0IiAmJiBuZXdDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc3dpdGNoIChuZXdDaGlsZC4kJHR5cGVvZikgewogICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0VMRU1FTlRfVFlQRTogewogICAgICAgICAgICAgICAgICAgIHZhciBfbWF0Y2hlZEZpYmVyID0gZXhpc3RpbmdDaGlsZHJlbi5nZXQobmV3Q2hpbGQua2V5ID09PSBudWxsID8gbmV3SWR4IDogbmV3Q2hpbGQua2V5KSB8fCBudWxsOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFbGVtZW50KHJldHVybkZpYmVyLCBfbWF0Y2hlZEZpYmVyLCBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgICB2YXIgX21hdGNoZWRGaWJlcjIgPSBleGlzdGluZ0NoaWxkcmVuLmdldChuZXdDaGlsZC5rZXkgPT09IG51bGwgPyBuZXdJZHggOiBuZXdDaGlsZC5rZXkpIHx8IG51bGw7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVBvcnRhbChyZXR1cm5GaWJlciwgX21hdGNoZWRGaWJlcjIsIG5ld0NoaWxkLCBsYW5lcyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6CiAgICAgICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBuZXdDaGlsZC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgICAgICB2YXIgaW5pdDIgPSBuZXdDaGlsZC5faW5pdDsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRnJvbU1hcChleGlzdGluZ0NoaWxkcmVuLCByZXR1cm5GaWJlciwgbmV3SWR4LCBpbml0MihwYXlsb2FkKSwgbGFuZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkobmV3Q2hpbGQpIHx8IGdldEl0ZXJhdG9yRm4obmV3Q2hpbGQpKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfbWF0Y2hlZEZpYmVyMyA9IGV4aXN0aW5nQ2hpbGRyZW4uZ2V0KG5ld0lkeCkgfHwgbnVsbDsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZyYWdtZW50MihyZXR1cm5GaWJlciwgX21hdGNoZWRGaWJlcjMsIG5ld0NoaWxkLCBsYW5lcywgbnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aHJvd09uSW52YWxpZE9iamVjdFR5cGUocmV0dXJuRmliZXIsIG5ld0NoaWxkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICB3YXJuT25GdW5jdGlvblR5cGUocmV0dXJuRmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiB3YXJuT25JbnZhbGlkS2V5KGNoaWxkLCBrbm93bktleXMsIHJldHVybkZpYmVyKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjaGlsZCAhPT0gIm9iamVjdCIgfHwgY2hpbGQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGtub3duS2V5czsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN3aXRjaCAoY2hpbGQuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9FTEVNRU5UX1RZUEU6CiAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgICAgICAgd2FybkZvck1pc3NpbmdLZXkoY2hpbGQsIHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICAgICAgICB2YXIga2V5ID0gY2hpbGQua2V5OwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Yga2V5ICE9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChrbm93bktleXMgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIGtub3duS2V5cyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgICAgICAgICAgICBrbm93bktleXMuYWRkKGtleSk7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKCFrbm93bktleXMuaGFzKGtleSkpIHsKICAgICAgICAgICAgICAgICAgICAgIGtub3duS2V5cy5hZGQoa2V5KTsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlcnJvcigiRW5jb3VudGVyZWQgdHdvIGNoaWxkcmVuIHdpdGggdGhlIHNhbWUga2V5LCBgJXNgLiBLZXlzIHNob3VsZCBiZSB1bmlxdWUgc28gdGhhdCBjb21wb25lbnRzIG1haW50YWluIHRoZWlyIGlkZW50aXR5IGFjcm9zcyB1cGRhdGVzLiBOb24tdW5pcXVlIGtleXMgbWF5IGNhdXNlIGNoaWxkcmVuIHRvIGJlIGR1cGxpY2F0ZWQgYW5kL29yIG9taXR0ZWQgXHUyMDE0IHRoZSBiZWhhdmlvciBpcyB1bnN1cHBvcnRlZCBhbmQgY291bGQgY2hhbmdlIGluIGEgZnV0dXJlIHZlcnNpb24uIiwga2V5KTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6CiAgICAgICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBjaGlsZC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgICAgICB2YXIgaW5pdDIgPSBjaGlsZC5faW5pdDsKICAgICAgICAgICAgICAgICAgICB3YXJuT25JbnZhbGlkS2V5KGluaXQyKHBheWxvYWQpLCBrbm93bktleXMsIHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGtub3duS2V5czsKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiByZWNvbmNpbGVDaGlsZHJlbkFycmF5KHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGRyZW4sIGxhbmVzKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGtub3duS2V5cyA9IG51bGw7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5ld0NoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IG5ld0NoaWxkcmVuW2ldOwogICAgICAgICAgICAgICAgICBrbm93bktleXMgPSB3YXJuT25JbnZhbGlkS2V5KGNoaWxkLCBrbm93bktleXMsIHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBudWxsOwogICAgICAgICAgICAgIHZhciBwcmV2aW91c05ld0ZpYmVyID0gbnVsbDsKICAgICAgICAgICAgICB2YXIgb2xkRmliZXIgPSBjdXJyZW50Rmlyc3RDaGlsZDsKICAgICAgICAgICAgICB2YXIgbGFzdFBsYWNlZEluZGV4ID0gMDsKICAgICAgICAgICAgICB2YXIgbmV3SWR4ID0gMDsKICAgICAgICAgICAgICB2YXIgbmV4dE9sZEZpYmVyID0gbnVsbDsKICAgICAgICAgICAgICBmb3IgKDsgb2xkRmliZXIgIT09IG51bGwgJiYgbmV3SWR4IDwgbmV3Q2hpbGRyZW4ubGVuZ3RoOyBuZXdJZHgrKykgewogICAgICAgICAgICAgICAgaWYgKG9sZEZpYmVyLmluZGV4ID4gbmV3SWR4KSB7CiAgICAgICAgICAgICAgICAgIG5leHRPbGRGaWJlciA9IG9sZEZpYmVyOwogICAgICAgICAgICAgICAgICBvbGRGaWJlciA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBuZXh0T2xkRmliZXIgPSBvbGRGaWJlci5zaWJsaW5nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG5ld0ZpYmVyID0gdXBkYXRlU2xvdChyZXR1cm5GaWJlciwgb2xkRmliZXIsIG5ld0NoaWxkcmVuW25ld0lkeF0sIGxhbmVzKTsKICAgICAgICAgICAgICAgIGlmIChuZXdGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBpZiAob2xkRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBvbGRGaWJlciA9IG5leHRPbGRGaWJlcjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgICAgIGlmIChvbGRGaWJlciAmJiBuZXdGaWJlci5hbHRlcm5hdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgb2xkRmliZXIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKG5ld0ZpYmVyLCBsYXN0UGxhY2VkSW5kZXgsIG5ld0lkeCk7CiAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNOZXdGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXN1bHRpbmdGaXJzdENoaWxkID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyLnNpYmxpbmcgPSBuZXdGaWJlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBuZXdGaWJlcjsKICAgICAgICAgICAgICAgIG9sZEZpYmVyID0gbmV4dE9sZEZpYmVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobmV3SWR4ID09PSBuZXdDaGlsZHJlbi5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBvbGRGaWJlcik7CiAgICAgICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgICAgICB2YXIgbnVtYmVyT2ZGb3JrcyA9IG5ld0lkeDsKICAgICAgICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHJldHVybkZpYmVyLCBudW1iZXJPZkZvcmtzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAob2xkRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZvciAoOyBuZXdJZHggPCBuZXdDaGlsZHJlbi5sZW5ndGg7IG5ld0lkeCsrKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfbmV3RmliZXIgPSBjcmVhdGVDaGlsZChyZXR1cm5GaWJlciwgbmV3Q2hpbGRyZW5bbmV3SWR4XSwgbGFuZXMpOwogICAgICAgICAgICAgICAgICBpZiAoX25ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChfbmV3RmliZXIsIGxhc3RQbGFjZWRJbmRleCwgbmV3SWR4KTsKICAgICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHRpbmdGaXJzdENoaWxkID0gX25ld0ZpYmVyOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IF9uZXdGaWJlcjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gX25ld0ZpYmVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9udW1iZXJPZkZvcmtzID0gbmV3SWR4OwogICAgICAgICAgICAgICAgICBwdXNoVHJlZUZvcmsocmV0dXJuRmliZXIsIF9udW1iZXJPZkZvcmtzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZXhpc3RpbmdDaGlsZHJlbiA9IG1hcFJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBvbGRGaWJlcik7CiAgICAgICAgICAgICAgZm9yICg7IG5ld0lkeCA8IG5ld0NoaWxkcmVuLmxlbmd0aDsgbmV3SWR4KyspIHsKICAgICAgICAgICAgICAgIHZhciBfbmV3RmliZXIyID0gdXBkYXRlRnJvbU1hcChleGlzdGluZ0NoaWxkcmVuLCByZXR1cm5GaWJlciwgbmV3SWR4LCBuZXdDaGlsZHJlbltuZXdJZHhdLCBsYW5lcyk7CiAgICAgICAgICAgICAgICBpZiAoX25ld0ZpYmVyMiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgICAgICAgIGlmIChfbmV3RmliZXIyLmFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZHJlbi5kZWxldGUoX25ld0ZpYmVyMi5rZXkgPT09IG51bGwgPyBuZXdJZHggOiBfbmV3RmliZXIyLmtleSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGxhc3RQbGFjZWRJbmRleCA9IHBsYWNlQ2hpbGQoX25ld0ZpYmVyMiwgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwogICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNOZXdGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBfbmV3RmliZXIyOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IF9uZXdGaWJlcjI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlciA9IF9uZXdGaWJlcjI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgICBleGlzdGluZ0NoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24oY2hpbGQyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgY2hpbGQyKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgICAgdmFyIF9udW1iZXJPZkZvcmtzMiA9IG5ld0lkeDsKICAgICAgICAgICAgICAgIHB1c2hUcmVlRm9yayhyZXR1cm5GaWJlciwgX251bWJlck9mRm9ya3MyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdGluZ0ZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlQ2hpbGRyZW5JdGVyYXRvcihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkcmVuSXRlcmFibGUsIGxhbmVzKSB7CiAgICAgICAgICAgICAgdmFyIGl0ZXJhdG9yRm4gPSBnZXRJdGVyYXRvckZuKG5ld0NoaWxkcmVuSXRlcmFibGUpOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgaXRlcmF0b3JGbiAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBbiBvYmplY3QgaXMgbm90IGFuIGl0ZXJhYmxlLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiAvLyAkRmxvd0ZpeE1lIEZsb3cgZG9lc24ndCBrbm93IGFib3V0IHRvU3RyaW5nVGFnCiAgICAgICAgICAgICAgICBuZXdDaGlsZHJlbkl0ZXJhYmxlW1N5bWJvbC50b1N0cmluZ1RhZ10gPT09ICJHZW5lcmF0b3IiKSB7CiAgICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0R2VuZXJhdG9ycykgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCJVc2luZyBHZW5lcmF0b3JzIGFzIGNoaWxkcmVuIGlzIHVuc3VwcG9ydGVkIGFuZCB3aWxsIGxpa2VseSB5aWVsZCB1bmV4cGVjdGVkIHJlc3VsdHMgYmVjYXVzZSBlbnVtZXJhdGluZyBhIGdlbmVyYXRvciBtdXRhdGVzIGl0LiBZb3UgbWF5IGNvbnZlcnQgaXQgdG8gYW4gYXJyYXkgd2l0aCBgQXJyYXkuZnJvbSgpYCBvciB0aGUgYFsuLi5zcHJlYWRdYCBvcGVyYXRvciBiZWZvcmUgcmVuZGVyaW5nLiBLZWVwIGluIG1pbmQgeW91IG1pZ2h0IG5lZWQgdG8gcG9seWZpbGwgdGhlc2UgZmVhdHVyZXMgZm9yIG9sZGVyIGJyb3dzZXJzLiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEdlbmVyYXRvcnMgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG5ld0NoaWxkcmVuSXRlcmFibGUuZW50cmllcyA9PT0gaXRlcmF0b3JGbikgewogICAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dE1hcHMpIHsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiVXNpbmcgTWFwcyBhcyBjaGlsZHJlbiBpcyBub3Qgc3VwcG9ydGVkLiBVc2UgYW4gYXJyYXkgb2Yga2V5ZWQgUmVhY3RFbGVtZW50cyBpbnN0ZWFkLiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dE1hcHMgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIF9uZXdDaGlsZHJlbiA9IGl0ZXJhdG9yRm4uY2FsbChuZXdDaGlsZHJlbkl0ZXJhYmxlKTsKICAgICAgICAgICAgICAgIGlmIChfbmV3Q2hpbGRyZW4pIHsKICAgICAgICAgICAgICAgICAgdmFyIGtub3duS2V5cyA9IG51bGw7CiAgICAgICAgICAgICAgICAgIHZhciBfc3RlcCA9IF9uZXdDaGlsZHJlbi5uZXh0KCk7CiAgICAgICAgICAgICAgICAgIGZvciAoOyAhX3N0ZXAuZG9uZTsgX3N0ZXAgPSBfbmV3Q2hpbGRyZW4ubmV4dCgpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gX3N0ZXAudmFsdWU7CiAgICAgICAgICAgICAgICAgICAga25vd25LZXlzID0gd2Fybk9uSW52YWxpZEtleShjaGlsZCwga25vd25LZXlzLCByZXR1cm5GaWJlcik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG5ld0NoaWxkcmVuID0gaXRlcmF0b3JGbi5jYWxsKG5ld0NoaWxkcmVuSXRlcmFibGUpOwogICAgICAgICAgICAgIGlmIChuZXdDaGlsZHJlbiA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkFuIGl0ZXJhYmxlIG9iamVjdCBwcm92aWRlZCBubyBpdGVyYXRvci4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBudWxsOwogICAgICAgICAgICAgIHZhciBwcmV2aW91c05ld0ZpYmVyID0gbnVsbDsKICAgICAgICAgICAgICB2YXIgb2xkRmliZXIgPSBjdXJyZW50Rmlyc3RDaGlsZDsKICAgICAgICAgICAgICB2YXIgbGFzdFBsYWNlZEluZGV4ID0gMDsKICAgICAgICAgICAgICB2YXIgbmV3SWR4ID0gMDsKICAgICAgICAgICAgICB2YXIgbmV4dE9sZEZpYmVyID0gbnVsbDsKICAgICAgICAgICAgICB2YXIgc3RlcCA9IG5ld0NoaWxkcmVuLm5leHQoKTsKICAgICAgICAgICAgICBmb3IgKDsgb2xkRmliZXIgIT09IG51bGwgJiYgIXN0ZXAuZG9uZTsgbmV3SWR4KyssIHN0ZXAgPSBuZXdDaGlsZHJlbi5uZXh0KCkpIHsKICAgICAgICAgICAgICAgIGlmIChvbGRGaWJlci5pbmRleCA+IG5ld0lkeCkgewogICAgICAgICAgICAgICAgICBuZXh0T2xkRmliZXIgPSBvbGRGaWJlcjsKICAgICAgICAgICAgICAgICAgb2xkRmliZXIgPSBudWxsOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgbmV4dE9sZEZpYmVyID0gb2xkRmliZXIuc2libGluZzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBuZXdGaWJlciA9IHVwZGF0ZVNsb3QocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBzdGVwLnZhbHVlLCBsYW5lcyk7CiAgICAgICAgICAgICAgICBpZiAobmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgaWYgKG9sZEZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgb2xkRmliZXIgPSBuZXh0T2xkRmliZXI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgICAgICBpZiAob2xkRmliZXIgJiYgbmV3RmliZXIuYWx0ZXJuYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChuZXdGaWJlciwgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwogICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmVzdWx0aW5nRmlyc3RDaGlsZCA9IG5ld0ZpYmVyOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlci5zaWJsaW5nID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgICBvbGRGaWJlciA9IG5leHRPbGRGaWJlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHN0ZXAuZG9uZSkgewogICAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgICAgIHZhciBudW1iZXJPZkZvcmtzID0gbmV3SWR4OwogICAgICAgICAgICAgICAgICBwdXNoVHJlZUZvcmsocmV0dXJuRmliZXIsIG51bWJlck9mRm9ya3MpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdGluZ0ZpcnN0Q2hpbGQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChvbGRGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgZm9yICg7ICFzdGVwLmRvbmU7IG5ld0lkeCsrLCBzdGVwID0gbmV3Q2hpbGRyZW4ubmV4dCgpKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfbmV3RmliZXIzID0gY3JlYXRlQ2hpbGQocmV0dXJuRmliZXIsIHN0ZXAudmFsdWUsIGxhbmVzKTsKICAgICAgICAgICAgICAgICAgaWYgKF9uZXdGaWJlcjMgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKF9uZXdGaWJlcjMsIGxhc3RQbGFjZWRJbmRleCwgbmV3SWR4KTsKICAgICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHRpbmdGaXJzdENoaWxkID0gX25ld0ZpYmVyMzsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyLnNpYmxpbmcgPSBfbmV3RmliZXIzOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBfbmV3RmliZXIzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9udW1iZXJPZkZvcmtzMyA9IG5ld0lkeDsKICAgICAgICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHJldHVybkZpYmVyLCBfbnVtYmVyT2ZGb3JrczMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdGluZ0ZpcnN0Q2hpbGQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBleGlzdGluZ0NoaWxkcmVuID0gbWFwUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgICBmb3IgKDsgIXN0ZXAuZG9uZTsgbmV3SWR4KyssIHN0ZXAgPSBuZXdDaGlsZHJlbi5uZXh0KCkpIHsKICAgICAgICAgICAgICAgIHZhciBfbmV3RmliZXI0ID0gdXBkYXRlRnJvbU1hcChleGlzdGluZ0NoaWxkcmVuLCByZXR1cm5GaWJlciwgbmV3SWR4LCBzdGVwLnZhbHVlLCBsYW5lcyk7CiAgICAgICAgICAgICAgICBpZiAoX25ld0ZpYmVyNCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgICAgICAgIGlmIChfbmV3RmliZXI0LmFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZHJlbi5kZWxldGUoX25ld0ZpYmVyNC5rZXkgPT09IG51bGwgPyBuZXdJZHggOiBfbmV3RmliZXI0LmtleSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGxhc3RQbGFjZWRJbmRleCA9IHBsYWNlQ2hpbGQoX25ld0ZpYmVyNCwgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwogICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNOZXdGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBfbmV3RmliZXI0OwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IF9uZXdGaWJlcjQ7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlciA9IF9uZXdGaWJlcjQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgICBleGlzdGluZ0NoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24oY2hpbGQyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgY2hpbGQyKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgICAgdmFyIF9udW1iZXJPZkZvcmtzNCA9IG5ld0lkeDsKICAgICAgICAgICAgICAgIHB1c2hUcmVlRm9yayhyZXR1cm5GaWJlciwgX251bWJlck9mRm9ya3M0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdGluZ0ZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlU2luZ2xlVGV4dE5vZGUocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCB0ZXh0Q29udGVudCwgbGFuZXMpIHsKICAgICAgICAgICAgICBpZiAoY3VycmVudEZpcnN0Q2hpbGQgIT09IG51bGwgJiYgY3VycmVudEZpcnN0Q2hpbGQudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLnNpYmxpbmcpOwogICAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY3VycmVudEZpcnN0Q2hpbGQsIHRleHRDb250ZW50KTsKICAgICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tVGV4dCh0ZXh0Q29udGVudCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMpOwogICAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlU2luZ2xlRWxlbWVudChyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIGVsZW1lbnQsIGxhbmVzKSB7CiAgICAgICAgICAgICAgdmFyIGtleSA9IGVsZW1lbnQua2V5OwogICAgICAgICAgICAgIHZhciBjaGlsZCA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKGNoaWxkLmtleSA9PT0ga2V5KSB7CiAgICAgICAgICAgICAgICAgIHZhciBlbGVtZW50VHlwZSA9IGVsZW1lbnQudHlwZTsKICAgICAgICAgICAgICAgICAgaWYgKGVsZW1lbnRUeXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLnRhZyA9PT0gRnJhZ21lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjaGlsZC5zaWJsaW5nKTsKICAgICAgICAgICAgICAgICAgICAgIHZhciBleGlzdGluZyA9IHVzZUZpYmVyKGNoaWxkLCBlbGVtZW50LnByb3BzLmNoaWxkcmVuKTsKICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZy5fZGVidWdTb3VyY2UgPSBlbGVtZW50Ll9zb3VyY2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nLl9kZWJ1Z093bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC5lbGVtZW50VHlwZSA9PT0gZWxlbWVudFR5cGUgfHwgLy8gS2VlcCB0aGlzIGNoZWNrIGlubGluZSBzbyBpdCBvbmx5IHJ1bnMgb24gdGhlIGZhbHNlIHBhdGg6CiAgICAgICAgICAgICAgICAgICAgaXNDb21wYXRpYmxlRmFtaWx5Rm9ySG90UmVsb2FkaW5nKGNoaWxkLCBlbGVtZW50KSB8fCAvLyBMYXp5IHR5cGVzIHNob3VsZCByZWNvbmNpbGUgdGhlaXIgcmVzb2x2ZWQgdHlwZS4KICAgICAgICAgICAgICAgICAgICAvLyBXZSBuZWVkIHRvIGRvIHRoaXMgYWZ0ZXIgdGhlIEhvdCBSZWxvYWRpbmcgY2hlY2sgYWJvdmUsCiAgICAgICAgICAgICAgICAgICAgLy8gYmVjYXVzZSBob3QgcmVsb2FkaW5nIGhhcyBkaWZmZXJlbnQgc2VtYW50aWNzIHRoYW4gcHJvZCBiZWNhdXNlCiAgICAgICAgICAgICAgICAgICAgLy8gaXQgZG9lc24ndCByZXN1c3BlbmQuIFNvIHdlIGNhbid0IGxldCB0aGUgY2FsbCBiZWxvdyBzdXNwZW5kLgogICAgICAgICAgICAgICAgICAgIHR5cGVvZiBlbGVtZW50VHlwZSA9PT0gIm9iamVjdCIgJiYgZWxlbWVudFR5cGUgIT09IG51bGwgJiYgZWxlbWVudFR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0xBWllfVFlQRSAmJiByZXNvbHZlTGF6eShlbGVtZW50VHlwZSkgPT09IGNoaWxkLnR5cGUpIHsKICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjaGlsZC5zaWJsaW5nKTsKICAgICAgICAgICAgICAgICAgICAgIHZhciBfZXhpc3RpbmcgPSB1c2VGaWJlcihjaGlsZCwgZWxlbWVudC5wcm9wcyk7CiAgICAgICAgICAgICAgICAgICAgICBfZXhpc3RpbmcucmVmID0gY29lcmNlUmVmKHJldHVybkZpYmVyLCBjaGlsZCwgZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgICBfZXhpc3RpbmcucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9leGlzdGluZy5fZGVidWdTb3VyY2UgPSBlbGVtZW50Ll9zb3VyY2U7CiAgICAgICAgICAgICAgICAgICAgICAgIF9leGlzdGluZy5fZGVidWdPd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9leGlzdGluZzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGNoaWxkKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgY2hpbGQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZWxlbWVudC50eXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFKSB7CiAgICAgICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KGVsZW1lbnQucHJvcHMuY2hpbGRyZW4sIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzLCBlbGVtZW50LmtleSk7CiAgICAgICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBfY3JlYXRlZDQgPSBjcmVhdGVGaWJlckZyb21FbGVtZW50KGVsZW1lbnQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgICAgIF9jcmVhdGVkNC5yZWYgPSBjb2VyY2VSZWYocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBlbGVtZW50KTsKICAgICAgICAgICAgICAgIF9jcmVhdGVkNC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgIHJldHVybiBfY3JlYXRlZDQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZVNpbmdsZVBvcnRhbChyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIHBvcnRhbCwgbGFuZXMpIHsKICAgICAgICAgICAgICB2YXIga2V5ID0gcG9ydGFsLmtleTsKICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBjdXJyZW50Rmlyc3RDaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChjaGlsZC5rZXkgPT09IGtleSkgewogICAgICAgICAgICAgICAgICBpZiAoY2hpbGQudGFnID09PSBIb3N0UG9ydGFsICYmIGNoaWxkLnN0YXRlTm9kZS5jb250YWluZXJJbmZvID09PSBwb3J0YWwuY29udGFpbmVySW5mbyAmJiBjaGlsZC5zdGF0ZU5vZGUuaW1wbGVtZW50YXRpb24gPT09IHBvcnRhbC5pbXBsZW1lbnRhdGlvbikgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjaGlsZC5zaWJsaW5nKTsKICAgICAgICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjaGlsZCwgcG9ydGFsLmNoaWxkcmVuIHx8IFtdKTsKICAgICAgICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGNoaWxkKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21Qb3J0YWwocG9ydGFsLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiByZWNvbmNpbGVDaGlsZEZpYmVyczIocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZCwgbGFuZXMpIHsKICAgICAgICAgICAgICB2YXIgaXNVbmtleWVkVG9wTGV2ZWxGcmFnbWVudCA9IHR5cGVvZiBuZXdDaGlsZCA9PT0gIm9iamVjdCIgJiYgbmV3Q2hpbGQgIT09IG51bGwgJiYgbmV3Q2hpbGQudHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSAmJiBuZXdDaGlsZC5rZXkgPT09IG51bGw7CiAgICAgICAgICAgICAgaWYgKGlzVW5rZXllZFRvcExldmVsRnJhZ21lbnQpIHsKICAgICAgICAgICAgICAgIG5ld0NoaWxkID0gbmV3Q2hpbGQucHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJvYmplY3QiICYmIG5ld0NoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKG5ld0NoaWxkLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRUxFTUVOVF9UWVBFOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGFjZVNpbmdsZUNoaWxkKHJlY29uY2lsZVNpbmdsZUVsZW1lbnQocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZCwgbGFuZXMpKTsKICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxhY2VTaW5nbGVDaGlsZChyZWNvbmNpbGVTaW5nbGVQb3J0YWwocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZCwgbGFuZXMpKTsKICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6CiAgICAgICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBuZXdDaGlsZC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgICAgICB2YXIgaW5pdDIgPSBuZXdDaGlsZC5faW5pdDsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVjb25jaWxlQ2hpbGRGaWJlcnMyKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgaW5pdDIocGF5bG9hZCksIGxhbmVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KG5ld0NoaWxkKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gcmVjb25jaWxlQ2hpbGRyZW5BcnJheShyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkLCBsYW5lcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZ2V0SXRlcmF0b3JGbihuZXdDaGlsZCkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlY29uY2lsZUNoaWxkcmVuSXRlcmF0b3IocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhyb3dPbkludmFsaWRPYmplY3RUeXBlKHJldHVybkZpYmVyLCBuZXdDaGlsZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJzdHJpbmciICYmIG5ld0NoaWxkICE9PSAiIiB8fCB0eXBlb2YgbmV3Q2hpbGQgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcGxhY2VTaW5nbGVDaGlsZChyZWNvbmNpbGVTaW5nbGVUZXh0Tm9kZShyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsICIiICsgbmV3Q2hpbGQsIGxhbmVzKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgd2Fybk9uRnVuY3Rpb25UeXBlKHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlY29uY2lsZUNoaWxkRmliZXJzMjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciByZWNvbmNpbGVDaGlsZEZpYmVycyA9IENoaWxkUmVjb25jaWxlcih0cnVlKTsKICAgICAgICAgIHZhciBtb3VudENoaWxkRmliZXJzID0gQ2hpbGRSZWNvbmNpbGVyKGZhbHNlKTsKICAgICAgICAgIGZ1bmN0aW9uIGNsb25lQ2hpbGRGaWJlcnMoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwgJiYgd29ya0luUHJvZ3Jlc3MyLmNoaWxkICE9PSBjdXJyZW50Mi5jaGlsZCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVzdW1pbmcgd29yayBub3QgeWV0IGltcGxlbWVudGVkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGN1cnJlbnRDaGlsZCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgdmFyIG5ld0NoaWxkID0gY3JlYXRlV29ya0luUHJvZ3Jlc3MoY3VycmVudENoaWxkLCBjdXJyZW50Q2hpbGQucGVuZGluZ1Byb3BzKTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gbmV3Q2hpbGQ7CiAgICAgICAgICAgIG5ld0NoaWxkLnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnRDaGlsZC5zaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgY3VycmVudENoaWxkID0gY3VycmVudENoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgbmV3Q2hpbGQgPSBuZXdDaGlsZC5zaWJsaW5nID0gY3JlYXRlV29ya0luUHJvZ3Jlc3MoY3VycmVudENoaWxkLCBjdXJyZW50Q2hpbGQucGVuZGluZ1Byb3BzKTsKICAgICAgICAgICAgICBuZXdDaGlsZC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV3Q2hpbGQuc2libGluZyA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZXNldENoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgbGFuZXMpIHsKICAgICAgICAgICAgdmFyIGNoaWxkID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICByZXNldFdvcmtJblByb2dyZXNzKGNoaWxkLCBsYW5lcyk7CiAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgTk9fQ09OVEVYVCA9IHt9OwogICAgICAgICAgdmFyIGNvbnRleHRTdGFja0N1cnNvciQxID0gY3JlYXRlQ3Vyc29yKE5PX0NPTlRFWFQpOwogICAgICAgICAgdmFyIGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKE5PX0NPTlRFWFQpOwogICAgICAgICAgdmFyIHJvb3RJbnN0YW5jZVN0YWNrQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKE5PX0NPTlRFWFQpOwogICAgICAgICAgZnVuY3Rpb24gcmVxdWlyZWRDb250ZXh0KGMyKSB7CiAgICAgICAgICAgIGlmIChjMiA9PT0gTk9fQ09OVEVYVCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgaG9zdCBjb250ZXh0IHRvIGV4aXN0LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjMjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldFJvb3RIb3N0Q29udGFpbmVyKCkgewogICAgICAgICAgICB2YXIgcm9vdEluc3RhbmNlID0gcmVxdWlyZWRDb250ZXh0KHJvb3RJbnN0YW5jZVN0YWNrQ3Vyc29yLmN1cnJlbnQpOwogICAgICAgICAgICByZXR1cm4gcm9vdEluc3RhbmNlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcHVzaEhvc3RDb250YWluZXIoZmliZXIsIG5leHRSb290SW5zdGFuY2UpIHsKICAgICAgICAgICAgcHVzaChyb290SW5zdGFuY2VTdGFja0N1cnNvciwgbmV4dFJvb3RJbnN0YW5jZSwgZmliZXIpOwogICAgICAgICAgICBwdXNoKGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yLCBmaWJlciwgZmliZXIpOwogICAgICAgICAgICBwdXNoKGNvbnRleHRTdGFja0N1cnNvciQxLCBOT19DT05URVhULCBmaWJlcik7CiAgICAgICAgICAgIHZhciBuZXh0Um9vdENvbnRleHQgPSBnZXRSb290SG9zdENvbnRleHQobmV4dFJvb3RJbnN0YW5jZSk7CiAgICAgICAgICAgIHBvcChjb250ZXh0U3RhY2tDdXJzb3IkMSwgZmliZXIpOwogICAgICAgICAgICBwdXNoKGNvbnRleHRTdGFja0N1cnNvciQxLCBuZXh0Um9vdENvbnRleHQsIGZpYmVyKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHBvcEhvc3RDb250YWluZXIoZmliZXIpIHsKICAgICAgICAgICAgcG9wKGNvbnRleHRTdGFja0N1cnNvciQxLCBmaWJlcik7CiAgICAgICAgICAgIHBvcChjb250ZXh0RmliZXJTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgICBwb3Aocm9vdEluc3RhbmNlU3RhY2tDdXJzb3IsIGZpYmVyKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldEhvc3RDb250ZXh0KCkgewogICAgICAgICAgICB2YXIgY29udGV4dCA9IHJlcXVpcmVkQ29udGV4dChjb250ZXh0U3RhY2tDdXJzb3IkMS5jdXJyZW50KTsKICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwdXNoSG9zdENvbnRleHQoZmliZXIpIHsKICAgICAgICAgICAgdmFyIHJvb3RJbnN0YW5jZSA9IHJlcXVpcmVkQ29udGV4dChyb290SW5zdGFuY2VTdGFja0N1cnNvci5jdXJyZW50KTsKICAgICAgICAgICAgdmFyIGNvbnRleHQgPSByZXF1aXJlZENvbnRleHQoY29udGV4dFN0YWNrQ3Vyc29yJDEuY3VycmVudCk7CiAgICAgICAgICAgIHZhciBuZXh0Q29udGV4dCA9IGdldENoaWxkSG9zdENvbnRleHQoY29udGV4dCwgZmliZXIudHlwZSk7CiAgICAgICAgICAgIGlmIChjb250ZXh0ID09PSBuZXh0Q29udGV4dCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBwdXNoKGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yLCBmaWJlciwgZmliZXIpOwogICAgICAgICAgICBwdXNoKGNvbnRleHRTdGFja0N1cnNvciQxLCBuZXh0Q29udGV4dCwgZmliZXIpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcG9wSG9zdENvbnRleHQoZmliZXIpIHsKICAgICAgICAgICAgaWYgKGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yLmN1cnJlbnQgIT09IGZpYmVyKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBvcChjb250ZXh0U3RhY2tDdXJzb3IkMSwgZmliZXIpOwogICAgICAgICAgICBwb3AoY29udGV4dEZpYmVyU3RhY2tDdXJzb3IsIGZpYmVyKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBEZWZhdWx0U3VzcGVuc2VDb250ZXh0ID0gMDsKICAgICAgICAgIHZhciBTdWJ0cmVlU3VzcGVuc2VDb250ZXh0TWFzayA9IDE7CiAgICAgICAgICB2YXIgSW52aXNpYmxlUGFyZW50U3VzcGVuc2VDb250ZXh0ID0gMTsKICAgICAgICAgIHZhciBGb3JjZVN1c3BlbnNlRmFsbGJhY2sgPSAyOwogICAgICAgICAgdmFyIHN1c3BlbnNlU3RhY2tDdXJzb3IgPSBjcmVhdGVDdXJzb3IoRGVmYXVsdFN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgICBmdW5jdGlvbiBoYXNTdXNwZW5zZUNvbnRleHQocGFyZW50Q29udGV4dCwgZmxhZykgewogICAgICAgICAgICByZXR1cm4gKHBhcmVudENvbnRleHQgJiBmbGFnKSAhPT0gMDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHNldERlZmF1bHRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHBhcmVudENvbnRleHQpIHsKICAgICAgICAgICAgcmV0dXJuIHBhcmVudENvbnRleHQgJiBTdWJ0cmVlU3VzcGVuc2VDb250ZXh0TWFzazsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHNldFNoYWxsb3dTdXNwZW5zZUNvbnRleHQocGFyZW50Q29udGV4dCwgc2hhbGxvd0NvbnRleHQpIHsKICAgICAgICAgICAgcmV0dXJuIHBhcmVudENvbnRleHQgJiBTdWJ0cmVlU3VzcGVuc2VDb250ZXh0TWFzayB8IHNoYWxsb3dDb250ZXh0OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gYWRkU3VidHJlZVN1c3BlbnNlQ29udGV4dChwYXJlbnRDb250ZXh0LCBzdWJ0cmVlQ29udGV4dCkgewogICAgICAgICAgICByZXR1cm4gcGFyZW50Q29udGV4dCB8IHN1YnRyZWVDb250ZXh0OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcHVzaFN1c3BlbnNlQ29udGV4dChmaWJlciwgbmV3Q29udGV4dCkgewogICAgICAgICAgICBwdXNoKHN1c3BlbnNlU3RhY2tDdXJzb3IsIG5ld0NvbnRleHQsIGZpYmVyKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHBvcFN1c3BlbnNlQ29udGV4dChmaWJlcikgewogICAgICAgICAgICBwb3Aoc3VzcGVuc2VTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gc2hvdWxkQ2FwdHVyZVN1c3BlbnNlKHdvcmtJblByb2dyZXNzMiwgaGFzSW52aXNpYmxlUGFyZW50KSB7CiAgICAgICAgICAgIHZhciBuZXh0U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgaWYgKG5leHRTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChuZXh0U3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBmaW5kRmlyc3RTdXNwZW5kZWQocm93KSB7CiAgICAgICAgICAgIHZhciBub2RlID0gcm93OwogICAgICAgICAgICB3aGlsZSAobm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgIHZhciBzdGF0ZSA9IG5vZGUubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgIGlmIChzdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgZGVoeWRyYXRlZCA9IHN0YXRlLmRlaHlkcmF0ZWQ7CiAgICAgICAgICAgICAgICAgIGlmIChkZWh5ZHJhdGVkID09PSBudWxsIHx8IGlzU3VzcGVuc2VJbnN0YW5jZVBlbmRpbmcoZGVoeWRyYXRlZCkgfHwgaXNTdXNwZW5zZUluc3RhbmNlRmFsbGJhY2soZGVoeWRyYXRlZCkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS50YWcgPT09IFN1c3BlbnNlTGlzdENvbXBvbmVudCAmJiAvLyByZXZlYWxPcmRlciB1bmRlZmluZWQgY2FuJ3QgYmUgdHJ1c3RlZCBiZWNhdXNlIGl0IGRvbid0CiAgICAgICAgICAgICAgLy8ga2VlcCB0cmFjayBvZiB3aGV0aGVyIGl0IHN1c3BlbmRlZCBvciBub3QuCiAgICAgICAgICAgICAgbm9kZS5tZW1vaXplZFByb3BzLnJldmVhbE9yZGVyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHZhciBkaWRTdXNwZW5kID0gKG5vZGUuZmxhZ3MgJiBEaWRDYXB0dXJlKSAhPT0gTm9GbGFnczsKICAgICAgICAgICAgICAgIGlmIChkaWRTdXNwZW5kKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbm9kZS5jaGlsZC5yZXR1cm4gPSBub2RlOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IHJvdykgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChub2RlLnJldHVybiA9PT0gbnVsbCB8fCBub2RlLnJldHVybiA9PT0gcm93KSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlLnNpYmxpbmcucmV0dXJuID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBOb0ZsYWdzJDEgPSAoCiAgICAgICAgICAgIC8qICAgKi8KICAgICAgICAgICAgMAogICAgICAgICAgKTsKICAgICAgICAgIHZhciBIYXNFZmZlY3QgPSAoCiAgICAgICAgICAgIC8qICovCiAgICAgICAgICAgIDEKICAgICAgICAgICk7CiAgICAgICAgICB2YXIgSW5zZXJ0aW9uID0gKAogICAgICAgICAgICAvKiAgKi8KICAgICAgICAgICAgMgogICAgICAgICAgKTsKICAgICAgICAgIHZhciBMYXlvdXQgPSAoCiAgICAgICAgICAgIC8qICAgICovCiAgICAgICAgICAgIDQKICAgICAgICAgICk7CiAgICAgICAgICB2YXIgUGFzc2l2ZSQxID0gKAogICAgICAgICAgICAvKiAgICovCiAgICAgICAgICAgIDgKICAgICAgICAgICk7CiAgICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NTb3VyY2VzID0gW107CiAgICAgICAgICBmdW5jdGlvbiByZXNldFdvcmtJblByb2dyZXNzVmVyc2lvbnMoKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgd29ya0luUHJvZ3Jlc3NTb3VyY2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIG11dGFibGVTb3VyY2UgPSB3b3JrSW5Qcm9ncmVzc1NvdXJjZXNbaV07CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbXV0YWJsZVNvdXJjZS5fd29ya0luUHJvZ3Jlc3NWZXJzaW9uUHJpbWFyeSA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzU291cmNlcy5sZW5ndGggPSAwOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJNdXRhYmxlU291cmNlRm9ySHlkcmF0aW9uKHJvb3QzLCBtdXRhYmxlU291cmNlKSB7CiAgICAgICAgICAgIHZhciBnZXRWZXJzaW9uID0gbXV0YWJsZVNvdXJjZS5fZ2V0VmVyc2lvbjsKICAgICAgICAgICAgdmFyIHZlcnNpb24gPSBnZXRWZXJzaW9uKG11dGFibGVTb3VyY2UuX3NvdXJjZSk7CiAgICAgICAgICAgIGlmIChyb290My5tdXRhYmxlU291cmNlRWFnZXJIeWRyYXRpb25EYXRhID09IG51bGwpIHsKICAgICAgICAgICAgICByb290My5tdXRhYmxlU291cmNlRWFnZXJIeWRyYXRpb25EYXRhID0gW211dGFibGVTb3VyY2UsIHZlcnNpb25dOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJvb3QzLm11dGFibGVTb3VyY2VFYWdlckh5ZHJhdGlvbkRhdGEucHVzaChtdXRhYmxlU291cmNlLCB2ZXJzaW9uKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudERpc3BhdGNoZXIsIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRCYXRjaENvbmZpZzsKICAgICAgICAgIHZhciBkaWRXYXJuQWJvdXRNaXNtYXRjaGVkSG9va3NGb3JDb21wb25lbnQ7CiAgICAgICAgICB2YXIgZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3Q7CiAgICAgICAgICB7CiAgICAgICAgICAgIGRpZFdhcm5BYm91dE1pc21hdGNoZWRIb29rc0ZvckNvbXBvbmVudCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcmVuZGVyTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdmFyIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEgPSBudWxsOwogICAgICAgICAgdmFyIGN1cnJlbnRIb29rID0gbnVsbDsKICAgICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc0hvb2sgPSBudWxsOwogICAgICAgICAgdmFyIGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgIHZhciBkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlRHVyaW5nVGhpc1Bhc3MgPSBmYWxzZTsKICAgICAgICAgIHZhciBsb2NhbElkQ291bnRlciA9IDA7CiAgICAgICAgICB2YXIgZ2xvYmFsQ2xpZW50SWRDb3VudGVyID0gMDsKICAgICAgICAgIHZhciBSRV9SRU5ERVJfTElNSVQgPSAyNTsKICAgICAgICAgIHZhciBjdXJyZW50SG9va05hbWVJbkRldiA9IG51bGw7CiAgICAgICAgICB2YXIgaG9va1R5cGVzRGV2ID0gbnVsbDsKICAgICAgICAgIHZhciBob29rVHlwZXNVcGRhdGVJbmRleERldiA9IC0xOwogICAgICAgICAgdmFyIGlnbm9yZVByZXZpb3VzRGVwZW5kZW5jaWVzID0gZmFsc2U7CiAgICAgICAgICBmdW5jdGlvbiBtb3VudEhvb2tUeXBlc0RldigpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBob29rTmFtZSA9IGN1cnJlbnRIb29rTmFtZUluRGV2OwogICAgICAgICAgICAgIGlmIChob29rVHlwZXNEZXYgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGhvb2tUeXBlc0RldiA9IFtob29rTmFtZV07CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGhvb2tUeXBlc0Rldi5wdXNoKGhvb2tOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUhvb2tUeXBlc0RldigpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBob29rTmFtZSA9IGN1cnJlbnRIb29rTmFtZUluRGV2OwogICAgICAgICAgICAgIGlmIChob29rVHlwZXNEZXYgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGhvb2tUeXBlc1VwZGF0ZUluZGV4RGV2Kys7CiAgICAgICAgICAgICAgICBpZiAoaG9va1R5cGVzRGV2W2hvb2tUeXBlc1VwZGF0ZUluZGV4RGV2XSAhPT0gaG9va05hbWUpIHsKICAgICAgICAgICAgICAgICAgd2Fybk9uSG9va01pc21hdGNoSW5EZXYoaG9va05hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGRlcHMgIT09IHZvaWQgMCAmJiBkZXBzICE9PSBudWxsICYmICFpc0FycmF5KGRlcHMpKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMgcmVjZWl2ZWQgYSBmaW5hbCBhcmd1bWVudCB0aGF0IGlzIG5vdCBhbiBhcnJheSAoaW5zdGVhZCwgcmVjZWl2ZWQgYCVzYCkuIFdoZW4gc3BlY2lmaWVkLCB0aGUgZmluYWwgYXJndW1lbnQgbXVzdCBiZSBhbiBhcnJheS4iLCBjdXJyZW50SG9va05hbWVJbkRldiwgdHlwZW9mIGRlcHMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gd2Fybk9uSG9va01pc21hdGNoSW5EZXYoY3VycmVudEhvb2tOYW1lKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSk7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRNaXNtYXRjaGVkSG9va3NGb3JDb21wb25lbnQuaGFzKGNvbXBvbmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNaXNtYXRjaGVkSG9va3NGb3JDb21wb25lbnQuYWRkKGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgaWYgKGhvb2tUeXBlc0RldiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgdGFibGUgPSAiIjsKICAgICAgICAgICAgICAgICAgdmFyIHNlY29uZENvbHVtblN0YXJ0ID0gMzA7CiAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDw9IGhvb2tUeXBlc1VwZGF0ZUluZGV4RGV2OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB2YXIgb2xkSG9va05hbWUgPSBob29rVHlwZXNEZXZbaV07CiAgICAgICAgICAgICAgICAgICAgdmFyIG5ld0hvb2tOYW1lID0gaSA9PT0gaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYgPyBjdXJyZW50SG9va05hbWUgOiBvbGRIb29rTmFtZTsKICAgICAgICAgICAgICAgICAgICB2YXIgcm93ID0gaSArIDEgKyAiLiAiICsgb2xkSG9va05hbWU7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKHJvdy5sZW5ndGggPCBzZWNvbmRDb2x1bW5TdGFydCkgewogICAgICAgICAgICAgICAgICAgICAgcm93ICs9ICIgIjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcm93ICs9IG5ld0hvb2tOYW1lICsgIlxuIjsKICAgICAgICAgICAgICAgICAgICB0YWJsZSArPSByb3c7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGhhcyBkZXRlY3RlZCBhIGNoYW5nZSBpbiB0aGUgb3JkZXIgb2YgSG9va3MgY2FsbGVkIGJ5ICVzLiBUaGlzIHdpbGwgbGVhZCB0byBidWdzIGFuZCBlcnJvcnMgaWYgbm90IGZpeGVkLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiwgcmVhZCB0aGUgUnVsZXMgb2YgSG9va3M6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9ydWxlcy1vZi1ob29rc1xuXG4gICBQcmV2aW91cyByZW5kZXIgICAgICAgICAgICBOZXh0IHJlbmRlclxuICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4lcyAgIF5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXlxuIiwgY29tcG9uZW50TmFtZSwgdGFibGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdGhyb3dJbnZhbGlkSG9va0Vycm9yKCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgaG9vayBjYWxsLiBIb29rcyBjYW4gb25seSBiZSBjYWxsZWQgaW5zaWRlIG9mIHRoZSBib2R5IG9mIGEgZnVuY3Rpb24gY29tcG9uZW50LiBUaGlzIGNvdWxkIGhhcHBlbiBmb3Igb25lIG9mIHRoZSBmb2xsb3dpbmcgcmVhc29uczpcbjEuIFlvdSBtaWdodCBoYXZlIG1pc21hdGNoaW5nIHZlcnNpb25zIG9mIFJlYWN0IGFuZCB0aGUgcmVuZGVyZXIgKHN1Y2ggYXMgUmVhY3QgRE9NKVxuMi4gWW91IG1pZ2h0IGJlIGJyZWFraW5nIHRoZSBSdWxlcyBvZiBIb29rc1xuMy4gWW91IG1pZ2h0IGhhdmUgbW9yZSB0aGFuIG9uZSBjb3B5IG9mIFJlYWN0IGluIHRoZSBzYW1lIGFwcFxuU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9pbnZhbGlkLWhvb2stY2FsbCBmb3IgdGlwcyBhYm91dCBob3cgdG8gZGVidWcgYW5kIGZpeCB0aGlzIHByb2JsZW0uIik7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBhcmVIb29rSW5wdXRzRXF1YWwobmV4dERlcHMsIHByZXZEZXBzKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaWdub3JlUHJldmlvdXNEZXBlbmRlbmNpZXMpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHByZXZEZXBzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzIHJlY2VpdmVkIGEgZmluYWwgYXJndW1lbnQgZHVyaW5nIHRoaXMgcmVuZGVyLCBidXQgbm90IGR1cmluZyB0aGUgcHJldmlvdXMgcmVuZGVyLiBFdmVuIHRob3VnaCB0aGUgZmluYWwgYXJndW1lbnQgaXMgb3B0aW9uYWwsIGl0cyB0eXBlIGNhbm5vdCBjaGFuZ2UgYmV0d2VlbiByZW5kZXJzLiIsIGN1cnJlbnRIb29rTmFtZUluRGV2KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAobmV4dERlcHMubGVuZ3RoICE9PSBwcmV2RGVwcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgZmluYWwgYXJndW1lbnQgcGFzc2VkIHRvICVzIGNoYW5nZWQgc2l6ZSBiZXR3ZWVuIHJlbmRlcnMuIFRoZSBvcmRlciBhbmQgc2l6ZSBvZiB0aGlzIGFycmF5IG11c3QgcmVtYWluIGNvbnN0YW50LlxuXG5QcmV2aW91czogJXNcbkluY29taW5nOiAlcyIsIGN1cnJlbnRIb29rTmFtZUluRGV2LCAiWyIgKyBwcmV2RGVwcy5qb2luKCIsICIpICsgIl0iLCAiWyIgKyBuZXh0RGVwcy5qb2luKCIsICIpICsgIl0iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcmV2RGVwcy5sZW5ndGggJiYgaSA8IG5leHREZXBzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgaWYgKG9iamVjdElzKG5leHREZXBzW2ldLCBwcmV2RGVwc1tpXSkpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZW5kZXJXaXRoSG9va3MoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBwcm9wcywgc2Vjb25kQXJnLCBuZXh0UmVuZGVyTGFuZXMpIHsKICAgICAgICAgICAgcmVuZGVyTGFuZXMgPSBuZXh0UmVuZGVyTGFuZXM7CiAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBob29rVHlwZXNEZXYgPSBjdXJyZW50MiAhPT0gbnVsbCA/IGN1cnJlbnQyLl9kZWJ1Z0hvb2tUeXBlcyA6IG51bGw7CiAgICAgICAgICAgICAgaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYgPSAtMTsKICAgICAgICAgICAgICBpZ25vcmVQcmV2aW91c0RlcGVuZGVuY2llcyA9IGN1cnJlbnQyICE9PSBudWxsICYmIGN1cnJlbnQyLnR5cGUgIT09IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCAmJiBjdXJyZW50Mi5tZW1vaXplZFN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChob29rVHlwZXNEZXYgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSG9va3NEaXNwYXRjaGVyT25Nb3VudFdpdGhIb29rVHlwZXNJbkRFVjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjaGlsZHJlbjIgPSBDb21wb25lbnQocHJvcHMsIHNlY29uZEFyZyk7CiAgICAgICAgICAgIGlmIChkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlRHVyaW5nVGhpc1Bhc3MpIHsKICAgICAgICAgICAgICB2YXIgbnVtYmVyT2ZSZVJlbmRlcnMgPSAwOwogICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgIGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGVEdXJpbmdUaGlzUGFzcyA9IGZhbHNlOwogICAgICAgICAgICAgICAgbG9jYWxJZENvdW50ZXIgPSAwOwogICAgICAgICAgICAgICAgaWYgKG51bWJlck9mUmVSZW5kZXJzID49IFJFX1JFTkRFUl9MSU1JVCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRvbyBtYW55IHJlLXJlbmRlcnMuIFJlYWN0IGxpbWl0cyB0aGUgbnVtYmVyIG9mIHJlbmRlcnMgdG8gcHJldmVudCBhbiBpbmZpbml0ZSBsb29wLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbnVtYmVyT2ZSZVJlbmRlcnMgKz0gMTsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWdub3JlUHJldmlvdXNEZXBlbmRlbmNpZXMgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rID0gbnVsbDsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayA9IG51bGw7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBob29rVHlwZXNVcGRhdGVJbmRleERldiA9IC0xOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVY7CiAgICAgICAgICAgICAgICBjaGlsZHJlbjIgPSBDb21wb25lbnQocHJvcHMsIHNlY29uZEFyZyk7CiAgICAgICAgICAgICAgfSB3aGlsZSAoZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZUR1cmluZ1RoaXNQYXNzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IENvbnRleHRPbmx5RGlzcGF0Y2hlcjsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5fZGVidWdIb29rVHlwZXMgPSBob29rVHlwZXNEZXY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGRpZFJlbmRlclRvb0Zld0hvb2tzID0gY3VycmVudEhvb2sgIT09IG51bGwgJiYgY3VycmVudEhvb2submV4dCAhPT0gbnVsbDsKICAgICAgICAgICAgcmVuZGVyTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxID0gbnVsbDsKICAgICAgICAgICAgY3VycmVudEhvb2sgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc0hvb2sgPSBudWxsOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSBudWxsOwogICAgICAgICAgICAgIGhvb2tUeXBlc0RldiA9IG51bGw7CiAgICAgICAgICAgICAgaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYgPSAtMTsKICAgICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwgJiYgKGN1cnJlbnQyLmZsYWdzICYgU3RhdGljTWFzaykgIT09ICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBTdGF0aWNNYXNrKSAmJiAvLyBEaXNhYmxlIHRoaXMgd2FybmluZyBpbiBsZWdhY3kgbW9kZSwgYmVjYXVzZSBsZWdhY3kgU3VzcGVuc2UgaXMgd2VpcmQKICAgICAgICAgICAgICAvLyBhbmQgY3JlYXRlcyBmYWxzZSBwb3NpdGl2ZXMuIFRvIG1ha2UgdGhpcyB3b3JrIGluIGxlZ2FjeSBtb2RlLCB3ZSdkCiAgICAgICAgICAgICAgLy8gbmVlZCB0byBtYXJrIGZpYmVycyB0aGF0IGNvbW1pdCBpbiBhbiBpbmNvbXBsZXRlIHN0YXRlLCBzb21laG93LiBGb3IKICAgICAgICAgICAgICAvLyBub3cgSSdsbCBkaXNhYmxlIHRoZSB3YXJuaW5nIHRoYXQgbW9zdCBvZiB0aGUgYnVncyB0aGF0IHdvdWxkIHRyaWdnZXIKICAgICAgICAgICAgICAvLyBpdCBhcmUgZWl0aGVyIGV4Y2x1c2l2ZSB0byBjb25jdXJyZW50IG1vZGUgb3IgZXhpc3QgaW4gYm90aC4KICAgICAgICAgICAgICAoY3VycmVudDIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiSW50ZXJuYWwgUmVhY3QgZXJyb3I6IEV4cGVjdGVkIHN0YXRpYyBmbGFnIHdhcyBtaXNzaW5nLiBQbGVhc2Ugbm90aWZ5IHRoZSBSZWFjdCB0ZWFtLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChkaWRSZW5kZXJUb29GZXdIb29rcykgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVuZGVyZWQgZmV3ZXIgaG9va3MgdGhhbiBleHBlY3RlZC4gVGhpcyBtYXkgYmUgY2F1c2VkIGJ5IGFuIGFjY2lkZW50YWwgZWFybHkgcmV0dXJuIHN0YXRlbWVudC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY2hpbGRyZW4yOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY2hlY2tEaWRSZW5kZXJJZEhvb2soKSB7CiAgICAgICAgICAgIHZhciBkaWRSZW5kZXJJZEhvb2sgPSBsb2NhbElkQ291bnRlciAhPT0gMDsKICAgICAgICAgICAgbG9jYWxJZENvdW50ZXIgPSAwOwogICAgICAgICAgICByZXR1cm4gZGlkUmVuZGVySWRIb29rOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gYmFpbG91dEhvb2tzKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIGxhbmVzKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IGN1cnJlbnQyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJj0gfihNb3VudFBhc3NpdmVEZXYgfCBNb3VudExheW91dERldiB8IFBhc3NpdmUgfCBVcGRhdGUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyAmPSB+KFBhc3NpdmUgfCBVcGRhdGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGN1cnJlbnQyLmxhbmVzID0gcmVtb3ZlTGFuZXMoY3VycmVudDIubGFuZXMsIGxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlc2V0SG9va3NBZnRlclRocm93KCkgewogICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IENvbnRleHRPbmx5RGlzcGF0Y2hlcjsKICAgICAgICAgICAgaWYgKGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGUpIHsKICAgICAgICAgICAgICB2YXIgaG9vayA9IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICB3aGlsZSAoaG9vayAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHF1ZXVlID0gaG9vay5xdWV1ZTsKICAgICAgICAgICAgICAgIGlmIChxdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBxdWV1ZS5wZW5kaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhvb2sgPSBob29rLm5leHQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEgPSBudWxsOwogICAgICAgICAgICBjdXJyZW50SG9vayA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayA9IG51bGw7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBob29rVHlwZXNEZXYgPSBudWxsOwogICAgICAgICAgICAgIGhvb2tUeXBlc1VwZGF0ZUluZGV4RGV2ID0gLTE7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSBudWxsOwogICAgICAgICAgICAgIGlzVXBkYXRpbmdPcGFxdWVWYWx1ZUluUmVuZGVyUGhhc2UgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlRHVyaW5nVGhpc1Bhc3MgPSBmYWxzZTsKICAgICAgICAgICAgbG9jYWxJZENvdW50ZXIgPSAwOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKSB7CiAgICAgICAgICAgIHZhciBob29rID0gewogICAgICAgICAgICAgIG1lbW9pemVkU3RhdGU6IG51bGwsCiAgICAgICAgICAgICAgYmFzZVN0YXRlOiBudWxsLAogICAgICAgICAgICAgIGJhc2VRdWV1ZTogbnVsbCwKICAgICAgICAgICAgICBxdWV1ZTogbnVsbCwKICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc0hvb2sgPT09IG51bGwpIHsKICAgICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLm1lbW9pemVkU3RhdGUgPSB3b3JrSW5Qcm9ncmVzc0hvb2sgPSBob29rOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayA9IHdvcmtJblByb2dyZXNzSG9vay5uZXh0ID0gaG9vazsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3NIb29rOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCkgewogICAgICAgICAgICB2YXIgbmV4dEN1cnJlbnRIb29rOwogICAgICAgICAgICBpZiAoY3VycmVudEhvb2sgPT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgY3VycmVudDIgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmFsdGVybmF0ZTsKICAgICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG5leHRDdXJyZW50SG9vayA9IGN1cnJlbnQyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5leHRDdXJyZW50SG9vayA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5leHRDdXJyZW50SG9vayA9IGN1cnJlbnRIb29rLm5leHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5leHRXb3JrSW5Qcm9ncmVzc0hvb2s7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc0hvb2sgPT09IG51bGwpIHsKICAgICAgICAgICAgICBuZXh0V29ya0luUHJvZ3Jlc3NIb29rID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5leHRXb3JrSW5Qcm9ncmVzc0hvb2sgPSB3b3JrSW5Qcm9ncmVzc0hvb2submV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobmV4dFdvcmtJblByb2dyZXNzSG9vayAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayA9IG5leHRXb3JrSW5Qcm9ncmVzc0hvb2s7CiAgICAgICAgICAgICAgbmV4dFdvcmtJblByb2dyZXNzSG9vayA9IHdvcmtJblByb2dyZXNzSG9vay5uZXh0OwogICAgICAgICAgICAgIGN1cnJlbnRIb29rID0gbmV4dEN1cnJlbnRIb29rOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChuZXh0Q3VycmVudEhvb2sgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVuZGVyZWQgbW9yZSBob29rcyB0aGFuIGR1cmluZyB0aGUgcHJldmlvdXMgcmVuZGVyLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjdXJyZW50SG9vayA9IG5leHRDdXJyZW50SG9vazsKICAgICAgICAgICAgICB2YXIgbmV3SG9vayA9IHsKICAgICAgICAgICAgICAgIG1lbW9pemVkU3RhdGU6IGN1cnJlbnRIb29rLm1lbW9pemVkU3RhdGUsCiAgICAgICAgICAgICAgICBiYXNlU3RhdGU6IGN1cnJlbnRIb29rLmJhc2VTdGF0ZSwKICAgICAgICAgICAgICAgIGJhc2VRdWV1ZTogY3VycmVudEhvb2suYmFzZVF1ZXVlLAogICAgICAgICAgICAgICAgcXVldWU6IGN1cnJlbnRIb29rLnF1ZXVlLAogICAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzSG9vayA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tZW1vaXplZFN0YXRlID0gd29ya0luUHJvZ3Jlc3NIb29rID0gbmV3SG9vazsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NIb29rID0gd29ya0luUHJvZ3Jlc3NIb29rLm5leHQgPSBuZXdIb29rOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3NIb29rOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY3JlYXRlRnVuY3Rpb25Db21wb25lbnRVcGRhdGVRdWV1ZSgpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBsYXN0RWZmZWN0OiBudWxsLAogICAgICAgICAgICAgIHN0b3JlczogbnVsbAogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gYmFzaWNTdGF0ZVJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgICAgICByZXR1cm4gdHlwZW9mIGFjdGlvbiA9PT0gImZ1bmN0aW9uIiA/IGFjdGlvbihzdGF0ZSkgOiBhY3Rpb247CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtb3VudFJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdDIpIHsKICAgICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgICB2YXIgaW5pdGlhbFN0YXRlOwogICAgICAgICAgICBpZiAoaW5pdDIgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIGluaXRpYWxTdGF0ZSA9IGluaXQyKGluaXRpYWxBcmcpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGluaXRpYWxTdGF0ZSA9IGluaXRpYWxBcmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gaG9vay5iYXNlU3RhdGUgPSBpbml0aWFsU3RhdGU7CiAgICAgICAgICAgIHZhciBxdWV1ZSA9IHsKICAgICAgICAgICAgICBwZW5kaW5nOiBudWxsLAogICAgICAgICAgICAgIGludGVybGVhdmVkOiBudWxsLAogICAgICAgICAgICAgIGxhbmVzOiBOb0xhbmVzLAogICAgICAgICAgICAgIGRpc3BhdGNoOiBudWxsLAogICAgICAgICAgICAgIGxhc3RSZW5kZXJlZFJlZHVjZXI6IHJlZHVjZXIsCiAgICAgICAgICAgICAgbGFzdFJlbmRlcmVkU3RhdGU6IGluaXRpYWxTdGF0ZQogICAgICAgICAgICB9OwogICAgICAgICAgICBob29rLnF1ZXVlID0gcXVldWU7CiAgICAgICAgICAgIHZhciBkaXNwYXRjaDIgPSBxdWV1ZS5kaXNwYXRjaCA9IGRpc3BhdGNoUmVkdWNlckFjdGlvbi5iaW5kKG51bGwsIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEsIHF1ZXVlKTsKICAgICAgICAgICAgcmV0dXJuIFtob29rLm1lbW9pemVkU3RhdGUsIGRpc3BhdGNoMl07CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQyKSB7CiAgICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICAgIHZhciBxdWV1ZSA9IGhvb2sucXVldWU7CiAgICAgICAgICAgIGlmIChxdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2hvdWxkIGhhdmUgYSBxdWV1ZS4gVGhpcyBpcyBsaWtlbHkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHF1ZXVlLmxhc3RSZW5kZXJlZFJlZHVjZXIgPSByZWR1Y2VyOwogICAgICAgICAgICB2YXIgY3VycmVudDIgPSBjdXJyZW50SG9vazsKICAgICAgICAgICAgdmFyIGJhc2VRdWV1ZSA9IGN1cnJlbnQyLmJhc2VRdWV1ZTsKICAgICAgICAgICAgdmFyIHBlbmRpbmdRdWV1ZSA9IHF1ZXVlLnBlbmRpbmc7CiAgICAgICAgICAgIGlmIChwZW5kaW5nUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoYmFzZVF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgYmFzZUZpcnN0ID0gYmFzZVF1ZXVlLm5leHQ7CiAgICAgICAgICAgICAgICB2YXIgcGVuZGluZ0ZpcnN0ID0gcGVuZGluZ1F1ZXVlLm5leHQ7CiAgICAgICAgICAgICAgICBiYXNlUXVldWUubmV4dCA9IHBlbmRpbmdGaXJzdDsKICAgICAgICAgICAgICAgIHBlbmRpbmdRdWV1ZS5uZXh0ID0gYmFzZUZpcnN0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudDIuYmFzZVF1ZXVlICE9PSBiYXNlUXVldWUpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIkludGVybmFsIGVycm9yOiBFeHBlY3RlZCB3b3JrLWluLXByb2dyZXNzIHF1ZXVlIHRvIGJlIGEgY2xvbmUuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1cnJlbnQyLmJhc2VRdWV1ZSA9IGJhc2VRdWV1ZSA9IHBlbmRpbmdRdWV1ZTsKICAgICAgICAgICAgICBxdWV1ZS5wZW5kaW5nID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYmFzZVF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGZpcnN0ID0gYmFzZVF1ZXVlLm5leHQ7CiAgICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gY3VycmVudDIuYmFzZVN0YXRlOwogICAgICAgICAgICAgIHZhciBuZXdCYXNlU3RhdGUgPSBudWxsOwogICAgICAgICAgICAgIHZhciBuZXdCYXNlUXVldWVGaXJzdCA9IG51bGw7CiAgICAgICAgICAgICAgdmFyIG5ld0Jhc2VRdWV1ZUxhc3QgPSBudWxsOwogICAgICAgICAgICAgIHZhciB1cGRhdGUgPSBmaXJzdDsKICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlTGFuZSA9IHVwZGF0ZS5sYW5lOwogICAgICAgICAgICAgICAgaWYgKCFpc1N1YnNldE9mTGFuZXMocmVuZGVyTGFuZXMsIHVwZGF0ZUxhbmUpKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjbG9uZSA9IHsKICAgICAgICAgICAgICAgICAgICBsYW5lOiB1cGRhdGVMYW5lLAogICAgICAgICAgICAgICAgICAgIGFjdGlvbjogdXBkYXRlLmFjdGlvbiwKICAgICAgICAgICAgICAgICAgICBoYXNFYWdlclN0YXRlOiB1cGRhdGUuaGFzRWFnZXJTdGF0ZSwKICAgICAgICAgICAgICAgICAgICBlYWdlclN0YXRlOiB1cGRhdGUuZWFnZXJTdGF0ZSwKICAgICAgICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIGlmIChuZXdCYXNlUXVldWVMYXN0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgbmV3QmFzZVF1ZXVlRmlyc3QgPSBuZXdCYXNlUXVldWVMYXN0ID0gY2xvbmU7CiAgICAgICAgICAgICAgICAgICAgbmV3QmFzZVN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbmV3QmFzZVF1ZXVlTGFzdCA9IG5ld0Jhc2VRdWV1ZUxhc3QubmV4dCA9IGNsb25lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubGFuZXMgPSBtZXJnZUxhbmVzKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubGFuZXMsIHVwZGF0ZUxhbmUpOwogICAgICAgICAgICAgICAgICBtYXJrU2tpcHBlZFVwZGF0ZUxhbmVzKHVwZGF0ZUxhbmUpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgaWYgKG5ld0Jhc2VRdWV1ZUxhc3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX2Nsb25lID0gewogICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyB1cGRhdGUgaXMgZ29pbmcgdG8gYmUgY29tbWl0dGVkIHNvIHdlIG5ldmVyIHdhbnQgdW5jb21taXQKICAgICAgICAgICAgICAgICAgICAgIC8vIGl0LiBVc2luZyBOb0xhbmUgd29ya3MgYmVjYXVzZSAwIGlzIGEgc3Vic2V0IG9mIGFsbCBiaXRtYXNrcywgc28KICAgICAgICAgICAgICAgICAgICAgIC8vIHRoaXMgd2lsbCBuZXZlciBiZSBza2lwcGVkIGJ5IHRoZSBjaGVjayBhYm92ZS4KICAgICAgICAgICAgICAgICAgICAgIGxhbmU6IE5vTGFuZSwKICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbjogdXBkYXRlLmFjdGlvbiwKICAgICAgICAgICAgICAgICAgICAgIGhhc0VhZ2VyU3RhdGU6IHVwZGF0ZS5oYXNFYWdlclN0YXRlLAogICAgICAgICAgICAgICAgICAgICAgZWFnZXJTdGF0ZTogdXBkYXRlLmVhZ2VyU3RhdGUsCiAgICAgICAgICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBuZXdCYXNlUXVldWVMYXN0ID0gbmV3QmFzZVF1ZXVlTGFzdC5uZXh0ID0gX2Nsb25lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICh1cGRhdGUuaGFzRWFnZXJTdGF0ZSkgewogICAgICAgICAgICAgICAgICAgIG5ld1N0YXRlID0gdXBkYXRlLmVhZ2VyU3RhdGU7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGFjdGlvbiA9IHVwZGF0ZS5hY3Rpb247CiAgICAgICAgICAgICAgICAgICAgbmV3U3RhdGUgPSByZWR1Y2VyKG5ld1N0YXRlLCBhY3Rpb24pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB1cGRhdGUgPSB1cGRhdGUubmV4dDsKICAgICAgICAgICAgICB9IHdoaWxlICh1cGRhdGUgIT09IG51bGwgJiYgdXBkYXRlICE9PSBmaXJzdCk7CiAgICAgICAgICAgICAgaWYgKG5ld0Jhc2VRdWV1ZUxhc3QgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG5ld0Jhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuZXdCYXNlUXVldWVMYXN0Lm5leHQgPSBuZXdCYXNlUXVldWVGaXJzdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFvYmplY3RJcyhuZXdTdGF0ZSwgaG9vay5tZW1vaXplZFN0YXRlKSkgewogICAgICAgICAgICAgICAgbWFya1dvcmtJblByb2dyZXNzUmVjZWl2ZWRVcGRhdGUoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgaG9vay5iYXNlU3RhdGUgPSBuZXdCYXNlU3RhdGU7CiAgICAgICAgICAgICAgaG9vay5iYXNlUXVldWUgPSBuZXdCYXNlUXVldWVMYXN0OwogICAgICAgICAgICAgIHF1ZXVlLmxhc3RSZW5kZXJlZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGxhc3RJbnRlcmxlYXZlZCA9IHF1ZXVlLmludGVybGVhdmVkOwogICAgICAgICAgICBpZiAobGFzdEludGVybGVhdmVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGludGVybGVhdmVkID0gbGFzdEludGVybGVhdmVkOwogICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgIHZhciBpbnRlcmxlYXZlZExhbmUgPSBpbnRlcmxlYXZlZC5sYW5lOwogICAgICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5sYW5lcyA9IG1lcmdlTGFuZXMoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5sYW5lcywgaW50ZXJsZWF2ZWRMYW5lKTsKICAgICAgICAgICAgICAgIG1hcmtTa2lwcGVkVXBkYXRlTGFuZXMoaW50ZXJsZWF2ZWRMYW5lKTsKICAgICAgICAgICAgICAgIGludGVybGVhdmVkID0gaW50ZXJsZWF2ZWQubmV4dDsKICAgICAgICAgICAgICB9IHdoaWxlIChpbnRlcmxlYXZlZCAhPT0gbGFzdEludGVybGVhdmVkKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChiYXNlUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICBxdWV1ZS5sYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGRpc3BhdGNoMiA9IHF1ZXVlLmRpc3BhdGNoOwogICAgICAgICAgICByZXR1cm4gW2hvb2subWVtb2l6ZWRTdGF0ZSwgZGlzcGF0Y2gyXTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlcmVuZGVyUmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0MikgewogICAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgICB2YXIgcXVldWUgPSBob29rLnF1ZXVlOwogICAgICAgICAgICBpZiAocXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBoYXZlIGEgcXVldWUuIFRoaXMgaXMgbGlrZWx5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBxdWV1ZS5sYXN0UmVuZGVyZWRSZWR1Y2VyID0gcmVkdWNlcjsKICAgICAgICAgICAgdmFyIGRpc3BhdGNoMiA9IHF1ZXVlLmRpc3BhdGNoOwogICAgICAgICAgICB2YXIgbGFzdFJlbmRlclBoYXNlVXBkYXRlID0gcXVldWUucGVuZGluZzsKICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gaG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICBpZiAobGFzdFJlbmRlclBoYXNlVXBkYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgcXVldWUucGVuZGluZyA9IG51bGw7CiAgICAgICAgICAgICAgdmFyIGZpcnN0UmVuZGVyUGhhc2VVcGRhdGUgPSBsYXN0UmVuZGVyUGhhc2VVcGRhdGUubmV4dDsKICAgICAgICAgICAgICB2YXIgdXBkYXRlID0gZmlyc3RSZW5kZXJQaGFzZVVwZGF0ZTsKICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICB2YXIgYWN0aW9uID0gdXBkYXRlLmFjdGlvbjsKICAgICAgICAgICAgICAgIG5ld1N0YXRlID0gcmVkdWNlcihuZXdTdGF0ZSwgYWN0aW9uKTsKICAgICAgICAgICAgICAgIHVwZGF0ZSA9IHVwZGF0ZS5uZXh0OwogICAgICAgICAgICAgIH0gd2hpbGUgKHVwZGF0ZSAhPT0gZmlyc3RSZW5kZXJQaGFzZVVwZGF0ZSk7CiAgICAgICAgICAgICAgaWYgKCFvYmplY3RJcyhuZXdTdGF0ZSwgaG9vay5tZW1vaXplZFN0YXRlKSkgewogICAgICAgICAgICAgICAgbWFya1dvcmtJblByb2dyZXNzUmVjZWl2ZWRVcGRhdGUoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgaWYgKGhvb2suYmFzZVF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBob29rLmJhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBxdWV1ZS5sYXN0UmVuZGVyZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBbbmV3U3RhdGUsIGRpc3BhdGNoMl07CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtb3VudE11dGFibGVTb3VyY2Uoc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVNdXRhYmxlU291cmNlKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbW91bnRTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxOwogICAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICAgIHZhciBuZXh0U25hcHNob3Q7CiAgICAgICAgICAgIHZhciBpc0h5ZHJhdGluZzIgPSBnZXRJc0h5ZHJhdGluZygpOwogICAgICAgICAgICBpZiAoaXNIeWRyYXRpbmcyKSB7CiAgICAgICAgICAgICAgaWYgKGdldFNlcnZlclNuYXBzaG90ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiTWlzc2luZyBnZXRTZXJ2ZXJTbmFwc2hvdCwgd2hpY2ggaXMgcmVxdWlyZWQgZm9yIHNlcnZlci1yZW5kZXJlZCBjb250ZW50LiBXaWxsIHJldmVydCB0byBjbGllbnQgcmVuZGVyaW5nLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBuZXh0U25hcHNob3QgPSBnZXRTZXJ2ZXJTbmFwc2hvdCgpOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICghZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QpIHsKICAgICAgICAgICAgICAgICAgaWYgKG5leHRTbmFwc2hvdCAhPT0gZ2V0U2VydmVyU25hcHNob3QoKSkgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgcmVzdWx0IG9mIGdldFNlcnZlclNuYXBzaG90IHNob3VsZCBiZSBjYWNoZWQgdG8gYXZvaWQgYW4gaW5maW5pdGUgbG9vcCIpOwogICAgICAgICAgICAgICAgICAgIGRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXh0U25hcHNob3QgPSBnZXRTbmFwc2hvdCgpOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICghZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QpIHsKICAgICAgICAgICAgICAgICAgdmFyIGNhY2hlZFNuYXBzaG90ID0gZ2V0U25hcHNob3QoKTsKICAgICAgICAgICAgICAgICAgaWYgKCFvYmplY3RJcyhuZXh0U25hcHNob3QsIGNhY2hlZFNuYXBzaG90KSkgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgcmVzdWx0IG9mIGdldFNuYXBzaG90IHNob3VsZCBiZSBjYWNoZWQgdG8gYXZvaWQgYW4gaW5maW5pdGUgbG9vcCIpOwogICAgICAgICAgICAgICAgICAgIGRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBnZXRXb3JrSW5Qcm9ncmVzc1Jvb3QoKTsKICAgICAgICAgICAgICBpZiAocm9vdDMgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgYSB3b3JrLWluLXByb2dyZXNzIHJvb3QuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIWluY2x1ZGVzQmxvY2tpbmdMYW5lKHJvb3QzLCByZW5kZXJMYW5lcykpIHsKICAgICAgICAgICAgICAgIHB1c2hTdG9yZUNvbnNpc3RlbmN5Q2hlY2soZmliZXIsIGdldFNuYXBzaG90LCBuZXh0U25hcHNob3QpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXh0U25hcHNob3Q7CiAgICAgICAgICAgIHZhciBpbnN0ID0gewogICAgICAgICAgICAgIHZhbHVlOiBuZXh0U25hcHNob3QsCiAgICAgICAgICAgICAgZ2V0U25hcHNob3QKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaG9vay5xdWV1ZSA9IGluc3Q7CiAgICAgICAgICAgIG1vdW50RWZmZWN0KHN1YnNjcmliZVRvU3RvcmUuYmluZChudWxsLCBmaWJlciwgaW5zdCwgc3Vic2NyaWJlKSwgW3N1YnNjcmliZV0pOwogICAgICAgICAgICBmaWJlci5mbGFncyB8PSBQYXNzaXZlOwogICAgICAgICAgICBwdXNoRWZmZWN0KEhhc0VmZmVjdCB8IFBhc3NpdmUkMSwgdXBkYXRlU3RvcmVJbnN0YW5jZS5iaW5kKG51bGwsIGZpYmVyLCBpbnN0LCBuZXh0U25hcHNob3QsIGdldFNuYXBzaG90KSwgdm9pZCAwLCBudWxsKTsKICAgICAgICAgICAgcmV0dXJuIG5leHRTbmFwc2hvdDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDE7CiAgICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICAgIHZhciBuZXh0U25hcHNob3QgPSBnZXRTbmFwc2hvdCgpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCkgewogICAgICAgICAgICAgICAgdmFyIGNhY2hlZFNuYXBzaG90ID0gZ2V0U25hcHNob3QoKTsKICAgICAgICAgICAgICAgIGlmICghb2JqZWN0SXMobmV4dFNuYXBzaG90LCBjYWNoZWRTbmFwc2hvdCkpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlRoZSByZXN1bHQgb2YgZ2V0U25hcHNob3Qgc2hvdWxkIGJlIGNhY2hlZCB0byBhdm9pZCBhbiBpbmZpbml0ZSBsb29wIik7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByZXZTbmFwc2hvdCA9IGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgdmFyIHNuYXBzaG90Q2hhbmdlZCA9ICFvYmplY3RJcyhwcmV2U25hcHNob3QsIG5leHRTbmFwc2hvdCk7CiAgICAgICAgICAgIGlmIChzbmFwc2hvdENoYW5nZWQpIHsKICAgICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXh0U25hcHNob3Q7CiAgICAgICAgICAgICAgbWFya1dvcmtJblByb2dyZXNzUmVjZWl2ZWRVcGRhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW5zdCA9IGhvb2sucXVldWU7CiAgICAgICAgICAgIHVwZGF0ZUVmZmVjdChzdWJzY3JpYmVUb1N0b3JlLmJpbmQobnVsbCwgZmliZXIsIGluc3QsIHN1YnNjcmliZSksIFtzdWJzY3JpYmVdKTsKICAgICAgICAgICAgaWYgKGluc3QuZ2V0U25hcHNob3QgIT09IGdldFNuYXBzaG90IHx8IHNuYXBzaG90Q2hhbmdlZCB8fCAvLyBDaGVjayBpZiB0aGUgc3VzYmNyaWJlIGZ1bmN0aW9uIGNoYW5nZWQuIFdlIGNhbiBzYXZlIHNvbWUgbWVtb3J5IGJ5CiAgICAgICAgICAgIC8vIGNoZWNraW5nIHdoZXRoZXIgd2Ugc2NoZWR1bGVkIGEgc3Vic2NyaXB0aW9uIGVmZmVjdCBhYm92ZS4KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NIb29rICE9PSBudWxsICYmIHdvcmtJblByb2dyZXNzSG9vay5tZW1vaXplZFN0YXRlLnRhZyAmIEhhc0VmZmVjdCkgewogICAgICAgICAgICAgIGZpYmVyLmZsYWdzIHw9IFBhc3NpdmU7CiAgICAgICAgICAgICAgcHVzaEVmZmVjdChIYXNFZmZlY3QgfCBQYXNzaXZlJDEsIHVwZGF0ZVN0b3JlSW5zdGFuY2UuYmluZChudWxsLCBmaWJlciwgaW5zdCwgbmV4dFNuYXBzaG90LCBnZXRTbmFwc2hvdCksIHZvaWQgMCwgbnVsbCk7CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZ2V0V29ya0luUHJvZ3Jlc3NSb290KCk7CiAgICAgICAgICAgICAgaWYgKHJvb3QzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIGEgd29yay1pbi1wcm9ncmVzcyByb290LiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFpbmNsdWRlc0Jsb2NraW5nTGFuZShyb290MywgcmVuZGVyTGFuZXMpKSB7CiAgICAgICAgICAgICAgICBwdXNoU3RvcmVDb25zaXN0ZW5jeUNoZWNrKGZpYmVyLCBnZXRTbmFwc2hvdCwgbmV4dFNuYXBzaG90KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5leHRTbmFwc2hvdDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHB1c2hTdG9yZUNvbnNpc3RlbmN5Q2hlY2soZmliZXIsIGdldFNuYXBzaG90LCByZW5kZXJlZFNuYXBzaG90KSB7CiAgICAgICAgICAgIGZpYmVyLmZsYWdzIHw9IFN0b3JlQ29uc2lzdGVuY3k7CiAgICAgICAgICAgIHZhciBjaGVjayA9IHsKICAgICAgICAgICAgICBnZXRTbmFwc2hvdCwKICAgICAgICAgICAgICB2YWx1ZTogcmVuZGVyZWRTbmFwc2hvdAogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgY29tcG9uZW50VXBkYXRlUXVldWUgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICBpZiAoY29tcG9uZW50VXBkYXRlUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZSA9IGNyZWF0ZUZ1bmN0aW9uQ29tcG9uZW50VXBkYXRlUXVldWUoKTsKICAgICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLnVwZGF0ZVF1ZXVlID0gY29tcG9uZW50VXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgY29tcG9uZW50VXBkYXRlUXVldWUuc3RvcmVzID0gW2NoZWNrXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgc3RvcmVzID0gY29tcG9uZW50VXBkYXRlUXVldWUuc3RvcmVzOwogICAgICAgICAgICAgIGlmIChzdG9yZXMgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGNvbXBvbmVudFVwZGF0ZVF1ZXVlLnN0b3JlcyA9IFtjaGVja107CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN0b3Jlcy5wdXNoKGNoZWNrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN0b3JlSW5zdGFuY2UoZmliZXIsIGluc3QsIG5leHRTbmFwc2hvdCwgZ2V0U25hcHNob3QpIHsKICAgICAgICAgICAgaW5zdC52YWx1ZSA9IG5leHRTbmFwc2hvdDsKICAgICAgICAgICAgaW5zdC5nZXRTbmFwc2hvdCA9IGdldFNuYXBzaG90OwogICAgICAgICAgICBpZiAoY2hlY2tJZlNuYXBzaG90Q2hhbmdlZChpbnN0KSkgewogICAgICAgICAgICAgIGZvcmNlU3RvcmVSZXJlbmRlcihmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHN1YnNjcmliZVRvU3RvcmUoZmliZXIsIGluc3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICB2YXIgaGFuZGxlU3RvcmVDaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZiAoY2hlY2tJZlNuYXBzaG90Q2hhbmdlZChpbnN0KSkgewogICAgICAgICAgICAgICAgZm9yY2VTdG9yZVJlcmVuZGVyKGZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJldHVybiBzdWJzY3JpYmUoaGFuZGxlU3RvcmVDaGFuZ2UpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY2hlY2tJZlNuYXBzaG90Q2hhbmdlZChpbnN0KSB7CiAgICAgICAgICAgIHZhciBsYXRlc3RHZXRTbmFwc2hvdCA9IGluc3QuZ2V0U25hcHNob3Q7CiAgICAgICAgICAgIHZhciBwcmV2VmFsdWUgPSBpbnN0LnZhbHVlOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHZhciBuZXh0VmFsdWUgPSBsYXRlc3RHZXRTbmFwc2hvdCgpOwogICAgICAgICAgICAgIHJldHVybiAhb2JqZWN0SXMocHJldlZhbHVlLCBuZXh0VmFsdWUpOwogICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZm9yY2VTdG9yZVJlcmVuZGVyKGZpYmVyKSB7CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtb3VudFN0YXRlKGluaXRpYWxTdGF0ZSkgewogICAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5pdGlhbFN0YXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5pdGlhbFN0YXRlID0gaW5pdGlhbFN0YXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gaG9vay5iYXNlU3RhdGUgPSBpbml0aWFsU3RhdGU7CiAgICAgICAgICAgIHZhciBxdWV1ZSA9IHsKICAgICAgICAgICAgICBwZW5kaW5nOiBudWxsLAogICAgICAgICAgICAgIGludGVybGVhdmVkOiBudWxsLAogICAgICAgICAgICAgIGxhbmVzOiBOb0xhbmVzLAogICAgICAgICAgICAgIGRpc3BhdGNoOiBudWxsLAogICAgICAgICAgICAgIGxhc3RSZW5kZXJlZFJlZHVjZXI6IGJhc2ljU3RhdGVSZWR1Y2VyLAogICAgICAgICAgICAgIGxhc3RSZW5kZXJlZFN0YXRlOiBpbml0aWFsU3RhdGUKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaG9vay5xdWV1ZSA9IHF1ZXVlOwogICAgICAgICAgICB2YXIgZGlzcGF0Y2gyID0gcXVldWUuZGlzcGF0Y2ggPSBkaXNwYXRjaFNldFN0YXRlLmJpbmQobnVsbCwgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSwgcXVldWUpOwogICAgICAgICAgICByZXR1cm4gW2hvb2subWVtb2l6ZWRTdGF0ZSwgZGlzcGF0Y2gyXTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN0YXRlKGluaXRpYWxTdGF0ZSkgewogICAgICAgICAgICByZXR1cm4gdXBkYXRlUmVkdWNlcihiYXNpY1N0YXRlUmVkdWNlcik7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZXJlbmRlclN0YXRlKGluaXRpYWxTdGF0ZSkgewogICAgICAgICAgICByZXR1cm4gcmVyZW5kZXJSZWR1Y2VyKGJhc2ljU3RhdGVSZWR1Y2VyKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHB1c2hFZmZlY3QodGFnLCBjcmVhdGUyLCBkZXN0cm95LCBkZXBzKSB7CiAgICAgICAgICAgIHZhciBlZmZlY3QgPSB7CiAgICAgICAgICAgICAgdGFnLAogICAgICAgICAgICAgIGNyZWF0ZTogY3JlYXRlMiwKICAgICAgICAgICAgICBkZXN0cm95LAogICAgICAgICAgICAgIGRlcHMsCiAgICAgICAgICAgICAgLy8gQ2lyY3VsYXIKICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciBjb21wb25lbnRVcGRhdGVRdWV1ZSA9IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEudXBkYXRlUXVldWU7CiAgICAgICAgICAgIGlmIChjb21wb25lbnRVcGRhdGVRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGNvbXBvbmVudFVwZGF0ZVF1ZXVlID0gY3JlYXRlRnVuY3Rpb25Db21wb25lbnRVcGRhdGVRdWV1ZSgpOwogICAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEudXBkYXRlUXVldWUgPSBjb21wb25lbnRVcGRhdGVRdWV1ZTsKICAgICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZS5sYXN0RWZmZWN0ID0gZWZmZWN0Lm5leHQgPSBlZmZlY3Q7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGxhc3RFZmZlY3QgPSBjb21wb25lbnRVcGRhdGVRdWV1ZS5sYXN0RWZmZWN0OwogICAgICAgICAgICAgIGlmIChsYXN0RWZmZWN0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZS5sYXN0RWZmZWN0ID0gZWZmZWN0Lm5leHQgPSBlZmZlY3Q7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBmaXJzdEVmZmVjdCA9IGxhc3RFZmZlY3QubmV4dDsKICAgICAgICAgICAgICAgIGxhc3RFZmZlY3QubmV4dCA9IGVmZmVjdDsKICAgICAgICAgICAgICAgIGVmZmVjdC5uZXh0ID0gZmlyc3RFZmZlY3Q7CiAgICAgICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZS5sYXN0RWZmZWN0ID0gZWZmZWN0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZWZmZWN0OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbW91bnRSZWYoaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBfcmVmMiA9IHsKICAgICAgICAgICAgICAgIGN1cnJlbnQ6IGluaXRpYWxWYWx1ZQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gX3JlZjI7CiAgICAgICAgICAgICAgcmV0dXJuIF9yZWYyOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVSZWYoaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICAgIHJldHVybiBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtb3VudEVmZmVjdEltcGwoZmliZXJGbGFncywgaG9va0ZsYWdzLCBjcmVhdGUyLCBkZXBzKSB7CiAgICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgICAgdmFyIG5leHREZXBzID0gZGVwcyA9PT0gdm9pZCAwID8gbnVsbCA6IGRlcHM7CiAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEuZmxhZ3MgfD0gZmliZXJGbGFnczsKICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gcHVzaEVmZmVjdChIYXNFZmZlY3QgfCBob29rRmxhZ3MsIGNyZWF0ZTIsIHZvaWQgMCwgbmV4dERlcHMpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlRWZmZWN0SW1wbChmaWJlckZsYWdzLCBob29rRmxhZ3MsIGNyZWF0ZTIsIGRlcHMpIHsKICAgICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgICAgdmFyIG5leHREZXBzID0gZGVwcyA9PT0gdm9pZCAwID8gbnVsbCA6IGRlcHM7CiAgICAgICAgICAgIHZhciBkZXN0cm95ID0gdm9pZCAwOwogICAgICAgICAgICBpZiAoY3VycmVudEhvb2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgcHJldkVmZmVjdCA9IGN1cnJlbnRIb29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgZGVzdHJveSA9IHByZXZFZmZlY3QuZGVzdHJveTsKICAgICAgICAgICAgICBpZiAobmV4dERlcHMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2RGVwcyA9IHByZXZFZmZlY3QuZGVwczsKICAgICAgICAgICAgICAgIGlmIChhcmVIb29rSW5wdXRzRXF1YWwobmV4dERlcHMsIHByZXZEZXBzKSkgewogICAgICAgICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBwdXNoRWZmZWN0KGhvb2tGbGFncywgY3JlYXRlMiwgZGVzdHJveSwgbmV4dERlcHMpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEuZmxhZ3MgfD0gZmliZXJGbGFnczsKICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gcHVzaEVmZmVjdChIYXNFZmZlY3QgfCBob29rRmxhZ3MsIGNyZWF0ZTIsIGRlc3Ryb3ksIG5leHREZXBzKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG1vdW50RWZmZWN0KGNyZWF0ZTIsIGRlcHMpIHsKICAgICAgICAgICAgaWYgKChjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLm1vZGUgJiBTdHJpY3RFZmZlY3RzTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdEltcGwoTW91bnRQYXNzaXZlRGV2IHwgUGFzc2l2ZSB8IFBhc3NpdmVTdGF0aWMsIFBhc3NpdmUkMSwgY3JlYXRlMiwgZGVwcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0SW1wbChQYXNzaXZlIHwgUGFzc2l2ZVN0YXRpYywgUGFzc2l2ZSQxLCBjcmVhdGUyLCBkZXBzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlRWZmZWN0KGNyZWF0ZTIsIGRlcHMpIHsKICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUVmZmVjdEltcGwoUGFzc2l2ZSwgUGFzc2l2ZSQxLCBjcmVhdGUyLCBkZXBzKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG1vdW50SW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZTIsIGRlcHMpIHsKICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0SW1wbChVcGRhdGUsIEluc2VydGlvbiwgY3JlYXRlMiwgZGVwcyk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVJbnNlcnRpb25FZmZlY3QoY3JlYXRlMiwgZGVwcykgewogICAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0SW1wbChVcGRhdGUsIEluc2VydGlvbiwgY3JlYXRlMiwgZGVwcyk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtb3VudExheW91dEVmZmVjdChjcmVhdGUyLCBkZXBzKSB7CiAgICAgICAgICAgIHZhciBmaWJlckZsYWdzID0gVXBkYXRlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZmliZXJGbGFncyB8PSBMYXlvdXRTdGF0aWM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKChjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLm1vZGUgJiBTdHJpY3RFZmZlY3RzTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTW91bnRMYXlvdXREZXY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0SW1wbChmaWJlckZsYWdzLCBMYXlvdXQsIGNyZWF0ZTIsIGRlcHMpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlTGF5b3V0RWZmZWN0KGNyZWF0ZTIsIGRlcHMpIHsKICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUVmZmVjdEltcGwoVXBkYXRlLCBMYXlvdXQsIGNyZWF0ZTIsIGRlcHMpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaW1wZXJhdGl2ZUhhbmRsZUVmZmVjdChjcmVhdGUyLCByZWYpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiByZWYgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgcmVmQ2FsbGJhY2sgPSByZWY7CiAgICAgICAgICAgICAgdmFyIF9pbnN0ID0gY3JlYXRlMigpOwogICAgICAgICAgICAgIHJlZkNhbGxiYWNrKF9pbnN0KTsKICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZWZDYWxsYmFjayhudWxsKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgaWYgKHJlZiAhPT0gbnVsbCAmJiByZWYgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHZhciByZWZPYmplY3QgPSByZWY7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCFyZWZPYmplY3QuaGFzT3duUHJvcGVydHkoImN1cnJlbnQiKSkgewogICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgdXNlSW1wZXJhdGl2ZUhhbmRsZSgpIGZpcnN0IGFyZ3VtZW50IHRvIGVpdGhlciBiZSBhIHJlZiBjYWxsYmFjayBvciBSZWFjdC5jcmVhdGVSZWYoKSBvYmplY3QuIEluc3RlYWQgcmVjZWl2ZWQ6ICVzLiIsICJhbiBvYmplY3Qgd2l0aCBrZXlzIHsiICsgT2JqZWN0LmtleXMocmVmT2JqZWN0KS5qb2luKCIsICIpICsgIn0iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIF9pbnN0MiA9IGNyZWF0ZTIoKTsKICAgICAgICAgICAgICByZWZPYmplY3QuY3VycmVudCA9IF9pbnN0MjsKICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZWZPYmplY3QuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbW91bnRJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlMiwgZGVwcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjcmVhdGUyICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgdXNlSW1wZXJhdGl2ZUhhbmRsZSgpIHNlY29uZCBhcmd1bWVudCB0byBiZSBhIGZ1bmN0aW9uIHRoYXQgY3JlYXRlcyBhIGhhbmRsZS4gSW5zdGVhZCByZWNlaXZlZDogJXMuIiwgY3JlYXRlMiAhPT0gbnVsbCA/IHR5cGVvZiBjcmVhdGUyIDogIm51bGwiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGVmZmVjdERlcHMgPSBkZXBzICE9PSBudWxsICYmIGRlcHMgIT09IHZvaWQgMCA/IGRlcHMuY29uY2F0KFtyZWZdKSA6IG51bGw7CiAgICAgICAgICAgIHZhciBmaWJlckZsYWdzID0gVXBkYXRlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZmliZXJGbGFncyB8PSBMYXlvdXRTdGF0aWM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKChjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLm1vZGUgJiBTdHJpY3RFZmZlY3RzTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTW91bnRMYXlvdXREZXY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0SW1wbChmaWJlckZsYWdzLCBMYXlvdXQsIGltcGVyYXRpdmVIYW5kbGVFZmZlY3QuYmluZChudWxsLCBjcmVhdGUyLCByZWYpLCBlZmZlY3REZXBzKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUyLCBkZXBzKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGNyZWF0ZTIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCB1c2VJbXBlcmF0aXZlSGFuZGxlKCkgc2Vjb25kIGFyZ3VtZW50IHRvIGJlIGEgZnVuY3Rpb24gdGhhdCBjcmVhdGVzIGEgaGFuZGxlLiBJbnN0ZWFkIHJlY2VpdmVkOiAlcy4iLCBjcmVhdGUyICE9PSBudWxsID8gdHlwZW9mIGNyZWF0ZTIgOiAibnVsbCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZWZmZWN0RGVwcyA9IGRlcHMgIT09IG51bGwgJiYgZGVwcyAhPT0gdm9pZCAwID8gZGVwcy5jb25jYXQoW3JlZl0pIDogbnVsbDsKICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUVmZmVjdEltcGwoVXBkYXRlLCBMYXlvdXQsIGltcGVyYXRpdmVIYW5kbGVFZmZlY3QuYmluZChudWxsLCBjcmVhdGUyLCByZWYpLCBlZmZlY3REZXBzKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG1vdW50RGVidWdWYWx1ZSh2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB1cGRhdGVEZWJ1Z1ZhbHVlID0gbW91bnREZWJ1Z1ZhbHVlOwogICAgICAgICAgZnVuY3Rpb24gbW91bnRDYWxsYmFjayhjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICAgIHZhciBuZXh0RGVwcyA9IGRlcHMgPT09IHZvaWQgMCA/IG51bGwgOiBkZXBzOwogICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBbY2FsbGJhY2ssIG5leHREZXBzXTsKICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgICAgdmFyIG5leHREZXBzID0gZGVwcyA9PT0gdm9pZCAwID8gbnVsbCA6IGRlcHM7CiAgICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIGlmIChwcmV2U3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAobmV4dERlcHMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2RGVwcyA9IHByZXZTdGF0ZVsxXTsKICAgICAgICAgICAgICAgIGlmIChhcmVIb29rSW5wdXRzRXF1YWwobmV4dERlcHMsIHByZXZEZXBzKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gcHJldlN0YXRlWzBdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBbY2FsbGJhY2ssIG5leHREZXBzXTsKICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbW91bnRNZW1vKG5leHRDcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgICB2YXIgbmV4dERlcHMgPSBkZXBzID09PSB2b2lkIDAgPyBudWxsIDogZGVwczsKICAgICAgICAgICAgdmFyIG5leHRWYWx1ZSA9IG5leHRDcmVhdGUoKTsKICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gW25leHRWYWx1ZSwgbmV4dERlcHNdOwogICAgICAgICAgICByZXR1cm4gbmV4dFZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlTWVtbyhuZXh0Q3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICAgIHZhciBuZXh0RGVwcyA9IGRlcHMgPT09IHZvaWQgMCA/IG51bGwgOiBkZXBzOwogICAgICAgICAgICB2YXIgcHJldlN0YXRlID0gaG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICBpZiAocHJldlN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5leHREZXBzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJldkRlcHMgPSBwcmV2U3RhdGVbMV07CiAgICAgICAgICAgICAgICBpZiAoYXJlSG9va0lucHV0c0VxdWFsKG5leHREZXBzLCBwcmV2RGVwcykpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHByZXZTdGF0ZVswXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5leHRWYWx1ZSA9IG5leHRDcmVhdGUoKTsKICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gW25leHRWYWx1ZSwgbmV4dERlcHNdOwogICAgICAgICAgICByZXR1cm4gbmV4dFZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbW91bnREZWZlcnJlZFZhbHVlKHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gdmFsdWU7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZURlZmVycmVkVmFsdWUodmFsdWUpIHsKICAgICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgICAgdmFyIHJlc29sdmVkQ3VycmVudEhvb2sgPSBjdXJyZW50SG9vazsKICAgICAgICAgICAgdmFyIHByZXZWYWx1ZSA9IHJlc29sdmVkQ3VycmVudEhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlZmVycmVkVmFsdWVJbXBsKGhvb2ssIHByZXZWYWx1ZSwgdmFsdWUpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVyZW5kZXJEZWZlcnJlZFZhbHVlKHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICAgIGlmIChjdXJyZW50SG9vayA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IHZhbHVlOwogICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgcHJldlZhbHVlID0gY3VycmVudEhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRGVmZXJyZWRWYWx1ZUltcGwoaG9vaywgcHJldlZhbHVlLCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZURlZmVycmVkVmFsdWVJbXBsKGhvb2ssIHByZXZWYWx1ZSwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIHNob3VsZERlZmVyVmFsdWUgPSAhaW5jbHVkZXNPbmx5Tm9uVXJnZW50TGFuZXMocmVuZGVyTGFuZXMpOwogICAgICAgICAgICBpZiAoc2hvdWxkRGVmZXJWYWx1ZSkgewogICAgICAgICAgICAgIGlmICghb2JqZWN0SXModmFsdWUsIHByZXZWYWx1ZSkpIHsKICAgICAgICAgICAgICAgIHZhciBkZWZlcnJlZExhbmUgPSBjbGFpbU5leHRUcmFuc2l0aW9uTGFuZSgpOwogICAgICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5sYW5lcyA9IG1lcmdlTGFuZXMoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5sYW5lcywgZGVmZXJyZWRMYW5lKTsKICAgICAgICAgICAgICAgIG1hcmtTa2lwcGVkVXBkYXRlTGFuZXMoZGVmZXJyZWRMYW5lKTsKICAgICAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHByZXZWYWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoaG9vay5iYXNlU3RhdGUpIHsKICAgICAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBtYXJrV29ya0luUHJvZ3Jlc3NSZWNlaXZlZFVwZGF0ZSgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSB2YWx1ZTsKICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHN0YXJ0VHJhbnNpdGlvbihzZXRQZW5kaW5nLCBjYWxsYmFjaywgb3B0aW9uczIpIHsKICAgICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KGhpZ2hlckV2ZW50UHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSwgQ29udGludW91c0V2ZW50UHJpb3JpdHkpKTsKICAgICAgICAgICAgc2V0UGVuZGluZyh0cnVlKTsKICAgICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMi50cmFuc2l0aW9uOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQyLnRyYW5zaXRpb24gPSB7fTsKICAgICAgICAgICAgdmFyIGN1cnJlbnRUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMi50cmFuc2l0aW9uOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMi50cmFuc2l0aW9uLl91cGRhdGVkRmliZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHNldFBlbmRpbmcoZmFsc2UpOwogICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDIudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChwcmV2VHJhbnNpdGlvbiA9PT0gbnVsbCAmJiBjdXJyZW50VHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycykgewogICAgICAgICAgICAgICAgICB2YXIgdXBkYXRlZEZpYmVyc0NvdW50ID0gY3VycmVudFRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMuc2l6ZTsKICAgICAgICAgICAgICAgICAgaWYgKHVwZGF0ZWRGaWJlcnNDb3VudCA+IDEwKSB7CiAgICAgICAgICAgICAgICAgICAgd2FybigiRGV0ZWN0ZWQgYSBsYXJnZSBudW1iZXIgb2YgdXBkYXRlcyBpbnNpZGUgc3RhcnRUcmFuc2l0aW9uLiBJZiB0aGlzIGlzIGR1ZSB0byBhIHN1YnNjcmlwdGlvbiBwbGVhc2UgcmUtd3JpdGUgaXQgdG8gdXNlIFJlYWN0IHByb3ZpZGVkIGhvb2tzLiBPdGhlcndpc2UgY29uY3VycmVudCBtb2RlIGd1YXJhbnRlZXMgYXJlIG9mZiB0aGUgdGFibGUuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY3VycmVudFRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMuY2xlYXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG1vdW50VHJhbnNpdGlvbigpIHsKICAgICAgICAgICAgdmFyIF9tb3VudFN0YXRlID0gbW91bnRTdGF0ZShmYWxzZSksIGlzUGVuZGluZyA9IF9tb3VudFN0YXRlWzBdLCBzZXRQZW5kaW5nID0gX21vdW50U3RhdGVbMV07CiAgICAgICAgICAgIHZhciBzdGFydDIgPSBzdGFydFRyYW5zaXRpb24uYmluZChudWxsLCBzZXRQZW5kaW5nKTsKICAgICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBzdGFydDI7CiAgICAgICAgICAgIHJldHVybiBbaXNQZW5kaW5nLCBzdGFydDJdOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlVHJhbnNpdGlvbigpIHsKICAgICAgICAgICAgdmFyIF91cGRhdGVTdGF0ZSA9IHVwZGF0ZVN0YXRlKCksIGlzUGVuZGluZyA9IF91cGRhdGVTdGF0ZVswXTsKICAgICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgICAgdmFyIHN0YXJ0MiA9IGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgcmV0dXJuIFtpc1BlbmRpbmcsIHN0YXJ0Ml07CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZXJlbmRlclRyYW5zaXRpb24oKSB7CiAgICAgICAgICAgIHZhciBfcmVyZW5kZXJTdGF0ZSA9IHJlcmVuZGVyU3RhdGUoKSwgaXNQZW5kaW5nID0gX3JlcmVuZGVyU3RhdGVbMF07CiAgICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICAgIHZhciBzdGFydDIgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIHJldHVybiBbaXNQZW5kaW5nLCBzdGFydDJdOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGlzVXBkYXRpbmdPcGFxdWVWYWx1ZUluUmVuZGVyUGhhc2UgPSBmYWxzZTsKICAgICAgICAgIGZ1bmN0aW9uIGdldElzVXBkYXRpbmdPcGFxdWVWYWx1ZUluUmVuZGVyUGhhc2VJbkRFVigpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHJldHVybiBpc1VwZGF0aW5nT3BhcXVlVmFsdWVJblJlbmRlclBoYXNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtb3VudElkKCkgewogICAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICAgIHZhciByb290MyA9IGdldFdvcmtJblByb2dyZXNzUm9vdCgpOwogICAgICAgICAgICB2YXIgaWRlbnRpZmllclByZWZpeCA9IHJvb3QzLmlkZW50aWZpZXJQcmVmaXg7CiAgICAgICAgICAgIHZhciBpZDI7CiAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgdmFyIHRyZWVJZCA9IGdldFRyZWVJZCgpOwogICAgICAgICAgICAgIGlkMiA9ICI6IiArIGlkZW50aWZpZXJQcmVmaXggKyAiUiIgKyB0cmVlSWQ7CiAgICAgICAgICAgICAgdmFyIGxvY2FsSWQgPSBsb2NhbElkQ291bnRlcisrOwogICAgICAgICAgICAgIGlmIChsb2NhbElkID4gMCkgewogICAgICAgICAgICAgICAgaWQyICs9ICJIIiArIGxvY2FsSWQudG9TdHJpbmcoMzIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZDIgKz0gIjoiOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBnbG9iYWxDbGllbnRJZCA9IGdsb2JhbENsaWVudElkQ291bnRlcisrOwogICAgICAgICAgICAgIGlkMiA9ICI6IiArIGlkZW50aWZpZXJQcmVmaXggKyAiciIgKyBnbG9iYWxDbGllbnRJZC50b1N0cmluZygzMikgKyAiOiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gaWQyOwogICAgICAgICAgICByZXR1cm4gaWQyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlSWQoKSB7CiAgICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICAgIHZhciBpZDIgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIHJldHVybiBpZDI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaFJlZHVjZXJBY3Rpb24oZmliZXIsIHF1ZXVlLCBhY3Rpb24pIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgYXJndW1lbnRzWzNdID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiU3RhdGUgdXBkYXRlcyBmcm9tIHRoZSB1c2VTdGF0ZSgpIGFuZCB1c2VSZWR1Y2VyKCkgSG9va3MgZG9uJ3Qgc3VwcG9ydCB0aGUgc2Vjb25kIGNhbGxiYWNrIGFyZ3VtZW50LiBUbyBleGVjdXRlIGEgc2lkZSBlZmZlY3QgYWZ0ZXIgcmVuZGVyaW5nLCBkZWNsYXJlIGl0IGluIHRoZSBjb21wb25lbnQgYm9keSB3aXRoIHVzZUVmZmVjdCgpLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKTsKICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IHsKICAgICAgICAgICAgICBsYW5lLAogICAgICAgICAgICAgIGFjdGlvbiwKICAgICAgICAgICAgICBoYXNFYWdlclN0YXRlOiBmYWxzZSwKICAgICAgICAgICAgICBlYWdlclN0YXRlOiBudWxsLAogICAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKGlzUmVuZGVyUGhhc2VVcGRhdGUoZmliZXIpKSB7CiAgICAgICAgICAgICAgZW5xdWV1ZVJlbmRlclBoYXNlVXBkYXRlKHF1ZXVlLCB1cGRhdGUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50SG9va1VwZGF0ZShmaWJlciwgcXVldWUsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICAgIGVudGFuZ2xlVHJhbnNpdGlvblVwZGF0ZShyb290MywgcXVldWUsIGxhbmUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBtYXJrVXBkYXRlSW5EZXZUb29scyhmaWJlciwgbGFuZSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaFNldFN0YXRlKGZpYmVyLCBxdWV1ZSwgYWN0aW9uKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3VtZW50c1szXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZXJyb3IoIlN0YXRlIHVwZGF0ZXMgZnJvbSB0aGUgdXNlU3RhdGUoKSBhbmQgdXNlUmVkdWNlcigpIEhvb2tzIGRvbid0IHN1cHBvcnQgdGhlIHNlY29uZCBjYWxsYmFjayBhcmd1bWVudC4gVG8gZXhlY3V0ZSBhIHNpZGUgZWZmZWN0IGFmdGVyIHJlbmRlcmluZywgZGVjbGFyZSBpdCBpbiB0aGUgY29tcG9uZW50IGJvZHkgd2l0aCB1c2VFZmZlY3QoKS4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGxhbmUgPSByZXF1ZXN0VXBkYXRlTGFuZShmaWJlcik7CiAgICAgICAgICAgIHZhciB1cGRhdGUgPSB7CiAgICAgICAgICAgICAgbGFuZSwKICAgICAgICAgICAgICBhY3Rpb24sCiAgICAgICAgICAgICAgaGFzRWFnZXJTdGF0ZTogZmFsc2UsCiAgICAgICAgICAgICAgZWFnZXJTdGF0ZTogbnVsbCwKICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmIChpc1JlbmRlclBoYXNlVXBkYXRlKGZpYmVyKSkgewogICAgICAgICAgICAgIGVucXVldWVSZW5kZXJQaGFzZVVwZGF0ZShxdWV1ZSwgdXBkYXRlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIGlmIChmaWJlci5sYW5lcyA9PT0gTm9MYW5lcyAmJiAoYWx0ZXJuYXRlID09PSBudWxsIHx8IGFsdGVybmF0ZS5sYW5lcyA9PT0gTm9MYW5lcykpIHsKICAgICAgICAgICAgICAgIHZhciBsYXN0UmVuZGVyZWRSZWR1Y2VyID0gcXVldWUubGFzdFJlbmRlcmVkUmVkdWNlcjsKICAgICAgICAgICAgICAgIGlmIChsYXN0UmVuZGVyZWRSZWR1Y2VyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50U3RhdGUgPSBxdWV1ZS5sYXN0UmVuZGVyZWRTdGF0ZTsKICAgICAgICAgICAgICAgICAgICB2YXIgZWFnZXJTdGF0ZSA9IGxhc3RSZW5kZXJlZFJlZHVjZXIoY3VycmVudFN0YXRlLCBhY3Rpb24pOwogICAgICAgICAgICAgICAgICAgIHVwZGF0ZS5oYXNFYWdlclN0YXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB1cGRhdGUuZWFnZXJTdGF0ZSA9IGVhZ2VyU3RhdGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9iamVjdElzKGVhZ2VyU3RhdGUsIGN1cnJlbnRTdGF0ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIGVucXVldWVDb25jdXJyZW50SG9va1VwZGF0ZUFuZEVhZ2VybHlCYWlsb3V0KGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50SG9va1VwZGF0ZShmaWJlciwgcXVldWUsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICAgIGVudGFuZ2xlVHJhbnNpdGlvblVwZGF0ZShyb290MywgcXVldWUsIGxhbmUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBtYXJrVXBkYXRlSW5EZXZUb29scyhmaWJlciwgbGFuZSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpc1JlbmRlclBoYXNlVXBkYXRlKGZpYmVyKSB7CiAgICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgIHJldHVybiBmaWJlciA9PT0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSB8fCBhbHRlcm5hdGUgIT09IG51bGwgJiYgYWx0ZXJuYXRlID09PSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZVJlbmRlclBoYXNlVXBkYXRlKHF1ZXVlLCB1cGRhdGUpIHsKICAgICAgICAgICAgZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZUR1cmluZ1RoaXNQYXNzID0gZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIHZhciBwZW5kaW5nID0gcXVldWUucGVuZGluZzsKICAgICAgICAgICAgaWYgKHBlbmRpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICB1cGRhdGUubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB1cGRhdGUubmV4dCA9IHBlbmRpbmcubmV4dDsKICAgICAgICAgICAgICBwZW5kaW5nLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcXVldWUucGVuZGluZyA9IHVwZGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGVudGFuZ2xlVHJhbnNpdGlvblVwZGF0ZShyb290MywgcXVldWUsIGxhbmUpIHsKICAgICAgICAgICAgaWYgKGlzVHJhbnNpdGlvbkxhbmUobGFuZSkpIHsKICAgICAgICAgICAgICB2YXIgcXVldWVMYW5lcyA9IHF1ZXVlLmxhbmVzOwogICAgICAgICAgICAgIHF1ZXVlTGFuZXMgPSBpbnRlcnNlY3RMYW5lcyhxdWV1ZUxhbmVzLCByb290My5wZW5kaW5nTGFuZXMpOwogICAgICAgICAgICAgIHZhciBuZXdRdWV1ZUxhbmVzID0gbWVyZ2VMYW5lcyhxdWV1ZUxhbmVzLCBsYW5lKTsKICAgICAgICAgICAgICBxdWV1ZS5sYW5lcyA9IG5ld1F1ZXVlTGFuZXM7CiAgICAgICAgICAgICAgbWFya1Jvb3RFbnRhbmdsZWQocm9vdDMsIG5ld1F1ZXVlTGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtYXJrVXBkYXRlSW5EZXZUb29scyhmaWJlciwgbGFuZSwgYWN0aW9uKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrU3RhdGVVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgQ29udGV4dE9ubHlEaXNwYXRjaGVyID0gewogICAgICAgICAgICByZWFkQ29udGV4dCwKICAgICAgICAgICAgdXNlQ2FsbGJhY2s6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgICAgdXNlQ29udGV4dDogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgICB1c2VFZmZlY3Q6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgICB1c2VJbnNlcnRpb25FZmZlY3Q6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICAgIHVzZU1lbW86IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgICAgdXNlUmVkdWNlcjogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgICB1c2VSZWY6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgICAgdXNlU3RhdGU6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgICAgdXNlRGVidWdWYWx1ZTogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgICB1c2VTeW5jRXh0ZXJuYWxTdG9yZTogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgICB1c2VJZDogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWID0gbnVsbDsKICAgICAgICAgIHZhciBIb29rc0Rpc3BhdGNoZXJPbk1vdW50V2l0aEhvb2tUeXBlc0luREVWID0gbnVsbDsKICAgICAgICAgIHZhciBIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWID0gbnVsbDsKICAgICAgICAgIHZhciBIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVYgPSBudWxsOwogICAgICAgICAgdmFyIEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVYgPSBudWxsOwogICAgICAgICAgdmFyIEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWID0gbnVsbDsKICAgICAgICAgIHZhciBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25SZXJlbmRlckluREVWID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHdhcm5JbnZhbGlkQ29udGV4dEFjY2VzcyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGVycm9yKCJDb250ZXh0IGNhbiBvbmx5IGJlIHJlYWQgd2hpbGUgUmVhY3QgaXMgcmVuZGVyaW5nLiBJbiBjbGFzc2VzLCB5b3UgY2FuIHJlYWQgaXQgaW4gdGhlIHJlbmRlciBtZXRob2Qgb3IgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLiBJbiBmdW5jdGlvbiBjb21wb25lbnRzLCB5b3UgY2FuIHJlYWQgaXQgZGlyZWN0bHkgaW4gdGhlIGZ1bmN0aW9uIGJvZHksIGJ1dCBub3QgaW5zaWRlIEhvb2tzIGxpa2UgdXNlUmVkdWNlcigpIG9yIHVzZU1lbW8oKS4iKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIHdhcm5JbnZhbGlkSG9va0FjY2VzcyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGVycm9yKCJEbyBub3QgY2FsbCBIb29rcyBpbnNpZGUgdXNlRWZmZWN0KC4uLiksIHVzZU1lbW8oLi4uKSwgb3Igb3RoZXIgYnVpbHQtaW4gSG9va3MuIFlvdSBjYW4gb25seSBjYWxsIEhvb2tzIGF0IHRoZSB0b3AgbGV2ZWwgb2YgeW91ciBSZWFjdCBmdW5jdGlvbi4gRm9yIG1vcmUgaW5mb3JtYXRpb24sIHNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcnVsZXMtb2YtaG9va3MiKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWID0gewogICAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNhbGxiYWNrIjsKICAgICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKTsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudENhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZUNvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZUVmZmVjdDogZnVuY3Rpb24oY3JlYXRlMiwgZGVwcykgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRWZmZWN0IjsKICAgICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKTsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdChjcmVhdGUyLCBkZXBzKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlMiwgZGVwcykgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcyk7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlMiwgZGVwcyk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VJbnNlcnRpb25FZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZTIsIGRlcHMpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUluc2VydGlvbkVmZmVjdCI7CiAgICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcyk7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbnNlcnRpb25FZmZlY3QoY3JlYXRlMiwgZGVwcyk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VMYXlvdXRFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZTIsIGRlcHMpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUxheW91dEVmZmVjdCI7CiAgICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcyk7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRMYXlvdXRFZmZlY3QoY3JlYXRlMiwgZGVwcyk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUyLCBkZXBzKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKTsKICAgICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TWVtbyhjcmVhdGUyLCBkZXBzKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0MikgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQyKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVmIjsKICAgICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRSZWYoaW5pdGlhbFZhbHVlKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN0YXRlIjsKICAgICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFN0YXRlKGluaXRpYWxTdGF0ZSk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlRGVidWdWYWx1ZTogZnVuY3Rpb24odmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWJ1Z1ZhbHVlIjsKICAgICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnREZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFRyYW5zaXRpb24oKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TXV0YWJsZVNvdXJjZSgpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTeW5jRXh0ZXJuYWxTdG9yZSI7CiAgICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50U3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSWQiOwogICAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudElkKCk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICAgICAgfTsKICAgICAgICAgICAgSG9va3NEaXNwYXRjaGVyT25Nb3VudFdpdGhIb29rVHlwZXNJbkRFViA9IHsKICAgICAgICAgICAgICByZWFkQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlQ2FsbGJhY2s6IGZ1bmN0aW9uKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudENhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZUNvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZTIsIGRlcHMpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdChjcmVhdGUyLCBkZXBzKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlMiwgZGVwcykgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudEltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUyLCBkZXBzKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlMiwgZGVwcykgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZTIsIGRlcHMpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiBmdW5jdGlvbihjcmVhdGUyLCBkZXBzKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRMYXlvdXRFZmZlY3QoY3JlYXRlMiwgZGVwcyk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUyLCBkZXBzKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRNZW1vKGNyZWF0ZTIsIGRlcHMpOwogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZVJlZHVjZXI6IGZ1bmN0aW9uKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQyKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWR1Y2VyIjsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQyKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVmIjsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50UmVmKGluaXRpYWxWYWx1ZSk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VTdGF0ZTogZnVuY3Rpb24oaW5pdGlhbFN0YXRlKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50U3RhdGUoaW5pdGlhbFN0YXRlKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VEZWJ1Z1ZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnREZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudERlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50VHJhbnNpdGlvbigpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogZnVuY3Rpb24oc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNdXRhYmxlU291cmNlIjsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TXV0YWJsZVNvdXJjZSgpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTeW5jRXh0ZXJuYWxTdG9yZSI7CiAgICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZUlkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SWQoKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgICAgICB9OwogICAgICAgICAgICBIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWID0gewogICAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNhbGxiYWNrIjsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZUNvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZTIsIGRlcHMpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3QoY3JlYXRlMiwgZGVwcyk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VJbXBlcmF0aXZlSGFuZGxlOiBmdW5jdGlvbihyZWYsIGNyZWF0ZTIsIGRlcHMpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUltcGVyYXRpdmVIYW5kbGUiOwogICAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZTIsIGRlcHMpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUyLCBkZXBzKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZTIsIGRlcHMpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiBmdW5jdGlvbihjcmVhdGUyLCBkZXBzKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTGF5b3V0RWZmZWN0KGNyZWF0ZTIsIGRlcHMpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlTWVtbzogZnVuY3Rpb24oY3JlYXRlMiwgZGVwcykgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTWVtbyI7CiAgICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNZW1vKGNyZWF0ZTIsIGRlcHMpOwogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZVJlZHVjZXI6IGZ1bmN0aW9uKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQyKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWR1Y2VyIjsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdDIpOwogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZVJlZjogZnVuY3Rpb24oaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWYiOwogICAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUmVmKCk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VTdGF0ZTogZnVuY3Rpb24oaW5pdGlhbFN0YXRlKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTdGF0ZShpbml0aWFsU3RhdGUpOwogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVidWdWYWx1ZSI7CiAgICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWZlcnJlZFZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlVHJhbnNpdGlvbiI7CiAgICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VNdXRhYmxlU291cmNlOiBmdW5jdGlvbihzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU11dGFibGVTb3VyY2UiOwogICAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTXV0YWJsZVNvdXJjZSgpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTeW5jRXh0ZXJuYWxTdG9yZSI7CiAgICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90KTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZUlkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUlkKCk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICAgICAgfTsKICAgICAgICAgICAgSG9va3NEaXNwYXRjaGVyT25SZXJlbmRlckluREVWID0gewogICAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNhbGxiYWNrIjsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZUNvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZTIsIGRlcHMpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3QoY3JlYXRlMiwgZGVwcyk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VJbXBlcmF0aXZlSGFuZGxlOiBmdW5jdGlvbihyZWYsIGNyZWF0ZTIsIGRlcHMpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUltcGVyYXRpdmVIYW5kbGUiOwogICAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZTIsIGRlcHMpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUyLCBkZXBzKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZTIsIGRlcHMpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiBmdW5jdGlvbihjcmVhdGUyLCBkZXBzKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTGF5b3V0RWZmZWN0KGNyZWF0ZTIsIGRlcHMpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlTWVtbzogZnVuY3Rpb24oY3JlYXRlMiwgZGVwcykgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTWVtbyI7CiAgICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25SZXJlbmRlckluREVWOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU1lbW8oY3JlYXRlMiwgZGVwcyk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlUmVkdWNlcjogZnVuY3Rpb24ocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdDIpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZHVjZXIiOwogICAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uUmVyZW5kZXJJbkRFVjsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiByZXJlbmRlclJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdDIpOwogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZVJlZjogZnVuY3Rpb24oaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWYiOwogICAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUmVmKCk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VTdGF0ZTogZnVuY3Rpb24oaW5pdGlhbFN0YXRlKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25SZXJlbmRlckluREVWOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyU3RhdGUoaW5pdGlhbFN0YXRlKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VEZWJ1Z1ZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRGVidWdWYWx1ZSgpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlRGVmZXJyZWRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlZmVycmVkVmFsdWUiOwogICAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVyZW5kZXJEZWZlcnJlZFZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlVHJhbnNpdGlvbiI7CiAgICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHJldHVybiByZXJlbmRlclRyYW5zaXRpb24oKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNdXRhYmxlU291cmNlKCk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VTeW5jRXh0ZXJuYWxTdG9yZTogZnVuY3Rpb24oc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN5bmNFeHRlcm5hbFN0b3JlIjsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSWQiOwogICAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSWQoKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgICAgICB9OwogICAgICAgICAgICBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWID0gewogICAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgICB3YXJuSW52YWxpZENvbnRleHRBY2Nlc3MoKTsKICAgICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZUNhbGxiYWNrOiBmdW5jdGlvbihjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ2FsbGJhY2siOwogICAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50Q2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ29udGV4dCI7CiAgICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZTIsIGRlcHMpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRFZmZlY3QoY3JlYXRlMiwgZGVwcyk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VJbXBlcmF0aXZlSGFuZGxlOiBmdW5jdGlvbihyZWYsIGNyZWF0ZTIsIGRlcHMpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUltcGVyYXRpdmVIYW5kbGUiOwogICAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZTIsIGRlcHMpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUyLCBkZXBzKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZTIsIGRlcHMpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiBmdW5jdGlvbihjcmVhdGUyLCBkZXBzKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TGF5b3V0RWZmZWN0KGNyZWF0ZTIsIGRlcHMpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlTWVtbzogZnVuY3Rpb24oY3JlYXRlMiwgZGVwcykgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTWVtbyI7CiAgICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBtb3VudE1lbW8oY3JlYXRlMiwgZGVwcyk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlUmVkdWNlcjogZnVuY3Rpb24ocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdDIpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZHVjZXIiOwogICAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQyKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVmIjsKICAgICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFJlZihpbml0aWFsVmFsdWUpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlU3RhdGU6IGZ1bmN0aW9uKGluaXRpYWxTdGF0ZSkgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3RhdGUiOwogICAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRTdGF0ZShpbml0aWFsU3RhdGUpOwogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVidWdWYWx1ZSI7CiAgICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnREZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnREZWZlcnJlZFZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlVHJhbnNpdGlvbiI7CiAgICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VNdXRhYmxlU291cmNlOiBmdW5jdGlvbihzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU11dGFibGVTb3VyY2UiOwogICAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TXV0YWJsZVNvdXJjZSgpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTeW5jRXh0ZXJuYWxTdG9yZSI7CiAgICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VJZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJZCI7CiAgICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRJZCgpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWID0gewogICAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgICB3YXJuSW52YWxpZENvbnRleHRBY2Nlc3MoKTsKICAgICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZUNhbGxiYWNrOiBmdW5jdGlvbihjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ2FsbGJhY2siOwogICAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDb250ZXh0IjsKICAgICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZTIsIGRlcHMpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUVmZmVjdChjcmVhdGUyLCBkZXBzKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlMiwgZGVwcykgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUyLCBkZXBzKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlMiwgZGVwcykgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZTIsIGRlcHMpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiBmdW5jdGlvbihjcmVhdGUyLCBkZXBzKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVMYXlvdXRFZmZlY3QoY3JlYXRlMiwgZGVwcyk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUyLCBkZXBzKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTWVtbyhjcmVhdGUyLCBkZXBzKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0MikgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdDIpOwogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZVJlZjogZnVuY3Rpb24oaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWYiOwogICAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVSZWYoKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN0YXRlIjsKICAgICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3RhdGUoaW5pdGlhbFN0YXRlKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VEZWJ1Z1ZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlVHJhbnNpdGlvbigpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogZnVuY3Rpb24oc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNdXRhYmxlU291cmNlIjsKICAgICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTXV0YWJsZVNvdXJjZSgpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTeW5jRXh0ZXJuYWxTdG9yZSI7CiAgICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSWQiOwogICAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJZCgpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVYgPSB7CiAgICAgICAgICAgICAgcmVhZENvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICAgIHdhcm5JbnZhbGlkQ29udGV4dEFjY2VzcygpOwogICAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlQ2FsbGJhY2s6IGZ1bmN0aW9uKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZUNvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZUVmZmVjdDogZnVuY3Rpb24oY3JlYXRlMiwgZGVwcykgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRWZmZWN0IjsKICAgICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0KGNyZWF0ZTIsIGRlcHMpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUyLCBkZXBzKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZTIsIGRlcHMpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUyLCBkZXBzKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJbnNlcnRpb25FZmZlY3QoY3JlYXRlMiwgZGVwcyk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VMYXlvdXRFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZTIsIGRlcHMpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUxheW91dEVmZmVjdCI7CiAgICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUxheW91dEVmZmVjdChjcmVhdGUyLCBkZXBzKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZTIsIGRlcHMpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNZW1vKGNyZWF0ZTIsIGRlcHMpOwogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZVJlZHVjZXI6IGZ1bmN0aW9uKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQyKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWR1Y2VyIjsKICAgICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICByZXR1cm4gcmVyZW5kZXJSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQyKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVmIjsKICAgICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUmVmKCk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VTdGF0ZTogZnVuY3Rpb24oaW5pdGlhbFN0YXRlKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyU3RhdGUoaW5pdGlhbFN0YXRlKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VEZWJ1Z1ZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyRGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHJldHVybiByZXJlbmRlclRyYW5zaXRpb24oKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90KTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVzZUlkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSWQoKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5vdyQxID0gU2NoZWR1bGVyLnVuc3RhYmxlX25vdzsKICAgICAgICAgIHZhciBjb21taXRUaW1lID0gMDsKICAgICAgICAgIHZhciBsYXlvdXRFZmZlY3RTdGFydFRpbWUgPSAtMTsKICAgICAgICAgIHZhciBwcm9maWxlclN0YXJ0VGltZSA9IC0xOwogICAgICAgICAgdmFyIHBhc3NpdmVFZmZlY3RTdGFydFRpbWUgPSAtMTsKICAgICAgICAgIHZhciBjdXJyZW50VXBkYXRlSXNOZXN0ZWQgPSBmYWxzZTsKICAgICAgICAgIHZhciBuZXN0ZWRVcGRhdGVTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICAgIGZ1bmN0aW9uIGlzQ3VycmVudFVwZGF0ZU5lc3RlZCgpIHsKICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRVcGRhdGVJc05lc3RlZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG1hcmtOZXN0ZWRVcGRhdGVTY2hlZHVsZWQoKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBuZXN0ZWRVcGRhdGVTY2hlZHVsZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZXNldE5lc3RlZFVwZGF0ZUZsYWcoKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjdXJyZW50VXBkYXRlSXNOZXN0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICBuZXN0ZWRVcGRhdGVTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gc3luY05lc3RlZFVwZGF0ZUZsYWcoKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjdXJyZW50VXBkYXRlSXNOZXN0ZWQgPSBuZXN0ZWRVcGRhdGVTY2hlZHVsZWQ7CiAgICAgICAgICAgICAgbmVzdGVkVXBkYXRlU2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldENvbW1pdFRpbWUoKSB7CiAgICAgICAgICAgIHJldHVybiBjb21taXRUaW1lOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb3JkQ29tbWl0VGltZSgpIHsKICAgICAgICAgICAgY29tbWl0VGltZSA9IG5vdyQxKCk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzdGFydFByb2ZpbGVyVGltZXIoZmliZXIpIHsKICAgICAgICAgICAgcHJvZmlsZXJTdGFydFRpbWUgPSBub3ckMSgpOwogICAgICAgICAgICBpZiAoZmliZXIuYWN0dWFsU3RhcnRUaW1lIDwgMCkgewogICAgICAgICAgICAgIGZpYmVyLmFjdHVhbFN0YXJ0VGltZSA9IG5vdyQxKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nKGZpYmVyKSB7CiAgICAgICAgICAgIHByb2ZpbGVyU3RhcnRUaW1lID0gLTE7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZ0FuZFJlY29yZERlbHRhKGZpYmVyLCBvdmVycmlkZUJhc2VUaW1lKSB7CiAgICAgICAgICAgIGlmIChwcm9maWxlclN0YXJ0VGltZSA+PSAwKSB7CiAgICAgICAgICAgICAgdmFyIGVsYXBzZWRUaW1lID0gbm93JDEoKSAtIHByb2ZpbGVyU3RhcnRUaW1lOwogICAgICAgICAgICAgIGZpYmVyLmFjdHVhbER1cmF0aW9uICs9IGVsYXBzZWRUaW1lOwogICAgICAgICAgICAgIGlmIChvdmVycmlkZUJhc2VUaW1lKSB7CiAgICAgICAgICAgICAgICBmaWJlci5zZWxmQmFzZUR1cmF0aW9uID0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByb2ZpbGVyU3RhcnRUaW1lID0gLTE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgIGlmIChsYXlvdXRFZmZlY3RTdGFydFRpbWUgPj0gMCkgewogICAgICAgICAgICAgIHZhciBlbGFwc2VkVGltZSA9IG5vdyQxKCkgLSBsYXlvdXRFZmZlY3RTdGFydFRpbWU7CiAgICAgICAgICAgICAgbGF5b3V0RWZmZWN0U3RhcnRUaW1lID0gLTE7CiAgICAgICAgICAgICAgdmFyIHBhcmVudEZpYmVyID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICAgIHdoaWxlIChwYXJlbnRGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc3dpdGNoIChwYXJlbnRGaWJlci50YWcpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgcm9vdDMuZWZmZWN0RHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICBjYXNlIFByb2ZpbGVyOgogICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRTdGF0ZU5vZGUgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgcGFyZW50U3RhdGVOb2RlLmVmZmVjdER1cmF0aW9uICs9IGVsYXBzZWRUaW1lOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBhcmVudEZpYmVyID0gcGFyZW50RmliZXIucmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb3JkUGFzc2l2ZUVmZmVjdER1cmF0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgIGlmIChwYXNzaXZlRWZmZWN0U3RhcnRUaW1lID49IDApIHsKICAgICAgICAgICAgICB2YXIgZWxhcHNlZFRpbWUgPSBub3ckMSgpIC0gcGFzc2l2ZUVmZmVjdFN0YXJ0VGltZTsKICAgICAgICAgICAgICBwYXNzaXZlRWZmZWN0U3RhcnRUaW1lID0gLTE7CiAgICAgICAgICAgICAgdmFyIHBhcmVudEZpYmVyID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICAgIHdoaWxlIChwYXJlbnRGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc3dpdGNoIChwYXJlbnRGaWJlci50YWcpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICByb290My5wYXNzaXZlRWZmZWN0RHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50U3RhdGVOb2RlID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnRTdGF0ZU5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFN0YXRlTm9kZS5wYXNzaXZlRWZmZWN0RHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBhcmVudEZpYmVyID0gcGFyZW50RmliZXIucmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpIHsKICAgICAgICAgICAgbGF5b3V0RWZmZWN0U3RhcnRUaW1lID0gbm93JDEoKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHN0YXJ0UGFzc2l2ZUVmZmVjdFRpbWVyKCkgewogICAgICAgICAgICBwYXNzaXZlRWZmZWN0U3RhcnRUaW1lID0gbm93JDEoKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHRyYW5zZmVyQWN0dWFsRHVyYXRpb24oZmliZXIpIHsKICAgICAgICAgICAgdmFyIGNoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChjaGlsZCkgewogICAgICAgICAgICAgIGZpYmVyLmFjdHVhbER1cmF0aW9uICs9IGNoaWxkLmFjdHVhbER1cmF0aW9uOwogICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIodmFsdWUsIHNvdXJjZSkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIHZhbHVlLAogICAgICAgICAgICAgIHNvdXJjZSwKICAgICAgICAgICAgICBzdGFjazogZ2V0U3RhY2tCeUZpYmVySW5EZXZBbmRQcm9kKHNvdXJjZSksCiAgICAgICAgICAgICAgZGlnZXN0OiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVDYXB0dXJlZFZhbHVlKHZhbHVlLCBkaWdlc3QsIHN0YWNrKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgICAgc291cmNlOiBudWxsLAogICAgICAgICAgICAgIHN0YWNrOiBzdGFjayAhPSBudWxsID8gc3RhY2sgOiBudWxsLAogICAgICAgICAgICAgIGRpZ2VzdDogZGlnZXN0ICE9IG51bGwgPyBkaWdlc3QgOiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzaG93RXJyb3JEaWFsb2coYm91bmRhcnksIGVycm9ySW5mbykgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGxvZ0NhcHR1cmVkRXJyb3IoYm91bmRhcnksIGVycm9ySW5mbykgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHZhciBsb2dFcnJvciA9IHNob3dFcnJvckRpYWxvZyhib3VuZGFyeSwgZXJyb3JJbmZvKTsKICAgICAgICAgICAgICBpZiAobG9nRXJyb3IgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBlcnJvcjIgPSBlcnJvckluZm8udmFsdWU7CiAgICAgICAgICAgICAgaWYgKHRydWUpIHsKICAgICAgICAgICAgICAgIHZhciBzb3VyY2UgPSBlcnJvckluZm8uc291cmNlOwogICAgICAgICAgICAgICAgdmFyIHN0YWNrID0gZXJyb3JJbmZvLnN0YWNrOwogICAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudFN0YWNrID0gc3RhY2sgIT09IG51bGwgPyBzdGFjayA6ICIiOwogICAgICAgICAgICAgICAgaWYgKGVycm9yMiAhPSBudWxsICYmIGVycm9yMi5fc3VwcHJlc3NMb2dnaW5nKSB7CiAgICAgICAgICAgICAgICAgIGlmIChib3VuZGFyeS50YWcgPT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNvbnNvbGVbImVycm9yIl0oZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gc291cmNlID8gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihzb3VyY2UpIDogbnVsbDsKICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lTWVzc2FnZSA9IGNvbXBvbmVudE5hbWUgPyAiVGhlIGFib3ZlIGVycm9yIG9jY3VycmVkIGluIHRoZSA8IiArIGNvbXBvbmVudE5hbWUgKyAiPiBjb21wb25lbnQ6IiA6ICJUaGUgYWJvdmUgZXJyb3Igb2NjdXJyZWQgaW4gb25lIG9mIHlvdXIgUmVhY3QgY29tcG9uZW50czoiOwogICAgICAgICAgICAgICAgdmFyIGVycm9yQm91bmRhcnlNZXNzYWdlOwogICAgICAgICAgICAgICAgaWYgKGJvdW5kYXJ5LnRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgICAgICAgZXJyb3JCb3VuZGFyeU1lc3NhZ2UgPSAiQ29uc2lkZXIgYWRkaW5nIGFuIGVycm9yIGJvdW5kYXJ5IHRvIHlvdXIgdHJlZSB0byBjdXN0b21pemUgZXJyb3IgaGFuZGxpbmcgYmVoYXZpb3IuXG5WaXNpdCBodHRwczovL3JlYWN0anMub3JnL2xpbmsvZXJyb3ItYm91bmRhcmllcyB0byBsZWFybiBtb3JlIGFib3V0IGVycm9yIGJvdW5kYXJpZXMuIjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciBlcnJvckJvdW5kYXJ5TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoYm91bmRhcnkpIHx8ICJBbm9ueW1vdXMiOwogICAgICAgICAgICAgICAgICBlcnJvckJvdW5kYXJ5TWVzc2FnZSA9ICJSZWFjdCB3aWxsIHRyeSB0byByZWNyZWF0ZSB0aGlzIGNvbXBvbmVudCB0cmVlIGZyb20gc2NyYXRjaCAiICsgKCJ1c2luZyB0aGUgZXJyb3IgYm91bmRhcnkgeW91IHByb3ZpZGVkLCAiICsgZXJyb3JCb3VuZGFyeU5hbWUgKyAiLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGNvbWJpbmVkTWVzc2FnZSA9IGNvbXBvbmVudE5hbWVNZXNzYWdlICsgIlxuIiArIGNvbXBvbmVudFN0YWNrICsgIlxuXG4iICsgKCIiICsgZXJyb3JCb3VuZGFyeU1lc3NhZ2UpOwogICAgICAgICAgICAgICAgY29uc29sZVsiZXJyb3IiXShjb21iaW5lZE1lc3NhZ2UpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zb2xlWyJlcnJvciJdKGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBQb3NzaWJseVdlYWtNYXAkMSA9IHR5cGVvZiBXZWFrTWFwID09PSAiZnVuY3Rpb24iID8gV2Vha01hcCA6IE1hcDsKICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVJvb3RFcnJvclVwZGF0ZShmaWJlciwgZXJyb3JJbmZvLCBsYW5lKSB7CiAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoTm9UaW1lc3RhbXAsIGxhbmUpOwogICAgICAgICAgICB1cGRhdGUudGFnID0gQ2FwdHVyZVVwZGF0ZTsKICAgICAgICAgICAgdXBkYXRlLnBheWxvYWQgPSB7CiAgICAgICAgICAgICAgZWxlbWVudDogbnVsbAogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgZXJyb3IyID0gZXJyb3JJbmZvLnZhbHVlOwogICAgICAgICAgICB1cGRhdGUuY2FsbGJhY2sgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBvblVuY2F1Z2h0RXJyb3IoZXJyb3IyKTsKICAgICAgICAgICAgICBsb2dDYXB0dXJlZEVycm9yKGZpYmVyLCBlcnJvckluZm8pOwogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4gdXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ2xhc3NFcnJvclVwZGF0ZShmaWJlciwgZXJyb3JJbmZvLCBsYW5lKSB7CiAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoTm9UaW1lc3RhbXAsIGxhbmUpOwogICAgICAgICAgICB1cGRhdGUudGFnID0gQ2FwdHVyZVVwZGF0ZTsKICAgICAgICAgICAgdmFyIGdldERlcml2ZWRTdGF0ZUZyb21FcnJvciA9IGZpYmVyLnR5cGUuZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yOwogICAgICAgICAgICBpZiAodHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21FcnJvciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBlcnJvciQxID0gZXJyb3JJbmZvLnZhbHVlOwogICAgICAgICAgICAgIHVwZGF0ZS5wYXlsb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yKGVycm9yJDEpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIG1hcmtGYWlsZWRFcnJvckJvdW5kYXJ5Rm9ySG90UmVsb2FkaW5nKGZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxvZ0NhcHR1cmVkRXJyb3IoZmliZXIsIGVycm9ySW5mbyk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW5zdCA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgaWYgKGluc3QgIT09IG51bGwgJiYgdHlwZW9mIGluc3QuY29tcG9uZW50RGlkQ2F0Y2ggPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB1cGRhdGUuY2FsbGJhY2sgPSBmdW5jdGlvbiBjYWxsYmFjaygpIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgbWFya0ZhaWxlZEVycm9yQm91bmRhcnlGb3JIb3RSZWxvYWRpbmcoZmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbG9nQ2FwdHVyZWRFcnJvcihmaWJlciwgZXJyb3JJbmZvKTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIG1hcmtMZWdhY3lFcnJvckJvdW5kYXJ5QXNGYWlsZWQodGhpcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IkMTIgPSBlcnJvckluZm8udmFsdWU7CiAgICAgICAgICAgICAgICB2YXIgc3RhY2sgPSBlcnJvckluZm8uc3RhY2s7CiAgICAgICAgICAgICAgICB0aGlzLmNvbXBvbmVudERpZENhdGNoKGVycm9yJDEyLCB7CiAgICAgICAgICAgICAgICAgIGNvbXBvbmVudFN0YWNrOiBzdGFjayAhPT0gbnVsbCA/IHN0YWNrIDogIiIKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21FcnJvciAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIGlmICghaW5jbHVkZXNTb21lTGFuZShmaWJlci5sYW5lcywgU3luY0xhbmUpKSB7CiAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiJXM6IEVycm9yIGJvdW5kYXJpZXMgc2hvdWxkIGltcGxlbWVudCBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IoKS4gSW4gdGhhdCBtZXRob2QsIHJldHVybiBhIHN0YXRlIHVwZGF0ZSB0byBkaXNwbGF5IGFuIGVycm9yIG1lc3NhZ2Ugb3IgZmFsbGJhY2sgVUkuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB1cGRhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBhdHRhY2hQaW5nTGlzdGVuZXIocm9vdDMsIHdha2VhYmxlLCBsYW5lcykgewogICAgICAgICAgICB2YXIgcGluZ0NhY2hlID0gcm9vdDMucGluZ0NhY2hlOwogICAgICAgICAgICB2YXIgdGhyZWFkSURzOwogICAgICAgICAgICBpZiAocGluZ0NhY2hlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcGluZ0NhY2hlID0gcm9vdDMucGluZ0NhY2hlID0gbmV3IFBvc3NpYmx5V2Vha01hcCQxKCk7CiAgICAgICAgICAgICAgdGhyZWFkSURzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgICBwaW5nQ2FjaGUuc2V0KHdha2VhYmxlLCB0aHJlYWRJRHMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRocmVhZElEcyA9IHBpbmdDYWNoZS5nZXQod2FrZWFibGUpOwogICAgICAgICAgICAgIGlmICh0aHJlYWRJRHMgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgdGhyZWFkSURzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgICAgIHBpbmdDYWNoZS5zZXQod2FrZWFibGUsIHRocmVhZElEcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghdGhyZWFkSURzLmhhcyhsYW5lcykpIHsKICAgICAgICAgICAgICB0aHJlYWRJRHMuYWRkKGxhbmVzKTsKICAgICAgICAgICAgICB2YXIgcGluZyA9IHBpbmdTdXNwZW5kZWRSb290LmJpbmQobnVsbCwgcm9vdDMsIHdha2VhYmxlLCBsYW5lcyk7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgICAgIHJlc3RvcmVQZW5kaW5nVXBkYXRlcnMocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2FrZWFibGUudGhlbihwaW5nLCBwaW5nKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gYXR0YWNoUmV0cnlMaXN0ZW5lcihzdXNwZW5zZUJvdW5kYXJ5LCByb290Mywgd2FrZWFibGUsIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciB3YWtlYWJsZXMgPSBzdXNwZW5zZUJvdW5kYXJ5LnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICBpZiAod2FrZWFibGVzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgICB1cGRhdGVRdWV1ZS5hZGQod2FrZWFibGUpOwogICAgICAgICAgICAgIHN1c3BlbnNlQm91bmRhcnkudXBkYXRlUXVldWUgPSB1cGRhdGVRdWV1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB3YWtlYWJsZXMuYWRkKHdha2VhYmxlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVzZXRTdXNwZW5kZWRDb21wb25lbnQoc291cmNlRmliZXIsIHJvb3RSZW5kZXJMYW5lcykgewogICAgICAgICAgICB2YXIgdGFnID0gc291cmNlRmliZXIudGFnOwogICAgICAgICAgICBpZiAoKHNvdXJjZUZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSAmJiAodGFnID09PSBGdW5jdGlvbkNvbXBvbmVudCB8fCB0YWcgPT09IEZvcndhcmRSZWYgfHwgdGFnID09PSBTaW1wbGVNZW1vQ29tcG9uZW50KSkgewogICAgICAgICAgICAgIHZhciBjdXJyZW50U291cmNlID0gc291cmNlRmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIGlmIChjdXJyZW50U291cmNlKSB7CiAgICAgICAgICAgICAgICBzb3VyY2VGaWJlci51cGRhdGVRdWV1ZSA9IGN1cnJlbnRTb3VyY2UudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgICBzb3VyY2VGaWJlci5tZW1vaXplZFN0YXRlID0gY3VycmVudFNvdXJjZS5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgc291cmNlRmliZXIubGFuZXMgPSBjdXJyZW50U291cmNlLmxhbmVzOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzb3VyY2VGaWJlci51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgICBzb3VyY2VGaWJlci5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldE5lYXJlc3RTdXNwZW5zZUJvdW5kYXJ5VG9DYXB0dXJlKHJldHVybkZpYmVyKSB7CiAgICAgICAgICAgIHZhciBub2RlID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICBpZiAobm9kZS50YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50ICYmIHNob3VsZENhcHR1cmVTdXNwZW5zZShub2RlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfSB3aGlsZSAobm9kZSAhPT0gbnVsbCk7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbWFya1N1c3BlbnNlQm91bmRhcnlTaG91bGRDYXB0dXJlKHN1c3BlbnNlQm91bmRhcnksIHJldHVybkZpYmVyLCBzb3VyY2VGaWJlciwgcm9vdDMsIHJvb3RSZW5kZXJMYW5lcykgewogICAgICAgICAgICBpZiAoKHN1c3BlbnNlQm91bmRhcnkubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlQm91bmRhcnkgPT09IHJldHVybkZpYmVyKSB7CiAgICAgICAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LmZsYWdzIHw9IFNob3VsZENhcHR1cmU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN1c3BlbnNlQm91bmRhcnkuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICAgIHNvdXJjZUZpYmVyLmZsYWdzIHw9IEZvcmNlVXBkYXRlRm9yTGVnYWN5U3VzcGVuc2U7CiAgICAgICAgICAgICAgICBzb3VyY2VGaWJlci5mbGFncyAmPSB+KExpZmVjeWNsZUVmZmVjdE1hc2sgfCBJbmNvbXBsZXRlKTsKICAgICAgICAgICAgICAgIGlmIChzb3VyY2VGaWJlci50YWcgPT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50U291cmNlRmliZXIgPSBzb3VyY2VGaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50U291cmNlRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBzb3VyY2VGaWJlci50YWcgPSBJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQ7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShOb1RpbWVzdGFtcCwgU3luY0xhbmUpOwogICAgICAgICAgICAgICAgICAgIHVwZGF0ZS50YWcgPSBGb3JjZVVwZGF0ZTsKICAgICAgICAgICAgICAgICAgICBlbnF1ZXVlVXBkYXRlKHNvdXJjZUZpYmVyLCB1cGRhdGUsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc291cmNlRmliZXIubGFuZXMgPSBtZXJnZUxhbmVzKHNvdXJjZUZpYmVyLmxhbmVzLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBzdXNwZW5zZUJvdW5kYXJ5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN1c3BlbnNlQm91bmRhcnkuZmxhZ3MgfD0gU2hvdWxkQ2FwdHVyZTsKICAgICAgICAgICAgc3VzcGVuc2VCb3VuZGFyeS5sYW5lcyA9IHJvb3RSZW5kZXJMYW5lczsKICAgICAgICAgICAgcmV0dXJuIHN1c3BlbnNlQm91bmRhcnk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB0aHJvd0V4Y2VwdGlvbihyb290MywgcmV0dXJuRmliZXIsIHNvdXJjZUZpYmVyLCB2YWx1ZSwgcm9vdFJlbmRlckxhbmVzKSB7CiAgICAgICAgICAgIHNvdXJjZUZpYmVyLmZsYWdzIHw9IEluY29tcGxldGU7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICAgIHJlc3RvcmVQZW5kaW5nVXBkYXRlcnMocm9vdDMsIHJvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIHR5cGVvZiB2YWx1ZS50aGVuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIHdha2VhYmxlID0gdmFsdWU7CiAgICAgICAgICAgICAgcmVzZXRTdXNwZW5kZWRDb21wb25lbnQoc291cmNlRmliZXIpOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpICYmIHNvdXJjZUZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgICAgICAgICBtYXJrRGlkVGhyb3dXaGlsZUh5ZHJhdGluZ0RFVigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VCb3VuZGFyeSA9IGdldE5lYXJlc3RTdXNwZW5zZUJvdW5kYXJ5VG9DYXB0dXJlKHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICBpZiAoc3VzcGVuc2VCb3VuZGFyeSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc3VzcGVuc2VCb3VuZGFyeS5mbGFncyAmPSB+Rm9yY2VDbGllbnRSZW5kZXI7CiAgICAgICAgICAgICAgICBtYXJrU3VzcGVuc2VCb3VuZGFyeVNob3VsZENhcHR1cmUoc3VzcGVuc2VCb3VuZGFyeSwgcmV0dXJuRmliZXIsIHNvdXJjZUZpYmVyLCByb290Mywgcm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgIGlmIChzdXNwZW5zZUJvdW5kYXJ5Lm1vZGUgJiBDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgICAgICAgICBhdHRhY2hQaW5nTGlzdGVuZXIocm9vdDMsIHdha2VhYmxlLCByb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYXR0YWNoUmV0cnlMaXN0ZW5lcihzdXNwZW5zZUJvdW5kYXJ5LCByb290Mywgd2FrZWFibGUpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoIWluY2x1ZGVzU3luY0xhbmUocm9vdFJlbmRlckxhbmVzKSkgewogICAgICAgICAgICAgICAgICBhdHRhY2hQaW5nTGlzdGVuZXIocm9vdDMsIHdha2VhYmxlLCByb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgICByZW5kZXJEaWRTdXNwZW5kRGVsYXlJZlBvc3NpYmxlKCk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciB1bmNhdWdodFN1c3BlbnNlRXJyb3IgPSBuZXcgRXJyb3IoIkEgY29tcG9uZW50IHN1c3BlbmRlZCB3aGlsZSByZXNwb25kaW5nIHRvIHN5bmNocm9ub3VzIGlucHV0LiBUaGlzIHdpbGwgY2F1c2UgdGhlIFVJIHRvIGJlIHJlcGxhY2VkIHdpdGggYSBsb2FkaW5nIGluZGljYXRvci4gVG8gZml4LCB1cGRhdGVzIHRoYXQgc3VzcGVuZCBzaG91bGQgYmUgd3JhcHBlZCB3aXRoIHN0YXJ0VHJhbnNpdGlvbi4iKTsKICAgICAgICAgICAgICAgIHZhbHVlID0gdW5jYXVnaHRTdXNwZW5zZUVycm9yOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBzb3VyY2VGaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgICAgICAgIG1hcmtEaWRUaHJvd1doaWxlSHlkcmF0aW5nREVWKCk7CiAgICAgICAgICAgICAgICB2YXIgX3N1c3BlbnNlQm91bmRhcnkgPSBnZXROZWFyZXN0U3VzcGVuc2VCb3VuZGFyeVRvQ2FwdHVyZShyZXR1cm5GaWJlcik7CiAgICAgICAgICAgICAgICBpZiAoX3N1c3BlbnNlQm91bmRhcnkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgaWYgKChfc3VzcGVuc2VCb3VuZGFyeS5mbGFncyAmIFNob3VsZENhcHR1cmUpID09PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICAgICAgX3N1c3BlbnNlQm91bmRhcnkuZmxhZ3MgfD0gRm9yY2VDbGllbnRSZW5kZXI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgbWFya1N1c3BlbnNlQm91bmRhcnlTaG91bGRDYXB0dXJlKF9zdXNwZW5zZUJvdW5kYXJ5LCByZXR1cm5GaWJlciwgc291cmNlRmliZXIsIHJvb3QzLCByb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgICBxdWV1ZUh5ZHJhdGlvbkVycm9yKGNyZWF0ZUNhcHR1cmVkVmFsdWVBdEZpYmVyKHZhbHVlLCBzb3VyY2VGaWJlcikpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhbHVlID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIodmFsdWUsIHNvdXJjZUZpYmVyKTsKICAgICAgICAgICAgcmVuZGVyRGlkRXJyb3IodmFsdWUpOwogICAgICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3MyID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICBzd2l0Y2ggKHdvcmtJblByb2dyZXNzMi50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICAgICAgdmFyIF9lcnJvckluZm8gPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFNob3VsZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgIHZhciBsYW5lID0gcGlja0FyYml0cmFyeUxhbmUocm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gbWVyZ2VMYW5lcyh3b3JrSW5Qcm9ncmVzczIubGFuZXMsIGxhbmUpOwogICAgICAgICAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlUm9vdEVycm9yVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgX2Vycm9ySW5mbywgbGFuZSk7CiAgICAgICAgICAgICAgICAgIGVucXVldWVDYXB0dXJlZFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIHVwZGF0ZSk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgICAgIHZhciBlcnJvckluZm8gPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgdmFyIGN0b3IgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSA9PT0gTm9GbGFncyAmJiAodHlwZW9mIGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yID09PSAiZnVuY3Rpb24iIHx8IGluc3RhbmNlICE9PSBudWxsICYmIHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRDYXRjaCA9PT0gImZ1bmN0aW9uIiAmJiAhaXNBbHJlYWR5RmFpbGVkTGVnYWN5RXJyb3JCb3VuZGFyeShpbnN0YW5jZSkpKSB7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFNob3VsZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9sYW5lID0gcGlja0FyYml0cmFyeUxhbmUocm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBtZXJnZUxhbmVzKHdvcmtJblByb2dyZXNzMi5sYW5lcywgX2xhbmUpOwogICAgICAgICAgICAgICAgICAgIHZhciBfdXBkYXRlID0gY3JlYXRlQ2xhc3NFcnJvclVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIGVycm9ySW5mbywgX2xhbmUpOwogICAgICAgICAgICAgICAgICAgIGVucXVldWVDYXB0dXJlZFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIF91cGRhdGUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyID0gd29ya0luUHJvZ3Jlc3MyLnJldHVybjsKICAgICAgICAgICAgfSB3aGlsZSAod29ya0luUHJvZ3Jlc3MyICE9PSBudWxsKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldFN1c3BlbmRlZENhY2hlKCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBSZWFjdEN1cnJlbnRPd25lciQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50T3duZXI7CiAgICAgICAgICB2YXIgZGlkUmVjZWl2ZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgdmFyIGRpZFdhcm5BYm91dEJhZENsYXNzOwogICAgICAgICAgdmFyIGRpZFdhcm5BYm91dE1vZHVsZVBhdHRlcm5Db21wb25lbnQ7CiAgICAgICAgICB2YXIgZGlkV2FybkFib3V0Q29udGV4dFR5cGVPbkZ1bmN0aW9uQ29tcG9uZW50OwogICAgICAgICAgdmFyIGRpZFdhcm5BYm91dEdldERlcml2ZWRTdGF0ZU9uRnVuY3Rpb25Db21wb25lbnQ7CiAgICAgICAgICB2YXIgZGlkV2FybkFib3V0RnVuY3Rpb25SZWZzOwogICAgICAgICAgdmFyIGRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHM7CiAgICAgICAgICB2YXIgZGlkV2FybkFib3V0UmV2ZWFsT3JkZXI7CiAgICAgICAgICB2YXIgZGlkV2FybkFib3V0VGFpbE9wdGlvbnM7CiAgICAgICAgICB7CiAgICAgICAgICAgIGRpZFdhcm5BYm91dEJhZENsYXNzID0ge307CiAgICAgICAgICAgIGRpZFdhcm5BYm91dE1vZHVsZVBhdHRlcm5Db21wb25lbnQgPSB7fTsKICAgICAgICAgICAgZGlkV2FybkFib3V0Q29udGV4dFR5cGVPbkZ1bmN0aW9uQ29tcG9uZW50ID0ge307CiAgICAgICAgICAgIGRpZFdhcm5BYm91dEdldERlcml2ZWRTdGF0ZU9uRnVuY3Rpb25Db21wb25lbnQgPSB7fTsKICAgICAgICAgICAgZGlkV2FybkFib3V0RnVuY3Rpb25SZWZzID0ge307CiAgICAgICAgICAgIGRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMgPSBmYWxzZTsKICAgICAgICAgICAgZGlkV2FybkFib3V0UmV2ZWFsT3JkZXIgPSB7fTsKICAgICAgICAgICAgZGlkV2FybkFib3V0VGFpbE9wdGlvbnMgPSB7fTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50MiA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IG1vdW50Q2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBudWxsLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBjdXJyZW50Mi5jaGlsZCwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBmb3JjZVVubW91bnRDdXJyZW50QW5kUmVjb25jaWxlKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgY3VycmVudDIuY2hpbGQsIG51bGwsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgbnVsbCwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlRm9yd2FyZFJlZihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnR5cGUgIT09IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSkgewogICAgICAgICAgICAgICAgdmFyIGlubmVyUHJvcFR5cGVzID0gQ29tcG9uZW50LnByb3BUeXBlczsKICAgICAgICAgICAgICAgIGlmIChpbm5lclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgICAgICBpbm5lclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAgICAgLy8gUmVzb2x2ZWQgcHJvcHMKICAgICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJlbmRlcjIgPSBDb21wb25lbnQucmVuZGVyOwogICAgICAgICAgICB2YXIgcmVmID0gd29ya0luUHJvZ3Jlc3MyLnJlZjsKICAgICAgICAgICAgdmFyIG5leHRDaGlsZHJlbjsKICAgICAgICAgICAgdmFyIGhhc0lkOwogICAgICAgICAgICBwcmVwYXJlVG9SZWFkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQxLmN1cnJlbnQgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcodHJ1ZSk7CiAgICAgICAgICAgICAgbmV4dENoaWxkcmVuID0gcmVuZGVyV2l0aEhvb2tzKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlcjIsIG5leHRQcm9wcywgcmVmLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIGhhc0lkID0gY2hlY2tEaWRSZW5kZXJJZEhvb2soKTsKICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IHJlbmRlcldpdGhIb29rcyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXIyLCBuZXh0UHJvcHMsIHJlZiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgICAgaGFzSWQgPSBjaGVja0RpZFJlbmRlcklkSG9vaygpOwogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzZXRJc1JlbmRlcmluZyhmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsICYmICFkaWRSZWNlaXZlVXBkYXRlKSB7CiAgICAgICAgICAgICAgYmFpbG91dEhvb2tzKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgcmV0dXJuIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBoYXNJZCkgewogICAgICAgICAgICAgIHB1c2hNYXRlcmlhbGl6ZWRUcmVlSWQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGVyZm9ybWVkV29yazsKICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlTWVtb0NvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50MiA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciB0eXBlMiA9IENvbXBvbmVudC50eXBlOwogICAgICAgICAgICAgIGlmIChpc1NpbXBsZUZ1bmN0aW9uQ29tcG9uZW50KHR5cGUyKSAmJiBDb21wb25lbnQuY29tcGFyZSA9PT0gbnVsbCAmJiAvLyBTaW1wbGVNZW1vQ29tcG9uZW50IGNvZGVwYXRoIGRvZXNuJ3QgcmVzb2x2ZSBvdXRlciBwcm9wcyBlaXRoZXIuCiAgICAgICAgICAgICAgQ29tcG9uZW50LmRlZmF1bHRQcm9wcyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVzb2x2ZWRUeXBlID0gdHlwZTI7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHJlc29sdmVkVHlwZSA9IHJlc29sdmVGdW5jdGlvbkZvckhvdFJlbG9hZGluZyh0eXBlMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudGFnID0gU2ltcGxlTWVtb0NvbXBvbmVudDsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gcmVzb2x2ZWRUeXBlOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICB2YWxpZGF0ZUZ1bmN0aW9uQ29tcG9uZW50SW5EZXYod29ya0luUHJvZ3Jlc3MyLCB0eXBlMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU2ltcGxlTWVtb0NvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZXNvbHZlZFR5cGUsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGlubmVyUHJvcFR5cGVzID0gdHlwZTIucHJvcFR5cGVzOwogICAgICAgICAgICAgICAgaWYgKGlubmVyUHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICAgIGlubmVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICAgIG5leHRQcm9wcywKICAgICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBwcm9wcwogICAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgICBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZTIpCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBjaGlsZCA9IGNyZWF0ZUZpYmVyRnJvbVR5cGVBbmRQcm9wcyhDb21wb25lbnQudHlwZSwgbnVsbCwgbmV4dFByb3BzLCB3b3JrSW5Qcm9ncmVzczIsIHdvcmtJblByb2dyZXNzMi5tb2RlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIGNoaWxkLnJlZiA9IHdvcmtJblByb2dyZXNzMi5yZWY7CiAgICAgICAgICAgICAgY2hpbGQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IGNoaWxkOwogICAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIF90eXBlID0gQ29tcG9uZW50LnR5cGU7CiAgICAgICAgICAgICAgdmFyIF9pbm5lclByb3BUeXBlcyA9IF90eXBlLnByb3BUeXBlczsKICAgICAgICAgICAgICBpZiAoX2lubmVyUHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgICAgX2lubmVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIHByb3BzCiAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKF90eXBlKQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGN1cnJlbnRDaGlsZCA9IGN1cnJlbnQyLmNoaWxkOwogICAgICAgICAgICB2YXIgaGFzU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0ID0gY2hlY2tTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQoY3VycmVudDIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGlmICghaGFzU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0KSB7CiAgICAgICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGN1cnJlbnRDaGlsZC5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgIHZhciBjb21wYXJlID0gQ29tcG9uZW50LmNvbXBhcmU7CiAgICAgICAgICAgICAgY29tcGFyZSA9IGNvbXBhcmUgIT09IG51bGwgPyBjb21wYXJlIDogc2hhbGxvd0VxdWFsOwogICAgICAgICAgICAgIGlmIChjb21wYXJlKHByZXZQcm9wcywgbmV4dFByb3BzKSAmJiBjdXJyZW50Mi5yZWYgPT09IHdvcmtJblByb2dyZXNzMi5yZWYpIHsKICAgICAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQZXJmb3JtZWRXb3JrOwogICAgICAgICAgICB2YXIgbmV3Q2hpbGQgPSBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50Q2hpbGQsIG5leHRQcm9wcyk7CiAgICAgICAgICAgIG5ld0NoaWxkLnJlZiA9IHdvcmtJblByb2dyZXNzMi5yZWY7CiAgICAgICAgICAgIG5ld0NoaWxkLnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gbmV3Q2hpbGQ7CiAgICAgICAgICAgIHJldHVybiBuZXdDaGlsZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVNpbXBsZU1lbW9Db21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUpIHsKICAgICAgICAgICAgICAgIHZhciBvdXRlck1lbW9UeXBlID0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlOwogICAgICAgICAgICAgICAgaWYgKG91dGVyTWVtb1R5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0xBWllfVFlQRSkgewogICAgICAgICAgICAgICAgICB2YXIgbGF6eUNvbXBvbmVudCA9IG91dGVyTWVtb1R5cGU7CiAgICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgICAgdmFyIGluaXQyID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBvdXRlck1lbW9UeXBlID0gaW5pdDIocGF5bG9hZCk7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgICAgb3V0ZXJNZW1vVHlwZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIG91dGVyUHJvcFR5cGVzID0gb3V0ZXJNZW1vVHlwZSAmJiBvdXRlck1lbW9UeXBlLnByb3BUeXBlczsKICAgICAgICAgICAgICAgICAgaWYgKG91dGVyUHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgICAgICBvdXRlclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgICAgIG5leHRQcm9wcywKICAgICAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIChTaW1wbGVNZW1vQ29tcG9uZW50IGhhcyBubyBkZWZhdWx0UHJvcHMpCiAgICAgICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgICAgICBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUob3V0ZXJNZW1vVHlwZSkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBwcmV2UHJvcHMgPSBjdXJyZW50Mi5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgIGlmIChzaGFsbG93RXF1YWwocHJldlByb3BzLCBuZXh0UHJvcHMpICYmIGN1cnJlbnQyLnJlZiA9PT0gd29ya0luUHJvZ3Jlc3MyLnJlZiAmJiAvLyBQcmV2ZW50IGJhaWxvdXQgaWYgdGhlIGltcGxlbWVudGF0aW9uIGNoYW5nZWQgZHVlIHRvIGhvdCByZWxvYWQuCiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPT09IGN1cnJlbnQyLnR5cGUpIHsKICAgICAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHMgPSBuZXh0UHJvcHMgPSBwcmV2UHJvcHM7CiAgICAgICAgICAgICAgICBpZiAoIWNoZWNrU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0KGN1cnJlbnQyLCByZW5kZXJMYW5lczIpKSB7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IGN1cnJlbnQyLmxhbmVzOwogICAgICAgICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoY3VycmVudDIuZmxhZ3MgJiBGb3JjZVVwZGF0ZUZvckxlZ2FjeVN1c3BlbnNlKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgICBkaWRSZWNlaXZlVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZ1bmN0aW9uQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlT2Zmc2NyZWVuQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgdmFyIG5leHRDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IGN1cnJlbnQyICE9PSBudWxsID8gY3VycmVudDIubWVtb2l6ZWRTdGF0ZSA6IG51bGw7CiAgICAgICAgICAgIGlmIChuZXh0UHJvcHMubW9kZSA9PT0gImhpZGRlbiIgfHwgZW5hYmxlTGVnYWN5SGlkZGVuKSB7CiAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICB2YXIgbmV4dFN0YXRlID0gewogICAgICAgICAgICAgICAgICBiYXNlTGFuZXM6IE5vTGFuZXMsCiAgICAgICAgICAgICAgICAgIGNhY2hlUG9vbDogbnVsbCwKICAgICAgICAgICAgICAgICAgdHJhbnNpdGlvbnM6IG51bGwKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG5leHRTdGF0ZTsKICAgICAgICAgICAgICAgIHB1c2hSZW5kZXJMYW5lcyh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICghaW5jbHVkZXNTb21lTGFuZShyZW5kZXJMYW5lczIsIE9mZnNjcmVlbkxhbmUpKSB7CiAgICAgICAgICAgICAgICB2YXIgc3Bhd25lZENhY2hlUG9vbCA9IG51bGw7CiAgICAgICAgICAgICAgICB2YXIgbmV4dEJhc2VMYW5lczsKICAgICAgICAgICAgICAgIGlmIChwcmV2U3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIHByZXZCYXNlTGFuZXMgPSBwcmV2U3RhdGUuYmFzZUxhbmVzOwogICAgICAgICAgICAgICAgICBuZXh0QmFzZUxhbmVzID0gbWVyZ2VMYW5lcyhwcmV2QmFzZUxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgbmV4dEJhc2VMYW5lcyA9IHJlbmRlckxhbmVzMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzID0gbGFuZVRvTGFuZXMoT2Zmc2NyZWVuTGFuZSk7CiAgICAgICAgICAgICAgICB2YXIgX25leHRTdGF0ZSA9IHsKICAgICAgICAgICAgICAgICAgYmFzZUxhbmVzOiBuZXh0QmFzZUxhbmVzLAogICAgICAgICAgICAgICAgICBjYWNoZVBvb2w6IHNwYXduZWRDYWNoZVBvb2wsCiAgICAgICAgICAgICAgICAgIHRyYW5zaXRpb25zOiBudWxsCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBfbmV4dFN0YXRlOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgICAgIHB1c2hSZW5kZXJMYW5lcyh3b3JrSW5Qcm9ncmVzczIsIG5leHRCYXNlTGFuZXMpOwogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBfbmV4dFN0YXRlMiA9IHsKICAgICAgICAgICAgICAgICAgYmFzZUxhbmVzOiBOb0xhbmVzLAogICAgICAgICAgICAgICAgICBjYWNoZVBvb2w6IG51bGwsCiAgICAgICAgICAgICAgICAgIHRyYW5zaXRpb25zOiBudWxsCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBfbmV4dFN0YXRlMjsKICAgICAgICAgICAgICAgIHZhciBzdWJ0cmVlUmVuZGVyTGFuZXMyID0gcHJldlN0YXRlICE9PSBudWxsID8gcHJldlN0YXRlLmJhc2VMYW5lcyA6IHJlbmRlckxhbmVzMjsKICAgICAgICAgICAgICAgIHB1c2hSZW5kZXJMYW5lcyh3b3JrSW5Qcm9ncmVzczIsIHN1YnRyZWVSZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX3N1YnRyZWVSZW5kZXJMYW5lczsKICAgICAgICAgICAgICBpZiAocHJldlN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBfc3VidHJlZVJlbmRlckxhbmVzID0gbWVyZ2VMYW5lcyhwcmV2U3RhdGUuYmFzZUxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBfc3VidHJlZVJlbmRlckxhbmVzID0gcmVuZGVyTGFuZXMyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwdXNoUmVuZGVyTGFuZXMod29ya0luUHJvZ3Jlc3MyLCBfc3VidHJlZVJlbmRlckxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVGcmFnbWVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgICAgdmFyIG5leHRDaGlsZHJlbiA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU1vZGUoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzLmNoaWxkcmVuOwogICAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVQcm9maWxlcihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBzdGF0ZU5vZGUuZWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgICAgICAgc3RhdGVOb2RlLnBhc3NpdmVFZmZlY3REdXJhdGlvbiA9IDA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBuZXh0UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtYXJrUmVmKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgICAgdmFyIHJlZiA9IHdvcmtJblByb2dyZXNzMi5yZWY7CiAgICAgICAgICAgIGlmIChjdXJyZW50MiA9PT0gbnVsbCAmJiByZWYgIT09IG51bGwgfHwgY3VycmVudDIgIT09IG51bGwgJiYgY3VycmVudDIucmVmICE9PSByZWYpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUmVmOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBSZWZTdGF0aWM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVGdW5jdGlvbkNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnR5cGUgIT09IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSkgewogICAgICAgICAgICAgICAgdmFyIGlubmVyUHJvcFR5cGVzID0gQ29tcG9uZW50LnByb3BUeXBlczsKICAgICAgICAgICAgICAgIGlmIChpbm5lclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgICAgICBpbm5lclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAgICAgLy8gUmVzb2x2ZWQgcHJvcHMKICAgICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNvbnRleHQ7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgdW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCB0cnVlKTsKICAgICAgICAgICAgICBjb250ZXh0ID0gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5leHRDaGlsZHJlbjsKICAgICAgICAgICAgdmFyIGhhc0lkOwogICAgICAgICAgICBwcmVwYXJlVG9SZWFkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQxLmN1cnJlbnQgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcodHJ1ZSk7CiAgICAgICAgICAgICAgbmV4dENoaWxkcmVuID0gcmVuZGVyV2l0aEhvb2tzKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCBjb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIGhhc0lkID0gY2hlY2tEaWRSZW5kZXJJZEhvb2soKTsKICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IHJlbmRlcldpdGhIb29rcyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgY29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgICAgaGFzSWQgPSBjaGVja0RpZFJlbmRlcklkSG9vaygpOwogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzZXRJc1JlbmRlcmluZyhmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsICYmICFkaWRSZWNlaXZlVXBkYXRlKSB7CiAgICAgICAgICAgICAgYmFpbG91dEhvb2tzKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgcmV0dXJuIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBoYXNJZCkgewogICAgICAgICAgICAgIHB1c2hNYXRlcmlhbGl6ZWRUcmVlSWQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGVyZm9ybWVkV29yazsKICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ2xhc3NDb21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc3dpdGNoIChzaG91bGRFcnJvcih3b3JrSW5Qcm9ncmVzczIpKSB7CiAgICAgICAgICAgICAgICBjYXNlIGZhbHNlOiB7CiAgICAgICAgICAgICAgICAgIHZhciBfaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICB2YXIgY3RvciA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgICAgICB2YXIgdGVtcEluc3RhbmNlID0gbmV3IGN0b3Iod29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMsIF9pbnN0YW5jZS5jb250ZXh0KTsKICAgICAgICAgICAgICAgICAgdmFyIHN0YXRlID0gdGVtcEluc3RhbmNlLnN0YXRlOwogICAgICAgICAgICAgICAgICBfaW5zdGFuY2UudXBkYXRlci5lbnF1ZXVlU2V0U3RhdGUoX2luc3RhbmNlLCBzdGF0ZSwgbnVsbCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSB0cnVlOiB7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU2hvdWxkQ2FwdHVyZTsKICAgICAgICAgICAgICAgICAgdmFyIGVycm9yJDEgPSBuZXcgRXJyb3IoIlNpbXVsYXRlZCBlcnJvciBjb21pbmcgZnJvbSBEZXZUb29scyIpOwogICAgICAgICAgICAgICAgICB2YXIgbGFuZSA9IHBpY2tBcmJpdHJhcnlMYW5lKHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IG1lcmdlTGFuZXMod29ya0luUHJvZ3Jlc3MyLmxhbmVzLCBsYW5lKTsKICAgICAgICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZUNsYXNzRXJyb3JVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBjcmVhdGVDYXB0dXJlZFZhbHVlQXRGaWJlcihlcnJvciQxLCB3b3JrSW5Qcm9ncmVzczIpLCBsYW5lKTsKICAgICAgICAgICAgICAgICAgZW5xdWV1ZUNhcHR1cmVkVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgdXBkYXRlKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgICB2YXIgaW5uZXJQcm9wVHlwZXMgPSBDb21wb25lbnQucHJvcFR5cGVzOwogICAgICAgICAgICAgICAgaWYgKGlubmVyUHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICAgIGlubmVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICAgIG5leHRQcm9wcywKICAgICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBwcm9wcwogICAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgICBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KQogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaGFzQ29udGV4dDsKICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICBoYXNDb250ZXh0ID0gdHJ1ZTsKICAgICAgICAgICAgICBwdXNoQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaGFzQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHByZXBhcmVUb1JlYWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgdmFyIHNob3VsZFVwZGF0ZTsKICAgICAgICAgICAgaWYgKGluc3RhbmNlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmVzZXRTdXNwZW5kZWRDdXJyZW50T25Nb3VudEluTGVnYWN5TW9kZShjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBjb25zdHJ1Y3RDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMpOwogICAgICAgICAgICAgIG1vdW50Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY3VycmVudDIgPT09IG51bGwpIHsKICAgICAgICAgICAgICBzaG91bGRVcGRhdGUgPSByZXN1bWVNb3VudENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzaG91bGRVcGRhdGUgPSB1cGRhdGVDbGFzc0luc3RhbmNlKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBuZXh0VW5pdE9mV29yayA9IGZpbmlzaENsYXNzQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgc2hvdWxkVXBkYXRlLCBoYXNDb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIGluc3QgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUgJiYgaW5zdC5wcm9wcyAhPT0gbmV4dFByb3BzKSB7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIkl0IGxvb2tzIGxpa2UgJXMgaXMgcmVhc3NpZ25pbmcgaXRzIG93biBgdGhpcy5wcm9wc2Agd2hpbGUgcmVuZGVyaW5nLiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQgYW5kIGNhbiBsZWFkIHRvIGNvbmZ1c2luZyBidWdzLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIod29ya0luUHJvZ3Jlc3MyKSB8fCAiYSBjb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV4dFVuaXRPZldvcms7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBmaW5pc2hDbGFzc0NvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHNob3VsZFVwZGF0ZSwgaGFzQ29udGV4dCwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICAgIG1hcmtSZWYoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIHZhciBkaWRDYXB0dXJlRXJyb3IgPSAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICAgIGlmICghc2hvdWxkVXBkYXRlICYmICFkaWRDYXB0dXJlRXJyb3IpIHsKICAgICAgICAgICAgICBpZiAoaGFzQ29udGV4dCkgewogICAgICAgICAgICAgICAgaW52YWxpZGF0ZUNvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgZmFsc2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgdmFyIG5leHRDaGlsZHJlbjsKICAgICAgICAgICAgaWYgKGRpZENhcHR1cmVFcnJvciAmJiB0eXBlb2YgQ29tcG9uZW50LmdldERlcml2ZWRTdGF0ZUZyb21FcnJvciAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IG51bGw7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmcoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0YXJ0ZWQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcodHJ1ZSk7CiAgICAgICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSBpbnN0YW5jZS5yZW5kZXIoKTsKICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UucmVuZGVyKCk7CiAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzZXRJc1JlbmRlcmluZyhmYWxzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQZXJmb3JtZWRXb3JrOwogICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwgJiYgZGlkQ2FwdHVyZUVycm9yKSB7CiAgICAgICAgICAgICAgZm9yY2VVbm1vdW50Q3VycmVudEFuZFJlY29uY2lsZShjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gaW5zdGFuY2Uuc3RhdGU7CiAgICAgICAgICAgIGlmIChoYXNDb250ZXh0KSB7CiAgICAgICAgICAgICAgaW52YWxpZGF0ZUNvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgdHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHB1c2hIb3N0Um9vdENvbnRleHQod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICAgIHZhciByb290MyA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmIChyb290My5wZW5kaW5nQ29udGV4dCkgewogICAgICAgICAgICAgIHB1c2hUb3BMZXZlbENvbnRleHRPYmplY3Qod29ya0luUHJvZ3Jlc3MyLCByb290My5wZW5kaW5nQ29udGV4dCwgcm9vdDMucGVuZGluZ0NvbnRleHQgIT09IHJvb3QzLmNvbnRleHQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHJvb3QzLmNvbnRleHQpIHsKICAgICAgICAgICAgICBwdXNoVG9wTGV2ZWxDb250ZXh0T2JqZWN0KHdvcmtJblByb2dyZXNzMiwgcm9vdDMuY29udGV4dCwgZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHB1c2hIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzMiwgcm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVIb3N0Um9vdChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgICAgcHVzaEhvc3RSb290Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBoYXZlIGEgY3VycmVudCBmaWJlci4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICB2YXIgcHJldkNoaWxkcmVuID0gcHJldlN0YXRlLmVsZW1lbnQ7CiAgICAgICAgICAgIGNsb25lVXBkYXRlUXVldWUoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIHByb2Nlc3NVcGRhdGVRdWV1ZSh3b3JrSW5Qcm9ncmVzczIsIG5leHRQcm9wcywgbnVsbCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgdmFyIG5leHRTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICB2YXIgcm9vdDMgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuID0gbmV4dFN0YXRlLmVsZW1lbnQ7CiAgICAgICAgICAgIGlmIChwcmV2U3RhdGUuaXNEZWh5ZHJhdGVkKSB7CiAgICAgICAgICAgICAgdmFyIG92ZXJyaWRlU3RhdGUgPSB7CiAgICAgICAgICAgICAgICBlbGVtZW50OiBuZXh0Q2hpbGRyZW4sCiAgICAgICAgICAgICAgICBpc0RlaHlkcmF0ZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgY2FjaGU6IG5leHRTdGF0ZS5jYWNoZSwKICAgICAgICAgICAgICAgIHBlbmRpbmdTdXNwZW5zZUJvdW5kYXJpZXM6IG5leHRTdGF0ZS5wZW5kaW5nU3VzcGVuc2VCb3VuZGFyaWVzLAogICAgICAgICAgICAgICAgdHJhbnNpdGlvbnM6IG5leHRTdGF0ZS50cmFuc2l0aW9ucwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgIHVwZGF0ZVF1ZXVlLmJhc2VTdGF0ZSA9IG92ZXJyaWRlU3RhdGU7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBvdmVycmlkZVN0YXRlOwogICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBGb3JjZUNsaWVudFJlbmRlcikgewogICAgICAgICAgICAgICAgdmFyIHJlY292ZXJhYmxlRXJyb3IgPSBjcmVhdGVDYXB0dXJlZFZhbHVlQXRGaWJlcihuZXcgRXJyb3IoIlRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSBoeWRyYXRpbmcuIEJlY2F1c2UgdGhlIGVycm9yIGhhcHBlbmVkIG91dHNpZGUgb2YgYSBTdXNwZW5zZSBib3VuZGFyeSwgdGhlIGVudGlyZSByb290IHdpbGwgc3dpdGNoIHRvIGNsaWVudCByZW5kZXJpbmcuIiksIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRIb3N0Um9vdFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIsIHJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAobmV4dENoaWxkcmVuICE9PSBwcmV2Q2hpbGRyZW4pIHsKICAgICAgICAgICAgICAgIHZhciBfcmVjb3ZlcmFibGVFcnJvciA9IGNyZWF0ZUNhcHR1cmVkVmFsdWVBdEZpYmVyKG5ldyBFcnJvcigiVGhpcyByb290IHJlY2VpdmVkIGFuIGVhcmx5IHVwZGF0ZSwgYmVmb3JlIGFueXRoaW5nIHdhcyBhYmxlIGh5ZHJhdGUuIFN3aXRjaGVkIHRoZSBlbnRpcmUgcm9vdCB0byBjbGllbnQgcmVuZGVyaW5nLiIpLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SG9zdFJvb3RXaXRob3V0SHlkcmF0aW5nKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyLCBfcmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVudGVySHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IG1vdW50Q2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBudWxsLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBjaGlsZDsKICAgICAgICAgICAgICAgIHZhciBub2RlID0gY2hpbGQ7CiAgICAgICAgICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgICAgICAgICBub2RlLmZsYWdzID0gbm9kZS5mbGFncyAmIH5QbGFjZW1lbnQgfCBIeWRyYXRpbmc7CiAgICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgICBpZiAobmV4dENoaWxkcmVuID09PSBwcmV2Q2hpbGRyZW4pIHsKICAgICAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbW91bnRIb3N0Um9vdFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIsIHJlY292ZXJhYmxlRXJyb3IpIHsKICAgICAgICAgICAgcmVzZXRIeWRyYXRpb25TdGF0ZSgpOwogICAgICAgICAgICBxdWV1ZUh5ZHJhdGlvbkVycm9yKHJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRm9yY2VDbGllbnRSZW5kZXI7CiAgICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUhvc3RDb21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICAgIHB1c2hIb3N0Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0cnlUb0NsYWltTmV4dEh5ZHJhdGFibGVJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0eXBlMiA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGN1cnJlbnQyICE9PSBudWxsID8gY3VycmVudDIubWVtb2l6ZWRQcm9wcyA6IG51bGw7CiAgICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgIHZhciBpc0RpcmVjdFRleHRDaGlsZCA9IHNob3VsZFNldFRleHRDb250ZW50KHR5cGUyLCBuZXh0UHJvcHMpOwogICAgICAgICAgICBpZiAoaXNEaXJlY3RUZXh0Q2hpbGQpIHsKICAgICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgICB9IGVsc2UgaWYgKHByZXZQcm9wcyAhPT0gbnVsbCAmJiBzaG91bGRTZXRUZXh0Q29udGVudCh0eXBlMiwgcHJldlByb3BzKSkgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBDb250ZW50UmVzZXQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbWFya1JlZihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlSG9zdFRleHQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0cnlUb0NsYWltTmV4dEh5ZHJhdGFibGVJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbW91bnRMYXp5Q29tcG9uZW50KF9jdXJyZW50LCB3b3JrSW5Qcm9ncmVzczIsIGVsZW1lbnRUeXBlLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgICAgcmVzZXRTdXNwZW5kZWRDdXJyZW50T25Nb3VudEluTGVnYWN5TW9kZShfY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgdmFyIHByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSBlbGVtZW50VHlwZTsKICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICB2YXIgaW5pdDIgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gaW5pdDIocGF5bG9hZCk7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gQ29tcG9uZW50OwogICAgICAgICAgICB2YXIgcmVzb2x2ZWRUYWcgPSB3b3JrSW5Qcm9ncmVzczIudGFnID0gcmVzb2x2ZUxhenlDb21wb25lbnRUYWcoQ29tcG9uZW50KTsKICAgICAgICAgICAgdmFyIHJlc29sdmVkUHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKENvbXBvbmVudCwgcHJvcHMpOwogICAgICAgICAgICB2YXIgY2hpbGQ7CiAgICAgICAgICAgIHN3aXRjaCAocmVzb2x2ZWRUYWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhbGlkYXRlRnVuY3Rpb25Db21wb25lbnRJbkRldih3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCk7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gQ29tcG9uZW50ID0gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKENvbXBvbmVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjaGlsZCA9IHVwZGF0ZUZ1bmN0aW9uQ29tcG9uZW50KG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCByZXNvbHZlZFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gQ29tcG9uZW50ID0gcmVzb2x2ZUNsYXNzRm9ySG90UmVsb2FkaW5nKENvbXBvbmVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjaGlsZCA9IHVwZGF0ZUNsYXNzQ29tcG9uZW50KG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCByZXNvbHZlZFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6IHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSBDb21wb25lbnQgPSByZXNvbHZlRm9yd2FyZFJlZkZvckhvdFJlbG9hZGluZyhDb21wb25lbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2hpbGQgPSB1cGRhdGVGb3J3YXJkUmVmKG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCByZXNvbHZlZFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgb3V0ZXJQcm9wVHlwZXMgPSBDb21wb25lbnQucHJvcFR5cGVzOwogICAgICAgICAgICAgICAgICAgIGlmIChvdXRlclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgICAgICAgIG91dGVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlZFByb3BzLAogICAgICAgICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBmb3Igb3V0ZXIgb25seQogICAgICAgICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpCiAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2hpbGQgPSB1cGRhdGVNZW1vQ29tcG9uZW50KAogICAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIsCiAgICAgICAgICAgICAgICAgIENvbXBvbmVudCwKICAgICAgICAgICAgICAgICAgcmVzb2x2ZURlZmF1bHRQcm9wcyhDb21wb25lbnQudHlwZSwgcmVzb2x2ZWRQcm9wcyksCiAgICAgICAgICAgICAgICAgIC8vIFRoZSBpbm5lciB0eXBlIGNhbiBoYXZlIGRlZmF1bHRzIHRvbwogICAgICAgICAgICAgICAgICByZW5kZXJMYW5lczIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBoaW50ID0gIiI7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoQ29tcG9uZW50ICE9PSBudWxsICYmIHR5cGVvZiBDb21wb25lbnQgPT09ICJvYmplY3QiICYmIENvbXBvbmVudC4kJHR5cGVvZiA9PT0gUkVBQ1RfTEFaWV9UWVBFKSB7CiAgICAgICAgICAgICAgICBoaW50ID0gIiBEaWQgeW91IHdyYXAgYSBjb21wb25lbnQgaW4gUmVhY3QubGF6eSgpIG1vcmUgdGhhbiBvbmNlPyI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRWxlbWVudCB0eXBlIGlzIGludmFsaWQuIFJlY2VpdmVkIGEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIHRvOiAiICsgQ29tcG9uZW50ICsgIi4gIiArICgiTGF6eSBlbGVtZW50IHR5cGUgbXVzdCByZXNvbHZlIHRvIGEgY2xhc3Mgb3IgZnVuY3Rpb24uIiArIGhpbnQpKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG1vdW50SW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50KF9jdXJyZW50LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgICAgcmVzZXRTdXNwZW5kZWRDdXJyZW50T25Nb3VudEluTGVnYWN5TW9kZShfY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRhZyA9IENsYXNzQ29tcG9uZW50OwogICAgICAgICAgICB2YXIgaGFzQ29udGV4dDsKICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICBoYXNDb250ZXh0ID0gdHJ1ZTsKICAgICAgICAgICAgICBwdXNoQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaGFzQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHByZXBhcmVUb1JlYWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY29uc3RydWN0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzKTsKICAgICAgICAgICAgbW91bnRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIHJldHVybiBmaW5pc2hDbGFzc0NvbXBvbmVudChudWxsLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgdHJ1ZSwgaGFzQ29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG1vdW50SW5kZXRlcm1pbmF0ZUNvbXBvbmVudChfY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgICByZXNldFN1c3BlbmRlZEN1cnJlbnRPbk1vdW50SW5MZWdhY3lNb2RlKF9jdXJyZW50LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB2YXIgcHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICB2YXIgY29udGV4dDsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciB1bm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIGZhbHNlKTsKICAgICAgICAgICAgICBjb250ZXh0ID0gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB2YXIgdmFsdWU7CiAgICAgICAgICAgIHZhciBoYXNJZDsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChDb21wb25lbnQucHJvdG90eXBlICYmIHR5cGVvZiBDb21wb25lbnQucHJvdG90eXBlLnJlbmRlciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dEJhZENsYXNzW2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgPCVzIC8+IGNvbXBvbmVudCBhcHBlYXJzIHRvIGhhdmUgYSByZW5kZXIgbWV0aG9kLCBidXQgZG9lc24ndCBleHRlbmQgUmVhY3QuQ29tcG9uZW50LiBUaGlzIGlzIGxpa2VseSB0byBjYXVzZSBlcnJvcnMuIENoYW5nZSAlcyB0byBleHRlbmQgUmVhY3QuQ29tcG9uZW50IGluc3RlYWQuIiwgY29tcG9uZW50TmFtZSwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEJhZENsYXNzW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MucmVjb3JkTGVnYWN5Q29udGV4dFdhcm5pbmcod29ya0luUHJvZ3Jlc3MyLCBudWxsKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcodHJ1ZSk7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIkMS5jdXJyZW50ID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICAgIHZhbHVlID0gcmVuZGVyV2l0aEhvb2tzKG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBwcm9wcywgY29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICBoYXNJZCA9IGNoZWNrRGlkUmVuZGVySWRIb29rKCk7CiAgICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcoZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQZXJmb3JtZWRXb3JrOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgJiYgdmFsdWUgIT09IG51bGwgJiYgdHlwZW9mIHZhbHVlLnJlbmRlciA9PT0gImZ1bmN0aW9uIiAmJiB2YWx1ZS4kJHR5cGVvZiA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICB2YXIgX2NvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dE1vZHVsZVBhdHRlcm5Db21wb25lbnRbX2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgPCVzIC8+IGNvbXBvbmVudCBhcHBlYXJzIHRvIGJlIGEgZnVuY3Rpb24gY29tcG9uZW50IHRoYXQgcmV0dXJucyBhIGNsYXNzIGluc3RhbmNlLiBDaGFuZ2UgJXMgdG8gYSBjbGFzcyB0aGF0IGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50IGluc3RlYWQuIElmIHlvdSBjYW4ndCB1c2UgYSBjbGFzcyB0cnkgYXNzaWduaW5nIHRoZSBwcm90b3R5cGUgb24gdGhlIGZ1bmN0aW9uIGFzIGEgd29ya2Fyb3VuZC4gYCVzLnByb3RvdHlwZSA9IFJlYWN0LkNvbXBvbmVudC5wcm90b3R5cGVgLiBEb24ndCB1c2UgYW4gYXJyb3cgZnVuY3Rpb24gc2luY2UgaXQgY2Fubm90IGJlIGNhbGxlZCB3aXRoIGBuZXdgIGJ5IFJlYWN0LiIsIF9jb21wb25lbnROYW1lLCBfY29tcG9uZW50TmFtZSwgX2NvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50W19jb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAvLyBSdW4gdGhlc2UgY2hlY2tzIGluIHByb2R1Y3Rpb24gb25seSBpZiB0aGUgZmxhZyBpcyBvZmYuCiAgICAgICAgICAgICAgLy8gRXZlbnR1YWxseSB3ZSdsbCBkZWxldGUgdGhpcyBicmFuY2ggYWx0b2dldGhlci4KICAgICAgICAgICAgICB0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIHZhbHVlICE9PSBudWxsICYmIHR5cGVvZiB2YWx1ZS5yZW5kZXIgPT09ICJmdW5jdGlvbiIgJiYgdmFsdWUuJCR0eXBlb2YgPT09IHZvaWQgMAogICAgICAgICAgICApIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgX2NvbXBvbmVudE5hbWUyID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkgfHwgIlVua25vd24iOwogICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50W19jb21wb25lbnROYW1lMl0pIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlRoZSA8JXMgLz4gY29tcG9uZW50IGFwcGVhcnMgdG8gYmUgYSBmdW5jdGlvbiBjb21wb25lbnQgdGhhdCByZXR1cm5zIGEgY2xhc3MgaW5zdGFuY2UuIENoYW5nZSAlcyB0byBhIGNsYXNzIHRoYXQgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQgaW5zdGVhZC4gSWYgeW91IGNhbid0IHVzZSBhIGNsYXNzIHRyeSBhc3NpZ25pbmcgdGhlIHByb3RvdHlwZSBvbiB0aGUgZnVuY3Rpb24gYXMgYSB3b3JrYXJvdW5kLiBgJXMucHJvdG90eXBlID0gUmVhY3QuQ29tcG9uZW50LnByb3RvdHlwZWAuIERvbid0IHVzZSBhbiBhcnJvdyBmdW5jdGlvbiBzaW5jZSBpdCBjYW5ub3QgYmUgY2FsbGVkIHdpdGggYG5ld2AgYnkgUmVhY3QuIiwgX2NvbXBvbmVudE5hbWUyLCBfY29tcG9uZW50TmFtZTIsIF9jb21wb25lbnROYW1lMik7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dE1vZHVsZVBhdHRlcm5Db21wb25lbnRbX2NvbXBvbmVudE5hbWUyXSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50YWcgPSBDbGFzc0NvbXBvbmVudDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgICB2YXIgaGFzQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgICAgIGlmIChpc0NvbnRleHRQcm92aWRlcihDb21wb25lbnQpKSB7CiAgICAgICAgICAgICAgICBoYXNDb250ZXh0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHB1c2hDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaGFzQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IHZhbHVlLnN0YXRlICE9PSBudWxsICYmIHZhbHVlLnN0YXRlICE9PSB2b2lkIDAgPyB2YWx1ZS5zdGF0ZSA6IG51bGw7CiAgICAgICAgICAgICAgaW5pdGlhbGl6ZVVwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgYWRvcHRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgdmFsdWUpOwogICAgICAgICAgICAgIG1vdW50Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgcmV0dXJuIGZpbmlzaENsYXNzQ29tcG9uZW50KG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCB0cnVlLCBoYXNDb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50YWcgPSBGdW5jdGlvbkNvbXBvbmVudDsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gcmVuZGVyV2l0aEhvb2tzKG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBwcm9wcywgY29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgICAgICBoYXNJZCA9IGNoZWNrRGlkUmVuZGVySWRIb29rKCk7CiAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpICYmIGhhc0lkKSB7CiAgICAgICAgICAgICAgICBwdXNoTWF0ZXJpYWxpemVkVHJlZUlkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKG51bGwsIHdvcmtJblByb2dyZXNzMiwgdmFsdWUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFsaWRhdGVGdW5jdGlvbkNvbXBvbmVudEluRGV2KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVGdW5jdGlvbkNvbXBvbmVudEluRGV2KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50KSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICBpZiAoQ29tcG9uZW50LmNoaWxkQ29udGV4dFR5cGVzKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCIlcyguLi4pOiBjaGlsZENvbnRleHRUeXBlcyBjYW5ub3QgYmUgZGVmaW5lZCBvbiBhIGZ1bmN0aW9uIGNvbXBvbmVudC4iLCBDb21wb25lbnQuZGlzcGxheU5hbWUgfHwgQ29tcG9uZW50Lm5hbWUgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGluZm8gPSAiIjsKICAgICAgICAgICAgICAgIHZhciBvd25lck5hbWUgPSBnZXRDdXJyZW50RmliZXJPd25lck5hbWVJbkRldk9yTnVsbCgpOwogICAgICAgICAgICAgICAgaWYgKG93bmVyTmFtZSkgewogICAgICAgICAgICAgICAgICBpbmZvICs9ICJcblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgYCIgKyBvd25lck5hbWUgKyAiYC4iOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHdhcm5pbmdLZXkgPSBvd25lck5hbWUgfHwgIiI7CiAgICAgICAgICAgICAgICB2YXIgZGVidWdTb3VyY2UgPSB3b3JrSW5Qcm9ncmVzczIuX2RlYnVnU291cmNlOwogICAgICAgICAgICAgICAgaWYgKGRlYnVnU291cmNlKSB7CiAgICAgICAgICAgICAgICAgIHdhcm5pbmdLZXkgPSBkZWJ1Z1NvdXJjZS5maWxlTmFtZSArICI6IiArIGRlYnVnU291cmNlLmxpbmVOdW1iZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dEZ1bmN0aW9uUmVmc1t3YXJuaW5nS2V5XSkgewogICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRGdW5jdGlvblJlZnNbd2FybmluZ0tleV0gPSB0cnVlOwogICAgICAgICAgICAgICAgICBlcnJvcigiRnVuY3Rpb24gY29tcG9uZW50cyBjYW5ub3QgYmUgZ2l2ZW4gcmVmcy4gQXR0ZW1wdHMgdG8gYWNjZXNzIHRoaXMgcmVmIHdpbGwgZmFpbC4gRGlkIHlvdSBtZWFuIHRvIHVzZSBSZWFjdC5mb3J3YXJkUmVmKCk/JXMiLCBpbmZvKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBDb21wb25lbnQuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB2YXIgX2NvbXBvbmVudE5hbWUzID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkgfHwgIlVua25vd24iOwogICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRHZXREZXJpdmVkU3RhdGVPbkZ1bmN0aW9uQ29tcG9uZW50W19jb21wb25lbnROYW1lM10pIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBGdW5jdGlvbiBjb21wb25lbnRzIGRvIG5vdCBzdXBwb3J0IGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcy4iLCBfY29tcG9uZW50TmFtZTMpOwogICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRHZXREZXJpdmVkU3RhdGVPbkZ1bmN0aW9uQ29tcG9uZW50W19jb21wb25lbnROYW1lM10gPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIENvbXBvbmVudC5jb250ZXh0VHlwZSA9PT0gIm9iamVjdCIgJiYgQ29tcG9uZW50LmNvbnRleHRUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgX2NvbXBvbmVudE5hbWU0ID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkgfHwgIlVua25vd24iOwogICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRDb250ZXh0VHlwZU9uRnVuY3Rpb25Db21wb25lbnRbX2NvbXBvbmVudE5hbWU0XSkgewogICAgICAgICAgICAgICAgICBlcnJvcigiJXM6IEZ1bmN0aW9uIGNvbXBvbmVudHMgZG8gbm90IHN1cHBvcnQgY29udGV4dFR5cGUuIiwgX2NvbXBvbmVudE5hbWU0KTsKICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0Q29udGV4dFR5cGVPbkZ1bmN0aW9uQ29tcG9uZW50W19jb21wb25lbnROYW1lNF0gPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIFNVU1BFTkRFRF9NQVJLRVIgPSB7CiAgICAgICAgICAgIGRlaHlkcmF0ZWQ6IG51bGwsCiAgICAgICAgICAgIHRyZWVDb250ZXh0OiBudWxsLAogICAgICAgICAgICByZXRyeUxhbmU6IE5vTGFuZQogICAgICAgICAgfTsKICAgICAgICAgIGZ1bmN0aW9uIG1vdW50U3VzcGVuc2VPZmZzY3JlZW5TdGF0ZShyZW5kZXJMYW5lczIpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBiYXNlTGFuZXM6IHJlbmRlckxhbmVzMiwKICAgICAgICAgICAgICBjYWNoZVBvb2w6IGdldFN1c3BlbmRlZENhY2hlKCksCiAgICAgICAgICAgICAgdHJhbnNpdGlvbnM6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN1c3BlbnNlT2Zmc2NyZWVuU3RhdGUocHJldk9mZnNjcmVlblN0YXRlLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgICAgdmFyIGNhY2hlUG9vbCA9IG51bGw7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgYmFzZUxhbmVzOiBtZXJnZUxhbmVzKHByZXZPZmZzY3JlZW5TdGF0ZS5iYXNlTGFuZXMsIHJlbmRlckxhbmVzMiksCiAgICAgICAgICAgICAgY2FjaGVQb29sLAogICAgICAgICAgICAgIHRyYW5zaXRpb25zOiBwcmV2T2Zmc2NyZWVuU3RhdGUudHJhbnNpdGlvbnMKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHNob3VsZFJlbWFpbk9uRmFsbGJhY2soc3VzcGVuc2VDb250ZXh0LCBjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBoYXNTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0LCBGb3JjZVN1c3BlbnNlRmFsbGJhY2spOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0UmVtYWluaW5nV29ya0luUHJpbWFyeVRyZWUoY3VycmVudDIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgICByZXR1cm4gcmVtb3ZlTGFuZXMoY3VycmVudDIuY2hpbGRMYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN1c3BlbnNlQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChzaG91bGRTdXNwZW5kKHdvcmtJblByb2dyZXNzMikpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc3VzcGVuc2VDb250ZXh0ID0gc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50OwogICAgICAgICAgICB2YXIgc2hvd0ZhbGxiYWNrID0gZmFsc2U7CiAgICAgICAgICAgIHZhciBkaWRTdXNwZW5kID0gKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzOwogICAgICAgICAgICBpZiAoZGlkU3VzcGVuZCB8fCBzaG91bGRSZW1haW5PbkZhbGxiYWNrKHN1c3BlbnNlQ29udGV4dCwgY3VycmVudDIpKSB7CiAgICAgICAgICAgICAgc2hvd0ZhbGxiYWNrID0gdHJ1ZTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJj0gfkRpZENhcHR1cmU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsIHx8IGN1cnJlbnQyLm1lbW9pemVkU3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgc3VzcGVuc2VDb250ZXh0ID0gYWRkU3VidHJlZVN1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQsIEludmlzaWJsZVBhcmVudFN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHN1c3BlbnNlQ29udGV4dCA9IHNldERlZmF1bHRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzdXNwZW5zZUNvbnRleHQpOwogICAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0cnlUb0NsYWltTmV4dEh5ZHJhdGFibGVJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlU3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBkZWh5ZHJhdGVkID0gc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkOwogICAgICAgICAgICAgICAgaWYgKGRlaHlkcmF0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RGVoeWRyYXRlZFN1c3BlbnNlQ29tcG9uZW50KHdvcmtJblByb2dyZXNzMiwgZGVoeWRyYXRlZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBuZXh0UHJpbWFyeUNoaWxkcmVuID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICAgIHZhciBuZXh0RmFsbGJhY2tDaGlsZHJlbiA9IG5leHRQcm9wcy5mYWxsYmFjazsKICAgICAgICAgICAgICBpZiAoc2hvd0ZhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICB2YXIgZmFsbGJhY2tGcmFnbWVudCA9IG1vdW50U3VzcGVuc2VGYWxsYmFja0NoaWxkcmVuKHdvcmtJblByb2dyZXNzMiwgbmV4dFByaW1hcnlDaGlsZHJlbiwgbmV4dEZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5tZW1vaXplZFN0YXRlID0gbW91bnRTdXNwZW5zZU9mZnNjcmVlblN0YXRlKHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IFNVU1BFTkRFRF9NQVJLRVI7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsbGJhY2tGcmFnbWVudDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50U3VzcGVuc2VQcmltYXJ5Q2hpbGRyZW4od29ya0luUHJvZ3Jlc3MyLCBuZXh0UHJpbWFyeUNoaWxkcmVuKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IGN1cnJlbnQyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHByZXZTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIF9kZWh5ZHJhdGVkID0gcHJldlN0YXRlLmRlaHlkcmF0ZWQ7CiAgICAgICAgICAgICAgICBpZiAoX2RlaHlkcmF0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlaHlkcmF0ZWRTdXNwZW5zZUNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBkaWRTdXNwZW5kLCBuZXh0UHJvcHMsIF9kZWh5ZHJhdGVkLCBwcmV2U3RhdGUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChzaG93RmFsbGJhY2spIHsKICAgICAgICAgICAgICAgIHZhciBfbmV4dEZhbGxiYWNrQ2hpbGRyZW4gPSBuZXh0UHJvcHMuZmFsbGJhY2s7CiAgICAgICAgICAgICAgICB2YXIgX25leHRQcmltYXJ5Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgICAgICB2YXIgZmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gdXBkYXRlU3VzcGVuc2VGYWxsYmFja0NoaWxkcmVuKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIF9uZXh0UHJpbWFyeUNoaWxkcmVuLCBfbmV4dEZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICB2YXIgX3ByaW1hcnlDaGlsZEZyYWdtZW50MiA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgIHZhciBwcmV2T2Zmc2NyZWVuU3RhdGUgPSBjdXJyZW50Mi5jaGlsZC5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgX3ByaW1hcnlDaGlsZEZyYWdtZW50Mi5tZW1vaXplZFN0YXRlID0gcHJldk9mZnNjcmVlblN0YXRlID09PSBudWxsID8gbW91bnRTdXNwZW5zZU9mZnNjcmVlblN0YXRlKHJlbmRlckxhbmVzMikgOiB1cGRhdGVTdXNwZW5zZU9mZnNjcmVlblN0YXRlKHByZXZPZmZzY3JlZW5TdGF0ZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIF9wcmltYXJ5Q2hpbGRGcmFnbWVudDIuY2hpbGRMYW5lcyA9IGdldFJlbWFpbmluZ1dvcmtJblByaW1hcnlUcmVlKGN1cnJlbnQyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBTVVNQRU5ERURfTUFSS0VSOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIF9uZXh0UHJpbWFyeUNoaWxkcmVuMiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICAgIHZhciBfcHJpbWFyeUNoaWxkRnJhZ21lbnQzID0gdXBkYXRlU3VzcGVuc2VQcmltYXJ5Q2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgX25leHRQcmltYXJ5Q2hpbGRyZW4yLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgICAgICAgcmV0dXJuIF9wcmltYXJ5Q2hpbGRGcmFnbWVudDM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtb3VudFN1c3BlbnNlUHJpbWFyeUNoaWxkcmVuKHdvcmtJblByb2dyZXNzMiwgcHJpbWFyeUNoaWxkcmVuLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgICAgdmFyIG1vZGUgPSB3b3JrSW5Qcm9ncmVzczIubW9kZTsKICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZFByb3BzID0gewogICAgICAgICAgICAgIG1vZGU6ICJ2aXNpYmxlIiwKICAgICAgICAgICAgICBjaGlsZHJlbjogcHJpbWFyeUNoaWxkcmVuCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IG1vdW50V29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihwcmltYXJ5Q2hpbGRQcm9wcywgbW9kZSk7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICAgIHJldHVybiBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG1vdW50U3VzcGVuc2VGYWxsYmFja0NoaWxkcmVuKHdvcmtJblByb2dyZXNzMiwgcHJpbWFyeUNoaWxkcmVuLCBmYWxsYmFja0NoaWxkcmVuLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgICAgdmFyIG1vZGUgPSB3b3JrSW5Qcm9ncmVzczIubW9kZTsKICAgICAgICAgICAgdmFyIHByb2dyZXNzZWRQcmltYXJ5RnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRQcm9wcyA9IHsKICAgICAgICAgICAgICBtb2RlOiAiaGlkZGVuIiwKICAgICAgICAgICAgICBjaGlsZHJlbjogcHJpbWFyeUNoaWxkcmVuCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgICAgdmFyIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgICAgaWYgKChtb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUgJiYgcHJvZ3Jlc3NlZFByaW1hcnlGcmFnbWVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gcHJvZ3Jlc3NlZFByaW1hcnlGcmFnbWVudDsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5jaGlsZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5wZW5kaW5nUHJvcHMgPSBwcmltYXJ5Q2hpbGRQcm9wczsKICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuYWN0dWFsRHVyYXRpb24gPSAwOwogICAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuYWN0dWFsU3RhcnRUaW1lID0gLTE7CiAgICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zZWxmQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnRyZWVCYXNlRHVyYXRpb24gPSAwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChmYWxsYmFja0NoaWxkcmVuLCBtb2RlLCByZW5kZXJMYW5lczIsIG51bGwpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gbW91bnRXb3JrSW5Qcm9ncmVzc09mZnNjcmVlbkZpYmVyKHByaW1hcnlDaGlsZFByb3BzLCBtb2RlKTsKICAgICAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChmYWxsYmFja0NoaWxkcmVuLCBtb2RlLCByZW5kZXJMYW5lczIsIG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuc2libGluZyA9IGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICAgIHJldHVybiBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtb3VudFdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIob2Zmc2NyZWVuUHJvcHMsIG1vZGUsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJGcm9tT2Zmc2NyZWVuKG9mZnNjcmVlblByb3BzLCBtb2RlLCBOb0xhbmVzLCBudWxsKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIoY3VycmVudDIsIG9mZnNjcmVlblByb3BzKSB7CiAgICAgICAgICAgIHJldHVybiBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50Miwgb2Zmc2NyZWVuUHJvcHMpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlU3VzcGVuc2VQcmltYXJ5Q2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcHJpbWFyeUNoaWxkcmVuLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudCA9IGN1cnJlbnQyLmNoaWxkOwogICAgICAgICAgICB2YXIgY3VycmVudEZhbGxiYWNrQ2hpbGRGcmFnbWVudCA9IGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudC5zaWJsaW5nOwogICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc09mZnNjcmVlbkZpYmVyKGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudCwgewogICAgICAgICAgICAgIG1vZGU6ICJ2aXNpYmxlIiwKICAgICAgICAgICAgICBjaGlsZHJlbjogcHJpbWFyeUNoaWxkcmVuCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5sYW5lcyA9IHJlbmRlckxhbmVzMjsKICAgICAgICAgICAgfQogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgICBpZiAoY3VycmVudEZhbGxiYWNrQ2hpbGRGcmFnbWVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBkZWxldGlvbnMgPSB3b3JrSW5Qcm9ncmVzczIuZGVsZXRpb25zOwogICAgICAgICAgICAgIGlmIChkZWxldGlvbnMgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5kZWxldGlvbnMgPSBbY3VycmVudEZhbGxiYWNrQ2hpbGRGcmFnbWVudF07CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gQ2hpbGREZWxldGlvbjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVsZXRpb25zLnB1c2goY3VycmVudEZhbGxiYWNrQ2hpbGRGcmFnbWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgICByZXR1cm4gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVTdXNwZW5zZUZhbGxiYWNrQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcHJpbWFyeUNoaWxkcmVuLCBmYWxsYmFja0NoaWxkcmVuLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgICAgdmFyIG1vZGUgPSB3b3JrSW5Qcm9ncmVzczIubW9kZTsKICAgICAgICAgICAgdmFyIGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudCA9IGN1cnJlbnQyLmNoaWxkOwogICAgICAgICAgICB2YXIgY3VycmVudEZhbGxiYWNrQ2hpbGRGcmFnbWVudCA9IGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudC5zaWJsaW5nOwogICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkUHJvcHMgPSB7CiAgICAgICAgICAgICAgbW9kZTogImhpZGRlbiIsCiAgICAgICAgICAgICAgY2hpbGRyZW46IHByaW1hcnlDaGlsZHJlbgogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAvLyBJbiBsZWdhY3kgbW9kZSwgd2UgY29tbWl0IHRoZSBwcmltYXJ5IHRyZWUgYXMgaWYgaXQgc3VjY2Vzc2Z1bGx5CiAgICAgICAgICAgICAgLy8gY29tcGxldGVkLCBldmVuIHRob3VnaCBpdCdzIGluIGFuIGluY29uc2lzdGVudCBzdGF0ZS4KICAgICAgICAgICAgICAobW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlICYmIC8vIE1ha2Ugc3VyZSB3ZSdyZSBvbiB0aGUgc2Vjb25kIHBhc3MsIGkuZS4gdGhlIHByaW1hcnkgY2hpbGQgZnJhZ21lbnQgd2FzCiAgICAgICAgICAgICAgLy8gYWxyZWFkeSBjbG9uZWQuIEluIGxlZ2FjeSBtb2RlLCB0aGUgb25seSBjYXNlIHdoZXJlIHRoaXMgaXNuJ3QgdHJ1ZSBpcwogICAgICAgICAgICAgIC8vIHdoZW4gRGV2VG9vbHMgZm9yY2VzIHVzIHRvIGRpc3BsYXkgYSBmYWxsYmFjazsgd2Ugc2tpcCB0aGUgZmlyc3QgcmVuZGVyCiAgICAgICAgICAgICAgLy8gcGFzcyBlbnRpcmVseSBhbmQgZ28gc3RyYWlnaHQgdG8gcmVuZGVyaW5nIHRoZSBmYWxsYmFjay4gKEluIENvbmN1cnJlbnQKICAgICAgICAgICAgICAvLyBNb2RlLCBTdXNwZW5zZUxpc3QgY2FuIGFsc28gdHJpZ2dlciB0aGlzIHNjZW5hcmlvLCBidXQgdGhpcyBpcyBhIGxlZ2FjeS0KICAgICAgICAgICAgICAvLyBvbmx5IGNvZGVwYXRoLikKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgIT09IGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudAogICAgICAgICAgICApIHsKICAgICAgICAgICAgICB2YXIgcHJvZ3Jlc3NlZFByaW1hcnlGcmFnbWVudCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHByb2dyZXNzZWRQcmltYXJ5RnJhZ21lbnQ7CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuY2hpbGRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQucGVuZGluZ1Byb3BzID0gcHJpbWFyeUNoaWxkUHJvcHM7CiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmFjdHVhbER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmFjdHVhbFN0YXJ0VGltZSA9IC0xOwogICAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuc2VsZkJhc2VEdXJhdGlvbiA9IGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudC5zZWxmQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQudHJlZUJhc2VEdXJhdGlvbiA9IGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVsZXRpb25zID0gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHVwZGF0ZVdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIoY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LCBwcmltYXJ5Q2hpbGRQcm9wcyk7CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuc3VidHJlZUZsYWdzID0gY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LnN1YnRyZWVGbGFncyAmIFN0YXRpY01hc2s7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgICAgaWYgKGN1cnJlbnRGYWxsYmFja0NoaWxkRnJhZ21lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50LCBmYWxsYmFja0NoaWxkcmVuKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChmYWxsYmFja0NoaWxkcmVuLCBtb2RlLCByZW5kZXJMYW5lczIsIG51bGwpOwogICAgICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudC5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zaWJsaW5nID0gZmFsbGJhY2tDaGlsZEZyYWdtZW50OwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgICAgcmV0dXJuIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJldHJ5U3VzcGVuc2VDb21wb25lbnRXaXRob3V0SHlkcmF0aW5nKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMiwgcmVjb3ZlcmFibGVFcnJvcikgewogICAgICAgICAgICBpZiAocmVjb3ZlcmFibGVFcnJvciAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHF1ZXVlSHlkcmF0aW9uRXJyb3IocmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBjdXJyZW50Mi5jaGlsZCwgbnVsbCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgdmFyIG5leHRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IG1vdW50U3VzcGVuc2VQcmltYXJ5Q2hpbGRyZW4od29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4pOwogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgcmV0dXJuIHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbW91bnRTdXNwZW5zZUZhbGxiYWNrQWZ0ZXJSZXRyeVdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcHJpbWFyeUNoaWxkcmVuLCBmYWxsYmFja0NoaWxkcmVuLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgICAgdmFyIGZpYmVyTW9kZSA9IHdvcmtJblByb2dyZXNzMi5tb2RlOwogICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkUHJvcHMgPSB7CiAgICAgICAgICAgICAgbW9kZTogInZpc2libGUiLAogICAgICAgICAgICAgIGNoaWxkcmVuOiBwcmltYXJ5Q2hpbGRyZW4KICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gbW91bnRXb3JrSW5Qcm9ncmVzc09mZnNjcmVlbkZpYmVyKHByaW1hcnlDaGlsZFByb3BzLCBmaWJlck1vZGUpOwogICAgICAgICAgICB2YXIgZmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZmFsbGJhY2tDaGlsZHJlbiwgZmliZXJNb2RlLCByZW5kZXJMYW5lczIsIG51bGwpOwogICAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnNpYmxpbmcgPSBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICByZWNvbmNpbGVDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIGN1cnJlbnQyLmNoaWxkLCBudWxsLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtb3VudERlaHlkcmF0ZWRTdXNwZW5zZUNvbXBvbmVudCh3b3JrSW5Qcm9ncmVzczIsIHN1c3BlbnNlSW5zdGFuY2UsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBlcnJvcigiQ2Fubm90IGh5ZHJhdGUgU3VzcGVuc2UgaW4gbGVnYWN5IG1vZGUuIFN3aXRjaCBmcm9tIFJlYWN0RE9NLmh5ZHJhdGUoZWxlbWVudCwgY29udGFpbmVyKSB0byBSZWFjdERPTUNsaWVudC5oeWRyYXRlUm9vdChjb250YWluZXIsIDxBcHAgLz4pLnJlbmRlcihlbGVtZW50KSBvciByZW1vdmUgdGhlIFN1c3BlbnNlIGNvbXBvbmVudHMgZnJvbSB0aGUgc2VydmVyIHJlbmRlcmVkIGNvbXBvbmVudHMuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IGxhbmVUb0xhbmVzKFN5bmNMYW5lKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc1N1c3BlbnNlSW5zdGFuY2VGYWxsYmFjayhzdXNwZW5zZUluc3RhbmNlKSkgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IGxhbmVUb0xhbmVzKERlZmF1bHRIeWRyYXRpb25MYW5lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBsYW5lVG9MYW5lcyhPZmZzY3JlZW5MYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZURlaHlkcmF0ZWRTdXNwZW5zZUNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBkaWRTdXNwZW5kLCBuZXh0UHJvcHMsIHN1c3BlbnNlSW5zdGFuY2UsIHN1c3BlbnNlU3RhdGUsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgICBpZiAoIWRpZFN1c3BlbmQpIHsKICAgICAgICAgICAgICB3YXJuSWZIeWRyYXRpbmcoKTsKICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiByZXRyeVN1c3BlbnNlQ29tcG9uZW50V2l0aG91dEh5ZHJhdGluZygKICAgICAgICAgICAgICAgICAgY3VycmVudDIsCiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMiwKICAgICAgICAgICAgICAgICAgcmVuZGVyTGFuZXMyLAogICAgICAgICAgICAgICAgICAvLyBUT0RPOiBXaGVuIHdlIGRlbGV0ZSBsZWdhY3kgbW9kZSwgd2Ugc2hvdWxkIG1ha2UgdGhpcyBlcnJvciBhcmd1bWVudAogICAgICAgICAgICAgICAgICAvLyByZXF1aXJlZCDigJQgZXZlcnkgY29uY3VycmVudCBtb2RlIHBhdGggdGhhdCBjYXVzZXMgaHlkcmF0aW9uIHRvCiAgICAgICAgICAgICAgICAgIC8vIGRlLW9wdCB0byBjbGllbnQgcmVuZGVyaW5nIHNob3VsZCBoYXZlIGFuIGVycm9yIG1lc3NhZ2UuCiAgICAgICAgICAgICAgICAgIG51bGwKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpc1N1c3BlbnNlSW5zdGFuY2VGYWxsYmFjayhzdXNwZW5zZUluc3RhbmNlKSkgewogICAgICAgICAgICAgICAgdmFyIGRpZ2VzdCwgbWVzc2FnZSwgc3RhY2s7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciBfZ2V0U3VzcGVuc2VJbnN0YW5jZUYgPSBnZXRTdXNwZW5zZUluc3RhbmNlRmFsbGJhY2tFcnJvckRldGFpbHMoc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICAgIGRpZ2VzdCA9IF9nZXRTdXNwZW5zZUluc3RhbmNlRi5kaWdlc3Q7CiAgICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSBfZ2V0U3VzcGVuc2VJbnN0YW5jZUYubWVzc2FnZTsKICAgICAgICAgICAgICAgICAgc3RhY2sgPSBfZ2V0U3VzcGVuc2VJbnN0YW5jZUYuc3RhY2s7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IyOwogICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2UpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IyID0gbmV3IEVycm9yKG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZXJyb3IyID0gbmV3IEVycm9yKCJUaGUgc2VydmVyIGNvdWxkIG5vdCBmaW5pc2ggdGhpcyBTdXNwZW5zZSBib3VuZGFyeSwgbGlrZWx5IGR1ZSB0byBhbiBlcnJvciBkdXJpbmcgc2VydmVyIHJlbmRlcmluZy4gU3dpdGNoZWQgdG8gY2xpZW50IHJlbmRlcmluZy4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjYXB0dXJlZFZhbHVlID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZShlcnJvcjIsIGRpZ2VzdCwgc3RhY2spOwogICAgICAgICAgICAgICAgcmV0dXJuIHJldHJ5U3VzcGVuc2VDb21wb25lbnRXaXRob3V0SHlkcmF0aW5nKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMiwgY2FwdHVyZWRWYWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBoYXNDb250ZXh0Q2hhbmdlZDIgPSBpbmNsdWRlc1NvbWVMYW5lKHJlbmRlckxhbmVzMiwgY3VycmVudDIuY2hpbGRMYW5lcyk7CiAgICAgICAgICAgICAgaWYgKGRpZFJlY2VpdmVVcGRhdGUgfHwgaGFzQ29udGV4dENoYW5nZWQyKSB7CiAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBnZXRXb3JrSW5Qcm9ncmVzc1Jvb3QoKTsKICAgICAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgYXR0ZW1wdEh5ZHJhdGlvbkF0TGFuZSA9IGdldEJ1bXBlZExhbmVGb3JIeWRyYXRpb24ocm9vdDMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgIGlmIChhdHRlbXB0SHlkcmF0aW9uQXRMYW5lICE9PSBOb0xhbmUgJiYgYXR0ZW1wdEh5ZHJhdGlvbkF0TGFuZSAhPT0gc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmUpIHsKICAgICAgICAgICAgICAgICAgICBzdXNwZW5zZVN0YXRlLnJldHJ5TGFuZSA9IGF0dGVtcHRIeWRyYXRpb25BdExhbmU7CiAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgICAgICAgICAgIGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShjdXJyZW50MiwgYXR0ZW1wdEh5ZHJhdGlvbkF0TGFuZSk7CiAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBjdXJyZW50MiwgYXR0ZW1wdEh5ZHJhdGlvbkF0TGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmVuZGVyRGlkU3VzcGVuZERlbGF5SWZQb3NzaWJsZSgpOwogICAgICAgICAgICAgICAgdmFyIF9jYXB0dXJlZFZhbHVlID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZShuZXcgRXJyb3IoIlRoaXMgU3VzcGVuc2UgYm91bmRhcnkgcmVjZWl2ZWQgYW4gdXBkYXRlIGJlZm9yZSBpdCBmaW5pc2hlZCBoeWRyYXRpbmcuIFRoaXMgY2F1c2VkIHRoZSBib3VuZGFyeSB0byBzd2l0Y2ggdG8gY2xpZW50IHJlbmRlcmluZy4gVGhlIHVzdWFsIHdheSB0byBmaXggdGhpcyBpcyB0byB3cmFwIHRoZSBvcmlnaW5hbCB1cGRhdGUgaW4gc3RhcnRUcmFuc2l0aW9uLiIpKTsKICAgICAgICAgICAgICAgIHJldHVybiByZXRyeVN1c3BlbnNlQ29tcG9uZW50V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIsIF9jYXB0dXJlZFZhbHVlKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzU3VzcGVuc2VJbnN0YW5jZVBlbmRpbmcoc3VzcGVuc2VJbnN0YW5jZSkpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY3VycmVudDIuY2hpbGQ7CiAgICAgICAgICAgICAgICB2YXIgcmV0cnkgPSByZXRyeURlaHlkcmF0ZWRTdXNwZW5zZUJvdW5kYXJ5LmJpbmQobnVsbCwgY3VycmVudDIpOwogICAgICAgICAgICAgICAgcmVnaXN0ZXJTdXNwZW5zZUluc3RhbmNlUmV0cnkoc3VzcGVuc2VJbnN0YW5jZSwgcmV0cnkpOwogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlZW50ZXJIeWRyYXRpb25TdGF0ZUZyb21EZWh5ZHJhdGVkU3VzcGVuc2VJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIHN1c3BlbnNlSW5zdGFuY2UsIHN1c3BlbnNlU3RhdGUudHJlZUNvbnRleHQpOwogICAgICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IG1vdW50U3VzcGVuc2VQcmltYXJ5Q2hpbGRyZW4od29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4pOwogICAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuZmxhZ3MgfD0gSHlkcmF0aW5nOwogICAgICAgICAgICAgICAgcmV0dXJuIHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRm9yY2VDbGllbnRSZW5kZXIpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyAmPSB+Rm9yY2VDbGllbnRSZW5kZXI7CiAgICAgICAgICAgICAgICB2YXIgX2NhcHR1cmVkVmFsdWUyID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZShuZXcgRXJyb3IoIlRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSBoeWRyYXRpbmcgdGhpcyBTdXNwZW5zZSBib3VuZGFyeS4gU3dpdGNoZWQgdG8gY2xpZW50IHJlbmRlcmluZy4iKSk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmV0cnlTdXNwZW5zZUNvbXBvbmVudFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyLCBfY2FwdHVyZWRWYWx1ZTIpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAod29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IGN1cnJlbnQyLmNoaWxkOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIG5leHRQcmltYXJ5Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgICAgICB2YXIgbmV4dEZhbGxiYWNrQ2hpbGRyZW4gPSBuZXh0UHJvcHMuZmFsbGJhY2s7CiAgICAgICAgICAgICAgICB2YXIgZmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gbW91bnRTdXNwZW5zZUZhbGxiYWNrQWZ0ZXJSZXRyeVdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dFByaW1hcnlDaGlsZHJlbiwgbmV4dEZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICB2YXIgX3ByaW1hcnlDaGlsZEZyYWdtZW50NCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgIF9wcmltYXJ5Q2hpbGRGcmFnbWVudDQubWVtb2l6ZWRTdGF0ZSA9IG1vdW50U3VzcGVuc2VPZmZzY3JlZW5TdGF0ZShyZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBTVVNQRU5ERURfTUFSS0VSOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlU3VzcGVuc2VXb3JrT25GaWJlcihmaWJlciwgcmVuZGVyTGFuZXMyLCBwcm9wYWdhdGlvblJvb3QpIHsKICAgICAgICAgICAgZmliZXIubGFuZXMgPSBtZXJnZUxhbmVzKGZpYmVyLmxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgYWx0ZXJuYXRlLmxhbmVzID0gbWVyZ2VMYW5lcyhhbHRlcm5hdGUubGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2NoZWR1bGVDb250ZXh0V29ya09uUGFyZW50UGF0aChmaWJlci5yZXR1cm4sIHJlbmRlckxhbmVzMiwgcHJvcGFnYXRpb25Sb290KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHByb3BhZ2F0ZVN1c3BlbnNlQ29udGV4dENoYW5nZSh3b3JrSW5Qcm9ncmVzczIsIGZpcnN0Q2hpbGQsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgICB2YXIgbm9kZSA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChub2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICAgICAgdmFyIHN0YXRlID0gbm9kZS5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgaWYgKHN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHNjaGVkdWxlU3VzcGVuc2VXb3JrT25GaWJlcihub2RlLCByZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLnRhZyA9PT0gU3VzcGVuc2VMaXN0Q29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICBzY2hlZHVsZVN1c3BlbnNlV29ya09uRmliZXIobm9kZSwgcmVuZGVyTGFuZXMyLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbm9kZS5jaGlsZC5yZXR1cm4gPSBub2RlOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgbm9kZS5yZXR1cm4gPT09IHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBmaW5kTGFzdENvbnRlbnRSb3coZmlyc3RDaGlsZCkgewogICAgICAgICAgICB2YXIgcm93ID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgdmFyIGxhc3RDb250ZW50Um93ID0gbnVsbDsKICAgICAgICAgICAgd2hpbGUgKHJvdyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBjdXJyZW50Um93ID0gcm93LmFsdGVybmF0ZTsKICAgICAgICAgICAgICBpZiAoY3VycmVudFJvdyAhPT0gbnVsbCAmJiBmaW5kRmlyc3RTdXNwZW5kZWQoY3VycmVudFJvdykgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGxhc3RDb250ZW50Um93ID0gcm93OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByb3cgPSByb3cuc2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbGFzdENvbnRlbnRSb3c7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVJldmVhbE9yZGVyKHJldmVhbE9yZGVyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAocmV2ZWFsT3JkZXIgIT09IHZvaWQgMCAmJiByZXZlYWxPcmRlciAhPT0gImZvcndhcmRzIiAmJiByZXZlYWxPcmRlciAhPT0gImJhY2t3YXJkcyIgJiYgcmV2ZWFsT3JkZXIgIT09ICJ0b2dldGhlciIgJiYgIWRpZFdhcm5BYm91dFJldmVhbE9yZGVyW3JldmVhbE9yZGVyXSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0UmV2ZWFsT3JkZXJbcmV2ZWFsT3JkZXJdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmV2ZWFsT3JkZXIgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgIHN3aXRjaCAocmV2ZWFsT3JkZXIudG9Mb3dlckNhc2UoKSkgewogICAgICAgICAgICAgICAgICAgIGNhc2UgInRvZ2V0aGVyIjoKICAgICAgICAgICAgICAgICAgICBjYXNlICJmb3J3YXJkcyI6CiAgICAgICAgICAgICAgICAgICAgY2FzZSAiYmFja3dhcmRzIjogewogICAgICAgICAgICAgICAgICAgICAgZXJyb3IoJyIlcyIgaXMgbm90IGEgdmFsaWQgdmFsdWUgZm9yIHJldmVhbE9yZGVyIG9uIDxTdXNwZW5zZUxpc3QgLz4uIFVzZSBsb3dlcmNhc2UgIiVzIiBpbnN0ZWFkLicsIHJldmVhbE9yZGVyLCByZXZlYWxPcmRlci50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjYXNlICJmb3J3YXJkIjoKICAgICAgICAgICAgICAgICAgICBjYXNlICJiYWNrd2FyZCI6IHsKICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCciJXMiIGlzIG5vdCBhIHZhbGlkIHZhbHVlIGZvciByZXZlYWxPcmRlciBvbiA8U3VzcGVuc2VMaXN0IC8+LiBSZWFjdCB1c2VzIHRoZSAtcyBzdWZmaXggaW4gdGhlIHNwZWxsaW5nLiBVc2UgIiVzcyIgaW5zdGVhZC4nLCByZXZlYWxPcmRlciwgcmV2ZWFsT3JkZXIudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCciJXMiIGlzIG5vdCBhIHN1cHBvcnRlZCByZXZlYWxPcmRlciBvbiA8U3VzcGVuc2VMaXN0IC8+LiBEaWQgeW91IG1lYW4gInRvZ2V0aGVyIiwgImZvcndhcmRzIiBvciAiYmFja3dhcmRzIj8nLCByZXZlYWxPcmRlcik7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoJyVzIGlzIG5vdCBhIHN1cHBvcnRlZCB2YWx1ZSBmb3IgcmV2ZWFsT3JkZXIgb24gPFN1c3BlbnNlTGlzdCAvPi4gRGlkIHlvdSBtZWFuICJ0b2dldGhlciIsICJmb3J3YXJkcyIgb3IgImJhY2t3YXJkcyI/JywgcmV2ZWFsT3JkZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVUYWlsT3B0aW9ucyh0YWlsTW9kZSwgcmV2ZWFsT3JkZXIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh0YWlsTW9kZSAhPT0gdm9pZCAwICYmICFkaWRXYXJuQWJvdXRUYWlsT3B0aW9uc1t0YWlsTW9kZV0pIHsKICAgICAgICAgICAgICAgIGlmICh0YWlsTW9kZSAhPT0gImNvbGxhcHNlZCIgJiYgdGFpbE1vZGUgIT09ICJoaWRkZW4iKSB7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFRhaWxPcHRpb25zW3RhaWxNb2RlXSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGVycm9yKCciJXMiIGlzIG5vdCBhIHN1cHBvcnRlZCB2YWx1ZSBmb3IgdGFpbCBvbiA8U3VzcGVuc2VMaXN0IC8+LiBEaWQgeW91IG1lYW4gImNvbGxhcHNlZCIgb3IgImhpZGRlbiI/JywgdGFpbE1vZGUpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZXZlYWxPcmRlciAhPT0gImZvcndhcmRzIiAmJiByZXZlYWxPcmRlciAhPT0gImJhY2t3YXJkcyIpIHsKICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VGFpbE9wdGlvbnNbdGFpbE1vZGVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoJzxTdXNwZW5zZUxpc3QgdGFpbD0iJXMiIC8+IGlzIG9ubHkgdmFsaWQgaWYgcmV2ZWFsT3JkZXIgaXMgImZvcndhcmRzIiBvciAiYmFja3dhcmRzIi4gRGlkIHlvdSBtZWFuIHRvIHNwZWNpZnkgcmV2ZWFsT3JkZXI9ImZvcndhcmRzIj8nLCB0YWlsTW9kZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVN1c3BlbnNlTGlzdE5lc3RlZENoaWxkKGNoaWxkU2xvdCwgaW5kZXgzKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgaXNBbkFycmF5ID0gaXNBcnJheShjaGlsZFNsb3QpOwogICAgICAgICAgICAgIHZhciBpc0l0ZXJhYmxlID0gIWlzQW5BcnJheSAmJiB0eXBlb2YgZ2V0SXRlcmF0b3JGbihjaGlsZFNsb3QpID09PSAiZnVuY3Rpb24iOwogICAgICAgICAgICAgIGlmIChpc0FuQXJyYXkgfHwgaXNJdGVyYWJsZSkgewogICAgICAgICAgICAgICAgdmFyIHR5cGUyID0gaXNBbkFycmF5ID8gImFycmF5IiA6ICJpdGVyYWJsZSI7CiAgICAgICAgICAgICAgICBlcnJvcigiQSBuZXN0ZWQgJXMgd2FzIHBhc3NlZCB0byByb3cgIyVzIGluIDxTdXNwZW5zZUxpc3QgLz4uIFdyYXAgaXQgaW4gYW4gYWRkaXRpb25hbCBTdXNwZW5zZUxpc3QgdG8gY29uZmlndXJlIGl0cyByZXZlYWxPcmRlcjogPFN1c3BlbnNlTGlzdCByZXZlYWxPcmRlcj0uLi4+IC4uLiA8U3VzcGVuc2VMaXN0IHJldmVhbE9yZGVyPS4uLj57JXN9PC9TdXNwZW5zZUxpc3Q+IC4uLiA8L1N1c3BlbnNlTGlzdD4iLCB0eXBlMiwgaW5kZXgzLCB0eXBlMik7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVTdXNwZW5zZUxpc3RDaGlsZHJlbihjaGlsZHJlbjIsIHJldmVhbE9yZGVyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoKHJldmVhbE9yZGVyID09PSAiZm9yd2FyZHMiIHx8IHJldmVhbE9yZGVyID09PSAiYmFja3dhcmRzIikgJiYgY2hpbGRyZW4yICE9PSB2b2lkIDAgJiYgY2hpbGRyZW4yICE9PSBudWxsICYmIGNoaWxkcmVuMiAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KGNoaWxkcmVuMikpIHsKICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbjIubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXZhbGlkYXRlU3VzcGVuc2VMaXN0TmVzdGVkQ2hpbGQoY2hpbGRyZW4yW2ldLCBpKSkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFyIGl0ZXJhdG9yRm4gPSBnZXRJdGVyYXRvckZuKGNoaWxkcmVuMik7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaXRlcmF0b3JGbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHZhciBjaGlsZHJlbkl0ZXJhdG9yID0gaXRlcmF0b3JGbi5jYWxsKGNoaWxkcmVuMik7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkcmVuSXRlcmF0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBzdGVwID0gY2hpbGRyZW5JdGVyYXRvci5uZXh0KCk7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgX2kgPSAwOwogICAgICAgICAgICAgICAgICAgICAgZm9yICg7ICFzdGVwLmRvbmU7IHN0ZXAgPSBjaGlsZHJlbkl0ZXJhdG9yLm5leHQoKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXZhbGlkYXRlU3VzcGVuc2VMaXN0TmVzdGVkQ2hpbGQoc3RlcC52YWx1ZSwgX2kpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIF9pKys7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCdBIHNpbmdsZSByb3cgd2FzIHBhc3NlZCB0byBhIDxTdXNwZW5zZUxpc3QgcmV2ZWFsT3JkZXI9IiVzIiAvPi4gVGhpcyBpcyBub3QgdXNlZnVsIHNpbmNlIGl0IG5lZWRzIG11bHRpcGxlIHJvd3MuIERpZCB5b3UgbWVhbiB0byBwYXNzIG11bHRpcGxlIGNoaWxkcmVuIG9yIGFuIGFycmF5PycsIHJldmVhbE9yZGVyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaW5pdFN1c3BlbnNlTGlzdFJlbmRlclN0YXRlKHdvcmtJblByb2dyZXNzMiwgaXNCYWNrd2FyZHMsIHRhaWwsIGxhc3RDb250ZW50Um93LCB0YWlsTW9kZSkgewogICAgICAgICAgICB2YXIgcmVuZGVyU3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgaWYgKHJlbmRlclN0YXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSB7CiAgICAgICAgICAgICAgICBpc0JhY2t3YXJkcywKICAgICAgICAgICAgICAgIHJlbmRlcmluZzogbnVsbCwKICAgICAgICAgICAgICAgIHJlbmRlcmluZ1N0YXJ0VGltZTogMCwKICAgICAgICAgICAgICAgIGxhc3Q6IGxhc3RDb250ZW50Um93LAogICAgICAgICAgICAgICAgdGFpbCwKICAgICAgICAgICAgICAgIHRhaWxNb2RlCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZW5kZXJTdGF0ZS5pc0JhY2t3YXJkcyA9IGlzQmFja3dhcmRzOwogICAgICAgICAgICAgIHJlbmRlclN0YXRlLnJlbmRlcmluZyA9IG51bGw7CiAgICAgICAgICAgICAgcmVuZGVyU3RhdGUucmVuZGVyaW5nU3RhcnRUaW1lID0gMDsKICAgICAgICAgICAgICByZW5kZXJTdGF0ZS5sYXN0ID0gbGFzdENvbnRlbnRSb3c7CiAgICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbCA9IHRhaWw7CiAgICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbE1vZGUgPSB0YWlsTW9kZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlU3VzcGVuc2VMaXN0Q29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgdmFyIHJldmVhbE9yZGVyID0gbmV4dFByb3BzLnJldmVhbE9yZGVyOwogICAgICAgICAgICB2YXIgdGFpbE1vZGUgPSBuZXh0UHJvcHMudGFpbDsKICAgICAgICAgICAgdmFyIG5ld0NoaWxkcmVuID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICB2YWxpZGF0ZVJldmVhbE9yZGVyKHJldmVhbE9yZGVyKTsKICAgICAgICAgICAgdmFsaWRhdGVUYWlsT3B0aW9ucyh0YWlsTW9kZSwgcmV2ZWFsT3JkZXIpOwogICAgICAgICAgICB2YWxpZGF0ZVN1c3BlbnNlTGlzdENoaWxkcmVuKG5ld0NoaWxkcmVuLCByZXZlYWxPcmRlcik7CiAgICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5ld0NoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB2YXIgc3VzcGVuc2VDb250ZXh0ID0gc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50OwogICAgICAgICAgICB2YXIgc2hvdWxkRm9yY2VGYWxsYmFjayA9IGhhc1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQsIEZvcmNlU3VzcGVuc2VGYWxsYmFjayk7CiAgICAgICAgICAgIGlmIChzaG91bGRGb3JjZUZhbGxiYWNrKSB7CiAgICAgICAgICAgICAgc3VzcGVuc2VDb250ZXh0ID0gc2V0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQsIEZvcmNlU3VzcGVuc2VGYWxsYmFjayk7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGRpZFN1c3BlbmRCZWZvcmUgPSBjdXJyZW50MiAhPT0gbnVsbCAmJiAoY3VycmVudDIuZmxhZ3MgJiBEaWRDYXB0dXJlKSAhPT0gTm9GbGFnczsKICAgICAgICAgICAgICBpZiAoZGlkU3VzcGVuZEJlZm9yZSkgewogICAgICAgICAgICAgICAgcHJvcGFnYXRlU3VzcGVuc2VDb250ZXh0Q2hhbmdlKHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLmNoaWxkLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzdXNwZW5zZUNvbnRleHQgPSBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzdXNwZW5zZUNvbnRleHQpOwogICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3dpdGNoIChyZXZlYWxPcmRlcikgewogICAgICAgICAgICAgICAgY2FzZSAiZm9yd2FyZHMiOiB7CiAgICAgICAgICAgICAgICAgIHZhciBsYXN0Q29udGVudFJvdyA9IGZpbmRMYXN0Q29udGVudFJvdyh3b3JrSW5Qcm9ncmVzczIuY2hpbGQpOwogICAgICAgICAgICAgICAgICB2YXIgdGFpbDsKICAgICAgICAgICAgICAgICAgaWYgKGxhc3RDb250ZW50Um93ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdGFpbCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBudWxsOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRhaWwgPSBsYXN0Q29udGVudFJvdy5zaWJsaW5nOwogICAgICAgICAgICAgICAgICAgIGxhc3RDb250ZW50Um93LnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGluaXRTdXNwZW5zZUxpc3RSZW5kZXJTdGF0ZSgKICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIsCiAgICAgICAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgLy8gaXNCYWNrd2FyZHMKICAgICAgICAgICAgICAgICAgICB0YWlsLAogICAgICAgICAgICAgICAgICAgIGxhc3RDb250ZW50Um93LAogICAgICAgICAgICAgICAgICAgIHRhaWxNb2RlCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSAiYmFja3dhcmRzIjogewogICAgICAgICAgICAgICAgICB2YXIgX3RhaWwgPSBudWxsOwogICAgICAgICAgICAgICAgICB2YXIgcm93ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBudWxsOwogICAgICAgICAgICAgICAgICB3aGlsZSAocm93ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRSb3cgPSByb3cuYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Um93ICE9PSBudWxsICYmIGZpbmRGaXJzdFN1c3BlbmRlZChjdXJyZW50Um93KSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcm93OwogICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHZhciBuZXh0Um93ID0gcm93LnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgcm93LnNpYmxpbmcgPSBfdGFpbDsKICAgICAgICAgICAgICAgICAgICBfdGFpbCA9IHJvdzsKICAgICAgICAgICAgICAgICAgICByb3cgPSBuZXh0Um93OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGluaXRTdXNwZW5zZUxpc3RSZW5kZXJTdGF0ZSgKICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIsCiAgICAgICAgICAgICAgICAgICAgdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAvLyBpc0JhY2t3YXJkcwogICAgICAgICAgICAgICAgICAgIF90YWlsLAogICAgICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICAgICAgLy8gbGFzdAogICAgICAgICAgICAgICAgICAgIHRhaWxNb2RlCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSAidG9nZXRoZXIiOiB7CiAgICAgICAgICAgICAgICAgIGluaXRTdXNwZW5zZUxpc3RSZW5kZXJTdGF0ZSgKICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIsCiAgICAgICAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgLy8gaXNCYWNrd2FyZHMKICAgICAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICAgICAgIC8vIHRhaWwKICAgICAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICAgICAgIC8vIGxhc3QKICAgICAgICAgICAgICAgICAgICB2b2lkIDAKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVBvcnRhbENvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgICAgcHVzaEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MyLCB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBudWxsLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaGFzV2FybmVkQWJvdXRVc2luZ05vVmFsdWVQcm9wT25Db250ZXh0UHJvdmlkZXIgPSBmYWxzZTsKICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNvbnRleHRQcm92aWRlcihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgICAgdmFyIHByb3ZpZGVyVHlwZSA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICB2YXIgY29udGV4dCA9IHByb3ZpZGVyVHlwZS5fY29udGV4dDsKICAgICAgICAgICAgdmFyIG5ld1Byb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgdmFyIG9sZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IG5ld1Byb3BzLnZhbHVlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCEoInZhbHVlIiBpbiBuZXdQcm9wcykpIHsKICAgICAgICAgICAgICAgIGlmICghaGFzV2FybmVkQWJvdXRVc2luZ05vVmFsdWVQcm9wT25Db250ZXh0UHJvdmlkZXIpIHsKICAgICAgICAgICAgICAgICAgaGFzV2FybmVkQWJvdXRVc2luZ05vVmFsdWVQcm9wT25Db250ZXh0UHJvdmlkZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICBlcnJvcigiVGhlIGB2YWx1ZWAgcHJvcCBpcyByZXF1aXJlZCBmb3IgdGhlIGA8Q29udGV4dC5Qcm92aWRlcj5gLiBEaWQgeW91IG1pc3NwZWxsIGl0IG9yIGZvcmdldCB0byBwYXNzIGl0PyIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcHJvdmlkZXJQcm9wVHlwZXMgPSB3b3JrSW5Qcm9ncmVzczIudHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgICAgaWYgKHByb3ZpZGVyUHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcyhwcm92aWRlclByb3BUeXBlcywgbmV3UHJvcHMsICJwcm9wIiwgIkNvbnRleHQuUHJvdmlkZXIiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHVzaFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMiwgY29udGV4dCwgbmV3VmFsdWUpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKG9sZFByb3BzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgb2xkVmFsdWUgPSBvbGRQcm9wcy52YWx1ZTsKICAgICAgICAgICAgICAgIGlmIChvYmplY3RJcyhvbGRWYWx1ZSwgbmV3VmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgIGlmIChvbGRQcm9wcy5jaGlsZHJlbiA9PT0gbmV3UHJvcHMuY2hpbGRyZW4gJiYgIWhhc0NvbnRleHRDaGFuZ2VkKCkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwcm9wYWdhdGVDb250ZXh0Q2hhbmdlKHdvcmtJblByb2dyZXNzMiwgY29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5ld0NoaWxkcmVuID0gbmV3UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5ld0NoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGhhc1dhcm5lZEFib3V0VXNpbmdDb250ZXh0QXNDb25zdW1lciA9IGZhbHNlOwogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ29udGV4dENvbnN1bWVyKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgICB2YXIgY29udGV4dCA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGNvbnRleHQuX2NvbnRleHQgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgaWYgKGNvbnRleHQgIT09IGNvbnRleHQuQ29uc3VtZXIpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFoYXNXYXJuZWRBYm91dFVzaW5nQ29udGV4dEFzQ29uc3VtZXIpIHsKICAgICAgICAgICAgICAgICAgICBoYXNXYXJuZWRBYm91dFVzaW5nQ29udGV4dEFzQ29uc3VtZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGVycm9yKCJSZW5kZXJpbmcgPENvbnRleHQ+IGRpcmVjdGx5IGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBEaWQgeW91IG1lYW4gdG8gcmVuZGVyIDxDb250ZXh0LkNvbnN1bWVyPiBpbnN0ZWFkPyIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnRleHQgPSBjb250ZXh0Ll9jb250ZXh0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmV3UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICB2YXIgcmVuZGVyMiA9IG5ld1Byb3BzLmNoaWxkcmVuOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZW5kZXIyICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiQSBjb250ZXh0IGNvbnN1bWVyIHdhcyByZW5kZXJlZCB3aXRoIG11bHRpcGxlIGNoaWxkcmVuLCBvciBhIGNoaWxkIHRoYXQgaXNuJ3QgYSBmdW5jdGlvbi4gQSBjb250ZXh0IGNvbnN1bWVyIGV4cGVjdHMgYSBzaW5nbGUgY2hpbGQgdGhhdCBpcyBhIGZ1bmN0aW9uLiBJZiB5b3UgZGlkIHBhc3MgYSBmdW5jdGlvbiwgbWFrZSBzdXJlIHRoZXJlIGlzIG5vIHRyYWlsaW5nIG9yIGxlYWRpbmcgd2hpdGVzcGFjZSBhcm91bmQgaXQuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHByZXBhcmVUb1JlYWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgdmFyIG5ld1ZhbHVlID0gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBuZXdDaGlsZHJlbjsKICAgICAgICAgICAgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgICBzZXRJc1JlbmRlcmluZyh0cnVlKTsKICAgICAgICAgICAgICBuZXdDaGlsZHJlbiA9IHJlbmRlcjIobmV3VmFsdWUpOwogICAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGVyZm9ybWVkV29yazsKICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV3Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtYXJrV29ya0luUHJvZ3Jlc3NSZWNlaXZlZFVwZGF0ZSgpIHsKICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZXNldFN1c3BlbmRlZEN1cnJlbnRPbk1vdW50SW5MZWdhY3lNb2RlKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50Mi5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmFsdGVybmF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlcGVuZGVuY2llcyA9IGN1cnJlbnQyLmRlcGVuZGVuY2llczsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmcoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBtYXJrU2tpcHBlZFVwZGF0ZUxhbmVzKHdvcmtJblByb2dyZXNzMi5sYW5lcyk7CiAgICAgICAgICAgIGlmICghaW5jbHVkZXNTb21lTGFuZShyZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzKSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjbG9uZUNoaWxkRmliZXJzKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVtb3VudEZpYmVyKGN1cnJlbnQyLCBvbGRXb3JrSW5Qcm9ncmVzcywgbmV3V29ya0luUHJvZ3Jlc3MpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciByZXR1cm5GaWJlciA9IG9sZFdvcmtJblByb2dyZXNzLnJldHVybjsKICAgICAgICAgICAgICBpZiAocmV0dXJuRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IHN3YXAgdGhlIHJvb3QgZmliZXIuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1cnJlbnQyLmFsdGVybmF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgb2xkV29ya0luUHJvZ3Jlc3MuYWx0ZXJuYXRlID0gbnVsbDsKICAgICAgICAgICAgICBuZXdXb3JrSW5Qcm9ncmVzcy5pbmRleCA9IG9sZFdvcmtJblByb2dyZXNzLmluZGV4OwogICAgICAgICAgICAgIG5ld1dvcmtJblByb2dyZXNzLnNpYmxpbmcgPSBvbGRXb3JrSW5Qcm9ncmVzcy5zaWJsaW5nOwogICAgICAgICAgICAgIG5ld1dvcmtJblByb2dyZXNzLnJldHVybiA9IG9sZFdvcmtJblByb2dyZXNzLnJldHVybjsKICAgICAgICAgICAgICBuZXdXb3JrSW5Qcm9ncmVzcy5yZWYgPSBvbGRXb3JrSW5Qcm9ncmVzcy5yZWY7CiAgICAgICAgICAgICAgaWYgKG9sZFdvcmtJblByb2dyZXNzID09PSByZXR1cm5GaWJlci5jaGlsZCkgewogICAgICAgICAgICAgICAgcmV0dXJuRmliZXIuY2hpbGQgPSBuZXdXb3JrSW5Qcm9ncmVzczsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHByZXZTaWJsaW5nID0gcmV0dXJuRmliZXIuY2hpbGQ7CiAgICAgICAgICAgICAgICBpZiAocHJldlNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBwYXJlbnQgdG8gaGF2ZSBhIGNoaWxkLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd2hpbGUgKHByZXZTaWJsaW5nLnNpYmxpbmcgIT09IG9sZFdvcmtJblByb2dyZXNzKSB7CiAgICAgICAgICAgICAgICAgIHByZXZTaWJsaW5nID0gcHJldlNpYmxpbmcuc2libGluZzsKICAgICAgICAgICAgICAgICAgaWYgKHByZXZTaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCB0byBmaW5kIHRoZSBwcmV2aW91cyBzaWJsaW5nLiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwcmV2U2libGluZy5zaWJsaW5nID0gbmV3V29ya0luUHJvZ3Jlc3M7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBkZWxldGlvbnMgPSByZXR1cm5GaWJlci5kZWxldGlvbnM7CiAgICAgICAgICAgICAgaWYgKGRlbGV0aW9ucyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuRmliZXIuZGVsZXRpb25zID0gW2N1cnJlbnQyXTsKICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLmZsYWdzIHw9IENoaWxkRGVsZXRpb247CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRlbGV0aW9ucy5wdXNoKGN1cnJlbnQyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbmV3V29ya0luUHJvZ3Jlc3MuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgICAgIHJldHVybiBuZXdXb3JrSW5Qcm9ncmVzczsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY2hlY2tTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQoY3VycmVudDIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgICB2YXIgdXBkYXRlTGFuZXMgPSBjdXJyZW50Mi5sYW5lczsKICAgICAgICAgICAgaWYgKGluY2x1ZGVzU29tZUxhbmUodXBkYXRlTGFuZXMsIHJlbmRlckxhbmVzMikpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBhdHRlbXB0RWFybHlCYWlsb3V0SWZOb1NjaGVkdWxlZFVwZGF0ZShjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzczIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICAgIHB1c2hIb3N0Um9vdENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIHZhciByb290MyA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlKCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgICBwdXNoSG9zdENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBDb21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICAgIGlmIChpc0NvbnRleHRQcm92aWRlcihDb21wb25lbnQpKSB7CiAgICAgICAgICAgICAgICAgIHB1c2hDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6CiAgICAgICAgICAgICAgICBwdXNoSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzczIsIHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIENvbnRleHRQcm92aWRlcjogewogICAgICAgICAgICAgICAgdmFyIG5ld1ZhbHVlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMudmFsdWU7CiAgICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IHdvcmtJblByb2dyZXNzMi50eXBlLl9jb250ZXh0OwogICAgICAgICAgICAgICAgcHVzaFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMiwgY29udGV4dCwgbmV3VmFsdWUpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciBoYXNDaGlsZFdvcmsgPSBpbmNsdWRlc1NvbWVMYW5lKHJlbmRlckxhbmVzMiwgd29ya0luUHJvZ3Jlc3MyLmNoaWxkTGFuZXMpOwogICAgICAgICAgICAgICAgICBpZiAoaGFzQ2hpbGRXb3JrKSB7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgc3RhdGVOb2RlLmVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICAgICAgICBzdGF0ZU5vZGUucGFzc2l2ZUVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIHN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmRlaHlkcmF0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc2V0RGVmYXVsdFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50KSk7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkTGFuZXMgPSBwcmltYXJ5Q2hpbGRGcmFnbWVudC5jaGlsZExhbmVzOwogICAgICAgICAgICAgICAgICBpZiAoaW5jbHVkZXNTb21lTGFuZShyZW5kZXJMYW5lczIsIHByaW1hcnlDaGlsZExhbmVzKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTdXNwZW5zZUNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQpKTsKICAgICAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc2V0RGVmYXVsdFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBkaWRTdXNwZW5kQmVmb3JlID0gKGN1cnJlbnQyLmZsYWdzICYgRGlkQ2FwdHVyZSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICAgICAgICB2YXIgX2hhc0NoaWxkV29yayA9IGluY2x1ZGVzU29tZUxhbmUocmVuZGVyTGFuZXMyLCB3b3JrSW5Qcm9ncmVzczIuY2hpbGRMYW5lcyk7CiAgICAgICAgICAgICAgICBpZiAoZGlkU3VzcGVuZEJlZm9yZSkgewogICAgICAgICAgICAgICAgICBpZiAoX2hhc0NoaWxkV29yaykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTdXNwZW5zZUxpc3RDb21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciByZW5kZXJTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgaWYgKHJlbmRlclN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnJlbmRlcmluZyA9IG51bGw7CiAgICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWwgPSBudWxsOwogICAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS5sYXN0RWZmZWN0ID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQpOwogICAgICAgICAgICAgICAgaWYgKF9oYXNDaGlsZFdvcmspIHsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBMZWdhY3lIaWRkZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlT2Zmc2NyZWVuQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBiZWdpbldvcmsoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z05lZWRzUmVtb3VudCAmJiBjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlbW91bnRGaWJlcihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBjcmVhdGVGaWJlckZyb21UeXBlQW5kUHJvcHMod29ya0luUHJvZ3Jlc3MyLnR5cGUsIHdvcmtJblByb2dyZXNzMi5rZXksIHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHMsIHdvcmtJblByb2dyZXNzMi5fZGVidWdPd25lciB8fCBudWxsLCB3b3JrSW5Qcm9ncmVzczIubW9kZSwgd29ya0luUHJvZ3Jlc3MyLmxhbmVzKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBvbGRQcm9wcyA9IGN1cnJlbnQyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgdmFyIG5ld1Byb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICBpZiAob2xkUHJvcHMgIT09IG5ld1Byb3BzIHx8IGhhc0NvbnRleHRDaGFuZ2VkKCkgfHwgLy8gRm9yY2UgYSByZS1yZW5kZXIgaWYgdGhlIGltcGxlbWVudGF0aW9uIGNoYW5nZWQgZHVlIHRvIGhvdCByZWxvYWQ6CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgIT09IGN1cnJlbnQyLnR5cGUpIHsKICAgICAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgaGFzU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0ID0gY2hlY2tTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQoY3VycmVudDIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICBpZiAoIWhhc1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dCAmJiAvLyBJZiB0aGlzIGlzIHRoZSBzZWNvbmQgcGFzcyBvZiBhbiBlcnJvciBvciBzdXNwZW5zZSBib3VuZGFyeSwgdGhlcmUKICAgICAgICAgICAgICAgIC8vIG1heSBub3QgYmUgd29yayBzY2hlZHVsZWQgb24gYGN1cnJlbnRgLCBzbyB3ZSBjaGVjayBmb3IgdGhpcyBmbGFnLgogICAgICAgICAgICAgICAgKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGF0dGVtcHRFYXJseUJhaWxvdXRJZk5vU2NoZWR1bGVkVXBkYXRlKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoKGN1cnJlbnQyLmZsYWdzICYgRm9yY2VVcGRhdGVGb3JMZWdhY3lTdXNwZW5zZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBkaWRSZWNlaXZlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBpc0ZvcmtlZENoaWxkKHdvcmtJblByb2dyZXNzMikpIHsKICAgICAgICAgICAgICAgIHZhciBzbG90SW5kZXggPSB3b3JrSW5Qcm9ncmVzczIuaW5kZXg7CiAgICAgICAgICAgICAgICB2YXIgbnVtYmVyT2ZGb3JrcyA9IGdldEZvcmtzQXRMZXZlbCgpOwogICAgICAgICAgICAgICAgcHVzaFRyZWVJZCh3b3JrSW5Qcm9ncmVzczIsIG51bWJlck9mRm9ya3MsIHNsb3RJbmRleCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIHN3aXRjaCAod29ya0luUHJvZ3Jlc3MyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDogewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW5kZXRlcm1pbmF0ZUNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCB3b3JrSW5Qcm9ncmVzczIudHlwZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBMYXp5Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgZWxlbWVudFR5cGUgPSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGU7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRMYXp5Q29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIGVsZW1lbnRUeXBlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgICB2YXIgdW5yZXNvbHZlZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICAgIHZhciByZXNvbHZlZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID09PSBDb21wb25lbnQgPyB1bnJlc29sdmVkUHJvcHMgOiByZXNvbHZlRGVmYXVsdFByb3BzKENvbXBvbmVudCwgdW5yZXNvbHZlZFByb3BzKTsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGdW5jdGlvbkNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHJlc29sdmVkUHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBfQ29tcG9uZW50ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgICB2YXIgX3VucmVzb2x2ZWRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICB2YXIgX3Jlc29sdmVkUHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUgPT09IF9Db21wb25lbnQgPyBfdW5yZXNvbHZlZFByb3BzIDogcmVzb2x2ZURlZmF1bHRQcm9wcyhfQ29tcG9uZW50LCBfdW5yZXNvbHZlZFByb3BzKTsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVDbGFzc0NvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBfQ29tcG9uZW50LCBfcmVzb2x2ZWRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVIb3N0Um9vdChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVIb3N0Q29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDoKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVIb3N0VGV4dChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OgogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN1c3BlbnNlQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVBvcnRhbENvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjogewogICAgICAgICAgICAgICAgdmFyIHR5cGUyID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgICB2YXIgX3VucmVzb2x2ZWRQcm9wczIgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgdmFyIF9yZXNvbHZlZFByb3BzMiA9IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSA9PT0gdHlwZTIgPyBfdW5yZXNvbHZlZFByb3BzMiA6IHJlc29sdmVEZWZhdWx0UHJvcHModHlwZTIsIF91bnJlc29sdmVkUHJvcHMyKTsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGb3J3YXJkUmVmKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHR5cGUyLCBfcmVzb2x2ZWRQcm9wczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgRnJhZ21lbnQ6CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRnJhZ21lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICBjYXNlIE1vZGU6CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTW9kZShjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUHJvZmlsZXIoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICBjYXNlIENvbnRleHRQcm92aWRlcjoKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVDb250ZXh0UHJvdmlkZXIoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICBjYXNlIENvbnRleHRDb25zdW1lcjoKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVDb250ZXh0Q29uc3VtZXIoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBfdHlwZTIgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICAgIHZhciBfdW5yZXNvbHZlZFByb3BzMyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICB2YXIgX3Jlc29sdmVkUHJvcHMzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhfdHlwZTIsIF91bnJlc29sdmVkUHJvcHMzKTsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgb3V0ZXJQcm9wVHlwZXMgPSBfdHlwZTIucHJvcFR5cGVzOwogICAgICAgICAgICAgICAgICAgIGlmIChvdXRlclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgICAgICAgIG91dGVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICAgICAgICBfcmVzb2x2ZWRQcm9wczMsCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIGZvciBvdXRlciBvbmx5CiAgICAgICAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKF90eXBlMikKICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBfcmVzb2x2ZWRQcm9wczMgPSByZXNvbHZlRGVmYXVsdFByb3BzKF90eXBlMi50eXBlLCBfcmVzb2x2ZWRQcm9wczMpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU1lbW9Db21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgX3R5cGUyLCBfcmVzb2x2ZWRQcm9wczMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVNpbXBsZU1lbW9Db21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLnR5cGUsIHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgX0NvbXBvbmVudDIgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICAgIHZhciBfdW5yZXNvbHZlZFByb3BzNCA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICB2YXIgX3Jlc29sdmVkUHJvcHM0ID0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID09PSBfQ29tcG9uZW50MiA/IF91bnJlc29sdmVkUHJvcHM0IDogcmVzb2x2ZURlZmF1bHRQcm9wcyhfQ29tcG9uZW50MiwgX3VucmVzb2x2ZWRQcm9wczQpOwogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIF9Db21wb25lbnQyLCBfcmVzb2x2ZWRQcm9wczQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3VzcGVuc2VMaXN0Q29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgU2NvcGVDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDogewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU9mZnNjcmVlbkNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gdW5pdCBvZiB3b3JrIHRhZyAoIiArIHdvcmtJblByb2dyZXNzMi50YWcgKyAiKS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtYXJrUmVmJDEod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBSZWY7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUmVmU3RhdGljOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgYXBwZW5kQWxsQ2hpbGRyZW47CiAgICAgICAgICB2YXIgdXBkYXRlSG9zdENvbnRhaW5lcjsKICAgICAgICAgIHZhciB1cGRhdGVIb3N0Q29tcG9uZW50JDE7CiAgICAgICAgICB2YXIgdXBkYXRlSG9zdFRleHQkMTsKICAgICAgICAgIHsKICAgICAgICAgICAgYXBwZW5kQWxsQ2hpbGRyZW4gPSBmdW5jdGlvbihwYXJlbnQsIHdvcmtJblByb2dyZXNzMiwgbmVlZHNWaXNpYmlsaXR5VG9nZ2xlLCBpc0hpZGRlbikgewogICAgICAgICAgICAgIHZhciBub2RlID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChub2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgbm9kZS50YWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgICAgICAgIGFwcGVuZEluaXRpYWxDaGlsZChwYXJlbnQsIG5vZGUuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS50YWcgPT09IEhvc3RQb3J0YWwpCiAgICAgICAgICAgICAgICAgIDsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKG5vZGUuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbm9kZS5jaGlsZC5yZXR1cm4gPSBub2RlOwogICAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IG5vZGUucmV0dXJuID09PSB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbm9kZS5zaWJsaW5nLnJldHVybiA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHVwZGF0ZUhvc3RDb250YWluZXIgPSBmdW5jdGlvbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHVwZGF0ZUhvc3RDb21wb25lbnQkMSA9IGZ1bmN0aW9uKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHR5cGUyLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlKSB7CiAgICAgICAgICAgICAgdmFyIG9sZFByb3BzID0gY3VycmVudDIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICBpZiAob2xkUHJvcHMgPT09IG5ld1Byb3BzKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnRIb3N0Q29udGV4dCA9IGdldEhvc3RDb250ZXh0KCk7CiAgICAgICAgICAgICAgdmFyIHVwZGF0ZVBheWxvYWQgPSBwcmVwYXJlVXBkYXRlKGluc3RhbmNlLCB0eXBlMiwgb2xkUHJvcHMsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGN1cnJlbnRIb3N0Q29udGV4dCk7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gdXBkYXRlUGF5bG9hZDsKICAgICAgICAgICAgICBpZiAodXBkYXRlUGF5bG9hZCkgewogICAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgdXBkYXRlSG9zdFRleHQkMSA9IGZ1bmN0aW9uKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG9sZFRleHQsIG5ld1RleHQpIHsKICAgICAgICAgICAgICBpZiAob2xkVGV4dCAhPT0gbmV3VGV4dCkgewogICAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgaGFzUmVuZGVyZWRBVGFpbEZhbGxiYWNrKSB7CiAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN3aXRjaCAocmVuZGVyU3RhdGUudGFpbE1vZGUpIHsKICAgICAgICAgICAgICBjYXNlICJoaWRkZW4iOiB7CiAgICAgICAgICAgICAgICB2YXIgdGFpbE5vZGUgPSByZW5kZXJTdGF0ZS50YWlsOwogICAgICAgICAgICAgICAgdmFyIGxhc3RUYWlsTm9kZSA9IG51bGw7CiAgICAgICAgICAgICAgICB3aGlsZSAodGFpbE5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgaWYgKHRhaWxOb2RlLmFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGxhc3RUYWlsTm9kZSA9IHRhaWxOb2RlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHRhaWxOb2RlID0gdGFpbE5vZGUuc2libGluZzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChsYXN0VGFpbE5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbCA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBsYXN0VGFpbE5vZGUuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSAiY29sbGFwc2VkIjogewogICAgICAgICAgICAgICAgdmFyIF90YWlsTm9kZSA9IHJlbmRlclN0YXRlLnRhaWw7CiAgICAgICAgICAgICAgICB2YXIgX2xhc3RUYWlsTm9kZSA9IG51bGw7CiAgICAgICAgICAgICAgICB3aGlsZSAoX3RhaWxOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGlmIChfdGFpbE5vZGUuYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgX2xhc3RUYWlsTm9kZSA9IF90YWlsTm9kZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBfdGFpbE5vZGUgPSBfdGFpbE5vZGUuc2libGluZzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChfbGFzdFRhaWxOb2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGlmICghaGFzUmVuZGVyZWRBVGFpbEZhbGxiYWNrICYmIHJlbmRlclN0YXRlLnRhaWwgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS50YWlsLnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWwgPSBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBfbGFzdFRhaWxOb2RlLnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBidWJibGVQcm9wZXJ0aWVzKGNvbXBsZXRlZFdvcmspIHsKICAgICAgICAgICAgdmFyIGRpZEJhaWxvdXQgPSBjb21wbGV0ZWRXb3JrLmFsdGVybmF0ZSAhPT0gbnVsbCAmJiBjb21wbGV0ZWRXb3JrLmFsdGVybmF0ZS5jaGlsZCA9PT0gY29tcGxldGVkV29yay5jaGlsZDsKICAgICAgICAgICAgdmFyIG5ld0NoaWxkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICB2YXIgc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgaWYgKCFkaWRCYWlsb3V0KSB7CiAgICAgICAgICAgICAgaWYgKChjb21wbGV0ZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgdmFyIGFjdHVhbER1cmF0aW9uID0gY29tcGxldGVkV29yay5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICAgIHZhciB0cmVlQmFzZUR1cmF0aW9uID0gY29tcGxldGVkV29yay5zZWxmQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gY29tcGxldGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBuZXdDaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhuZXdDaGlsZExhbmVzLCBtZXJnZUxhbmVzKGNoaWxkLmxhbmVzLCBjaGlsZC5jaGlsZExhbmVzKSk7CiAgICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBjaGlsZC5zdWJ0cmVlRmxhZ3M7CiAgICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBjaGlsZC5mbGFnczsKICAgICAgICAgICAgICAgICAgYWN0dWFsRHVyYXRpb24gKz0gY2hpbGQuYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgICAgICAgIHRyZWVCYXNlRHVyYXRpb24gKz0gY2hpbGQudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29tcGxldGVkV29yay5hY3R1YWxEdXJhdGlvbiA9IGFjdHVhbER1cmF0aW9uOwogICAgICAgICAgICAgICAgY29tcGxldGVkV29yay50cmVlQmFzZUR1cmF0aW9uID0gdHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIF9jaGlsZCA9IGNvbXBsZXRlZFdvcmsuY2hpbGQ7CiAgICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIG5ld0NoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKG5ld0NoaWxkTGFuZXMsIG1lcmdlTGFuZXMoX2NoaWxkLmxhbmVzLCBfY2hpbGQuY2hpbGRMYW5lcykpOwogICAgICAgICAgICAgICAgICBzdWJ0cmVlRmxhZ3MgfD0gX2NoaWxkLnN1YnRyZWVGbGFnczsKICAgICAgICAgICAgICAgICAgc3VidHJlZUZsYWdzIHw9IF9jaGlsZC5mbGFnczsKICAgICAgICAgICAgICAgICAgX2NoaWxkLnJldHVybiA9IGNvbXBsZXRlZFdvcms7CiAgICAgICAgICAgICAgICAgIF9jaGlsZCA9IF9jaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb21wbGV0ZWRXb3JrLnN1YnRyZWVGbGFncyB8PSBzdWJ0cmVlRmxhZ3M7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKChjb21wbGV0ZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgdmFyIF90cmVlQmFzZUR1cmF0aW9uID0gY29tcGxldGVkV29yay5zZWxmQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgICAgdmFyIF9jaGlsZDIgPSBjb21wbGV0ZWRXb3JrLmNoaWxkOwogICAgICAgICAgICAgICAgd2hpbGUgKF9jaGlsZDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbmV3Q2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMobmV3Q2hpbGRMYW5lcywgbWVyZ2VMYW5lcyhfY2hpbGQyLmxhbmVzLCBfY2hpbGQyLmNoaWxkTGFuZXMpKTsKICAgICAgICAgICAgICAgICAgc3VidHJlZUZsYWdzIHw9IF9jaGlsZDIuc3VidHJlZUZsYWdzICYgU3RhdGljTWFzazsKICAgICAgICAgICAgICAgICAgc3VidHJlZUZsYWdzIHw9IF9jaGlsZDIuZmxhZ3MgJiBTdGF0aWNNYXNrOwogICAgICAgICAgICAgICAgICBfdHJlZUJhc2VEdXJhdGlvbiArPSBfY2hpbGQyLnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgICAgIF9jaGlsZDIgPSBfY2hpbGQyLnNpYmxpbmc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb21wbGV0ZWRXb3JrLnRyZWVCYXNlRHVyYXRpb24gPSBfdHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIF9jaGlsZDMgPSBjb21wbGV0ZWRXb3JrLmNoaWxkOwogICAgICAgICAgICAgICAgd2hpbGUgKF9jaGlsZDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbmV3Q2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMobmV3Q2hpbGRMYW5lcywgbWVyZ2VMYW5lcyhfY2hpbGQzLmxhbmVzLCBfY2hpbGQzLmNoaWxkTGFuZXMpKTsKICAgICAgICAgICAgICAgICAgc3VidHJlZUZsYWdzIHw9IF9jaGlsZDMuc3VidHJlZUZsYWdzICYgU3RhdGljTWFzazsKICAgICAgICAgICAgICAgICAgc3VidHJlZUZsYWdzIHw9IF9jaGlsZDMuZmxhZ3MgJiBTdGF0aWNNYXNrOwogICAgICAgICAgICAgICAgICBfY2hpbGQzLnJldHVybiA9IGNvbXBsZXRlZFdvcms7CiAgICAgICAgICAgICAgICAgIF9jaGlsZDMgPSBfY2hpbGQzLnNpYmxpbmc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbXBsZXRlZFdvcmsuc3VidHJlZUZsYWdzIHw9IHN1YnRyZWVGbGFnczsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb21wbGV0ZWRXb3JrLmNoaWxkTGFuZXMgPSBuZXdDaGlsZExhbmVzOwogICAgICAgICAgICByZXR1cm4gZGlkQmFpbG91dDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNvbXBsZXRlRGVoeWRyYXRlZFN1c3BlbnNlQm91bmRhcnkoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dFN0YXRlKSB7CiAgICAgICAgICAgIGlmIChoYXNVbmh5ZHJhdGVkVGFpbE5vZGVzKCkgJiYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGUgJiYgKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgd2FybklmVW5oeWRyYXRlZFRhaWxOb2Rlcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRm9yY2VDbGllbnRSZW5kZXIgfCBJbmNvbXBsZXRlIHwgU2hvdWxkQ2FwdHVyZTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHdhc0h5ZHJhdGVkID0gcG9wSHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgaWYgKG5leHRTdGF0ZSAhPT0gbnVsbCAmJiBuZXh0U3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChjdXJyZW50MiA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKCF3YXNIeWRyYXRlZCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkEgZGVoeWRyYXRlZCBzdXNwZW5zZSBjb21wb25lbnQgd2FzIGNvbXBsZXRlZCB3aXRob3V0IGEgaHlkcmF0ZWQgbm9kZS4gVGhpcyBpcyBwcm9iYWJseSBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHByZXBhcmVUb0h5ZHJhdGVIb3N0U3VzcGVuc2VJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaXNUaW1lZE91dFN1c3BlbnNlID0gbmV4dFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgICAgIGlmIChpc1RpbWVkT3V0U3VzcGVuc2UpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgICAgICAgIGlmIChwcmltYXJ5Q2hpbGRGcmFnbWVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiAtPSBwcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlKCk7CiAgICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBfaXNUaW1lZE91dFN1c3BlbnNlID0gbmV4dFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgICAgIGlmIChfaXNUaW1lZE91dFN1c3BlbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgX3ByaW1hcnlDaGlsZEZyYWdtZW50ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICAgICAgaWYgKF9wcmltYXJ5Q2hpbGRGcmFnbWVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiAtPSBfcHJpbWFyeUNoaWxkRnJhZ21lbnQudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdXBncmFkZUh5ZHJhdGlvbkVycm9yc1RvUmVjb3ZlcmFibGUoKTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY29tcGxldGVXb3JrKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgICB2YXIgbmV3UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICBwb3BUcmVlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICBzd2l0Y2ggKHdvcmtJblByb2dyZXNzMi50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEluZGV0ZXJtaW5hdGVDb21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBMYXp5Q29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgICBjYXNlIEZyYWdtZW50OgogICAgICAgICAgICAgIGNhc2UgTW9kZToKICAgICAgICAgICAgICBjYXNlIFByb2ZpbGVyOgogICAgICAgICAgICAgIGNhc2UgQ29udGV4dENvbnN1bWVyOgogICAgICAgICAgICAgIGNhc2UgTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBDb21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICAgIGlmIChpc0NvbnRleHRQcm92aWRlcihDb21wb25lbnQpKSB7CiAgICAgICAgICAgICAgICAgIHBvcENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICB2YXIgZmliZXJSb290ID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIHBvcFRvcExldmVsQ29udGV4dE9iamVjdCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgcmVzZXRXb3JrSW5Qcm9ncmVzc1ZlcnNpb25zKCk7CiAgICAgICAgICAgICAgICBpZiAoZmliZXJSb290LnBlbmRpbmdDb250ZXh0KSB7CiAgICAgICAgICAgICAgICAgIGZpYmVyUm9vdC5jb250ZXh0ID0gZmliZXJSb290LnBlbmRpbmdDb250ZXh0OwogICAgICAgICAgICAgICAgICBmaWJlclJvb3QucGVuZGluZ0NvbnRleHQgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsIHx8IGN1cnJlbnQyLmNoaWxkID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciB3YXNIeWRyYXRlZCA9IHBvcEh5ZHJhdGlvblN0YXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIGlmICh3YXNIeWRyYXRlZCkgewogICAgICAgICAgICAgICAgICAgIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB0aGlzIGlzIGEgY2xpZW50IHJvb3QKICAgICAgICAgICAgICAgICAgICAgICAgIXByZXZTdGF0ZS5pc0RlaHlkcmF0ZWQgfHwgLy8gQ2hlY2sgaWYgd2UgcmV2ZXJ0ZWQgdG8gY2xpZW50IHJlbmRlcmluZyAoZS5nLiBkdWUgdG8gYW4gZXJyb3IpCiAgICAgICAgICAgICAgICAgICAgICAgICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBGb3JjZUNsaWVudFJlbmRlcikgIT09IE5vRmxhZ3MKICAgICAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU25hcHNob3Q7CiAgICAgICAgICAgICAgICAgICAgICAgIHVwZ3JhZGVIeWRyYXRpb25FcnJvcnNUb1JlY292ZXJhYmxlKCk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB1cGRhdGVIb3N0Q29udGFpbmVyKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgICAgcG9wSG9zdENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIHZhciByb290Q29udGFpbmVySW5zdGFuY2UgPSBnZXRSb290SG9zdENvbnRhaW5lcigpOwogICAgICAgICAgICAgICAgdmFyIHR5cGUyID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwgJiYgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHVwZGF0ZUhvc3RDb21wb25lbnQkMShjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCB0eXBlMiwgbmV3UHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Mi5yZWYgIT09IHdvcmtJblByb2dyZXNzMi5yZWYpIHsKICAgICAgICAgICAgICAgICAgICBtYXJrUmVmJDEod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgaWYgKCFuZXdQcm9wcykgewogICAgICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIldlIG11c3QgaGF2ZSBuZXcgcHJvcHMgZm9yIG5ldyBtb3VudHMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgY3VycmVudEhvc3RDb250ZXh0ID0gZ2V0SG9zdENvbnRleHQoKTsKICAgICAgICAgICAgICAgICAgdmFyIF93YXNIeWRyYXRlZCA9IHBvcEh5ZHJhdGlvblN0YXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIGlmIChfd2FzSHlkcmF0ZWQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocHJlcGFyZVRvSHlkcmF0ZUhvc3RJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgY3VycmVudEhvc3RDb250ZXh0KSkgewogICAgICAgICAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBjcmVhdGVJbnN0YW5jZSh0eXBlMiwgbmV3UHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgY3VycmVudEhvc3RDb250ZXh0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICAgIGFwcGVuZEFsbENoaWxkcmVuKGluc3RhbmNlLCB3b3JrSW5Qcm9ncmVzczIsIGZhbHNlLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9IGluc3RhbmNlOwogICAgICAgICAgICAgICAgICAgIGlmIChmaW5hbGl6ZUluaXRpYWxDaGlsZHJlbihpbnN0YW5jZSwgdHlwZTIsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgICAgICAgICBtYXJrVXBkYXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIucmVmICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya1JlZiQxKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OiB7CiAgICAgICAgICAgICAgICB2YXIgbmV3VGV4dCA9IG5ld1Byb3BzOwogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyICYmIHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgb2xkVGV4dCA9IGN1cnJlbnQyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgICAgIHVwZGF0ZUhvc3RUZXh0JDEoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgb2xkVGV4dCwgbmV3VGV4dCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld1RleHQgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiV2UgbXVzdCBoYXZlIG5ldyBwcm9wcyBmb3IgbmV3IG1vdW50cy4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIF9yb290Q29udGFpbmVySW5zdGFuY2UgPSBnZXRSb290SG9zdENvbnRhaW5lcigpOwogICAgICAgICAgICAgICAgICB2YXIgX2N1cnJlbnRIb3N0Q29udGV4dCA9IGdldEhvc3RDb250ZXh0KCk7CiAgICAgICAgICAgICAgICAgIHZhciBfd2FzSHlkcmF0ZWQyID0gcG9wSHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgICAgaWYgKF93YXNIeWRyYXRlZDIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocHJlcGFyZVRvSHlkcmF0ZUhvc3RUZXh0SW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyKSkgewogICAgICAgICAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlID0gY3JlYXRlVGV4dEluc3RhbmNlKG5ld1RleHQsIF9yb290Q29udGFpbmVySW5zdGFuY2UsIF9jdXJyZW50SG9zdENvbnRleHQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBwb3BTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIHZhciBuZXh0U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50MiA9PT0gbnVsbCB8fCBjdXJyZW50Mi5tZW1vaXplZFN0YXRlICE9PSBudWxsICYmIGN1cnJlbnQyLm1lbW9pemVkU3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgZmFsbHRocm91Z2hUb05vcm1hbFN1c3BlbnNlUGF0aCA9IGNvbXBsZXRlRGVoeWRyYXRlZFN1c3BlbnNlQm91bmRhcnkoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dFN0YXRlKTsKICAgICAgICAgICAgICAgICAgaWYgKCFmYWxsdGhyb3VnaFRvTm9ybWFsU3VzcGVuc2VQYXRoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIFNob3VsZENhcHR1cmUpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSByZW5kZXJMYW5lczI7CiAgICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICAgIHRyYW5zZmVyQWN0dWFsRHVyYXRpb24od29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG5leHREaWRUaW1lb3V0ID0gbmV4dFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgdmFyIHByZXZEaWRUaW1lb3V0ID0gY3VycmVudDIgIT09IG51bGwgJiYgY3VycmVudDIubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgIGlmIChuZXh0RGlkVGltZW91dCAhPT0gcHJldkRpZFRpbWVvdXQpIHsKICAgICAgICAgICAgICAgICAgaWYgKG5leHREaWRUaW1lb3V0KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9vZmZzY3JlZW5GaWJlcjIgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgX29mZnNjcmVlbkZpYmVyMi5mbGFncyB8PSBWaXNpYmlsaXR5OwogICAgICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGhhc0ludmlzaWJsZUNoaWxkQ29udGV4dCA9IGN1cnJlbnQyID09PSBudWxsICYmICh3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcy51bnN0YWJsZV9hdm9pZFRoaXNGYWxsYmFjayAhPT0gdHJ1ZSB8fCAhZW5hYmxlU3VzcGVuc2VBdm9pZFRoaXNGYWxsYmFjayk7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzSW52aXNpYmxlQ2hpbGRDb250ZXh0IHx8IGhhc1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQsIEludmlzaWJsZVBhcmVudFN1c3BlbnNlQ29udGV4dCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVyRGlkU3VzcGVuZCgpOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVyRGlkU3VzcGVuZERlbGF5SWZQb3NzaWJsZSgpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHdha2VhYmxlcyA9IHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgIGlmICh3YWtlYWJsZXMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG5leHREaWRUaW1lb3V0KSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgICBpZiAocHJpbWFyeUNoaWxkRnJhZ21lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRyZWVCYXNlRHVyYXRpb24gLT0gcHJpbWFyeUNoaWxkRnJhZ21lbnQudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6CiAgICAgICAgICAgICAgICBwb3BIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB1cGRhdGVIb3N0Q29udGFpbmVyKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHByZXBhcmVQb3J0YWxNb3VudCh3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgY2FzZSBDb250ZXh0UHJvdmlkZXI6CiAgICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IHdvcmtJblByb2dyZXNzMi50eXBlLl9jb250ZXh0OwogICAgICAgICAgICAgICAgcG9wUHJvdmlkZXIoY29udGV4dCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIGNhc2UgSW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgX0NvbXBvbmVudCA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKF9Db21wb25lbnQpKSB7CiAgICAgICAgICAgICAgICAgIHBvcENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDogewogICAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB2YXIgcmVuZGVyU3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGRpZFN1c3BlbmRBbHJlYWR5ID0gKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzOwogICAgICAgICAgICAgICAgdmFyIHJlbmRlcmVkVGFpbCA9IHJlbmRlclN0YXRlLnJlbmRlcmluZzsKICAgICAgICAgICAgICAgIGlmIChyZW5kZXJlZFRhaWwgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFkaWRTdXNwZW5kQWxyZWFkeSkgewogICAgICAgICAgICAgICAgICAgIHZhciBjYW5ub3RCZVN1c3BlbmRlZCA9IHJlbmRlckhhc05vdFN1c3BlbmRlZFlldCgpICYmIChjdXJyZW50MiA9PT0gbnVsbCB8fCAoY3VycmVudDIuZmxhZ3MgJiBEaWRDYXB0dXJlKSA9PT0gTm9GbGFncyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFjYW5ub3RCZVN1c3BlbmRlZCkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIHJvdyA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChyb3cgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN1c3BlbmRlZCA9IGZpbmRGaXJzdFN1c3BlbmRlZChyb3cpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3VzcGVuZGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZGlkU3VzcGVuZEFscmVhZHkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgICAgICAgICAgIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdUaGVuYWJsZXMgPSBzdXNwZW5kZWQudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5ld1RoZW5hYmxlcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbmV3VGhlbmFibGVzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN1YnRyZWVGbGFncyA9IE5vRmxhZ3M7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzZXRDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcHVzaFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHNldFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50LCBGb3JjZVN1c3BlbnNlRmFsbGJhY2spKTsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJvdyA9IHJvdy5zaWJsaW5nOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAocmVuZGVyU3RhdGUudGFpbCAhPT0gbnVsbCAmJiBub3cyKCkgPiBnZXRSZW5kZXJUYXJnZXRUaW1lKCkpIHsKICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgICAgICAgZGlkU3VzcGVuZEFscmVhZHkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgY3V0T2ZmVGFpbElmTmVlZGVkKHJlbmRlclN0YXRlLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBTb21lUmV0cnlMYW5lOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdXRPZmZUYWlsSWZOZWVkZWQocmVuZGVyU3RhdGUsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgaWYgKCFkaWRTdXNwZW5kQWxyZWFkeSkgewogICAgICAgICAgICAgICAgICAgIHZhciBfc3VzcGVuZGVkID0gZmluZEZpcnN0U3VzcGVuZGVkKHJlbmRlcmVkVGFpbCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9zdXNwZW5kZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgICAgICAgZGlkU3VzcGVuZEFscmVhZHkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgdmFyIF9uZXdUaGVuYWJsZXMgPSBfc3VzcGVuZGVkLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgICAgICAgICAgaWYgKF9uZXdUaGVuYWJsZXMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gX25ld1RoZW5hYmxlczsKICAgICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICBpZiAocmVuZGVyU3RhdGUudGFpbCA9PT0gbnVsbCAmJiByZW5kZXJTdGF0ZS50YWlsTW9kZSA9PT0gImhpZGRlbiIgJiYgIXJlbmRlcmVkVGFpbC5hbHRlcm5hdGUgJiYgIWdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICAgICAgICAgICAgLy8gVGhlIHRpbWUgaXQgdG9vayB0byByZW5kZXIgbGFzdCByb3cgaXMgZ3JlYXRlciB0aGFuIHRoZSByZW1haW5pbmcKICAgICAgICAgICAgICAgICAgICAgIC8vIHRpbWUgd2UgaGF2ZSB0byByZW5kZXIuIFNvIHJlbmRlcmluZyBvbmUgbW9yZSByb3cgd291bGQgbGlrZWx5CiAgICAgICAgICAgICAgICAgICAgICAvLyBleGNlZWQgaXQuCiAgICAgICAgICAgICAgICAgICAgICBub3cyKCkgKiAyIC0gcmVuZGVyU3RhdGUucmVuZGVyaW5nU3RhcnRUaW1lID4gZ2V0UmVuZGVyVGFyZ2V0VGltZSgpICYmIHJlbmRlckxhbmVzMiAhPT0gT2Zmc2NyZWVuTGFuZQogICAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgICAgICBkaWRTdXNwZW5kQWxyZWFkeSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICBjdXRPZmZUYWlsSWZOZWVkZWQocmVuZGVyU3RhdGUsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IFNvbWVSZXRyeUxhbmU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZS5pc0JhY2t3YXJkcykgewogICAgICAgICAgICAgICAgICAgIHJlbmRlcmVkVGFpbC5zaWJsaW5nID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlbmRlcmVkVGFpbDsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJldmlvdXNTaWJsaW5nID0gcmVuZGVyU3RhdGUubGFzdDsKICAgICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNTaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c1NpYmxpbmcuc2libGluZyA9IHJlbmRlcmVkVGFpbDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcmVuZGVyZWRUYWlsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS5sYXN0ID0gcmVuZGVyZWRUYWlsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocmVuZGVyU3RhdGUudGFpbCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgbmV4dCA9IHJlbmRlclN0YXRlLnRhaWw7CiAgICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnJlbmRlcmluZyA9IG5leHQ7CiAgICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWwgPSBuZXh0LnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnJlbmRlcmluZ1N0YXJ0VGltZSA9IG5vdzIoKTsKICAgICAgICAgICAgICAgICAgbmV4dC5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgICAgdmFyIHN1c3BlbnNlQ29udGV4dCA9IHN1c3BlbnNlU3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgICAgICAgICAgICAgaWYgKGRpZFN1c3BlbmRBbHJlYWR5KSB7CiAgICAgICAgICAgICAgICAgICAgc3VzcGVuc2VDb250ZXh0ID0gc2V0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQsIEZvcmNlU3VzcGVuc2VGYWxsYmFjayk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgc3VzcGVuc2VDb250ZXh0ID0gc2V0RGVmYXVsdFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG5leHQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBTY29wZUNvbXBvbmVudDogewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgTGVnYWN5SGlkZGVuQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBwb3BSZW5kZXJMYW5lcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgdmFyIF9uZXh0U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgIHZhciBuZXh0SXNIaWRkZW4gPSBfbmV4dFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfcHJldlN0YXRlID0gY3VycmVudDIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgICAgdmFyIHByZXZJc0hpZGRlbiA9IF9wcmV2U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICAgIGlmIChwcmV2SXNIaWRkZW4gIT09IG5leHRJc0hpZGRlbiAmJiAvLyBMZWdhY3lIaWRkZW4gZG9lc24ndCBkbyBhbnkgaGlkaW5nIOKAlCBpdCBvbmx5IHByZS1yZW5kZXJzLgogICAgICAgICAgICAgICAgICAhZW5hYmxlTGVnYWN5SGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFZpc2liaWxpdHk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICghbmV4dElzSGlkZGVuIHx8ICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlc1NvbWVMYW5lKHN1YnRyZWVSZW5kZXJMYW5lcywgT2Zmc2NyZWVuTGFuZSkpIHsKICAgICAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5zdWJ0cmVlRmxhZ3MgJiAoUGxhY2VtZW50IHwgVXBkYXRlKSkgewogICAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVmlzaWJpbGl0eTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENhY2hlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBUcmFjaW5nTWFya2VyQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIHVuaXQgb2Ygd29yayB0YWcgKCIgKyB3b3JrSW5Qcm9ncmVzczIudGFnICsgIikuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1bndpbmRXb3JrKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgICBwb3BUcmVlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICBzd2l0Y2ggKHdvcmtJblByb2dyZXNzMi50YWcpIHsKICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgICAgICBwb3BDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgZmxhZ3MgPSB3b3JrSW5Qcm9ncmVzczIuZmxhZ3M7CiAgICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBTaG91bGRDYXB0dXJlKSB7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyA9IGZsYWdzICYgflNob3VsZENhcHR1cmUgfCBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgICAgICB0cmFuc2ZlckFjdHVhbER1cmF0aW9uKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgcG9wSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgcG9wVG9wTGV2ZWxDb250ZXh0T2JqZWN0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICByZXNldFdvcmtJblByb2dyZXNzVmVyc2lvbnMoKTsKICAgICAgICAgICAgICAgIHZhciBfZmxhZ3MgPSB3b3JrSW5Qcm9ncmVzczIuZmxhZ3M7CiAgICAgICAgICAgICAgICBpZiAoKF9mbGFncyAmIFNob3VsZENhcHR1cmUpICE9PSBOb0ZsYWdzICYmIChfZmxhZ3MgJiBEaWRDYXB0dXJlKSA9PT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgPSBfZmxhZ3MgJiB+U2hvdWxkQ2FwdHVyZSB8IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBwb3BIb3N0Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHBvcFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlICE9PSBudWxsICYmIHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLmFsdGVybmF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhyZXcgaW4gbmV3bHkgbW91bnRlZCBkZWh5ZHJhdGVkIGNvbXBvbmVudC4gVGhpcyBpcyBsaWtlbHkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBfZmxhZ3MyID0gd29ya0luUHJvZ3Jlc3MyLmZsYWdzOwogICAgICAgICAgICAgICAgaWYgKF9mbGFnczIgJiBTaG91bGRDYXB0dXJlKSB7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyA9IF9mbGFnczIgJiB+U2hvdWxkQ2FwdHVyZSB8IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICAgIHRyYW5zZmVyQWN0dWFsRHVyYXRpb24od29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBwb3BTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6CiAgICAgICAgICAgICAgICBwb3BIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICBjYXNlIENvbnRleHRQcm92aWRlcjoKICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGUuX2NvbnRleHQ7CiAgICAgICAgICAgICAgICBwb3BQcm92aWRlcihjb250ZXh0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBMZWdhY3lIaWRkZW5Db21wb25lbnQ6CiAgICAgICAgICAgICAgICBwb3BSZW5kZXJMYW5lcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgY2FzZSBDYWNoZUNvbXBvbmVudDoKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdW53aW5kSW50ZXJydXB0ZWRXb3JrKGN1cnJlbnQyLCBpbnRlcnJ1cHRlZFdvcmssIHJlbmRlckxhbmVzMikgewogICAgICAgICAgICBwb3BUcmVlQ29udGV4dChpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICBzd2l0Y2ggKGludGVycnVwdGVkV29yay50YWcpIHsKICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgY2hpbGRDb250ZXh0VHlwZXMgPSBpbnRlcnJ1cHRlZFdvcmsudHlwZS5jaGlsZENvbnRleHRUeXBlczsKICAgICAgICAgICAgICAgIGlmIChjaGlsZENvbnRleHRUeXBlcyAhPT0gbnVsbCAmJiBjaGlsZENvbnRleHRUeXBlcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgIHBvcENvbnRleHQoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBpbnRlcnJ1cHRlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgcG9wSG9zdENvbnRhaW5lcihpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgICAgcG9wVG9wTGV2ZWxDb250ZXh0T2JqZWN0KGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgICByZXNldFdvcmtJblByb2dyZXNzVmVyc2lvbnMoKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHBvcEhvc3RDb250ZXh0KGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgICAgcG9wSG9zdENvbnRhaW5lcihpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDoKICAgICAgICAgICAgICAgIHBvcFN1c3BlbnNlQ29udGV4dChpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgICBwb3BTdXNwZW5zZUNvbnRleHQoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgQ29udGV4dFByb3ZpZGVyOgogICAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSBpbnRlcnJ1cHRlZFdvcmsudHlwZS5fY29udGV4dDsKICAgICAgICAgICAgICAgIHBvcFByb3ZpZGVyKGNvbnRleHQsIGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIExlZ2FjeUhpZGRlbkNvbXBvbmVudDoKICAgICAgICAgICAgICAgIHBvcFJlbmRlckxhbmVzKGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGRpZFdhcm5BYm91dFVuZGVmaW5lZFNuYXBzaG90QmVmb3JlVXBkYXRlID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgZGlkV2FybkFib3V0VW5kZWZpbmVkU25hcHNob3RCZWZvcmVVcGRhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG9mZnNjcmVlblN1YnRyZWVJc0hpZGRlbiA9IGZhbHNlOwogICAgICAgICAgdmFyIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBmYWxzZTsKICAgICAgICAgIHZhciBQb3NzaWJseVdlYWtTZXQgPSB0eXBlb2YgV2Vha1NldCA9PT0gImZ1bmN0aW9uIiA/IFdlYWtTZXQgOiBTZXQ7CiAgICAgICAgICB2YXIgbmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgICB2YXIgaW5Qcm9ncmVzc0xhbmVzID0gbnVsbDsKICAgICAgICAgIHZhciBpblByb2dyZXNzUm9vdCA9IG51bGw7CiAgICAgICAgICBmdW5jdGlvbiByZXBvcnRVbmNhdWdodEVycm9ySW5ERVYoZXJyb3IyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpbnZva2VHdWFyZGVkQ2FsbGJhY2sobnVsbCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgY2xlYXJDYXVnaHRFcnJvcigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY2FsbENvbXBvbmVudFdpbGxVbm1vdW50V2l0aFRpbWVyID0gZnVuY3Rpb24oY3VycmVudDIsIGluc3RhbmNlKSB7CiAgICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gY3VycmVudDIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICBpZiAoY3VycmVudDIubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHN0YXJ0TGF5b3V0RWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVbm1vdW50KCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGN1cnJlbnQyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVubW91bnQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIGZ1bmN0aW9uIHNhZmVseUNhbGxDb21taXRIb29rTGF5b3V0RWZmZWN0TGlzdE1vdW50KGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChMYXlvdXQsIGN1cnJlbnQyKTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY3VycmVudDIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHNhZmVseUNhbGxDb21wb25lbnRXaWxsVW5tb3VudChjdXJyZW50MiwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgaW5zdGFuY2UpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBjYWxsQ29tcG9uZW50V2lsbFVubW91bnRXaXRoVGltZXIoY3VycmVudDIsIGluc3RhbmNlKTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY3VycmVudDIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHNhZmVseUNhbGxDb21wb25lbnREaWRNb3VudChjdXJyZW50MiwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgaW5zdGFuY2UpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCgpOwogICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihjdXJyZW50MiwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZXJyb3IyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gc2FmZWx5QXR0YWNoUmVmKGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgY29tbWl0QXR0YWNoUmVmKGN1cnJlbnQyKTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY3VycmVudDIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHNhZmVseURldGFjaFJlZihjdXJyZW50MiwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvcikgewogICAgICAgICAgICB2YXIgcmVmID0gY3VycmVudDIucmVmOwogICAgICAgICAgICBpZiAocmVmICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZWYgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHZhciByZXRWYWw7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBpZiAoZW5hYmxlUHJvZmlsZXJUaW1lciAmJiBlbmFibGVQcm9maWxlckNvbW1pdEhvb2tzICYmIGN1cnJlbnQyLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgICByZXRWYWwgPSByZWYobnVsbCk7CiAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGN1cnJlbnQyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0VmFsID0gcmVmKG51bGwpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY3VycmVudDIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmV0VmFsID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIlVuZXhwZWN0ZWQgcmV0dXJuIHZhbHVlIGZyb20gYSBjYWxsYmFjayByZWYgaW4gJXMuIEEgY2FsbGJhY2sgcmVmIHNob3VsZCBub3QgcmV0dXJuIGEgZnVuY3Rpb24uIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihjdXJyZW50MikpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlZi5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHNhZmVseUNhbGxEZXN0cm95KGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZXN0cm95KSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgZGVzdHJveSgpOwogICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihjdXJyZW50MiwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZXJyb3IyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGZvY3VzZWRJbnN0YW5jZUhhbmRsZSA9IG51bGw7CiAgICAgICAgICB2YXIgc2hvdWxkRmlyZUFmdGVyQWN0aXZlSW5zdGFuY2VCbHVyID0gZmFsc2U7CiAgICAgICAgICBmdW5jdGlvbiBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgZm9jdXNlZEluc3RhbmNlSGFuZGxlID0gcHJlcGFyZUZvckNvbW1pdChyb290My5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIGNvbW1pdEJlZm9yZU11dGF0aW9uRWZmZWN0c19iZWdpbigpOwogICAgICAgICAgICB2YXIgc2hvdWxkRmlyZSA9IHNob3VsZEZpcmVBZnRlckFjdGl2ZUluc3RhbmNlQmx1cjsKICAgICAgICAgICAgc2hvdWxkRmlyZUFmdGVyQWN0aXZlSW5zdGFuY2VCbHVyID0gZmFsc2U7CiAgICAgICAgICAgIGZvY3VzZWRJbnN0YW5jZUhhbmRsZSA9IG51bGw7CiAgICAgICAgICAgIHJldHVybiBzaG91bGRGaXJlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzX2JlZ2luKCkgewogICAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgICAgdmFyIGNoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgICAgaWYgKChmaWJlci5zdWJ0cmVlRmxhZ3MgJiBCZWZvcmVNdXRhdGlvbk1hc2spICE9PSBOb0ZsYWdzICYmIGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBjaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBjaGlsZDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzX2NvbXBsZXRlKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHNfY29tcGxldGUoKSB7CiAgICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHNPbkZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBmaWJlci5zaWJsaW5nOwogICAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBzaWJsaW5nOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHNPbkZpYmVyKGZpbmlzaGVkV29yaykgewogICAgICAgICAgICB2YXIgY3VycmVudDIgPSBmaW5pc2hlZFdvcmsuYWx0ZXJuYXRlOwogICAgICAgICAgICB2YXIgZmxhZ3MgPSBmaW5pc2hlZFdvcmsuZmxhZ3M7CiAgICAgICAgICAgIGlmICgoZmxhZ3MgJiBTbmFwc2hvdCkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBwcmV2UHJvcHMgPSBjdXJyZW50Mi5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay50eXBlID09PSBmaW5pc2hlZFdvcmsuZWxlbWVudFR5cGUgJiYgIWRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnByb3BzICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCAlcyBwcm9wcyB0byBtYXRjaCBtZW1vaXplZCBwcm9wcyBiZWZvcmUgZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUuIFRoaXMgbWlnaHQgZWl0aGVyIGJlIGJlY2F1c2Ugb2YgYSBidWcgaW4gUmVhY3QsIG9yIGJlY2F1c2UgYSBjb21wb25lbnQgcmVhc3NpZ25zIGl0cyBvd24gYHRoaXMucHJvcHNgLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykgfHwgImluc3RhbmNlIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnN0YXRlICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCAlcyBzdGF0ZSB0byBtYXRjaCBtZW1vaXplZCBzdGF0ZSBiZWZvcmUgZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUuIFRoaXMgbWlnaHQgZWl0aGVyIGJlIGJlY2F1c2Ugb2YgYSBidWcgaW4gUmVhY3QsIG9yIGJlY2F1c2UgYSBjb21wb25lbnQgcmVhc3NpZ25zIGl0cyBvd24gYHRoaXMuc3RhdGVgLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykgfHwgImluc3RhbmNlIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdmFyIHNuYXBzaG90ID0gaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUoZmluaXNoZWRXb3JrLmVsZW1lbnRUeXBlID09PSBmaW5pc2hlZFdvcmsudHlwZSA/IHByZXZQcm9wcyA6IHJlc29sdmVEZWZhdWx0UHJvcHMoZmluaXNoZWRXb3JrLnR5cGUsIHByZXZQcm9wcyksIHByZXZTdGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGRpZFdhcm5TZXQgPSBkaWRXYXJuQWJvdXRVbmRlZmluZWRTbmFwc2hvdEJlZm9yZVVwZGF0ZTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChzbmFwc2hvdCA9PT0gdm9pZCAwICYmICFkaWRXYXJuU2V0LmhhcyhmaW5pc2hlZFdvcmsudHlwZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGlkV2FyblNldC5hZGQoZmluaXNoZWRXb3JrLnR5cGUpOwogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiJXMuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUoKTogQSBzbmFwc2hvdCB2YWx1ZSAob3IgbnVsbCkgbXVzdCBiZSByZXR1cm5lZC4gWW91IGhhdmUgcmV0dXJuZWQgdW5kZWZpbmVkLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbFNuYXBzaG90QmVmb3JlVXBkYXRlID0gc25hcHNob3Q7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICAgIGNsZWFyQ29udGFpbmVyKHJvb3QzLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDoKICAgICAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICAgIGNhc2UgSW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGlzIHVuaXQgb2Ygd29yayB0YWcgc2hvdWxkIG5vdCBoYXZlIHNpZGUtZWZmZWN0cy4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KGZsYWdzLCBmaW5pc2hlZFdvcmssIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpIHsKICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICB2YXIgbGFzdEVmZmVjdCA9IHVwZGF0ZVF1ZXVlICE9PSBudWxsID8gdXBkYXRlUXVldWUubGFzdEVmZmVjdCA6IG51bGw7CiAgICAgICAgICAgIGlmIChsYXN0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGZpcnN0RWZmZWN0ID0gbGFzdEVmZmVjdC5uZXh0OwogICAgICAgICAgICAgIHZhciBlZmZlY3QgPSBmaXJzdEVmZmVjdDsKICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICBpZiAoKGVmZmVjdC50YWcgJiBmbGFncykgPT09IGZsYWdzKSB7CiAgICAgICAgICAgICAgICAgIHZhciBkZXN0cm95ID0gZWZmZWN0LmRlc3Ryb3k7CiAgICAgICAgICAgICAgICAgIGVmZmVjdC5kZXN0cm95ID0gdm9pZCAwOwogICAgICAgICAgICAgICAgICBpZiAoZGVzdHJveSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgaWYgKChmbGFncyAmIFBhc3NpdmUkMSkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdFVubW91bnRTdGFydGVkKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChmbGFncyAmIExheW91dCkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0YXJ0ZWQoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgaWYgKChmbGFncyAmIEluc2VydGlvbikgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgICBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QodHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxEZXN0cm95KGZpbmlzaGVkV29yaywgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVzdHJveSk7CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgaWYgKChmbGFncyAmIEluc2VydGlvbikgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgICBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgUGFzc2l2ZSQxKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGZsYWdzICYgTGF5b3V0KSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWZmZWN0ID0gZWZmZWN0Lm5leHQ7CiAgICAgICAgICAgICAgfSB3aGlsZSAoZWZmZWN0ICE9PSBmaXJzdEVmZmVjdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNvbW1pdEhvb2tFZmZlY3RMaXN0TW91bnQoZmxhZ3MsIGZpbmlzaGVkV29yaykgewogICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWU7CiAgICAgICAgICAgIHZhciBsYXN0RWZmZWN0ID0gdXBkYXRlUXVldWUgIT09IG51bGwgPyB1cGRhdGVRdWV1ZS5sYXN0RWZmZWN0IDogbnVsbDsKICAgICAgICAgICAgaWYgKGxhc3RFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgZmlyc3RFZmZlY3QgPSBsYXN0RWZmZWN0Lm5leHQ7CiAgICAgICAgICAgICAgdmFyIGVmZmVjdCA9IGZpcnN0RWZmZWN0OwogICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgIGlmICgoZWZmZWN0LnRhZyAmIGZsYWdzKSA9PT0gZmxhZ3MpIHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICgoZmxhZ3MgJiBQYXNzaXZlJDEpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0TW91bnRTdGFydGVkKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoZmxhZ3MgJiBMYXlvdXQpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0YXJ0ZWQoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIGNyZWF0ZTIgPSBlZmZlY3QuY3JlYXRlOwogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKChmbGFncyAmIEluc2VydGlvbikgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgc2V0SXNSdW5uaW5nSW5zZXJ0aW9uRWZmZWN0KHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlZmZlY3QuZGVzdHJveSA9IGNyZWF0ZTIoKTsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICgoZmxhZ3MgJiBJbnNlcnRpb24pICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgIHNldElzUnVubmluZ0luc2VydGlvbkVmZmVjdChmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgUGFzc2l2ZSQxKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGZsYWdzICYgTGF5b3V0KSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdG9wcGVkKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZGVzdHJveSA9IGVmZmVjdC5kZXN0cm95OwogICAgICAgICAgICAgICAgICAgIGlmIChkZXN0cm95ICE9PSB2b2lkIDAgJiYgdHlwZW9mIGRlc3Ryb3kgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBob29rTmFtZSA9IHZvaWQgMDsKICAgICAgICAgICAgICAgICAgICAgIGlmICgoZWZmZWN0LnRhZyAmIExheW91dCkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaG9va05hbWUgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGVmZmVjdC50YWcgJiBJbnNlcnRpb24pICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGhvb2tOYW1lID0gInVzZUluc2VydGlvbkVmZmVjdCI7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBob29rTmFtZSA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgdmFyIGFkZGVuZHVtID0gdm9pZCAwOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGRlc3Ryb3kgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIFlvdSByZXR1cm5lZCBudWxsLiBJZiB5b3VyIGVmZmVjdCBkb2VzIG5vdCByZXF1aXJlIGNsZWFuIHVwLCByZXR1cm4gdW5kZWZpbmVkIChvciBub3RoaW5nKS4iOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZGVzdHJveS50aGVuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIlxuXG5JdCBsb29rcyBsaWtlIHlvdSB3cm90ZSAiICsgaG9va05hbWUgKyAiKGFzeW5jICgpID0+IC4uLikgb3IgcmV0dXJuZWQgYSBQcm9taXNlLiBJbnN0ZWFkLCB3cml0ZSB0aGUgYXN5bmMgZnVuY3Rpb24gaW5zaWRlIHlvdXIgZWZmZWN0IGFuZCBjYWxsIGl0IGltbWVkaWF0ZWx5OlxuXG4iICsgaG9va05hbWUgKyAiKCgpID0+IHtcbiAgYXN5bmMgZnVuY3Rpb24gZmV0Y2hEYXRhKCkge1xuICAgIC8vIFlvdSBjYW4gYXdhaXQgaGVyZVxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgTXlBUEkuZ2V0RGF0YShzb21lSWQpO1xuICAgIC8vIC4uLlxuICB9XG4gIGZldGNoRGF0YSgpO1xufSwgW3NvbWVJZF0pOyAvLyBPciBbXSBpZiBlZmZlY3QgZG9lc24ndCBuZWVkIHByb3BzIG9yIHN0YXRlXG5cbkxlYXJuIG1vcmUgYWJvdXQgZGF0YSBmZXRjaGluZyB3aXRoIEhvb2tzOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaG9va3MtZGF0YS1mZXRjaGluZyI7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBhZGRlbmR1bSA9ICIgWW91IHJldHVybmVkOiAiICsgZGVzdHJveTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCIlcyBtdXN0IG5vdCByZXR1cm4gYW55dGhpbmcgYmVzaWRlcyBhIGZ1bmN0aW9uLCB3aGljaCBpcyB1c2VkIGZvciBjbGVhbi11cC4lcyIsIGhvb2tOYW1lLCBhZGRlbmR1bSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlZmZlY3QgPSBlZmZlY3QubmV4dDsKICAgICAgICAgICAgICB9IHdoaWxlIChlZmZlY3QgIT09IGZpcnN0RWZmZWN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZUVmZmVjdER1cmF0aW9ucyhmaW5pc2hlZFJvb3QsIGZpbmlzaGVkV29yaykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKChmaW5pc2hlZFdvcmsuZmxhZ3MgJiBVcGRhdGUpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBQcm9maWxlcjogewogICAgICAgICAgICAgICAgICAgIHZhciBwYXNzaXZlRWZmZWN0RHVyYXRpb24gPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlLnBhc3NpdmVFZmZlY3REdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICB2YXIgX2ZpbmlzaGVkV29yayRtZW1vaXplID0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMsIGlkMiA9IF9maW5pc2hlZFdvcmskbWVtb2l6ZS5pZCwgb25Qb3N0Q29tbWl0ID0gX2ZpbmlzaGVkV29yayRtZW1vaXplLm9uUG9zdENvbW1pdDsKICAgICAgICAgICAgICAgICAgICB2YXIgY29tbWl0VGltZTIgPSBnZXRDb21taXRUaW1lKCk7CiAgICAgICAgICAgICAgICAgICAgdmFyIHBoYXNlID0gZmluaXNoZWRXb3JrLmFsdGVybmF0ZSA9PT0gbnVsbCA/ICJtb3VudCIgOiAidXBkYXRlIjsKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNDdXJyZW50VXBkYXRlTmVzdGVkKCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGhhc2UgPSAibmVzdGVkLXVwZGF0ZSI7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb25Qb3N0Q29tbWl0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICBvblBvc3RDb21taXQoaWQyLCBwaGFzZSwgcGFzc2l2ZUVmZmVjdER1cmF0aW9uLCBjb21taXRUaW1lMik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRGaWJlciA9IGZpbmlzaGVkV29yay5yZXR1cm47CiAgICAgICAgICAgICAgICAgICAgb3V0ZXI6CiAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAocGFyZW50RmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChwYXJlbnRGaWJlci50YWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcm9vdDMucGFzc2l2ZUVmZmVjdER1cmF0aW9uICs9IHBhc3NpdmVFZmZlY3REdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIG91dGVyOwogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50U3RhdGVOb2RlID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50U3RhdGVOb2RlLnBhc3NpdmVFZmZlY3REdXJhdGlvbiArPSBwYXNzaXZlRWZmZWN0RHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRGaWJlciA9IHBhcmVudEZpYmVyLnJldHVybjsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY29tbWl0TGF5b3V0RWZmZWN0T25GaWJlcihmaW5pc2hlZFJvb3QsIGN1cnJlbnQyLCBmaW5pc2hlZFdvcmssIGNvbW1pdHRlZExhbmVzKSB7CiAgICAgICAgICAgIGlmICgoZmluaXNoZWRXb3JrLmZsYWdzICYgTGF5b3V0TWFzaykgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgICAgaWYgKCFvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0TGF5b3V0RWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChMYXlvdXQgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KExheW91dCB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsuZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIW9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50MiA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay50eXBlID09PSBmaW5pc2hlZFdvcmsuZWxlbWVudFR5cGUgJiYgIWRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5wcm9wcyAhPT0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHByb3BzIHRvIG1hdGNoIG1lbW9pemVkIHByb3BzIGJlZm9yZSBjb21wb25lbnREaWRNb3VudC4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5wcm9wc2AuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5zdGF0ZSAhPT0gZmluaXNoZWRXb3JrLm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHN0YXRlIHRvIG1hdGNoIG1lbW9pemVkIHN0YXRlIGJlZm9yZSBjb21wb25lbnREaWRNb3VudC4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5zdGF0ZWAuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGZpbmlzaGVkV29yay5lbGVtZW50VHlwZSA9PT0gZmluaXNoZWRXb3JrLnR5cGUgPyBjdXJyZW50Mi5tZW1vaXplZFByb3BzIDogcmVzb2x2ZURlZmF1bHRQcm9wcyhmaW5pc2hlZFdvcmsudHlwZSwgY3VycmVudDIubWVtb2l6ZWRQcm9wcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay50eXBlID09PSBmaW5pc2hlZFdvcmsuZWxlbWVudFR5cGUgJiYgIWRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5wcm9wcyAhPT0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHByb3BzIHRvIG1hdGNoIG1lbW9pemVkIHByb3BzIGJlZm9yZSBjb21wb25lbnREaWRVcGRhdGUuIFRoaXMgbWlnaHQgZWl0aGVyIGJlIGJlY2F1c2Ugb2YgYSBidWcgaW4gUmVhY3QsIG9yIGJlY2F1c2UgYSBjb21wb25lbnQgcmVhc3NpZ25zIGl0cyBvd24gYHRoaXMucHJvcHNgLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykgfHwgImluc3RhbmNlIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2Uuc3RhdGUgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCAlcyBzdGF0ZSB0byBtYXRjaCBtZW1vaXplZCBzdGF0ZSBiZWZvcmUgY29tcG9uZW50RGlkVXBkYXRlLiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnN0YXRlYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnREaWRVcGRhdGUocHJldlByb3BzLCBwcmV2U3RhdGUsIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbFNuYXBzaG90QmVmb3JlVXBkYXRlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlKHByZXZQcm9wcywgcHJldlN0YXRlLCBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxTbmFwc2hvdEJlZm9yZVVwZGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgICAgICBpZiAodXBkYXRlUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLnR5cGUgPT09IGZpbmlzaGVkV29yay5lbGVtZW50VHlwZSAmJiAhZGlkV2FybkFib3V0UmVhc3NpZ25pbmdQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UucHJvcHMgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHByb3BzIHRvIG1hdGNoIG1lbW9pemVkIHByb3BzIGJlZm9yZSBwcm9jZXNzaW5nIHRoZSB1cGRhdGUgcXVldWUuIFRoaXMgbWlnaHQgZWl0aGVyIGJlIGJlY2F1c2Ugb2YgYSBidWcgaW4gUmVhY3QsIG9yIGJlY2F1c2UgYSBjb21wb25lbnQgcmVhc3NpZ25zIGl0cyBvd24gYHRoaXMucHJvcHNgLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykgfHwgImluc3RhbmNlIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnN0YXRlICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCAlcyBzdGF0ZSB0byBtYXRjaCBtZW1vaXplZCBzdGF0ZSBiZWZvcmUgcHJvY2Vzc2luZyB0aGUgdXBkYXRlIHF1ZXVlLiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnN0YXRlYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNvbW1pdFVwZGF0ZVF1ZXVlKGZpbmlzaGVkV29yaywgdXBkYXRlUXVldWUsIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICAgICAgdmFyIF91cGRhdGVRdWV1ZSA9IGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgICAgaWYgKF91cGRhdGVRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBfaW5zdGFuY2UgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoZmluaXNoZWRXb3JrLmNoaWxkLnRhZykgewogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgX2luc3RhbmNlID0gZ2V0UHVibGljSW5zdGFuY2UoZmluaXNoZWRXb3JrLmNoaWxkLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgX2luc3RhbmNlID0gZmluaXNoZWRXb3JrLmNoaWxkLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY29tbWl0VXBkYXRlUXVldWUoZmluaXNoZWRXb3JrLCBfdXBkYXRlUXVldWUsIF9pbnN0YW5jZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgICAgdmFyIF9pbnN0YW5jZTIgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwgJiYgZmluaXNoZWRXb3JrLmZsYWdzICYgVXBkYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHR5cGUyID0gZmluaXNoZWRXb3JrLnR5cGU7CiAgICAgICAgICAgICAgICAgICAgdmFyIHByb3BzID0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0TW91bnQoX2luc3RhbmNlMiwgdHlwZTIsIHByb3BzKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6IHsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6IHsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIFByb2ZpbGVyOiB7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX2ZpbmlzaGVkV29yayRtZW1vaXplMiA9IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzLCBvbkNvbW1pdCA9IF9maW5pc2hlZFdvcmskbWVtb2l6ZTIub25Db21taXQsIG9uUmVuZGVyID0gX2ZpbmlzaGVkV29yayRtZW1vaXplMi5vblJlbmRlcjsKICAgICAgICAgICAgICAgICAgICB2YXIgZWZmZWN0RHVyYXRpb24gPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlLmVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgIHZhciBjb21taXRUaW1lMiA9IGdldENvbW1pdFRpbWUoKTsKICAgICAgICAgICAgICAgICAgICB2YXIgcGhhc2UgPSBjdXJyZW50MiA9PT0gbnVsbCA/ICJtb3VudCIgOiAidXBkYXRlIjsKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNDdXJyZW50VXBkYXRlTmVzdGVkKCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGhhc2UgPSAibmVzdGVkLXVwZGF0ZSI7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb25SZW5kZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgIG9uUmVuZGVyKGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzLmlkLCBwaGFzZSwgZmluaXNoZWRXb3JrLmFjdHVhbER1cmF0aW9uLCBmaW5pc2hlZFdvcmsudHJlZUJhc2VEdXJhdGlvbiwgZmluaXNoZWRXb3JrLmFjdHVhbFN0YXJ0VGltZSwgY29tbWl0VGltZTIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9uQ29tbWl0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG9uQ29tbWl0KGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzLmlkLCBwaGFzZSwgZWZmZWN0RHVyYXRpb24sIGNvbW1pdFRpbWUyKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGVucXVldWVQZW5kaW5nUGFzc2l2ZVByb2ZpbGVyRWZmZWN0KGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50RmliZXIgPSBmaW5pc2hlZFdvcmsucmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgb3V0ZXI6CiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChwYXJlbnRGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAocGFyZW50RmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJvb3QzLmVmZmVjdER1cmF0aW9uICs9IGVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRTdGF0ZU5vZGUgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFN0YXRlTm9kZS5lZmZlY3REdXJhdGlvbiArPSBlZmZlY3REdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsgb3V0ZXI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudEZpYmVyID0gcGFyZW50RmliZXIucmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgICAgICBjb21taXRTdXNwZW5zZUh5ZHJhdGlvbkNhbGxiYWNrcyhmaW5pc2hlZFJvb3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgICBjYXNlIEluY29tcGxldGVDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICAgIGNhc2UgU2NvcGVDb21wb25lbnQ6CiAgICAgICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDoKICAgICAgICAgICAgICAgIGNhc2UgTGVnYWN5SGlkZGVuQ29tcG9uZW50OgogICAgICAgICAgICAgICAgY2FzZSBUcmFjaW5nTWFya2VyQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGlzIHVuaXQgb2Ygd29yayB0YWcgc2hvdWxkIG5vdCBoYXZlIHNpZGUtZWZmZWN0cy4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5mbGFncyAmIFJlZikgewogICAgICAgICAgICAgICAgICBjb21taXRBdHRhY2hSZWYoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlYXBwZWFyTGF5b3V0RWZmZWN0c09uRmliZXIobm9kZSkgewogICAgICAgICAgICBzd2l0Y2ggKG5vZGUudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbENvbW1pdEhvb2tMYXlvdXRFZmZlY3RMaXN0TW91bnQobm9kZSwgbm9kZS5yZXR1cm4pOwogICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKG5vZGUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBzYWZlbHlDYWxsQ29tbWl0SG9va0xheW91dEVmZmVjdExpc3RNb3VudChub2RlLCBub2RlLnJldHVybik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21wb25lbnREaWRNb3VudChub2RlLCBub2RlLnJldHVybiwgaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2FmZWx5QXR0YWNoUmVmKG5vZGUsIG5vZGUucmV0dXJuKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHNhZmVseUF0dGFjaFJlZihub2RlLCBub2RlLnJldHVybik7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGhpZGVPclVuaGlkZUFsbENoaWxkcmVuKGZpbmlzaGVkV29yaywgaXNIaWRkZW4pIHsKICAgICAgICAgICAgdmFyIGhvc3RTdWJ0cmVlUm9vdCA9IG51bGw7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgbm9kZSA9IGZpbmlzaGVkV29yazsKICAgICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICAgIGlmIChob3N0U3VidHJlZVJvb3QgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBob3N0U3VidHJlZVJvb3QgPSBub2RlOwogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBub2RlLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0hpZGRlbikgewogICAgICAgICAgICAgICAgICAgICAgICBoaWRlSW5zdGFuY2UoaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdW5oaWRlSW5zdGFuY2Uobm9kZS5zdGF0ZU5vZGUsIG5vZGUubWVtb2l6ZWRQcm9wcyk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgICAgICBpZiAoaG9zdFN1YnRyZWVSb290ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBfaW5zdGFuY2UzID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaGlkZVRleHRJbnN0YW5jZShfaW5zdGFuY2UzKTsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHVuaGlkZVRleHRJbnN0YW5jZShfaW5zdGFuY2UzLCBub2RlLm1lbW9pemVkUHJvcHMpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmICgobm9kZS50YWcgPT09IE9mZnNjcmVlbkNvbXBvbmVudCB8fCBub2RlLnRhZyA9PT0gTGVnYWN5SGlkZGVuQ29tcG9uZW50KSAmJiBub2RlLm1lbW9pemVkU3RhdGUgIT09IG51bGwgJiYgbm9kZSAhPT0gZmluaXNoZWRXb3JrKQogICAgICAgICAgICAgICAgICA7CiAgICAgICAgICAgICAgICBlbHNlIGlmIChub2RlLmNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIG5vZGUuY2hpbGQucmV0dXJuID0gbm9kZTsKICAgICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IGZpbmlzaGVkV29yaykgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGlmIChub2RlLnJldHVybiA9PT0gbnVsbCB8fCBub2RlLnJldHVybiA9PT0gZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChob3N0U3VidHJlZVJvb3QgPT09IG5vZGUpIHsKICAgICAgICAgICAgICAgICAgICBob3N0U3VidHJlZVJvb3QgPSBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChob3N0U3VidHJlZVJvb3QgPT09IG5vZGUpIHsKICAgICAgICAgICAgICAgICAgaG9zdFN1YnRyZWVSb290ID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjb21taXRBdHRhY2hSZWYoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICAgIHZhciByZWYgPSBmaW5pc2hlZFdvcmsucmVmOwogICAgICAgICAgICBpZiAocmVmICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICB2YXIgaW5zdGFuY2VUb1VzZTsKICAgICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICAgICAgaW5zdGFuY2VUb1VzZSA9IGdldFB1YmxpY0luc3RhbmNlKGluc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICBpbnN0YW5jZVRvVXNlID0gaW5zdGFuY2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0eXBlb2YgcmVmID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB2YXIgcmV0VmFsOwogICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0VmFsID0gcmVmKGluc3RhbmNlVG9Vc2UpOwogICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJldFZhbCA9IHJlZihpbnN0YW5jZVRvVXNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZXRWYWwgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiVW5leHBlY3RlZCByZXR1cm4gdmFsdWUgZnJvbSBhIGNhbGxiYWNrIHJlZiBpbiAlcy4gQSBjYWxsYmFjayByZWYgc2hvdWxkIG5vdCByZXR1cm4gYSBmdW5jdGlvbi4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKCFyZWYuaGFzT3duUHJvcGVydHkoImN1cnJlbnQiKSkgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCJVbmV4cGVjdGVkIHJlZiBvYmplY3QgcHJvdmlkZWQgZm9yICVzLiBVc2UgZWl0aGVyIGEgcmVmLXNldHRlciBmdW5jdGlvbiBvciBSZWFjdC5jcmVhdGVSZWYoKS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZWYuY3VycmVudCA9IGluc3RhbmNlVG9Vc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBkZXRhY2hGaWJlck11dGF0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmIChhbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBhbHRlcm5hdGUucmV0dXJuID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBmaWJlci5yZXR1cm4gPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZGV0YWNoRmliZXJBZnRlckVmZmVjdHMoZmliZXIpIHsKICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGZpYmVyLmFsdGVybmF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgZGV0YWNoRmliZXJBZnRlckVmZmVjdHMoYWx0ZXJuYXRlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZmliZXIuY2hpbGQgPSBudWxsOwogICAgICAgICAgICAgIGZpYmVyLmRlbGV0aW9ucyA9IG51bGw7CiAgICAgICAgICAgICAgZmliZXIuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gSG9zdENvbXBvbmVudCkgewogICAgICAgICAgICAgICAgdmFyIGhvc3RJbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmIChob3N0SW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZGV0YWNoRGVsZXRlZEluc3RhbmNlKGhvc3RJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IG51bGw7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZmliZXIuX2RlYnVnT3duZXIgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBmaWJlci5yZXR1cm4gPSBudWxsOwogICAgICAgICAgICAgICAgZmliZXIuZGVwZW5kZW5jaWVzID0gbnVsbDsKICAgICAgICAgICAgICAgIGZpYmVyLm1lbW9pemVkUHJvcHMgPSBudWxsOwogICAgICAgICAgICAgICAgZmliZXIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgICBmaWJlci5wZW5kaW5nUHJvcHMgPSBudWxsOwogICAgICAgICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gbnVsbDsKICAgICAgICAgICAgICAgIGZpYmVyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldEhvc3RQYXJlbnRGaWJlcihmaWJlcikgewogICAgICAgICAgICB2YXIgcGFyZW50ID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICB3aGlsZSAocGFyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGlzSG9zdFBhcmVudChwYXJlbnQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcGFyZW50OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgdG8gZmluZCBhIGhvc3QgcGFyZW50LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaXNIb3N0UGFyZW50KGZpYmVyKSB7CiAgICAgICAgICAgIHJldHVybiBmaWJlci50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgZmliZXIudGFnID09PSBIb3N0Um9vdCB8fCBmaWJlci50YWcgPT09IEhvc3RQb3J0YWw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRIb3N0U2libGluZyhmaWJlcikgewogICAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgICBzaWJsaW5nczoKICAgICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgICAgd2hpbGUgKG5vZGUuc2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgaXNIb3N0UGFyZW50KG5vZGUucmV0dXJuKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICAgICAgICB3aGlsZSAobm9kZS50YWcgIT09IEhvc3RDb21wb25lbnQgJiYgbm9kZS50YWcgIT09IEhvc3RUZXh0ICYmIG5vZGUudGFnICE9PSBEZWh5ZHJhdGVkRnJhZ21lbnQpIHsKICAgICAgICAgICAgICAgICAgaWYgKG5vZGUuZmxhZ3MgJiBQbGFjZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZSBzaWJsaW5nczsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAobm9kZS5jaGlsZCA9PT0gbnVsbCB8fCBub2RlLnRhZyA9PT0gSG9zdFBvcnRhbCkgewogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlIHNpYmxpbmdzOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG5vZGUuY2hpbGQucmV0dXJuID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCEobm9kZS5mbGFncyAmIFBsYWNlbWVudCkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBsYWNlbWVudChmaW5pc2hlZFdvcmspIHsKICAgICAgICAgICAgdmFyIHBhcmVudEZpYmVyID0gZ2V0SG9zdFBhcmVudEZpYmVyKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgIHN3aXRjaCAocGFyZW50RmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgaWYgKHBhcmVudEZpYmVyLmZsYWdzICYgQ29udGVudFJlc2V0KSB7CiAgICAgICAgICAgICAgICAgIHJlc2V0VGV4dENvbnRlbnQocGFyZW50KTsKICAgICAgICAgICAgICAgICAgcGFyZW50RmliZXIuZmxhZ3MgJj0gfkNvbnRlbnRSZXNldDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBiZWZvcmUgPSBnZXRIb3N0U2libGluZyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlKGZpbmlzaGVkV29yaywgYmVmb3JlLCBwYXJlbnQpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOiB7CiAgICAgICAgICAgICAgICB2YXIgX3BhcmVudCA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgICAgdmFyIF9iZWZvcmUgPSBnZXRIb3N0U2libGluZyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlSW50b0NvbnRhaW5lcihmaW5pc2hlZFdvcmssIF9iZWZvcmUsIF9wYXJlbnQpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgaG9zdCBwYXJlbnQgZmliZXIuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZUludG9Db250YWluZXIobm9kZSwgYmVmb3JlLCBwYXJlbnQpIHsKICAgICAgICAgICAgdmFyIHRhZyA9IG5vZGUudGFnOwogICAgICAgICAgICB2YXIgaXNIb3N0ID0gdGFnID09PSBIb3N0Q29tcG9uZW50IHx8IHRhZyA9PT0gSG9zdFRleHQ7CiAgICAgICAgICAgIGlmIChpc0hvc3QpIHsKICAgICAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKGJlZm9yZSkgewogICAgICAgICAgICAgICAgaW5zZXJ0SW5Db250YWluZXJCZWZvcmUocGFyZW50LCBzdGF0ZU5vZGUsIGJlZm9yZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGFwcGVuZENoaWxkVG9Db250YWluZXIocGFyZW50LCBzdGF0ZU5vZGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0YWcgPT09IEhvc3RQb3J0YWwpCiAgICAgICAgICAgICAgOwogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBub2RlLmNoaWxkOwogICAgICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlSW50b0NvbnRhaW5lcihjaGlsZCwgYmVmb3JlLCBwYXJlbnQpOwogICAgICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgd2hpbGUgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlSW50b0NvbnRhaW5lcihzaWJsaW5nLCBiZWZvcmUsIHBhcmVudCk7CiAgICAgICAgICAgICAgICAgIHNpYmxpbmcgPSBzaWJsaW5nLnNpYmxpbmc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpbnNlcnRPckFwcGVuZFBsYWNlbWVudE5vZGUobm9kZSwgYmVmb3JlLCBwYXJlbnQpIHsKICAgICAgICAgICAgdmFyIHRhZyA9IG5vZGUudGFnOwogICAgICAgICAgICB2YXIgaXNIb3N0ID0gdGFnID09PSBIb3N0Q29tcG9uZW50IHx8IHRhZyA9PT0gSG9zdFRleHQ7CiAgICAgICAgICAgIGlmIChpc0hvc3QpIHsKICAgICAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKGJlZm9yZSkgewogICAgICAgICAgICAgICAgaW5zZXJ0QmVmb3JlKHBhcmVudCwgc3RhdGVOb2RlLCBiZWZvcmUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhcHBlbmRDaGlsZChwYXJlbnQsIHN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHRhZyA9PT0gSG9zdFBvcnRhbCkKICAgICAgICAgICAgICA7CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHZhciBjaGlsZCA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgaWYgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpbnNlcnRPckFwcGVuZFBsYWNlbWVudE5vZGUoY2hpbGQsIGJlZm9yZSwgcGFyZW50KTsKICAgICAgICAgICAgICAgIHZhciBzaWJsaW5nID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICAgIHdoaWxlIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZShzaWJsaW5nLCBiZWZvcmUsIHBhcmVudCk7CiAgICAgICAgICAgICAgICAgIHNpYmxpbmcgPSBzaWJsaW5nLnNpYmxpbmc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaG9zdFBhcmVudCA9IG51bGw7CiAgICAgICAgICB2YXIgaG9zdFBhcmVudElzQ29udGFpbmVyID0gZmFsc2U7CiAgICAgICAgICBmdW5jdGlvbiBjb21taXREZWxldGlvbkVmZmVjdHMocm9vdDMsIHJldHVybkZpYmVyLCBkZWxldGVkRmliZXIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBwYXJlbnQgPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICBmaW5kUGFyZW50OgogICAgICAgICAgICAgICAgd2hpbGUgKHBhcmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBzd2l0Y2ggKHBhcmVudC50YWcpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBwYXJlbnQuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBmaW5kUGFyZW50OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gcGFyZW50LnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGZpbmRQYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDogewogICAgICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudCA9IHBhcmVudC5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgICAgIGhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBmaW5kUGFyZW50OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQucmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChob3N0UGFyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGZpbmQgYSBob3N0IHBhcmVudC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29tbWl0RGVsZXRpb25FZmZlY3RzT25GaWJlcihyb290MywgcmV0dXJuRmliZXIsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgaG9zdFBhcmVudCA9IG51bGw7CiAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGV0YWNoRmliZXJNdXRhdGlvbihkZWxldGVkRmliZXIpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIHBhcmVudCkgewogICAgICAgICAgICB2YXIgY2hpbGQgPSBwYXJlbnQuY2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGNvbW1pdERlbGV0aW9uRWZmZWN0c09uRmliZXIoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBjaGlsZCk7CiAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjb21taXREZWxldGlvbkVmZmVjdHNPbkZpYmVyKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKSB7CiAgICAgICAgICAgIG9uQ29tbWl0VW5tb3VudChkZWxldGVkRmliZXIpOwogICAgICAgICAgICBzd2l0Y2ggKGRlbGV0ZWRGaWJlci50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmICghb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbikgewogICAgICAgICAgICAgICAgICBzYWZlbHlEZXRhY2hSZWYoZGVsZXRlZEZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDogewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICB2YXIgcHJldkhvc3RQYXJlbnQgPSBob3N0UGFyZW50OwogICAgICAgICAgICAgICAgICB2YXIgcHJldkhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IGhvc3RQYXJlbnRJc0NvbnRhaW5lcjsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudCA9IG51bGw7CiAgICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gcHJldkhvc3RQYXJlbnQ7CiAgICAgICAgICAgICAgICAgIGhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IHByZXZIb3N0UGFyZW50SXNDb250YWluZXI7CiAgICAgICAgICAgICAgICAgIGlmIChob3N0UGFyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhvc3RQYXJlbnRJc0NvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlQ2hpbGRGcm9tQ29udGFpbmVyKGhvc3RQYXJlbnQsIGRlbGV0ZWRGaWJlci5zdGF0ZU5vZGUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICByZW1vdmVDaGlsZChob3N0UGFyZW50LCBkZWxldGVkRmliZXIuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBEZWh5ZHJhdGVkRnJhZ21lbnQ6IHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKGhvc3RQYXJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaG9zdFBhcmVudElzQ29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICAgICAgICBjbGVhclN1c3BlbnNlQm91bmRhcnlGcm9tQ29udGFpbmVyKGhvc3RQYXJlbnQsIGRlbGV0ZWRGaWJlci5zdGF0ZU5vZGUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBjbGVhclN1c3BlbnNlQm91bmRhcnkoaG9zdFBhcmVudCwgZGVsZXRlZEZpYmVyLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDogewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICB2YXIgX3ByZXZIb3N0UGFyZW50ID0gaG9zdFBhcmVudDsKICAgICAgICAgICAgICAgICAgdmFyIF9wcmV2SG9zdFBhcmVudElzQ29udGFpbmVyID0gaG9zdFBhcmVudElzQ29udGFpbmVyOwogICAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gZGVsZXRlZEZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudCA9IF9wcmV2SG9zdFBhcmVudDsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gX3ByZXZIb3N0UGFyZW50SXNDb250YWluZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOgogICAgICAgICAgICAgIGNhc2UgTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmICghb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbikgewogICAgICAgICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBkZWxldGVkRmliZXIudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgICAgIGlmICh1cGRhdGVRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBsYXN0RWZmZWN0ID0gdXBkYXRlUXVldWUubGFzdEVmZmVjdDsKICAgICAgICAgICAgICAgICAgICBpZiAobGFzdEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGZpcnN0RWZmZWN0ID0gbGFzdEVmZmVjdC5uZXh0OwogICAgICAgICAgICAgICAgICAgICAgdmFyIGVmZmVjdCA9IGZpcnN0RWZmZWN0OwogICAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgX2VmZmVjdCA9IGVmZmVjdCwgZGVzdHJveSA9IF9lZmZlY3QuZGVzdHJveSwgdGFnID0gX2VmZmVjdC50YWc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkZXN0cm95ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKHRhZyAmIEluc2VydGlvbikgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbERlc3Ryb3koZGVsZXRlZEZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZXN0cm95KTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCh0YWcgJiBMYXlvdXQpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdGFydGVkKGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGVsZXRlZEZpYmVyLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxEZXN0cm95KGRlbGV0ZWRGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVzdHJveSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYWZlbHlDYWxsRGVzdHJveShkZWxldGVkRmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlc3Ryb3kpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWZmZWN0ID0gZWZmZWN0Lm5leHQ7CiAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlIChlZmZlY3QgIT09IGZpcnN0RWZmZWN0KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBpZiAoIW9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgc2FmZWx5RGV0YWNoUmVmKGRlbGV0ZWRGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3Rvcik7CiAgICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGRlbGV0ZWRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVubW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICBzYWZlbHlDYWxsQ29tcG9uZW50V2lsbFVubW91bnQoZGVsZXRlZEZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIFNjb3BlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgICAgLy8gVE9ETzogUmVtb3ZlIHRoaXMgZGVhZCBmbGFnCiAgICAgICAgICAgICAgICAgIGRlbGV0ZWRGaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUKICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICB2YXIgcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gfHwgZGVsZXRlZEZpYmVyLm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNvbW1pdFN1c3BlbnNlQ2FsbGJhY2soZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGZpbmlzaGVkV29yay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY29tbWl0U3VzcGVuc2VIeWRyYXRpb25DYWxsYmFja3MoZmluaXNoZWRSb290LCBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gZmluaXNoZWRXb3JrLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIGlmIChuZXdTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBjdXJyZW50MiA9IGZpbmlzaGVkV29yay5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgIGlmIChwcmV2U3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIHN1c3BlbnNlSW5zdGFuY2UgPSBwcmV2U3RhdGUuZGVoeWRyYXRlZDsKICAgICAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlSW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBjb21taXRIeWRyYXRlZFN1c3BlbnNlSW5zdGFuY2Uoc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGF0dGFjaFN1c3BlbnNlUmV0cnlMaXN0ZW5lcnMoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICAgIHZhciB3YWtlYWJsZXMgPSBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWU7CiAgICAgICAgICAgIGlmICh3YWtlYWJsZXMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgICAgICAgIHZhciByZXRyeUNhY2hlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAocmV0cnlDYWNoZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0cnlDYWNoZSA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGUgPSBuZXcgUG9zc2libHlXZWFrU2V0KCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdha2VhYmxlcy5mb3JFYWNoKGZ1bmN0aW9uKHdha2VhYmxlKSB7CiAgICAgICAgICAgICAgICB2YXIgcmV0cnkgPSByZXNvbHZlUmV0cnlXYWtlYWJsZS5iaW5kKG51bGwsIGZpbmlzaGVkV29yaywgd2FrZWFibGUpOwogICAgICAgICAgICAgICAgaWYgKCFyZXRyeUNhY2hlLmhhcyh3YWtlYWJsZSkpIHsKICAgICAgICAgICAgICAgICAgcmV0cnlDYWNoZS5hZGQod2FrZWFibGUpOwogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5Qcm9ncmVzc0xhbmVzICE9PSBudWxsICYmIGluUHJvZ3Jlc3NSb290ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3RvcmVQZW5kaW5nVXBkYXRlcnMoaW5Qcm9ncmVzc1Jvb3QsIGluUHJvZ3Jlc3NMYW5lcyk7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigiRXhwZWN0ZWQgZmluaXNoZWQgcm9vdCBhbmQgbGFuZXMgdG8gYmUgc2V0LiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB3YWtlYWJsZS50aGVuKHJldHJ5LCByZXRyeSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNvbW1pdE11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrLCBjb21taXR0ZWRMYW5lcykgewogICAgICAgICAgICBpblByb2dyZXNzTGFuZXMgPSBjb21taXR0ZWRMYW5lczsKICAgICAgICAgICAgaW5Qcm9ncmVzc1Jvb3QgPSByb290MzsKICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgIGNvbW1pdE11dGF0aW9uRWZmZWN0c09uRmliZXIoZmluaXNoZWRXb3JrLCByb290Myk7CiAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICBpblByb2dyZXNzTGFuZXMgPSBudWxsOwogICAgICAgICAgICBpblByb2dyZXNzUm9vdCA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBwYXJlbnRGaWJlciwgbGFuZXMpIHsKICAgICAgICAgICAgdmFyIGRlbGV0aW9ucyA9IHBhcmVudEZpYmVyLmRlbGV0aW9uczsKICAgICAgICAgICAgaWYgKGRlbGV0aW9ucyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGVsZXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgY2hpbGRUb0RlbGV0ZSA9IGRlbGV0aW9uc1tpXTsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGNvbW1pdERlbGV0aW9uRWZmZWN0cyhyb290MywgcGFyZW50RmliZXIsIGNoaWxkVG9EZWxldGUpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGNoaWxkVG9EZWxldGUsIHBhcmVudEZpYmVyLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJldkRlYnVnRmliZXIgPSBnZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgaWYgKHBhcmVudEZpYmVyLnN1YnRyZWVGbGFncyAmIE11dGF0aW9uTWFzaykgewogICAgICAgICAgICAgIHZhciBjaGlsZCA9IHBhcmVudEZpYmVyLmNoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGNoaWxkKTsKICAgICAgICAgICAgICAgIGNvbW1pdE11dGF0aW9uRWZmZWN0c09uRmliZXIoY2hpbGQsIHJvb3QzKTsKICAgICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKHByZXZEZWJ1Z0ZpYmVyKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNvbW1pdE11dGF0aW9uRWZmZWN0c09uRmliZXIoZmluaXNoZWRXb3JrLCByb290MywgbGFuZXMpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnQyID0gZmluaXNoZWRXb3JrLmFsdGVybmF0ZTsKICAgICAgICAgICAgdmFyIGZsYWdzID0gZmluaXNoZWRXb3JrLmZsYWdzOwogICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoSW5zZXJ0aW9uIHwgSGFzRWZmZWN0LCBmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4pOwogICAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0TW91bnQoSW5zZXJ0aW9uIHwgSGFzRWZmZWN0LCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KExheW91dCB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuKTsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KExheW91dCB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuKTsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgaWYgKGZsYWdzICYgUmVmKSB7CiAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHNhZmVseURldGFjaFJlZihjdXJyZW50MiwgY3VycmVudDIucmV0dXJuKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIGlmIChmbGFncyAmIFJlZikgewogICAgICAgICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBzYWZlbHlEZXRhY2hSZWYoY3VycmVudDIsIGN1cnJlbnQyLnJldHVybik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5mbGFncyAmIENvbnRlbnRSZXNldCkgewogICAgICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgIHJlc2V0VGV4dENvbnRlbnQoaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX2luc3RhbmNlNCA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9pbnN0YW5jZTQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1Byb3BzID0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgb2xkUHJvcHMgPSBjdXJyZW50MiAhPT0gbnVsbCA/IGN1cnJlbnQyLm1lbW9pemVkUHJvcHMgOiBuZXdQcm9wczsKICAgICAgICAgICAgICAgICAgICAgIHZhciB0eXBlMiA9IGZpbmlzaGVkV29yay50eXBlOwogICAgICAgICAgICAgICAgICAgICAgdmFyIHVwZGF0ZVBheWxvYWQgPSBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgICAgICAgICBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgaWYgKHVwZGF0ZVBheWxvYWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICBjb21taXRVcGRhdGUoX2luc3RhbmNlNCwgdXBkYXRlUGF5bG9hZCwgdHlwZTIsIG9sZFByb3BzLCBuZXdQcm9wcywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6IHsKICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIGlmIChmbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5zdGF0ZU5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhpcyBzaG91bGQgaGF2ZSBhIHRleHQgbm9kZSBpbml0aWFsaXplZC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdmFyIHRleHRJbnN0YW5jZSA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1RleHQgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgICAgICB2YXIgb2xkVGV4dCA9IGN1cnJlbnQyICE9PSBudWxsID8gY3VycmVudDIubWVtb2l6ZWRQcm9wcyA6IG5ld1RleHQ7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgIGNvbW1pdFRleHRVcGRhdGUodGV4dEluc3RhbmNlLCBvbGRUZXh0LCBuZXdUZXh0KTsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgaWYgKGZsYWdzICYgVXBkYXRlKSB7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBwcmV2Um9vdFN0YXRlID0gY3VycmVudDIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChwcmV2Um9vdFN0YXRlLmlzRGVoeWRyYXRlZCkgewogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbW1pdEh5ZHJhdGVkQ29udGFpbmVyKHJvb3QzLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOiB7CiAgICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIHZhciBvZmZzY3JlZW5GaWJlciA9IGZpbmlzaGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICAgIGlmIChvZmZzY3JlZW5GaWJlci5mbGFncyAmIFZpc2liaWxpdHkpIHsKICAgICAgICAgICAgICAgICAgdmFyIG9mZnNjcmVlbkluc3RhbmNlID0gb2Zmc2NyZWVuRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBvZmZzY3JlZW5GaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgICB2YXIgaXNIaWRkZW4gPSBuZXdTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgICAgb2Zmc2NyZWVuSW5zdGFuY2UuaXNIaWRkZW4gPSBpc0hpZGRlbjsKICAgICAgICAgICAgICAgICAgaWYgKGlzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHdhc0hpZGRlbiA9IG9mZnNjcmVlbkZpYmVyLmFsdGVybmF0ZSAhPT0gbnVsbCAmJiBvZmZzY3JlZW5GaWJlci5hbHRlcm5hdGUubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgICAgICBpZiAoIXdhc0hpZGRlbikgewogICAgICAgICAgICAgICAgICAgICAgbWFya0NvbW1pdFRpbWVPZkZhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBjb21taXRTdXNwZW5zZUNhbGxiYWNrKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBhdHRhY2hTdXNwZW5zZVJldHJ5TGlzdGVuZXJzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgX3dhc0hpZGRlbiA9IGN1cnJlbnQyICE9PSBudWxsICYmIGN1cnJlbnQyLm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAgIC8vIFRPRE86IFJlbW92ZSB0aGlzIGRlYWQgZmxhZwogICAgICAgICAgICAgICAgICBmaW5pc2hlZFdvcmsubW9kZSAmIENvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgICAgdmFyIHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuIHx8IF93YXNIaWRkZW47CiAgICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIGlmIChmbGFncyAmIFZpc2liaWxpdHkpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9vZmZzY3JlZW5JbnN0YW5jZSA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIHZhciBfbmV3U3RhdGUgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgICAgdmFyIF9pc0hpZGRlbiA9IF9uZXdTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgICAgdmFyIG9mZnNjcmVlbkJvdW5kYXJ5ID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgICAgICAgICBfb2Zmc2NyZWVuSW5zdGFuY2UuaXNIaWRkZW4gPSBfaXNIaWRkZW47CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoX2lzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIV93YXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChvZmZzY3JlZW5Cb3VuZGFyeS5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gb2Zmc2NyZWVuQm91bmRhcnk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9mZnNjcmVlbkNoaWxkID0gb2Zmc2NyZWVuQm91bmRhcnkuY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKG9mZnNjcmVlbkNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gb2Zmc2NyZWVuQ2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNhcHBlYXJMYXlvdXRFZmZlY3RzX2JlZ2luKG9mZnNjcmVlbkNoaWxkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNjcmVlbkNoaWxkID0gb2Zmc2NyZWVuQ2hpbGQuc2libGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGhpZGVPclVuaGlkZUFsbENoaWxkcmVuKG9mZnNjcmVlbkJvdW5kYXJ5LCBfaXNIaWRkZW4pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgICAgYXR0YWNoU3VzcGVuc2VSZXRyeUxpc3RlbmVycyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIFNjb3BlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspIHsKICAgICAgICAgICAgdmFyIGZsYWdzID0gZmluaXNoZWRXb3JrLmZsYWdzOwogICAgICAgICAgICBpZiAoZmxhZ3MgJiBQbGFjZW1lbnQpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY29tbWl0UGxhY2VtZW50KGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZpbmlzaGVkV29yay5mbGFncyAmPSB+UGxhY2VtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmbGFncyAmIEh5ZHJhdGluZykgewogICAgICAgICAgICAgIGZpbmlzaGVkV29yay5mbGFncyAmPSB+SHlkcmF0aW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjb21taXRMYXlvdXRFZmZlY3RzKGZpbmlzaGVkV29yaywgcm9vdDMsIGNvbW1pdHRlZExhbmVzKSB7CiAgICAgICAgICAgIGluUHJvZ3Jlc3NMYW5lcyA9IGNvbW1pdHRlZExhbmVzOwogICAgICAgICAgICBpblByb2dyZXNzUm9vdCA9IHJvb3QzOwogICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgICBjb21taXRMYXlvdXRFZmZlY3RzX2JlZ2luKGZpbmlzaGVkV29yaywgcm9vdDMsIGNvbW1pdHRlZExhbmVzKTsKICAgICAgICAgICAgaW5Qcm9ncmVzc0xhbmVzID0gbnVsbDsKICAgICAgICAgICAgaW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY29tbWl0TGF5b3V0RWZmZWN0c19iZWdpbihzdWJ0cmVlUm9vdCwgcm9vdDMsIGNvbW1pdHRlZExhbmVzKSB7CiAgICAgICAgICAgIHZhciBpc01vZGVyblJvb3QgPSAoc3VidHJlZVJvb3QubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlOwogICAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgICAgdmFyIGZpcnN0Q2hpbGQgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBPZmZzY3JlZW5Db21wb25lbnQgJiYgaXNNb2Rlcm5Sb290KSB7CiAgICAgICAgICAgICAgICB2YXIgaXNIaWRkZW4gPSBmaWJlci5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgdmFyIG5ld09mZnNjcmVlblN1YnRyZWVJc0hpZGRlbiA9IGlzSGlkZGVuIHx8IG9mZnNjcmVlblN1YnRyZWVJc0hpZGRlbjsKICAgICAgICAgICAgICAgIGlmIChuZXdPZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgY29tbWl0TGF5b3V0TW91bnRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMpOwogICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50MiA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICAgICAgdmFyIHdhc0hpZGRlbiA9IGN1cnJlbnQyICE9PSBudWxsICYmIGN1cnJlbnQyLm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICAgIHZhciBuZXdPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gd2FzSGlkZGVuIHx8IG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgICAgIHZhciBwcmV2T2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuID0gb2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuOwogICAgICAgICAgICAgICAgICB2YXIgcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW4gPSBuZXdPZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW47CiAgICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBuZXdPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgICAgICBpZiAob2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiAmJiAhcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXI7CiAgICAgICAgICAgICAgICAgICAgcmVhcHBlYXJMYXlvdXRFZmZlY3RzX2JlZ2luKGZpYmVyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBmaXJzdENoaWxkOwogICAgICAgICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0TGF5b3V0RWZmZWN0c19iZWdpbigKICAgICAgICAgICAgICAgICAgICAgIGNoaWxkLAogICAgICAgICAgICAgICAgICAgICAgLy8gTmV3IHJvb3Q7IGJ1YmJsZSBiYWNrIHVwIHRvIGhlcmUgYW5kIHN0b3AuCiAgICAgICAgICAgICAgICAgICAgICByb290MywKICAgICAgICAgICAgICAgICAgICAgIGNvbW1pdHRlZExhbmVzCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyOwogICAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW4gPSBwcmV2T2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuOwogICAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgICAgIGNvbW1pdExheW91dE1vdW50RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCwgcm9vdDMsIGNvbW1pdHRlZExhbmVzKTsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgoZmliZXIuc3VidHJlZUZsYWdzICYgTGF5b3V0TWFzaykgIT09IE5vRmxhZ3MgJiYgZmlyc3RDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZmlyc3RDaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaXJzdENoaWxkOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb21taXRMYXlvdXRNb3VudEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjb21taXRMYXlvdXRNb3VudEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcykgewogICAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgICAgaWYgKChmaWJlci5mbGFncyAmIExheW91dE1hc2spICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICB2YXIgY3VycmVudDIgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0TGF5b3V0RWZmZWN0T25GaWJlcihyb290MywgY3VycmVudDIsIGZpYmVyLCBjb21taXR0ZWRMYW5lcyk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChmaWJlciA9PT0gc3VidHJlZVJvb3QpIHsKICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBudWxsOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNpYmxpbmcucmV0dXJuID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGRpc2FwcGVhckxheW91dEVmZmVjdHNfYmVnaW4oc3VidHJlZVJvb3QpIHsKICAgICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICAgIHZhciBmaXJzdENoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgICAgaWYgKGZpYmVyLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoTGF5b3V0LCBmaWJlciwgZmliZXIucmV0dXJuKTsKICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmliZXIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoTGF5b3V0LCBmaWJlciwgZmliZXIucmV0dXJuKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgICAgc2FmZWx5RGV0YWNoUmVmKGZpYmVyLCBmaWJlci5yZXR1cm4pOwogICAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVubW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICBzYWZlbHlDYWxsQ29tcG9uZW50V2lsbFVubW91bnQoZmliZXIsIGZpYmVyLnJldHVybiwgaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgIHNhZmVseURldGFjaFJlZihmaWJlciwgZmliZXIucmV0dXJuKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDogewogICAgICAgICAgICAgICAgICB2YXIgaXNIaWRkZW4gPSBmaWJlci5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgICBpZiAoaXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICBkaXNhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KTsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGZpcnN0Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZpcnN0Q2hpbGQucmV0dXJuID0gZmliZXI7CiAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGlzYXBwZWFyTGF5b3V0RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBkaXNhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KSB7CiAgICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgICBpZiAoZmliZXIgPT09IHN1YnRyZWVSb290KSB7CiAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBmaWJlci5zaWJsaW5nOwogICAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBzaWJsaW5nOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZWFwcGVhckxheW91dEVmZmVjdHNfYmVnaW4oc3VidHJlZVJvb3QpIHsKICAgICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICAgIHZhciBmaXJzdENoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gT2Zmc2NyZWVuQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgaXNIaWRkZW4gPSBmaWJlci5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgaWYgKGlzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgIHJlYXBwZWFyTGF5b3V0RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCk7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZmlyc3RDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZmlyc3RDaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaXJzdENoaWxkOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZWFwcGVhckxheW91dEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KSB7CiAgICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZWFwcGVhckxheW91dEVmZmVjdHNPbkZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgaWYgKGZpYmVyID09PSBzdWJ0cmVlUm9vdCkgewogICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBzaWJsaW5nID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gc2libGluZzsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZU1vdW50RWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrLCBjb21taXR0ZWRMYW5lcywgY29tbWl0dGVkVHJhbnNpdGlvbnMpIHsKICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpbmlzaGVkV29yazsKICAgICAgICAgICAgY29tbWl0UGFzc2l2ZU1vdW50RWZmZWN0c19iZWdpbihmaW5pc2hlZFdvcmssIHJvb3QzLCBjb21taXR0ZWRMYW5lcywgY29tbWl0dGVkVHJhbnNpdGlvbnMpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZU1vdW50RWZmZWN0c19iZWdpbihzdWJ0cmVlUm9vdCwgcm9vdDMsIGNvbW1pdHRlZExhbmVzLCBjb21taXR0ZWRUcmFuc2l0aW9ucykgewogICAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgICAgdmFyIGZpcnN0Q2hpbGQgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgICBpZiAoKGZpYmVyLnN1YnRyZWVGbGFncyAmIFBhc3NpdmVNYXNrKSAhPT0gTm9GbGFncyAmJiBmaXJzdENoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBmaXJzdENoaWxkLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbW1pdFBhc3NpdmVNb3VudEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcywgY29tbWl0dGVkVHJhbnNpdGlvbnMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZU1vdW50RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCwgcm9vdDMsIGNvbW1pdHRlZExhbmVzLCBjb21taXR0ZWRUcmFuc2l0aW9ucykgewogICAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgICAgaWYgKChmaWJlci5mbGFncyAmIFBhc3NpdmUpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0UGFzc2l2ZU1vdW50T25GaWJlcihyb290MywgZmliZXIsIGNvbW1pdHRlZExhbmVzLCBjb21taXR0ZWRUcmFuc2l0aW9ucyk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChmaWJlciA9PT0gc3VidHJlZVJvb3QpIHsKICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBudWxsOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNpYmxpbmcucmV0dXJuID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVNb3VudE9uRmliZXIoZmluaXNoZWRSb290LCBmaW5pc2hlZFdvcmssIGNvbW1pdHRlZExhbmVzLCBjb21taXR0ZWRUcmFuc2l0aW9ucykgewogICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICAgIHN0YXJ0UGFzc2l2ZUVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChQYXNzaXZlJDEgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgcmVjb3JkUGFzc2l2ZUVmZmVjdER1cmF0aW9uKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0TW91bnQoUGFzc2l2ZSQxIHwgSGFzRWZmZWN0LCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHMoZmlyc3RDaGlsZCkgewogICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzX2JlZ2luKCk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNfYmVnaW4oKSB7CiAgICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgICBpZiAoKG5leHRFZmZlY3QuZmxhZ3MgJiBDaGlsZERlbGV0aW9uKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgdmFyIGRlbGV0aW9ucyA9IGZpYmVyLmRlbGV0aW9uczsKICAgICAgICAgICAgICAgIGlmIChkZWxldGlvbnMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkZWxldGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZmliZXJUb0RlbGV0ZSA9IGRlbGV0aW9uc1tpXTsKICAgICAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXJUb0RlbGV0ZTsKICAgICAgICAgICAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNJbnNpZGVPZkRlbGV0ZWRUcmVlX2JlZ2luKGZpYmVyVG9EZWxldGUsIGZpYmVyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHByZXZpb3VzRmliZXIgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzRmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBkZXRhY2hlZENoaWxkID0gcHJldmlvdXNGaWJlci5jaGlsZDsKICAgICAgICAgICAgICAgICAgICAgIGlmIChkZXRhY2hlZENoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByZXZpb3VzRmliZXIuY2hpbGQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRldGFjaGVkU2libGluZyA9IGRldGFjaGVkQ2hpbGQuc2libGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgICBkZXRhY2hlZENoaWxkLnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgIGRldGFjaGVkQ2hpbGQgPSBkZXRhY2hlZFNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKGRldGFjaGVkQ2hpbGQgIT09IG51bGwpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgoZmliZXIuc3VidHJlZUZsYWdzICYgUGFzc2l2ZU1hc2spICE9PSBOb0ZsYWdzICYmIGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBjaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBjaGlsZDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzX2NvbXBsZXRlKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNfY29tcGxldGUoKSB7CiAgICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgICBpZiAoKGZpYmVyLmZsYWdzICYgUGFzc2l2ZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudE9uRmliZXIoZmliZXIpOwogICAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBmaWJlci5zaWJsaW5nOwogICAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBzaWJsaW5nOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudE9uRmliZXIoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICAgIHN3aXRjaCAoZmluaXNoZWRXb3JrLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgc3RhcnRQYXNzaXZlRWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuKTsKICAgICAgICAgICAgICAgICAgcmVjb3JkUGFzc2l2ZUVmZmVjdER1cmF0aW9uKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoUGFzc2l2ZSQxIHwgSGFzRWZmZWN0LCBmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNJbnNpZGVPZkRlbGV0ZWRUcmVlX2JlZ2luKGRlbGV0ZWRTdWJ0cmVlUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvcikgewogICAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEluc2lkZURlbGV0ZWRUcmVlT25GaWJlcihmaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3Rvcik7CiAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgICBpZiAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGNoaWxkOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNJbnNpZGVPZkRlbGV0ZWRUcmVlX2NvbXBsZXRlKGRlbGV0ZWRTdWJ0cmVlUm9vdCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNJbnNpZGVPZkRlbGV0ZWRUcmVlX2NvbXBsZXRlKGRlbGV0ZWRTdWJ0cmVlUm9vdCkgewogICAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBmaWJlci5zaWJsaW5nOwogICAgICAgICAgICAgIHZhciByZXR1cm5GaWJlciA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBkZXRhY2hGaWJlckFmdGVyRWZmZWN0cyhmaWJlcik7CiAgICAgICAgICAgICAgICBpZiAoZmliZXIgPT09IGRlbGV0ZWRTdWJ0cmVlUm9vdCkgewogICAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBzaWJsaW5nOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50SW5zaWRlRGVsZXRlZFRyZWVPbkZpYmVyKGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICAgIHN3aXRjaCAoY3VycmVudDIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudDIubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICAgIHN0YXJ0UGFzc2l2ZUVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEsIGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgICAgICAgcmVjb3JkUGFzc2l2ZUVmZmVjdER1cmF0aW9uKGN1cnJlbnQyKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEsIGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaW52b2tlTGF5b3V0RWZmZWN0TW91bnRJbkRFVihmaWJlcikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KExheW91dCB8IEhhc0VmZmVjdCwgZmliZXIpOwogICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaWJlciwgZmliZXIucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQoKTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGludm9rZVBhc3NpdmVFZmZlY3RNb3VudEluREVWKGZpYmVyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0TW91bnQoUGFzc2l2ZSQxIHwgSGFzRWZmZWN0LCBmaWJlcik7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpbnZva2VMYXlvdXRFZmZlY3RVbm1vdW50SW5ERVYoZmliZXIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOgogICAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KExheW91dCB8IEhhc0VmZmVjdCwgZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVW5tb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21wb25lbnRXaWxsVW5tb3VudChmaWJlciwgZmliZXIucmV0dXJuLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpbnZva2VQYXNzaXZlRWZmZWN0VW5tb3VudEluREVWKGZpYmVyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEgfCBIYXNFZmZlY3QsIGZpYmVyLCBmaWJlci5yZXR1cm4pOwogICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaWJlciwgZmliZXIucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgQ09NUE9ORU5UX1RZUEUgPSAwOwogICAgICAgICAgdmFyIEhBU19QU0VVRE9fQ0xBU1NfVFlQRSA9IDE7CiAgICAgICAgICB2YXIgUk9MRV9UWVBFID0gMjsKICAgICAgICAgIHZhciBURVNUX05BTUVfVFlQRSA9IDM7CiAgICAgICAgICB2YXIgVEVYVF9UWVBFID0gNDsKICAgICAgICAgIGlmICh0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIFN5bWJvbC5mb3IpIHsKICAgICAgICAgICAgdmFyIHN5bWJvbEZvciA9IFN5bWJvbC5mb3I7CiAgICAgICAgICAgIENPTVBPTkVOVF9UWVBFID0gc3ltYm9sRm9yKCJzZWxlY3Rvci5jb21wb25lbnQiKTsKICAgICAgICAgICAgSEFTX1BTRVVET19DTEFTU19UWVBFID0gc3ltYm9sRm9yKCJzZWxlY3Rvci5oYXNfcHNldWRvX2NsYXNzIik7CiAgICAgICAgICAgIFJPTEVfVFlQRSA9IHN5bWJvbEZvcigic2VsZWN0b3Iucm9sZSIpOwogICAgICAgICAgICBURVNUX05BTUVfVFlQRSA9IHN5bWJvbEZvcigic2VsZWN0b3IudGVzdF9pZCIpOwogICAgICAgICAgICBURVhUX1RZUEUgPSBzeW1ib2xGb3IoInNlbGVjdG9yLnRleHQiKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjb21taXRIb29rcyA9IFtdOwogICAgICAgICAgZnVuY3Rpb24gb25Db21taXRSb290JDEoKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjb21taXRIb29rcy5mb3JFYWNoKGZ1bmN0aW9uKGNvbW1pdEhvb2spIHsKICAgICAgICAgICAgICAgIHJldHVybiBjb21taXRIb29rKCk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBSZWFjdEN1cnJlbnRBY3RRdWV1ZSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudEFjdFF1ZXVlOwogICAgICAgICAgZnVuY3Rpb24gaXNMZWdhY3lBY3RFbnZpcm9ubWVudChmaWJlcikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIGlzUmVhY3RBY3RFbnZpcm9ubWVudEdsb2JhbCA9ICgKICAgICAgICAgICAgICAgIC8vICRGbG93RXhwZWN0ZWRFcnJvciDigJMgRmxvdyBkb2Vzbid0IGtub3cgYWJvdXQgSVNfUkVBQ1RfQUNUX0VOVklST05NRU5UIGdsb2JhbAogICAgICAgICAgICAgICAgdHlwZW9mIElTX1JFQUNUX0FDVF9FTlZJUk9OTUVOVCAhPT0gInVuZGVmaW5lZCIgPyBJU19SRUFDVF9BQ1RfRU5WSVJPTk1FTlQgOiB2b2lkIDAKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHZhciBqZXN0SXNEZWZpbmVkID0gdHlwZW9mIGplc3QgIT09ICJ1bmRlZmluZWQiOwogICAgICAgICAgICAgIHJldHVybiBqZXN0SXNEZWZpbmVkICYmIGlzUmVhY3RBY3RFbnZpcm9ubWVudEdsb2JhbCAhPT0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGlzQ29uY3VycmVudEFjdEVudmlyb25tZW50KCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIGlzUmVhY3RBY3RFbnZpcm9ubWVudEdsb2JhbCA9ICgKICAgICAgICAgICAgICAgIC8vICRGbG93RXhwZWN0ZWRFcnJvciDigJMgRmxvdyBkb2Vzbid0IGtub3cgYWJvdXQgSVNfUkVBQ1RfQUNUX0VOVklST05NRU5UIGdsb2JhbAogICAgICAgICAgICAgICAgdHlwZW9mIElTX1JFQUNUX0FDVF9FTlZJUk9OTUVOVCAhPT0gInVuZGVmaW5lZCIgPyBJU19SRUFDVF9BQ1RfRU5WSVJPTk1FTlQgOiB2b2lkIDAKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmICghaXNSZWFjdEFjdEVudmlyb25tZW50R2xvYmFsICYmIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgY3VycmVudCB0ZXN0aW5nIGVudmlyb25tZW50IGlzIG5vdCBjb25maWd1cmVkIHRvIHN1cHBvcnQgYWN0KC4uLikiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGlzUmVhY3RBY3RFbnZpcm9ubWVudEdsb2JhbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGNlaWwgPSBNYXRoLmNlaWw7CiAgICAgICAgICB2YXIgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50RGlzcGF0Y2hlciwgUmVhY3RDdXJyZW50T3duZXIkMiA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudE93bmVyLCBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50QmF0Y2hDb25maWcsIFJlYWN0Q3VycmVudEFjdFF1ZXVlJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRBY3RRdWV1ZTsKICAgICAgICAgIHZhciBOb0NvbnRleHQgPSAoCiAgICAgICAgICAgIC8qICAgICAgICAgICAgICovCiAgICAgICAgICAgIDAKICAgICAgICAgICk7CiAgICAgICAgICB2YXIgQmF0Y2hlZENvbnRleHQgPSAoCiAgICAgICAgICAgIC8qICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgMQogICAgICAgICAgKTsKICAgICAgICAgIHZhciBSZW5kZXJDb250ZXh0ID0gKAogICAgICAgICAgICAvKiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAyCiAgICAgICAgICApOwogICAgICAgICAgdmFyIENvbW1pdENvbnRleHQgPSAoCiAgICAgICAgICAgIC8qICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgIDQKICAgICAgICAgICk7CiAgICAgICAgICB2YXIgUm9vdEluUHJvZ3Jlc3MgPSAwOwogICAgICAgICAgdmFyIFJvb3RGYXRhbEVycm9yZWQgPSAxOwogICAgICAgICAgdmFyIFJvb3RFcnJvcmVkID0gMjsKICAgICAgICAgIHZhciBSb290U3VzcGVuZGVkID0gMzsKICAgICAgICAgIHZhciBSb290U3VzcGVuZGVkV2l0aERlbGF5ID0gNDsKICAgICAgICAgIHZhciBSb290Q29tcGxldGVkID0gNTsKICAgICAgICAgIHZhciBSb290RGlkTm90Q29tcGxldGUgPSA2OwogICAgICAgICAgdmFyIGV4ZWN1dGlvbkNvbnRleHQgPSBOb0NvbnRleHQ7CiAgICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290ID0gbnVsbDsKICAgICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzcyA9IG51bGw7CiAgICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdmFyIHN1YnRyZWVSZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB2YXIgc3VidHJlZVJlbmRlckxhbmVzQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKE5vTGFuZXMpOwogICAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPSBSb290SW5Qcm9ncmVzczsKICAgICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RGYXRhbEVycm9yID0gbnVsbDsKICAgICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RJbmNsdWRlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RTa2lwcGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdEludGVybGVhdmVkVXBkYXRlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RQaW5nZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290Q29uY3VycmVudEVycm9ycyA9IG51bGw7CiAgICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMgPSBudWxsOwogICAgICAgICAgdmFyIGdsb2JhbE1vc3RSZWNlbnRGYWxsYmFja1RpbWUgPSAwOwogICAgICAgICAgdmFyIEZBTExCQUNLX1RIUk9UVExFX01TID0gNTAwOwogICAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlclRhcmdldFRpbWUgPSBJbmZpbml0eTsKICAgICAgICAgIHZhciBSRU5ERVJfVElNRU9VVF9NUyA9IDUwMDsKICAgICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zID0gbnVsbDsKICAgICAgICAgIGZ1bmN0aW9uIHJlc2V0UmVuZGVyVGltZXIoKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlclRhcmdldFRpbWUgPSBub3cyKCkgKyBSRU5ERVJfVElNRU9VVF9NUzsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldFJlbmRlclRhcmdldFRpbWUoKSB7CiAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJUYXJnZXRUaW1lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGhhc1VuY2F1Z2h0RXJyb3IgPSBmYWxzZTsKICAgICAgICAgIHZhciBmaXJzdFVuY2F1Z2h0RXJyb3IgPSBudWxsOwogICAgICAgICAgdmFyIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkID0gbnVsbDsKICAgICAgICAgIHZhciByb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgICAgdmFyIHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzID0gbnVsbDsKICAgICAgICAgIHZhciBwZW5kaW5nUGFzc2l2ZUVmZmVjdHNMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB2YXIgcGVuZGluZ1Bhc3NpdmVQcm9maWxlckVmZmVjdHMgPSBbXTsKICAgICAgICAgIHZhciBwZW5kaW5nUGFzc2l2ZVRyYW5zaXRpb25zID0gbnVsbDsKICAgICAgICAgIHZhciBORVNURURfVVBEQVRFX0xJTUlUID0gNTA7CiAgICAgICAgICB2YXIgbmVzdGVkVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgdmFyIHJvb3RXaXRoTmVzdGVkVXBkYXRlcyA9IG51bGw7CiAgICAgICAgICB2YXIgaXNGbHVzaGluZ1Bhc3NpdmVFZmZlY3RzID0gZmFsc2U7CiAgICAgICAgICB2YXIgZGlkU2NoZWR1bGVVcGRhdGVEdXJpbmdQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgICAgdmFyIE5FU1RFRF9QQVNTSVZFX1VQREFURV9MSU1JVCA9IDUwOwogICAgICAgICAgdmFyIG5lc3RlZFBhc3NpdmVVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgICB2YXIgcm9vdFdpdGhQYXNzaXZlTmVzdGVkVXBkYXRlcyA9IG51bGw7CiAgICAgICAgICB2YXIgY3VycmVudEV2ZW50VGltZSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgdmFyIGN1cnJlbnRFdmVudFRyYW5zaXRpb25MYW5lID0gTm9MYW5lczsKICAgICAgICAgIHZhciBpc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QgPSBmYWxzZTsKICAgICAgICAgIGZ1bmN0aW9uIGdldFdvcmtJblByb2dyZXNzUm9vdCgpIHsKICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzUm9vdDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RFdmVudFRpbWUoKSB7CiAgICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpICE9PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICByZXR1cm4gbm93MigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjdXJyZW50RXZlbnRUaW1lICE9PSBOb1RpbWVzdGFtcCkgewogICAgICAgICAgICAgIHJldHVybiBjdXJyZW50RXZlbnRUaW1lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGN1cnJlbnRFdmVudFRpbWUgPSBub3cyKCk7CiAgICAgICAgICAgIHJldHVybiBjdXJyZW50RXZlbnRUaW1lOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVxdWVzdFVwZGF0ZUxhbmUoZmliZXIpIHsKICAgICAgICAgICAgdmFyIG1vZGUgPSBmaWJlci5tb2RlOwogICAgICAgICAgICBpZiAoKG1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICAgIHJldHVybiBTeW5jTGFuZTsKICAgICAgICAgICAgfSBlbHNlIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpICE9PSBOb0NvbnRleHQgJiYgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICByZXR1cm4gcGlja0FyYml0cmFyeUxhbmUod29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpc1RyYW5zaXRpb24gPSByZXF1ZXN0Q3VycmVudFRyYW5zaXRpb24oKSAhPT0gTm9UcmFuc2l0aW9uOwogICAgICAgICAgICBpZiAoaXNUcmFuc2l0aW9uKSB7CiAgICAgICAgICAgICAgaWYgKFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHRyYW5zaXRpb24yID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uOwogICAgICAgICAgICAgICAgaWYgKCF0cmFuc2l0aW9uMi5fdXBkYXRlZEZpYmVycykgewogICAgICAgICAgICAgICAgICB0cmFuc2l0aW9uMi5fdXBkYXRlZEZpYmVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uMi5fdXBkYXRlZEZpYmVycy5hZGQoZmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoY3VycmVudEV2ZW50VHJhbnNpdGlvbkxhbmUgPT09IE5vTGFuZSkgewogICAgICAgICAgICAgICAgY3VycmVudEV2ZW50VHJhbnNpdGlvbkxhbmUgPSBjbGFpbU5leHRUcmFuc2l0aW9uTGFuZSgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gY3VycmVudEV2ZW50VHJhbnNpdGlvbkxhbmU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHVwZGF0ZUxhbmUgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgICAgaWYgKHVwZGF0ZUxhbmUgIT09IE5vTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVMYW5lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBldmVudExhbmUgPSBnZXRDdXJyZW50RXZlbnRQcmlvcml0eSgpOwogICAgICAgICAgICByZXR1cm4gZXZlbnRMYW5lOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVxdWVzdFJldHJ5TGFuZShmaWJlcikgewogICAgICAgICAgICB2YXIgbW9kZSA9IGZpYmVyLm1vZGU7CiAgICAgICAgICAgIGlmICgobW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFN5bmNMYW5lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjbGFpbU5leHRSZXRyeUxhbmUoKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSkgewogICAgICAgICAgICBjaGVja0Zvck5lc3RlZFVwZGF0ZXMoKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJ1c2VJbnNlcnRpb25FZmZlY3QgbXVzdCBub3Qgc2NoZWR1bGUgdXBkYXRlcy4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpc0ZsdXNoaW5nUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgICAgIGRpZFNjaGVkdWxlVXBkYXRlRHVyaW5nUGFzc2l2ZUVmZmVjdHMgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBtYXJrUm9vdFVwZGF0ZWQocm9vdDMsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpICE9PSBOb0xhbmVzICYmIHJvb3QzID09PSB3b3JrSW5Qcm9ncmVzc1Jvb3QpIHsKICAgICAgICAgICAgICB3YXJuQWJvdXRSZW5kZXJQaGFzZVVwZGF0ZXNJbkRFVihmaWJlcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgICAgIGFkZEZpYmVyVG9MYW5lc01hcChyb290MywgZmliZXIsIGxhbmUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3YXJuSWZVcGRhdGVzTm90V3JhcHBlZFdpdGhBY3RERVYoZmliZXIpOwogICAgICAgICAgICAgIGlmIChyb290MyA9PT0gd29ya0luUHJvZ3Jlc3NSb290KSB7CiAgICAgICAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiBSZW5kZXJDb250ZXh0KSA9PT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEludGVybGVhdmVkVXBkYXRlZExhbmVzID0gbWVyZ2VMYW5lcyh3b3JrSW5Qcm9ncmVzc1Jvb3RJbnRlcmxlYXZlZFVwZGF0ZWRMYW5lcywgbGFuZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9PT0gUm9vdFN1c3BlbmRlZFdpdGhEZWxheSkgewogICAgICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICBpZiAobGFuZSA9PT0gU3luY0xhbmUgJiYgZXhlY3V0aW9uQ29udGV4dCA9PT0gTm9Db250ZXh0ICYmIChmaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUgJiYgLy8gVHJlYXQgYGFjdGAgYXMgaWYgaXQncyBpbnNpZGUgYGJhdGNoZWRVcGRhdGVzYCwgZXZlbiBpbiBsZWdhY3kgbW9kZS4KICAgICAgICAgICAgICAhUmVhY3RDdXJyZW50QWN0UXVldWUkMS5pc0JhdGNoaW5nTGVnYWN5KSB7CiAgICAgICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgICAgICBmbHVzaFN5bmNDYWxsYmFja3NPbmx5SW5MZWdhY3lNb2RlKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZUluaXRpYWxIeWRyYXRpb25PblJvb3Qocm9vdDMsIGxhbmUsIGV2ZW50VGltZSkgewogICAgICAgICAgICB2YXIgY3VycmVudDIgPSByb290My5jdXJyZW50OwogICAgICAgICAgICBjdXJyZW50Mi5sYW5lcyA9IGxhbmU7CiAgICAgICAgICAgIG1hcmtSb290VXBkYXRlZChyb290MywgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBldmVudFRpbWUpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaXNVbnNhZmVDbGFzc1JlbmRlclBoYXNlVXBkYXRlKGZpYmVyKSB7CiAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgLy8gVE9ETzogUmVtb3ZlIG91dGRhdGVkIGRlZmVyUmVuZGVyUGhhc2VVcGRhdGVUb05leHRCYXRjaCBleHBlcmltZW50LiBXZQogICAgICAgICAgICAgIC8vIGRlY2lkZWQgbm90IHRvIGVuYWJsZSBpdC4KICAgICAgICAgICAgICAoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpICE9PSBOb0NvbnRleHQKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgY3VycmVudFRpbWUpIHsKICAgICAgICAgICAgdmFyIGV4aXN0aW5nQ2FsbGJhY2tOb2RlID0gcm9vdDMuY2FsbGJhY2tOb2RlOwogICAgICAgICAgICBtYXJrU3RhcnZlZExhbmVzQXNFeHBpcmVkKHJvb3QzLCBjdXJyZW50VGltZSk7CiAgICAgICAgICAgIHZhciBuZXh0TGFuZXMgPSBnZXROZXh0TGFuZXMocm9vdDMsIHJvb3QzID09PSB3b3JrSW5Qcm9ncmVzc1Jvb3QgPyB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA6IE5vTGFuZXMpOwogICAgICAgICAgICBpZiAobmV4dExhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nQ2FsbGJhY2tOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBjYW5jZWxDYWxsYmFjayQxKGV4aXN0aW5nQ2FsbGJhY2tOb2RlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcm9vdDMuY2FsbGJhY2tOb2RlID0gbnVsbDsKICAgICAgICAgICAgICByb290My5jYWxsYmFja1ByaW9yaXR5ID0gTm9MYW5lOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmV3Q2FsbGJhY2tQcmlvcml0eSA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobmV4dExhbmVzKTsKICAgICAgICAgICAgdmFyIGV4aXN0aW5nQ2FsbGJhY2tQcmlvcml0eSA9IHJvb3QzLmNhbGxiYWNrUHJpb3JpdHk7CiAgICAgICAgICAgIGlmIChleGlzdGluZ0NhbGxiYWNrUHJpb3JpdHkgPT09IG5ld0NhbGxiYWNrUHJpb3JpdHkgJiYgLy8gU3BlY2lhbCBjYXNlIHJlbGF0ZWQgdG8gYGFjdGAuIElmIHRoZSBjdXJyZW50bHkgc2NoZWR1bGVkIHRhc2sgaXMgYQogICAgICAgICAgICAvLyBTY2hlZHVsZXIgdGFzaywgcmF0aGVyIHRoYW4gYW4gYGFjdGAgdGFzaywgY2FuY2VsIGl0IGFuZCByZS1zY2hlZHVsZWQKICAgICAgICAgICAgLy8gb24gdGhlIGBhY3RgIHF1ZXVlLgogICAgICAgICAgICAhKFJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuY3VycmVudCAhPT0gbnVsbCAmJiBleGlzdGluZ0NhbGxiYWNrTm9kZSAhPT0gZmFrZUFjdENhbGxiYWNrTm9kZSkpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdDYWxsYmFja05vZGUgPT0gbnVsbCAmJiBleGlzdGluZ0NhbGxiYWNrUHJpb3JpdHkgIT09IFN5bmNMYW5lKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCBzY2hlZHVsZWQgY2FsbGJhY2sgdG8gZXhpc3QuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZXhpc3RpbmdDYWxsYmFja05vZGUgIT0gbnVsbCkgewogICAgICAgICAgICAgIGNhbmNlbENhbGxiYWNrJDEoZXhpc3RpbmdDYWxsYmFja05vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBuZXdDYWxsYmFja05vZGU7CiAgICAgICAgICAgIGlmIChuZXdDYWxsYmFja1ByaW9yaXR5ID09PSBTeW5jTGFuZSkgewogICAgICAgICAgICAgIGlmIChyb290My50YWcgPT09IExlZ2FjeVJvb3QpIHsKICAgICAgICAgICAgICAgIGlmIChSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmlzQmF0Y2hpbmdMZWdhY3kgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUkMS5kaWRTY2hlZHVsZUxlZ2FjeVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzY2hlZHVsZUxlZ2FjeVN5bmNDYWxsYmFjayhwZXJmb3JtU3luY1dvcmtPblJvb3QuYmluZChudWxsLCByb290MykpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzY2hlZHVsZVN5bmNDYWxsYmFjayhwZXJmb3JtU3luY1dvcmtPblJvb3QuYmluZChudWxsLCByb290MykpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuY3VycmVudC5wdXNoKGZsdXNoU3luY0NhbGxiYWNrcyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBzY2hlZHVsZU1pY3JvdGFzayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSA9PT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICBmbHVzaFN5bmNDYWxsYmFja3MoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBuZXdDYWxsYmFja05vZGUgPSBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBzY2hlZHVsZXJQcmlvcml0eUxldmVsOwogICAgICAgICAgICAgIHN3aXRjaCAobGFuZXNUb0V2ZW50UHJpb3JpdHkobmV4dExhbmVzKSkgewogICAgICAgICAgICAgICAgY2FzZSBEaXNjcmV0ZUV2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5TGV2ZWwgPSBJbW1lZGlhdGVQcmlvcml0eTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIENvbnRpbnVvdXNFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eUxldmVsID0gVXNlckJsb2NraW5nUHJpb3JpdHk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSBEZWZhdWx0RXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHlMZXZlbCA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgSWRsZUV2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5TGV2ZWwgPSBJZGxlUHJpb3JpdHk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHlMZXZlbCA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbmV3Q2FsbGJhY2tOb2RlID0gc2NoZWR1bGVDYWxsYmFjayQxKHNjaGVkdWxlclByaW9yaXR5TGV2ZWwsIHBlcmZvcm1Db25jdXJyZW50V29ya09uUm9vdC5iaW5kKG51bGwsIHJvb3QzKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcm9vdDMuY2FsbGJhY2tQcmlvcml0eSA9IG5ld0NhbGxiYWNrUHJpb3JpdHk7CiAgICAgICAgICAgIHJvb3QzLmNhbGxiYWNrTm9kZSA9IG5ld0NhbGxiYWNrTm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHBlcmZvcm1Db25jdXJyZW50V29ya09uUm9vdChyb290MywgZGlkVGltZW91dCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgcmVzZXROZXN0ZWRVcGRhdGVGbGFnKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3VycmVudEV2ZW50VGltZSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgICBjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZSA9IE5vTGFuZXM7CiAgICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpICE9PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBub3QgYWxyZWFkeSBiZSB3b3JraW5nLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBvcmlnaW5hbENhbGxiYWNrTm9kZSA9IHJvb3QzLmNhbGxiYWNrTm9kZTsKICAgICAgICAgICAgdmFyIGRpZEZsdXNoUGFzc2l2ZUVmZmVjdHMgPSBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICAgIGlmIChkaWRGbHVzaFBhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgaWYgKHJvb3QzLmNhbGxiYWNrTm9kZSAhPT0gb3JpZ2luYWxDYWxsYmFja05vZGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbGFuZXMgPSBnZXROZXh0TGFuZXMocm9vdDMsIHJvb3QzID09PSB3b3JrSW5Qcm9ncmVzc1Jvb3QgPyB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA6IE5vTGFuZXMpOwogICAgICAgICAgICBpZiAobGFuZXMgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2hvdWxkVGltZVNsaWNlID0gIWluY2x1ZGVzQmxvY2tpbmdMYW5lKHJvb3QzLCBsYW5lcykgJiYgIWluY2x1ZGVzRXhwaXJlZExhbmUocm9vdDMsIGxhbmVzKSAmJiAhZGlkVGltZW91dDsKICAgICAgICAgICAgdmFyIGV4aXRTdGF0dXMgPSBzaG91bGRUaW1lU2xpY2UgPyByZW5kZXJSb290Q29uY3VycmVudChyb290MywgbGFuZXMpIDogcmVuZGVyUm9vdFN5bmMocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgaWYgKGV4aXRTdGF0dXMgIT09IFJvb3RJblByb2dyZXNzKSB7CiAgICAgICAgICAgICAgaWYgKGV4aXRTdGF0dXMgPT09IFJvb3RFcnJvcmVkKSB7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3JSZXRyeUxhbmVzID0gZ2V0TGFuZXNUb1JldHJ5U3luY2hyb25vdXNseU9uRXJyb3Iocm9vdDMpOwogICAgICAgICAgICAgICAgaWYgKGVycm9yUmV0cnlMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgICBsYW5lcyA9IGVycm9yUmV0cnlMYW5lczsKICAgICAgICAgICAgICAgICAgZXhpdFN0YXR1cyA9IHJlY292ZXJGcm9tQ29uY3VycmVudEVycm9yKHJvb3QzLCBlcnJvclJldHJ5TGFuZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZXhpdFN0YXR1cyA9PT0gUm9vdEZhdGFsRXJyb3JlZCkgewogICAgICAgICAgICAgICAgdmFyIGZhdGFsRXJyb3IgPSB3b3JrSW5Qcm9ncmVzc1Jvb3RGYXRhbEVycm9yOwogICAgICAgICAgICAgICAgcHJlcGFyZUZyZXNoU3RhY2socm9vdDMsIE5vTGFuZXMpOwogICAgICAgICAgICAgICAgbWFya1Jvb3RTdXNwZW5kZWQkMShyb290MywgbGFuZXMpOwogICAgICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBub3cyKCkpOwogICAgICAgICAgICAgICAgdGhyb3cgZmF0YWxFcnJvcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGV4aXRTdGF0dXMgPT09IFJvb3REaWROb3RDb21wbGV0ZSkgewogICAgICAgICAgICAgICAgbWFya1Jvb3RTdXNwZW5kZWQkMShyb290MywgbGFuZXMpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgcmVuZGVyV2FzQ29uY3VycmVudCA9ICFpbmNsdWRlc0Jsb2NraW5nTGFuZShyb290MywgbGFuZXMpOwogICAgICAgICAgICAgICAgdmFyIGZpbmlzaGVkV29yayA9IHJvb3QzLmN1cnJlbnQuYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgaWYgKHJlbmRlcldhc0NvbmN1cnJlbnQgJiYgIWlzUmVuZGVyQ29uc2lzdGVudFdpdGhFeHRlcm5hbFN0b3JlcyhmaW5pc2hlZFdvcmspKSB7CiAgICAgICAgICAgICAgICAgIGV4aXRTdGF0dXMgPSByZW5kZXJSb290U3luYyhyb290MywgbGFuZXMpOwogICAgICAgICAgICAgICAgICBpZiAoZXhpdFN0YXR1cyA9PT0gUm9vdEVycm9yZWQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX2Vycm9yUmV0cnlMYW5lcyA9IGdldExhbmVzVG9SZXRyeVN5bmNocm9ub3VzbHlPbkVycm9yKHJvb3QzKTsKICAgICAgICAgICAgICAgICAgICBpZiAoX2Vycm9yUmV0cnlMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgICAgICAgbGFuZXMgPSBfZXJyb3JSZXRyeUxhbmVzOwogICAgICAgICAgICAgICAgICAgICAgZXhpdFN0YXR1cyA9IHJlY292ZXJGcm9tQ29uY3VycmVudEVycm9yKHJvb3QzLCBfZXJyb3JSZXRyeUxhbmVzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKGV4aXRTdGF0dXMgPT09IFJvb3RGYXRhbEVycm9yZWQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX2ZhdGFsRXJyb3IgPSB3b3JrSW5Qcm9ncmVzc1Jvb3RGYXRhbEVycm9yOwogICAgICAgICAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBub3cyKCkpOwogICAgICAgICAgICAgICAgICAgIHRocm93IF9mYXRhbEVycm9yOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByb290My5maW5pc2hlZFdvcmsgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICAgICAgICByb290My5maW5pc2hlZExhbmVzID0gbGFuZXM7CiAgICAgICAgICAgICAgICBmaW5pc2hDb25jdXJyZW50UmVuZGVyKHJvb3QzLCBleGl0U3RhdHVzLCBsYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93MigpKTsKICAgICAgICAgICAgaWYgKHJvb3QzLmNhbGxiYWNrTm9kZSA9PT0gb3JpZ2luYWxDYWxsYmFja05vZGUpIHsKICAgICAgICAgICAgICByZXR1cm4gcGVyZm9ybUNvbmN1cnJlbnRXb3JrT25Sb290LmJpbmQobnVsbCwgcm9vdDMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb3ZlckZyb21Db25jdXJyZW50RXJyb3Iocm9vdDMsIGVycm9yUmV0cnlMYW5lcykgewogICAgICAgICAgICB2YXIgZXJyb3JzRnJvbUZpcnN0QXR0ZW1wdCA9IHdvcmtJblByb2dyZXNzUm9vdENvbmN1cnJlbnRFcnJvcnM7CiAgICAgICAgICAgIGlmIChpc1Jvb3REZWh5ZHJhdGVkKHJvb3QzKSkgewogICAgICAgICAgICAgIHZhciByb290V29ya0luUHJvZ3Jlc3MgPSBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgZXJyb3JSZXRyeUxhbmVzKTsKICAgICAgICAgICAgICByb290V29ya0luUHJvZ3Jlc3MuZmxhZ3MgfD0gRm9yY2VDbGllbnRSZW5kZXI7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZXJyb3JIeWRyYXRpbmdDb250YWluZXIocm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBleGl0U3RhdHVzID0gcmVuZGVyUm9vdFN5bmMocm9vdDMsIGVycm9yUmV0cnlMYW5lcyk7CiAgICAgICAgICAgIGlmIChleGl0U3RhdHVzICE9PSBSb290RXJyb3JlZCkgewogICAgICAgICAgICAgIHZhciBlcnJvcnNGcm9tU2Vjb25kQXR0ZW1wdCA9IHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzID0gZXJyb3JzRnJvbUZpcnN0QXR0ZW1wdDsKICAgICAgICAgICAgICBpZiAoZXJyb3JzRnJvbVNlY29uZEF0dGVtcHQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHF1ZXVlUmVjb3ZlcmFibGVFcnJvcnMoZXJyb3JzRnJvbVNlY29uZEF0dGVtcHQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZXhpdFN0YXR1czsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHF1ZXVlUmVjb3ZlcmFibGVFcnJvcnMoZXJyb3JzKSB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzID0gZXJyb3JzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLnB1c2guYXBwbHkod29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMsIGVycm9ycyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGZpbmlzaENvbmN1cnJlbnRSZW5kZXIocm9vdDMsIGV4aXRTdGF0dXMsIGxhbmVzKSB7CiAgICAgICAgICAgIHN3aXRjaCAoZXhpdFN0YXR1cykgewogICAgICAgICAgICAgIGNhc2UgUm9vdEluUHJvZ3Jlc3M6CiAgICAgICAgICAgICAgY2FzZSBSb290RmF0YWxFcnJvcmVkOiB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJvb3QgZGlkIG5vdCBjb21wbGV0ZS4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBSb290RXJyb3JlZDogewogICAgICAgICAgICAgICAgY29tbWl0Um9vdChyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMsIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgUm9vdFN1c3BlbmRlZDogewogICAgICAgICAgICAgICAgbWFya1Jvb3RTdXNwZW5kZWQkMShyb290MywgbGFuZXMpOwogICAgICAgICAgICAgICAgaWYgKGluY2x1ZGVzT25seVJldHJpZXMobGFuZXMpICYmIC8vIGRvIG5vdCBkZWxheSBpZiB3ZSdyZSBpbnNpZGUgYW4gYWN0KCkgc2NvcGUKICAgICAgICAgICAgICAgICFzaG91bGRGb3JjZUZsdXNoRmFsbGJhY2tzSW5ERVYoKSkgewogICAgICAgICAgICAgICAgICB2YXIgbXNVbnRpbFRpbWVvdXQgPSBnbG9iYWxNb3N0UmVjZW50RmFsbGJhY2tUaW1lICsgRkFMTEJBQ0tfVEhST1RUTEVfTVMgLSBub3cyKCk7CiAgICAgICAgICAgICAgICAgIGlmIChtc1VudGlsVGltZW91dCA+IDEwKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG5leHRMYW5lcyA9IGdldE5leHRMYW5lcyhyb290MywgTm9MYW5lcyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG5leHRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHZhciBzdXNwZW5kZWRMYW5lcyA9IHJvb3QzLnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgICAgICAgICAgIGlmICghaXNTdWJzZXRPZkxhbmVzKHN1c3BlbmRlZExhbmVzLCBsYW5lcykpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgICAgICAgICAgICBtYXJrUm9vdFBpbmdlZChyb290Mywgc3VzcGVuZGVkTGFuZXMpOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJvb3QzLnRpbWVvdXRIYW5kbGUgPSBzY2hlZHVsZVRpbWVvdXQoY29tbWl0Um9vdC5iaW5kKG51bGwsIHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyksIG1zVW50aWxUaW1lb3V0KTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29tbWl0Um9vdChyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMsIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgUm9vdFN1c3BlbmRlZFdpdGhEZWxheTogewogICAgICAgICAgICAgICAgbWFya1Jvb3RTdXNwZW5kZWQkMShyb290MywgbGFuZXMpOwogICAgICAgICAgICAgICAgaWYgKGluY2x1ZGVzT25seVRyYW5zaXRpb25zKGxhbmVzKSkgewogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICghc2hvdWxkRm9yY2VGbHVzaEZhbGxiYWNrc0luREVWKCkpIHsKICAgICAgICAgICAgICAgICAgdmFyIG1vc3RSZWNlbnRFdmVudFRpbWUgPSBnZXRNb3N0UmVjZW50RXZlbnRUaW1lKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgICAgIHZhciBldmVudFRpbWVNcyA9IG1vc3RSZWNlbnRFdmVudFRpbWU7CiAgICAgICAgICAgICAgICAgIHZhciB0aW1lRWxhcHNlZE1zID0gbm93MigpIC0gZXZlbnRUaW1lTXM7CiAgICAgICAgICAgICAgICAgIHZhciBfbXNVbnRpbFRpbWVvdXQgPSBqbmQodGltZUVsYXBzZWRNcykgLSB0aW1lRWxhcHNlZE1zOwogICAgICAgICAgICAgICAgICBpZiAoX21zVW50aWxUaW1lb3V0ID4gMTApIHsKICAgICAgICAgICAgICAgICAgICByb290My50aW1lb3V0SGFuZGxlID0gc2NoZWR1bGVUaW1lb3V0KGNvbW1pdFJvb3QuYmluZChudWxsLCByb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMsIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMpLCBfbXNVbnRpbFRpbWVvdXQpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb21taXRSb290KHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBSb290Q29tcGxldGVkOiB7CiAgICAgICAgICAgICAgICBjb21taXRSb290KHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIHJvb3QgZXhpdCBzdGF0dXMuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpc1JlbmRlckNvbnNpc3RlbnRXaXRoRXh0ZXJuYWxTdG9yZXMoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICAgIHZhciBub2RlID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgIGlmIChub2RlLmZsYWdzICYgU3RvcmVDb25zaXN0ZW5jeSkgewogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gbm9kZS51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgIGlmICh1cGRhdGVRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgY2hlY2tzID0gdXBkYXRlUXVldWUuc3RvcmVzOwogICAgICAgICAgICAgICAgICBpZiAoY2hlY2tzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGVja3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBjaGVjayA9IGNoZWNrc1tpXTsKICAgICAgICAgICAgICAgICAgICAgIHZhciBnZXRTbmFwc2hvdCA9IGNoZWNrLmdldFNuYXBzaG90OwogICAgICAgICAgICAgICAgICAgICAgdmFyIHJlbmRlcmVkVmFsdWUgPSBjaGVjay52YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghb2JqZWN0SXMoZ2V0U25hcHNob3QoKSwgcmVuZGVyZWRWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBjaGlsZCA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgaWYgKG5vZGUuc3VidHJlZUZsYWdzICYgU3RvcmVDb25zaXN0ZW5jeSAmJiBjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgY2hpbGQucmV0dXJuID0gbm9kZTsKICAgICAgICAgICAgICAgIG5vZGUgPSBjaGlsZDsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2hpbGUgKG5vZGUuc2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IG5vZGUucmV0dXJuID09PSBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RTdXNwZW5kZWQkMShyb290Mywgc3VzcGVuZGVkTGFuZXMpIHsKICAgICAgICAgICAgc3VzcGVuZGVkTGFuZXMgPSByZW1vdmVMYW5lcyhzdXNwZW5kZWRMYW5lcywgd29ya0luUHJvZ3Jlc3NSb290UGluZ2VkTGFuZXMpOwogICAgICAgICAgICBzdXNwZW5kZWRMYW5lcyA9IHJlbW92ZUxhbmVzKHN1c3BlbmRlZExhbmVzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RJbnRlcmxlYXZlZFVwZGF0ZWRMYW5lcyk7CiAgICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkKHJvb3QzLCBzdXNwZW5kZWRMYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwZXJmb3JtU3luY1dvcmtPblJvb3Qocm9vdDMpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHN5bmNOZXN0ZWRVcGRhdGVGbGFnKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgIT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2hvdWxkIG5vdCBhbHJlYWR5IGJlIHdvcmtpbmcuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmx1c2hQYXNzaXZlRWZmZWN0cygpOwogICAgICAgICAgICB2YXIgbGFuZXMgPSBnZXROZXh0TGFuZXMocm9vdDMsIE5vTGFuZXMpOwogICAgICAgICAgICBpZiAoIWluY2x1ZGVzU29tZUxhbmUobGFuZXMsIFN5bmNMYW5lKSkgewogICAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93MigpKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZXhpdFN0YXR1cyA9IHJlbmRlclJvb3RTeW5jKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgIGlmIChyb290My50YWcgIT09IExlZ2FjeVJvb3QgJiYgZXhpdFN0YXR1cyA9PT0gUm9vdEVycm9yZWQpIHsKICAgICAgICAgICAgICB2YXIgZXJyb3JSZXRyeUxhbmVzID0gZ2V0TGFuZXNUb1JldHJ5U3luY2hyb25vdXNseU9uRXJyb3Iocm9vdDMpOwogICAgICAgICAgICAgIGlmIChlcnJvclJldHJ5TGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICAgIGxhbmVzID0gZXJyb3JSZXRyeUxhbmVzOwogICAgICAgICAgICAgICAgZXhpdFN0YXR1cyA9IHJlY292ZXJGcm9tQ29uY3VycmVudEVycm9yKHJvb3QzLCBlcnJvclJldHJ5TGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZXhpdFN0YXR1cyA9PT0gUm9vdEZhdGFsRXJyb3JlZCkgewogICAgICAgICAgICAgIHZhciBmYXRhbEVycm9yID0gd29ya0luUHJvZ3Jlc3NSb290RmF0YWxFcnJvcjsKICAgICAgICAgICAgICBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgTm9MYW5lcyk7CiAgICAgICAgICAgICAgbWFya1Jvb3RTdXNwZW5kZWQkMShyb290MywgbGFuZXMpOwogICAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93MigpKTsKICAgICAgICAgICAgICB0aHJvdyBmYXRhbEVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RGlkTm90Q29tcGxldGUpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJvb3QgZGlkIG5vdCBjb21wbGV0ZS4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZmluaXNoZWRXb3JrID0gcm9vdDMuY3VycmVudC5hbHRlcm5hdGU7CiAgICAgICAgICAgIHJvb3QzLmZpbmlzaGVkV29yayA9IGZpbmlzaGVkV29yazsKICAgICAgICAgICAgcm9vdDMuZmluaXNoZWRMYW5lcyA9IGxhbmVzOwogICAgICAgICAgICBjb21taXRSb290KHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyk7CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93MigpKTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBmbHVzaFJvb3Qocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICAgIGlmIChsYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgIG1hcmtSb290RW50YW5nbGVkKHJvb3QzLCBtZXJnZUxhbmVzKGxhbmVzLCBTeW5jTGFuZSkpOwogICAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93MigpKTsKICAgICAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSA9PT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgICAgICBmbHVzaFN5bmNDYWxsYmFja3MoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGJhdGNoZWRVcGRhdGVzJDEoZm4sIGEyKSB7CiAgICAgICAgICAgIHZhciBwcmV2RXhlY3V0aW9uQ29udGV4dCA9IGV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgfD0gQmF0Y2hlZENvbnRleHQ7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZuKGEyKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBleGVjdXRpb25Db250ZXh0ID0gcHJldkV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICAgICAgaWYgKGV4ZWN1dGlvbkNvbnRleHQgPT09IE5vQ29udGV4dCAmJiAvLyBUcmVhdCBgYWN0YCBhcyBpZiBpdCdzIGluc2lkZSBgYmF0Y2hlZFVwZGF0ZXNgLCBldmVuIGluIGxlZ2FjeSBtb2RlLgogICAgICAgICAgICAgICFSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmlzQmF0Y2hpbmdMZWdhY3kpIHsKICAgICAgICAgICAgICAgIHJlc2V0UmVuZGVyVGltZXIoKTsKICAgICAgICAgICAgICAgIGZsdXNoU3luY0NhbGxiYWNrc09ubHlJbkxlZ2FjeU1vZGUoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGRpc2NyZXRlVXBkYXRlcyhmbiwgYTIsIGIsIGMyLCBkKSB7CiAgICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbjsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBudWxsOwogICAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICAgIHJldHVybiBmbihhMiwgYiwgYzIsIGQpOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShwcmV2aW91c1ByaW9yaXR5KTsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgICBpZiAoZXhlY3V0aW9uQ29udGV4dCA9PT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBmbHVzaFN5bmMoZm4pIHsKICAgICAgICAgICAgaWYgKHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzICE9PSBudWxsICYmIHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzLnRhZyA9PT0gTGVnYWN5Um9vdCAmJiAoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpID09PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByZXZFeGVjdXRpb25Db250ZXh0ID0gZXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCB8PSBCYXRjaGVkQ29udGV4dDsKICAgICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uOwogICAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KERpc2NyZXRlRXZlbnRQcmlvcml0eSk7CiAgICAgICAgICAgICAgaWYgKGZuKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZm4oKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgPSBwcmV2RXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSA9PT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgICAgICBmbHVzaFN5bmNDYWxsYmFja3MoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGlzQWxyZWFkeVJlbmRlcmluZygpIHsKICAgICAgICAgICAgcmV0dXJuIChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgIT09IE5vQ29udGV4dDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHB1c2hSZW5kZXJMYW5lcyhmaWJlciwgbGFuZXMpIHsKICAgICAgICAgICAgcHVzaChzdWJ0cmVlUmVuZGVyTGFuZXNDdXJzb3IsIHN1YnRyZWVSZW5kZXJMYW5lcywgZmliZXIpOwogICAgICAgICAgICBzdWJ0cmVlUmVuZGVyTGFuZXMgPSBtZXJnZUxhbmVzKHN1YnRyZWVSZW5kZXJMYW5lcywgbGFuZXMpOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RJbmNsdWRlZExhbmVzID0gbWVyZ2VMYW5lcyh3b3JrSW5Qcm9ncmVzc1Jvb3RJbmNsdWRlZExhbmVzLCBsYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwb3BSZW5kZXJMYW5lcyhmaWJlcikgewogICAgICAgICAgICBzdWJ0cmVlUmVuZGVyTGFuZXMgPSBzdWJ0cmVlUmVuZGVyTGFuZXNDdXJzb3IuY3VycmVudDsKICAgICAgICAgICAgcG9wKHN1YnRyZWVSZW5kZXJMYW5lc0N1cnNvciwgZmliZXIpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcHJlcGFyZUZyZXNoU3RhY2socm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICAgIHJvb3QzLmZpbmlzaGVkV29yayA9IG51bGw7CiAgICAgICAgICAgIHJvb3QzLmZpbmlzaGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICB2YXIgdGltZW91dEhhbmRsZSA9IHJvb3QzLnRpbWVvdXRIYW5kbGU7CiAgICAgICAgICAgIGlmICh0aW1lb3V0SGFuZGxlICE9PSBub1RpbWVvdXQpIHsKICAgICAgICAgICAgICByb290My50aW1lb3V0SGFuZGxlID0gbm9UaW1lb3V0OwogICAgICAgICAgICAgIGNhbmNlbFRpbWVvdXQodGltZW91dEhhbmRsZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGludGVycnVwdGVkV29yayA9IHdvcmtJblByb2dyZXNzLnJldHVybjsKICAgICAgICAgICAgICB3aGlsZSAoaW50ZXJydXB0ZWRXb3JrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgY3VycmVudDIgPSBpbnRlcnJ1cHRlZFdvcmsuYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgdW53aW5kSW50ZXJydXB0ZWRXb3JrKGN1cnJlbnQyLCBpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgICAgaW50ZXJydXB0ZWRXb3JrID0gaW50ZXJydXB0ZWRXb3JrLnJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290ID0gcm9vdDM7CiAgICAgICAgICAgIHZhciByb290V29ya0luUHJvZ3Jlc3MgPSBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhyb290My5jdXJyZW50LCBudWxsKTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSByb290V29ya0luUHJvZ3Jlc3M7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzID0gc3VidHJlZVJlbmRlckxhbmVzID0gd29ya0luUHJvZ3Jlc3NSb290SW5jbHVkZWRMYW5lcyA9IGxhbmVzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdEluUHJvZ3Jlc3M7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEZhdGFsRXJyb3IgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RTa2lwcGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RJbnRlcmxlYXZlZFVwZGF0ZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFBpbmdlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290Q29uY3VycmVudEVycm9ycyA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzID0gbnVsbDsKICAgICAgICAgICAgZmluaXNoUXVldWVpbmdDb25jdXJyZW50VXBkYXRlcygpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZGlzY2FyZFBlbmRpbmdXYXJuaW5ncygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByb290V29ya0luUHJvZ3Jlc3M7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVFcnJvcihyb290MywgdGhyb3duVmFsdWUpIHsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIHZhciBlcnJvcmVkV29yayA9IHdvcmtJblByb2dyZXNzOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXNldENvbnRleHREZXBlbmRlbmNpZXMoKTsKICAgICAgICAgICAgICAgIHJlc2V0SG9va3NBZnRlclRocm93KCk7CiAgICAgICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIkMi5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgICAgIGlmIChlcnJvcmVkV29yayA9PT0gbnVsbCB8fCBlcnJvcmVkV29yay5yZXR1cm4gPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RGYXRhbEVycm9yZWQ7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEZhdGFsRXJyb3IgPSB0aHJvd25WYWx1ZTsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSBudWxsOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZW5hYmxlUHJvZmlsZXJUaW1lciAmJiBlcnJvcmVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmdBbmRSZWNvcmREZWx0YShlcnJvcmVkV29yaywgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZW5hYmxlU2NoZWR1bGluZ1Byb2ZpbGVyKSB7CiAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICAgICAgICAgIGlmICh0aHJvd25WYWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdGhyb3duVmFsdWUgPT09ICJvYmplY3QiICYmIHR5cGVvZiB0aHJvd25WYWx1ZS50aGVuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHdha2VhYmxlID0gdGhyb3duVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFN1c3BlbmRlZChlcnJvcmVkV29yaywgd2FrZWFibGUsIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50RXJyb3JlZChlcnJvcmVkV29yaywgdGhyb3duVmFsdWUsIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhyb3dFeGNlcHRpb24ocm9vdDMsIGVycm9yZWRXb3JrLnJldHVybiwgZXJyb3JlZFdvcmssIHRocm93blZhbHVlLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICBjb21wbGV0ZVVuaXRPZldvcmsoZXJyb3JlZFdvcmspOwogICAgICAgICAgICAgIH0gY2F0Y2ggKHlldEFub3RoZXJUaHJvd25WYWx1ZSkgewogICAgICAgICAgICAgICAgdGhyb3duVmFsdWUgPSB5ZXRBbm90aGVyVGhyb3duVmFsdWU7CiAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MgPT09IGVycm9yZWRXb3JrICYmIGVycm9yZWRXb3JrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yZWRXb3JrID0gZXJyb3JlZFdvcmsucmV0dXJuOwogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IGVycm9yZWRXb3JrOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZXJyb3JlZFdvcmsgPSB3b3JrSW5Qcm9ncmVzczsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0gd2hpbGUgKHRydWUpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcHVzaERpc3BhdGNoZXIoKSB7CiAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMi5jdXJyZW50OwogICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDIuY3VycmVudCA9IENvbnRleHRPbmx5RGlzcGF0Y2hlcjsKICAgICAgICAgICAgaWYgKHByZXZEaXNwYXRjaGVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIENvbnRleHRPbmx5RGlzcGF0Y2hlcjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHBvcERpc3BhdGNoZXIocHJldkRpc3BhdGNoZXIpIHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQyLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG1hcmtDb21taXRUaW1lT2ZGYWxsYmFjaygpIHsKICAgICAgICAgICAgZ2xvYmFsTW9zdFJlY2VudEZhbGxiYWNrVGltZSA9IG5vdzIoKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG1hcmtTa2lwcGVkVXBkYXRlTGFuZXMobGFuZSkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RTa2lwcGVkTGFuZXMgPSBtZXJnZUxhbmVzKGxhbmUsIHdvcmtJblByb2dyZXNzUm9vdFNraXBwZWRMYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZW5kZXJEaWRTdXNwZW5kKCkgewogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9PT0gUm9vdEluUHJvZ3Jlc3MpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdFN1c3BlbmRlZDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVuZGVyRGlkU3VzcGVuZERlbGF5SWZQb3NzaWJsZSgpIHsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RJblByb2dyZXNzIHx8IHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RTdXNwZW5kZWQgfHwgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9PT0gUm9vdEVycm9yZWQpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdFN1c3BlbmRlZFdpdGhEZWxheTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290ICE9PSBudWxsICYmIChpbmNsdWRlc05vbklkbGVXb3JrKHdvcmtJblByb2dyZXNzUm9vdFNraXBwZWRMYW5lcykgfHwgaW5jbHVkZXNOb25JZGxlV29yayh3b3JrSW5Qcm9ncmVzc1Jvb3RJbnRlcmxlYXZlZFVwZGF0ZWRMYW5lcykpKSB7CiAgICAgICAgICAgICAgbWFya1Jvb3RTdXNwZW5kZWQkMSh3b3JrSW5Qcm9ncmVzc1Jvb3QsIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVuZGVyRGlkRXJyb3IoZXJyb3IyKSB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzICE9PSBSb290U3VzcGVuZGVkV2l0aERlbGF5KSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RFcnJvcmVkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RDb25jdXJyZW50RXJyb3JzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290Q29uY3VycmVudEVycm9ycyA9IFtlcnJvcjJdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdENvbmN1cnJlbnRFcnJvcnMucHVzaChlcnJvcjIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZW5kZXJIYXNOb3RTdXNwZW5kZWRZZXQoKSB7CiAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290SW5Qcm9ncmVzczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlbmRlclJvb3RTeW5jKHJvb3QzLCBsYW5lcykgewogICAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgICBleGVjdXRpb25Db250ZXh0IHw9IFJlbmRlckNvbnRleHQ7CiAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IHB1c2hEaXNwYXRjaGVyKCk7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3QgIT09IHJvb3QzIHx8IHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzICE9PSBsYW5lcykgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgICAgICB2YXIgbWVtb2l6ZWRVcGRhdGVycyA9IHJvb3QzLm1lbW9pemVkVXBkYXRlcnM7CiAgICAgICAgICAgICAgICAgIGlmIChtZW1vaXplZFVwZGF0ZXJzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdG9yZVBlbmRpbmdVcGRhdGVycyhyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgICAgIG1lbW9pemVkVXBkYXRlcnMuY2xlYXIoKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBtb3ZlUGVuZGluZ0ZpYmVyc1RvTWVtb2l6ZWQocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyA9IGdldFRyYW5zaXRpb25zRm9yTGFuZXMoKTsKICAgICAgICAgICAgICBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgbGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrUmVuZGVyU3RhcnRlZChsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB3b3JrTG9vcFN5bmMoKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0gY2F0Y2ggKHRocm93blZhbHVlKSB7CiAgICAgICAgICAgICAgICBoYW5kbGVFcnJvcihyb290MywgdGhyb3duVmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSB3aGlsZSAodHJ1ZSk7CiAgICAgICAgICAgIHJlc2V0Q29udGV4dERlcGVuZGVuY2llcygpOwogICAgICAgICAgICBleGVjdXRpb25Db250ZXh0ID0gcHJldkV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICAgIHBvcERpc3BhdGNoZXIocHJldkRpc3BhdGNoZXIpOwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MgIT09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBjb21taXQgYW4gaW5jb21wbGV0ZSByb290LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrUmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdCA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB3b3JrTG9vcFN5bmMoKSB7CiAgICAgICAgICAgIHdoaWxlICh3b3JrSW5Qcm9ncmVzcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHBlcmZvcm1Vbml0T2ZXb3JrKHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVuZGVyUm9vdENvbmN1cnJlbnQocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBwcmV2RXhlY3V0aW9uQ29udGV4dCA9IGV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgfD0gUmVuZGVyQ29udGV4dDsKICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gcHVzaERpc3BhdGNoZXIoKTsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdCAhPT0gcm9vdDMgfHwgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgIT09IGxhbmVzKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgICAgIHZhciBtZW1vaXplZFVwZGF0ZXJzID0gcm9vdDMubWVtb2l6ZWRVcGRhdGVyczsKICAgICAgICAgICAgICAgICAgaWYgKG1lbW9pemVkVXBkYXRlcnMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgICAgICByZXN0b3JlUGVuZGluZ1VwZGF0ZXJzKHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICAgICAgbWVtb2l6ZWRVcGRhdGVycy5jbGVhcigpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIG1vdmVQZW5kaW5nRmliZXJzVG9NZW1vaXplZChyb290MywgbGFuZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zID0gZ2V0VHJhbnNpdGlvbnNGb3JMYW5lcygpOwogICAgICAgICAgICAgIHJlc2V0UmVuZGVyVGltZXIoKTsKICAgICAgICAgICAgICBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgbGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrUmVuZGVyU3RhcnRlZChsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB3b3JrTG9vcENvbmN1cnJlbnQoKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0gY2F0Y2ggKHRocm93blZhbHVlKSB7CiAgICAgICAgICAgICAgICBoYW5kbGVFcnJvcihyb290MywgdGhyb3duVmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSB3aGlsZSAodHJ1ZSk7CiAgICAgICAgICAgIHJlc2V0Q29udGV4dERlcGVuZGVuY2llcygpOwogICAgICAgICAgICBwb3BEaXNwYXRjaGVyKHByZXZEaXNwYXRjaGVyKTsKICAgICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MgIT09IG51bGwpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBtYXJrUmVuZGVyWWllbGRlZCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gUm9vdEluUHJvZ3Jlc3M7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWFya1JlbmRlclN0b3BwZWQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290ID0gbnVsbDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHdvcmtMb29wQ29uY3VycmVudCgpIHsKICAgICAgICAgICAgd2hpbGUgKHdvcmtJblByb2dyZXNzICE9PSBudWxsICYmICFzaG91bGRZaWVsZCgpKSB7CiAgICAgICAgICAgICAgcGVyZm9ybVVuaXRPZldvcmsod29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwZXJmb3JtVW5pdE9mV29yayh1bml0T2ZXb3JrKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50MiA9IHVuaXRPZldvcmsuYWx0ZXJuYXRlOwogICAgICAgICAgICBzZXRDdXJyZW50RmliZXIodW5pdE9mV29yayk7CiAgICAgICAgICAgIHZhciBuZXh0OwogICAgICAgICAgICBpZiAoKHVuaXRPZldvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgc3RhcnRQcm9maWxlclRpbWVyKHVuaXRPZldvcmspOwogICAgICAgICAgICAgIG5leHQgPSBiZWdpbldvcmskMShjdXJyZW50MiwgdW5pdE9mV29yaywgc3VidHJlZVJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZ0FuZFJlY29yZERlbHRhKHVuaXRPZldvcmssIHRydWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5leHQgPSBiZWdpbldvcmskMShjdXJyZW50MiwgdW5pdE9mV29yaywgc3VidHJlZVJlbmRlckxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICB1bml0T2ZXb3JrLm1lbW9pemVkUHJvcHMgPSB1bml0T2ZXb3JrLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgaWYgKG5leHQgPT09IG51bGwpIHsKICAgICAgICAgICAgICBjb21wbGV0ZVVuaXRPZldvcmsodW5pdE9mV29yayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSBuZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDIuY3VycmVudCA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjb21wbGV0ZVVuaXRPZldvcmsodW5pdE9mV29yaykgewogICAgICAgICAgICB2YXIgY29tcGxldGVkV29yayA9IHVuaXRPZldvcms7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICB2YXIgY3VycmVudDIgPSBjb21wbGV0ZWRXb3JrLmFsdGVybmF0ZTsKICAgICAgICAgICAgICB2YXIgcmV0dXJuRmliZXIgPSBjb21wbGV0ZWRXb3JrLnJldHVybjsKICAgICAgICAgICAgICBpZiAoKGNvbXBsZXRlZFdvcmsuZmxhZ3MgJiBJbmNvbXBsZXRlKSA9PT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGNvbXBsZXRlZFdvcmspOwogICAgICAgICAgICAgICAgdmFyIG5leHQgPSB2b2lkIDA7CiAgICAgICAgICAgICAgICBpZiAoKGNvbXBsZXRlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIG5leHQgPSBjb21wbGV0ZVdvcmsoY3VycmVudDIsIGNvbXBsZXRlZFdvcmssIHN1YnRyZWVSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBzdGFydFByb2ZpbGVyVGltZXIoY29tcGxldGVkV29yayk7CiAgICAgICAgICAgICAgICAgIG5leHQgPSBjb21wbGV0ZVdvcmsoY3VycmVudDIsIGNvbXBsZXRlZFdvcmssIHN1YnRyZWVSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICAgIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nQW5kUmVjb3JkRGVsdGEoY29tcGxldGVkV29yaywgZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICAgIGlmIChuZXh0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gbmV4dDsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgX25leHQgPSB1bndpbmRXb3JrKGN1cnJlbnQyLCBjb21wbGV0ZWRXb3JrKTsKICAgICAgICAgICAgICAgIGlmIChfbmV4dCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBfbmV4dC5mbGFncyAmPSBIb3N0RWZmZWN0TWFzazsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSBfbmV4dDsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKChjb21wbGV0ZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZ0FuZFJlY29yZERlbHRhKGNvbXBsZXRlZFdvcmssIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgdmFyIGFjdHVhbER1cmF0aW9uID0gY29tcGxldGVkV29yay5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gY29tcGxldGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgYWN0dWFsRHVyYXRpb24gKz0gY2hpbGQuYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNvbXBsZXRlZFdvcmsuYWN0dWFsRHVyYXRpb24gPSBhY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChyZXR1cm5GaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm5GaWJlci5mbGFncyB8PSBJbmNvbXBsZXRlOwogICAgICAgICAgICAgICAgICByZXR1cm5GaWJlci5zdWJ0cmVlRmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgICAgICAgICByZXR1cm5GaWJlci5kZWxldGlvbnMgPSBudWxsOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3REaWROb3RDb21wbGV0ZTsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSBudWxsOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBzaWJsaW5nRmliZXIgPSBjb21wbGV0ZWRXb3JrLnNpYmxpbmc7CiAgICAgICAgICAgICAgaWYgKHNpYmxpbmdGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSBzaWJsaW5nRmliZXI7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbXBsZXRlZFdvcmsgPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IGNvbXBsZXRlZFdvcms7CiAgICAgICAgICAgIH0gd2hpbGUgKGNvbXBsZXRlZFdvcmsgIT09IG51bGwpOwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9PT0gUm9vdEluUHJvZ3Jlc3MpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdENvbXBsZXRlZDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY29tbWl0Um9vdChyb290MywgcmVjb3ZlcmFibGVFcnJvcnMsIHRyYW5zaXRpb25zKSB7CiAgICAgICAgICAgIHZhciBwcmV2aW91c1VwZGF0ZUxhbmVQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb247CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoRGlzY3JldGVFdmVudFByaW9yaXR5KTsKICAgICAgICAgICAgICBjb21taXRSb290SW1wbChyb290MywgcmVjb3ZlcmFibGVFcnJvcnMsIHRyYW5zaXRpb25zLCBwcmV2aW91c1VwZGF0ZUxhbmVQcmlvcml0eSk7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gcHJldlRyYW5zaXRpb247CiAgICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzVXBkYXRlTGFuZVByaW9yaXR5KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNvbW1pdFJvb3RJbXBsKHJvb3QzLCByZWNvdmVyYWJsZUVycm9ycywgdHJhbnNpdGlvbnMsIHJlbmRlclByaW9yaXR5TGV2ZWwpIHsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgICAgfSB3aGlsZSAocm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgIT09IG51bGwpOwogICAgICAgICAgICBmbHVzaFJlbmRlclBoYXNlU3RyaWN0TW9kZVdhcm5pbmdzSW5ERVYoKTsKICAgICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgIT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2hvdWxkIG5vdCBhbHJlYWR5IGJlIHdvcmtpbmcuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGZpbmlzaGVkV29yayA9IHJvb3QzLmZpbmlzaGVkV29yazsKICAgICAgICAgICAgdmFyIGxhbmVzID0gcm9vdDMuZmluaXNoZWRMYW5lczsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtDb21taXRTdGFydGVkKGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrID09PSBudWxsKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWFya0NvbW1pdFN0b3BwZWQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGxhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJyb290LmZpbmlzaGVkTGFuZXMgc2hvdWxkIG5vdCBiZSBlbXB0eSBkdXJpbmcgYSBjb21taXQuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJvb3QzLmZpbmlzaGVkV29yayA9IG51bGw7CiAgICAgICAgICAgIHJvb3QzLmZpbmlzaGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrID09PSByb290My5jdXJyZW50KSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgY29tbWl0IHRoZSBzYW1lIHRyZWUgYXMgYmVmb3JlLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJvb3QzLmNhbGxiYWNrTm9kZSA9IG51bGw7CiAgICAgICAgICAgIHJvb3QzLmNhbGxiYWNrUHJpb3JpdHkgPSBOb0xhbmU7CiAgICAgICAgICAgIHZhciByZW1haW5pbmdMYW5lcyA9IG1lcmdlTGFuZXMoZmluaXNoZWRXb3JrLmxhbmVzLCBmaW5pc2hlZFdvcmsuY2hpbGRMYW5lcyk7CiAgICAgICAgICAgIG1hcmtSb290RmluaXNoZWQocm9vdDMsIHJlbWFpbmluZ0xhbmVzKTsKICAgICAgICAgICAgaWYgKHJvb3QzID09PSB3b3JrSW5Qcm9ncmVzc1Jvb3QpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gbnVsbDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKChmaW5pc2hlZFdvcmsuc3VidHJlZUZsYWdzICYgUGFzc2l2ZU1hc2spICE9PSBOb0ZsYWdzIHx8IChmaW5pc2hlZFdvcmsuZmxhZ3MgJiBQYXNzaXZlTWFzaykgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICBpZiAoIXJvb3REb2VzSGF2ZVBhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgICByb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cyA9IHRydWU7CiAgICAgICAgICAgICAgICBwZW5kaW5nUGFzc2l2ZVRyYW5zaXRpb25zID0gdHJhbnNpdGlvbnM7CiAgICAgICAgICAgICAgICBzY2hlZHVsZUNhbGxiYWNrJDEoTm9ybWFsUHJpb3JpdHksIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzdWJ0cmVlSGFzRWZmZWN0cyA9IChmaW5pc2hlZFdvcmsuc3VidHJlZUZsYWdzICYgKEJlZm9yZU11dGF0aW9uTWFzayB8IE11dGF0aW9uTWFzayB8IExheW91dE1hc2sgfCBQYXNzaXZlTWFzaykpICE9PSBOb0ZsYWdzOwogICAgICAgICAgICB2YXIgcm9vdEhhc0VmZmVjdCA9IChmaW5pc2hlZFdvcmsuZmxhZ3MgJiAoQmVmb3JlTXV0YXRpb25NYXNrIHwgTXV0YXRpb25NYXNrIHwgTGF5b3V0TWFzayB8IFBhc3NpdmVNYXNrKSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICAgIGlmIChzdWJ0cmVlSGFzRWZmZWN0cyB8fCByb290SGFzRWZmZWN0KSB7CiAgICAgICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uOwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoRGlzY3JldGVFdmVudFByaW9yaXR5KTsKICAgICAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgfD0gQ29tbWl0Q29udGV4dDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQyLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICAgIHZhciBzaG91bGRGaXJlQWZ0ZXJBY3RpdmVJbnN0YW5jZUJsdXIyID0gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJlY29yZENvbW1pdFRpbWUoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29tbWl0TXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmssIGxhbmVzKTsKICAgICAgICAgICAgICByZXNldEFmdGVyQ29tbWl0KHJvb3QzLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgIHJvb3QzLmN1cnJlbnQgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWFya0xheW91dEVmZmVjdHNTdGFydGVkKGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29tbWl0TGF5b3V0RWZmZWN0cyhmaW5pc2hlZFdvcmssIHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWFya0xheW91dEVmZmVjdHNTdG9wcGVkKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlcXVlc3RQYWludCgpOwogICAgICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgPSBwcmV2RXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gcHJldlRyYW5zaXRpb247CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcm9vdDMuY3VycmVudCA9IGZpbmlzaGVkV29yazsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZWNvcmRDb21taXRUaW1lKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290RGlkSGF2ZVBhc3NpdmVFZmZlY3RzID0gcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHM7CiAgICAgICAgICAgIGlmIChyb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIHJvb3REb2VzSGF2ZVBhc3NpdmVFZmZlY3RzID0gZmFsc2U7CiAgICAgICAgICAgICAgcm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgPSByb290MzsKICAgICAgICAgICAgICBwZW5kaW5nUGFzc2l2ZUVmZmVjdHNMYW5lcyA9IGxhbmVzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG5lc3RlZFBhc3NpdmVVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgICAgICAgICByb290V2l0aFBhc3NpdmVOZXN0ZWRVcGRhdGVzID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVtYWluaW5nTGFuZXMgPSByb290My5wZW5kaW5nTGFuZXM7CiAgICAgICAgICAgIGlmIChyZW1haW5pbmdMYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICAgIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCFyb290RGlkSGF2ZVBhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgICBjb21taXREb3VibGVJbnZva2VFZmZlY3RzSW5ERVYocm9vdDMuY3VycmVudCwgZmFsc2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBvbkNvbW1pdFJvb3QoZmluaXNoZWRXb3JrLnN0YXRlTm9kZSwgcmVuZGVyUHJpb3JpdHlMZXZlbCk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICAgIHJvb3QzLm1lbW9pemVkVXBkYXRlcnMuY2xlYXIoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIG9uQ29tbWl0Um9vdCQxKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBub3cyKCkpOwogICAgICAgICAgICBpZiAocmVjb3ZlcmFibGVFcnJvcnMgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgb25SZWNvdmVyYWJsZUVycm9yID0gcm9vdDMub25SZWNvdmVyYWJsZUVycm9yOwogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVjb3ZlcmFibGVFcnJvcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciByZWNvdmVyYWJsZUVycm9yID0gcmVjb3ZlcmFibGVFcnJvcnNbaV07CiAgICAgICAgICAgICAgICB2YXIgY29tcG9uZW50U3RhY2sgPSByZWNvdmVyYWJsZUVycm9yLnN0YWNrOwogICAgICAgICAgICAgICAgdmFyIGRpZ2VzdCA9IHJlY292ZXJhYmxlRXJyb3IuZGlnZXN0OwogICAgICAgICAgICAgICAgb25SZWNvdmVyYWJsZUVycm9yKHJlY292ZXJhYmxlRXJyb3IudmFsdWUsIHsKICAgICAgICAgICAgICAgICAgY29tcG9uZW50U3RhY2ssCiAgICAgICAgICAgICAgICAgIGRpZ2VzdAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChoYXNVbmNhdWdodEVycm9yKSB7CiAgICAgICAgICAgICAgaGFzVW5jYXVnaHRFcnJvciA9IGZhbHNlOwogICAgICAgICAgICAgIHZhciBlcnJvciQxID0gZmlyc3RVbmNhdWdodEVycm9yOwogICAgICAgICAgICAgIGZpcnN0VW5jYXVnaHRFcnJvciA9IG51bGw7CiAgICAgICAgICAgICAgdGhyb3cgZXJyb3IkMTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW5jbHVkZXNTb21lTGFuZShwZW5kaW5nUGFzc2l2ZUVmZmVjdHNMYW5lcywgU3luY0xhbmUpICYmIHJvb3QzLnRhZyAhPT0gTGVnYWN5Um9vdCkgewogICAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZW1haW5pbmdMYW5lcyA9IHJvb3QzLnBlbmRpbmdMYW5lczsKICAgICAgICAgICAgaWYgKGluY2x1ZGVzU29tZUxhbmUocmVtYWluaW5nTGFuZXMsIFN5bmNMYW5lKSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1hcmtOZXN0ZWRVcGRhdGVTY2hlZHVsZWQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHJvb3QzID09PSByb290V2l0aE5lc3RlZFVwZGF0ZXMpIHsKICAgICAgICAgICAgICAgIG5lc3RlZFVwZGF0ZUNvdW50Kys7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5lc3RlZFVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgICAgICAgIHJvb3RXaXRoTmVzdGVkVXBkYXRlcyA9IHJvb3QzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXN0ZWRVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrQ29tbWl0U3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZmx1c2hQYXNzaXZlRWZmZWN0cygpIHsKICAgICAgICAgICAgaWYgKHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHJlbmRlclByaW9yaXR5ID0gbGFuZXNUb0V2ZW50UHJpb3JpdHkocGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXMpOwogICAgICAgICAgICAgIHZhciBwcmlvcml0eSA9IGxvd2VyRXZlbnRQcmlvcml0eShEZWZhdWx0RXZlbnRQcmlvcml0eSwgcmVuZGVyUHJpb3JpdHkpOwogICAgICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbjsKICAgICAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBudWxsOwogICAgICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByaW9yaXR5KTsKICAgICAgICAgICAgICAgIHJldHVybiBmbHVzaFBhc3NpdmVFZmZlY3RzSW1wbCgpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZVBlbmRpbmdQYXNzaXZlUHJvZmlsZXJFZmZlY3QoZmliZXIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHBlbmRpbmdQYXNzaXZlUHJvZmlsZXJFZmZlY3RzLnB1c2goZmliZXIpOwogICAgICAgICAgICAgIGlmICghcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgICAgIHJvb3REb2VzSGF2ZVBhc3NpdmVFZmZlY3RzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2skMShOb3JtYWxQcmlvcml0eSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGZsdXNoUGFzc2l2ZUVmZmVjdHNJbXBsKCkgewogICAgICAgICAgICBpZiAocm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRyYW5zaXRpb25zID0gcGVuZGluZ1Bhc3NpdmVUcmFuc2l0aW9uczsKICAgICAgICAgICAgcGVuZGluZ1Bhc3NpdmVUcmFuc2l0aW9ucyA9IG51bGw7CiAgICAgICAgICAgIHZhciByb290MyA9IHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzOwogICAgICAgICAgICB2YXIgbGFuZXMgPSBwZW5kaW5nUGFzc2l2ZUVmZmVjdHNMYW5lczsKICAgICAgICAgICAgcm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgPSBudWxsOwogICAgICAgICAgICBwZW5kaW5nUGFzc2l2ZUVmZmVjdHNMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpICE9PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBmbHVzaCBwYXNzaXZlIGVmZmVjdHMgd2hpbGUgYWxyZWFkeSByZW5kZXJpbmcuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlzRmx1c2hpbmdQYXNzaXZlRWZmZWN0cyA9IHRydWU7CiAgICAgICAgICAgICAgZGlkU2NoZWR1bGVVcGRhdGVEdXJpbmdQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrUGFzc2l2ZUVmZmVjdHNTdGFydGVkKGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgICBleGVjdXRpb25Db250ZXh0IHw9IENvbW1pdENvbnRleHQ7CiAgICAgICAgICAgIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0cyhyb290My5jdXJyZW50KTsKICAgICAgICAgICAgY29tbWl0UGFzc2l2ZU1vdW50RWZmZWN0cyhyb290Mywgcm9vdDMuY3VycmVudCwgbGFuZXMsIHRyYW5zaXRpb25zKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBwcm9maWxlckVmZmVjdHMgPSBwZW5kaW5nUGFzc2l2ZVByb2ZpbGVyRWZmZWN0czsKICAgICAgICAgICAgICBwZW5kaW5nUGFzc2l2ZVByb2ZpbGVyRWZmZWN0cyA9IFtdOwogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJvZmlsZXJFZmZlY3RzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgX2ZpYmVyID0gcHJvZmlsZXJFZmZlY3RzW2ldOwogICAgICAgICAgICAgICAgY29tbWl0UGFzc2l2ZUVmZmVjdER1cmF0aW9ucyhyb290MywgX2ZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtQYXNzaXZlRWZmZWN0c1N0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY29tbWl0RG91YmxlSW52b2tlRWZmZWN0c0luREVWKHJvb3QzLmN1cnJlbnQsIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgPSBwcmV2RXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoZGlkU2NoZWR1bGVVcGRhdGVEdXJpbmdQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgICAgaWYgKHJvb3QzID09PSByb290V2l0aFBhc3NpdmVOZXN0ZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgICAgIG5lc3RlZFBhc3NpdmVVcGRhdGVDb3VudCsrOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgbmVzdGVkUGFzc2l2ZVVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgICAgICAgICAgcm9vdFdpdGhQYXNzaXZlTmVzdGVkVXBkYXRlcyA9IHJvb3QzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpc0ZsdXNoaW5nUGFzc2l2ZUVmZmVjdHMgPSBmYWxzZTsKICAgICAgICAgICAgICBkaWRTY2hlZHVsZVVwZGF0ZUR1cmluZ1Bhc3NpdmVFZmZlY3RzID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb25Qb3N0Q29tbWl0Um9vdChyb290Myk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gcm9vdDMuY3VycmVudC5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgc3RhdGVOb2RlLmVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICBzdGF0ZU5vZGUucGFzc2l2ZUVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGlzQWxyZWFkeUZhaWxlZExlZ2FjeUVycm9yQm91bmRhcnkoaW5zdGFuY2UpIHsKICAgICAgICAgICAgcmV0dXJuIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkICE9PSBudWxsICYmIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkLmhhcyhpbnN0YW5jZSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtYXJrTGVnYWN5RXJyb3JCb3VuZGFyeUFzRmFpbGVkKGluc3RhbmNlKSB7CiAgICAgICAgICAgIGlmIChsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoW2luc3RhbmNlXSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbGVnYWN5RXJyb3JCb3VuZGFyaWVzVGhhdEFscmVhZHlGYWlsZWQuYWRkKGluc3RhbmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcHJlcGFyZVRvVGhyb3dVbmNhdWdodEVycm9yKGVycm9yMikgewogICAgICAgICAgICBpZiAoIWhhc1VuY2F1Z2h0RXJyb3IpIHsKICAgICAgICAgICAgICBoYXNVbmNhdWdodEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICBmaXJzdFVuY2F1Z2h0RXJyb3IgPSBlcnJvcjI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBvblVuY2F1Z2h0RXJyb3IgPSBwcmVwYXJlVG9UaHJvd1VuY2F1Z2h0RXJyb3I7CiAgICAgICAgICBmdW5jdGlvbiBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvck9uUm9vdChyb290RmliZXIsIHNvdXJjZUZpYmVyLCBlcnJvcjIpIHsKICAgICAgICAgICAgdmFyIGVycm9ySW5mbyA9IGNyZWF0ZUNhcHR1cmVkVmFsdWVBdEZpYmVyKGVycm9yMiwgc291cmNlRmliZXIpOwogICAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlUm9vdEVycm9yVXBkYXRlKHJvb3RGaWJlciwgZXJyb3JJbmZvLCBTeW5jTGFuZSk7CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVVcGRhdGUocm9vdEZpYmVyLCB1cGRhdGUsIFN5bmNMYW5lKTsKICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgbWFya1Jvb3RVcGRhdGVkKHJvb3QzLCBTeW5jTGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIGV2ZW50VGltZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKHNvdXJjZUZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBlcnJvciQxKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZXBvcnRVbmNhdWdodEVycm9ySW5ERVYoZXJyb3IkMSk7CiAgICAgICAgICAgICAgc2V0SXNSdW5uaW5nSW5zZXJ0aW9uRWZmZWN0KGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc291cmNlRmliZXIudGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yT25Sb290KHNvdXJjZUZpYmVyLCBzb3VyY2VGaWJlciwgZXJyb3IkMSk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBmaWJlciA9IG51bGw7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBmaWJlciA9IG5lYXJlc3RNb3VudGVkQW5jZXN0b3I7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKGZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yT25Sb290KGZpYmVyLCBzb3VyY2VGaWJlciwgZXJyb3IkMSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChmaWJlci50YWcgPT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgY3RvciA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRDYXRjaCA9PT0gImZ1bmN0aW9uIiAmJiAhaXNBbHJlYWR5RmFpbGVkTGVnYWN5RXJyb3JCb3VuZGFyeShpbnN0YW5jZSkpIHsKICAgICAgICAgICAgICAgICAgdmFyIGVycm9ySW5mbyA9IGNyZWF0ZUNhcHR1cmVkVmFsdWVBdEZpYmVyKGVycm9yJDEsIHNvdXJjZUZpYmVyKTsKICAgICAgICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZUNsYXNzRXJyb3JVcGRhdGUoZmliZXIsIGVycm9ySW5mbywgU3luY0xhbmUpOwogICAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlVXBkYXRlKGZpYmVyLCB1cGRhdGUsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya1Jvb3RVcGRhdGVkKHJvb3QzLCBTeW5jTGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmaWJlciA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3IoIkludGVybmFsIFJlYWN0IGVycm9yOiBBdHRlbXB0ZWQgdG8gY2FwdHVyZSBhIGNvbW1pdCBwaGFzZSBlcnJvciBpbnNpZGUgYSBkZXRhY2hlZCB0cmVlLiBUaGlzIGluZGljYXRlcyBhIGJ1ZyBpbiBSZWFjdC4gTGlrZWx5IGNhdXNlcyBpbmNsdWRlIGRlbGV0aW5nIHRoZSBzYW1lIGZpYmVyIG1vcmUgdGhhbiBvbmNlLCBjb21taXR0aW5nIGFuIGFscmVhZHktZmluaXNoZWQgdHJlZSwgb3IgYW4gaW5jb25zaXN0ZW50IHJldHVybiBwb2ludGVyLlxuXG5FcnJvciBtZXNzYWdlOlxuXG4lcyIsIGVycm9yJDEpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwaW5nU3VzcGVuZGVkUm9vdChyb290Mywgd2FrZWFibGUsIHBpbmdlZExhbmVzKSB7CiAgICAgICAgICAgIHZhciBwaW5nQ2FjaGUgPSByb290My5waW5nQ2FjaGU7CiAgICAgICAgICAgIGlmIChwaW5nQ2FjaGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBwaW5nQ2FjaGUuZGVsZXRlKHdha2VhYmxlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICBtYXJrUm9vdFBpbmdlZChyb290MywgcGluZ2VkTGFuZXMpOwogICAgICAgICAgICB3YXJuSWZTdXNwZW5zZVJlc29sdXRpb25Ob3RXcmFwcGVkV2l0aEFjdERFVihyb290Myk7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3QgPT09IHJvb3QzICYmIGlzU3Vic2V0T2ZMYW5lcyh3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcywgcGluZ2VkTGFuZXMpKSB7CiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RTdXNwZW5kZWRXaXRoRGVsYXkgfHwgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9PT0gUm9vdFN1c3BlbmRlZCAmJiBpbmNsdWRlc09ubHlSZXRyaWVzKHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKSAmJiBub3cyKCkgLSBnbG9iYWxNb3N0UmVjZW50RmFsbGJhY2tUaW1lIDwgRkFMTEJBQ0tfVEhST1RUTEVfTVMpIHsKICAgICAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UGluZ2VkTGFuZXMgPSBtZXJnZUxhbmVzKHdvcmtJblByb2dyZXNzUm9vdFBpbmdlZExhbmVzLCBwaW5nZWRMYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJldHJ5VGltZWRPdXRCb3VuZGFyeShib3VuZGFyeUZpYmVyLCByZXRyeUxhbmUpIHsKICAgICAgICAgICAgaWYgKHJldHJ5TGFuZSA9PT0gTm9MYW5lKSB7CiAgICAgICAgICAgICAgcmV0cnlMYW5lID0gcmVxdWVzdFJldHJ5TGFuZShib3VuZGFyeUZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoYm91bmRhcnlGaWJlciwgcmV0cnlMYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgbWFya1Jvb3RVcGRhdGVkKHJvb3QzLCByZXRyeUxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBldmVudFRpbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZXRyeURlaHlkcmF0ZWRTdXNwZW5zZUJvdW5kYXJ5KGJvdW5kYXJ5RmliZXIpIHsKICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSBib3VuZGFyeUZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIHZhciByZXRyeUxhbmUgPSBOb0xhbmU7CiAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0cnlMYW5lID0gc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0cnlUaW1lZE91dEJvdW5kYXJ5KGJvdW5kYXJ5RmliZXIsIHJldHJ5TGFuZSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZXNvbHZlUmV0cnlXYWtlYWJsZShib3VuZGFyeUZpYmVyLCB3YWtlYWJsZSkgewogICAgICAgICAgICB2YXIgcmV0cnlMYW5lID0gTm9MYW5lOwogICAgICAgICAgICB2YXIgcmV0cnlDYWNoZTsKICAgICAgICAgICAgc3dpdGNoIChib3VuZGFyeUZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6CiAgICAgICAgICAgICAgICByZXRyeUNhY2hlID0gYm91bmRhcnlGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGJvdW5kYXJ5RmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJldHJ5TGFuZSA9IHN1c3BlbnNlU3RhdGUucmV0cnlMYW5lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgICByZXRyeUNhY2hlID0gYm91bmRhcnlGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJQaW5nZWQgdW5rbm93biBzdXNwZW5zZSBib3VuZGFyeSB0eXBlLiBUaGlzIGlzIHByb2JhYmx5IGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZXRyeUNhY2hlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0cnlDYWNoZS5kZWxldGUod2FrZWFibGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHJ5VGltZWRPdXRCb3VuZGFyeShib3VuZGFyeUZpYmVyLCByZXRyeUxhbmUpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gam5kKHRpbWVFbGFwc2VkKSB7CiAgICAgICAgICAgIHJldHVybiB0aW1lRWxhcHNlZCA8IDEyMCA/IDEyMCA6IHRpbWVFbGFwc2VkIDwgNDgwID8gNDgwIDogdGltZUVsYXBzZWQgPCAxMDgwID8gMTA4MCA6IHRpbWVFbGFwc2VkIDwgMTkyMCA/IDE5MjAgOiB0aW1lRWxhcHNlZCA8IDNlMyA/IDNlMyA6IHRpbWVFbGFwc2VkIDwgNDMyMCA/IDQzMjAgOiBjZWlsKHRpbWVFbGFwc2VkIC8gMTk2MCkgKiAxOTYwOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY2hlY2tGb3JOZXN0ZWRVcGRhdGVzKCkgewogICAgICAgICAgICBpZiAobmVzdGVkVXBkYXRlQ291bnQgPiBORVNURURfVVBEQVRFX0xJTUlUKSB7CiAgICAgICAgICAgICAgbmVzdGVkVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgICAgIHJvb3RXaXRoTmVzdGVkVXBkYXRlcyA9IG51bGw7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJNYXhpbXVtIHVwZGF0ZSBkZXB0aCBleGNlZWRlZC4gVGhpcyBjYW4gaGFwcGVuIHdoZW4gYSBjb21wb25lbnQgcmVwZWF0ZWRseSBjYWxscyBzZXRTdGF0ZSBpbnNpZGUgY29tcG9uZW50V2lsbFVwZGF0ZSBvciBjb21wb25lbnREaWRVcGRhdGUuIFJlYWN0IGxpbWl0cyB0aGUgbnVtYmVyIG9mIG5lc3RlZCB1cGRhdGVzIHRvIHByZXZlbnQgaW5maW5pdGUgbG9vcHMuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQgPiBORVNURURfUEFTU0lWRV9VUERBVEVfTElNSVQpIHsKICAgICAgICAgICAgICAgIG5lc3RlZFBhc3NpdmVVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgICAgICAgICByb290V2l0aFBhc3NpdmVOZXN0ZWRVcGRhdGVzID0gbnVsbDsKICAgICAgICAgICAgICAgIGVycm9yKCJNYXhpbXVtIHVwZGF0ZSBkZXB0aCBleGNlZWRlZC4gVGhpcyBjYW4gaGFwcGVuIHdoZW4gYSBjb21wb25lbnQgY2FsbHMgc2V0U3RhdGUgaW5zaWRlIHVzZUVmZmVjdCwgYnV0IHVzZUVmZmVjdCBlaXRoZXIgZG9lc24ndCBoYXZlIGEgZGVwZW5kZW5jeSBhcnJheSwgb3Igb25lIG9mIHRoZSBkZXBlbmRlbmNpZXMgY2hhbmdlcyBvbiBldmVyeSByZW5kZXIuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBmbHVzaFJlbmRlclBoYXNlU3RyaWN0TW9kZVdhcm5pbmdzSW5ERVYoKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5mbHVzaExlZ2FjeUNvbnRleHRXYXJuaW5nKCk7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZmx1c2hQZW5kaW5nVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3MoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNvbW1pdERvdWJsZUludm9rZUVmZmVjdHNJbkRFVihmaWJlciwgaGFzUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgaW52b2tlRWZmZWN0c0luRGV2KGZpYmVyLCBNb3VudExheW91dERldiwgaW52b2tlTGF5b3V0RWZmZWN0VW5tb3VudEluREVWKTsKICAgICAgICAgICAgICBpZiAoaGFzUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgICAgIGludm9rZUVmZmVjdHNJbkRldihmaWJlciwgTW91bnRQYXNzaXZlRGV2LCBpbnZva2VQYXNzaXZlRWZmZWN0VW5tb3VudEluREVWKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaW52b2tlRWZmZWN0c0luRGV2KGZpYmVyLCBNb3VudExheW91dERldiwgaW52b2tlTGF5b3V0RWZmZWN0TW91bnRJbkRFVik7CiAgICAgICAgICAgICAgaWYgKGhhc1Bhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgICBpbnZva2VFZmZlY3RzSW5EZXYoZmliZXIsIE1vdW50UGFzc2l2ZURldiwgaW52b2tlUGFzc2l2ZUVmZmVjdE1vdW50SW5ERVYpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpbnZva2VFZmZlY3RzSW5EZXYoZmlyc3RDaGlsZCwgZmliZXJGbGFncywgaW52b2tlRWZmZWN0Rm4pIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBjdXJyZW50MiA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICAgICAgdmFyIHN1YnRyZWVSb290ID0gbnVsbDsKICAgICAgICAgICAgICB3aGlsZSAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBwcmltYXJ5U3VidHJlZUZsYWcgPSBjdXJyZW50Mi5zdWJ0cmVlRmxhZ3MgJiBmaWJlckZsYWdzOwogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBzdWJ0cmVlUm9vdCAmJiBjdXJyZW50Mi5jaGlsZCAhPT0gbnVsbCAmJiBwcmltYXJ5U3VidHJlZUZsYWcgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgICAgY3VycmVudDIgPSBjdXJyZW50Mi5jaGlsZDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGlmICgoY3VycmVudDIuZmxhZ3MgJiBmaWJlckZsYWdzKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgICAgIGludm9rZUVmZmVjdEZuKGN1cnJlbnQyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoY3VycmVudDIuc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnQyID0gY3VycmVudDIuc2libGluZzsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50MiA9IHN1YnRyZWVSb290ID0gY3VycmVudDIucmV0dXJuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZGlkV2FyblN0YXRlVXBkYXRlRm9yTm90WWV0TW91bnRlZENvbXBvbmVudCA9IG51bGw7CiAgICAgICAgICBmdW5jdGlvbiB3YXJuQWJvdXRVcGRhdGVPbk5vdFlldE1vdW50ZWRGaWJlckluREVWKGZpYmVyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiBSZW5kZXJDb250ZXh0KSAhPT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghKGZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHRhZyA9IGZpYmVyLnRhZzsKICAgICAgICAgICAgICBpZiAodGFnICE9PSBJbmRldGVybWluYXRlQ29tcG9uZW50ICYmIHRhZyAhPT0gSG9zdFJvb3QgJiYgdGFnICE9PSBDbGFzc0NvbXBvbmVudCAmJiB0YWcgIT09IEZ1bmN0aW9uQ29tcG9uZW50ICYmIHRhZyAhPT0gRm9yd2FyZFJlZiAmJiB0YWcgIT09IE1lbW9Db21wb25lbnQgJiYgdGFnICE9PSBTaW1wbGVNZW1vQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlJlYWN0Q29tcG9uZW50IjsKICAgICAgICAgICAgICBpZiAoZGlkV2FyblN0YXRlVXBkYXRlRm9yTm90WWV0TW91bnRlZENvbXBvbmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKGRpZFdhcm5TdGF0ZVVwZGF0ZUZvck5vdFlldE1vdW50ZWRDb21wb25lbnQuaGFzKGNvbXBvbmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRpZFdhcm5TdGF0ZVVwZGF0ZUZvck5vdFlldE1vdW50ZWRDb21wb25lbnQuYWRkKGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuU3RhdGVVcGRhdGVGb3JOb3RZZXRNb3VudGVkQ29tcG9uZW50ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoW2NvbXBvbmVudE5hbWVdKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHByZXZpb3VzRmliZXIgPSBjdXJyZW50OwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgICAgZXJyb3IoIkNhbid0IHBlcmZvcm0gYSBSZWFjdCBzdGF0ZSB1cGRhdGUgb24gYSBjb21wb25lbnQgdGhhdCBoYXNuJ3QgbW91bnRlZCB5ZXQuIFRoaXMgaW5kaWNhdGVzIHRoYXQgeW91IGhhdmUgYSBzaWRlLWVmZmVjdCBpbiB5b3VyIHJlbmRlciBmdW5jdGlvbiB0aGF0IGFzeW5jaHJvbm91c2x5IGxhdGVyIGNhbGxzIHRyaWVzIHRvIHVwZGF0ZSB0aGUgY29tcG9uZW50LiBNb3ZlIHRoaXMgd29yayB0byB1c2VFZmZlY3QgaW5zdGVhZC4iKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzRmliZXIpIHsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgYmVnaW5Xb3JrJDE7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBkdW1teUZpYmVyID0gbnVsbDsKICAgICAgICAgICAgYmVnaW5Xb3JrJDEgPSBmdW5jdGlvbihjdXJyZW50MiwgdW5pdE9mV29yaywgbGFuZXMpIHsKICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxXb3JrSW5Qcm9ncmVzc0NvcHkgPSBhc3NpZ25GaWJlclByb3BlcnRpZXNJbkRFVihkdW1teUZpYmVyLCB1bml0T2ZXb3JrKTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIGJlZ2luV29yayhjdXJyZW50MiwgdW5pdE9mV29yaywgbGFuZXMpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKG9yaWdpbmFsRXJyb3IpIHsKICAgICAgICAgICAgICAgIGlmIChkaWRTdXNwZW5kT3JFcnJvcldoaWxlSHlkcmF0aW5nREVWKCkgfHwgb3JpZ2luYWxFcnJvciAhPT0gbnVsbCAmJiB0eXBlb2Ygb3JpZ2luYWxFcnJvciA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIG9yaWdpbmFsRXJyb3IudGhlbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICB0aHJvdyBvcmlnaW5hbEVycm9yOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmVzZXRDb250ZXh0RGVwZW5kZW5jaWVzKCk7CiAgICAgICAgICAgICAgICByZXNldEhvb2tzQWZ0ZXJUaHJvdygpOwogICAgICAgICAgICAgICAgdW53aW5kSW50ZXJydXB0ZWRXb3JrKGN1cnJlbnQyLCB1bml0T2ZXb3JrKTsKICAgICAgICAgICAgICAgIGFzc2lnbkZpYmVyUHJvcGVydGllc0luREVWKHVuaXRPZldvcmssIG9yaWdpbmFsV29ya0luUHJvZ3Jlc3NDb3B5KTsKICAgICAgICAgICAgICAgIGlmICh1bml0T2ZXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgICBzdGFydFByb2ZpbGVyVGltZXIodW5pdE9mV29yayk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpbnZva2VHdWFyZGVkQ2FsbGJhY2sobnVsbCwgYmVnaW5Xb3JrLCBudWxsLCBjdXJyZW50MiwgdW5pdE9mV29yaywgbGFuZXMpOwogICAgICAgICAgICAgICAgaWYgKGhhc0NhdWdodEVycm9yKCkpIHsKICAgICAgICAgICAgICAgICAgdmFyIHJlcGxheUVycm9yID0gY2xlYXJDYXVnaHRFcnJvcigpOwogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHJlcGxheUVycm9yID09PSAib2JqZWN0IiAmJiByZXBsYXlFcnJvciAhPT0gbnVsbCAmJiByZXBsYXlFcnJvci5fc3VwcHJlc3NMb2dnaW5nICYmIHR5cGVvZiBvcmlnaW5hbEVycm9yID09PSAib2JqZWN0IiAmJiBvcmlnaW5hbEVycm9yICE9PSBudWxsICYmICFvcmlnaW5hbEVycm9yLl9zdXBwcmVzc0xvZ2dpbmcpIHsKICAgICAgICAgICAgICAgICAgICBvcmlnaW5hbEVycm9yLl9zdXBwcmVzc0xvZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aHJvdyBvcmlnaW5hbEVycm9yOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBkaWRXYXJuQWJvdXRVcGRhdGVJblJlbmRlciA9IGZhbHNlOwogICAgICAgICAgdmFyIGRpZFdhcm5BYm91dFVwZGF0ZUluUmVuZGVyRm9yQW5vdGhlckNvbXBvbmVudDsKICAgICAgICAgIHsKICAgICAgICAgICAgZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXJGb3JBbm90aGVyQ29tcG9uZW50ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHdhcm5BYm91dFJlbmRlclBoYXNlVXBkYXRlc0luREVWKGZpYmVyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaXNSZW5kZXJpbmcgJiYgIWdldElzVXBkYXRpbmdPcGFxdWVWYWx1ZUluUmVuZGVyUGhhc2VJbkRFVigpKSB7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgICAgIHZhciByZW5kZXJpbmdDb21wb25lbnROYW1lID0gd29ya0luUHJvZ3Jlc3MgJiYgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcih3b3JrSW5Qcm9ncmVzcykgfHwgIlVua25vd24iOwogICAgICAgICAgICAgICAgICAgIHZhciBkZWR1cGVLZXkgPSByZW5kZXJpbmdDb21wb25lbnROYW1lOwogICAgICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXJGb3JBbm90aGVyQ29tcG9uZW50LmhhcyhkZWR1cGVLZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVcGRhdGVJblJlbmRlckZvckFub3RoZXJDb21wb25lbnQuYWRkKGRlZHVwZUtleSk7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgc2V0U3RhdGVDb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iOwogICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkNhbm5vdCB1cGRhdGUgYSBjb21wb25lbnQgKGAlc2ApIHdoaWxlIHJlbmRlcmluZyBhIGRpZmZlcmVudCBjb21wb25lbnQgKGAlc2ApLiBUbyBsb2NhdGUgdGhlIGJhZCBzZXRTdGF0ZSgpIGNhbGwgaW5zaWRlIGAlc2AsIGZvbGxvdyB0aGUgc3RhY2sgdHJhY2UgYXMgZGVzY3JpYmVkIGluIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zZXRzdGF0ZS1pbi1yZW5kZXIiLCBzZXRTdGF0ZUNvbXBvbmVudE5hbWUsIHJlbmRlcmluZ0NvbXBvbmVudE5hbWUsIHJlbmRlcmluZ0NvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRVcGRhdGVJblJlbmRlcikgewogICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkNhbm5vdCB1cGRhdGUgZHVyaW5nIGFuIGV4aXN0aW5nIHN0YXRlIHRyYW5zaXRpb24gKHN1Y2ggYXMgd2l0aGluIGByZW5kZXJgKS4gUmVuZGVyIG1ldGhvZHMgc2hvdWxkIGJlIGEgcHVyZSBmdW5jdGlvbiBvZiBwcm9wcyBhbmQgc3RhdGUuIik7CiAgICAgICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVcGRhdGVJblJlbmRlciA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZXN0b3JlUGVuZGluZ1VwZGF0ZXJzKHJvb3QzLCBsYW5lcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgbWVtb2l6ZWRVcGRhdGVycyA9IHJvb3QzLm1lbW9pemVkVXBkYXRlcnM7CiAgICAgICAgICAgICAgICBtZW1vaXplZFVwZGF0ZXJzLmZvckVhY2goZnVuY3Rpb24oc2NoZWR1bGluZ0ZpYmVyKSB7CiAgICAgICAgICAgICAgICAgIGFkZEZpYmVyVG9MYW5lc01hcChyb290Mywgc2NoZWR1bGluZ0ZpYmVyLCBsYW5lcyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBmYWtlQWN0Q2FsbGJhY2tOb2RlID0ge307CiAgICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZUNhbGxiYWNrJDEocHJpb3JpdHlMZXZlbCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBhY3RRdWV1ZSA9IFJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuY3VycmVudDsKICAgICAgICAgICAgICBpZiAoYWN0UXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGFjdFF1ZXVlLnB1c2goY2FsbGJhY2spOwogICAgICAgICAgICAgICAgcmV0dXJuIGZha2VBY3RDYWxsYmFja05vZGU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBzY2hlZHVsZUNhbGxiYWNrKHByaW9yaXR5TGV2ZWwsIGNhbGxiYWNrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNhbmNlbENhbGxiYWNrJDEoY2FsbGJhY2tOb2RlKSB7CiAgICAgICAgICAgIGlmIChjYWxsYmFja05vZGUgPT09IGZha2VBY3RDYWxsYmFja05vZGUpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGNhbmNlbENhbGxiYWNrKGNhbGxiYWNrTm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzaG91bGRGb3JjZUZsdXNoRmFsbGJhY2tzSW5ERVYoKSB7CiAgICAgICAgICAgIHJldHVybiBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmN1cnJlbnQgIT09IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB3YXJuSWZVcGRhdGVzTm90V3JhcHBlZFdpdGhBY3RERVYoZmliZXIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChmaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgICAgICAgIGlmICghaXNDb25jdXJyZW50QWN0RW52aXJvbm1lbnQoKSkgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICghaXNMZWdhY3lBY3RFbnZpcm9ubWVudCgpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChleGVjdXRpb25Db250ZXh0ICE9PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGZpYmVyLnRhZyAhPT0gRnVuY3Rpb25Db21wb25lbnQgJiYgZmliZXIudGFnICE9PSBGb3J3YXJkUmVmICYmIGZpYmVyLnRhZyAhPT0gU2ltcGxlTWVtb0NvbXBvbmVudCkgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmN1cnJlbnQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2aW91c0ZpYmVyID0gY3VycmVudDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJBbiB1cGRhdGUgdG8gJXMgaW5zaWRlIGEgdGVzdCB3YXMgbm90IHdyYXBwZWQgaW4gYWN0KC4uLikuXG5cbldoZW4gdGVzdGluZywgY29kZSB0aGF0IGNhdXNlcyBSZWFjdCBzdGF0ZSB1cGRhdGVzIHNob3VsZCBiZSB3cmFwcGVkIGludG8gYWN0KC4uLik6XG5cbmFjdCgoKSA9PiB7XG4gIC8qIGZpcmUgZXZlbnRzIHRoYXQgdXBkYXRlIHN0YXRlICovXG59KTtcbi8qIGFzc2VydCBvbiB0aGUgb3V0cHV0ICovXG5cblRoaXMgZW5zdXJlcyB0aGF0IHlvdSdyZSB0ZXN0aW5nIHRoZSBiZWhhdmlvciB0aGUgdXNlciB3b3VsZCBzZWUgaW4gdGhlIGJyb3dzZXIuIExlYXJuIG1vcmUgYXQgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3dyYXAtdGVzdHMtd2l0aC1hY3QiLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNGaWJlcikgewogICAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gd2FybklmU3VzcGVuc2VSZXNvbHV0aW9uTm90V3JhcHBlZFdpdGhBY3RERVYocm9vdDMpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChyb290My50YWcgIT09IExlZ2FjeVJvb3QgJiYgaXNDb25jdXJyZW50QWN0RW52aXJvbm1lbnQoKSAmJiBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmN1cnJlbnQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJBIHN1c3BlbmRlZCByZXNvdXJjZSBmaW5pc2hlZCBsb2FkaW5nIGluc2lkZSBhIHRlc3QsIGJ1dCB0aGUgZXZlbnQgd2FzIG5vdCB3cmFwcGVkIGluIGFjdCguLi4pLlxuXG5XaGVuIHRlc3RpbmcsIGNvZGUgdGhhdCByZXNvbHZlcyBzdXNwZW5kZWQgZGF0YSBzaG91bGQgYmUgd3JhcHBlZCBpbnRvIGFjdCguLi4pOlxuXG5hY3QoKCkgPT4ge1xuICAvKiBmaW5pc2ggbG9hZGluZyBzdXNwZW5kZWQgZGF0YSAqL1xufSk7XG4vKiBhc3NlcnQgb24gdGhlIG91dHB1dCAqL1xuXG5UaGlzIGVuc3VyZXMgdGhhdCB5b3UncmUgdGVzdGluZyB0aGUgYmVoYXZpb3IgdGhlIHVzZXIgd291bGQgc2VlIGluIHRoZSBicm93c2VyLiBMZWFybiBtb3JlIGF0IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay93cmFwLXRlc3RzLXdpdGgtYWN0Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QoaXNSdW5uaW5nKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QgPSBpc1J1bm5pbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciByZXNvbHZlRmFtaWx5ID0gbnVsbDsKICAgICAgICAgIHZhciBmYWlsZWRCb3VuZGFyaWVzID0gbnVsbDsKICAgICAgICAgIHZhciBzZXRSZWZyZXNoSGFuZGxlciA9IGZ1bmN0aW9uKGhhbmRsZXIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHJlc29sdmVGYW1pbHkgPSBoYW5kbGVyOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKHR5cGUyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAocmVzb2x2ZUZhbWlseSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHR5cGUyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZmFtaWx5ID0gcmVzb2x2ZUZhbWlseSh0eXBlMik7CiAgICAgICAgICAgICAgaWYgKGZhbWlseSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZTI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBmYW1pbHkuY3VycmVudDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZUNsYXNzRm9ySG90UmVsb2FkaW5nKHR5cGUyKSB7CiAgICAgICAgICAgIHJldHVybiByZXNvbHZlRnVuY3Rpb25Gb3JIb3RSZWxvYWRpbmcodHlwZTIpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZUZvcndhcmRSZWZGb3JIb3RSZWxvYWRpbmcodHlwZTIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChyZXNvbHZlRmFtaWx5ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZTI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBmYW1pbHkgPSByZXNvbHZlRmFtaWx5KHR5cGUyKTsKICAgICAgICAgICAgICBpZiAoZmFtaWx5ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlMiAhPT0gbnVsbCAmJiB0eXBlMiAhPT0gdm9pZCAwICYmIHR5cGVvZiB0eXBlMi5yZW5kZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRSZW5kZXIgPSByZXNvbHZlRnVuY3Rpb25Gb3JIb3RSZWxvYWRpbmcodHlwZTIucmVuZGVyKTsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGUyLnJlbmRlciAhPT0gY3VycmVudFJlbmRlcikgewogICAgICAgICAgICAgICAgICAgIHZhciBzeW50aGV0aWNUeXBlID0gewogICAgICAgICAgICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUsCiAgICAgICAgICAgICAgICAgICAgICByZW5kZXI6IGN1cnJlbnRSZW5kZXIKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlMi5kaXNwbGF5TmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICBzeW50aGV0aWNUeXBlLmRpc3BsYXlOYW1lID0gdHlwZTIuZGlzcGxheU5hbWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiBzeW50aGV0aWNUeXBlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZTI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBmYW1pbHkuY3VycmVudDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaXNDb21wYXRpYmxlRmFtaWx5Rm9ySG90UmVsb2FkaW5nKGZpYmVyLCBlbGVtZW50KSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAocmVzb2x2ZUZhbWlseSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcHJldlR5cGUgPSBmaWJlci5lbGVtZW50VHlwZTsKICAgICAgICAgICAgICB2YXIgbmV4dFR5cGUgPSBlbGVtZW50LnR5cGU7CiAgICAgICAgICAgICAgdmFyIG5lZWRzQ29tcGFyZUZhbWlsaWVzID0gZmFsc2U7CiAgICAgICAgICAgICAgdmFyICQkdHlwZW9mTmV4dFR5cGUgPSB0eXBlb2YgbmV4dFR5cGUgPT09ICJvYmplY3QiICYmIG5leHRUeXBlICE9PSBudWxsID8gbmV4dFR5cGUuJCR0eXBlb2YgOiBudWxsOwogICAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoJCR0eXBlb2ZOZXh0VHlwZSA9PT0gUkVBQ1RfTEFaWV9UWVBFKSB7CiAgICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOiB7CiAgICAgICAgICAgICAgICAgIGlmICgkJHR5cGVvZk5leHRUeXBlID09PSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFKSB7CiAgICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCQkdHlwZW9mTmV4dFR5cGUgPT09IFJFQUNUX0xBWllfVFlQRSkgewogICAgICAgICAgICAgICAgICAgIG5lZWRzQ29tcGFyZUZhbWlsaWVzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgICBpZiAoJCR0eXBlb2ZOZXh0VHlwZSA9PT0gUkVBQ1RfTUVNT19UWVBFKSB7CiAgICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCQkdHlwZW9mTmV4dFR5cGUgPT09IFJFQUNUX0xBWllfVFlQRSkgewogICAgICAgICAgICAgICAgICAgIG5lZWRzQ29tcGFyZUZhbWlsaWVzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5lZWRzQ29tcGFyZUZhbWlsaWVzKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJldkZhbWlseSA9IHJlc29sdmVGYW1pbHkocHJldlR5cGUpOwogICAgICAgICAgICAgICAgaWYgKHByZXZGYW1pbHkgIT09IHZvaWQgMCAmJiBwcmV2RmFtaWx5ID09PSByZXNvbHZlRmFtaWx5KG5leHRUeXBlKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtYXJrRmFpbGVkRXJyb3JCb3VuZGFyeUZvckhvdFJlbG9hZGluZyhmaWJlcikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHJlc29sdmVGYW1pbHkgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBXZWFrU2V0ICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChmYWlsZWRCb3VuZGFyaWVzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBmYWlsZWRCb3VuZGFyaWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrU2V0KCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZhaWxlZEJvdW5kYXJpZXMuYWRkKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHNjaGVkdWxlUmVmcmVzaCA9IGZ1bmN0aW9uKHJvb3QzLCB1cGRhdGUpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChyZXNvbHZlRmFtaWx5ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBzdGFsZUZhbWlsaWVzID0gdXBkYXRlLnN0YWxlRmFtaWxpZXMsIHVwZGF0ZWRGYW1pbGllcyA9IHVwZGF0ZS51cGRhdGVkRmFtaWxpZXM7CiAgICAgICAgICAgICAgZmx1c2hQYXNzaXZlRWZmZWN0cygpOwogICAgICAgICAgICAgIGZsdXNoU3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlRmliZXJzV2l0aEZhbWlsaWVzUmVjdXJzaXZlbHkocm9vdDMuY3VycmVudCwgdXBkYXRlZEZhbWlsaWVzLCBzdGFsZUZhbWlsaWVzKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBzY2hlZHVsZVJvb3QgPSBmdW5jdGlvbihyb290MywgZWxlbWVudCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHJvb3QzLmNvbnRleHQgIT09IGVtcHR5Q29udGV4dE9iamVjdCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICAgICAgZmx1c2hTeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdXBkYXRlQ29udGFpbmVyKGVsZW1lbnQsIHJvb3QzLCBudWxsLCBudWxsKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlRmliZXJzV2l0aEZhbWlsaWVzUmVjdXJzaXZlbHkoZmliZXIsIHVwZGF0ZWRGYW1pbGllcywgc3RhbGVGYW1pbGllcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZSwgY2hpbGQgPSBmaWJlci5jaGlsZCwgc2libGluZyA9IGZpYmVyLnNpYmxpbmcsIHRhZyA9IGZpYmVyLnRhZywgdHlwZTIgPSBmaWJlci50eXBlOwogICAgICAgICAgICAgIHZhciBjYW5kaWRhdGVUeXBlID0gbnVsbDsKICAgICAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgICAgIGNhbmRpZGF0ZVR5cGUgPSB0eXBlMjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgICAgICAgIGNhbmRpZGF0ZVR5cGUgPSB0eXBlMi5yZW5kZXI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocmVzb2x2ZUZhbWlseSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCByZXNvbHZlRmFtaWx5IHRvIGJlIHNldCBkdXJpbmcgaG90IHJlbG9hZC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG5lZWRzUmVuZGVyID0gZmFsc2U7CiAgICAgICAgICAgICAgdmFyIG5lZWRzUmVtb3VudCA9IGZhbHNlOwogICAgICAgICAgICAgIGlmIChjYW5kaWRhdGVUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgZmFtaWx5ID0gcmVzb2x2ZUZhbWlseShjYW5kaWRhdGVUeXBlKTsKICAgICAgICAgICAgICAgIGlmIChmYW1pbHkgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICBpZiAoc3RhbGVGYW1pbGllcy5oYXMoZmFtaWx5KSkgewogICAgICAgICAgICAgICAgICAgIG5lZWRzUmVtb3VudCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodXBkYXRlZEZhbWlsaWVzLmhhcyhmYW1pbHkpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZyA9PT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgIG5lZWRzUmVtb3VudCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIG5lZWRzUmVuZGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGZhaWxlZEJvdW5kYXJpZXMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChmYWlsZWRCb3VuZGFyaWVzLmhhcyhmaWJlcikgfHwgYWx0ZXJuYXRlICE9PSBudWxsICYmIGZhaWxlZEJvdW5kYXJpZXMuaGFzKGFsdGVybmF0ZSkpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNSZW1vdW50ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5lZWRzUmVtb3VudCkgewogICAgICAgICAgICAgICAgZmliZXIuX2RlYnVnTmVlZHNSZW1vdW50ID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5lZWRzUmVtb3VudCB8fCBuZWVkc1JlbmRlcikgewogICAgICAgICAgICAgICAgdmFyIF9yb290ID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgICBpZiAoX3Jvb3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKF9yb290LCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGNoaWxkICE9PSBudWxsICYmICFuZWVkc1JlbW91bnQpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlRmliZXJzV2l0aEZhbWlsaWVzUmVjdXJzaXZlbHkoY2hpbGQsIHVwZGF0ZWRGYW1pbGllcywgc3RhbGVGYW1pbGllcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBzY2hlZHVsZUZpYmVyc1dpdGhGYW1pbGllc1JlY3Vyc2l2ZWx5KHNpYmxpbmcsIHVwZGF0ZWRGYW1pbGllcywgc3RhbGVGYW1pbGllcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmluZEhvc3RJbnN0YW5jZXNGb3JSZWZyZXNoID0gZnVuY3Rpb24ocm9vdDMsIGZhbWlsaWVzKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgaG9zdEluc3RhbmNlcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgICAgdmFyIHR5cGVzID0gbmV3IFNldChmYW1pbGllcy5tYXAoZnVuY3Rpb24oZmFtaWx5KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFtaWx5LmN1cnJlbnQ7CiAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VzRm9yTWF0Y2hpbmdGaWJlcnNSZWN1cnNpdmVseShyb290My5jdXJyZW50LCB0eXBlcywgaG9zdEluc3RhbmNlcyk7CiAgICAgICAgICAgICAgcmV0dXJuIGhvc3RJbnN0YW5jZXM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBmdW5jdGlvbiBmaW5kSG9zdEluc3RhbmNlc0Zvck1hdGNoaW5nRmliZXJzUmVjdXJzaXZlbHkoZmliZXIsIHR5cGVzLCBob3N0SW5zdGFuY2VzKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBmaWJlci5jaGlsZCwgc2libGluZyA9IGZpYmVyLnNpYmxpbmcsIHRhZyA9IGZpYmVyLnRhZywgdHlwZTIgPSBmaWJlci50eXBlOwogICAgICAgICAgICAgIHZhciBjYW5kaWRhdGVUeXBlID0gbnVsbDsKICAgICAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgICAgIGNhbmRpZGF0ZVR5cGUgPSB0eXBlMjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgICAgICAgIGNhbmRpZGF0ZVR5cGUgPSB0eXBlMi5yZW5kZXI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZGlkTWF0Y2ggPSBmYWxzZTsKICAgICAgICAgICAgICBpZiAoY2FuZGlkYXRlVHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVzLmhhcyhjYW5kaWRhdGVUeXBlKSkgewogICAgICAgICAgICAgICAgICBkaWRNYXRjaCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChkaWRNYXRjaCkgewogICAgICAgICAgICAgICAgZmluZEhvc3RJbnN0YW5jZXNGb3JGaWJlclNoYWxsb3dseShmaWJlciwgaG9zdEluc3RhbmNlcyk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBmaW5kSG9zdEluc3RhbmNlc0Zvck1hdGNoaW5nRmliZXJzUmVjdXJzaXZlbHkoY2hpbGQsIHR5cGVzLCBob3N0SW5zdGFuY2VzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VzRm9yTWF0Y2hpbmdGaWJlcnNSZWN1cnNpdmVseShzaWJsaW5nLCB0eXBlcywgaG9zdEluc3RhbmNlcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBmaW5kSG9zdEluc3RhbmNlc0ZvckZpYmVyU2hhbGxvd2x5KGZpYmVyLCBob3N0SW5zdGFuY2VzKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgZm91bmRIb3N0SW5zdGFuY2VzID0gZmluZENoaWxkSG9zdEluc3RhbmNlc0ZvckZpYmVyU2hhbGxvd2x5KGZpYmVyLCBob3N0SW5zdGFuY2VzKTsKICAgICAgICAgICAgICBpZiAoZm91bmRIb3N0SW5zdGFuY2VzKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBub2RlID0gZmliZXI7CiAgICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICAgIHN3aXRjaCAobm9kZS50YWcpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgICAgICAgIGhvc3RJbnN0YW5jZXMuYWRkKG5vZGUuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICAgICAgICBob3N0SW5zdGFuY2VzLmFkZChub2RlLnN0YXRlTm9kZS5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgICAgICAgaG9zdEluc3RhbmNlcy5hZGQobm9kZS5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgdG8gcmVhY2ggcm9vdCBmaXJzdC4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGZpbmRDaGlsZEhvc3RJbnN0YW5jZXNGb3JGaWJlclNoYWxsb3dseShmaWJlciwgaG9zdEluc3RhbmNlcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIG5vZGUgPSBmaWJlcjsKICAgICAgICAgICAgICB2YXIgZm91bmRIb3N0SW5zdGFuY2VzID0gZmFsc2U7CiAgICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gSG9zdENvbXBvbmVudCkgewogICAgICAgICAgICAgICAgICBmb3VuZEhvc3RJbnN0YW5jZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgICBob3N0SW5zdGFuY2VzLmFkZChub2RlLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbm9kZS5jaGlsZC5yZXR1cm4gPSBub2RlOwogICAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gZmliZXIpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZvdW5kSG9zdEluc3RhbmNlczsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IG5vZGUucmV0dXJuID09PSBmaWJlcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmb3VuZEhvc3RJbnN0YW5jZXM7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbm9kZS5zaWJsaW5nLnJldHVybiA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGhhc0JhZE1hcFBvbHlmaWxsOwogICAgICAgICAgewogICAgICAgICAgICBoYXNCYWRNYXBQb2x5ZmlsbCA9IGZhbHNlOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHZhciBub25FeHRlbnNpYmxlT2JqZWN0ID0gT2JqZWN0LnByZXZlbnRFeHRlbnNpb25zKHt9KTsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gbmV3IE1hcChbW25vbkV4dGVuc2libGVPYmplY3QsIG51bGxdXSk7CiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovIG5ldyBTZXQoW25vbkV4dGVuc2libGVPYmplY3RdKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgIGhhc0JhZE1hcFBvbHlmaWxsID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gRmliZXJOb2RlKHRhZywgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpIHsKICAgICAgICAgICAgdGhpcy50YWcgPSB0YWc7CiAgICAgICAgICAgIHRoaXMua2V5ID0ga2V5OwogICAgICAgICAgICB0aGlzLmVsZW1lbnRUeXBlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy50eXBlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zdGF0ZU5vZGUgPSBudWxsOwogICAgICAgICAgICB0aGlzLnJldHVybiA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuY2hpbGQgPSBudWxsOwogICAgICAgICAgICB0aGlzLnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgICB0aGlzLmluZGV4ID0gMDsKICAgICAgICAgICAgdGhpcy5yZWYgPSBudWxsOwogICAgICAgICAgICB0aGlzLnBlbmRpbmdQcm9wcyA9IHBlbmRpbmdQcm9wczsKICAgICAgICAgICAgdGhpcy5tZW1vaXplZFByb3BzID0gbnVsbDsKICAgICAgICAgICAgdGhpcy51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZGVwZW5kZW5jaWVzID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5tb2RlID0gbW9kZTsKICAgICAgICAgICAgdGhpcy5mbGFncyA9IE5vRmxhZ3M7CiAgICAgICAgICAgIHRoaXMuc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgdGhpcy5kZWxldGlvbnMgPSBudWxsOwogICAgICAgICAgICB0aGlzLmxhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgdGhpcy5jaGlsZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgdGhpcy5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdGhpcy5hY3R1YWxEdXJhdGlvbiA9IE51bWJlci5OYU47CiAgICAgICAgICAgICAgdGhpcy5hY3R1YWxTdGFydFRpbWUgPSBOdW1iZXIuTmFOOwogICAgICAgICAgICAgIHRoaXMuc2VsZkJhc2VEdXJhdGlvbiA9IE51bWJlci5OYU47CiAgICAgICAgICAgICAgdGhpcy50cmVlQmFzZUR1cmF0aW9uID0gTnVtYmVyLk5hTjsKICAgICAgICAgICAgICB0aGlzLmFjdHVhbER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICB0aGlzLmFjdHVhbFN0YXJ0VGltZSA9IC0xOwogICAgICAgICAgICAgIHRoaXMuc2VsZkJhc2VEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgICAgdGhpcy50cmVlQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdGhpcy5fZGVidWdTb3VyY2UgPSBudWxsOwogICAgICAgICAgICAgIHRoaXMuX2RlYnVnT3duZXIgPSBudWxsOwogICAgICAgICAgICAgIHRoaXMuX2RlYnVnTmVlZHNSZW1vdW50ID0gZmFsc2U7CiAgICAgICAgICAgICAgdGhpcy5fZGVidWdIb29rVHlwZXMgPSBudWxsOwogICAgICAgICAgICAgIGlmICghaGFzQmFkTWFwUG9seWZpbGwgJiYgdHlwZW9mIE9iamVjdC5wcmV2ZW50RXh0ZW5zaW9ucyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgT2JqZWN0LnByZXZlbnRFeHRlbnNpb25zKHRoaXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGNyZWF0ZUZpYmVyID0gZnVuY3Rpb24odGFnLCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSkgewogICAgICAgICAgICByZXR1cm4gbmV3IEZpYmVyTm9kZSh0YWcsIHBlbmRpbmdQcm9wcywga2V5LCBtb2RlKTsKICAgICAgICAgIH07CiAgICAgICAgICBmdW5jdGlvbiBzaG91bGRDb25zdHJ1Y3QkMShDb21wb25lbnQpIHsKICAgICAgICAgICAgdmFyIHByb3RvdHlwZSA9IENvbXBvbmVudC5wcm90b3R5cGU7CiAgICAgICAgICAgIHJldHVybiAhIShwcm90b3R5cGUgJiYgcHJvdG90eXBlLmlzUmVhY3RDb21wb25lbnQpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaXNTaW1wbGVGdW5jdGlvbkNvbXBvbmVudCh0eXBlMikgewogICAgICAgICAgICByZXR1cm4gdHlwZW9mIHR5cGUyID09PSAiZnVuY3Rpb24iICYmICFzaG91bGRDb25zdHJ1Y3QkMSh0eXBlMikgJiYgdHlwZTIuZGVmYXVsdFByb3BzID09PSB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZXNvbHZlTGF6eUNvbXBvbmVudFRhZyhDb21wb25lbnQpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBDb21wb25lbnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICByZXR1cm4gc2hvdWxkQ29uc3RydWN0JDEoQ29tcG9uZW50KSA/IENsYXNzQ29tcG9uZW50IDogRnVuY3Rpb25Db21wb25lbnQ7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoQ29tcG9uZW50ICE9PSB2b2lkIDAgJiYgQ29tcG9uZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyICQkdHlwZW9mID0gQ29tcG9uZW50LiQkdHlwZW9mOwogICAgICAgICAgICAgIGlmICgkJHR5cGVvZiA9PT0gUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRSkgewogICAgICAgICAgICAgICAgcmV0dXJuIEZvcndhcmRSZWY7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgkJHR5cGVvZiA9PT0gUkVBQ1RfTUVNT19UWVBFKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gTWVtb0NvbXBvbmVudDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIEluZGV0ZXJtaW5hdGVDb21wb25lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50MiwgcGVuZGluZ1Byb3BzKSB7CiAgICAgICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzczIgPSBjdXJyZW50Mi5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIgPT09IG51bGwpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIgPSBjcmVhdGVGaWJlcihjdXJyZW50Mi50YWcsIHBlbmRpbmdQcm9wcywgY3VycmVudDIua2V5LCBjdXJyZW50Mi5tb2RlKTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUgPSBjdXJyZW50Mi5lbGVtZW50VHlwZTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IGN1cnJlbnQyLnR5cGU7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9IGN1cnJlbnQyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuX2RlYnVnU291cmNlID0gY3VycmVudDIuX2RlYnVnU291cmNlOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z093bmVyID0gY3VycmVudDIuX2RlYnVnT3duZXI7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuX2RlYnVnSG9va1R5cGVzID0gY3VycmVudDIuX2RlYnVnSG9va1R5cGVzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuYWx0ZXJuYXRlID0gY3VycmVudDI7CiAgICAgICAgICAgICAgY3VycmVudDIuYWx0ZXJuYXRlID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHMgPSBwZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSBjdXJyZW50Mi50eXBlOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyA9IE5vRmxhZ3M7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN1YnRyZWVGbGFncyA9IE5vRmxhZ3M7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlbGV0aW9ucyA9IG51bGw7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmFjdHVhbER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5hY3R1YWxTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzID0gY3VycmVudDIuZmxhZ3MgJiBTdGF0aWNNYXNrOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGRMYW5lcyA9IGN1cnJlbnQyLmNoaWxkTGFuZXM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IGN1cnJlbnQyLmxhbmVzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBjdXJyZW50Mi5jaGlsZDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMgPSBjdXJyZW50Mi5tZW1vaXplZFByb3BzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IGN1cnJlbnQyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IGN1cnJlbnQyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICB2YXIgY3VycmVudERlcGVuZGVuY2llcyA9IGN1cnJlbnQyLmRlcGVuZGVuY2llczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlcGVuZGVuY2llcyA9IGN1cnJlbnREZXBlbmRlbmNpZXMgPT09IG51bGwgPyBudWxsIDogewogICAgICAgICAgICAgIGxhbmVzOiBjdXJyZW50RGVwZW5kZW5jaWVzLmxhbmVzLAogICAgICAgICAgICAgIGZpcnN0Q29udGV4dDogY3VycmVudERlcGVuZGVuY2llcy5maXJzdENvbnRleHQKICAgICAgICAgICAgfTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnNpYmxpbmcgPSBjdXJyZW50Mi5zaWJsaW5nOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuaW5kZXggPSBjdXJyZW50Mi5pbmRleDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnJlZiA9IGN1cnJlbnQyLnJlZjsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zZWxmQmFzZUR1cmF0aW9uID0gY3VycmVudDIuc2VsZkJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiA9IGN1cnJlbnQyLnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5fZGVidWdOZWVkc1JlbW91bnQgPSBjdXJyZW50Mi5fZGVidWdOZWVkc1JlbW91bnQ7CiAgICAgICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzczIudGFnKSB7CiAgICAgICAgICAgICAgICBjYXNlIEluZGV0ZXJtaW5hdGVDb21wb25lbnQ6CiAgICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IHJlc29sdmVGdW5jdGlvbkZvckhvdFJlbG9hZGluZyhjdXJyZW50Mi50eXBlKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IHJlc29sdmVDbGFzc0ZvckhvdFJlbG9hZGluZyhjdXJyZW50Mi50eXBlKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gcmVzb2x2ZUZvcndhcmRSZWZGb3JIb3RSZWxvYWRpbmcoY3VycmVudDIudHlwZSk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVzZXRXb3JrSW5Qcm9ncmVzcyh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJj0gU3RhdGljTWFzayB8IFBsYWNlbWVudDsKICAgICAgICAgICAgdmFyIGN1cnJlbnQyID0gd29ya0luUHJvZ3Jlc3MyLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IHJlbmRlckxhbmVzMjsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBudWxsOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zdWJ0cmVlRmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzID0gbnVsbDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVwZW5kZW5jaWVzID0gbnVsbDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlID0gbnVsbDsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc2VsZkJhc2VEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzID0gY3VycmVudDIuY2hpbGRMYW5lczsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBjdXJyZW50Mi5sYW5lczsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBjdXJyZW50Mi5jaGlsZDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVsZXRpb25zID0gbnVsbDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcyA9IGN1cnJlbnQyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IGN1cnJlbnQyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gY3VycmVudDIudHlwZTsKICAgICAgICAgICAgICB2YXIgY3VycmVudERlcGVuZGVuY2llcyA9IGN1cnJlbnQyLmRlcGVuZGVuY2llczsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVwZW5kZW5jaWVzID0gY3VycmVudERlcGVuZGVuY2llcyA9PT0gbnVsbCA/IG51bGwgOiB7CiAgICAgICAgICAgICAgICBsYW5lczogY3VycmVudERlcGVuZGVuY2llcy5sYW5lcywKICAgICAgICAgICAgICAgIGZpcnN0Q29udGV4dDogY3VycmVudERlcGVuZGVuY2llcy5maXJzdENvbnRleHQKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zZWxmQmFzZUR1cmF0aW9uID0gY3VycmVudDIuc2VsZkJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50cmVlQmFzZUR1cmF0aW9uID0gY3VycmVudDIudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUhvc3RSb290RmliZXIodGFnLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUpIHsKICAgICAgICAgICAgdmFyIG1vZGU7CiAgICAgICAgICAgIGlmICh0YWcgPT09IENvbmN1cnJlbnRSb290KSB7CiAgICAgICAgICAgICAgbW9kZSA9IENvbmN1cnJlbnRNb2RlOwogICAgICAgICAgICAgIGlmIChpc1N0cmljdE1vZGUgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgIG1vZGUgfD0gU3RyaWN0TGVnYWN5TW9kZTsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgbW9kZSB8PSBTdHJpY3RFZmZlY3RzTW9kZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbW9kZSA9IE5vTW9kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICBtb2RlIHw9IFByb2ZpbGVNb2RlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlcihIb3N0Um9vdCwgbnVsbCwgbnVsbCwgbW9kZSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21UeXBlQW5kUHJvcHModHlwZTIsIGtleSwgcGVuZGluZ1Byb3BzLCBvd25lciwgbW9kZSwgbGFuZXMpIHsKICAgICAgICAgICAgdmFyIGZpYmVyVGFnID0gSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDsKICAgICAgICAgICAgdmFyIHJlc29sdmVkVHlwZSA9IHR5cGUyOwogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKHNob3VsZENvbnN0cnVjdCQxKHR5cGUyKSkgewogICAgICAgICAgICAgICAgZmliZXJUYWcgPSBDbGFzc0NvbXBvbmVudDsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgcmVzb2x2ZWRUeXBlID0gcmVzb2x2ZUNsYXNzRm9ySG90UmVsb2FkaW5nKHJlc29sdmVkVHlwZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgcmVzb2x2ZWRUeXBlID0gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKHJlc29sdmVkVHlwZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0eXBlMiA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICBmaWJlclRhZyA9IEhvc3RDb21wb25lbnQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZ2V0VGFnOgogICAgICAgICAgICAgICAgc3dpdGNoICh0eXBlMikgewogICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZSQUdNRU5UX1RZUEU6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KHBlbmRpbmdQcm9wcy5jaGlsZHJlbiwgbW9kZSwgbGFuZXMsIGtleSk7CiAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1RSSUNUX01PREVfVFlQRToKICAgICAgICAgICAgICAgICAgICBmaWJlclRhZyA9IE1vZGU7CiAgICAgICAgICAgICAgICAgICAgbW9kZSB8PSBTdHJpY3RMZWdhY3lNb2RlOwogICAgICAgICAgICAgICAgICAgIGlmICgobW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICBtb2RlIHw9IFN0cmljdEVmZmVjdHNNb2RlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QUk9GSUxFUl9UWVBFOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlckZyb21Qcm9maWxlcihwZW5kaW5nUHJvcHMsIG1vZGUsIGxhbmVzLCBrZXkpOwogICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX1RZUEU6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUZpYmVyRnJvbVN1c3BlbnNlKHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSk7CiAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlckZyb21TdXNwZW5zZUxpc3QocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KTsKICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9PRkZTQ1JFRU5fVFlQRToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJGcm9tT2Zmc2NyZWVuKHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSk7CiAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEVHQUNZX0hJRERFTl9UWVBFOgogICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1NDT1BFX1RZUEU6CiAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfQ0FDSEVfVFlQRToKICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9UUkFDSU5HX01BUktFUl9UWVBFOgogICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0RFQlVHX1RSQUNJTkdfTU9ERV9UWVBFOgogICAgICAgICAgICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlMiA9PT0gIm9iamVjdCIgJiYgdHlwZTIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAodHlwZTIuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QUk9WSURFUl9UWVBFOgogICAgICAgICAgICAgICAgICAgICAgICAgIGZpYmVyVGFnID0gQ29udGV4dFByb3ZpZGVyOwogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGdldFRhZzsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9DT05URVhUX1RZUEU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgZmliZXJUYWcgPSBDb250ZXh0Q29uc3VtZXI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsgZ2V0VGFnOwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgZmliZXJUYWcgPSBGb3J3YXJkUmVmOwogICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmVkVHlwZSA9IHJlc29sdmVGb3J3YXJkUmVmRm9ySG90UmVsb2FkaW5nKHJlc29sdmVkVHlwZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGdldFRhZzsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgZmliZXJUYWcgPSBNZW1vQ29tcG9uZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGdldFRhZzsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgZmliZXJUYWcgPSBMYXp5Q29tcG9uZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmVkVHlwZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsgZ2V0VGFnOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB2YXIgaW5mbyA9ICIiOwogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlMiA9PT0gdm9pZCAwIHx8IHR5cGVvZiB0eXBlMiA9PT0gIm9iamVjdCIgJiYgdHlwZTIgIT09IG51bGwgJiYgT2JqZWN0LmtleXModHlwZTIpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBpbmZvICs9ICIgWW91IGxpa2VseSBmb3Jnb3QgdG8gZXhwb3J0IHlvdXIgY29tcG9uZW50IGZyb20gdGhlIGZpbGUgaXQncyBkZWZpbmVkIGluLCBvciB5b3UgbWlnaHQgaGF2ZSBtaXhlZCB1cCBkZWZhdWx0IGFuZCBuYW1lZCBpbXBvcnRzLiI7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB2YXIgb3duZXJOYW1lID0gb3duZXIgPyBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKG93bmVyKSA6IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICBpZiAob3duZXJOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZm8gKz0gIlxuXG5DaGVjayB0aGUgcmVuZGVyIG1ldGhvZCBvZiBgIiArIG93bmVyTmFtZSArICJgLiI7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRWxlbWVudCB0eXBlIGlzIGludmFsaWQ6IGV4cGVjdGVkIGEgc3RyaW5nIChmb3IgYnVpbHQtaW4gY29tcG9uZW50cykgb3IgYSBjbGFzcy9mdW5jdGlvbiAoZm9yIGNvbXBvc2l0ZSBjb21wb25lbnRzKSAiICsgKCJidXQgZ290OiAiICsgKHR5cGUyID09IG51bGwgPyB0eXBlMiA6IHR5cGVvZiB0eXBlMikgKyAiLiIgKyBpbmZvKSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihmaWJlclRhZywgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpOwogICAgICAgICAgICBmaWJlci5lbGVtZW50VHlwZSA9IHR5cGUyOwogICAgICAgICAgICBmaWJlci50eXBlID0gcmVzb2x2ZWRUeXBlOwogICAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZmliZXIuX2RlYnVnT3duZXIgPSBvd25lcjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21FbGVtZW50KGVsZW1lbnQsIG1vZGUsIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBvd25lciA9IG51bGw7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0eXBlMiA9IGVsZW1lbnQudHlwZTsKICAgICAgICAgICAgdmFyIGtleSA9IGVsZW1lbnQua2V5OwogICAgICAgICAgICB2YXIgcGVuZGluZ1Byb3BzID0gZWxlbWVudC5wcm9wczsKICAgICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXJGcm9tVHlwZUFuZFByb3BzKHR5cGUyLCBrZXksIHBlbmRpbmdQcm9wcywgb3duZXIsIG1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGZpYmVyLl9kZWJ1Z1NvdXJjZSA9IGVsZW1lbnQuX3NvdXJjZTsKICAgICAgICAgICAgICBmaWJlci5fZGVidWdPd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KGVsZW1lbnRzLCBtb2RlLCBsYW5lcywga2V5KSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKEZyYWdtZW50LCBlbGVtZW50cywga2V5LCBtb2RlKTsKICAgICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tUHJvZmlsZXIocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHBlbmRpbmdQcm9wcy5pZCAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCdQcm9maWxlciBtdXN0IHNwZWNpZnkgYW4gImlkIiBvZiB0eXBlIGBzdHJpbmdgIGFzIGEgcHJvcC4gUmVjZWl2ZWQgdGhlIHR5cGUgYCVzYCBpbnN0ZWFkLicsIHR5cGVvZiBwZW5kaW5nUHJvcHMuaWQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihQcm9maWxlciwgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUgfCBQcm9maWxlTW9kZSk7CiAgICAgICAgICAgIGZpYmVyLmVsZW1lbnRUeXBlID0gUkVBQ1RfUFJPRklMRVJfVFlQRTsKICAgICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IHsKICAgICAgICAgICAgICAgIGVmZmVjdER1cmF0aW9uOiAwLAogICAgICAgICAgICAgICAgcGFzc2l2ZUVmZmVjdER1cmF0aW9uOiAwCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21TdXNwZW5zZShwZW5kaW5nUHJvcHMsIG1vZGUsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXIoU3VzcGVuc2VDb21wb25lbnQsIHBlbmRpbmdQcm9wcywga2V5LCBtb2RlKTsKICAgICAgICAgICAgZmliZXIuZWxlbWVudFR5cGUgPSBSRUFDVF9TVVNQRU5TRV9UWVBFOwogICAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21TdXNwZW5zZUxpc3QocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKFN1c3BlbnNlTGlzdENvbXBvbmVudCwgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpOwogICAgICAgICAgICBmaWJlci5lbGVtZW50VHlwZSA9IFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRTsKICAgICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tT2Zmc2NyZWVuKHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihPZmZzY3JlZW5Db21wb25lbnQsIHBlbmRpbmdQcm9wcywga2V5LCBtb2RlKTsKICAgICAgICAgICAgZmliZXIuZWxlbWVudFR5cGUgPSBSRUFDVF9PRkZTQ1JFRU5fVFlQRTsKICAgICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEluc3RhbmNlID0gewogICAgICAgICAgICAgIGlzSGlkZGVuOiBmYWxzZQogICAgICAgICAgICB9OwogICAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSBwcmltYXJ5Q2hpbGRJbnN0YW5jZTsKICAgICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tVGV4dChjb250ZW50LCBtb2RlLCBsYW5lcykgewogICAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihIb3N0VGV4dCwgY29udGVudCwgbnVsbCwgbW9kZSk7CiAgICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbUhvc3RJbnN0YW5jZUZvckRlbGV0aW9uKCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihIb3N0Q29tcG9uZW50LCBudWxsLCBudWxsLCBOb01vZGUpOwogICAgICAgICAgICBmaWJlci5lbGVtZW50VHlwZSA9ICJERUxFVEVEIjsKICAgICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tRGVoeWRyYXRlZEZyYWdtZW50KGRlaHlkcmF0ZWROb2RlKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKERlaHlkcmF0ZWRGcmFnbWVudCwgbnVsbCwgbnVsbCwgTm9Nb2RlKTsKICAgICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gZGVoeWRyYXRlZE5vZGU7CiAgICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbVBvcnRhbChwb3J0YWwsIG1vZGUsIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBwZW5kaW5nUHJvcHMgPSBwb3J0YWwuY2hpbGRyZW4gIT09IG51bGwgPyBwb3J0YWwuY2hpbGRyZW4gOiBbXTsKICAgICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXIoSG9zdFBvcnRhbCwgcGVuZGluZ1Byb3BzLCBwb3J0YWwua2V5LCBtb2RlKTsKICAgICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gewogICAgICAgICAgICAgIGNvbnRhaW5lckluZm86IHBvcnRhbC5jb250YWluZXJJbmZvLAogICAgICAgICAgICAgIHBlbmRpbmdDaGlsZHJlbjogbnVsbCwKICAgICAgICAgICAgICAvLyBVc2VkIGJ5IHBlcnNpc3RlbnQgdXBkYXRlcwogICAgICAgICAgICAgIGltcGxlbWVudGF0aW9uOiBwb3J0YWwuaW1wbGVtZW50YXRpb24KICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gYXNzaWduRmliZXJQcm9wZXJ0aWVzSW5ERVYodGFyZ2V0LCBzb3VyY2UpIHsKICAgICAgICAgICAgaWYgKHRhcmdldCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRhcmdldCA9IGNyZWF0ZUZpYmVyKEluZGV0ZXJtaW5hdGVDb21wb25lbnQsIG51bGwsIG51bGwsIE5vTW9kZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGFyZ2V0LnRhZyA9IHNvdXJjZS50YWc7CiAgICAgICAgICAgIHRhcmdldC5rZXkgPSBzb3VyY2Uua2V5OwogICAgICAgICAgICB0YXJnZXQuZWxlbWVudFR5cGUgPSBzb3VyY2UuZWxlbWVudFR5cGU7CiAgICAgICAgICAgIHRhcmdldC50eXBlID0gc291cmNlLnR5cGU7CiAgICAgICAgICAgIHRhcmdldC5zdGF0ZU5vZGUgPSBzb3VyY2Uuc3RhdGVOb2RlOwogICAgICAgICAgICB0YXJnZXQucmV0dXJuID0gc291cmNlLnJldHVybjsKICAgICAgICAgICAgdGFyZ2V0LmNoaWxkID0gc291cmNlLmNoaWxkOwogICAgICAgICAgICB0YXJnZXQuc2libGluZyA9IHNvdXJjZS5zaWJsaW5nOwogICAgICAgICAgICB0YXJnZXQuaW5kZXggPSBzb3VyY2UuaW5kZXg7CiAgICAgICAgICAgIHRhcmdldC5yZWYgPSBzb3VyY2UucmVmOwogICAgICAgICAgICB0YXJnZXQucGVuZGluZ1Byb3BzID0gc291cmNlLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgdGFyZ2V0Lm1lbW9pemVkUHJvcHMgPSBzb3VyY2UubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgdGFyZ2V0LnVwZGF0ZVF1ZXVlID0gc291cmNlLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICB0YXJnZXQubWVtb2l6ZWRTdGF0ZSA9IHNvdXJjZS5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICB0YXJnZXQuZGVwZW5kZW5jaWVzID0gc291cmNlLmRlcGVuZGVuY2llczsKICAgICAgICAgICAgdGFyZ2V0Lm1vZGUgPSBzb3VyY2UubW9kZTsKICAgICAgICAgICAgdGFyZ2V0LmZsYWdzID0gc291cmNlLmZsYWdzOwogICAgICAgICAgICB0YXJnZXQuc3VidHJlZUZsYWdzID0gc291cmNlLnN1YnRyZWVGbGFnczsKICAgICAgICAgICAgdGFyZ2V0LmRlbGV0aW9ucyA9IHNvdXJjZS5kZWxldGlvbnM7CiAgICAgICAgICAgIHRhcmdldC5sYW5lcyA9IHNvdXJjZS5sYW5lczsKICAgICAgICAgICAgdGFyZ2V0LmNoaWxkTGFuZXMgPSBzb3VyY2UuY2hpbGRMYW5lczsKICAgICAgICAgICAgdGFyZ2V0LmFsdGVybmF0ZSA9IHNvdXJjZS5hbHRlcm5hdGU7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB0YXJnZXQuYWN0dWFsRHVyYXRpb24gPSBzb3VyY2UuYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgICAgdGFyZ2V0LmFjdHVhbFN0YXJ0VGltZSA9IHNvdXJjZS5hY3R1YWxTdGFydFRpbWU7CiAgICAgICAgICAgICAgdGFyZ2V0LnNlbGZCYXNlRHVyYXRpb24gPSBzb3VyY2Uuc2VsZkJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICB0YXJnZXQudHJlZUJhc2VEdXJhdGlvbiA9IHNvdXJjZS50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRhcmdldC5fZGVidWdTb3VyY2UgPSBzb3VyY2UuX2RlYnVnU291cmNlOwogICAgICAgICAgICB0YXJnZXQuX2RlYnVnT3duZXIgPSBzb3VyY2UuX2RlYnVnT3duZXI7CiAgICAgICAgICAgIHRhcmdldC5fZGVidWdOZWVkc1JlbW91bnQgPSBzb3VyY2UuX2RlYnVnTmVlZHNSZW1vdW50OwogICAgICAgICAgICB0YXJnZXQuX2RlYnVnSG9va1R5cGVzID0gc291cmNlLl9kZWJ1Z0hvb2tUeXBlczsKICAgICAgICAgICAgcmV0dXJuIHRhcmdldDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIEZpYmVyUm9vdE5vZGUoY29udGFpbmVySW5mbywgdGFnLCBoeWRyYXRlMiwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yKSB7CiAgICAgICAgICAgIHRoaXMudGFnID0gdGFnOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lckluZm8gPSBjb250YWluZXJJbmZvOwogICAgICAgICAgICB0aGlzLnBlbmRpbmdDaGlsZHJlbiA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMucGluZ0NhY2hlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5maW5pc2hlZFdvcmsgPSBudWxsOwogICAgICAgICAgICB0aGlzLnRpbWVvdXRIYW5kbGUgPSBub1RpbWVvdXQ7CiAgICAgICAgICAgIHRoaXMuY29udGV4dCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMucGVuZGluZ0NvbnRleHQgPSBudWxsOwogICAgICAgICAgICB0aGlzLmNhbGxiYWNrTm9kZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuY2FsbGJhY2tQcmlvcml0eSA9IE5vTGFuZTsKICAgICAgICAgICAgdGhpcy5ldmVudFRpbWVzID0gY3JlYXRlTGFuZU1hcChOb0xhbmVzKTsKICAgICAgICAgICAgdGhpcy5leHBpcmF0aW9uVGltZXMgPSBjcmVhdGVMYW5lTWFwKE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgdGhpcy5wZW5kaW5nTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICB0aGlzLnN1c3BlbmRlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgdGhpcy5waW5nZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIHRoaXMuZXhwaXJlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgdGhpcy5tdXRhYmxlUmVhZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgdGhpcy5maW5pc2hlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgdGhpcy5lbnRhbmdsZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIHRoaXMuZW50YW5nbGVtZW50cyA9IGNyZWF0ZUxhbmVNYXAoTm9MYW5lcyk7CiAgICAgICAgICAgIHRoaXMuaWRlbnRpZmllclByZWZpeCA9IGlkZW50aWZpZXJQcmVmaXg7CiAgICAgICAgICAgIHRoaXMub25SZWNvdmVyYWJsZUVycm9yID0gb25SZWNvdmVyYWJsZUVycm9yOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdGhpcy5tdXRhYmxlU291cmNlRWFnZXJIeWRyYXRpb25EYXRhID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdGhpcy5lZmZlY3REdXJhdGlvbiA9IDA7CiAgICAgICAgICAgICAgdGhpcy5wYXNzaXZlRWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB0aGlzLm1lbW9pemVkVXBkYXRlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgIHZhciBwZW5kaW5nVXBkYXRlcnNMYW5lTWFwID0gdGhpcy5wZW5kaW5nVXBkYXRlcnNMYW5lTWFwID0gW107CiAgICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IFRvdGFsTGFuZXM7IF9pKyspIHsKICAgICAgICAgICAgICAgIHBlbmRpbmdVcGRhdGVyc0xhbmVNYXAucHVzaCgvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgICAgICBjYXNlIENvbmN1cnJlbnRSb290OgogICAgICAgICAgICAgICAgICB0aGlzLl9kZWJ1Z1Jvb3RUeXBlID0gaHlkcmF0ZTIgPyAiaHlkcmF0ZVJvb3QoKSIgOiAiY3JlYXRlUm9vdCgpIjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIExlZ2FjeVJvb3Q6CiAgICAgICAgICAgICAgICAgIHRoaXMuX2RlYnVnUm9vdFR5cGUgPSBoeWRyYXRlMiA/ICJoeWRyYXRlKCkiIDogInJlbmRlcigpIjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlclJvb3QoY29udGFpbmVySW5mbywgdGFnLCBoeWRyYXRlMiwgaW5pdGlhbENoaWxkcmVuLCBoeWRyYXRpb25DYWxsYmFja3MsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yLCB0cmFuc2l0aW9uQ2FsbGJhY2tzKSB7CiAgICAgICAgICAgIHZhciByb290MyA9IG5ldyBGaWJlclJvb3ROb2RlKGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0ZTIsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICAgIHZhciB1bmluaXRpYWxpemVkRmliZXIgPSBjcmVhdGVIb3N0Um9vdEZpYmVyKHRhZywgaXNTdHJpY3RNb2RlKTsKICAgICAgICAgICAgcm9vdDMuY3VycmVudCA9IHVuaW5pdGlhbGl6ZWRGaWJlcjsKICAgICAgICAgICAgdW5pbml0aWFsaXplZEZpYmVyLnN0YXRlTm9kZSA9IHJvb3QzOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIF9pbml0aWFsU3RhdGUgPSB7CiAgICAgICAgICAgICAgICBlbGVtZW50OiBpbml0aWFsQ2hpbGRyZW4sCiAgICAgICAgICAgICAgICBpc0RlaHlkcmF0ZWQ6IGh5ZHJhdGUyLAogICAgICAgICAgICAgICAgY2FjaGU6IG51bGwsCiAgICAgICAgICAgICAgICAvLyBub3QgZW5hYmxlZCB5ZXQKICAgICAgICAgICAgICAgIHRyYW5zaXRpb25zOiBudWxsLAogICAgICAgICAgICAgICAgcGVuZGluZ1N1c3BlbnNlQm91bmRhcmllczogbnVsbAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgdW5pbml0aWFsaXplZEZpYmVyLm1lbW9pemVkU3RhdGUgPSBfaW5pdGlhbFN0YXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGluaXRpYWxpemVVcGRhdGVRdWV1ZSh1bmluaXRpYWxpemVkRmliZXIpOwogICAgICAgICAgICByZXR1cm4gcm9vdDM7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgUmVhY3RWZXJzaW9uID0gIjE4LjIuMCI7CiAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVQb3J0YWwoY2hpbGRyZW4yLCBjb250YWluZXJJbmZvLCBpbXBsZW1lbnRhdGlvbikgewogICAgICAgICAgICB2YXIga2V5ID0gYXJndW1lbnRzLmxlbmd0aCA+IDMgJiYgYXJndW1lbnRzWzNdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbM10gOiBudWxsOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY2hlY2tLZXlTdHJpbmdDb2VyY2lvbihrZXkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgLy8gVGhpcyB0YWcgYWxsb3cgdXMgdG8gdW5pcXVlbHkgaWRlbnRpZnkgdGhpcyBhcyBhIFJlYWN0IFBvcnRhbAogICAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9QT1JUQUxfVFlQRSwKICAgICAgICAgICAgICBrZXk6IGtleSA9PSBudWxsID8gbnVsbCA6ICIiICsga2V5LAogICAgICAgICAgICAgIGNoaWxkcmVuOiBjaGlsZHJlbjIsCiAgICAgICAgICAgICAgY29udGFpbmVySW5mbywKICAgICAgICAgICAgICBpbXBsZW1lbnRhdGlvbgogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRpZFdhcm5BYm91dE5lc3RlZFVwZGF0ZXM7CiAgICAgICAgICB2YXIgZGlkV2FybkFib3V0RmluZE5vZGVJblN0cmljdE1vZGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGRpZFdhcm5BYm91dE5lc3RlZFVwZGF0ZXMgPSBmYWxzZTsKICAgICAgICAgICAgZGlkV2FybkFib3V0RmluZE5vZGVJblN0cmljdE1vZGUgPSB7fTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldENvbnRleHRGb3JTdWJ0cmVlKHBhcmVudENvbXBvbmVudCkgewogICAgICAgICAgICBpZiAoIXBhcmVudENvbXBvbmVudCkgewogICAgICAgICAgICAgIHJldHVybiBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGZpYmVyID0gZ2V0MyhwYXJlbnRDb21wb25lbnQpOwogICAgICAgICAgICB2YXIgcGFyZW50Q29udGV4dCA9IGZpbmRDdXJyZW50VW5tYXNrZWRDb250ZXh0KGZpYmVyKTsKICAgICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gZmliZXIudHlwZTsKICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHByb2Nlc3NDaGlsZENvbnRleHQoZmliZXIsIENvbXBvbmVudCwgcGFyZW50Q29udGV4dCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwYXJlbnRDb250ZXh0OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZmluZEhvc3RJbnN0YW5jZVdpdGhXYXJuaW5nKGNvbXBvbmVudCwgbWV0aG9kTmFtZSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIGZpYmVyID0gZ2V0Myhjb21wb25lbnQpOwogICAgICAgICAgICAgIGlmIChmaWJlciA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNvbXBvbmVudC5yZW5kZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gZmluZCBub2RlIG9uIGFuIHVubW91bnRlZCBjb21wb25lbnQuIik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGNvbXBvbmVudCkuam9pbigiLCIpOwogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkFyZ3VtZW50IGFwcGVhcnMgdG8gbm90IGJlIGEgUmVhY3RDb21wb25lbnQuIEtleXM6ICIgKyBrZXlzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGhvc3RGaWJlciA9IGZpbmRDdXJyZW50SG9zdEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgICBpZiAoaG9zdEZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGhvc3RGaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0RmluZE5vZGVJblN0cmljdE1vZGVbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0RmluZE5vZGVJblN0cmljdE1vZGVbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgICB2YXIgcHJldmlvdXNGaWJlciA9IGN1cnJlbnQ7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGhvc3RGaWJlcik7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZpYmVyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiJXMgaXMgZGVwcmVjYXRlZCBpbiBTdHJpY3RNb2RlLiAlcyB3YXMgcGFzc2VkIGFuIGluc3RhbmNlIG9mICVzIHdoaWNoIGlzIGluc2lkZSBTdHJpY3RNb2RlLiBJbnN0ZWFkLCBhZGQgYSByZWYgZGlyZWN0bHkgdG8gdGhlIGVsZW1lbnQgeW91IHdhbnQgdG8gcmVmZXJlbmNlLiBMZWFybiBtb3JlIGFib3V0IHVzaW5nIHJlZnMgc2FmZWx5IGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zdHJpY3QtbW9kZS1maW5kLW5vZGUiLCBtZXRob2ROYW1lLCBtZXRob2ROYW1lLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzIGlzIGRlcHJlY2F0ZWQgaW4gU3RyaWN0TW9kZS4gJXMgd2FzIHBhc3NlZCBhbiBpbnN0YW5jZSBvZiAlcyB3aGljaCByZW5kZXJzIFN0cmljdE1vZGUgY2hpbGRyZW4uIEluc3RlYWQsIGFkZCBhIHJlZiBkaXJlY3RseSB0byB0aGUgZWxlbWVudCB5b3Ugd2FudCB0byByZWZlcmVuY2UuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLWZpbmQtbm9kZSIsIG1ldGhvZE5hbWUsIG1ldGhvZE5hbWUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNGaWJlcikgewogICAgICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKHByZXZpb3VzRmliZXIpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gaG9zdEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ29udGFpbmVyKGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0aW9uQ2FsbGJhY2tzLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvciwgdHJhbnNpdGlvbkNhbGxiYWNrcykgewogICAgICAgICAgICB2YXIgaHlkcmF0ZTIgPSBmYWxzZTsKICAgICAgICAgICAgdmFyIGluaXRpYWxDaGlsZHJlbiA9IG51bGw7CiAgICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlclJvb3QoY29udGFpbmVySW5mbywgdGFnLCBoeWRyYXRlMiwgaW5pdGlhbENoaWxkcmVuLCBoeWRyYXRpb25DYWxsYmFja3MsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUh5ZHJhdGlvbkNvbnRhaW5lcihpbml0aWFsQ2hpbGRyZW4sIGNhbGxiYWNrLCBjb250YWluZXJJbmZvLCB0YWcsIGh5ZHJhdGlvbkNhbGxiYWNrcywgaXNTdHJpY3RNb2RlLCBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IsIHRyYW5zaXRpb25DYWxsYmFja3MpIHsKICAgICAgICAgICAgdmFyIGh5ZHJhdGUyID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIHJvb3QzID0gY3JlYXRlRmliZXJSb290KGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0ZTIsIGluaXRpYWxDaGlsZHJlbiwgaHlkcmF0aW9uQ2FsbGJhY2tzLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICAgIHJvb3QzLmNvbnRleHQgPSBnZXRDb250ZXh0Rm9yU3VidHJlZShudWxsKTsKICAgICAgICAgICAgdmFyIGN1cnJlbnQyID0gcm9vdDMuY3VycmVudDsKICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSByZXF1ZXN0VXBkYXRlTGFuZShjdXJyZW50Mik7CiAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoZXZlbnRUaW1lLCBsYW5lKTsKICAgICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gY2FsbGJhY2sgIT09IHZvaWQgMCAmJiBjYWxsYmFjayAhPT0gbnVsbCA/IGNhbGxiYWNrIDogbnVsbDsKICAgICAgICAgICAgZW5xdWV1ZVVwZGF0ZShjdXJyZW50MiwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgICAgc2NoZWR1bGVJbml0aWFsSHlkcmF0aW9uT25Sb290KHJvb3QzLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICByZXR1cm4gcm9vdDM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVDb250YWluZXIoZWxlbWVudCwgY29udGFpbmVyLCBwYXJlbnRDb21wb25lbnQsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBvblNjaGVkdWxlUm9vdChjb250YWluZXIsIGVsZW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjdXJyZW50JDEgPSBjb250YWluZXIuY3VycmVudDsKICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSByZXF1ZXN0VXBkYXRlTGFuZShjdXJyZW50JDEpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya1JlbmRlclNjaGVkdWxlZChsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY29udGV4dCA9IGdldENvbnRleHRGb3JTdWJ0cmVlKHBhcmVudENvbXBvbmVudCk7CiAgICAgICAgICAgIGlmIChjb250YWluZXIuY29udGV4dCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGNvbnRhaW5lci5jb250ZXh0ID0gY29udGV4dDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb250YWluZXIucGVuZGluZ0NvbnRleHQgPSBjb250ZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaXNSZW5kZXJpbmcgJiYgY3VycmVudCAhPT0gbnVsbCAmJiAhZGlkV2FybkFib3V0TmVzdGVkVXBkYXRlcykgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0TmVzdGVkVXBkYXRlcyA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcigiUmVuZGVyIG1ldGhvZHMgc2hvdWxkIGJlIGEgcHVyZSBmdW5jdGlvbiBvZiBwcm9wcyBhbmQgc3RhdGU7IHRyaWdnZXJpbmcgbmVzdGVkIGNvbXBvbmVudCB1cGRhdGVzIGZyb20gcmVuZGVyIGlzIG5vdCBhbGxvd2VkLiBJZiBuZWNlc3NhcnksIHRyaWdnZXIgbmVzdGVkIHVwZGF0ZXMgaW4gY29tcG9uZW50RGlkVXBkYXRlLlxuXG5DaGVjayB0aGUgcmVuZGVyIG1ldGhvZCBvZiAlcy4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGN1cnJlbnQpIHx8ICJVbmtub3duIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoZXZlbnRUaW1lLCBsYW5lKTsKICAgICAgICAgICAgdXBkYXRlLnBheWxvYWQgPSB7CiAgICAgICAgICAgICAgZWxlbWVudAogICAgICAgICAgICB9OwogICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrID09PSB2b2lkIDAgPyBudWxsIDogY2FsbGJhY2s7CiAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoInJlbmRlciguLi4pOiBFeHBlY3RlZCB0aGUgbGFzdCBvcHRpb25hbCBgY2FsbGJhY2tgIGFyZ3VtZW50IHRvIGJlIGEgZnVuY3Rpb24uIEluc3RlYWQgcmVjZWl2ZWQ6ICVzLiIsIGNhbGxiYWNrKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZVVwZGF0ZShjdXJyZW50JDEsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgY3VycmVudCQxLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICAgIGVudGFuZ2xlVHJhbnNpdGlvbnMocm9vdDMsIGN1cnJlbnQkMSwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxhbmU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRQdWJsaWNSb290SW5zdGFuY2UoY29udGFpbmVyKSB7CiAgICAgICAgICAgIHZhciBjb250YWluZXJGaWJlciA9IGNvbnRhaW5lci5jdXJyZW50OwogICAgICAgICAgICBpZiAoIWNvbnRhaW5lckZpYmVyLmNoaWxkKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3dpdGNoIChjb250YWluZXJGaWJlci5jaGlsZC50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0UHVibGljSW5zdGFuY2UoY29udGFpbmVyRmliZXIuY2hpbGQuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lckZpYmVyLmNoaWxkLnN0YXRlTm9kZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uJDEoZmliZXIpIHsKICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAoaXNSb290RGVoeWRyYXRlZChyb290MykpIHsKICAgICAgICAgICAgICAgICAgdmFyIGxhbmVzID0gZ2V0SGlnaGVzdFByaW9yaXR5UGVuZGluZ0xhbmVzKHJvb3QzKTsKICAgICAgICAgICAgICAgICAgZmx1c2hSb290KHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgICAgZmx1c2hTeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB2YXIgcm9vdDQgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICAgICAgaWYgKHJvb3Q0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDQsIGZpYmVyLCBTeW5jTGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB2YXIgcmV0cnlMYW5lID0gU3luY0xhbmU7CiAgICAgICAgICAgICAgICBtYXJrUmV0cnlMYW5lSWZOb3RIeWRyYXRlZChmaWJlciwgcmV0cnlMYW5lKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbWFya1JldHJ5TGFuZUltcGwoZmliZXIsIHJldHJ5TGFuZSkgewogICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlICE9PSBudWxsICYmIHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN1c3BlbnNlU3RhdGUucmV0cnlMYW5lID0gaGlnaGVyUHJpb3JpdHlMYW5lKHN1c3BlbnNlU3RhdGUucmV0cnlMYW5lLCByZXRyeUxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtYXJrUmV0cnlMYW5lSWZOb3RIeWRyYXRlZChmaWJlciwgcmV0cnlMYW5lKSB7CiAgICAgICAgICAgIG1hcmtSZXRyeUxhbmVJbXBsKGZpYmVyLCByZXRyeUxhbmUpOwogICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoYWx0ZXJuYXRlKSB7CiAgICAgICAgICAgICAgbWFya1JldHJ5TGFuZUltcGwoYWx0ZXJuYXRlLCByZXRyeUxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbiQxKGZpYmVyKSB7CiAgICAgICAgICAgIGlmIChmaWJlci50YWcgIT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBsYW5lID0gU2VsZWN0aXZlSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG1hcmtSZXRyeUxhbmVJZk5vdEh5ZHJhdGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eSQxKGZpYmVyKSB7CiAgICAgICAgICAgIGlmIChmaWJlci50YWcgIT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoZmliZXIpOwogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIGxhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbWFya1JldHJ5TGFuZUlmTm90SHlkcmF0ZWQoZmliZXIsIGxhbmUpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZmluZEhvc3RJbnN0YW5jZVdpdGhOb1BvcnRhbHMoZmliZXIpIHsKICAgICAgICAgICAgdmFyIGhvc3RGaWJlciA9IGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFscyhmaWJlcik7CiAgICAgICAgICAgIGlmIChob3N0RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaG9zdEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzaG91bGRFcnJvckltcGwgPSBmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH07CiAgICAgICAgICBmdW5jdGlvbiBzaG91bGRFcnJvcihmaWJlcikgewogICAgICAgICAgICByZXR1cm4gc2hvdWxkRXJyb3JJbXBsKGZpYmVyKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzaG91bGRTdXNwZW5kSW1wbCA9IGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH07CiAgICAgICAgICBmdW5jdGlvbiBzaG91bGRTdXNwZW5kKGZpYmVyKSB7CiAgICAgICAgICAgIHJldHVybiBzaG91bGRTdXNwZW5kSW1wbChmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgb3ZlcnJpZGVIb29rU3RhdGUgPSBudWxsOwogICAgICAgICAgdmFyIG92ZXJyaWRlSG9va1N0YXRlRGVsZXRlUGF0aCA9IG51bGw7CiAgICAgICAgICB2YXIgb3ZlcnJpZGVIb29rU3RhdGVSZW5hbWVQYXRoID0gbnVsbDsKICAgICAgICAgIHZhciBvdmVycmlkZVByb3BzID0gbnVsbDsKICAgICAgICAgIHZhciBvdmVycmlkZVByb3BzRGVsZXRlUGF0aCA9IG51bGw7CiAgICAgICAgICB2YXIgb3ZlcnJpZGVQcm9wc1JlbmFtZVBhdGggPSBudWxsOwogICAgICAgICAgdmFyIHNjaGVkdWxlVXBkYXRlID0gbnVsbDsKICAgICAgICAgIHZhciBzZXRFcnJvckhhbmRsZXIgPSBudWxsOwogICAgICAgICAgdmFyIHNldFN1c3BlbnNlSGFuZGxlciA9IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBjb3B5V2l0aERlbGV0ZUltcGwgPSBmdW5jdGlvbihvYmosIHBhdGgsIGluZGV4MykgewogICAgICAgICAgICAgIHZhciBrZXkgPSBwYXRoW2luZGV4M107CiAgICAgICAgICAgICAgdmFyIHVwZGF0ZWQgPSBpc0FycmF5KG9iaikgPyBvYmouc2xpY2UoKSA6IGFzc2lnbih7fSwgb2JqKTsKICAgICAgICAgICAgICBpZiAoaW5kZXgzICsgMSA9PT0gcGF0aC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KHVwZGF0ZWQpKSB7CiAgICAgICAgICAgICAgICAgIHVwZGF0ZWQuc3BsaWNlKGtleSwgMSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBkZWxldGUgdXBkYXRlZFtrZXldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZWQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVwZGF0ZWRba2V5XSA9IGNvcHlXaXRoRGVsZXRlSW1wbChvYmpba2V5XSwgcGF0aCwgaW5kZXgzICsgMSk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZWQ7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciBjb3B5V2l0aERlbGV0ZSA9IGZ1bmN0aW9uKG9iaiwgcGF0aCkgewogICAgICAgICAgICAgIHJldHVybiBjb3B5V2l0aERlbGV0ZUltcGwob2JqLCBwYXRoLCAwKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIGNvcHlXaXRoUmVuYW1lSW1wbCA9IGZ1bmN0aW9uKG9iaiwgb2xkUGF0aCwgbmV3UGF0aCwgaW5kZXgzKSB7CiAgICAgICAgICAgICAgdmFyIG9sZEtleSA9IG9sZFBhdGhbaW5kZXgzXTsKICAgICAgICAgICAgICB2YXIgdXBkYXRlZCA9IGlzQXJyYXkob2JqKSA/IG9iai5zbGljZSgpIDogYXNzaWduKHt9LCBvYmopOwogICAgICAgICAgICAgIGlmIChpbmRleDMgKyAxID09PSBvbGRQYXRoLmxlbmd0aCkgewogICAgICAgICAgICAgICAgdmFyIG5ld0tleSA9IG5ld1BhdGhbaW5kZXgzXTsKICAgICAgICAgICAgICAgIHVwZGF0ZWRbbmV3S2V5XSA9IHVwZGF0ZWRbb2xkS2V5XTsKICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KHVwZGF0ZWQpKSB7CiAgICAgICAgICAgICAgICAgIHVwZGF0ZWQuc3BsaWNlKG9sZEtleSwgMSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBkZWxldGUgdXBkYXRlZFtvbGRLZXldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB1cGRhdGVkW29sZEtleV0gPSBjb3B5V2l0aFJlbmFtZUltcGwoCiAgICAgICAgICAgICAgICAgIC8vICRGbG93Rml4TWUgbnVtYmVyIG9yIHN0cmluZyBpcyBmaW5lIGhlcmUKICAgICAgICAgICAgICAgICAgb2JqW29sZEtleV0sCiAgICAgICAgICAgICAgICAgIG9sZFBhdGgsCiAgICAgICAgICAgICAgICAgIG5ld1BhdGgsCiAgICAgICAgICAgICAgICAgIGluZGV4MyArIDEKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVkOwogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgY29weVdpdGhSZW5hbWUgPSBmdW5jdGlvbihvYmosIG9sZFBhdGgsIG5ld1BhdGgpIHsKICAgICAgICAgICAgICBpZiAob2xkUGF0aC5sZW5ndGggIT09IG5ld1BhdGgubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB3YXJuKCJjb3B5V2l0aFJlbmFtZSgpIGV4cGVjdHMgcGF0aHMgb2YgdGhlIHNhbWUgbGVuZ3RoIik7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbmV3UGF0aC5sZW5ndGggLSAxOyBpKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKG9sZFBhdGhbaV0gIT09IG5ld1BhdGhbaV0pIHsKICAgICAgICAgICAgICAgICAgICB3YXJuKCJjb3B5V2l0aFJlbmFtZSgpIGV4cGVjdHMgcGF0aHMgdG8gYmUgdGhlIHNhbWUgZXhjZXB0IGZvciB0aGUgZGVlcGVzdCBrZXkiKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGNvcHlXaXRoUmVuYW1lSW1wbChvYmosIG9sZFBhdGgsIG5ld1BhdGgsIDApOwogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgY29weVdpdGhTZXRJbXBsID0gZnVuY3Rpb24ob2JqLCBwYXRoLCBpbmRleDMsIHZhbHVlKSB7CiAgICAgICAgICAgICAgaWYgKGluZGV4MyA+PSBwYXRoLmxlbmd0aCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIga2V5ID0gcGF0aFtpbmRleDNdOwogICAgICAgICAgICAgIHZhciB1cGRhdGVkID0gaXNBcnJheShvYmopID8gb2JqLnNsaWNlKCkgOiBhc3NpZ24oe30sIG9iaik7CiAgICAgICAgICAgICAgdXBkYXRlZFtrZXldID0gY29weVdpdGhTZXRJbXBsKG9ialtrZXldLCBwYXRoLCBpbmRleDMgKyAxLCB2YWx1ZSk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZWQ7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciBjb3B5V2l0aFNldCA9IGZ1bmN0aW9uKG9iaiwgcGF0aCwgdmFsdWUpIHsKICAgICAgICAgICAgICByZXR1cm4gY29weVdpdGhTZXRJbXBsKG9iaiwgcGF0aCwgMCwgdmFsdWUpOwogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgZmluZEhvb2sgPSBmdW5jdGlvbihmaWJlciwgaWQyKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnRIb29rMiA9IGZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnRIb29rMiAhPT0gbnVsbCAmJiBpZDIgPiAwKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SG9vazIgPSBjdXJyZW50SG9vazIubmV4dDsKICAgICAgICAgICAgICAgIGlkMi0tOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gY3VycmVudEhvb2syOwogICAgICAgICAgICB9OwogICAgICAgICAgICBvdmVycmlkZUhvb2tTdGF0ZSA9IGZ1bmN0aW9uKGZpYmVyLCBpZDIsIHBhdGgsIHZhbHVlKSB7CiAgICAgICAgICAgICAgdmFyIGhvb2sgPSBmaW5kSG9vayhmaWJlciwgaWQyKTsKICAgICAgICAgICAgICBpZiAoaG9vayAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gY29weVdpdGhTZXQoaG9vay5tZW1vaXplZFN0YXRlLCBwYXRoLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgICBmaWJlci5tZW1vaXplZFByb3BzID0gYXNzaWduKHt9LCBmaWJlci5tZW1vaXplZFByb3BzKTsKICAgICAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICBvdmVycmlkZUhvb2tTdGF0ZURlbGV0ZVBhdGggPSBmdW5jdGlvbihmaWJlciwgaWQyLCBwYXRoKSB7CiAgICAgICAgICAgICAgdmFyIGhvb2sgPSBmaW5kSG9vayhmaWJlciwgaWQyKTsKICAgICAgICAgICAgICBpZiAoaG9vayAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gY29weVdpdGhEZWxldGUoaG9vay5tZW1vaXplZFN0YXRlLCBwYXRoKTsKICAgICAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgICAgaG9vay5iYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICAgIGZpYmVyLm1lbW9pemVkUHJvcHMgPSBhc3NpZ24oe30sIGZpYmVyLm1lbW9pemVkUHJvcHMpOwogICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIG92ZXJyaWRlSG9va1N0YXRlUmVuYW1lUGF0aCA9IGZ1bmN0aW9uKGZpYmVyLCBpZDIsIG9sZFBhdGgsIG5ld1BhdGgpIHsKICAgICAgICAgICAgICB2YXIgaG9vayA9IGZpbmRIb29rKGZpYmVyLCBpZDIpOwogICAgICAgICAgICAgIGlmIChob29rICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBjb3B5V2l0aFJlbmFtZShob29rLm1lbW9pemVkU3RhdGUsIG9sZFBhdGgsIG5ld1BhdGgpOwogICAgICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgICBob29rLmJhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgICAgZmliZXIubWVtb2l6ZWRQcm9wcyA9IGFzc2lnbih7fSwgZmliZXIubWVtb2l6ZWRQcm9wcyk7CiAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgb3ZlcnJpZGVQcm9wcyA9IGZ1bmN0aW9uKGZpYmVyLCBwYXRoLCB2YWx1ZSkgewogICAgICAgICAgICAgIGZpYmVyLnBlbmRpbmdQcm9wcyA9IGNvcHlXaXRoU2V0KGZpYmVyLm1lbW9pemVkUHJvcHMsIHBhdGgsIHZhbHVlKTsKICAgICAgICAgICAgICBpZiAoZmliZXIuYWx0ZXJuYXRlKSB7CiAgICAgICAgICAgICAgICBmaWJlci5hbHRlcm5hdGUucGVuZGluZ1Byb3BzID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICBvdmVycmlkZVByb3BzRGVsZXRlUGF0aCA9IGZ1bmN0aW9uKGZpYmVyLCBwYXRoKSB7CiAgICAgICAgICAgICAgZmliZXIucGVuZGluZ1Byb3BzID0gY29weVdpdGhEZWxldGUoZmliZXIubWVtb2l6ZWRQcm9wcywgcGF0aCk7CiAgICAgICAgICAgICAgaWYgKGZpYmVyLmFsdGVybmF0ZSkgewogICAgICAgICAgICAgICAgZmliZXIuYWx0ZXJuYXRlLnBlbmRpbmdQcm9wcyA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgb3ZlcnJpZGVQcm9wc1JlbmFtZVBhdGggPSBmdW5jdGlvbihmaWJlciwgb2xkUGF0aCwgbmV3UGF0aCkgewogICAgICAgICAgICAgIGZpYmVyLnBlbmRpbmdQcm9wcyA9IGNvcHlXaXRoUmVuYW1lKGZpYmVyLm1lbW9pemVkUHJvcHMsIG9sZFBhdGgsIG5ld1BhdGgpOwogICAgICAgICAgICAgIGlmIChmaWJlci5hbHRlcm5hdGUpIHsKICAgICAgICAgICAgICAgIGZpYmVyLmFsdGVybmF0ZS5wZW5kaW5nUHJvcHMgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlID0gZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICBzZXRFcnJvckhhbmRsZXIgPSBmdW5jdGlvbihuZXdTaG91bGRFcnJvckltcGwpIHsKICAgICAgICAgICAgICBzaG91bGRFcnJvckltcGwgPSBuZXdTaG91bGRFcnJvckltcGw7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHNldFN1c3BlbnNlSGFuZGxlciA9IGZ1bmN0aW9uKG5ld1Nob3VsZFN1c3BlbmRJbXBsKSB7CiAgICAgICAgICAgICAgc2hvdWxkU3VzcGVuZEltcGwgPSBuZXdTaG91bGRTdXNwZW5kSW1wbDsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGZpbmRIb3N0SW5zdGFuY2VCeUZpYmVyKGZpYmVyKSB7CiAgICAgICAgICAgIHZhciBob3N0RmliZXIgPSBmaW5kQ3VycmVudEhvc3RGaWJlcihmaWJlcik7CiAgICAgICAgICAgIGlmIChob3N0RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaG9zdEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGVtcHR5RmluZEZpYmVyQnlIb3N0SW5zdGFuY2UoaW5zdGFuY2UpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50RmliZXJGb3JEZXZUb29scygpIHsKICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpbmplY3RJbnRvRGV2VG9vbHMoZGV2VG9vbHNDb25maWcpIHsKICAgICAgICAgICAgdmFyIGZpbmRGaWJlckJ5SG9zdEluc3RhbmNlID0gZGV2VG9vbHNDb25maWcuZmluZEZpYmVyQnlIb3N0SW5zdGFuY2U7CiAgICAgICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyMiA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudERpc3BhdGNoZXI7CiAgICAgICAgICAgIHJldHVybiBpbmplY3RJbnRlcm5hbHMoewogICAgICAgICAgICAgIGJ1bmRsZVR5cGU6IGRldlRvb2xzQ29uZmlnLmJ1bmRsZVR5cGUsCiAgICAgICAgICAgICAgdmVyc2lvbjogZGV2VG9vbHNDb25maWcudmVyc2lvbiwKICAgICAgICAgICAgICByZW5kZXJlclBhY2thZ2VOYW1lOiBkZXZUb29sc0NvbmZpZy5yZW5kZXJlclBhY2thZ2VOYW1lLAogICAgICAgICAgICAgIHJlbmRlcmVyQ29uZmlnOiBkZXZUb29sc0NvbmZpZy5yZW5kZXJlckNvbmZpZywKICAgICAgICAgICAgICBvdmVycmlkZUhvb2tTdGF0ZSwKICAgICAgICAgICAgICBvdmVycmlkZUhvb2tTdGF0ZURlbGV0ZVBhdGgsCiAgICAgICAgICAgICAgb3ZlcnJpZGVIb29rU3RhdGVSZW5hbWVQYXRoLAogICAgICAgICAgICAgIG92ZXJyaWRlUHJvcHMsCiAgICAgICAgICAgICAgb3ZlcnJpZGVQcm9wc0RlbGV0ZVBhdGgsCiAgICAgICAgICAgICAgb3ZlcnJpZGVQcm9wc1JlbmFtZVBhdGgsCiAgICAgICAgICAgICAgc2V0RXJyb3JIYW5kbGVyLAogICAgICAgICAgICAgIHNldFN1c3BlbnNlSGFuZGxlciwKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZSwKICAgICAgICAgICAgICBjdXJyZW50RGlzcGF0Y2hlclJlZjogUmVhY3RDdXJyZW50RGlzcGF0Y2hlcjIsCiAgICAgICAgICAgICAgZmluZEhvc3RJbnN0YW5jZUJ5RmliZXIsCiAgICAgICAgICAgICAgZmluZEZpYmVyQnlIb3N0SW5zdGFuY2U6IGZpbmRGaWJlckJ5SG9zdEluc3RhbmNlIHx8IGVtcHR5RmluZEZpYmVyQnlIb3N0SW5zdGFuY2UsCiAgICAgICAgICAgICAgLy8gUmVhY3QgUmVmcmVzaAogICAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VzRm9yUmVmcmVzaCwKICAgICAgICAgICAgICBzY2hlZHVsZVJlZnJlc2gsCiAgICAgICAgICAgICAgc2NoZWR1bGVSb290LAogICAgICAgICAgICAgIHNldFJlZnJlc2hIYW5kbGVyLAogICAgICAgICAgICAgIC8vIEVuYWJsZXMgRGV2VG9vbHMgdG8gYXBwZW5kIG93bmVyIHN0YWNrcyB0byBlcnJvciBtZXNzYWdlcyBpbiBERVYgbW9kZS4KICAgICAgICAgICAgICBnZXRDdXJyZW50RmliZXI6IGdldEN1cnJlbnRGaWJlckZvckRldlRvb2xzLAogICAgICAgICAgICAgIC8vIEVuYWJsZXMgRGV2VG9vbHMgdG8gZGV0ZWN0IHJlY29uY2lsZXIgdmVyc2lvbiByYXRoZXIgdGhhbiByZW5kZXJlciB2ZXJzaW9uCiAgICAgICAgICAgICAgLy8gd2hpY2ggbWF5IG5vdCBtYXRjaCBmb3IgdGhpcmQgcGFydHkgcmVuZGVyZXJzLgogICAgICAgICAgICAgIHJlY29uY2lsZXJWZXJzaW9uOiBSZWFjdFZlcnNpb24KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZGVmYXVsdE9uUmVjb3ZlcmFibGVFcnJvciA9IHR5cGVvZiByZXBvcnRFcnJvciA9PT0gImZ1bmN0aW9uIiA/ICgKICAgICAgICAgICAgLy8gSW4gbW9kZXJuIGJyb3dzZXJzLCByZXBvcnRFcnJvciB3aWxsIGRpc3BhdGNoIGFuIGVycm9yIGV2ZW50LAogICAgICAgICAgICAvLyBlbXVsYXRpbmcgYW4gdW5jYXVnaHQgSmF2YVNjcmlwdCBlcnJvci4KICAgICAgICAgICAgcmVwb3J0RXJyb3IKICAgICAgICAgICkgOiBmdW5jdGlvbihlcnJvcjIpIHsKICAgICAgICAgICAgY29uc29sZVsiZXJyb3IiXShlcnJvcjIpOwogICAgICAgICAgfTsKICAgICAgICAgIGZ1bmN0aW9uIFJlYWN0RE9NUm9vdChpbnRlcm5hbFJvb3QpIHsKICAgICAgICAgICAgdGhpcy5faW50ZXJuYWxSb290ID0gaW50ZXJuYWxSb290OwogICAgICAgICAgfQogICAgICAgICAgUmVhY3RET01IeWRyYXRpb25Sb290LnByb3RvdHlwZS5yZW5kZXIgPSBSZWFjdERPTVJvb3QucHJvdG90eXBlLnJlbmRlciA9IGZ1bmN0aW9uKGNoaWxkcmVuMikgewogICAgICAgICAgICB2YXIgcm9vdDMgPSB0aGlzLl9pbnRlcm5hbFJvb3Q7CiAgICAgICAgICAgIGlmIChyb290MyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IHVwZGF0ZSBhbiB1bm1vdW50ZWQgcm9vdC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBhcmd1bWVudHNbMV0gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJyZW5kZXIoLi4uKTogZG9lcyBub3Qgc3VwcG9ydCB0aGUgc2Vjb25kIGNhbGxiYWNrIGFyZ3VtZW50LiBUbyBleGVjdXRlIGEgc2lkZSBlZmZlY3QgYWZ0ZXIgcmVuZGVyaW5nLCBkZWNsYXJlIGl0IGluIGEgY29tcG9uZW50IGJvZHkgd2l0aCB1c2VFZmZlY3QoKS4iKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzVmFsaWRDb250YWluZXIoYXJndW1lbnRzWzFdKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIllvdSBwYXNzZWQgYSBjb250YWluZXIgdG8gdGhlIHNlY29uZCBhcmd1bWVudCBvZiByb290LnJlbmRlciguLi4pLiBZb3UgZG9uJ3QgbmVlZCB0byBwYXNzIGl0IGFnYWluIHNpbmNlIHlvdSBhbHJlYWR5IHBhc3NlZCBpdCB0byBjcmVhdGUgdGhlIHJvb3QuIik7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYXJndW1lbnRzWzFdICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgZXJyb3IoIllvdSBwYXNzZWQgYSBzZWNvbmQgYXJndW1lbnQgdG8gcm9vdC5yZW5kZXIoLi4uKSBidXQgaXQgb25seSBhY2NlcHRzIG9uZSBhcmd1bWVudC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGNvbnRhaW5lciA9IHJvb3QzLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgICAgaWYgKGNvbnRhaW5lci5ub2RlVHlwZSAhPT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgICB2YXIgaG9zdEluc3RhbmNlID0gZmluZEhvc3RJbnN0YW5jZVdpdGhOb1BvcnRhbHMocm9vdDMuY3VycmVudCk7CiAgICAgICAgICAgICAgICBpZiAoaG9zdEluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICAgIGlmIChob3N0SW5zdGFuY2UucGFyZW50Tm9kZSAhPT0gY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoInJlbmRlciguLi4pOiBJdCBsb29rcyBsaWtlIHRoZSBSZWFjdC1yZW5kZXJlZCBjb250ZW50IG9mIHRoZSByb290IGNvbnRhaW5lciB3YXMgcmVtb3ZlZCB3aXRob3V0IHVzaW5nIFJlYWN0LiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgY2F1c2UgZXJyb3JzLiBJbnN0ZWFkLCBjYWxsIHJvb3QudW5tb3VudCgpIHRvIGVtcHR5IGEgcm9vdCdzIGNvbnRhaW5lci4iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB1cGRhdGVDb250YWluZXIoY2hpbGRyZW4yLCByb290MywgbnVsbCwgbnVsbCk7CiAgICAgICAgICB9OwogICAgICAgICAgUmVhY3RET01IeWRyYXRpb25Sb290LnByb3RvdHlwZS51bm1vdW50ID0gUmVhY3RET01Sb290LnByb3RvdHlwZS51bm1vdW50ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3VtZW50c1swXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZXJyb3IoInVubW91bnQoLi4uKTogZG9lcyBub3Qgc3VwcG9ydCBhIGNhbGxiYWNrIGFyZ3VtZW50LiBUbyBleGVjdXRlIGEgc2lkZSBlZmZlY3QgYWZ0ZXIgcmVuZGVyaW5nLCBkZWNsYXJlIGl0IGluIGEgY29tcG9uZW50IGJvZHkgd2l0aCB1c2VFZmZlY3QoKS4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gdGhpcy5faW50ZXJuYWxSb290OwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICB0aGlzLl9pbnRlcm5hbFJvb3QgPSBudWxsOwogICAgICAgICAgICAgIHZhciBjb250YWluZXIgPSByb290My5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChpc0FscmVhZHlSZW5kZXJpbmcoKSkgewogICAgICAgICAgICAgICAgICBlcnJvcigiQXR0ZW1wdGVkIHRvIHN5bmNocm9ub3VzbHkgdW5tb3VudCBhIHJvb3Qgd2hpbGUgUmVhY3Qgd2FzIGFscmVhZHkgcmVuZGVyaW5nLiBSZWFjdCBjYW5ub3QgZmluaXNoIHVubW91bnRpbmcgdGhlIHJvb3QgdW50aWwgdGhlIGN1cnJlbnQgcmVuZGVyIGhhcyBjb21wbGV0ZWQsIHdoaWNoIG1heSBsZWFkIHRvIGEgcmFjZSBjb25kaXRpb24uIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZsdXNoU3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHVwZGF0ZUNvbnRhaW5lcihudWxsLCByb290MywgbnVsbCwgbnVsbCk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgdW5tYXJrQ29udGFpbmVyQXNSb290KGNvbnRhaW5lcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVSb290KGNvbnRhaW5lciwgb3B0aW9uczIpIHsKICAgICAgICAgICAgaWYgKCFpc1ZhbGlkQ29udGFpbmVyKGNvbnRhaW5lcikpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImNyZWF0ZVJvb3QoLi4uKTogVGFyZ2V0IGNvbnRhaW5lciBpcyBub3QgYSBET00gZWxlbWVudC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuSWZSZWFjdERPTUNvbnRhaW5lckluREVWKGNvbnRhaW5lcik7CiAgICAgICAgICAgIHZhciBpc1N0cmljdE1vZGUgPSBmYWxzZTsKICAgICAgICAgICAgdmFyIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUgPSBmYWxzZTsKICAgICAgICAgICAgdmFyIGlkZW50aWZpZXJQcmVmaXggPSAiIjsKICAgICAgICAgICAgdmFyIG9uUmVjb3ZlcmFibGVFcnJvciA9IGRlZmF1bHRPblJlY292ZXJhYmxlRXJyb3I7CiAgICAgICAgICAgIHZhciB0cmFuc2l0aW9uQ2FsbGJhY2tzID0gbnVsbDsKICAgICAgICAgICAgaWYgKG9wdGlvbnMyICE9PSBudWxsICYmIG9wdGlvbnMyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAob3B0aW9uczIuaHlkcmF0ZSkgewogICAgICAgICAgICAgICAgICB3YXJuKCJoeWRyYXRlIHRocm91Z2ggY3JlYXRlUm9vdCBpcyBkZXByZWNhdGVkLiBVc2UgUmVhY3RET01DbGllbnQuaHlkcmF0ZVJvb3QoY29udGFpbmVyLCA8QXBwIC8+KSBpbnN0ZWFkLiIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zMiA9PT0gIm9iamVjdCIgJiYgb3B0aW9uczIgIT09IG51bGwgJiYgb3B0aW9uczIuJCR0eXBlb2YgPT09IFJFQUNUX0VMRU1FTlRfVFlQRSkgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCJZb3UgcGFzc2VkIGEgSlNYIGVsZW1lbnQgdG8gY3JlYXRlUm9vdC4gWW91IHByb2JhYmx5IG1lYW50IHRvIGNhbGwgcm9vdC5yZW5kZXIgaW5zdGVhZC4gRXhhbXBsZSB1c2FnZTpcblxuICBsZXQgcm9vdCA9IGNyZWF0ZVJvb3QoZG9tQ29udGFpbmVyKTtcbiAgcm9vdC5yZW5kZXIoPEFwcCAvPik7Iik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG9wdGlvbnMyLnVuc3RhYmxlX3N0cmljdE1vZGUgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgIGlzU3RyaWN0TW9kZSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChvcHRpb25zMi5pZGVudGlmaWVyUHJlZml4ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIGlkZW50aWZpZXJQcmVmaXggPSBvcHRpb25zMi5pZGVudGlmaWVyUHJlZml4OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAob3B0aW9uczIub25SZWNvdmVyYWJsZUVycm9yICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIG9uUmVjb3ZlcmFibGVFcnJvciA9IG9wdGlvbnMyLm9uUmVjb3ZlcmFibGVFcnJvcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG9wdGlvbnMyLnRyYW5zaXRpb25DYWxsYmFja3MgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgdHJhbnNpdGlvbkNhbGxiYWNrcyA9IG9wdGlvbnMyLnRyYW5zaXRpb25DYWxsYmFja3M7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGNyZWF0ZUNvbnRhaW5lcihjb250YWluZXIsIENvbmN1cnJlbnRSb290LCBudWxsLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICAgIG1hcmtDb250YWluZXJBc1Jvb3Qocm9vdDMuY3VycmVudCwgY29udGFpbmVyKTsKICAgICAgICAgICAgdmFyIHJvb3RDb250YWluZXJFbGVtZW50ID0gY29udGFpbmVyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUgPyBjb250YWluZXIucGFyZW50Tm9kZSA6IGNvbnRhaW5lcjsKICAgICAgICAgICAgbGlzdGVuVG9BbGxTdXBwb3J0ZWRFdmVudHMocm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgICByZXR1cm4gbmV3IFJlYWN0RE9NUm9vdChyb290Myk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBSZWFjdERPTUh5ZHJhdGlvblJvb3QoaW50ZXJuYWxSb290KSB7CiAgICAgICAgICAgIHRoaXMuX2ludGVybmFsUm9vdCA9IGludGVybmFsUm9vdDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlSHlkcmF0aW9uKHRhcmdldCkgewogICAgICAgICAgICBpZiAodGFyZ2V0KSB7CiAgICAgICAgICAgICAgcXVldWVFeHBsaWNpdEh5ZHJhdGlvblRhcmdldCh0YXJnZXQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBSZWFjdERPTUh5ZHJhdGlvblJvb3QucHJvdG90eXBlLnVuc3RhYmxlX3NjaGVkdWxlSHlkcmF0aW9uID0gc2NoZWR1bGVIeWRyYXRpb247CiAgICAgICAgICBmdW5jdGlvbiBoeWRyYXRlUm9vdChjb250YWluZXIsIGluaXRpYWxDaGlsZHJlbiwgb3B0aW9uczIpIHsKICAgICAgICAgICAgaWYgKCFpc1ZhbGlkQ29udGFpbmVyKGNvbnRhaW5lcikpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImh5ZHJhdGVSb290KC4uLik6IFRhcmdldCBjb250YWluZXIgaXMgbm90IGEgRE9NIGVsZW1lbnQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2FybklmUmVhY3RET01Db250YWluZXJJbkRFVihjb250YWluZXIpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGluaXRpYWxDaGlsZHJlbiA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiTXVzdCBwcm92aWRlIGluaXRpYWwgY2hpbGRyZW4gYXMgc2Vjb25kIGFyZ3VtZW50IHRvIGh5ZHJhdGVSb290LiBFeGFtcGxlIHVzYWdlOiBoeWRyYXRlUm9vdChkb21Db250YWluZXIsIDxBcHAgLz4pIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBoeWRyYXRpb25DYWxsYmFja3MgPSBvcHRpb25zMiAhPSBudWxsID8gb3B0aW9uczIgOiBudWxsOwogICAgICAgICAgICB2YXIgbXV0YWJsZVNvdXJjZXMgPSBvcHRpb25zMiAhPSBudWxsICYmIG9wdGlvbnMyLmh5ZHJhdGVkU291cmNlcyB8fCBudWxsOwogICAgICAgICAgICB2YXIgaXNTdHJpY3RNb2RlID0gZmFsc2U7CiAgICAgICAgICAgIHZhciBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlID0gZmFsc2U7CiAgICAgICAgICAgIHZhciBpZGVudGlmaWVyUHJlZml4ID0gIiI7CiAgICAgICAgICAgIHZhciBvblJlY292ZXJhYmxlRXJyb3IgPSBkZWZhdWx0T25SZWNvdmVyYWJsZUVycm9yOwogICAgICAgICAgICBpZiAob3B0aW9uczIgIT09IG51bGwgJiYgb3B0aW9uczIgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIGlmIChvcHRpb25zMi51bnN0YWJsZV9zdHJpY3RNb2RlID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBpc1N0cmljdE1vZGUgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAob3B0aW9uczIuaWRlbnRpZmllclByZWZpeCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBpZGVudGlmaWVyUHJlZml4ID0gb3B0aW9uczIuaWRlbnRpZmllclByZWZpeDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG9wdGlvbnMyLm9uUmVjb3ZlcmFibGVFcnJvciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBvblJlY292ZXJhYmxlRXJyb3IgPSBvcHRpb25zMi5vblJlY292ZXJhYmxlRXJyb3I7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGNyZWF0ZUh5ZHJhdGlvbkNvbnRhaW5lcihpbml0aWFsQ2hpbGRyZW4sIG51bGwsIGNvbnRhaW5lciwgQ29uY3VycmVudFJvb3QsIGh5ZHJhdGlvbkNhbGxiYWNrcywgaXNTdHJpY3RNb2RlLCBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgICBtYXJrQ29udGFpbmVyQXNSb290KHJvb3QzLmN1cnJlbnQsIGNvbnRhaW5lcik7CiAgICAgICAgICAgIGxpc3RlblRvQWxsU3VwcG9ydGVkRXZlbnRzKGNvbnRhaW5lcik7CiAgICAgICAgICAgIGlmIChtdXRhYmxlU291cmNlcykgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbXV0YWJsZVNvdXJjZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBtdXRhYmxlU291cmNlID0gbXV0YWJsZVNvdXJjZXNbaV07CiAgICAgICAgICAgICAgICByZWdpc3Rlck11dGFibGVTb3VyY2VGb3JIeWRyYXRpb24ocm9vdDMsIG11dGFibGVTb3VyY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV3IFJlYWN0RE9NSHlkcmF0aW9uUm9vdChyb290Myk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpc1ZhbGlkQ29udGFpbmVyKG5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuICEhKG5vZGUgJiYgKG5vZGUubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSB8fCBub2RlLm5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFIHx8IG5vZGUubm9kZVR5cGUgPT09IERPQ1VNRU5UX0ZSQUdNRU5UX05PREUgfHwgIWRpc2FibGVDb21tZW50c0FzRE9NQ29udGFpbmVycykpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaXNWYWxpZENvbnRhaW5lckxlZ2FjeShub2RlKSB7CiAgICAgICAgICAgIHJldHVybiAhIShub2RlICYmIChub2RlLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUgfHwgbm9kZS5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSB8fCBub2RlLm5vZGVUeXBlID09PSBET0NVTUVOVF9GUkFHTUVOVF9OT0RFIHx8IG5vZGUubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSAmJiBub2RlLm5vZGVWYWx1ZSA9PT0gIiByZWFjdC1tb3VudC1wb2ludC11bnN0YWJsZSAiKSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB3YXJuSWZSZWFjdERPTUNvbnRhaW5lckluREVWKGNvbnRhaW5lcikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGNvbnRhaW5lci5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFICYmIGNvbnRhaW5lci50YWdOYW1lICYmIGNvbnRhaW5lci50YWdOYW1lLnRvVXBwZXJDYXNlKCkgPT09ICJCT0RZIikgewogICAgICAgICAgICAgICAgZXJyb3IoImNyZWF0ZVJvb3QoKTogQ3JlYXRpbmcgcm9vdHMgZGlyZWN0bHkgd2l0aCBkb2N1bWVudC5ib2R5IGlzIGRpc2NvdXJhZ2VkLCBzaW5jZSBpdHMgY2hpbGRyZW4gYXJlIG9mdGVuIG1hbmlwdWxhdGVkIGJ5IHRoaXJkLXBhcnR5IHNjcmlwdHMgYW5kIGJyb3dzZXIgZXh0ZW5zaW9ucy4gVGhpcyBtYXkgbGVhZCB0byBzdWJ0bGUgcmVjb25jaWxpYXRpb24gaXNzdWVzLiBUcnkgdXNpbmcgYSBjb250YWluZXIgZWxlbWVudCBjcmVhdGVkIGZvciB5b3VyIGFwcC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGlzQ29udGFpbmVyTWFya2VkQXNSb290KGNvbnRhaW5lcikpIHsKICAgICAgICAgICAgICAgIGlmIChjb250YWluZXIuX3JlYWN0Um9vdENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICBlcnJvcigiWW91IGFyZSBjYWxsaW5nIFJlYWN0RE9NQ2xpZW50LmNyZWF0ZVJvb3QoKSBvbiBhIGNvbnRhaW5lciB0aGF0IHdhcyBwcmV2aW91c2x5IHBhc3NlZCB0byBSZWFjdERPTS5yZW5kZXIoKS4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkLiIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIllvdSBhcmUgY2FsbGluZyBSZWFjdERPTUNsaWVudC5jcmVhdGVSb290KCkgb24gYSBjb250YWluZXIgdGhhdCBoYXMgYWxyZWFkeSBiZWVuIHBhc3NlZCB0byBjcmVhdGVSb290KCkgYmVmb3JlLiBJbnN0ZWFkLCBjYWxsIHJvb3QucmVuZGVyKCkgb24gdGhlIGV4aXN0aW5nIHJvb3QgaW5zdGVhZCBpZiB5b3Ugd2FudCB0byB1cGRhdGUgaXQuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIkMyA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudE93bmVyOwogICAgICAgICAgdmFyIHRvcExldmVsVXBkYXRlV2FybmluZ3M7CiAgICAgICAgICB7CiAgICAgICAgICAgIHRvcExldmVsVXBkYXRlV2FybmluZ3MgPSBmdW5jdGlvbihjb250YWluZXIpIHsKICAgICAgICAgICAgICBpZiAoY29udGFpbmVyLl9yZWFjdFJvb3RDb250YWluZXIgJiYgY29udGFpbmVyLm5vZGVUeXBlICE9PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgICAgIHZhciBob3N0SW5zdGFuY2UgPSBmaW5kSG9zdEluc3RhbmNlV2l0aE5vUG9ydGFscyhjb250YWluZXIuX3JlYWN0Um9vdENvbnRhaW5lci5jdXJyZW50KTsKICAgICAgICAgICAgICAgIGlmIChob3N0SW5zdGFuY2UpIHsKICAgICAgICAgICAgICAgICAgaWYgKGhvc3RJbnN0YW5jZS5wYXJlbnROb2RlICE9PSBjb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICBlcnJvcigicmVuZGVyKC4uLik6IEl0IGxvb2tzIGxpa2UgdGhlIFJlYWN0LXJlbmRlcmVkIGNvbnRlbnQgb2YgdGhpcyBjb250YWluZXIgd2FzIHJlbW92ZWQgd2l0aG91dCB1c2luZyBSZWFjdC4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkIGFuZCB3aWxsIGNhdXNlIGVycm9ycy4gSW5zdGVhZCwgY2FsbCBSZWFjdERPTS51bm1vdW50Q29tcG9uZW50QXROb2RlIHRvIGVtcHR5IGEgY29udGFpbmVyLiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBpc1Jvb3RSZW5kZXJlZEJ5U29tZVJlYWN0ID0gISFjb250YWluZXIuX3JlYWN0Um9vdENvbnRhaW5lcjsKICAgICAgICAgICAgICB2YXIgcm9vdEVsID0gZ2V0UmVhY3RSb290RWxlbWVudEluQ29udGFpbmVyKGNvbnRhaW5lcik7CiAgICAgICAgICAgICAgdmFyIGhhc05vblJvb3RSZWFjdENoaWxkID0gISEocm9vdEVsICYmIGdldEluc3RhbmNlRnJvbU5vZGUocm9vdEVsKSk7CiAgICAgICAgICAgICAgaWYgKGhhc05vblJvb3RSZWFjdENoaWxkICYmICFpc1Jvb3RSZW5kZXJlZEJ5U29tZVJlYWN0KSB7CiAgICAgICAgICAgICAgICBlcnJvcigicmVuZGVyKC4uLik6IFJlcGxhY2luZyBSZWFjdC1yZW5kZXJlZCBjaGlsZHJlbiB3aXRoIGEgbmV3IHJvb3QgY29tcG9uZW50LiBJZiB5b3UgaW50ZW5kZWQgdG8gdXBkYXRlIHRoZSBjaGlsZHJlbiBvZiB0aGlzIG5vZGUsIHlvdSBzaG91bGQgaW5zdGVhZCBoYXZlIHRoZSBleGlzdGluZyBjaGlsZHJlbiB1cGRhdGUgdGhlaXIgc3RhdGUgYW5kIHJlbmRlciB0aGUgbmV3IGNvbXBvbmVudHMgaW5zdGVhZCBvZiBjYWxsaW5nIFJlYWN0RE9NLnJlbmRlci4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGNvbnRhaW5lci5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFICYmIGNvbnRhaW5lci50YWdOYW1lICYmIGNvbnRhaW5lci50YWdOYW1lLnRvVXBwZXJDYXNlKCkgPT09ICJCT0RZIikgewogICAgICAgICAgICAgICAgZXJyb3IoInJlbmRlcigpOiBSZW5kZXJpbmcgY29tcG9uZW50cyBkaXJlY3RseSBpbnRvIGRvY3VtZW50LmJvZHkgaXMgZGlzY291cmFnZWQsIHNpbmNlIGl0cyBjaGlsZHJlbiBhcmUgb2Z0ZW4gbWFuaXB1bGF0ZWQgYnkgdGhpcmQtcGFydHkgc2NyaXB0cyBhbmQgYnJvd3NlciBleHRlbnNpb25zLiBUaGlzIG1heSBsZWFkIHRvIHN1YnRsZSByZWNvbmNpbGlhdGlvbiBpc3N1ZXMuIFRyeSByZW5kZXJpbmcgaW50byBhIGNvbnRhaW5lciBlbGVtZW50IGNyZWF0ZWQgZm9yIHlvdXIgYXBwLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldFJlYWN0Um9vdEVsZW1lbnRJbkNvbnRhaW5lcihjb250YWluZXIpIHsKICAgICAgICAgICAgaWYgKCFjb250YWluZXIpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29udGFpbmVyLm5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lci5kb2N1bWVudEVsZW1lbnQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lci5maXJzdENoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBub29wT25SZWNvdmVyYWJsZUVycm9yKCkgewogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbGVnYWN5Q3JlYXRlUm9vdEZyb21ET01Db250YWluZXIoY29udGFpbmVyLCBpbml0aWFsQ2hpbGRyZW4sIHBhcmVudENvbXBvbmVudCwgY2FsbGJhY2ssIGlzSHlkcmF0aW9uQ29udGFpbmVyKSB7CiAgICAgICAgICAgIGlmIChpc0h5ZHJhdGlvbkNvbnRhaW5lcikgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHZhciBvcmlnaW5hbENhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBnZXRQdWJsaWNSb290SW5zdGFuY2Uocm9vdDMpOwogICAgICAgICAgICAgICAgICBvcmlnaW5hbENhbGxiYWNrLmNhbGwoaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gY3JlYXRlSHlkcmF0aW9uQ29udGFpbmVyKAogICAgICAgICAgICAgICAgaW5pdGlhbENoaWxkcmVuLAogICAgICAgICAgICAgICAgY2FsbGJhY2ssCiAgICAgICAgICAgICAgICBjb250YWluZXIsCiAgICAgICAgICAgICAgICBMZWdhY3lSb290LAogICAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAgIC8vIGh5ZHJhdGlvbkNhbGxiYWNrcwogICAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgICAvLyBpc1N0cmljdE1vZGUKICAgICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgICAgLy8gY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwKICAgICAgICAgICAgICAgICIiLAogICAgICAgICAgICAgICAgLy8gaWRlbnRpZmllclByZWZpeAogICAgICAgICAgICAgICAgbm9vcE9uUmVjb3ZlcmFibGVFcnJvcgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgY29udGFpbmVyLl9yZWFjdFJvb3RDb250YWluZXIgPSByb290MzsKICAgICAgICAgICAgICBtYXJrQ29udGFpbmVyQXNSb290KHJvb3QzLmN1cnJlbnQsIGNvbnRhaW5lcik7CiAgICAgICAgICAgICAgdmFyIHJvb3RDb250YWluZXJFbGVtZW50ID0gY29udGFpbmVyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUgPyBjb250YWluZXIucGFyZW50Tm9kZSA6IGNvbnRhaW5lcjsKICAgICAgICAgICAgICBsaXN0ZW5Ub0FsbFN1cHBvcnRlZEV2ZW50cyhyb290Q29udGFpbmVyRWxlbWVudCk7CiAgICAgICAgICAgICAgZmx1c2hTeW5jKCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJvb3QzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciByb290U2libGluZzsKICAgICAgICAgICAgICB3aGlsZSAocm9vdFNpYmxpbmcgPSBjb250YWluZXIubGFzdENoaWxkKSB7CiAgICAgICAgICAgICAgICBjb250YWluZXIucmVtb3ZlQ2hpbGQocm9vdFNpYmxpbmcpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB2YXIgX29yaWdpbmFsQ2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGdldFB1YmxpY1Jvb3RJbnN0YW5jZShfcm9vdCk7CiAgICAgICAgICAgICAgICAgIF9vcmlnaW5hbENhbGxiYWNrLmNhbGwoaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIF9yb290ID0gY3JlYXRlQ29udGFpbmVyKAogICAgICAgICAgICAgICAgY29udGFpbmVyLAogICAgICAgICAgICAgICAgTGVnYWN5Um9vdCwKICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICAvLyBoeWRyYXRpb25DYWxsYmFja3MKICAgICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgICAgLy8gaXNTdHJpY3RNb2RlCiAgICAgICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgICAgIC8vIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsCiAgICAgICAgICAgICAgICAiIiwKICAgICAgICAgICAgICAgIC8vIGlkZW50aWZpZXJQcmVmaXgKICAgICAgICAgICAgICAgIG5vb3BPblJlY292ZXJhYmxlRXJyb3IKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGNvbnRhaW5lci5fcmVhY3RSb290Q29udGFpbmVyID0gX3Jvb3Q7CiAgICAgICAgICAgICAgbWFya0NvbnRhaW5lckFzUm9vdChfcm9vdC5jdXJyZW50LCBjb250YWluZXIpOwogICAgICAgICAgICAgIHZhciBfcm9vdENvbnRhaW5lckVsZW1lbnQgPSBjb250YWluZXIubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSA/IGNvbnRhaW5lci5wYXJlbnROb2RlIDogY29udGFpbmVyOwogICAgICAgICAgICAgIGxpc3RlblRvQWxsU3VwcG9ydGVkRXZlbnRzKF9yb290Q29udGFpbmVyRWxlbWVudCk7CiAgICAgICAgICAgICAgZmx1c2hTeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdXBkYXRlQ29udGFpbmVyKGluaXRpYWxDaGlsZHJlbiwgX3Jvb3QsIHBhcmVudENvbXBvbmVudCwgY2FsbGJhY2spOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHJldHVybiBfcm9vdDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gd2Fybk9uSW52YWxpZENhbGxiYWNrJDEoY2FsbGJhY2ssIGNhbGxlck5hbWUpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gbnVsbCAmJiB0eXBlb2YgY2FsbGJhY2sgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyguLi4pOiBFeHBlY3RlZCB0aGUgbGFzdCBvcHRpb25hbCBgY2FsbGJhY2tgIGFyZ3VtZW50IHRvIGJlIGEgZnVuY3Rpb24uIEluc3RlYWQgcmVjZWl2ZWQ6ICVzLiIsIGNhbGxlck5hbWUsIGNhbGxiYWNrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGxlZ2FjeVJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKHBhcmVudENvbXBvbmVudCwgY2hpbGRyZW4yLCBjb250YWluZXIsIGZvcmNlSHlkcmF0ZSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHRvcExldmVsVXBkYXRlV2FybmluZ3MoY29udGFpbmVyKTsKICAgICAgICAgICAgICB3YXJuT25JbnZhbGlkQ2FsbGJhY2skMShjYWxsYmFjayA9PT0gdm9pZCAwID8gbnVsbCA6IGNhbGxiYWNrLCAicmVuZGVyIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG1heWJlUm9vdCA9IGNvbnRhaW5lci5fcmVhY3RSb290Q29udGFpbmVyOwogICAgICAgICAgICB2YXIgcm9vdDM7CiAgICAgICAgICAgIGlmICghbWF5YmVSb290KSB7CiAgICAgICAgICAgICAgcm9vdDMgPSBsZWdhY3lDcmVhdGVSb290RnJvbURPTUNvbnRhaW5lcihjb250YWluZXIsIGNoaWxkcmVuMiwgcGFyZW50Q29tcG9uZW50LCBjYWxsYmFjaywgZm9yY2VIeWRyYXRlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByb290MyA9IG1heWJlUm9vdDsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxDYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZ2V0UHVibGljUm9vdEluc3RhbmNlKHJvb3QzKTsKICAgICAgICAgICAgICAgICAgb3JpZ2luYWxDYWxsYmFjay5jYWxsKGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVwZGF0ZUNvbnRhaW5lcihjaGlsZHJlbjIsIHJvb3QzLCBwYXJlbnRDb21wb25lbnQsIGNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZ2V0UHVibGljUm9vdEluc3RhbmNlKHJvb3QzKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGZpbmRET01Ob2RlKGNvbXBvbmVudE9yRWxlbWVudCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIG93bmVyID0gUmVhY3RDdXJyZW50T3duZXIkMy5jdXJyZW50OwogICAgICAgICAgICAgIGlmIChvd25lciAhPT0gbnVsbCAmJiBvd25lci5zdGF0ZU5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciB3YXJuZWRBYm91dFJlZnNJblJlbmRlciA9IG93bmVyLnN0YXRlTm9kZS5fd2FybmVkQWJvdXRSZWZzSW5SZW5kZXI7CiAgICAgICAgICAgICAgICBpZiAoIXdhcm5lZEFib3V0UmVmc0luUmVuZGVyKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCIlcyBpcyBhY2Nlc3NpbmcgZmluZERPTU5vZGUgaW5zaWRlIGl0cyByZW5kZXIoKS4gcmVuZGVyKCkgc2hvdWxkIGJlIGEgcHVyZSBmdW5jdGlvbiBvZiBwcm9wcyBhbmQgc3RhdGUuIEl0IHNob3VsZCBuZXZlciBhY2Nlc3Mgc29tZXRoaW5nIHRoYXQgcmVxdWlyZXMgc3RhbGUgZGF0YSBmcm9tIHRoZSBwcmV2aW91cyByZW5kZXIsIHN1Y2ggYXMgcmVmcy4gTW92ZSB0aGlzIGxvZ2ljIHRvIGNvbXBvbmVudERpZE1vdW50IGFuZCBjb21wb25lbnREaWRVcGRhdGUgaW5zdGVhZC4iLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUob3duZXIudHlwZSkgfHwgIkEgY29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBvd25lci5zdGF0ZU5vZGUuX3dhcm5lZEFib3V0UmVmc0luUmVuZGVyID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNvbXBvbmVudE9yRWxlbWVudCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNvbXBvbmVudE9yRWxlbWVudC5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGNvbXBvbmVudE9yRWxlbWVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgcmV0dXJuIGZpbmRIb3N0SW5zdGFuY2VXaXRoV2FybmluZyhjb21wb25lbnRPckVsZW1lbnQsICJmaW5kRE9NTm9kZSIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBoeWRyYXRlKGVsZW1lbnQsIGNvbnRhaW5lciwgY2FsbGJhY2spIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCJSZWFjdERPTS5oeWRyYXRlIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQgaW4gUmVhY3QgMTguIFVzZSBoeWRyYXRlUm9vdCBpbnN0ZWFkLiBVbnRpbCB5b3Ugc3dpdGNoIHRvIHRoZSBuZXcgQVBJLCB5b3VyIGFwcCB3aWxsIGJlaGF2ZSBhcyBpZiBpdCdzIHJ1bm5pbmcgUmVhY3QgMTcuIExlYXJuIG1vcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zd2l0Y2gtdG8tY3JlYXRlcm9vdCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghaXNWYWxpZENvbnRhaW5lckxlZ2FjeShjb250YWluZXIpKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgaXNNb2Rlcm5Sb290ID0gaXNDb250YWluZXJNYXJrZWRBc1Jvb3QoY29udGFpbmVyKSAmJiBjb250YWluZXIuX3JlYWN0Um9vdENvbnRhaW5lciA9PT0gdm9pZCAwOwogICAgICAgICAgICAgIGlmIChpc01vZGVyblJvb3QpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJZb3UgYXJlIGNhbGxpbmcgUmVhY3RET00uaHlkcmF0ZSgpIG9uIGEgY29udGFpbmVyIHRoYXQgd2FzIHByZXZpb3VzbHkgcGFzc2VkIHRvIFJlYWN0RE9NQ2xpZW50LmNyZWF0ZVJvb3QoKS4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkLiBEaWQgeW91IG1lYW4gdG8gY2FsbCBoeWRyYXRlUm9vdChjb250YWluZXIsIGVsZW1lbnQpPyIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbGVnYWN5UmVuZGVyU3VidHJlZUludG9Db250YWluZXIobnVsbCwgZWxlbWVudCwgY29udGFpbmVyLCB0cnVlLCBjYWxsYmFjayk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZW5kZXIoZWxlbWVudCwgY29udGFpbmVyLCBjYWxsYmFjaykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0RE9NLnJlbmRlciBpcyBubyBsb25nZXIgc3VwcG9ydGVkIGluIFJlYWN0IDE4LiBVc2UgY3JlYXRlUm9vdCBpbnN0ZWFkLiBVbnRpbCB5b3Ugc3dpdGNoIHRvIHRoZSBuZXcgQVBJLCB5b3VyIGFwcCB3aWxsIGJlaGF2ZSBhcyBpZiBpdCdzIHJ1bm5pbmcgUmVhY3QgMTcuIExlYXJuIG1vcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zd2l0Y2gtdG8tY3JlYXRlcm9vdCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghaXNWYWxpZENvbnRhaW5lckxlZ2FjeShjb250YWluZXIpKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgaXNNb2Rlcm5Sb290ID0gaXNDb250YWluZXJNYXJrZWRBc1Jvb3QoY29udGFpbmVyKSAmJiBjb250YWluZXIuX3JlYWN0Um9vdENvbnRhaW5lciA9PT0gdm9pZCAwOwogICAgICAgICAgICAgIGlmIChpc01vZGVyblJvb3QpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJZb3UgYXJlIGNhbGxpbmcgUmVhY3RET00ucmVuZGVyKCkgb24gYSBjb250YWluZXIgdGhhdCB3YXMgcHJldmlvdXNseSBwYXNzZWQgdG8gUmVhY3RET01DbGllbnQuY3JlYXRlUm9vdCgpLiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQuIERpZCB5b3UgbWVhbiB0byBjYWxsIHJvb3QucmVuZGVyKGVsZW1lbnQpPyIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbGVnYWN5UmVuZGVyU3VidHJlZUludG9Db250YWluZXIobnVsbCwgZWxlbWVudCwgY29udGFpbmVyLCBmYWxzZSwgY2FsbGJhY2spOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfcmVuZGVyU3VidHJlZUludG9Db250YWluZXIocGFyZW50Q29tcG9uZW50LCBlbGVtZW50LCBjb250YWluZXJOb2RlLCBjYWxsYmFjaykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0RE9NLnVuc3RhYmxlX3JlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKCkgaXMgbm8gbG9uZ2VyIHN1cHBvcnRlZCBpbiBSZWFjdCAxOC4gQ29uc2lkZXIgdXNpbmcgYSBwb3J0YWwgaW5zdGVhZC4gVW50aWwgeW91IHN3aXRjaCB0byB0aGUgY3JlYXRlUm9vdCBBUEksIHlvdXIgYXBwIHdpbGwgYmVoYXZlIGFzIGlmIGl0J3MgcnVubmluZyBSZWFjdCAxNy4gTGVhcm4gbW9yZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N3aXRjaC10by1jcmVhdGVyb290Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFpc1ZhbGlkQ29udGFpbmVyTGVnYWN5KGNvbnRhaW5lck5vZGUpKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwYXJlbnRDb21wb25lbnQgPT0gbnVsbCB8fCAhaGFzKHBhcmVudENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInBhcmVudENvbXBvbmVudCBtdXN0IGJlIGEgdmFsaWQgUmVhY3QgQ29tcG9uZW50Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlZ2FjeVJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKHBhcmVudENvbXBvbmVudCwgZWxlbWVudCwgY29udGFpbmVyTm9kZSwgZmFsc2UsIGNhbGxiYWNrKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVubW91bnRDb21wb25lbnRBdE5vZGUoY29udGFpbmVyKSB7CiAgICAgICAgICAgIGlmICghaXNWYWxpZENvbnRhaW5lckxlZ2FjeShjb250YWluZXIpKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJ1bm1vdW50Q29tcG9uZW50QXROb2RlKC4uLik6IFRhcmdldCBjb250YWluZXIgaXMgbm90IGEgRE9NIGVsZW1lbnQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBpc01vZGVyblJvb3QgPSBpc0NvbnRhaW5lck1hcmtlZEFzUm9vdChjb250YWluZXIpICYmIGNvbnRhaW5lci5fcmVhY3RSb290Q29udGFpbmVyID09PSB2b2lkIDA7CiAgICAgICAgICAgICAgaWYgKGlzTW9kZXJuUm9vdCkgewogICAgICAgICAgICAgICAgZXJyb3IoIllvdSBhcmUgY2FsbGluZyBSZWFjdERPTS51bm1vdW50Q29tcG9uZW50QXROb2RlKCkgb24gYSBjb250YWluZXIgdGhhdCB3YXMgcHJldmlvdXNseSBwYXNzZWQgdG8gUmVhY3RET01DbGllbnQuY3JlYXRlUm9vdCgpLiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQuIERpZCB5b3UgbWVhbiB0byBjYWxsIHJvb3QudW5tb3VudCgpPyIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29udGFpbmVyLl9yZWFjdFJvb3RDb250YWluZXIpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgcm9vdEVsID0gZ2V0UmVhY3RSb290RWxlbWVudEluQ29udGFpbmVyKGNvbnRhaW5lcik7CiAgICAgICAgICAgICAgICB2YXIgcmVuZGVyZWRCeURpZmZlcmVudFJlYWN0ID0gcm9vdEVsICYmICFnZXRJbnN0YW5jZUZyb21Ob2RlKHJvb3RFbCk7CiAgICAgICAgICAgICAgICBpZiAocmVuZGVyZWRCeURpZmZlcmVudFJlYWN0KSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJ1bm1vdW50Q29tcG9uZW50QXROb2RlKCk6IFRoZSBub2RlIHlvdSdyZSBhdHRlbXB0aW5nIHRvIHVubW91bnQgd2FzIHJlbmRlcmVkIGJ5IGFub3RoZXIgY29weSBvZiBSZWFjdC4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZmx1c2hTeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgbGVnYWN5UmVuZGVyU3VidHJlZUludG9Db250YWluZXIobnVsbCwgbnVsbCwgY29udGFpbmVyLCBmYWxzZSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci5fcmVhY3RSb290Q29udGFpbmVyID0gbnVsbDsKICAgICAgICAgICAgICAgICAgdW5tYXJrQ29udGFpbmVyQXNSb290KGNvbnRhaW5lcik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgX3Jvb3RFbCA9IGdldFJlYWN0Um9vdEVsZW1lbnRJbkNvbnRhaW5lcihjb250YWluZXIpOwogICAgICAgICAgICAgICAgdmFyIGhhc05vblJvb3RSZWFjdENoaWxkID0gISEoX3Jvb3RFbCAmJiBnZXRJbnN0YW5jZUZyb21Ob2RlKF9yb290RWwpKTsKICAgICAgICAgICAgICAgIHZhciBpc0NvbnRhaW5lclJlYWN0Um9vdCA9IGNvbnRhaW5lci5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFICYmIGlzVmFsaWRDb250YWluZXJMZWdhY3koY29udGFpbmVyLnBhcmVudE5vZGUpICYmICEhY29udGFpbmVyLnBhcmVudE5vZGUuX3JlYWN0Um9vdENvbnRhaW5lcjsKICAgICAgICAgICAgICAgIGlmIChoYXNOb25Sb290UmVhY3RDaGlsZCkgewogICAgICAgICAgICAgICAgICBlcnJvcigidW5tb3VudENvbXBvbmVudEF0Tm9kZSgpOiBUaGUgbm9kZSB5b3UncmUgYXR0ZW1wdGluZyB0byB1bm1vdW50IHdhcyByZW5kZXJlZCBieSBSZWFjdCBhbmQgaXMgbm90IGEgdG9wLWxldmVsIGNvbnRhaW5lci4gJXMiLCBpc0NvbnRhaW5lclJlYWN0Um9vdCA/ICJZb3UgbWF5IGhhdmUgYWNjaWRlbnRhbGx5IHBhc3NlZCBpbiBhIFJlYWN0IHJvb3Qgbm9kZSBpbnN0ZWFkIG9mIGl0cyBjb250YWluZXIuIiA6ICJJbnN0ZWFkLCBoYXZlIHRoZSBwYXJlbnQgY29tcG9uZW50IHVwZGF0ZSBpdHMgc3RhdGUgYW5kIHJlcmVuZGVyIGluIG9yZGVyIHRvIHJlbW92ZSB0aGlzIGNvbXBvbmVudC4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBzZXRBdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24oYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uJDEpOwogICAgICAgICAgc2V0QXR0ZW1wdENvbnRpbnVvdXNIeWRyYXRpb24oYXR0ZW1wdENvbnRpbnVvdXNIeWRyYXRpb24kMSk7CiAgICAgICAgICBzZXRBdHRlbXB0SHlkcmF0aW9uQXRDdXJyZW50UHJpb3JpdHkoYXR0ZW1wdEh5ZHJhdGlvbkF0Q3VycmVudFByaW9yaXR5JDEpOwogICAgICAgICAgc2V0R2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSk7CiAgICAgICAgICBzZXRBdHRlbXB0SHlkcmF0aW9uQXRQcmlvcml0eShydW5XaXRoUHJpb3JpdHkpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIE1hcCAhPT0gImZ1bmN0aW9uIiB8fCAvLyAkRmxvd0lzc3VlIEZsb3cgaW5jb3JyZWN0bHkgdGhpbmtzIE1hcCBoYXMgbm8gcHJvdG90eXBlCiAgICAgICAgICAgIE1hcC5wcm90b3R5cGUgPT0gbnVsbCB8fCB0eXBlb2YgTWFwLnByb3RvdHlwZS5mb3JFYWNoICE9PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBTZXQgIT09ICJmdW5jdGlvbiIgfHwgLy8gJEZsb3dJc3N1ZSBGbG93IGluY29ycmVjdGx5IHRoaW5rcyBTZXQgaGFzIG5vIHByb3RvdHlwZQogICAgICAgICAgICBTZXQucHJvdG90eXBlID09IG51bGwgfHwgdHlwZW9mIFNldC5wcm90b3R5cGUuY2xlYXIgIT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIFNldC5wcm90b3R5cGUuZm9yRWFjaCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBkZXBlbmRzIG9uIE1hcCBhbmQgU2V0IGJ1aWx0LWluIHR5cGVzLiBNYWtlIHN1cmUgdGhhdCB5b3UgbG9hZCBhIHBvbHlmaWxsIGluIG9sZGVyIGJyb3dzZXJzLiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcmVhY3QtcG9seWZpbGxzIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHNldFJlc3RvcmVJbXBsZW1lbnRhdGlvbihyZXN0b3JlQ29udHJvbGxlZFN0YXRlJDMpOwogICAgICAgICAgc2V0QmF0Y2hpbmdJbXBsZW1lbnRhdGlvbihiYXRjaGVkVXBkYXRlcyQxLCBkaXNjcmV0ZVVwZGF0ZXMsIGZsdXNoU3luYyk7CiAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVQb3J0YWwkMShjaGlsZHJlbjIsIGNvbnRhaW5lcikgewogICAgICAgICAgICB2YXIga2V5ID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMl0gOiBudWxsOwogICAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXIoY29udGFpbmVyKSkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGFyZ2V0IGNvbnRhaW5lciBpcyBub3QgYSBET00gZWxlbWVudC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY3JlYXRlUG9ydGFsKGNoaWxkcmVuMiwgY29udGFpbmVyLCBudWxsLCBrZXkpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVuZGVyU3VidHJlZUludG9Db250YWluZXIocGFyZW50Q29tcG9uZW50LCBlbGVtZW50LCBjb250YWluZXJOb2RlLCBjYWxsYmFjaykgewogICAgICAgICAgICByZXR1cm4gdW5zdGFibGVfcmVuZGVyU3VidHJlZUludG9Db250YWluZXIocGFyZW50Q29tcG9uZW50LCBlbGVtZW50LCBjb250YWluZXJOb2RlLCBjYWxsYmFjayk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgSW50ZXJuYWxzID0gewogICAgICAgICAgICB1c2luZ0NsaWVudEVudHJ5UG9pbnQ6IGZhbHNlLAogICAgICAgICAgICAvLyBLZWVwIGluIHN5bmMgd2l0aCBSZWFjdFRlc3RVdGlscy5qcy4KICAgICAgICAgICAgLy8gVGhpcyBpcyBhbiBhcnJheSBmb3IgYmV0dGVyIG1pbmlmaWNhdGlvbi4KICAgICAgICAgICAgRXZlbnRzOiBbZ2V0SW5zdGFuY2VGcm9tTm9kZSwgZ2V0Tm9kZUZyb21JbnN0YW5jZSwgZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZSwgZW5xdWV1ZVN0YXRlUmVzdG9yZSwgcmVzdG9yZVN0YXRlSWZOZWVkZWQsIGJhdGNoZWRVcGRhdGVzJDFdCiAgICAgICAgICB9OwogICAgICAgICAgZnVuY3Rpb24gY3JlYXRlUm9vdCQxKGNvbnRhaW5lciwgb3B0aW9uczIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghSW50ZXJuYWxzLnVzaW5nQ2xpZW50RW50cnlQb2ludCAmJiB0cnVlKSB7CiAgICAgICAgICAgICAgICBlcnJvcignWW91IGFyZSBpbXBvcnRpbmcgY3JlYXRlUm9vdCBmcm9tICJyZWFjdC1kb20iIHdoaWNoIGlzIG5vdCBzdXBwb3J0ZWQuIFlvdSBzaG91bGQgaW5zdGVhZCBpbXBvcnQgaXQgZnJvbSAicmVhY3QtZG9tL2NsaWVudCIuJyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjcmVhdGVSb290KGNvbnRhaW5lciwgb3B0aW9uczIpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaHlkcmF0ZVJvb3QkMShjb250YWluZXIsIGluaXRpYWxDaGlsZHJlbiwgb3B0aW9uczIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghSW50ZXJuYWxzLnVzaW5nQ2xpZW50RW50cnlQb2ludCAmJiB0cnVlKSB7CiAgICAgICAgICAgICAgICBlcnJvcignWW91IGFyZSBpbXBvcnRpbmcgaHlkcmF0ZVJvb3QgZnJvbSAicmVhY3QtZG9tIiB3aGljaCBpcyBub3Qgc3VwcG9ydGVkLiBZb3Ugc2hvdWxkIGluc3RlYWQgaW1wb3J0IGl0IGZyb20gInJlYWN0LWRvbS9jbGllbnQiLicpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaHlkcmF0ZVJvb3QoY29udGFpbmVyLCBpbml0aWFsQ2hpbGRyZW4sIG9wdGlvbnMyKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGZsdXNoU3luYyQxKGZuKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaXNBbHJlYWR5UmVuZGVyaW5nKCkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJmbHVzaFN5bmMgd2FzIGNhbGxlZCBmcm9tIGluc2lkZSBhIGxpZmVjeWNsZSBtZXRob2QuIFJlYWN0IGNhbm5vdCBmbHVzaCB3aGVuIFJlYWN0IGlzIGFscmVhZHkgcmVuZGVyaW5nLiBDb25zaWRlciBtb3ZpbmcgdGhpcyBjYWxsIHRvIGEgc2NoZWR1bGVyIHRhc2sgb3IgbWljcm8gdGFzay4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZsdXNoU3luYyhmbik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZm91bmREZXZUb29scyA9IGluamVjdEludG9EZXZUb29scyh7CiAgICAgICAgICAgIGZpbmRGaWJlckJ5SG9zdEluc3RhbmNlOiBnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZSwKICAgICAgICAgICAgYnVuZGxlVHlwZTogMSwKICAgICAgICAgICAgdmVyc2lvbjogUmVhY3RWZXJzaW9uLAogICAgICAgICAgICByZW5kZXJlclBhY2thZ2VOYW1lOiAicmVhY3QtZG9tIgogICAgICAgICAgfSk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghZm91bmREZXZUb29scyAmJiBjYW5Vc2VET00gJiYgd2luZG93LnRvcCA9PT0gd2luZG93LnNlbGYpIHsKICAgICAgICAgICAgICBpZiAobmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCJDaHJvbWUiKSA+IC0xICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZigiRWRnZSIpID09PSAtMSB8fCBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoIkZpcmVmb3giKSA+IC0xKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJvdG9jb2wgPSB3aW5kb3cubG9jYXRpb24ucHJvdG9jb2w7CiAgICAgICAgICAgICAgICBpZiAoL14oaHR0cHM/fGZpbGUpOiQvLnRlc3QocHJvdG9jb2wpKSB7CiAgICAgICAgICAgICAgICAgIGNvbnNvbGUuaW5mbygiJWNEb3dubG9hZCB0aGUgUmVhY3QgRGV2VG9vbHMgZm9yIGEgYmV0dGVyIGRldmVsb3BtZW50IGV4cGVyaWVuY2U6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9yZWFjdC1kZXZ0b29scyIgKyAocHJvdG9jb2wgPT09ICJmaWxlOiIgPyAiXG5Zb3UgbWlnaHQgbmVlZCB0byB1c2UgYSBsb2NhbCBIVFRQIHNlcnZlciAoaW5zdGVhZCBvZiBmaWxlOi8vKTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3JlYWN0LWRldnRvb2xzLWZhcSIgOiAiIiksICJmb250LXdlaWdodDpib2xkIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBleHBvcnRzLl9fU0VDUkVUX0lOVEVSTkFMU19ET19OT1RfVVNFX09SX1lPVV9XSUxMX0JFX0ZJUkVEID0gSW50ZXJuYWxzOwogICAgICAgICAgZXhwb3J0cy5jcmVhdGVQb3J0YWwgPSBjcmVhdGVQb3J0YWwkMTsKICAgICAgICAgIGV4cG9ydHMuY3JlYXRlUm9vdCA9IGNyZWF0ZVJvb3QkMTsKICAgICAgICAgIGV4cG9ydHMuZmluZERPTU5vZGUgPSBmaW5kRE9NTm9kZTsKICAgICAgICAgIGV4cG9ydHMuZmx1c2hTeW5jID0gZmx1c2hTeW5jJDE7CiAgICAgICAgICBleHBvcnRzLmh5ZHJhdGUgPSBoeWRyYXRlOwogICAgICAgICAgZXhwb3J0cy5oeWRyYXRlUm9vdCA9IGh5ZHJhdGVSb290JDE7CiAgICAgICAgICBleHBvcnRzLnJlbmRlciA9IHJlbmRlcjsKICAgICAgICAgIGV4cG9ydHMudW5tb3VudENvbXBvbmVudEF0Tm9kZSA9IHVubW91bnRDb21wb25lbnRBdE5vZGU7CiAgICAgICAgICBleHBvcnRzLnVuc3RhYmxlX2JhdGNoZWRVcGRhdGVzID0gYmF0Y2hlZFVwZGF0ZXMkMTsKICAgICAgICAgIGV4cG9ydHMudW5zdGFibGVfcmVuZGVyU3VidHJlZUludG9Db250YWluZXIgPSByZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcjsKICAgICAgICAgIGV4cG9ydHMudmVyc2lvbiA9IFJlYWN0VmVyc2lvbjsKICAgICAgICAgIGlmICh0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcChuZXcgRXJyb3IoKSk7CiAgICAgICAgICB9CiAgICAgICAgfSkoKTsKICAgICAgfQogICAgfQogIH0pOwoKICAvLyBub2RlX21vZHVsZXMvcmVhY3QtZG9tL2luZGV4LmpzCiAgdmFyIHJlcXVpcmVfcmVhY3RfZG9tID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL3JlYWN0LWRvbS9pbmRleC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgaWYgKGZhbHNlKSB7CiAgICAgICAgY2hlY2tEQ0UoKTsKICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IG51bGw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3JlYWN0X2RvbV9kZXZlbG9wbWVudCgpOwogICAgICB9CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9yZWFjdC1kb20vY2xpZW50LmpzCiAgdmFyIHJlcXVpcmVfY2xpZW50ID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL3JlYWN0LWRvbS9jbGllbnQuanMiKGV4cG9ydHMpIHsKICAgICAgInVzZSBzdHJpY3QiOwogICAgICB2YXIgbTIgPSByZXF1aXJlX3JlYWN0X2RvbSgpOwogICAgICBpZiAoZmFsc2UpIHsKICAgICAgICBleHBvcnRzLmNyZWF0ZVJvb3QgPSBtMi5jcmVhdGVSb290OwogICAgICAgIGV4cG9ydHMuaHlkcmF0ZVJvb3QgPSBtMi5oeWRyYXRlUm9vdDsKICAgICAgfSBlbHNlIHsKICAgICAgICBpID0gbTIuX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQ7CiAgICAgICAgZXhwb3J0cy5jcmVhdGVSb290ID0gZnVuY3Rpb24oYzIsIG8pIHsKICAgICAgICAgIGkudXNpbmdDbGllbnRFbnRyeVBvaW50ID0gdHJ1ZTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBtMi5jcmVhdGVSb290KGMyLCBvKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGkudXNpbmdDbGllbnRFbnRyeVBvaW50ID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBleHBvcnRzLmh5ZHJhdGVSb290ID0gZnVuY3Rpb24oYzIsIGgsIG8pIHsKICAgICAgICAgIGkudXNpbmdDbGllbnRFbnRyeVBvaW50ID0gdHJ1ZTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBtMi5oeWRyYXRlUm9vdChjMiwgaCwgbyk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBpLnVzaW5nQ2xpZW50RW50cnlQb2ludCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0KICAgICAgdmFyIGk7CiAgICB9CiAgfSk7CgogIC8vIHNyYy9wdWJsaWMvbWFpbi50c3gKICB2YXIgaW1wb3J0X3JlYWN0NiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKICB2YXIgaW1wb3J0X2NsaWVudCA9IF9fdG9FU00ocmVxdWlyZV9jbGllbnQoKSk7CgogIC8vIG5vZGVfbW9kdWxlcy91dWlkL2Rpc3QvZXNtLWJyb3dzZXIvcm5nLmpzCiAgdmFyIGdldFJhbmRvbVZhbHVlczsKICB2YXIgcm5kczggPSBuZXcgVWludDhBcnJheSgxNik7CiAgZnVuY3Rpb24gcm5nKCkgewogICAgaWYgKCFnZXRSYW5kb21WYWx1ZXMpIHsKICAgICAgZ2V0UmFuZG9tVmFsdWVzID0gdHlwZW9mIGNyeXB0byAhPT0gInVuZGVmaW5lZCIgJiYgY3J5cHRvLmdldFJhbmRvbVZhbHVlcyAmJiBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzLmJpbmQoY3J5cHRvKTsKICAgICAgaWYgKCFnZXRSYW5kb21WYWx1ZXMpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImNyeXB0by5nZXRSYW5kb21WYWx1ZXMoKSBub3Qgc3VwcG9ydGVkLiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3V1aWRqcy91dWlkI2dldHJhbmRvbXZhbHVlcy1ub3Qtc3VwcG9ydGVkIik7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBnZXRSYW5kb21WYWx1ZXMocm5kczgpOwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL3V1aWQvZGlzdC9lc20tYnJvd3Nlci9zdHJpbmdpZnkuanMKICB2YXIgYnl0ZVRvSGV4ID0gW107CiAgZm9yIChsZXQgaSA9IDA7IGkgPCAyNTY7ICsraSkgewogICAgYnl0ZVRvSGV4LnB1c2goKGkgKyAyNTYpLnRvU3RyaW5nKDE2KS5zbGljZSgxKSk7CiAgfQogIGZ1bmN0aW9uIHVuc2FmZVN0cmluZ2lmeShhcnIsIG9mZnNldCA9IDApIHsKICAgIHJldHVybiAoYnl0ZVRvSGV4W2FycltvZmZzZXQgKyAwXV0gKyBieXRlVG9IZXhbYXJyW29mZnNldCArIDFdXSArIGJ5dGVUb0hleFthcnJbb2Zmc2V0ICsgMl1dICsgYnl0ZVRvSGV4W2FycltvZmZzZXQgKyAzXV0gKyAiLSIgKyBieXRlVG9IZXhbYXJyW29mZnNldCArIDRdXSArIGJ5dGVUb0hleFthcnJbb2Zmc2V0ICsgNV1dICsgIi0iICsgYnl0ZVRvSGV4W2FycltvZmZzZXQgKyA2XV0gKyBieXRlVG9IZXhbYXJyW29mZnNldCArIDddXSArICItIiArIGJ5dGVUb0hleFthcnJbb2Zmc2V0ICsgOF1dICsgYnl0ZVRvSGV4W2FycltvZmZzZXQgKyA5XV0gKyAiLSIgKyBieXRlVG9IZXhbYXJyW29mZnNldCArIDEwXV0gKyBieXRlVG9IZXhbYXJyW29mZnNldCArIDExXV0gKyBieXRlVG9IZXhbYXJyW29mZnNldCArIDEyXV0gKyBieXRlVG9IZXhbYXJyW29mZnNldCArIDEzXV0gKyBieXRlVG9IZXhbYXJyW29mZnNldCArIDE0XV0gKyBieXRlVG9IZXhbYXJyW29mZnNldCArIDE1XV0pLnRvTG93ZXJDYXNlKCk7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvdXVpZC9kaXN0L2VzbS1icm93c2VyL25hdGl2ZS5qcwogIHZhciByYW5kb21VVUlEID0gdHlwZW9mIGNyeXB0byAhPT0gInVuZGVmaW5lZCIgJiYgY3J5cHRvLnJhbmRvbVVVSUQgJiYgY3J5cHRvLnJhbmRvbVVVSUQuYmluZChjcnlwdG8pOwogIHZhciBuYXRpdmVfZGVmYXVsdCA9IHsKICAgIHJhbmRvbVVVSUQKICB9OwoKICAvLyBub2RlX21vZHVsZXMvdXVpZC9kaXN0L2VzbS1icm93c2VyL3Y0LmpzCiAgZnVuY3Rpb24gdjQob3B0aW9ucywgYnVmLCBvZmZzZXQpIHsKICAgIGlmIChuYXRpdmVfZGVmYXVsdC5yYW5kb21VVUlEICYmICFidWYgJiYgIW9wdGlvbnMpIHsKICAgICAgcmV0dXJuIG5hdGl2ZV9kZWZhdWx0LnJhbmRvbVVVSUQoKTsKICAgIH0KICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgY29uc3Qgcm5kcyA9IG9wdGlvbnMucmFuZG9tIHx8IChvcHRpb25zLnJuZyB8fCBybmcpKCk7CiAgICBybmRzWzZdID0gcm5kc1s2XSAmIDE1IHwgNjQ7CiAgICBybmRzWzhdID0gcm5kc1s4XSAmIDYzIHwgMTI4OwogICAgaWYgKGJ1ZikgewogICAgICBvZmZzZXQgPSBvZmZzZXQgfHwgMDsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAxNjsgKytpKSB7CiAgICAgICAgYnVmW29mZnNldCArIGldID0gcm5kc1tpXTsKICAgICAgfQogICAgICByZXR1cm4gYnVmOwogICAgfQogICAgcmV0dXJuIHVuc2FmZVN0cmluZ2lmeShybmRzKTsKICB9CiAgdmFyIHY0X2RlZmF1bHQgPSB2NDsKCiAgLy8gc3JjL3B1YmxpYy9saWIvQml0YnVybmVySW5zdGFuY2UudHMKICB2YXIgQml0YnVybmVySW5zdGFuY2UgPSB7CiAgICBhc3luYyBnZXROZXR3b3JrRGF0YSgpIHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuc2VuZEFjdGlvbih7IGFjdGlvbjogInNjYW4tbmV0d29yayIgfSk7CiAgICB9LAogICAgY29ubmVjdFRvU2VydmVyKHBhdGgpIHsKICAgICAgdGhpcy5zZW5kQWN0aW9uKHsgYWN0aW9uOiAiY29ubmVjdFRvU2VydmVyIiwgcGFyYW1zOiBwYXRoIH0pOwogICAgfSwKICAgIGFzeW5jIGxvYWRUaGVtZSgpIHsKICAgICAgY29uc3QgdGhlbWUgPSBhd2FpdCB0aGlzLnNlbmRBY3Rpb24oeyBhY3Rpb246ICJucy1mdW5jdGlvbiIsIHBhcmFtczogWyJ1aS5nZXRUaGVtZSJdIH0pOwogICAgICBPYmplY3QuZW50cmllcyh0aGVtZSkuZm9yRWFjaCgoW2tleSwgdmFsdWVdKSA9PiB7CiAgICAgICAgZG9jdW1lbnQuYm9keS5zdHlsZS5zZXRQcm9wZXJ0eShgLS0ke2tleX1gLCB2YWx1ZSk7CiAgICAgIH0pOwogICAgfSwKICAgIGFzeW5jIHNlbmRBY3Rpb24oYWN0aW9uKSB7CiAgICAgIGNvbnN0IHV1aWQgPSB2NF9kZWZhdWx0KCk7CiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShhc3luYyAocmVzb2x2ZSkgPT4gewogICAgICAgIHdpbmRvdy5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgiYml0YnVybmVyIiwgeyBkZXRhaWw6IF9fc3ByZWFkVmFsdWVzKHsgdXVpZCB9LCBhY3Rpb24pIH0pKTsKICAgICAgICBjb25zdCByZXNwb25zZUxpc3RlbmVyID0gKHsgZGV0YWlsIH0pID0+IHsKICAgICAgICAgIGNvbnN0IHsgdXVpZDogcmVzcG9uc2VJRCB9ID0gZGV0YWlsOwogICAgICAgICAgaWYgKHV1aWQgIT0gcmVzcG9uc2VJRCkKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgcmVzb2x2ZShkZXRhaWwuZGF0YSk7CiAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigiYml0YnVybmVyLXJlc3BvbnNlIiwgcmVzcG9uc2VMaXN0ZW5lcik7CiAgICAgICAgfTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigiYml0YnVybmVyLXJlc3BvbnNlIiwgcmVzcG9uc2VMaXN0ZW5lcik7CiAgICAgIH0pOwogICAgfQogIH07CgogIC8vIHNyYy9wdWJsaWMvY29tcG9uZW50cy9BcHAudHN4CiAgdmFyIGltcG9ydF9yZWFjdDUgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgogIC8vIG5vZGVfbW9kdWxlcy9kMy1kaXNwYXRjaC9zcmMvZGlzcGF0Y2guanMKICB2YXIgbm9vcCA9IHsgdmFsdWU6ICgpID0+IHsKICB9IH07CiAgZnVuY3Rpb24gZGlzcGF0Y2goKSB7CiAgICBmb3IgKHZhciBpID0gMCwgbiA9IGFyZ3VtZW50cy5sZW5ndGgsIF8gPSB7fSwgdDsgaSA8IG47ICsraSkgewogICAgICBpZiAoISh0ID0gYXJndW1lbnRzW2ldICsgIiIpIHx8IHQgaW4gXyB8fCAvW1xzLl0vLnRlc3QodCkpCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJpbGxlZ2FsIHR5cGU6ICIgKyB0KTsKICAgICAgX1t0XSA9IFtdOwogICAgfQogICAgcmV0dXJuIG5ldyBEaXNwYXRjaChfKTsKICB9CiAgZnVuY3Rpb24gRGlzcGF0Y2goXykgewogICAgdGhpcy5fID0gXzsKICB9CiAgZnVuY3Rpb24gcGFyc2VUeXBlbmFtZXModHlwZW5hbWVzLCB0eXBlcykgewogICAgcmV0dXJuIHR5cGVuYW1lcy50cmltKCkuc3BsaXQoL158XHMrLykubWFwKGZ1bmN0aW9uKHQpIHsKICAgICAgdmFyIG5hbWUgPSAiIiwgaSA9IHQuaW5kZXhPZigiLiIpOwogICAgICBpZiAoaSA+PSAwKQogICAgICAgIG5hbWUgPSB0LnNsaWNlKGkgKyAxKSwgdCA9IHQuc2xpY2UoMCwgaSk7CiAgICAgIGlmICh0ICYmICF0eXBlcy5oYXNPd25Qcm9wZXJ0eSh0KSkKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInVua25vd24gdHlwZTogIiArIHQpOwogICAgICByZXR1cm4geyB0eXBlOiB0LCBuYW1lIH07CiAgICB9KTsKICB9CiAgRGlzcGF0Y2gucHJvdG90eXBlID0gZGlzcGF0Y2gucHJvdG90eXBlID0gewogICAgY29uc3RydWN0b3I6IERpc3BhdGNoLAogICAgb246IGZ1bmN0aW9uKHR5cGVuYW1lLCBjYWxsYmFjaykgewogICAgICB2YXIgXyA9IHRoaXMuXywgVCA9IHBhcnNlVHlwZW5hbWVzKHR5cGVuYW1lICsgIiIsIF8pLCB0LCBpID0gLTEsIG4gPSBULmxlbmd0aDsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPCAyKSB7CiAgICAgICAgd2hpbGUgKCsraSA8IG4pCiAgICAgICAgICBpZiAoKHQgPSAodHlwZW5hbWUgPSBUW2ldKS50eXBlKSAmJiAodCA9IGdldChfW3RdLCB0eXBlbmFtZS5uYW1lKSkpCiAgICAgICAgICAgIHJldHVybiB0OwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoY2FsbGJhY2sgIT0gbnVsbCAmJiB0eXBlb2YgY2FsbGJhY2sgIT09ICJmdW5jdGlvbiIpCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJpbnZhbGlkIGNhbGxiYWNrOiAiICsgY2FsbGJhY2spOwogICAgICB3aGlsZSAoKytpIDwgbikgewogICAgICAgIGlmICh0ID0gKHR5cGVuYW1lID0gVFtpXSkudHlwZSkKICAgICAgICAgIF9bdF0gPSBzZXQoX1t0XSwgdHlwZW5hbWUubmFtZSwgY2FsbGJhY2spOwogICAgICAgIGVsc2UgaWYgKGNhbGxiYWNrID09IG51bGwpCiAgICAgICAgICBmb3IgKHQgaW4gXykKICAgICAgICAgICAgX1t0XSA9IHNldChfW3RdLCB0eXBlbmFtZS5uYW1lLCBudWxsKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBjb3B5OiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGNvcHkgPSB7fSwgXyA9IHRoaXMuXzsKICAgICAgZm9yICh2YXIgdCBpbiBfKQogICAgICAgIGNvcHlbdF0gPSBfW3RdLnNsaWNlKCk7CiAgICAgIHJldHVybiBuZXcgRGlzcGF0Y2goY29weSk7CiAgICB9LAogICAgY2FsbDogZnVuY3Rpb24odHlwZTIsIHRoYXQpIHsKICAgICAgaWYgKChuID0gYXJndW1lbnRzLmxlbmd0aCAtIDIpID4gMCkKICAgICAgICBmb3IgKHZhciBhcmdzID0gbmV3IEFycmF5KG4pLCBpID0gMCwgbiwgdDsgaSA8IG47ICsraSkKICAgICAgICAgIGFyZ3NbaV0gPSBhcmd1bWVudHNbaSArIDJdOwogICAgICBpZiAoIXRoaXMuXy5oYXNPd25Qcm9wZXJ0eSh0eXBlMikpCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJ1bmtub3duIHR5cGU6ICIgKyB0eXBlMik7CiAgICAgIGZvciAodCA9IHRoaXMuX1t0eXBlMl0sIGkgPSAwLCBuID0gdC5sZW5ndGg7IGkgPCBuOyArK2kpCiAgICAgICAgdFtpXS52YWx1ZS5hcHBseSh0aGF0LCBhcmdzKTsKICAgIH0sCiAgICBhcHBseTogZnVuY3Rpb24odHlwZTIsIHRoYXQsIGFyZ3MpIHsKICAgICAgaWYgKCF0aGlzLl8uaGFzT3duUHJvcGVydHkodHlwZTIpKQogICAgICAgIHRocm93IG5ldyBFcnJvcigidW5rbm93biB0eXBlOiAiICsgdHlwZTIpOwogICAgICBmb3IgKHZhciB0ID0gdGhpcy5fW3R5cGUyXSwgaSA9IDAsIG4gPSB0Lmxlbmd0aDsgaSA8IG47ICsraSkKICAgICAgICB0W2ldLnZhbHVlLmFwcGx5KHRoYXQsIGFyZ3MpOwogICAgfQogIH07CiAgZnVuY3Rpb24gZ2V0KHR5cGUyLCBuYW1lKSB7CiAgICBmb3IgKHZhciBpID0gMCwgbiA9IHR5cGUyLmxlbmd0aCwgYzI7IGkgPCBuOyArK2kpIHsKICAgICAgaWYgKChjMiA9IHR5cGUyW2ldKS5uYW1lID09PSBuYW1lKSB7CiAgICAgICAgcmV0dXJuIGMyLnZhbHVlOwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIHNldCh0eXBlMiwgbmFtZSwgY2FsbGJhY2spIHsKICAgIGZvciAodmFyIGkgPSAwLCBuID0gdHlwZTIubGVuZ3RoOyBpIDwgbjsgKytpKSB7CiAgICAgIGlmICh0eXBlMltpXS5uYW1lID09PSBuYW1lKSB7CiAgICAgICAgdHlwZTJbaV0gPSBub29wLCB0eXBlMiA9IHR5cGUyLnNsaWNlKDAsIGkpLmNvbmNhdCh0eXBlMi5zbGljZShpICsgMSkpOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICBpZiAoY2FsbGJhY2sgIT0gbnVsbCkKICAgICAgdHlwZTIucHVzaCh7IG5hbWUsIHZhbHVlOiBjYWxsYmFjayB9KTsKICAgIHJldHVybiB0eXBlMjsKICB9CiAgdmFyIGRpc3BhdGNoX2RlZmF1bHQgPSBkaXNwYXRjaDsKCiAgLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvbmFtZXNwYWNlcy5qcwogIHZhciB4aHRtbCA9ICJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIjsKICB2YXIgbmFtZXNwYWNlc19kZWZhdWx0ID0gewogICAgc3ZnOiAiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciLAogICAgeGh0bWwsCiAgICB4bGluazogImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiLAogICAgeG1sOiAiaHR0cDovL3d3dy53My5vcmcvWE1MLzE5OTgvbmFtZXNwYWNlIiwKICAgIHhtbG5zOiAiaHR0cDovL3d3dy53My5vcmcvMjAwMC94bWxucy8iCiAgfTsKCiAgLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvbmFtZXNwYWNlLmpzCiAgZnVuY3Rpb24gbmFtZXNwYWNlX2RlZmF1bHQobmFtZSkgewogICAgdmFyIHByZWZpeCA9IG5hbWUgKz0gIiIsIGkgPSBwcmVmaXguaW5kZXhPZigiOiIpOwogICAgaWYgKGkgPj0gMCAmJiAocHJlZml4ID0gbmFtZS5zbGljZSgwLCBpKSkgIT09ICJ4bWxucyIpCiAgICAgIG5hbWUgPSBuYW1lLnNsaWNlKGkgKyAxKTsKICAgIHJldHVybiBuYW1lc3BhY2VzX2RlZmF1bHQuaGFzT3duUHJvcGVydHkocHJlZml4KSA/IHsgc3BhY2U6IG5hbWVzcGFjZXNfZGVmYXVsdFtwcmVmaXhdLCBsb2NhbDogbmFtZSB9IDogbmFtZTsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9kMy1zZWxlY3Rpb24vc3JjL2NyZWF0b3IuanMKICBmdW5jdGlvbiBjcmVhdG9ySW5oZXJpdChuYW1lKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBkb2N1bWVudDIgPSB0aGlzLm93bmVyRG9jdW1lbnQsIHVyaSA9IHRoaXMubmFtZXNwYWNlVVJJOwogICAgICByZXR1cm4gdXJpID09PSB4aHRtbCAmJiBkb2N1bWVudDIuZG9jdW1lbnRFbGVtZW50Lm5hbWVzcGFjZVVSSSA9PT0geGh0bWwgPyBkb2N1bWVudDIuY3JlYXRlRWxlbWVudChuYW1lKSA6IGRvY3VtZW50Mi5jcmVhdGVFbGVtZW50TlModXJpLCBuYW1lKTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIGNyZWF0b3JGaXhlZChmdWxsbmFtZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5vd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhmdWxsbmFtZS5zcGFjZSwgZnVsbG5hbWUubG9jYWwpOwogICAgfTsKICB9CiAgZnVuY3Rpb24gY3JlYXRvcl9kZWZhdWx0KG5hbWUpIHsKICAgIHZhciBmdWxsbmFtZSA9IG5hbWVzcGFjZV9kZWZhdWx0KG5hbWUpOwogICAgcmV0dXJuIChmdWxsbmFtZS5sb2NhbCA/IGNyZWF0b3JGaXhlZCA6IGNyZWF0b3JJbmhlcml0KShmdWxsbmFtZSk7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3Rvci5qcwogIGZ1bmN0aW9uIG5vbmUoKSB7CiAgfQogIGZ1bmN0aW9uIHNlbGVjdG9yX2RlZmF1bHQoc2VsZWN0b3IpIHsKICAgIHJldHVybiBzZWxlY3RvciA9PSBudWxsID8gbm9uZSA6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5xdWVyeVNlbGVjdG9yKHNlbGVjdG9yKTsKICAgIH07CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3Rpb24vc2VsZWN0LmpzCiAgZnVuY3Rpb24gc2VsZWN0X2RlZmF1bHQoc2VsZWN0KSB7CiAgICBpZiAodHlwZW9mIHNlbGVjdCAhPT0gImZ1bmN0aW9uIikKICAgICAgc2VsZWN0ID0gc2VsZWN0b3JfZGVmYXVsdChzZWxlY3QpOwogICAgZm9yICh2YXIgZ3JvdXBzID0gdGhpcy5fZ3JvdXBzLCBtMiA9IGdyb3Vwcy5sZW5ndGgsIHN1Ymdyb3VwcyA9IG5ldyBBcnJheShtMiksIGogPSAwOyBqIDwgbTI7ICsraikgewogICAgICBmb3IgKHZhciBncm91cCA9IGdyb3Vwc1tqXSwgbiA9IGdyb3VwLmxlbmd0aCwgc3ViZ3JvdXAgPSBzdWJncm91cHNbal0gPSBuZXcgQXJyYXkobiksIG5vZGUsIHN1Ym5vZGUsIGkgPSAwOyBpIDwgbjsgKytpKSB7CiAgICAgICAgaWYgKChub2RlID0gZ3JvdXBbaV0pICYmIChzdWJub2RlID0gc2VsZWN0LmNhbGwobm9kZSwgbm9kZS5fX2RhdGFfXywgaSwgZ3JvdXApKSkgewogICAgICAgICAgaWYgKCJfX2RhdGFfXyIgaW4gbm9kZSkKICAgICAgICAgICAgc3Vibm9kZS5fX2RhdGFfXyA9IG5vZGUuX19kYXRhX187CiAgICAgICAgICBzdWJncm91cFtpXSA9IHN1Ym5vZGU7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gbmV3IFNlbGVjdGlvbihzdWJncm91cHMsIHRoaXMuX3BhcmVudHMpOwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvYXJyYXkuanMKICBmdW5jdGlvbiBhcnJheSh4MikgewogICAgcmV0dXJuIHgyID09IG51bGwgPyBbXSA6IEFycmF5LmlzQXJyYXkoeDIpID8geDIgOiBBcnJheS5mcm9tKHgyKTsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9kMy1zZWxlY3Rpb24vc3JjL3NlbGVjdG9yQWxsLmpzCiAgZnVuY3Rpb24gZW1wdHkoKSB7CiAgICByZXR1cm4gW107CiAgfQogIGZ1bmN0aW9uIHNlbGVjdG9yQWxsX2RlZmF1bHQoc2VsZWN0b3IpIHsKICAgIHJldHVybiBzZWxlY3RvciA9PSBudWxsID8gZW1wdHkgOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMucXVlcnlTZWxlY3RvckFsbChzZWxlY3Rvcik7CiAgICB9OwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvc2VsZWN0aW9uL3NlbGVjdEFsbC5qcwogIGZ1bmN0aW9uIGFycmF5QWxsKHNlbGVjdCkgewogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gYXJyYXkoc2VsZWN0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgfTsKICB9CiAgZnVuY3Rpb24gc2VsZWN0QWxsX2RlZmF1bHQoc2VsZWN0KSB7CiAgICBpZiAodHlwZW9mIHNlbGVjdCA9PT0gImZ1bmN0aW9uIikKICAgICAgc2VsZWN0ID0gYXJyYXlBbGwoc2VsZWN0KTsKICAgIGVsc2UKICAgICAgc2VsZWN0ID0gc2VsZWN0b3JBbGxfZGVmYXVsdChzZWxlY3QpOwogICAgZm9yICh2YXIgZ3JvdXBzID0gdGhpcy5fZ3JvdXBzLCBtMiA9IGdyb3Vwcy5sZW5ndGgsIHN1Ymdyb3VwcyA9IFtdLCBwYXJlbnRzID0gW10sIGogPSAwOyBqIDwgbTI7ICsraikgewogICAgICBmb3IgKHZhciBncm91cCA9IGdyb3Vwc1tqXSwgbiA9IGdyb3VwLmxlbmd0aCwgbm9kZSwgaSA9IDA7IGkgPCBuOyArK2kpIHsKICAgICAgICBpZiAobm9kZSA9IGdyb3VwW2ldKSB7CiAgICAgICAgICBzdWJncm91cHMucHVzaChzZWxlY3QuY2FsbChub2RlLCBub2RlLl9fZGF0YV9fLCBpLCBncm91cCkpOwogICAgICAgICAgcGFyZW50cy5wdXNoKG5vZGUpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIG5ldyBTZWxlY3Rpb24oc3ViZ3JvdXBzLCBwYXJlbnRzKTsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9kMy1zZWxlY3Rpb24vc3JjL21hdGNoZXIuanMKICBmdW5jdGlvbiBtYXRjaGVyX2RlZmF1bHQoc2VsZWN0b3IpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMubWF0Y2hlcyhzZWxlY3Rvcik7CiAgICB9OwogIH0KICBmdW5jdGlvbiBjaGlsZE1hdGNoZXIoc2VsZWN0b3IpIHsKICAgIHJldHVybiBmdW5jdGlvbihub2RlKSB7CiAgICAgIHJldHVybiBub2RlLm1hdGNoZXMoc2VsZWN0b3IpOwogICAgfTsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9kMy1zZWxlY3Rpb24vc3JjL3NlbGVjdGlvbi9zZWxlY3RDaGlsZC5qcwogIHZhciBmaW5kID0gQXJyYXkucHJvdG90eXBlLmZpbmQ7CiAgZnVuY3Rpb24gY2hpbGRGaW5kKG1hdGNoKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBmaW5kLmNhbGwodGhpcy5jaGlsZHJlbiwgbWF0Y2gpOwogICAgfTsKICB9CiAgZnVuY3Rpb24gY2hpbGRGaXJzdCgpIHsKICAgIHJldHVybiB0aGlzLmZpcnN0RWxlbWVudENoaWxkOwogIH0KICBmdW5jdGlvbiBzZWxlY3RDaGlsZF9kZWZhdWx0KG1hdGNoKSB7CiAgICByZXR1cm4gdGhpcy5zZWxlY3QobWF0Y2ggPT0gbnVsbCA/IGNoaWxkRmlyc3QgOiBjaGlsZEZpbmQodHlwZW9mIG1hdGNoID09PSAiZnVuY3Rpb24iID8gbWF0Y2ggOiBjaGlsZE1hdGNoZXIobWF0Y2gpKSk7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3Rpb24vc2VsZWN0Q2hpbGRyZW4uanMKICB2YXIgZmlsdGVyID0gQXJyYXkucHJvdG90eXBlLmZpbHRlcjsKICBmdW5jdGlvbiBjaGlsZHJlbigpIHsKICAgIHJldHVybiBBcnJheS5mcm9tKHRoaXMuY2hpbGRyZW4pOwogIH0KICBmdW5jdGlvbiBjaGlsZHJlbkZpbHRlcihtYXRjaCkgewogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gZmlsdGVyLmNhbGwodGhpcy5jaGlsZHJlbiwgbWF0Y2gpOwogICAgfTsKICB9CiAgZnVuY3Rpb24gc2VsZWN0Q2hpbGRyZW5fZGVmYXVsdChtYXRjaCkgewogICAgcmV0dXJuIHRoaXMuc2VsZWN0QWxsKG1hdGNoID09IG51bGwgPyBjaGlsZHJlbiA6IGNoaWxkcmVuRmlsdGVyKHR5cGVvZiBtYXRjaCA9PT0gImZ1bmN0aW9uIiA/IG1hdGNoIDogY2hpbGRNYXRjaGVyKG1hdGNoKSkpOwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvc2VsZWN0aW9uL2ZpbHRlci5qcwogIGZ1bmN0aW9uIGZpbHRlcl9kZWZhdWx0KG1hdGNoKSB7CiAgICBpZiAodHlwZW9mIG1hdGNoICE9PSAiZnVuY3Rpb24iKQogICAgICBtYXRjaCA9IG1hdGNoZXJfZGVmYXVsdChtYXRjaCk7CiAgICBmb3IgKHZhciBncm91cHMgPSB0aGlzLl9ncm91cHMsIG0yID0gZ3JvdXBzLmxlbmd0aCwgc3ViZ3JvdXBzID0gbmV3IEFycmF5KG0yKSwgaiA9IDA7IGogPCBtMjsgKytqKSB7CiAgICAgIGZvciAodmFyIGdyb3VwID0gZ3JvdXBzW2pdLCBuID0gZ3JvdXAubGVuZ3RoLCBzdWJncm91cCA9IHN1Ymdyb3Vwc1tqXSA9IFtdLCBub2RlLCBpID0gMDsgaSA8IG47ICsraSkgewogICAgICAgIGlmICgobm9kZSA9IGdyb3VwW2ldKSAmJiBtYXRjaC5jYWxsKG5vZGUsIG5vZGUuX19kYXRhX18sIGksIGdyb3VwKSkgewogICAgICAgICAgc3ViZ3JvdXAucHVzaChub2RlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBuZXcgU2VsZWN0aW9uKHN1Ymdyb3VwcywgdGhpcy5fcGFyZW50cyk7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3Rpb24vc3BhcnNlLmpzCiAgZnVuY3Rpb24gc3BhcnNlX2RlZmF1bHQodXBkYXRlKSB7CiAgICByZXR1cm4gbmV3IEFycmF5KHVwZGF0ZS5sZW5ndGgpOwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvc2VsZWN0aW9uL2VudGVyLmpzCiAgZnVuY3Rpb24gZW50ZXJfZGVmYXVsdCgpIHsKICAgIHJldHVybiBuZXcgU2VsZWN0aW9uKHRoaXMuX2VudGVyIHx8IHRoaXMuX2dyb3Vwcy5tYXAoc3BhcnNlX2RlZmF1bHQpLCB0aGlzLl9wYXJlbnRzKTsKICB9CiAgZnVuY3Rpb24gRW50ZXJOb2RlKHBhcmVudCwgZGF0dW0yKSB7CiAgICB0aGlzLm93bmVyRG9jdW1lbnQgPSBwYXJlbnQub3duZXJEb2N1bWVudDsKICAgIHRoaXMubmFtZXNwYWNlVVJJID0gcGFyZW50Lm5hbWVzcGFjZVVSSTsKICAgIHRoaXMuX25leHQgPSBudWxsOwogICAgdGhpcy5fcGFyZW50ID0gcGFyZW50OwogICAgdGhpcy5fX2RhdGFfXyA9IGRhdHVtMjsKICB9CiAgRW50ZXJOb2RlLnByb3RvdHlwZSA9IHsKICAgIGNvbnN0cnVjdG9yOiBFbnRlck5vZGUsCiAgICBhcHBlbmRDaGlsZDogZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgcmV0dXJuIHRoaXMuX3BhcmVudC5pbnNlcnRCZWZvcmUoY2hpbGQsIHRoaXMuX25leHQpOwogICAgfSwKICAgIGluc2VydEJlZm9yZTogZnVuY3Rpb24oY2hpbGQsIG5leHQpIHsKICAgICAgcmV0dXJuIHRoaXMuX3BhcmVudC5pbnNlcnRCZWZvcmUoY2hpbGQsIG5leHQpOwogICAgfSwKICAgIHF1ZXJ5U2VsZWN0b3I6IGZ1bmN0aW9uKHNlbGVjdG9yKSB7CiAgICAgIHJldHVybiB0aGlzLl9wYXJlbnQucXVlcnlTZWxlY3RvcihzZWxlY3Rvcik7CiAgICB9LAogICAgcXVlcnlTZWxlY3RvckFsbDogZnVuY3Rpb24oc2VsZWN0b3IpIHsKICAgICAgcmV0dXJuIHRoaXMuX3BhcmVudC5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKTsKICAgIH0KICB9OwoKICAvLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9jb25zdGFudC5qcwogIGZ1bmN0aW9uIGNvbnN0YW50X2RlZmF1bHQoeDIpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHgyOwogICAgfTsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9kMy1zZWxlY3Rpb24vc3JjL3NlbGVjdGlvbi9kYXRhLmpzCiAgZnVuY3Rpb24gYmluZEluZGV4KHBhcmVudCwgZ3JvdXAsIGVudGVyLCB1cGRhdGUsIGV4aXQsIGRhdGEpIHsKICAgIHZhciBpID0gMCwgbm9kZSwgZ3JvdXBMZW5ndGggPSBncm91cC5sZW5ndGgsIGRhdGFMZW5ndGggPSBkYXRhLmxlbmd0aDsKICAgIGZvciAoOyBpIDwgZGF0YUxlbmd0aDsgKytpKSB7CiAgICAgIGlmIChub2RlID0gZ3JvdXBbaV0pIHsKICAgICAgICBub2RlLl9fZGF0YV9fID0gZGF0YVtpXTsKICAgICAgICB1cGRhdGVbaV0gPSBub2RlOwogICAgICB9IGVsc2UgewogICAgICAgIGVudGVyW2ldID0gbmV3IEVudGVyTm9kZShwYXJlbnQsIGRhdGFbaV0pOwogICAgICB9CiAgICB9CiAgICBmb3IgKDsgaSA8IGdyb3VwTGVuZ3RoOyArK2kpIHsKICAgICAgaWYgKG5vZGUgPSBncm91cFtpXSkgewogICAgICAgIGV4aXRbaV0gPSBub2RlOwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIGJpbmRLZXkocGFyZW50LCBncm91cCwgZW50ZXIsIHVwZGF0ZSwgZXhpdCwgZGF0YSwga2V5KSB7CiAgICB2YXIgaSwgbm9kZSwgbm9kZUJ5S2V5VmFsdWUgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpLCBncm91cExlbmd0aCA9IGdyb3VwLmxlbmd0aCwgZGF0YUxlbmd0aCA9IGRhdGEubGVuZ3RoLCBrZXlWYWx1ZXMgPSBuZXcgQXJyYXkoZ3JvdXBMZW5ndGgpLCBrZXlWYWx1ZTsKICAgIGZvciAoaSA9IDA7IGkgPCBncm91cExlbmd0aDsgKytpKSB7CiAgICAgIGlmIChub2RlID0gZ3JvdXBbaV0pIHsKICAgICAgICBrZXlWYWx1ZXNbaV0gPSBrZXlWYWx1ZSA9IGtleS5jYWxsKG5vZGUsIG5vZGUuX19kYXRhX18sIGksIGdyb3VwKSArICIiOwogICAgICAgIGlmIChub2RlQnlLZXlWYWx1ZS5oYXMoa2V5VmFsdWUpKSB7CiAgICAgICAgICBleGl0W2ldID0gbm9kZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbm9kZUJ5S2V5VmFsdWUuc2V0KGtleVZhbHVlLCBub2RlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGZvciAoaSA9IDA7IGkgPCBkYXRhTGVuZ3RoOyArK2kpIHsKICAgICAga2V5VmFsdWUgPSBrZXkuY2FsbChwYXJlbnQsIGRhdGFbaV0sIGksIGRhdGEpICsgIiI7CiAgICAgIGlmIChub2RlID0gbm9kZUJ5S2V5VmFsdWUuZ2V0KGtleVZhbHVlKSkgewogICAgICAgIHVwZGF0ZVtpXSA9IG5vZGU7CiAgICAgICAgbm9kZS5fX2RhdGFfXyA9IGRhdGFbaV07CiAgICAgICAgbm9kZUJ5S2V5VmFsdWUuZGVsZXRlKGtleVZhbHVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBlbnRlcltpXSA9IG5ldyBFbnRlck5vZGUocGFyZW50LCBkYXRhW2ldKTsKICAgICAgfQogICAgfQogICAgZm9yIChpID0gMDsgaSA8IGdyb3VwTGVuZ3RoOyArK2kpIHsKICAgICAgaWYgKChub2RlID0gZ3JvdXBbaV0pICYmIG5vZGVCeUtleVZhbHVlLmdldChrZXlWYWx1ZXNbaV0pID09PSBub2RlKSB7CiAgICAgICAgZXhpdFtpXSA9IG5vZGU7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gZGF0dW0obm9kZSkgewogICAgcmV0dXJuIG5vZGUuX19kYXRhX187CiAgfQogIGZ1bmN0aW9uIGRhdGFfZGVmYXVsdCh2YWx1ZSwga2V5KSB7CiAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGgpCiAgICAgIHJldHVybiBBcnJheS5mcm9tKHRoaXMsIGRhdHVtKTsKICAgIHZhciBiaW5kID0ga2V5ID8gYmluZEtleSA6IGJpbmRJbmRleCwgcGFyZW50cyA9IHRoaXMuX3BhcmVudHMsIGdyb3VwcyA9IHRoaXMuX2dyb3VwczsKICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICJmdW5jdGlvbiIpCiAgICAgIHZhbHVlID0gY29uc3RhbnRfZGVmYXVsdCh2YWx1ZSk7CiAgICBmb3IgKHZhciBtMiA9IGdyb3Vwcy5sZW5ndGgsIHVwZGF0ZSA9IG5ldyBBcnJheShtMiksIGVudGVyID0gbmV3IEFycmF5KG0yKSwgZXhpdCA9IG5ldyBBcnJheShtMiksIGogPSAwOyBqIDwgbTI7ICsraikgewogICAgICB2YXIgcGFyZW50ID0gcGFyZW50c1tqXSwgZ3JvdXAgPSBncm91cHNbal0sIGdyb3VwTGVuZ3RoID0gZ3JvdXAubGVuZ3RoLCBkYXRhID0gYXJyYXlsaWtlKHZhbHVlLmNhbGwocGFyZW50LCBwYXJlbnQgJiYgcGFyZW50Ll9fZGF0YV9fLCBqLCBwYXJlbnRzKSksIGRhdGFMZW5ndGggPSBkYXRhLmxlbmd0aCwgZW50ZXJHcm91cCA9IGVudGVyW2pdID0gbmV3IEFycmF5KGRhdGFMZW5ndGgpLCB1cGRhdGVHcm91cCA9IHVwZGF0ZVtqXSA9IG5ldyBBcnJheShkYXRhTGVuZ3RoKSwgZXhpdEdyb3VwID0gZXhpdFtqXSA9IG5ldyBBcnJheShncm91cExlbmd0aCk7CiAgICAgIGJpbmQocGFyZW50LCBncm91cCwgZW50ZXJHcm91cCwgdXBkYXRlR3JvdXAsIGV4aXRHcm91cCwgZGF0YSwga2V5KTsKICAgICAgZm9yICh2YXIgaTAgPSAwLCBpMSA9IDAsIHByZXZpb3VzLCBuZXh0OyBpMCA8IGRhdGFMZW5ndGg7ICsraTApIHsKICAgICAgICBpZiAocHJldmlvdXMgPSBlbnRlckdyb3VwW2kwXSkgewogICAgICAgICAgaWYgKGkwID49IGkxKQogICAgICAgICAgICBpMSA9IGkwICsgMTsKICAgICAgICAgIHdoaWxlICghKG5leHQgPSB1cGRhdGVHcm91cFtpMV0pICYmICsraTEgPCBkYXRhTGVuZ3RoKQogICAgICAgICAgICA7CiAgICAgICAgICBwcmV2aW91cy5fbmV4dCA9IG5leHQgfHwgbnVsbDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHVwZGF0ZSA9IG5ldyBTZWxlY3Rpb24odXBkYXRlLCBwYXJlbnRzKTsKICAgIHVwZGF0ZS5fZW50ZXIgPSBlbnRlcjsKICAgIHVwZGF0ZS5fZXhpdCA9IGV4aXQ7CiAgICByZXR1cm4gdXBkYXRlOwogIH0KICBmdW5jdGlvbiBhcnJheWxpa2UoZGF0YSkgewogICAgcmV0dXJuIHR5cGVvZiBkYXRhID09PSAib2JqZWN0IiAmJiAibGVuZ3RoIiBpbiBkYXRhID8gZGF0YSA6IEFycmF5LmZyb20oZGF0YSk7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3Rpb24vZXhpdC5qcwogIGZ1bmN0aW9uIGV4aXRfZGVmYXVsdCgpIHsKICAgIHJldHVybiBuZXcgU2VsZWN0aW9uKHRoaXMuX2V4aXQgfHwgdGhpcy5fZ3JvdXBzLm1hcChzcGFyc2VfZGVmYXVsdCksIHRoaXMuX3BhcmVudHMpOwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvc2VsZWN0aW9uL2pvaW4uanMKICBmdW5jdGlvbiBqb2luX2RlZmF1bHQob25lbnRlciwgb251cGRhdGUsIG9uZXhpdCkgewogICAgdmFyIGVudGVyID0gdGhpcy5lbnRlcigpLCB1cGRhdGUgPSB0aGlzLCBleGl0ID0gdGhpcy5leGl0KCk7CiAgICBpZiAodHlwZW9mIG9uZW50ZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgZW50ZXIgPSBvbmVudGVyKGVudGVyKTsKICAgICAgaWYgKGVudGVyKQogICAgICAgIGVudGVyID0gZW50ZXIuc2VsZWN0aW9uKCk7CiAgICB9IGVsc2UgewogICAgICBlbnRlciA9IGVudGVyLmFwcGVuZChvbmVudGVyICsgIiIpOwogICAgfQogICAgaWYgKG9udXBkYXRlICE9IG51bGwpIHsKICAgICAgdXBkYXRlID0gb251cGRhdGUodXBkYXRlKTsKICAgICAgaWYgKHVwZGF0ZSkKICAgICAgICB1cGRhdGUgPSB1cGRhdGUuc2VsZWN0aW9uKCk7CiAgICB9CiAgICBpZiAob25leGl0ID09IG51bGwpCiAgICAgIGV4aXQucmVtb3ZlKCk7CiAgICBlbHNlCiAgICAgIG9uZXhpdChleGl0KTsKICAgIHJldHVybiBlbnRlciAmJiB1cGRhdGUgPyBlbnRlci5tZXJnZSh1cGRhdGUpLm9yZGVyKCkgOiB1cGRhdGU7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3Rpb24vbWVyZ2UuanMKICBmdW5jdGlvbiBtZXJnZV9kZWZhdWx0KGNvbnRleHQpIHsKICAgIHZhciBzZWxlY3Rpb24yID0gY29udGV4dC5zZWxlY3Rpb24gPyBjb250ZXh0LnNlbGVjdGlvbigpIDogY29udGV4dDsKICAgIGZvciAodmFyIGdyb3VwczAgPSB0aGlzLl9ncm91cHMsIGdyb3VwczEgPSBzZWxlY3Rpb24yLl9ncm91cHMsIG0wID0gZ3JvdXBzMC5sZW5ndGgsIG0xID0gZ3JvdXBzMS5sZW5ndGgsIG0yID0gTWF0aC5taW4obTAsIG0xKSwgbWVyZ2VzID0gbmV3IEFycmF5KG0wKSwgaiA9IDA7IGogPCBtMjsgKytqKSB7CiAgICAgIGZvciAodmFyIGdyb3VwMCA9IGdyb3VwczBbal0sIGdyb3VwMSA9IGdyb3VwczFbal0sIG4gPSBncm91cDAubGVuZ3RoLCBtZXJnZSA9IG1lcmdlc1tqXSA9IG5ldyBBcnJheShuKSwgbm9kZSwgaSA9IDA7IGkgPCBuOyArK2kpIHsKICAgICAgICBpZiAobm9kZSA9IGdyb3VwMFtpXSB8fCBncm91cDFbaV0pIHsKICAgICAgICAgIG1lcmdlW2ldID0gbm9kZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGZvciAoOyBqIDwgbTA7ICsraikgewogICAgICBtZXJnZXNbal0gPSBncm91cHMwW2pdOwogICAgfQogICAgcmV0dXJuIG5ldyBTZWxlY3Rpb24obWVyZ2VzLCB0aGlzLl9wYXJlbnRzKTsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9kMy1zZWxlY3Rpb24vc3JjL3NlbGVjdGlvbi9vcmRlci5qcwogIGZ1bmN0aW9uIG9yZGVyX2RlZmF1bHQoKSB7CiAgICBmb3IgKHZhciBncm91cHMgPSB0aGlzLl9ncm91cHMsIGogPSAtMSwgbTIgPSBncm91cHMubGVuZ3RoOyArK2ogPCBtMjsgKSB7CiAgICAgIGZvciAodmFyIGdyb3VwID0gZ3JvdXBzW2pdLCBpID0gZ3JvdXAubGVuZ3RoIC0gMSwgbmV4dCA9IGdyb3VwW2ldLCBub2RlOyAtLWkgPj0gMDsgKSB7CiAgICAgICAgaWYgKG5vZGUgPSBncm91cFtpXSkgewogICAgICAgICAgaWYgKG5leHQgJiYgbm9kZS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihuZXh0KSBeIDQpCiAgICAgICAgICAgIG5leHQucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZSwgbmV4dCk7CiAgICAgICAgICBuZXh0ID0gbm9kZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvc2VsZWN0aW9uL3NvcnQuanMKICBmdW5jdGlvbiBzb3J0X2RlZmF1bHQoY29tcGFyZSkgewogICAgaWYgKCFjb21wYXJlKQogICAgICBjb21wYXJlID0gYXNjZW5kaW5nOwogICAgZnVuY3Rpb24gY29tcGFyZU5vZGUoYTIsIGIpIHsKICAgICAgcmV0dXJuIGEyICYmIGIgPyBjb21wYXJlKGEyLl9fZGF0YV9fLCBiLl9fZGF0YV9fKSA6ICFhMiAtICFiOwogICAgfQogICAgZm9yICh2YXIgZ3JvdXBzID0gdGhpcy5fZ3JvdXBzLCBtMiA9IGdyb3Vwcy5sZW5ndGgsIHNvcnRncm91cHMgPSBuZXcgQXJyYXkobTIpLCBqID0gMDsgaiA8IG0yOyArK2opIHsKICAgICAgZm9yICh2YXIgZ3JvdXAgPSBncm91cHNbal0sIG4gPSBncm91cC5sZW5ndGgsIHNvcnRncm91cCA9IHNvcnRncm91cHNbal0gPSBuZXcgQXJyYXkobiksIG5vZGUsIGkgPSAwOyBpIDwgbjsgKytpKSB7CiAgICAgICAgaWYgKG5vZGUgPSBncm91cFtpXSkgewogICAgICAgICAgc29ydGdyb3VwW2ldID0gbm9kZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgc29ydGdyb3VwLnNvcnQoY29tcGFyZU5vZGUpOwogICAgfQogICAgcmV0dXJuIG5ldyBTZWxlY3Rpb24oc29ydGdyb3VwcywgdGhpcy5fcGFyZW50cykub3JkZXIoKTsKICB9CiAgZnVuY3Rpb24gYXNjZW5kaW5nKGEyLCBiKSB7CiAgICByZXR1cm4gYTIgPCBiID8gLTEgOiBhMiA+IGIgPyAxIDogYTIgPj0gYiA/IDAgOiBOYU47CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3Rpb24vY2FsbC5qcwogIGZ1bmN0aW9uIGNhbGxfZGVmYXVsdCgpIHsKICAgIHZhciBjYWxsYmFjayA9IGFyZ3VtZW50c1swXTsKICAgIGFyZ3VtZW50c1swXSA9IHRoaXM7CiAgICBjYWxsYmFjay5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXM7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3Rpb24vbm9kZXMuanMKICBmdW5jdGlvbiBub2Rlc19kZWZhdWx0KCkgewogICAgcmV0dXJuIEFycmF5LmZyb20odGhpcyk7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3Rpb24vbm9kZS5qcwogIGZ1bmN0aW9uIG5vZGVfZGVmYXVsdCgpIHsKICAgIGZvciAodmFyIGdyb3VwcyA9IHRoaXMuX2dyb3VwcywgaiA9IDAsIG0yID0gZ3JvdXBzLmxlbmd0aDsgaiA8IG0yOyArK2opIHsKICAgICAgZm9yICh2YXIgZ3JvdXAgPSBncm91cHNbal0sIGkgPSAwLCBuID0gZ3JvdXAubGVuZ3RoOyBpIDwgbjsgKytpKSB7CiAgICAgICAgdmFyIG5vZGUgPSBncm91cFtpXTsKICAgICAgICBpZiAobm9kZSkKICAgICAgICAgIHJldHVybiBub2RlOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9kMy1zZWxlY3Rpb24vc3JjL3NlbGVjdGlvbi9zaXplLmpzCiAgZnVuY3Rpb24gc2l6ZV9kZWZhdWx0KCkgewogICAgbGV0IHNpemUgPSAwOwogICAgZm9yIChjb25zdCBub2RlIG9mIHRoaXMpCiAgICAgICsrc2l6ZTsKICAgIHJldHVybiBzaXplOwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvc2VsZWN0aW9uL2VtcHR5LmpzCiAgZnVuY3Rpb24gZW1wdHlfZGVmYXVsdCgpIHsKICAgIHJldHVybiAhdGhpcy5ub2RlKCk7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3Rpb24vZWFjaC5qcwogIGZ1bmN0aW9uIGVhY2hfZGVmYXVsdChjYWxsYmFjaykgewogICAgZm9yICh2YXIgZ3JvdXBzID0gdGhpcy5fZ3JvdXBzLCBqID0gMCwgbTIgPSBncm91cHMubGVuZ3RoOyBqIDwgbTI7ICsraikgewogICAgICBmb3IgKHZhciBncm91cCA9IGdyb3Vwc1tqXSwgaSA9IDAsIG4gPSBncm91cC5sZW5ndGgsIG5vZGU7IGkgPCBuOyArK2kpIHsKICAgICAgICBpZiAobm9kZSA9IGdyb3VwW2ldKQogICAgICAgICAgY2FsbGJhY2suY2FsbChub2RlLCBub2RlLl9fZGF0YV9fLCBpLCBncm91cCk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvc2VsZWN0aW9uL2F0dHIuanMKICBmdW5jdGlvbiBhdHRyUmVtb3ZlKG5hbWUpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5yZW1vdmVBdHRyaWJ1dGUobmFtZSk7CiAgICB9OwogIH0KICBmdW5jdGlvbiBhdHRyUmVtb3ZlTlMoZnVsbG5hbWUpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5yZW1vdmVBdHRyaWJ1dGVOUyhmdWxsbmFtZS5zcGFjZSwgZnVsbG5hbWUubG9jYWwpOwogICAgfTsKICB9CiAgZnVuY3Rpb24gYXR0ckNvbnN0YW50KG5hbWUsIHZhbHVlKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuc2V0QXR0cmlidXRlKG5hbWUsIHZhbHVlKTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIGF0dHJDb25zdGFudE5TKGZ1bGxuYW1lLCB2YWx1ZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnNldEF0dHJpYnV0ZU5TKGZ1bGxuYW1lLnNwYWNlLCBmdWxsbmFtZS5sb2NhbCwgdmFsdWUpOwogICAgfTsKICB9CiAgZnVuY3Rpb24gYXR0ckZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciB2ID0gdmFsdWUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgaWYgKHYgPT0gbnVsbCkKICAgICAgICB0aGlzLnJlbW92ZUF0dHJpYnV0ZShuYW1lKTsKICAgICAgZWxzZQogICAgICAgIHRoaXMuc2V0QXR0cmlidXRlKG5hbWUsIHYpOwogICAgfTsKICB9CiAgZnVuY3Rpb24gYXR0ckZ1bmN0aW9uTlMoZnVsbG5hbWUsIHZhbHVlKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciB2ID0gdmFsdWUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgaWYgKHYgPT0gbnVsbCkKICAgICAgICB0aGlzLnJlbW92ZUF0dHJpYnV0ZU5TKGZ1bGxuYW1lLnNwYWNlLCBmdWxsbmFtZS5sb2NhbCk7CiAgICAgIGVsc2UKICAgICAgICB0aGlzLnNldEF0dHJpYnV0ZU5TKGZ1bGxuYW1lLnNwYWNlLCBmdWxsbmFtZS5sb2NhbCwgdik7CiAgICB9OwogIH0KICBmdW5jdGlvbiBhdHRyX2RlZmF1bHQobmFtZSwgdmFsdWUpIHsKICAgIHZhciBmdWxsbmFtZSA9IG5hbWVzcGFjZV9kZWZhdWx0KG5hbWUpOwogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPCAyKSB7CiAgICAgIHZhciBub2RlID0gdGhpcy5ub2RlKCk7CiAgICAgIHJldHVybiBmdWxsbmFtZS5sb2NhbCA/IG5vZGUuZ2V0QXR0cmlidXRlTlMoZnVsbG5hbWUuc3BhY2UsIGZ1bGxuYW1lLmxvY2FsKSA6IG5vZGUuZ2V0QXR0cmlidXRlKGZ1bGxuYW1lKTsKICAgIH0KICAgIHJldHVybiB0aGlzLmVhY2goKHZhbHVlID09IG51bGwgPyBmdWxsbmFtZS5sb2NhbCA/IGF0dHJSZW1vdmVOUyA6IGF0dHJSZW1vdmUgOiB0eXBlb2YgdmFsdWUgPT09ICJmdW5jdGlvbiIgPyBmdWxsbmFtZS5sb2NhbCA/IGF0dHJGdW5jdGlvbk5TIDogYXR0ckZ1bmN0aW9uIDogZnVsbG5hbWUubG9jYWwgPyBhdHRyQ29uc3RhbnROUyA6IGF0dHJDb25zdGFudCkoZnVsbG5hbWUsIHZhbHVlKSk7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy93aW5kb3cuanMKICBmdW5jdGlvbiB3aW5kb3dfZGVmYXVsdChub2RlKSB7CiAgICByZXR1cm4gbm9kZS5vd25lckRvY3VtZW50ICYmIG5vZGUub3duZXJEb2N1bWVudC5kZWZhdWx0VmlldyB8fCBub2RlLmRvY3VtZW50ICYmIG5vZGUgfHwgbm9kZS5kZWZhdWx0VmlldzsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9kMy1zZWxlY3Rpb24vc3JjL3NlbGVjdGlvbi9zdHlsZS5qcwogIGZ1bmN0aW9uIHN0eWxlUmVtb3ZlKG5hbWUpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5zdHlsZS5yZW1vdmVQcm9wZXJ0eShuYW1lKTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIHN0eWxlQ29uc3RhbnQobmFtZSwgdmFsdWUsIHByaW9yaXR5KSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuc3R5bGUuc2V0UHJvcGVydHkobmFtZSwgdmFsdWUsIHByaW9yaXR5KTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIHN0eWxlRnVuY3Rpb24obmFtZSwgdmFsdWUsIHByaW9yaXR5KSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciB2ID0gdmFsdWUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgaWYgKHYgPT0gbnVsbCkKICAgICAgICB0aGlzLnN0eWxlLnJlbW92ZVByb3BlcnR5KG5hbWUpOwogICAgICBlbHNlCiAgICAgICAgdGhpcy5zdHlsZS5zZXRQcm9wZXJ0eShuYW1lLCB2LCBwcmlvcml0eSk7CiAgICB9OwogIH0KICBmdW5jdGlvbiBzdHlsZV9kZWZhdWx0KG5hbWUsIHZhbHVlLCBwcmlvcml0eSkgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPiAxID8gdGhpcy5lYWNoKCh2YWx1ZSA9PSBudWxsID8gc3R5bGVSZW1vdmUgOiB0eXBlb2YgdmFsdWUgPT09ICJmdW5jdGlvbiIgPyBzdHlsZUZ1bmN0aW9uIDogc3R5bGVDb25zdGFudCkobmFtZSwgdmFsdWUsIHByaW9yaXR5ID09IG51bGwgPyAiIiA6IHByaW9yaXR5KSkgOiBzdHlsZVZhbHVlKHRoaXMubm9kZSgpLCBuYW1lKTsKICB9CiAgZnVuY3Rpb24gc3R5bGVWYWx1ZShub2RlLCBuYW1lKSB7CiAgICByZXR1cm4gbm9kZS5zdHlsZS5nZXRQcm9wZXJ0eVZhbHVlKG5hbWUpIHx8IHdpbmRvd19kZWZhdWx0KG5vZGUpLmdldENvbXB1dGVkU3R5bGUobm9kZSwgbnVsbCkuZ2V0UHJvcGVydHlWYWx1ZShuYW1lKTsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9kMy1zZWxlY3Rpb24vc3JjL3NlbGVjdGlvbi9wcm9wZXJ0eS5qcwogIGZ1bmN0aW9uIHByb3BlcnR5UmVtb3ZlKG5hbWUpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgZGVsZXRlIHRoaXNbbmFtZV07CiAgICB9OwogIH0KICBmdW5jdGlvbiBwcm9wZXJ0eUNvbnN0YW50KG5hbWUsIHZhbHVlKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHRoaXNbbmFtZV0gPSB2YWx1ZTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIHByb3BlcnR5RnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHYgPSB2YWx1ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICBpZiAodiA9PSBudWxsKQogICAgICAgIGRlbGV0ZSB0aGlzW25hbWVdOwogICAgICBlbHNlCiAgICAgICAgdGhpc1tuYW1lXSA9IHY7CiAgICB9OwogIH0KICBmdW5jdGlvbiBwcm9wZXJ0eV9kZWZhdWx0KG5hbWUsIHZhbHVlKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA+IDEgPyB0aGlzLmVhY2goKHZhbHVlID09IG51bGwgPyBwcm9wZXJ0eVJlbW92ZSA6IHR5cGVvZiB2YWx1ZSA9PT0gImZ1bmN0aW9uIiA/IHByb3BlcnR5RnVuY3Rpb24gOiBwcm9wZXJ0eUNvbnN0YW50KShuYW1lLCB2YWx1ZSkpIDogdGhpcy5ub2RlKClbbmFtZV07CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3Rpb24vY2xhc3NlZC5qcwogIGZ1bmN0aW9uIGNsYXNzQXJyYXkoc3RyaW5nKSB7CiAgICByZXR1cm4gc3RyaW5nLnRyaW0oKS5zcGxpdCgvXnxccysvKTsKICB9CiAgZnVuY3Rpb24gY2xhc3NMaXN0KG5vZGUpIHsKICAgIHJldHVybiBub2RlLmNsYXNzTGlzdCB8fCBuZXcgQ2xhc3NMaXN0KG5vZGUpOwogIH0KICBmdW5jdGlvbiBDbGFzc0xpc3Qobm9kZSkgewogICAgdGhpcy5fbm9kZSA9IG5vZGU7CiAgICB0aGlzLl9uYW1lcyA9IGNsYXNzQXJyYXkobm9kZS5nZXRBdHRyaWJ1dGUoImNsYXNzIikgfHwgIiIpOwogIH0KICBDbGFzc0xpc3QucHJvdG90eXBlID0gewogICAgYWRkOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHZhciBpID0gdGhpcy5fbmFtZXMuaW5kZXhPZihuYW1lKTsKICAgICAgaWYgKGkgPCAwKSB7CiAgICAgICAgdGhpcy5fbmFtZXMucHVzaChuYW1lKTsKICAgICAgICB0aGlzLl9ub2RlLnNldEF0dHJpYnV0ZSgiY2xhc3MiLCB0aGlzLl9uYW1lcy5qb2luKCIgIikpOwogICAgICB9CiAgICB9LAogICAgcmVtb3ZlOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHZhciBpID0gdGhpcy5fbmFtZXMuaW5kZXhPZihuYW1lKTsKICAgICAgaWYgKGkgPj0gMCkgewogICAgICAgIHRoaXMuX25hbWVzLnNwbGljZShpLCAxKTsKICAgICAgICB0aGlzLl9ub2RlLnNldEF0dHJpYnV0ZSgiY2xhc3MiLCB0aGlzLl9uYW1lcy5qb2luKCIgIikpOwogICAgICB9CiAgICB9LAogICAgY29udGFpbnM6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgcmV0dXJuIHRoaXMuX25hbWVzLmluZGV4T2YobmFtZSkgPj0gMDsKICAgIH0KICB9OwogIGZ1bmN0aW9uIGNsYXNzZWRBZGQobm9kZSwgbmFtZXMpIHsKICAgIHZhciBsaXN0ID0gY2xhc3NMaXN0KG5vZGUpLCBpID0gLTEsIG4gPSBuYW1lcy5sZW5ndGg7CiAgICB3aGlsZSAoKytpIDwgbikKICAgICAgbGlzdC5hZGQobmFtZXNbaV0pOwogIH0KICBmdW5jdGlvbiBjbGFzc2VkUmVtb3ZlKG5vZGUsIG5hbWVzKSB7CiAgICB2YXIgbGlzdCA9IGNsYXNzTGlzdChub2RlKSwgaSA9IC0xLCBuID0gbmFtZXMubGVuZ3RoOwogICAgd2hpbGUgKCsraSA8IG4pCiAgICAgIGxpc3QucmVtb3ZlKG5hbWVzW2ldKTsKICB9CiAgZnVuY3Rpb24gY2xhc3NlZFRydWUobmFtZXMpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgY2xhc3NlZEFkZCh0aGlzLCBuYW1lcyk7CiAgICB9OwogIH0KICBmdW5jdGlvbiBjbGFzc2VkRmFsc2UobmFtZXMpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgY2xhc3NlZFJlbW92ZSh0aGlzLCBuYW1lcyk7CiAgICB9OwogIH0KICBmdW5jdGlvbiBjbGFzc2VkRnVuY3Rpb24obmFtZXMsIHZhbHVlKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICh2YWx1ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpID8gY2xhc3NlZEFkZCA6IGNsYXNzZWRSZW1vdmUpKHRoaXMsIG5hbWVzKTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIGNsYXNzZWRfZGVmYXVsdChuYW1lLCB2YWx1ZSkgewogICAgdmFyIG5hbWVzID0gY2xhc3NBcnJheShuYW1lICsgIiIpOwogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPCAyKSB7CiAgICAgIHZhciBsaXN0ID0gY2xhc3NMaXN0KHRoaXMubm9kZSgpKSwgaSA9IC0xLCBuID0gbmFtZXMubGVuZ3RoOwogICAgICB3aGlsZSAoKytpIDwgbikKICAgICAgICBpZiAoIWxpc3QuY29udGFpbnMobmFtZXNbaV0pKQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHJldHVybiB0aGlzLmVhY2goKHR5cGVvZiB2YWx1ZSA9PT0gImZ1bmN0aW9uIiA/IGNsYXNzZWRGdW5jdGlvbiA6IHZhbHVlID8gY2xhc3NlZFRydWUgOiBjbGFzc2VkRmFsc2UpKG5hbWVzLCB2YWx1ZSkpOwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvc2VsZWN0aW9uL3RleHQuanMKICBmdW5jdGlvbiB0ZXh0UmVtb3ZlKCkgewogICAgdGhpcy50ZXh0Q29udGVudCA9ICIiOwogIH0KICBmdW5jdGlvbiB0ZXh0Q29uc3RhbnQodmFsdWUpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy50ZXh0Q29udGVudCA9IHZhbHVlOwogICAgfTsKICB9CiAgZnVuY3Rpb24gdGV4dEZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciB2ID0gdmFsdWUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgdGhpcy50ZXh0Q29udGVudCA9IHYgPT0gbnVsbCA/ICIiIDogdjsKICAgIH07CiAgfQogIGZ1bmN0aW9uIHRleHRfZGVmYXVsdCh2YWx1ZSkgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyB0aGlzLmVhY2godmFsdWUgPT0gbnVsbCA/IHRleHRSZW1vdmUgOiAodHlwZW9mIHZhbHVlID09PSAiZnVuY3Rpb24iID8gdGV4dEZ1bmN0aW9uIDogdGV4dENvbnN0YW50KSh2YWx1ZSkpIDogdGhpcy5ub2RlKCkudGV4dENvbnRlbnQ7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3Rpb24vaHRtbC5qcwogIGZ1bmN0aW9uIGh0bWxSZW1vdmUoKSB7CiAgICB0aGlzLmlubmVySFRNTCA9ICIiOwogIH0KICBmdW5jdGlvbiBodG1sQ29uc3RhbnQodmFsdWUpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5pbm5lckhUTUwgPSB2YWx1ZTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIGh0bWxGdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgdiA9IHZhbHVlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIHRoaXMuaW5uZXJIVE1MID0gdiA9PSBudWxsID8gIiIgOiB2OwogICAgfTsKICB9CiAgZnVuY3Rpb24gaHRtbF9kZWZhdWx0KHZhbHVlKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IHRoaXMuZWFjaCh2YWx1ZSA9PSBudWxsID8gaHRtbFJlbW92ZSA6ICh0eXBlb2YgdmFsdWUgPT09ICJmdW5jdGlvbiIgPyBodG1sRnVuY3Rpb24gOiBodG1sQ29uc3RhbnQpKHZhbHVlKSkgOiB0aGlzLm5vZGUoKS5pbm5lckhUTUw7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3Rpb24vcmFpc2UuanMKICBmdW5jdGlvbiByYWlzZSgpIHsKICAgIGlmICh0aGlzLm5leHRTaWJsaW5nKQogICAgICB0aGlzLnBhcmVudE5vZGUuYXBwZW5kQ2hpbGQodGhpcyk7CiAgfQogIGZ1bmN0aW9uIHJhaXNlX2RlZmF1bHQoKSB7CiAgICByZXR1cm4gdGhpcy5lYWNoKHJhaXNlKTsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9kMy1zZWxlY3Rpb24vc3JjL3NlbGVjdGlvbi9sb3dlci5qcwogIGZ1bmN0aW9uIGxvd2VyKCkgewogICAgaWYgKHRoaXMucHJldmlvdXNTaWJsaW5nKQogICAgICB0aGlzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHRoaXMsIHRoaXMucGFyZW50Tm9kZS5maXJzdENoaWxkKTsKICB9CiAgZnVuY3Rpb24gbG93ZXJfZGVmYXVsdCgpIHsKICAgIHJldHVybiB0aGlzLmVhY2gobG93ZXIpOwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvc2VsZWN0aW9uL2FwcGVuZC5qcwogIGZ1bmN0aW9uIGFwcGVuZF9kZWZhdWx0KG5hbWUpIHsKICAgIHZhciBjcmVhdGUyID0gdHlwZW9mIG5hbWUgPT09ICJmdW5jdGlvbiIgPyBuYW1lIDogY3JlYXRvcl9kZWZhdWx0KG5hbWUpOwogICAgcmV0dXJuIHRoaXMuc2VsZWN0KGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5hcHBlbmRDaGlsZChjcmVhdGUyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgfSk7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3Rpb24vaW5zZXJ0LmpzCiAgZnVuY3Rpb24gY29uc3RhbnROdWxsKCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIGZ1bmN0aW9uIGluc2VydF9kZWZhdWx0KG5hbWUsIGJlZm9yZSkgewogICAgdmFyIGNyZWF0ZTIgPSB0eXBlb2YgbmFtZSA9PT0gImZ1bmN0aW9uIiA/IG5hbWUgOiBjcmVhdG9yX2RlZmF1bHQobmFtZSksIHNlbGVjdCA9IGJlZm9yZSA9PSBudWxsID8gY29uc3RhbnROdWxsIDogdHlwZW9mIGJlZm9yZSA9PT0gImZ1bmN0aW9uIiA/IGJlZm9yZSA6IHNlbGVjdG9yX2RlZmF1bHQoYmVmb3JlKTsKICAgIHJldHVybiB0aGlzLnNlbGVjdChmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuaW5zZXJ0QmVmb3JlKGNyZWF0ZTIuYXBwbHkodGhpcywgYXJndW1lbnRzKSwgc2VsZWN0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgbnVsbCk7CiAgICB9KTsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9kMy1zZWxlY3Rpb24vc3JjL3NlbGVjdGlvbi9yZW1vdmUuanMKICBmdW5jdGlvbiByZW1vdmUoKSB7CiAgICB2YXIgcGFyZW50ID0gdGhpcy5wYXJlbnROb2RlOwogICAgaWYgKHBhcmVudCkKICAgICAgcGFyZW50LnJlbW92ZUNoaWxkKHRoaXMpOwogIH0KICBmdW5jdGlvbiByZW1vdmVfZGVmYXVsdCgpIHsKICAgIHJldHVybiB0aGlzLmVhY2gocmVtb3ZlKTsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9kMy1zZWxlY3Rpb24vc3JjL3NlbGVjdGlvbi9jbG9uZS5qcwogIGZ1bmN0aW9uIHNlbGVjdGlvbl9jbG9uZVNoYWxsb3coKSB7CiAgICB2YXIgY2xvbmUgPSB0aGlzLmNsb25lTm9kZShmYWxzZSksIHBhcmVudCA9IHRoaXMucGFyZW50Tm9kZTsKICAgIHJldHVybiBwYXJlbnQgPyBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNsb25lLCB0aGlzLm5leHRTaWJsaW5nKSA6IGNsb25lOwogIH0KICBmdW5jdGlvbiBzZWxlY3Rpb25fY2xvbmVEZWVwKCkgewogICAgdmFyIGNsb25lID0gdGhpcy5jbG9uZU5vZGUodHJ1ZSksIHBhcmVudCA9IHRoaXMucGFyZW50Tm9kZTsKICAgIHJldHVybiBwYXJlbnQgPyBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNsb25lLCB0aGlzLm5leHRTaWJsaW5nKSA6IGNsb25lOwogIH0KICBmdW5jdGlvbiBjbG9uZV9kZWZhdWx0KGRlZXApIHsKICAgIHJldHVybiB0aGlzLnNlbGVjdChkZWVwID8gc2VsZWN0aW9uX2Nsb25lRGVlcCA6IHNlbGVjdGlvbl9jbG9uZVNoYWxsb3cpOwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvc2VsZWN0aW9uL2RhdHVtLmpzCiAgZnVuY3Rpb24gZGF0dW1fZGVmYXVsdCh2YWx1ZSkgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyB0aGlzLnByb3BlcnR5KCJfX2RhdGFfXyIsIHZhbHVlKSA6IHRoaXMubm9kZSgpLl9fZGF0YV9fOwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvc2VsZWN0aW9uL29uLmpzCiAgZnVuY3Rpb24gY29udGV4dExpc3RlbmVyKGxpc3RlbmVyKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgbGlzdGVuZXIuY2FsbCh0aGlzLCBldmVudCwgdGhpcy5fX2RhdGFfXyk7CiAgICB9OwogIH0KICBmdW5jdGlvbiBwYXJzZVR5cGVuYW1lczIodHlwZW5hbWVzKSB7CiAgICByZXR1cm4gdHlwZW5hbWVzLnRyaW0oKS5zcGxpdCgvXnxccysvKS5tYXAoZnVuY3Rpb24odCkgewogICAgICB2YXIgbmFtZSA9ICIiLCBpID0gdC5pbmRleE9mKCIuIik7CiAgICAgIGlmIChpID49IDApCiAgICAgICAgbmFtZSA9IHQuc2xpY2UoaSArIDEpLCB0ID0gdC5zbGljZSgwLCBpKTsKICAgICAgcmV0dXJuIHsgdHlwZTogdCwgbmFtZSB9OwogICAgfSk7CiAgfQogIGZ1bmN0aW9uIG9uUmVtb3ZlKHR5cGVuYW1lKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBvbiA9IHRoaXMuX19vbjsKICAgICAgaWYgKCFvbikKICAgICAgICByZXR1cm47CiAgICAgIGZvciAodmFyIGogPSAwLCBpID0gLTEsIG0yID0gb24ubGVuZ3RoLCBvOyBqIDwgbTI7ICsraikgewogICAgICAgIGlmIChvID0gb25bal0sICghdHlwZW5hbWUudHlwZSB8fCBvLnR5cGUgPT09IHR5cGVuYW1lLnR5cGUpICYmIG8ubmFtZSA9PT0gdHlwZW5hbWUubmFtZSkgewogICAgICAgICAgdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKG8udHlwZSwgby5saXN0ZW5lciwgby5vcHRpb25zKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgb25bKytpXSA9IG87CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICgrK2kpCiAgICAgICAgb24ubGVuZ3RoID0gaTsKICAgICAgZWxzZQogICAgICAgIGRlbGV0ZSB0aGlzLl9fb247CiAgICB9OwogIH0KICBmdW5jdGlvbiBvbkFkZCh0eXBlbmFtZSwgdmFsdWUsIG9wdGlvbnMpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIG9uID0gdGhpcy5fX29uLCBvLCBsaXN0ZW5lciA9IGNvbnRleHRMaXN0ZW5lcih2YWx1ZSk7CiAgICAgIGlmIChvbikKICAgICAgICBmb3IgKHZhciBqID0gMCwgbTIgPSBvbi5sZW5ndGg7IGogPCBtMjsgKytqKSB7CiAgICAgICAgICBpZiAoKG8gPSBvbltqXSkudHlwZSA9PT0gdHlwZW5hbWUudHlwZSAmJiBvLm5hbWUgPT09IHR5cGVuYW1lLm5hbWUpIHsKICAgICAgICAgICAgdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKG8udHlwZSwgby5saXN0ZW5lciwgby5vcHRpb25zKTsKICAgICAgICAgICAgdGhpcy5hZGRFdmVudExpc3RlbmVyKG8udHlwZSwgby5saXN0ZW5lciA9IGxpc3RlbmVyLCBvLm9wdGlvbnMgPSBvcHRpb25zKTsKICAgICAgICAgICAgby52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB0aGlzLmFkZEV2ZW50TGlzdGVuZXIodHlwZW5hbWUudHlwZSwgbGlzdGVuZXIsIG9wdGlvbnMpOwogICAgICBvID0geyB0eXBlOiB0eXBlbmFtZS50eXBlLCBuYW1lOiB0eXBlbmFtZS5uYW1lLCB2YWx1ZSwgbGlzdGVuZXIsIG9wdGlvbnMgfTsKICAgICAgaWYgKCFvbikKICAgICAgICB0aGlzLl9fb24gPSBbb107CiAgICAgIGVsc2UKICAgICAgICBvbi5wdXNoKG8pOwogICAgfTsKICB9CiAgZnVuY3Rpb24gb25fZGVmYXVsdCh0eXBlbmFtZSwgdmFsdWUsIG9wdGlvbnMpIHsKICAgIHZhciB0eXBlbmFtZXMgPSBwYXJzZVR5cGVuYW1lczIodHlwZW5hbWUgKyAiIiksIGksIG4gPSB0eXBlbmFtZXMubGVuZ3RoLCB0OwogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPCAyKSB7CiAgICAgIHZhciBvbiA9IHRoaXMubm9kZSgpLl9fb247CiAgICAgIGlmIChvbikKICAgICAgICBmb3IgKHZhciBqID0gMCwgbTIgPSBvbi5sZW5ndGgsIG87IGogPCBtMjsgKytqKSB7CiAgICAgICAgICBmb3IgKGkgPSAwLCBvID0gb25bal07IGkgPCBuOyArK2kpIHsKICAgICAgICAgICAgaWYgKCh0ID0gdHlwZW5hbWVzW2ldKS50eXBlID09PSBvLnR5cGUgJiYgdC5uYW1lID09PSBvLm5hbWUpIHsKICAgICAgICAgICAgICByZXR1cm4gby52YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgcmV0dXJuOwogICAgfQogICAgb24gPSB2YWx1ZSA/IG9uQWRkIDogb25SZW1vdmU7CiAgICBmb3IgKGkgPSAwOyBpIDwgbjsgKytpKQogICAgICB0aGlzLmVhY2gob24odHlwZW5hbWVzW2ldLCB2YWx1ZSwgb3B0aW9ucykpOwogICAgcmV0dXJuIHRoaXM7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3Rpb24vZGlzcGF0Y2guanMKICBmdW5jdGlvbiBkaXNwYXRjaEV2ZW50KG5vZGUsIHR5cGUyLCBwYXJhbXMpIHsKICAgIHZhciB3aW5kb3cyID0gd2luZG93X2RlZmF1bHQobm9kZSksIGV2ZW50ID0gd2luZG93Mi5DdXN0b21FdmVudDsKICAgIGlmICh0eXBlb2YgZXZlbnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgZXZlbnQgPSBuZXcgZXZlbnQodHlwZTIsIHBhcmFtcyk7CiAgICB9IGVsc2UgewogICAgICBldmVudCA9IHdpbmRvdzIuZG9jdW1lbnQuY3JlYXRlRXZlbnQoIkV2ZW50Iik7CiAgICAgIGlmIChwYXJhbXMpCiAgICAgICAgZXZlbnQuaW5pdEV2ZW50KHR5cGUyLCBwYXJhbXMuYnViYmxlcywgcGFyYW1zLmNhbmNlbGFibGUpLCBldmVudC5kZXRhaWwgPSBwYXJhbXMuZGV0YWlsOwogICAgICBlbHNlCiAgICAgICAgZXZlbnQuaW5pdEV2ZW50KHR5cGUyLCBmYWxzZSwgZmFsc2UpOwogICAgfQogICAgbm9kZS5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICB9CiAgZnVuY3Rpb24gZGlzcGF0Y2hDb25zdGFudCh0eXBlMiwgcGFyYW1zKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBkaXNwYXRjaEV2ZW50KHRoaXMsIHR5cGUyLCBwYXJhbXMpOwogICAgfTsKICB9CiAgZnVuY3Rpb24gZGlzcGF0Y2hGdW5jdGlvbih0eXBlMiwgcGFyYW1zKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBkaXNwYXRjaEV2ZW50KHRoaXMsIHR5cGUyLCBwYXJhbXMuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICB9OwogIH0KICBmdW5jdGlvbiBkaXNwYXRjaF9kZWZhdWx0Mih0eXBlMiwgcGFyYW1zKSB7CiAgICByZXR1cm4gdGhpcy5lYWNoKCh0eXBlb2YgcGFyYW1zID09PSAiZnVuY3Rpb24iID8gZGlzcGF0Y2hGdW5jdGlvbiA6IGRpc3BhdGNoQ29uc3RhbnQpKHR5cGUyLCBwYXJhbXMpKTsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9kMy1zZWxlY3Rpb24vc3JjL3NlbGVjdGlvbi9pdGVyYXRvci5qcwogIGZ1bmN0aW9uKiBpdGVyYXRvcl9kZWZhdWx0KCkgewogICAgZm9yICh2YXIgZ3JvdXBzID0gdGhpcy5fZ3JvdXBzLCBqID0gMCwgbTIgPSBncm91cHMubGVuZ3RoOyBqIDwgbTI7ICsraikgewogICAgICBmb3IgKHZhciBncm91cCA9IGdyb3Vwc1tqXSwgaSA9IDAsIG4gPSBncm91cC5sZW5ndGgsIG5vZGU7IGkgPCBuOyArK2kpIHsKICAgICAgICBpZiAobm9kZSA9IGdyb3VwW2ldKQogICAgICAgICAgeWllbGQgbm9kZTsKICAgICAgfQogICAgfQogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvc2VsZWN0aW9uL2luZGV4LmpzCiAgdmFyIHJvb3QgPSBbbnVsbF07CiAgZnVuY3Rpb24gU2VsZWN0aW9uKGdyb3VwcywgcGFyZW50cykgewogICAgdGhpcy5fZ3JvdXBzID0gZ3JvdXBzOwogICAgdGhpcy5fcGFyZW50cyA9IHBhcmVudHM7CiAgfQogIGZ1bmN0aW9uIHNlbGVjdGlvbigpIHsKICAgIHJldHVybiBuZXcgU2VsZWN0aW9uKFtbZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50XV0sIHJvb3QpOwogIH0KICBmdW5jdGlvbiBzZWxlY3Rpb25fc2VsZWN0aW9uKCkgewogICAgcmV0dXJuIHRoaXM7CiAgfQogIFNlbGVjdGlvbi5wcm90b3R5cGUgPSBzZWxlY3Rpb24ucHJvdG90eXBlID0gewogICAgY29uc3RydWN0b3I6IFNlbGVjdGlvbiwKICAgIHNlbGVjdDogc2VsZWN0X2RlZmF1bHQsCiAgICBzZWxlY3RBbGw6IHNlbGVjdEFsbF9kZWZhdWx0LAogICAgc2VsZWN0Q2hpbGQ6IHNlbGVjdENoaWxkX2RlZmF1bHQsCiAgICBzZWxlY3RDaGlsZHJlbjogc2VsZWN0Q2hpbGRyZW5fZGVmYXVsdCwKICAgIGZpbHRlcjogZmlsdGVyX2RlZmF1bHQsCiAgICBkYXRhOiBkYXRhX2RlZmF1bHQsCiAgICBlbnRlcjogZW50ZXJfZGVmYXVsdCwKICAgIGV4aXQ6IGV4aXRfZGVmYXVsdCwKICAgIGpvaW46IGpvaW5fZGVmYXVsdCwKICAgIG1lcmdlOiBtZXJnZV9kZWZhdWx0LAogICAgc2VsZWN0aW9uOiBzZWxlY3Rpb25fc2VsZWN0aW9uLAogICAgb3JkZXI6IG9yZGVyX2RlZmF1bHQsCiAgICBzb3J0OiBzb3J0X2RlZmF1bHQsCiAgICBjYWxsOiBjYWxsX2RlZmF1bHQsCiAgICBub2Rlczogbm9kZXNfZGVmYXVsdCwKICAgIG5vZGU6IG5vZGVfZGVmYXVsdCwKICAgIHNpemU6IHNpemVfZGVmYXVsdCwKICAgIGVtcHR5OiBlbXB0eV9kZWZhdWx0LAogICAgZWFjaDogZWFjaF9kZWZhdWx0LAogICAgYXR0cjogYXR0cl9kZWZhdWx0LAogICAgc3R5bGU6IHN0eWxlX2RlZmF1bHQsCiAgICBwcm9wZXJ0eTogcHJvcGVydHlfZGVmYXVsdCwKICAgIGNsYXNzZWQ6IGNsYXNzZWRfZGVmYXVsdCwKICAgIHRleHQ6IHRleHRfZGVmYXVsdCwKICAgIGh0bWw6IGh0bWxfZGVmYXVsdCwKICAgIHJhaXNlOiByYWlzZV9kZWZhdWx0LAogICAgbG93ZXI6IGxvd2VyX2RlZmF1bHQsCiAgICBhcHBlbmQ6IGFwcGVuZF9kZWZhdWx0LAogICAgaW5zZXJ0OiBpbnNlcnRfZGVmYXVsdCwKICAgIHJlbW92ZTogcmVtb3ZlX2RlZmF1bHQsCiAgICBjbG9uZTogY2xvbmVfZGVmYXVsdCwKICAgIGRhdHVtOiBkYXR1bV9kZWZhdWx0LAogICAgb246IG9uX2RlZmF1bHQsCiAgICBkaXNwYXRjaDogZGlzcGF0Y2hfZGVmYXVsdDIsCiAgICBbU3ltYm9sLml0ZXJhdG9yXTogaXRlcmF0b3JfZGVmYXVsdAogIH07CiAgdmFyIHNlbGVjdGlvbl9kZWZhdWx0ID0gc2VsZWN0aW9uOwoKICAvLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3QuanMKICBmdW5jdGlvbiBzZWxlY3RfZGVmYXVsdDIoc2VsZWN0b3IpIHsKICAgIHJldHVybiB0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciID8gbmV3IFNlbGVjdGlvbihbW2RvY3VtZW50LnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0b3IpXV0sIFtkb2N1bWVudC5kb2N1bWVudEVsZW1lbnRdKSA6IG5ldyBTZWxlY3Rpb24oW1tzZWxlY3Rvcl1dLCByb290KTsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9kMy1zZWxlY3Rpb24vc3JjL3NvdXJjZUV2ZW50LmpzCiAgZnVuY3Rpb24gc291cmNlRXZlbnRfZGVmYXVsdChldmVudCkgewogICAgbGV0IHNvdXJjZUV2ZW50OwogICAgd2hpbGUgKHNvdXJjZUV2ZW50ID0gZXZlbnQuc291cmNlRXZlbnQpCiAgICAgIGV2ZW50ID0gc291cmNlRXZlbnQ7CiAgICByZXR1cm4gZXZlbnQ7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9wb2ludGVyLmpzCiAgZnVuY3Rpb24gcG9pbnRlcl9kZWZhdWx0KGV2ZW50LCBub2RlKSB7CiAgICBldmVudCA9IHNvdXJjZUV2ZW50X2RlZmF1bHQoZXZlbnQpOwogICAgaWYgKG5vZGUgPT09IHZvaWQgMCkKICAgICAgbm9kZSA9IGV2ZW50LmN1cnJlbnRUYXJnZXQ7CiAgICBpZiAobm9kZSkgewogICAgICB2YXIgc3ZnID0gbm9kZS5vd25lclNWR0VsZW1lbnQgfHwgbm9kZTsKICAgICAgaWYgKHN2Zy5jcmVhdGVTVkdQb2ludCkgewogICAgICAgIHZhciBwb2ludCA9IHN2Zy5jcmVhdGVTVkdQb2ludCgpOwogICAgICAgIHBvaW50LnggPSBldmVudC5jbGllbnRYLCBwb2ludC55ID0gZXZlbnQuY2xpZW50WTsKICAgICAgICBwb2ludCA9IHBvaW50Lm1hdHJpeFRyYW5zZm9ybShub2RlLmdldFNjcmVlbkNUTSgpLmludmVyc2UoKSk7CiAgICAgICAgcmV0dXJuIFtwb2ludC54LCBwb2ludC55XTsKICAgICAgfQogICAgICBpZiAobm9kZS5nZXRCb3VuZGluZ0NsaWVudFJlY3QpIHsKICAgICAgICB2YXIgcmVjdCA9IG5vZGUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgICAgcmV0dXJuIFtldmVudC5jbGllbnRYIC0gcmVjdC5sZWZ0IC0gbm9kZS5jbGllbnRMZWZ0LCBldmVudC5jbGllbnRZIC0gcmVjdC50b3AgLSBub2RlLmNsaWVudFRvcF07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBbZXZlbnQucGFnZVgsIGV2ZW50LnBhZ2VZXTsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9kMy1kcmFnL3NyYy9ub2V2ZW50LmpzCiAgdmFyIG5vbnBhc3NpdmUgPSB7IHBhc3NpdmU6IGZhbHNlIH07CiAgdmFyIG5vbnBhc3NpdmVjYXB0dXJlID0geyBjYXB0dXJlOiB0cnVlLCBwYXNzaXZlOiBmYWxzZSB9OwogIGZ1bmN0aW9uIG5vcHJvcGFnYXRpb24oZXZlbnQpIHsKICAgIGV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwogIH0KICBmdW5jdGlvbiBub2V2ZW50X2RlZmF1bHQoZXZlbnQpIHsKICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICBldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9kMy1kcmFnL3NyYy9ub2RyYWcuanMKICBmdW5jdGlvbiBub2RyYWdfZGVmYXVsdCh2aWV3KSB7CiAgICB2YXIgcm9vdDIgPSB2aWV3LmRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwgc2VsZWN0aW9uMiA9IHNlbGVjdF9kZWZhdWx0Mih2aWV3KS5vbigiZHJhZ3N0YXJ0LmRyYWciLCBub2V2ZW50X2RlZmF1bHQsIG5vbnBhc3NpdmVjYXB0dXJlKTsKICAgIGlmICgib25zZWxlY3RzdGFydCIgaW4gcm9vdDIpIHsKICAgICAgc2VsZWN0aW9uMi5vbigic2VsZWN0c3RhcnQuZHJhZyIsIG5vZXZlbnRfZGVmYXVsdCwgbm9ucGFzc2l2ZWNhcHR1cmUpOwogICAgfSBlbHNlIHsKICAgICAgcm9vdDIuX19ub3NlbGVjdCA9IHJvb3QyLnN0eWxlLk1velVzZXJTZWxlY3Q7CiAgICAgIHJvb3QyLnN0eWxlLk1velVzZXJTZWxlY3QgPSAibm9uZSI7CiAgICB9CiAgfQogIGZ1bmN0aW9uIHllc2RyYWcodmlldywgbm9jbGljaykgewogICAgdmFyIHJvb3QyID0gdmlldy5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsIHNlbGVjdGlvbjIgPSBzZWxlY3RfZGVmYXVsdDIodmlldykub24oImRyYWdzdGFydC5kcmFnIiwgbnVsbCk7CiAgICBpZiAobm9jbGljaykgewogICAgICBzZWxlY3Rpb24yLm9uKCJjbGljay5kcmFnIiwgbm9ldmVudF9kZWZhdWx0LCBub25wYXNzaXZlY2FwdHVyZSk7CiAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZWN0aW9uMi5vbigiY2xpY2suZHJhZyIsIG51bGwpOwogICAgICB9LCAwKTsKICAgIH0KICAgIGlmICgib25zZWxlY3RzdGFydCIgaW4gcm9vdDIpIHsKICAgICAgc2VsZWN0aW9uMi5vbigic2VsZWN0c3RhcnQuZHJhZyIsIG51bGwpOwogICAgfSBlbHNlIHsKICAgICAgcm9vdDIuc3R5bGUuTW96VXNlclNlbGVjdCA9IHJvb3QyLl9fbm9zZWxlY3Q7CiAgICAgIGRlbGV0ZSByb290Mi5fX25vc2VsZWN0OwogICAgfQogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLWRyYWcvc3JjL2NvbnN0YW50LmpzCiAgdmFyIGNvbnN0YW50X2RlZmF1bHQyID0gKHgyKSA9PiAoKSA9PiB4MjsKCiAgLy8gbm9kZV9tb2R1bGVzL2QzLWRyYWcvc3JjL2V2ZW50LmpzCiAgZnVuY3Rpb24gRHJhZ0V2ZW50KHR5cGUyLCB7CiAgICBzb3VyY2VFdmVudCwKICAgIHN1YmplY3QsCiAgICB0YXJnZXQsCiAgICBpZGVudGlmaWVyLAogICAgYWN0aXZlLAogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIGR4LAogICAgZHksCiAgICBkaXNwYXRjaDogZGlzcGF0Y2gyCiAgfSkgewogICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXModGhpcywgewogICAgICB0eXBlOiB7IHZhbHVlOiB0eXBlMiwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0sCiAgICAgIHNvdXJjZUV2ZW50OiB7IHZhbHVlOiBzb3VyY2VFdmVudCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0sCiAgICAgIHN1YmplY3Q6IHsgdmFsdWU6IHN1YmplY3QsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSB9LAogICAgICB0YXJnZXQ6IHsgdmFsdWU6IHRhcmdldCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0sCiAgICAgIGlkZW50aWZpZXI6IHsgdmFsdWU6IGlkZW50aWZpZXIsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSB9LAogICAgICBhY3RpdmU6IHsgdmFsdWU6IGFjdGl2ZSwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0sCiAgICAgIHg6IHsgdmFsdWU6IHgyLCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUgfSwKICAgICAgeTogeyB2YWx1ZTogeTIsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSB9LAogICAgICBkeDogeyB2YWx1ZTogZHgsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSB9LAogICAgICBkeTogeyB2YWx1ZTogZHksIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSB9LAogICAgICBfOiB7IHZhbHVlOiBkaXNwYXRjaDIgfQogICAgfSk7CiAgfQogIERyYWdFdmVudC5wcm90b3R5cGUub24gPSBmdW5jdGlvbigpIHsKICAgIHZhciB2YWx1ZSA9IHRoaXMuXy5vbi5hcHBseSh0aGlzLl8sIGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdmFsdWUgPT09IHRoaXMuXyA/IHRoaXMgOiB2YWx1ZTsKICB9OwoKICAvLyBub2RlX21vZHVsZXMvZDMtZHJhZy9zcmMvZHJhZy5qcwogIGZ1bmN0aW9uIGRlZmF1bHRGaWx0ZXIoZXZlbnQpIHsKICAgIHJldHVybiAhZXZlbnQuY3RybEtleSAmJiAhZXZlbnQuYnV0dG9uOwogIH0KICBmdW5jdGlvbiBkZWZhdWx0Q29udGFpbmVyKCkgewogICAgcmV0dXJuIHRoaXMucGFyZW50Tm9kZTsKICB9CiAgZnVuY3Rpb24gZGVmYXVsdFN1YmplY3QoZXZlbnQsIGQpIHsKICAgIHJldHVybiBkID09IG51bGwgPyB7IHg6IGV2ZW50LngsIHk6IGV2ZW50LnkgfSA6IGQ7CiAgfQogIGZ1bmN0aW9uIGRlZmF1bHRUb3VjaGFibGUoKSB7CiAgICByZXR1cm4gbmF2aWdhdG9yLm1heFRvdWNoUG9pbnRzIHx8ICJvbnRvdWNoc3RhcnQiIGluIHRoaXM7CiAgfQogIGZ1bmN0aW9uIGRyYWdfZGVmYXVsdCgpIHsKICAgIHZhciBmaWx0ZXIyID0gZGVmYXVsdEZpbHRlciwgY29udGFpbmVyID0gZGVmYXVsdENvbnRhaW5lciwgc3ViamVjdCA9IGRlZmF1bHRTdWJqZWN0LCB0b3VjaGFibGUgPSBkZWZhdWx0VG91Y2hhYmxlLCBnZXN0dXJlcyA9IHt9LCBsaXN0ZW5lcnMgPSBkaXNwYXRjaF9kZWZhdWx0KCJzdGFydCIsICJkcmFnIiwgImVuZCIpLCBhY3RpdmUgPSAwLCBtb3VzZWRvd254LCBtb3VzZWRvd255LCBtb3VzZW1vdmluZywgdG91Y2hlbmRpbmcsIGNsaWNrRGlzdGFuY2UyID0gMDsKICAgIGZ1bmN0aW9uIGRyYWcyKHNlbGVjdGlvbjIpIHsKICAgICAgc2VsZWN0aW9uMi5vbigibW91c2Vkb3duLmRyYWciLCBtb3VzZWRvd25lZCkuZmlsdGVyKHRvdWNoYWJsZSkub24oInRvdWNoc3RhcnQuZHJhZyIsIHRvdWNoc3RhcnRlZCkub24oInRvdWNobW92ZS5kcmFnIiwgdG91Y2htb3ZlZCwgbm9ucGFzc2l2ZSkub24oInRvdWNoZW5kLmRyYWcgdG91Y2hjYW5jZWwuZHJhZyIsIHRvdWNoZW5kZWQpLnN0eWxlKCJ0b3VjaC1hY3Rpb24iLCAibm9uZSIpLnN0eWxlKCItd2Via2l0LXRhcC1oaWdobGlnaHQtY29sb3IiLCAicmdiYSgwLDAsMCwwKSIpOwogICAgfQogICAgZnVuY3Rpb24gbW91c2Vkb3duZWQoZXZlbnQsIGQpIHsKICAgICAgaWYgKHRvdWNoZW5kaW5nIHx8ICFmaWx0ZXIyLmNhbGwodGhpcywgZXZlbnQsIGQpKQogICAgICAgIHJldHVybjsKICAgICAgdmFyIGdlc3R1cmUgPSBiZWZvcmVzdGFydCh0aGlzLCBjb250YWluZXIuY2FsbCh0aGlzLCBldmVudCwgZCksIGV2ZW50LCBkLCAibW91c2UiKTsKICAgICAgaWYgKCFnZXN0dXJlKQogICAgICAgIHJldHVybjsKICAgICAgc2VsZWN0X2RlZmF1bHQyKGV2ZW50LnZpZXcpLm9uKCJtb3VzZW1vdmUuZHJhZyIsIG1vdXNlbW92ZWQsIG5vbnBhc3NpdmVjYXB0dXJlKS5vbigibW91c2V1cC5kcmFnIiwgbW91c2V1cHBlZCwgbm9ucGFzc2l2ZWNhcHR1cmUpOwogICAgICBub2RyYWdfZGVmYXVsdChldmVudC52aWV3KTsKICAgICAgbm9wcm9wYWdhdGlvbihldmVudCk7CiAgICAgIG1vdXNlbW92aW5nID0gZmFsc2U7CiAgICAgIG1vdXNlZG93bnggPSBldmVudC5jbGllbnRYOwogICAgICBtb3VzZWRvd255ID0gZXZlbnQuY2xpZW50WTsKICAgICAgZ2VzdHVyZSgic3RhcnQiLCBldmVudCk7CiAgICB9CiAgICBmdW5jdGlvbiBtb3VzZW1vdmVkKGV2ZW50KSB7CiAgICAgIG5vZXZlbnRfZGVmYXVsdChldmVudCk7CiAgICAgIGlmICghbW91c2Vtb3ZpbmcpIHsKICAgICAgICB2YXIgZHggPSBldmVudC5jbGllbnRYIC0gbW91c2Vkb3dueCwgZHkgPSBldmVudC5jbGllbnRZIC0gbW91c2Vkb3dueTsKICAgICAgICBtb3VzZW1vdmluZyA9IGR4ICogZHggKyBkeSAqIGR5ID4gY2xpY2tEaXN0YW5jZTI7CiAgICAgIH0KICAgICAgZ2VzdHVyZXMubW91c2UoImRyYWciLCBldmVudCk7CiAgICB9CiAgICBmdW5jdGlvbiBtb3VzZXVwcGVkKGV2ZW50KSB7CiAgICAgIHNlbGVjdF9kZWZhdWx0MihldmVudC52aWV3KS5vbigibW91c2Vtb3ZlLmRyYWcgbW91c2V1cC5kcmFnIiwgbnVsbCk7CiAgICAgIHllc2RyYWcoZXZlbnQudmlldywgbW91c2Vtb3ZpbmcpOwogICAgICBub2V2ZW50X2RlZmF1bHQoZXZlbnQpOwogICAgICBnZXN0dXJlcy5tb3VzZSgiZW5kIiwgZXZlbnQpOwogICAgfQogICAgZnVuY3Rpb24gdG91Y2hzdGFydGVkKGV2ZW50LCBkKSB7CiAgICAgIGlmICghZmlsdGVyMi5jYWxsKHRoaXMsIGV2ZW50LCBkKSkKICAgICAgICByZXR1cm47CiAgICAgIHZhciB0b3VjaGVzID0gZXZlbnQuY2hhbmdlZFRvdWNoZXMsIGMyID0gY29udGFpbmVyLmNhbGwodGhpcywgZXZlbnQsIGQpLCBuID0gdG91Y2hlcy5sZW5ndGgsIGksIGdlc3R1cmU7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBuOyArK2kpIHsKICAgICAgICBpZiAoZ2VzdHVyZSA9IGJlZm9yZXN0YXJ0KHRoaXMsIGMyLCBldmVudCwgZCwgdG91Y2hlc1tpXS5pZGVudGlmaWVyLCB0b3VjaGVzW2ldKSkgewogICAgICAgICAgbm9wcm9wYWdhdGlvbihldmVudCk7CiAgICAgICAgICBnZXN0dXJlKCJzdGFydCIsIGV2ZW50LCB0b3VjaGVzW2ldKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIHRvdWNobW92ZWQoZXZlbnQpIHsKICAgICAgdmFyIHRvdWNoZXMgPSBldmVudC5jaGFuZ2VkVG91Y2hlcywgbiA9IHRvdWNoZXMubGVuZ3RoLCBpLCBnZXN0dXJlOwogICAgICBmb3IgKGkgPSAwOyBpIDwgbjsgKytpKSB7CiAgICAgICAgaWYgKGdlc3R1cmUgPSBnZXN0dXJlc1t0b3VjaGVzW2ldLmlkZW50aWZpZXJdKSB7CiAgICAgICAgICBub2V2ZW50X2RlZmF1bHQoZXZlbnQpOwogICAgICAgICAgZ2VzdHVyZSgiZHJhZyIsIGV2ZW50LCB0b3VjaGVzW2ldKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIHRvdWNoZW5kZWQoZXZlbnQpIHsKICAgICAgdmFyIHRvdWNoZXMgPSBldmVudC5jaGFuZ2VkVG91Y2hlcywgbiA9IHRvdWNoZXMubGVuZ3RoLCBpLCBnZXN0dXJlOwogICAgICBpZiAodG91Y2hlbmRpbmcpCiAgICAgICAgY2xlYXJUaW1lb3V0KHRvdWNoZW5kaW5nKTsKICAgICAgdG91Y2hlbmRpbmcgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIHRvdWNoZW5kaW5nID0gbnVsbDsKICAgICAgfSwgNTAwKTsKICAgICAgZm9yIChpID0gMDsgaSA8IG47ICsraSkgewogICAgICAgIGlmIChnZXN0dXJlID0gZ2VzdHVyZXNbdG91Y2hlc1tpXS5pZGVudGlmaWVyXSkgewogICAgICAgICAgbm9wcm9wYWdhdGlvbihldmVudCk7CiAgICAgICAgICBnZXN0dXJlKCJlbmQiLCBldmVudCwgdG91Y2hlc1tpXSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBiZWZvcmVzdGFydCh0aGF0LCBjb250YWluZXIyLCBldmVudCwgZCwgaWRlbnRpZmllciwgdG91Y2gpIHsKICAgICAgdmFyIGRpc3BhdGNoMiA9IGxpc3RlbmVycy5jb3B5KCksIHAgPSBwb2ludGVyX2RlZmF1bHQodG91Y2ggfHwgZXZlbnQsIGNvbnRhaW5lcjIpLCBkeCwgZHksIHM7CiAgICAgIGlmICgocyA9IHN1YmplY3QuY2FsbCh0aGF0LCBuZXcgRHJhZ0V2ZW50KCJiZWZvcmVzdGFydCIsIHsKICAgICAgICBzb3VyY2VFdmVudDogZXZlbnQsCiAgICAgICAgdGFyZ2V0OiBkcmFnMiwKICAgICAgICBpZGVudGlmaWVyLAogICAgICAgIGFjdGl2ZSwKICAgICAgICB4OiBwWzBdLAogICAgICAgIHk6IHBbMV0sCiAgICAgICAgZHg6IDAsCiAgICAgICAgZHk6IDAsCiAgICAgICAgZGlzcGF0Y2g6IGRpc3BhdGNoMgogICAgICB9KSwgZCkpID09IG51bGwpCiAgICAgICAgcmV0dXJuOwogICAgICBkeCA9IHMueCAtIHBbMF0gfHwgMDsKICAgICAgZHkgPSBzLnkgLSBwWzFdIHx8IDA7CiAgICAgIHJldHVybiBmdW5jdGlvbiBnZXN0dXJlKHR5cGUyLCBldmVudDIsIHRvdWNoMikgewogICAgICAgIHZhciBwMCA9IHAsIG47CiAgICAgICAgc3dpdGNoICh0eXBlMikgewogICAgICAgICAgY2FzZSAic3RhcnQiOgogICAgICAgICAgICBnZXN0dXJlc1tpZGVudGlmaWVyXSA9IGdlc3R1cmUsIG4gPSBhY3RpdmUrKzsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICBkZWxldGUgZ2VzdHVyZXNbaWRlbnRpZmllcl0sIC0tYWN0aXZlOwogICAgICAgICAgY2FzZSAiZHJhZyI6CiAgICAgICAgICAgIHAgPSBwb2ludGVyX2RlZmF1bHQodG91Y2gyIHx8IGV2ZW50MiwgY29udGFpbmVyMiksIG4gPSBhY3RpdmU7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICBkaXNwYXRjaDIuY2FsbCgKICAgICAgICAgIHR5cGUyLAogICAgICAgICAgdGhhdCwKICAgICAgICAgIG5ldyBEcmFnRXZlbnQodHlwZTIsIHsKICAgICAgICAgICAgc291cmNlRXZlbnQ6IGV2ZW50MiwKICAgICAgICAgICAgc3ViamVjdDogcywKICAgICAgICAgICAgdGFyZ2V0OiBkcmFnMiwKICAgICAgICAgICAgaWRlbnRpZmllciwKICAgICAgICAgICAgYWN0aXZlOiBuLAogICAgICAgICAgICB4OiBwWzBdICsgZHgsCiAgICAgICAgICAgIHk6IHBbMV0gKyBkeSwKICAgICAgICAgICAgZHg6IHBbMF0gLSBwMFswXSwKICAgICAgICAgICAgZHk6IHBbMV0gLSBwMFsxXSwKICAgICAgICAgICAgZGlzcGF0Y2g6IGRpc3BhdGNoMgogICAgICAgICAgfSksCiAgICAgICAgICBkCiAgICAgICAgKTsKICAgICAgfTsKICAgIH0KICAgIGRyYWcyLmZpbHRlciA9IGZ1bmN0aW9uKF8pIHsKICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoZmlsdGVyMiA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQyKCEhXyksIGRyYWcyKSA6IGZpbHRlcjI7CiAgICB9OwogICAgZHJhZzIuY29udGFpbmVyID0gZnVuY3Rpb24oXykgewogICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChjb250YWluZXIgPSB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0MihfKSwgZHJhZzIpIDogY29udGFpbmVyOwogICAgfTsKICAgIGRyYWcyLnN1YmplY3QgPSBmdW5jdGlvbihfKSB7CiAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHN1YmplY3QgPSB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0MihfKSwgZHJhZzIpIDogc3ViamVjdDsKICAgIH07CiAgICBkcmFnMi50b3VjaGFibGUgPSBmdW5jdGlvbihfKSB7CiAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHRvdWNoYWJsZSA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQyKCEhXyksIGRyYWcyKSA6IHRvdWNoYWJsZTsKICAgIH07CiAgICBkcmFnMi5vbiA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdmFsdWUgPSBsaXN0ZW5lcnMub24uYXBwbHkobGlzdGVuZXJzLCBhcmd1bWVudHMpOwogICAgICByZXR1cm4gdmFsdWUgPT09IGxpc3RlbmVycyA/IGRyYWcyIDogdmFsdWU7CiAgICB9OwogICAgZHJhZzIuY2xpY2tEaXN0YW5jZSA9IGZ1bmN0aW9uKF8pIHsKICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoY2xpY2tEaXN0YW5jZTIgPSAoXyA9ICtfKSAqIF8sIGRyYWcyKSA6IE1hdGguc3FydChjbGlja0Rpc3RhbmNlMik7CiAgICB9OwogICAgcmV0dXJuIGRyYWcyOwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLWNvbG9yL3NyYy9kZWZpbmUuanMKICBmdW5jdGlvbiBkZWZpbmVfZGVmYXVsdChjb25zdHJ1Y3RvciwgZmFjdG9yeSwgcHJvdG90eXBlKSB7CiAgICBjb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSBmYWN0b3J5LnByb3RvdHlwZSA9IHByb3RvdHlwZTsKICAgIHByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGNvbnN0cnVjdG9yOwogIH0KICBmdW5jdGlvbiBleHRlbmQocGFyZW50LCBkZWZpbml0aW9uKSB7CiAgICB2YXIgcHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShwYXJlbnQucHJvdG90eXBlKTsKICAgIGZvciAodmFyIGtleSBpbiBkZWZpbml0aW9uKQogICAgICBwcm90b3R5cGVba2V5XSA9IGRlZmluaXRpb25ba2V5XTsKICAgIHJldHVybiBwcm90b3R5cGU7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtY29sb3Ivc3JjL2NvbG9yLmpzCiAgZnVuY3Rpb24gQ29sb3IoKSB7CiAgfQogIHZhciBkYXJrZXIgPSAwLjc7CiAgdmFyIGJyaWdodGVyID0gMSAvIGRhcmtlcjsKICB2YXIgcmVJID0gIlxccyooWystXT9cXGQrKVxccyoiOwogIHZhciByZU4gPSAiXFxzKihbKy1dPyg/OlxcZCpcXC4pP1xcZCsoPzpbZUVdWystXT9cXGQrKT8pXFxzKiI7CiAgdmFyIHJlUCA9ICJcXHMqKFsrLV0/KD86XFxkKlxcLik/XFxkKyg/OltlRV1bKy1dP1xcZCspPyklXFxzKiI7CiAgdmFyIHJlSGV4ID0gL14jKFswLTlhLWZdezMsOH0pJC87CiAgdmFyIHJlUmdiSW50ZWdlciA9IG5ldyBSZWdFeHAoYF5yZ2JcXCgke3JlSX0sJHtyZUl9LCR7cmVJfVxcKSRgKTsKICB2YXIgcmVSZ2JQZXJjZW50ID0gbmV3IFJlZ0V4cChgXnJnYlxcKCR7cmVQfSwke3JlUH0sJHtyZVB9XFwpJGApOwogIHZhciByZVJnYmFJbnRlZ2VyID0gbmV3IFJlZ0V4cChgXnJnYmFcXCgke3JlSX0sJHtyZUl9LCR7cmVJfSwke3JlTn1cXCkkYCk7CiAgdmFyIHJlUmdiYVBlcmNlbnQgPSBuZXcgUmVnRXhwKGBecmdiYVxcKCR7cmVQfSwke3JlUH0sJHtyZVB9LCR7cmVOfVxcKSRgKTsKICB2YXIgcmVIc2xQZXJjZW50ID0gbmV3IFJlZ0V4cChgXmhzbFxcKCR7cmVOfSwke3JlUH0sJHtyZVB9XFwpJGApOwogIHZhciByZUhzbGFQZXJjZW50ID0gbmV3IFJlZ0V4cChgXmhzbGFcXCgke3JlTn0sJHtyZVB9LCR7cmVQfSwke3JlTn1cXCkkYCk7CiAgdmFyIG5hbWVkID0gewogICAgYWxpY2VibHVlOiAxNTc5MjM4MywKICAgIGFudGlxdWV3aGl0ZTogMTY0NDQzNzUsCiAgICBhcXVhOiA2NTUzNSwKICAgIGFxdWFtYXJpbmU6IDgzODg1NjQsCiAgICBhenVyZTogMTU3OTQxNzUsCiAgICBiZWlnZTogMTYxMTkyNjAsCiAgICBiaXNxdWU6IDE2NzcwMjQ0LAogICAgYmxhY2s6IDAsCiAgICBibGFuY2hlZGFsbW9uZDogMTY3NzIwNDUsCiAgICBibHVlOiAyNTUsCiAgICBibHVldmlvbGV0OiA5MDU1MjAyLAogICAgYnJvd246IDEwODI0MjM0LAogICAgYnVybHl3b29kOiAxNDU5NjIzMSwKICAgIGNhZGV0Ymx1ZTogNjI2NjUyOCwKICAgIGNoYXJ0cmV1c2U6IDgzODgzNTIsCiAgICBjaG9jb2xhdGU6IDEzNzg5NDcwLAogICAgY29yYWw6IDE2NzQ0MjcyLAogICAgY29ybmZsb3dlcmJsdWU6IDY1OTE5ODEsCiAgICBjb3Juc2lsazogMTY3NzUzODgsCiAgICBjcmltc29uOiAxNDQyMzEwMCwKICAgIGN5YW46IDY1NTM1LAogICAgZGFya2JsdWU6IDEzOSwKICAgIGRhcmtjeWFuOiAzNTcyMywKICAgIGRhcmtnb2xkZW5yb2Q6IDEyMDkyOTM5LAogICAgZGFya2dyYXk6IDExMTE5MDE3LAogICAgZGFya2dyZWVuOiAyNTYwMCwKICAgIGRhcmtncmV5OiAxMTExOTAxNywKICAgIGRhcmtraGFraTogMTI0MzMyNTksCiAgICBkYXJrbWFnZW50YTogOTEwOTY0MywKICAgIGRhcmtvbGl2ZWdyZWVuOiA1NTk3OTk5LAogICAgZGFya29yYW5nZTogMTY3NDc1MjAsCiAgICBkYXJrb3JjaGlkOiAxMDA0MDAxMiwKICAgIGRhcmtyZWQ6IDkxMDk1MDQsCiAgICBkYXJrc2FsbW9uOiAxNTMwODQxMCwKICAgIGRhcmtzZWFncmVlbjogOTQxOTkxOSwKICAgIGRhcmtzbGF0ZWJsdWU6IDQ3MzQzNDcsCiAgICBkYXJrc2xhdGVncmF5OiAzMTAwNDk1LAogICAgZGFya3NsYXRlZ3JleTogMzEwMDQ5NSwKICAgIGRhcmt0dXJxdW9pc2U6IDUyOTQ1LAogICAgZGFya3Zpb2xldDogOTY5OTUzOSwKICAgIGRlZXBwaW5rOiAxNjcxNjk0NywKICAgIGRlZXBza3libHVlOiA0OTE1MSwKICAgIGRpbWdyYXk6IDY5MDgyNjUsCiAgICBkaW1ncmV5OiA2OTA4MjY1LAogICAgZG9kZ2VyYmx1ZTogMjAwMzE5OSwKICAgIGZpcmVicmljazogMTE2NzQxNDYsCiAgICBmbG9yYWx3aGl0ZTogMTY3NzU5MjAsCiAgICBmb3Jlc3RncmVlbjogMjI2Mzg0MiwKICAgIGZ1Y2hzaWE6IDE2NzExOTM1LAogICAgZ2FpbnNib3JvOiAxNDQ3NDQ2MCwKICAgIGdob3N0d2hpdGU6IDE2MzE2NjcxLAogICAgZ29sZDogMTY3NjY3MjAsCiAgICBnb2xkZW5yb2Q6IDE0MzI5MTIwLAogICAgZ3JheTogODQyMTUwNCwKICAgIGdyZWVuOiAzMjc2OCwKICAgIGdyZWVueWVsbG93OiAxMTQwMzA1NSwKICAgIGdyZXk6IDg0MjE1MDQsCiAgICBob25leWRldzogMTU3OTQxNjAsCiAgICBob3RwaW5rOiAxNjczODc0MCwKICAgIGluZGlhbnJlZDogMTM0NTg1MjQsCiAgICBpbmRpZ286IDQ5MTUzMzAsCiAgICBpdm9yeTogMTY3NzcyMDAsCiAgICBraGFraTogMTU3ODc2NjAsCiAgICBsYXZlbmRlcjogMTUxMzI0MTAsCiAgICBsYXZlbmRlcmJsdXNoOiAxNjc3MzM2NSwKICAgIGxhd25ncmVlbjogODE5MDk3NiwKICAgIGxlbW9uY2hpZmZvbjogMTY3NzU4ODUsCiAgICBsaWdodGJsdWU6IDExMzkzMjU0LAogICAgbGlnaHRjb3JhbDogMTU3NjE1MzYsCiAgICBsaWdodGN5YW46IDE0NzQ1NTk5LAogICAgbGlnaHRnb2xkZW5yb2R5ZWxsb3c6IDE2NDQ4MjEwLAogICAgbGlnaHRncmF5OiAxMzg4MjMyMywKICAgIGxpZ2h0Z3JlZW46IDk0OTgyNTYsCiAgICBsaWdodGdyZXk6IDEzODgyMzIzLAogICAgbGlnaHRwaW5rOiAxNjc1ODQ2NSwKICAgIGxpZ2h0c2FsbW9uOiAxNjc1Mjc2MiwKICAgIGxpZ2h0c2VhZ3JlZW46IDIxNDI4OTAsCiAgICBsaWdodHNreWJsdWU6IDg5MDAzNDYsCiAgICBsaWdodHNsYXRlZ3JheTogNzgzMzc1MywKICAgIGxpZ2h0c2xhdGVncmV5OiA3ODMzNzUzLAogICAgbGlnaHRzdGVlbGJsdWU6IDExNTg0NzM0LAogICAgbGlnaHR5ZWxsb3c6IDE2Nzc3MTg0LAogICAgbGltZTogNjUyODAsCiAgICBsaW1lZ3JlZW46IDMzMjkzMzAsCiAgICBsaW5lbjogMTY0NDU2NzAsCiAgICBtYWdlbnRhOiAxNjcxMTkzNSwKICAgIG1hcm9vbjogODM4ODYwOCwKICAgIG1lZGl1bWFxdWFtYXJpbmU6IDY3MzczMjIsCiAgICBtZWRpdW1ibHVlOiAyMDUsCiAgICBtZWRpdW1vcmNoaWQ6IDEyMjExNjY3LAogICAgbWVkaXVtcHVycGxlOiA5NjYyNjgzLAogICAgbWVkaXVtc2VhZ3JlZW46IDM5NzgwOTcsCiAgICBtZWRpdW1zbGF0ZWJsdWU6IDgwODc3OTAsCiAgICBtZWRpdW1zcHJpbmdncmVlbjogNjQxNTQsCiAgICBtZWRpdW10dXJxdW9pc2U6IDQ3NzIzMDAsCiAgICBtZWRpdW12aW9sZXRyZWQ6IDEzMDQ3MTczLAogICAgbWlkbmlnaHRibHVlOiAxNjQ0OTEyLAogICAgbWludGNyZWFtOiAxNjEyMTg1MCwKICAgIG1pc3R5cm9zZTogMTY3NzAyNzMsCiAgICBtb2NjYXNpbjogMTY3NzAyMjksCiAgICBuYXZham93aGl0ZTogMTY3Njg2ODUsCiAgICBuYXZ5OiAxMjgsCiAgICBvbGRsYWNlOiAxNjY0MzU1OCwKICAgIG9saXZlOiA4NDIxMzc2LAogICAgb2xpdmVkcmFiOiA3MDQ4NzM5LAogICAgb3JhbmdlOiAxNjc1MzkyMCwKICAgIG9yYW5nZXJlZDogMTY3MjkzNDQsCiAgICBvcmNoaWQ6IDE0MzE1NzM0LAogICAgcGFsZWdvbGRlbnJvZDogMTU2NTcxMzAsCiAgICBwYWxlZ3JlZW46IDEwMDI1ODgwLAogICAgcGFsZXR1cnF1b2lzZTogMTE1Mjk5NjYsCiAgICBwYWxldmlvbGV0cmVkOiAxNDM4MTIwMywKICAgIHBhcGF5YXdoaXA6IDE2NzczMDc3LAogICAgcGVhY2hwdWZmOiAxNjc2NzY3MywKICAgIHBlcnU6IDEzNDY4OTkxLAogICAgcGluazogMTY3NjEwMzUsCiAgICBwbHVtOiAxNDUyNDYzNywKICAgIHBvd2RlcmJsdWU6IDExNTkxOTEwLAogICAgcHVycGxlOiA4Mzg4NzM2LAogICAgcmViZWNjYXB1cnBsZTogNjY5Nzg4MSwKICAgIHJlZDogMTY3MTE2ODAsCiAgICByb3N5YnJvd246IDEyMzU3NTE5LAogICAgcm95YWxibHVlOiA0Mjg2OTQ1LAogICAgc2FkZGxlYnJvd246IDkxMjcxODcsCiAgICBzYWxtb246IDE2NDE2ODgyLAogICAgc2FuZHlicm93bjogMTYwMzI4NjQsCiAgICBzZWFncmVlbjogMzA1MDMyNywKICAgIHNlYXNoZWxsOiAxNjc3NDYzOCwKICAgIHNpZW5uYTogMTA1MDY3OTcsCiAgICBzaWx2ZXI6IDEyNjMyMjU2LAogICAgc2t5Ymx1ZTogODkwMDMzMSwKICAgIHNsYXRlYmx1ZTogNjk3MDA2MSwKICAgIHNsYXRlZ3JheTogNzM3Mjk0NCwKICAgIHNsYXRlZ3JleTogNzM3Mjk0NCwKICAgIHNub3c6IDE2Nzc1OTMwLAogICAgc3ByaW5nZ3JlZW46IDY1NDA3LAogICAgc3RlZWxibHVlOiA0NjIwOTgwLAogICAgdGFuOiAxMzgwODc4MCwKICAgIHRlYWw6IDMyODk2LAogICAgdGhpc3RsZTogMTQyMDQ4ODgsCiAgICB0b21hdG86IDE2NzM3MDk1LAogICAgdHVycXVvaXNlOiA0MjUxODU2LAogICAgdmlvbGV0OiAxNTYzMTA4NiwKICAgIHdoZWF0OiAxNjExMzMzMSwKICAgIHdoaXRlOiAxNjc3NzIxNSwKICAgIHdoaXRlc21va2U6IDE2MTE5Mjg1LAogICAgeWVsbG93OiAxNjc3Njk2MCwKICAgIHllbGxvd2dyZWVuOiAxMDE0NTA3NAogIH07CiAgZGVmaW5lX2RlZmF1bHQoQ29sb3IsIGNvbG9yLCB7CiAgICBjb3B5KGNoYW5uZWxzKSB7CiAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKG5ldyB0aGlzLmNvbnN0cnVjdG9yKCksIHRoaXMsIGNoYW5uZWxzKTsKICAgIH0sCiAgICBkaXNwbGF5YWJsZSgpIHsKICAgICAgcmV0dXJuIHRoaXMucmdiKCkuZGlzcGxheWFibGUoKTsKICAgIH0sCiAgICBoZXg6IGNvbG9yX2Zvcm1hdEhleCwKICAgIC8vIERlcHJlY2F0ZWQhIFVzZSBjb2xvci5mb3JtYXRIZXguCiAgICBmb3JtYXRIZXg6IGNvbG9yX2Zvcm1hdEhleCwKICAgIGZvcm1hdEhleDg6IGNvbG9yX2Zvcm1hdEhleDgsCiAgICBmb3JtYXRIc2w6IGNvbG9yX2Zvcm1hdEhzbCwKICAgIGZvcm1hdFJnYjogY29sb3JfZm9ybWF0UmdiLAogICAgdG9TdHJpbmc6IGNvbG9yX2Zvcm1hdFJnYgogIH0pOwogIGZ1bmN0aW9uIGNvbG9yX2Zvcm1hdEhleCgpIHsKICAgIHJldHVybiB0aGlzLnJnYigpLmZvcm1hdEhleCgpOwogIH0KICBmdW5jdGlvbiBjb2xvcl9mb3JtYXRIZXg4KCkgewogICAgcmV0dXJuIHRoaXMucmdiKCkuZm9ybWF0SGV4OCgpOwogIH0KICBmdW5jdGlvbiBjb2xvcl9mb3JtYXRIc2woKSB7CiAgICByZXR1cm4gaHNsQ29udmVydCh0aGlzKS5mb3JtYXRIc2woKTsKICB9CiAgZnVuY3Rpb24gY29sb3JfZm9ybWF0UmdiKCkgewogICAgcmV0dXJuIHRoaXMucmdiKCkuZm9ybWF0UmdiKCk7CiAgfQogIGZ1bmN0aW9uIGNvbG9yKGZvcm1hdCkgewogICAgdmFyIG0yLCBsOwogICAgZm9ybWF0ID0gKGZvcm1hdCArICIiKS50cmltKCkudG9Mb3dlckNhc2UoKTsKICAgIHJldHVybiAobTIgPSByZUhleC5leGVjKGZvcm1hdCkpID8gKGwgPSBtMlsxXS5sZW5ndGgsIG0yID0gcGFyc2VJbnQobTJbMV0sIDE2KSwgbCA9PT0gNiA/IHJnYm4obTIpIDogbCA9PT0gMyA/IG5ldyBSZ2IobTIgPj4gOCAmIDE1IHwgbTIgPj4gNCAmIDI0MCwgbTIgPj4gNCAmIDE1IHwgbTIgJiAyNDAsIChtMiAmIDE1KSA8PCA0IHwgbTIgJiAxNSwgMSkgOiBsID09PSA4ID8gcmdiYShtMiA+PiAyNCAmIDI1NSwgbTIgPj4gMTYgJiAyNTUsIG0yID4+IDggJiAyNTUsIChtMiAmIDI1NSkgLyAyNTUpIDogbCA9PT0gNCA/IHJnYmEobTIgPj4gMTIgJiAxNSB8IG0yID4+IDggJiAyNDAsIG0yID4+IDggJiAxNSB8IG0yID4+IDQgJiAyNDAsIG0yID4+IDQgJiAxNSB8IG0yICYgMjQwLCAoKG0yICYgMTUpIDw8IDQgfCBtMiAmIDE1KSAvIDI1NSkgOiBudWxsKSA6IChtMiA9IHJlUmdiSW50ZWdlci5leGVjKGZvcm1hdCkpID8gbmV3IFJnYihtMlsxXSwgbTJbMl0sIG0yWzNdLCAxKSA6IChtMiA9IHJlUmdiUGVyY2VudC5leGVjKGZvcm1hdCkpID8gbmV3IFJnYihtMlsxXSAqIDI1NSAvIDEwMCwgbTJbMl0gKiAyNTUgLyAxMDAsIG0yWzNdICogMjU1IC8gMTAwLCAxKSA6IChtMiA9IHJlUmdiYUludGVnZXIuZXhlYyhmb3JtYXQpKSA/IHJnYmEobTJbMV0sIG0yWzJdLCBtMlszXSwgbTJbNF0pIDogKG0yID0gcmVSZ2JhUGVyY2VudC5leGVjKGZvcm1hdCkpID8gcmdiYShtMlsxXSAqIDI1NSAvIDEwMCwgbTJbMl0gKiAyNTUgLyAxMDAsIG0yWzNdICogMjU1IC8gMTAwLCBtMls0XSkgOiAobTIgPSByZUhzbFBlcmNlbnQuZXhlYyhmb3JtYXQpKSA/IGhzbGEobTJbMV0sIG0yWzJdIC8gMTAwLCBtMlszXSAvIDEwMCwgMSkgOiAobTIgPSByZUhzbGFQZXJjZW50LmV4ZWMoZm9ybWF0KSkgPyBoc2xhKG0yWzFdLCBtMlsyXSAvIDEwMCwgbTJbM10gLyAxMDAsIG0yWzRdKSA6IG5hbWVkLmhhc093blByb3BlcnR5KGZvcm1hdCkgPyByZ2JuKG5hbWVkW2Zvcm1hdF0pIDogZm9ybWF0ID09PSAidHJhbnNwYXJlbnQiID8gbmV3IFJnYihOYU4sIE5hTiwgTmFOLCAwKSA6IG51bGw7CiAgfQogIGZ1bmN0aW9uIHJnYm4obikgewogICAgcmV0dXJuIG5ldyBSZ2IobiA+PiAxNiAmIDI1NSwgbiA+PiA4ICYgMjU1LCBuICYgMjU1LCAxKTsKICB9CiAgZnVuY3Rpb24gcmdiYShyLCBnLCBiLCBhMikgewogICAgaWYgKGEyIDw9IDApCiAgICAgIHIgPSBnID0gYiA9IE5hTjsKICAgIHJldHVybiBuZXcgUmdiKHIsIGcsIGIsIGEyKTsKICB9CiAgZnVuY3Rpb24gcmdiQ29udmVydChvKSB7CiAgICBpZiAoIShvIGluc3RhbmNlb2YgQ29sb3IpKQogICAgICBvID0gY29sb3Iobyk7CiAgICBpZiAoIW8pCiAgICAgIHJldHVybiBuZXcgUmdiKCk7CiAgICBvID0gby5yZ2IoKTsKICAgIHJldHVybiBuZXcgUmdiKG8uciwgby5nLCBvLmIsIG8ub3BhY2l0eSk7CiAgfQogIGZ1bmN0aW9uIHJnYihyLCBnLCBiLCBvcGFjaXR5KSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA9PT0gMSA/IHJnYkNvbnZlcnQocikgOiBuZXcgUmdiKHIsIGcsIGIsIG9wYWNpdHkgPT0gbnVsbCA/IDEgOiBvcGFjaXR5KTsKICB9CiAgZnVuY3Rpb24gUmdiKHIsIGcsIGIsIG9wYWNpdHkpIHsKICAgIHRoaXMuciA9ICtyOwogICAgdGhpcy5nID0gK2c7CiAgICB0aGlzLmIgPSArYjsKICAgIHRoaXMub3BhY2l0eSA9ICtvcGFjaXR5OwogIH0KICBkZWZpbmVfZGVmYXVsdChSZ2IsIHJnYiwgZXh0ZW5kKENvbG9yLCB7CiAgICBicmlnaHRlcihrKSB7CiAgICAgIGsgPSBrID09IG51bGwgPyBicmlnaHRlciA6IE1hdGgucG93KGJyaWdodGVyLCBrKTsKICAgICAgcmV0dXJuIG5ldyBSZ2IodGhpcy5yICogaywgdGhpcy5nICogaywgdGhpcy5iICogaywgdGhpcy5vcGFjaXR5KTsKICAgIH0sCiAgICBkYXJrZXIoaykgewogICAgICBrID0gayA9PSBudWxsID8gZGFya2VyIDogTWF0aC5wb3coZGFya2VyLCBrKTsKICAgICAgcmV0dXJuIG5ldyBSZ2IodGhpcy5yICogaywgdGhpcy5nICogaywgdGhpcy5iICogaywgdGhpcy5vcGFjaXR5KTsKICAgIH0sCiAgICByZ2IoKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIGNsYW1wKCkgewogICAgICByZXR1cm4gbmV3IFJnYihjbGFtcGkodGhpcy5yKSwgY2xhbXBpKHRoaXMuZyksIGNsYW1waSh0aGlzLmIpLCBjbGFtcGEodGhpcy5vcGFjaXR5KSk7CiAgICB9LAogICAgZGlzcGxheWFibGUoKSB7CiAgICAgIHJldHVybiAtMC41IDw9IHRoaXMuciAmJiB0aGlzLnIgPCAyNTUuNSAmJiAoLTAuNSA8PSB0aGlzLmcgJiYgdGhpcy5nIDwgMjU1LjUpICYmICgtMC41IDw9IHRoaXMuYiAmJiB0aGlzLmIgPCAyNTUuNSkgJiYgKDAgPD0gdGhpcy5vcGFjaXR5ICYmIHRoaXMub3BhY2l0eSA8PSAxKTsKICAgIH0sCiAgICBoZXg6IHJnYl9mb3JtYXRIZXgsCiAgICAvLyBEZXByZWNhdGVkISBVc2UgY29sb3IuZm9ybWF0SGV4LgogICAgZm9ybWF0SGV4OiByZ2JfZm9ybWF0SGV4LAogICAgZm9ybWF0SGV4ODogcmdiX2Zvcm1hdEhleDgsCiAgICBmb3JtYXRSZ2I6IHJnYl9mb3JtYXRSZ2IsCiAgICB0b1N0cmluZzogcmdiX2Zvcm1hdFJnYgogIH0pKTsKICBmdW5jdGlvbiByZ2JfZm9ybWF0SGV4KCkgewogICAgcmV0dXJuIGAjJHtoZXgodGhpcy5yKX0ke2hleCh0aGlzLmcpfSR7aGV4KHRoaXMuYil9YDsKICB9CiAgZnVuY3Rpb24gcmdiX2Zvcm1hdEhleDgoKSB7CiAgICByZXR1cm4gYCMke2hleCh0aGlzLnIpfSR7aGV4KHRoaXMuZyl9JHtoZXgodGhpcy5iKX0ke2hleCgoaXNOYU4odGhpcy5vcGFjaXR5KSA/IDEgOiB0aGlzLm9wYWNpdHkpICogMjU1KX1gOwogIH0KICBmdW5jdGlvbiByZ2JfZm9ybWF0UmdiKCkgewogICAgY29uc3QgYTIgPSBjbGFtcGEodGhpcy5vcGFjaXR5KTsKICAgIHJldHVybiBgJHthMiA9PT0gMSA/ICJyZ2IoIiA6ICJyZ2JhKCJ9JHtjbGFtcGkodGhpcy5yKX0sICR7Y2xhbXBpKHRoaXMuZyl9LCAke2NsYW1waSh0aGlzLmIpfSR7YTIgPT09IDEgPyAiKSIgOiBgLCAke2EyfSlgfWA7CiAgfQogIGZ1bmN0aW9uIGNsYW1wYShvcGFjaXR5KSB7CiAgICByZXR1cm4gaXNOYU4ob3BhY2l0eSkgPyAxIDogTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgb3BhY2l0eSkpOwogIH0KICBmdW5jdGlvbiBjbGFtcGkodmFsdWUpIHsKICAgIHJldHVybiBNYXRoLm1heCgwLCBNYXRoLm1pbigyNTUsIE1hdGgucm91bmQodmFsdWUpIHx8IDApKTsKICB9CiAgZnVuY3Rpb24gaGV4KHZhbHVlKSB7CiAgICB2YWx1ZSA9IGNsYW1waSh2YWx1ZSk7CiAgICByZXR1cm4gKHZhbHVlIDwgMTYgPyAiMCIgOiAiIikgKyB2YWx1ZS50b1N0cmluZygxNik7CiAgfQogIGZ1bmN0aW9uIGhzbGEoaCwgcywgbCwgYTIpIHsKICAgIGlmIChhMiA8PSAwKQogICAgICBoID0gcyA9IGwgPSBOYU47CiAgICBlbHNlIGlmIChsIDw9IDAgfHwgbCA+PSAxKQogICAgICBoID0gcyA9IE5hTjsKICAgIGVsc2UgaWYgKHMgPD0gMCkKICAgICAgaCA9IE5hTjsKICAgIHJldHVybiBuZXcgSHNsKGgsIHMsIGwsIGEyKTsKICB9CiAgZnVuY3Rpb24gaHNsQ29udmVydChvKSB7CiAgICBpZiAobyBpbnN0YW5jZW9mIEhzbCkKICAgICAgcmV0dXJuIG5ldyBIc2woby5oLCBvLnMsIG8ubCwgby5vcGFjaXR5KTsKICAgIGlmICghKG8gaW5zdGFuY2VvZiBDb2xvcikpCiAgICAgIG8gPSBjb2xvcihvKTsKICAgIGlmICghbykKICAgICAgcmV0dXJuIG5ldyBIc2woKTsKICAgIGlmIChvIGluc3RhbmNlb2YgSHNsKQogICAgICByZXR1cm4gbzsKICAgIG8gPSBvLnJnYigpOwogICAgdmFyIHIgPSBvLnIgLyAyNTUsIGcgPSBvLmcgLyAyNTUsIGIgPSBvLmIgLyAyNTUsIG1pbjIgPSBNYXRoLm1pbihyLCBnLCBiKSwgbWF4MiA9IE1hdGgubWF4KHIsIGcsIGIpLCBoID0gTmFOLCBzID0gbWF4MiAtIG1pbjIsIGwgPSAobWF4MiArIG1pbjIpIC8gMjsKICAgIGlmIChzKSB7CiAgICAgIGlmIChyID09PSBtYXgyKQogICAgICAgIGggPSAoZyAtIGIpIC8gcyArIChnIDwgYikgKiA2OwogICAgICBlbHNlIGlmIChnID09PSBtYXgyKQogICAgICAgIGggPSAoYiAtIHIpIC8gcyArIDI7CiAgICAgIGVsc2UKICAgICAgICBoID0gKHIgLSBnKSAvIHMgKyA0OwogICAgICBzIC89IGwgPCAwLjUgPyBtYXgyICsgbWluMiA6IDIgLSBtYXgyIC0gbWluMjsKICAgICAgaCAqPSA2MDsKICAgIH0gZWxzZSB7CiAgICAgIHMgPSBsID4gMCAmJiBsIDwgMSA/IDAgOiBoOwogICAgfQogICAgcmV0dXJuIG5ldyBIc2woaCwgcywgbCwgby5vcGFjaXR5KTsKICB9CiAgZnVuY3Rpb24gaHNsKGgsIHMsIGwsIG9wYWNpdHkpIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID09PSAxID8gaHNsQ29udmVydChoKSA6IG5ldyBIc2woaCwgcywgbCwgb3BhY2l0eSA9PSBudWxsID8gMSA6IG9wYWNpdHkpOwogIH0KICBmdW5jdGlvbiBIc2woaCwgcywgbCwgb3BhY2l0eSkgewogICAgdGhpcy5oID0gK2g7CiAgICB0aGlzLnMgPSArczsKICAgIHRoaXMubCA9ICtsOwogICAgdGhpcy5vcGFjaXR5ID0gK29wYWNpdHk7CiAgfQogIGRlZmluZV9kZWZhdWx0KEhzbCwgaHNsLCBleHRlbmQoQ29sb3IsIHsKICAgIGJyaWdodGVyKGspIHsKICAgICAgayA9IGsgPT0gbnVsbCA/IGJyaWdodGVyIDogTWF0aC5wb3coYnJpZ2h0ZXIsIGspOwogICAgICByZXR1cm4gbmV3IEhzbCh0aGlzLmgsIHRoaXMucywgdGhpcy5sICogaywgdGhpcy5vcGFjaXR5KTsKICAgIH0sCiAgICBkYXJrZXIoaykgewogICAgICBrID0gayA9PSBudWxsID8gZGFya2VyIDogTWF0aC5wb3coZGFya2VyLCBrKTsKICAgICAgcmV0dXJuIG5ldyBIc2wodGhpcy5oLCB0aGlzLnMsIHRoaXMubCAqIGssIHRoaXMub3BhY2l0eSk7CiAgICB9LAogICAgcmdiKCkgewogICAgICB2YXIgaCA9IHRoaXMuaCAlIDM2MCArICh0aGlzLmggPCAwKSAqIDM2MCwgcyA9IGlzTmFOKGgpIHx8IGlzTmFOKHRoaXMucykgPyAwIDogdGhpcy5zLCBsID0gdGhpcy5sLCBtMiA9IGwgKyAobCA8IDAuNSA/IGwgOiAxIC0gbCkgKiBzLCBtMSA9IDIgKiBsIC0gbTI7CiAgICAgIHJldHVybiBuZXcgUmdiKAogICAgICAgIGhzbDJyZ2IoaCA+PSAyNDAgPyBoIC0gMjQwIDogaCArIDEyMCwgbTEsIG0yKSwKICAgICAgICBoc2wycmdiKGgsIG0xLCBtMiksCiAgICAgICAgaHNsMnJnYihoIDwgMTIwID8gaCArIDI0MCA6IGggLSAxMjAsIG0xLCBtMiksCiAgICAgICAgdGhpcy5vcGFjaXR5CiAgICAgICk7CiAgICB9LAogICAgY2xhbXAoKSB7CiAgICAgIHJldHVybiBuZXcgSHNsKGNsYW1waCh0aGlzLmgpLCBjbGFtcHQodGhpcy5zKSwgY2xhbXB0KHRoaXMubCksIGNsYW1wYSh0aGlzLm9wYWNpdHkpKTsKICAgIH0sCiAgICBkaXNwbGF5YWJsZSgpIHsKICAgICAgcmV0dXJuICgwIDw9IHRoaXMucyAmJiB0aGlzLnMgPD0gMSB8fCBpc05hTih0aGlzLnMpKSAmJiAoMCA8PSB0aGlzLmwgJiYgdGhpcy5sIDw9IDEpICYmICgwIDw9IHRoaXMub3BhY2l0eSAmJiB0aGlzLm9wYWNpdHkgPD0gMSk7CiAgICB9LAogICAgZm9ybWF0SHNsKCkgewogICAgICBjb25zdCBhMiA9IGNsYW1wYSh0aGlzLm9wYWNpdHkpOwogICAgICByZXR1cm4gYCR7YTIgPT09IDEgPyAiaHNsKCIgOiAiaHNsYSgifSR7Y2xhbXBoKHRoaXMuaCl9LCAke2NsYW1wdCh0aGlzLnMpICogMTAwfSUsICR7Y2xhbXB0KHRoaXMubCkgKiAxMDB9JSR7YTIgPT09IDEgPyAiKSIgOiBgLCAke2EyfSlgfWA7CiAgICB9CiAgfSkpOwogIGZ1bmN0aW9uIGNsYW1waCh2YWx1ZSkgewogICAgdmFsdWUgPSAodmFsdWUgfHwgMCkgJSAzNjA7CiAgICByZXR1cm4gdmFsdWUgPCAwID8gdmFsdWUgKyAzNjAgOiB2YWx1ZTsKICB9CiAgZnVuY3Rpb24gY2xhbXB0KHZhbHVlKSB7CiAgICByZXR1cm4gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgdmFsdWUgfHwgMCkpOwogIH0KICBmdW5jdGlvbiBoc2wycmdiKGgsIG0xLCBtMikgewogICAgcmV0dXJuIChoIDwgNjAgPyBtMSArIChtMiAtIG0xKSAqIGggLyA2MCA6IGggPCAxODAgPyBtMiA6IGggPCAyNDAgPyBtMSArIChtMiAtIG0xKSAqICgyNDAgLSBoKSAvIDYwIDogbTEpICogMjU1OwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9iYXNpcy5qcwogIGZ1bmN0aW9uIGJhc2lzKHQxLCB2MCwgdjEsIHYyLCB2MykgewogICAgdmFyIHQyID0gdDEgKiB0MSwgdDMgPSB0MiAqIHQxOwogICAgcmV0dXJuICgoMSAtIDMgKiB0MSArIDMgKiB0MiAtIHQzKSAqIHYwICsgKDQgLSA2ICogdDIgKyAzICogdDMpICogdjEgKyAoMSArIDMgKiB0MSArIDMgKiB0MiAtIDMgKiB0MykgKiB2MiArIHQzICogdjMpIC8gNjsKICB9CiAgZnVuY3Rpb24gYmFzaXNfZGVmYXVsdCh2YWx1ZXMpIHsKICAgIHZhciBuID0gdmFsdWVzLmxlbmd0aCAtIDE7CiAgICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgICB2YXIgaSA9IHQgPD0gMCA/IHQgPSAwIDogdCA+PSAxID8gKHQgPSAxLCBuIC0gMSkgOiBNYXRoLmZsb29yKHQgKiBuKSwgdjEgPSB2YWx1ZXNbaV0sIHYyID0gdmFsdWVzW2kgKyAxXSwgdjAgPSBpID4gMCA/IHZhbHVlc1tpIC0gMV0gOiAyICogdjEgLSB2MiwgdjMgPSBpIDwgbiAtIDEgPyB2YWx1ZXNbaSArIDJdIDogMiAqIHYyIC0gdjE7CiAgICAgIHJldHVybiBiYXNpcygodCAtIGkgLyBuKSAqIG4sIHYwLCB2MSwgdjIsIHYzKTsKICAgIH07CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL2Jhc2lzQ2xvc2VkLmpzCiAgZnVuY3Rpb24gYmFzaXNDbG9zZWRfZGVmYXVsdCh2YWx1ZXMpIHsKICAgIHZhciBuID0gdmFsdWVzLmxlbmd0aDsKICAgIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICAgIHZhciBpID0gTWF0aC5mbG9vcigoKHQgJT0gMSkgPCAwID8gKyt0IDogdCkgKiBuKSwgdjAgPSB2YWx1ZXNbKGkgKyBuIC0gMSkgJSBuXSwgdjEgPSB2YWx1ZXNbaSAlIG5dLCB2MiA9IHZhbHVlc1soaSArIDEpICUgbl0sIHYzID0gdmFsdWVzWyhpICsgMikgJSBuXTsKICAgICAgcmV0dXJuIGJhc2lzKCh0IC0gaSAvIG4pICogbiwgdjAsIHYxLCB2MiwgdjMpOwogICAgfTsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvY29uc3RhbnQuanMKICB2YXIgY29uc3RhbnRfZGVmYXVsdDMgPSAoeDIpID0+ICgpID0+IHgyOwoKICAvLyBub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL2NvbG9yLmpzCiAgZnVuY3Rpb24gbGluZWFyKGEyLCBkKSB7CiAgICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgICByZXR1cm4gYTIgKyB0ICogZDsKICAgIH07CiAgfQogIGZ1bmN0aW9uIGV4cG9uZW50aWFsKGEyLCBiLCB5MikgewogICAgcmV0dXJuIGEyID0gTWF0aC5wb3coYTIsIHkyKSwgYiA9IE1hdGgucG93KGIsIHkyKSAtIGEyLCB5MiA9IDEgLyB5MiwgZnVuY3Rpb24odCkgewogICAgICByZXR1cm4gTWF0aC5wb3coYTIgKyB0ICogYiwgeTIpOwogICAgfTsKICB9CiAgZnVuY3Rpb24gZ2FtbWEoeTIpIHsKICAgIHJldHVybiAoeTIgPSAreTIpID09PSAxID8gbm9nYW1tYSA6IGZ1bmN0aW9uKGEyLCBiKSB7CiAgICAgIHJldHVybiBiIC0gYTIgPyBleHBvbmVudGlhbChhMiwgYiwgeTIpIDogY29uc3RhbnRfZGVmYXVsdDMoaXNOYU4oYTIpID8gYiA6IGEyKTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIG5vZ2FtbWEoYTIsIGIpIHsKICAgIHZhciBkID0gYiAtIGEyOwogICAgcmV0dXJuIGQgPyBsaW5lYXIoYTIsIGQpIDogY29uc3RhbnRfZGVmYXVsdDMoaXNOYU4oYTIpID8gYiA6IGEyKTsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvcmdiLmpzCiAgdmFyIHJnYl9kZWZhdWx0ID0gZnVuY3Rpb24gcmdiR2FtbWEoeTIpIHsKICAgIHZhciBjb2xvcjIgPSBnYW1tYSh5Mik7CiAgICBmdW5jdGlvbiByZ2IyKHN0YXJ0MiwgZW5kKSB7CiAgICAgIHZhciByID0gY29sb3IyKChzdGFydDIgPSByZ2Ioc3RhcnQyKSkuciwgKGVuZCA9IHJnYihlbmQpKS5yKSwgZyA9IGNvbG9yMihzdGFydDIuZywgZW5kLmcpLCBiID0gY29sb3IyKHN0YXJ0Mi5iLCBlbmQuYiksIG9wYWNpdHkgPSBub2dhbW1hKHN0YXJ0Mi5vcGFjaXR5LCBlbmQub3BhY2l0eSk7CiAgICAgIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICAgICAgc3RhcnQyLnIgPSByKHQpOwogICAgICAgIHN0YXJ0Mi5nID0gZyh0KTsKICAgICAgICBzdGFydDIuYiA9IGIodCk7CiAgICAgICAgc3RhcnQyLm9wYWNpdHkgPSBvcGFjaXR5KHQpOwogICAgICAgIHJldHVybiBzdGFydDIgKyAiIjsKICAgICAgfTsKICAgIH0KICAgIHJnYjIuZ2FtbWEgPSByZ2JHYW1tYTsKICAgIHJldHVybiByZ2IyOwogIH0oMSk7CiAgZnVuY3Rpb24gcmdiU3BsaW5lKHNwbGluZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKGNvbG9ycykgewogICAgICB2YXIgbiA9IGNvbG9ycy5sZW5ndGgsIHIgPSBuZXcgQXJyYXkobiksIGcgPSBuZXcgQXJyYXkobiksIGIgPSBuZXcgQXJyYXkobiksIGksIGNvbG9yMjsKICAgICAgZm9yIChpID0gMDsgaSA8IG47ICsraSkgewogICAgICAgIGNvbG9yMiA9IHJnYihjb2xvcnNbaV0pOwogICAgICAgIHJbaV0gPSBjb2xvcjIuciB8fCAwOwogICAgICAgIGdbaV0gPSBjb2xvcjIuZyB8fCAwOwogICAgICAgIGJbaV0gPSBjb2xvcjIuYiB8fCAwOwogICAgICB9CiAgICAgIHIgPSBzcGxpbmUocik7CiAgICAgIGcgPSBzcGxpbmUoZyk7CiAgICAgIGIgPSBzcGxpbmUoYik7CiAgICAgIGNvbG9yMi5vcGFjaXR5ID0gMTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgICAgICBjb2xvcjIuciA9IHIodCk7CiAgICAgICAgY29sb3IyLmcgPSBnKHQpOwogICAgICAgIGNvbG9yMi5iID0gYih0KTsKICAgICAgICByZXR1cm4gY29sb3IyICsgIiI7CiAgICAgIH07CiAgICB9OwogIH0KICB2YXIgcmdiQmFzaXMgPSByZ2JTcGxpbmUoYmFzaXNfZGVmYXVsdCk7CiAgdmFyIHJnYkJhc2lzQ2xvc2VkID0gcmdiU3BsaW5lKGJhc2lzQ2xvc2VkX2RlZmF1bHQpOwoKICAvLyBub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL251bWJlci5qcwogIGZ1bmN0aW9uIG51bWJlcl9kZWZhdWx0KGEyLCBiKSB7CiAgICByZXR1cm4gYTIgPSArYTIsIGIgPSArYiwgZnVuY3Rpb24odCkgewogICAgICByZXR1cm4gYTIgKiAoMSAtIHQpICsgYiAqIHQ7CiAgICB9OwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9zdHJpbmcuanMKICB2YXIgcmVBID0gL1stK10/KD86XGQrXC4/XGQqfFwuP1xkKykoPzpbZUVdWy0rXT9cZCspPy9nOwogIHZhciByZUIgPSBuZXcgUmVnRXhwKHJlQS5zb3VyY2UsICJnIik7CiAgZnVuY3Rpb24gemVybyhiKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBiOwogICAgfTsKICB9CiAgZnVuY3Rpb24gb25lKGIpIHsKICAgIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICAgIHJldHVybiBiKHQpICsgIiI7CiAgICB9OwogIH0KICBmdW5jdGlvbiBzdHJpbmdfZGVmYXVsdChhMiwgYikgewogICAgdmFyIGJpID0gcmVBLmxhc3RJbmRleCA9IHJlQi5sYXN0SW5kZXggPSAwLCBhbSwgYm0sIGJzLCBpID0gLTEsIHMgPSBbXSwgcSA9IFtdOwogICAgYTIgPSBhMiArICIiLCBiID0gYiArICIiOwogICAgd2hpbGUgKChhbSA9IHJlQS5leGVjKGEyKSkgJiYgKGJtID0gcmVCLmV4ZWMoYikpKSB7CiAgICAgIGlmICgoYnMgPSBibS5pbmRleCkgPiBiaSkgewogICAgICAgIGJzID0gYi5zbGljZShiaSwgYnMpOwogICAgICAgIGlmIChzW2ldKQogICAgICAgICAgc1tpXSArPSBiczsKICAgICAgICBlbHNlCiAgICAgICAgICBzWysraV0gPSBiczsKICAgICAgfQogICAgICBpZiAoKGFtID0gYW1bMF0pID09PSAoYm0gPSBibVswXSkpIHsKICAgICAgICBpZiAoc1tpXSkKICAgICAgICAgIHNbaV0gKz0gYm07CiAgICAgICAgZWxzZQogICAgICAgICAgc1srK2ldID0gYm07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc1srK2ldID0gbnVsbDsKICAgICAgICBxLnB1c2goeyBpLCB4OiBudW1iZXJfZGVmYXVsdChhbSwgYm0pIH0pOwogICAgICB9CiAgICAgIGJpID0gcmVCLmxhc3RJbmRleDsKICAgIH0KICAgIGlmIChiaSA8IGIubGVuZ3RoKSB7CiAgICAgIGJzID0gYi5zbGljZShiaSk7CiAgICAgIGlmIChzW2ldKQogICAgICAgIHNbaV0gKz0gYnM7CiAgICAgIGVsc2UKICAgICAgICBzWysraV0gPSBiczsKICAgIH0KICAgIHJldHVybiBzLmxlbmd0aCA8IDIgPyBxWzBdID8gb25lKHFbMF0ueCkgOiB6ZXJvKGIpIDogKGIgPSBxLmxlbmd0aCwgZnVuY3Rpb24odCkgewogICAgICBmb3IgKHZhciBpMiA9IDAsIG87IGkyIDwgYjsgKytpMikKICAgICAgICBzWyhvID0gcVtpMl0pLmldID0gby54KHQpOwogICAgICByZXR1cm4gcy5qb2luKCIiKTsKICAgIH0pOwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy90cmFuc2Zvcm0vZGVjb21wb3NlLmpzCiAgdmFyIGRlZ3JlZXMgPSAxODAgLyBNYXRoLlBJOwogIHZhciBpZGVudGl0eSA9IHsKICAgIHRyYW5zbGF0ZVg6IDAsCiAgICB0cmFuc2xhdGVZOiAwLAogICAgcm90YXRlOiAwLAogICAgc2tld1g6IDAsCiAgICBzY2FsZVg6IDEsCiAgICBzY2FsZVk6IDEKICB9OwogIGZ1bmN0aW9uIGRlY29tcG9zZV9kZWZhdWx0KGEyLCBiLCBjMiwgZCwgZSwgZikgewogICAgdmFyIHNjYWxlWCwgc2NhbGVZLCBza2V3WDsKICAgIGlmIChzY2FsZVggPSBNYXRoLnNxcnQoYTIgKiBhMiArIGIgKiBiKSkKICAgICAgYTIgLz0gc2NhbGVYLCBiIC89IHNjYWxlWDsKICAgIGlmIChza2V3WCA9IGEyICogYzIgKyBiICogZCkKICAgICAgYzIgLT0gYTIgKiBza2V3WCwgZCAtPSBiICogc2tld1g7CiAgICBpZiAoc2NhbGVZID0gTWF0aC5zcXJ0KGMyICogYzIgKyBkICogZCkpCiAgICAgIGMyIC89IHNjYWxlWSwgZCAvPSBzY2FsZVksIHNrZXdYIC89IHNjYWxlWTsKICAgIGlmIChhMiAqIGQgPCBiICogYzIpCiAgICAgIGEyID0gLWEyLCBiID0gLWIsIHNrZXdYID0gLXNrZXdYLCBzY2FsZVggPSAtc2NhbGVYOwogICAgcmV0dXJuIHsKICAgICAgdHJhbnNsYXRlWDogZSwKICAgICAgdHJhbnNsYXRlWTogZiwKICAgICAgcm90YXRlOiBNYXRoLmF0YW4yKGIsIGEyKSAqIGRlZ3JlZXMsCiAgICAgIHNrZXdYOiBNYXRoLmF0YW4oc2tld1gpICogZGVncmVlcywKICAgICAgc2NhbGVYLAogICAgICBzY2FsZVkKICAgIH07CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL3RyYW5zZm9ybS9wYXJzZS5qcwogIHZhciBzdmdOb2RlOwogIGZ1bmN0aW9uIHBhcnNlQ3NzKHZhbHVlKSB7CiAgICBjb25zdCBtMiA9IG5ldyAodHlwZW9mIERPTU1hdHJpeCA9PT0gImZ1bmN0aW9uIiA/IERPTU1hdHJpeCA6IFdlYktpdENTU01hdHJpeCkodmFsdWUgKyAiIik7CiAgICByZXR1cm4gbTIuaXNJZGVudGl0eSA/IGlkZW50aXR5IDogZGVjb21wb3NlX2RlZmF1bHQobTIuYSwgbTIuYiwgbTIuYywgbTIuZCwgbTIuZSwgbTIuZik7CiAgfQogIGZ1bmN0aW9uIHBhcnNlU3ZnKHZhbHVlKSB7CiAgICBpZiAodmFsdWUgPT0gbnVsbCkKICAgICAgcmV0dXJuIGlkZW50aXR5OwogICAgaWYgKCFzdmdOb2RlKQogICAgICBzdmdOb2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKCJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIsICJnIik7CiAgICBzdmdOb2RlLnNldEF0dHJpYnV0ZSgidHJhbnNmb3JtIiwgdmFsdWUpOwogICAgaWYgKCEodmFsdWUgPSBzdmdOb2RlLnRyYW5zZm9ybS5iYXNlVmFsLmNvbnNvbGlkYXRlKCkpKQogICAgICByZXR1cm4gaWRlbnRpdHk7CiAgICB2YWx1ZSA9IHZhbHVlLm1hdHJpeDsKICAgIHJldHVybiBkZWNvbXBvc2VfZGVmYXVsdCh2YWx1ZS5hLCB2YWx1ZS5iLCB2YWx1ZS5jLCB2YWx1ZS5kLCB2YWx1ZS5lLCB2YWx1ZS5mKTsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvdHJhbnNmb3JtL2luZGV4LmpzCiAgZnVuY3Rpb24gaW50ZXJwb2xhdGVUcmFuc2Zvcm0ocGFyc2UsIHB4Q29tbWEsIHB4UGFyZW4sIGRlZ1BhcmVuKSB7CiAgICBmdW5jdGlvbiBwb3AocykgewogICAgICByZXR1cm4gcy5sZW5ndGggPyBzLnBvcCgpICsgIiAiIDogIiI7CiAgICB9CiAgICBmdW5jdGlvbiB0cmFuc2xhdGUoeGEsIHlhLCB4YiwgeWIsIHMsIHEpIHsKICAgICAgaWYgKHhhICE9PSB4YiB8fCB5YSAhPT0geWIpIHsKICAgICAgICB2YXIgaSA9IHMucHVzaCgidHJhbnNsYXRlKCIsIG51bGwsIHB4Q29tbWEsIG51bGwsIHB4UGFyZW4pOwogICAgICAgIHEucHVzaCh7IGk6IGkgLSA0LCB4OiBudW1iZXJfZGVmYXVsdCh4YSwgeGIpIH0sIHsgaTogaSAtIDIsIHg6IG51bWJlcl9kZWZhdWx0KHlhLCB5YikgfSk7CiAgICAgIH0gZWxzZSBpZiAoeGIgfHwgeWIpIHsKICAgICAgICBzLnB1c2goInRyYW5zbGF0ZSgiICsgeGIgKyBweENvbW1hICsgeWIgKyBweFBhcmVuKTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gcm90YXRlKGEyLCBiLCBzLCBxKSB7CiAgICAgIGlmIChhMiAhPT0gYikgewogICAgICAgIGlmIChhMiAtIGIgPiAxODApCiAgICAgICAgICBiICs9IDM2MDsKICAgICAgICBlbHNlIGlmIChiIC0gYTIgPiAxODApCiAgICAgICAgICBhMiArPSAzNjA7CiAgICAgICAgcS5wdXNoKHsgaTogcy5wdXNoKHBvcChzKSArICJyb3RhdGUoIiwgbnVsbCwgZGVnUGFyZW4pIC0gMiwgeDogbnVtYmVyX2RlZmF1bHQoYTIsIGIpIH0pOwogICAgICB9IGVsc2UgaWYgKGIpIHsKICAgICAgICBzLnB1c2gocG9wKHMpICsgInJvdGF0ZSgiICsgYiArIGRlZ1BhcmVuKTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gc2tld1goYTIsIGIsIHMsIHEpIHsKICAgICAgaWYgKGEyICE9PSBiKSB7CiAgICAgICAgcS5wdXNoKHsgaTogcy5wdXNoKHBvcChzKSArICJza2V3WCgiLCBudWxsLCBkZWdQYXJlbikgLSAyLCB4OiBudW1iZXJfZGVmYXVsdChhMiwgYikgfSk7CiAgICAgIH0gZWxzZSBpZiAoYikgewogICAgICAgIHMucHVzaChwb3AocykgKyAic2tld1goIiArIGIgKyBkZWdQYXJlbik7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIHNjYWxlKHhhLCB5YSwgeGIsIHliLCBzLCBxKSB7CiAgICAgIGlmICh4YSAhPT0geGIgfHwgeWEgIT09IHliKSB7CiAgICAgICAgdmFyIGkgPSBzLnB1c2gocG9wKHMpICsgInNjYWxlKCIsIG51bGwsICIsIiwgbnVsbCwgIikiKTsKICAgICAgICBxLnB1c2goeyBpOiBpIC0gNCwgeDogbnVtYmVyX2RlZmF1bHQoeGEsIHhiKSB9LCB7IGk6IGkgLSAyLCB4OiBudW1iZXJfZGVmYXVsdCh5YSwgeWIpIH0pOwogICAgICB9IGVsc2UgaWYgKHhiICE9PSAxIHx8IHliICE9PSAxKSB7CiAgICAgICAgcy5wdXNoKHBvcChzKSArICJzY2FsZSgiICsgeGIgKyAiLCIgKyB5YiArICIpIik7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmdW5jdGlvbihhMiwgYikgewogICAgICB2YXIgcyA9IFtdLCBxID0gW107CiAgICAgIGEyID0gcGFyc2UoYTIpLCBiID0gcGFyc2UoYik7CiAgICAgIHRyYW5zbGF0ZShhMi50cmFuc2xhdGVYLCBhMi50cmFuc2xhdGVZLCBiLnRyYW5zbGF0ZVgsIGIudHJhbnNsYXRlWSwgcywgcSk7CiAgICAgIHJvdGF0ZShhMi5yb3RhdGUsIGIucm90YXRlLCBzLCBxKTsKICAgICAgc2tld1goYTIuc2tld1gsIGIuc2tld1gsIHMsIHEpOwogICAgICBzY2FsZShhMi5zY2FsZVgsIGEyLnNjYWxlWSwgYi5zY2FsZVgsIGIuc2NhbGVZLCBzLCBxKTsKICAgICAgYTIgPSBiID0gbnVsbDsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgICAgICB2YXIgaSA9IC0xLCBuID0gcS5sZW5ndGgsIG87CiAgICAgICAgd2hpbGUgKCsraSA8IG4pCiAgICAgICAgICBzWyhvID0gcVtpXSkuaV0gPSBvLngodCk7CiAgICAgICAgcmV0dXJuIHMuam9pbigiIik7CiAgICAgIH07CiAgICB9OwogIH0KICB2YXIgaW50ZXJwb2xhdGVUcmFuc2Zvcm1Dc3MgPSBpbnRlcnBvbGF0ZVRyYW5zZm9ybShwYXJzZUNzcywgInB4LCAiLCAicHgpIiwgImRlZykiKTsKICB2YXIgaW50ZXJwb2xhdGVUcmFuc2Zvcm1TdmcgPSBpbnRlcnBvbGF0ZVRyYW5zZm9ybShwYXJzZVN2ZywgIiwgIiwgIikiLCAiKSIpOwoKICAvLyBub2RlX21vZHVsZXMvZDMtdGltZXIvc3JjL3RpbWVyLmpzCiAgdmFyIGZyYW1lID0gMDsKICB2YXIgdGltZW91dCA9IDA7CiAgdmFyIGludGVydmFsID0gMDsKICB2YXIgcG9rZURlbGF5ID0gMWUzOwogIHZhciB0YXNrSGVhZDsKICB2YXIgdGFza1RhaWw7CiAgdmFyIGNsb2NrTGFzdCA9IDA7CiAgdmFyIGNsb2NrTm93ID0gMDsKICB2YXIgY2xvY2tTa2V3ID0gMDsKICB2YXIgY2xvY2sgPSB0eXBlb2YgcGVyZm9ybWFuY2UgPT09ICJvYmplY3QiICYmIHBlcmZvcm1hbmNlLm5vdyA/IHBlcmZvcm1hbmNlIDogRGF0ZTsKICB2YXIgc2V0RnJhbWUgPSB0eXBlb2Ygd2luZG93ID09PSAib2JqZWN0IiAmJiB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lID8gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZS5iaW5kKHdpbmRvdykgOiBmdW5jdGlvbihmKSB7CiAgICBzZXRUaW1lb3V0KGYsIDE3KTsKICB9OwogIGZ1bmN0aW9uIG5vdygpIHsKICAgIHJldHVybiBjbG9ja05vdyB8fCAoc2V0RnJhbWUoY2xlYXJOb3cpLCBjbG9ja05vdyA9IGNsb2NrLm5vdygpICsgY2xvY2tTa2V3KTsKICB9CiAgZnVuY3Rpb24gY2xlYXJOb3coKSB7CiAgICBjbG9ja05vdyA9IDA7CiAgfQogIGZ1bmN0aW9uIFRpbWVyKCkgewogICAgdGhpcy5fY2FsbCA9IHRoaXMuX3RpbWUgPSB0aGlzLl9uZXh0ID0gbnVsbDsKICB9CiAgVGltZXIucHJvdG90eXBlID0gdGltZXIucHJvdG90eXBlID0gewogICAgY29uc3RydWN0b3I6IFRpbWVyLAogICAgcmVzdGFydDogZnVuY3Rpb24oY2FsbGJhY2ssIGRlbGF5LCB0aW1lKSB7CiAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT09ICJmdW5jdGlvbiIpCiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiY2FsbGJhY2sgaXMgbm90IGEgZnVuY3Rpb24iKTsKICAgICAgdGltZSA9ICh0aW1lID09IG51bGwgPyBub3coKSA6ICt0aW1lKSArIChkZWxheSA9PSBudWxsID8gMCA6ICtkZWxheSk7CiAgICAgIGlmICghdGhpcy5fbmV4dCAmJiB0YXNrVGFpbCAhPT0gdGhpcykgewogICAgICAgIGlmICh0YXNrVGFpbCkKICAgICAgICAgIHRhc2tUYWlsLl9uZXh0ID0gdGhpczsKICAgICAgICBlbHNlCiAgICAgICAgICB0YXNrSGVhZCA9IHRoaXM7CiAgICAgICAgdGFza1RhaWwgPSB0aGlzOwogICAgICB9CiAgICAgIHRoaXMuX2NhbGwgPSBjYWxsYmFjazsKICAgICAgdGhpcy5fdGltZSA9IHRpbWU7CiAgICAgIHNsZWVwKCk7CiAgICB9LAogICAgc3RvcDogZnVuY3Rpb24oKSB7CiAgICAgIGlmICh0aGlzLl9jYWxsKSB7CiAgICAgICAgdGhpcy5fY2FsbCA9IG51bGw7CiAgICAgICAgdGhpcy5fdGltZSA9IEluZmluaXR5OwogICAgICAgIHNsZWVwKCk7CiAgICAgIH0KICAgIH0KICB9OwogIGZ1bmN0aW9uIHRpbWVyKGNhbGxiYWNrLCBkZWxheSwgdGltZSkgewogICAgdmFyIHQgPSBuZXcgVGltZXIoKTsKICAgIHQucmVzdGFydChjYWxsYmFjaywgZGVsYXksIHRpbWUpOwogICAgcmV0dXJuIHQ7CiAgfQogIGZ1bmN0aW9uIHRpbWVyRmx1c2goKSB7CiAgICBub3coKTsKICAgICsrZnJhbWU7CiAgICB2YXIgdCA9IHRhc2tIZWFkLCBlOwogICAgd2hpbGUgKHQpIHsKICAgICAgaWYgKChlID0gY2xvY2tOb3cgLSB0Ll90aW1lKSA+PSAwKQogICAgICAgIHQuX2NhbGwuY2FsbCh2b2lkIDAsIGUpOwogICAgICB0ID0gdC5fbmV4dDsKICAgIH0KICAgIC0tZnJhbWU7CiAgfQogIGZ1bmN0aW9uIHdha2UoKSB7CiAgICBjbG9ja05vdyA9IChjbG9ja0xhc3QgPSBjbG9jay5ub3coKSkgKyBjbG9ja1NrZXc7CiAgICBmcmFtZSA9IHRpbWVvdXQgPSAwOwogICAgdHJ5IHsKICAgICAgdGltZXJGbHVzaCgpOwogICAgfSBmaW5hbGx5IHsKICAgICAgZnJhbWUgPSAwOwogICAgICBuYXAoKTsKICAgICAgY2xvY2tOb3cgPSAwOwogICAgfQogIH0KICBmdW5jdGlvbiBwb2tlKCkgewogICAgdmFyIG5vdzIgPSBjbG9jay5ub3coKSwgZGVsYXkgPSBub3cyIC0gY2xvY2tMYXN0OwogICAgaWYgKGRlbGF5ID4gcG9rZURlbGF5KQogICAgICBjbG9ja1NrZXcgLT0gZGVsYXksIGNsb2NrTGFzdCA9IG5vdzI7CiAgfQogIGZ1bmN0aW9uIG5hcCgpIHsKICAgIHZhciB0MCwgdDEgPSB0YXNrSGVhZCwgdDIsIHRpbWUgPSBJbmZpbml0eTsKICAgIHdoaWxlICh0MSkgewogICAgICBpZiAodDEuX2NhbGwpIHsKICAgICAgICBpZiAodGltZSA+IHQxLl90aW1lKQogICAgICAgICAgdGltZSA9IHQxLl90aW1lOwogICAgICAgIHQwID0gdDEsIHQxID0gdDEuX25leHQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdDIgPSB0MS5fbmV4dCwgdDEuX25leHQgPSBudWxsOwogICAgICAgIHQxID0gdDAgPyB0MC5fbmV4dCA9IHQyIDogdGFza0hlYWQgPSB0MjsKICAgICAgfQogICAgfQogICAgdGFza1RhaWwgPSB0MDsKICAgIHNsZWVwKHRpbWUpOwogIH0KICBmdW5jdGlvbiBzbGVlcCh0aW1lKSB7CiAgICBpZiAoZnJhbWUpCiAgICAgIHJldHVybjsKICAgIGlmICh0aW1lb3V0KQogICAgICB0aW1lb3V0ID0gY2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogICAgdmFyIGRlbGF5ID0gdGltZSAtIGNsb2NrTm93OwogICAgaWYgKGRlbGF5ID4gMjQpIHsKICAgICAgaWYgKHRpbWUgPCBJbmZpbml0eSkKICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dCh3YWtlLCB0aW1lIC0gY2xvY2subm93KCkgLSBjbG9ja1NrZXcpOwogICAgICBpZiAoaW50ZXJ2YWwpCiAgICAgICAgaW50ZXJ2YWwgPSBjbGVhckludGVydmFsKGludGVydmFsKTsKICAgIH0gZWxzZSB7CiAgICAgIGlmICghaW50ZXJ2YWwpCiAgICAgICAgY2xvY2tMYXN0ID0gY2xvY2subm93KCksIGludGVydmFsID0gc2V0SW50ZXJ2YWwocG9rZSwgcG9rZURlbGF5KTsKICAgICAgZnJhbWUgPSAxLCBzZXRGcmFtZSh3YWtlKTsKICAgIH0KICB9CgogIC8vIG5vZGVfbW9kdWxlcy9kMy10aW1lci9zcmMvdGltZW91dC5qcwogIGZ1bmN0aW9uIHRpbWVvdXRfZGVmYXVsdChjYWxsYmFjaywgZGVsYXksIHRpbWUpIHsKICAgIHZhciB0ID0gbmV3IFRpbWVyKCk7CiAgICBkZWxheSA9IGRlbGF5ID09IG51bGwgPyAwIDogK2RlbGF5OwogICAgdC5yZXN0YXJ0KChlbGFwc2VkKSA9PiB7CiAgICAgIHQuc3RvcCgpOwogICAgICBjYWxsYmFjayhlbGFwc2VkICsgZGVsYXkpOwogICAgfSwgZGVsYXksIHRpbWUpOwogICAgcmV0dXJuIHQ7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtdHJhbnNpdGlvbi9zcmMvdHJhbnNpdGlvbi9zY2hlZHVsZS5qcwogIHZhciBlbXB0eU9uID0gZGlzcGF0Y2hfZGVmYXVsdCgic3RhcnQiLCAiZW5kIiwgImNhbmNlbCIsICJpbnRlcnJ1cHQiKTsKICB2YXIgZW1wdHlUd2VlbiA9IFtdOwogIHZhciBDUkVBVEVEID0gMDsKICB2YXIgU0NIRURVTEVEID0gMTsKICB2YXIgU1RBUlRJTkcgPSAyOwogIHZhciBTVEFSVEVEID0gMzsKICB2YXIgUlVOTklORyA9IDQ7CiAgdmFyIEVORElORyA9IDU7CiAgdmFyIEVOREVEID0gNjsKICBmdW5jdGlvbiBzY2hlZHVsZV9kZWZhdWx0KG5vZGUsIG5hbWUsIGlkMiwgaW5kZXgyLCBncm91cCwgdGltaW5nKSB7CiAgICB2YXIgc2NoZWR1bGVzID0gbm9kZS5fX3RyYW5zaXRpb247CiAgICBpZiAoIXNjaGVkdWxlcykKICAgICAgbm9kZS5fX3RyYW5zaXRpb24gPSB7fTsKICAgIGVsc2UgaWYgKGlkMiBpbiBzY2hlZHVsZXMpCiAgICAgIHJldHVybjsKICAgIGNyZWF0ZShub2RlLCBpZDIsIHsKICAgICAgbmFtZSwKICAgICAgaW5kZXg6IGluZGV4MiwKICAgICAgLy8gRm9yIGNvbnRleHQgZHVyaW5nIGNhbGxiYWNrLgogICAgICBncm91cCwKICAgICAgLy8gRm9yIGNvbnRleHQgZHVyaW5nIGNhbGxiYWNrLgogICAgICBvbjogZW1wdHlPbiwKICAgICAgdHdlZW46IGVtcHR5VHdlZW4sCiAgICAgIHRpbWU6IHRpbWluZy50aW1lLAogICAgICBkZWxheTogdGltaW5nLmRlbGF5LAogICAgICBkdXJhdGlvbjogdGltaW5nLmR1cmF0aW9uLAogICAgICBlYXNlOiB0aW1pbmcuZWFzZSwKICAgICAgdGltZXI6IG51bGwsCiAgICAgIHN0YXRlOiBDUkVBVEVECiAgICB9KTsKICB9CiAgZnVuY3Rpb24gaW5pdChub2RlLCBpZDIpIHsKICAgIHZhciBzY2hlZHVsZSA9IGdldDIobm9kZSwgaWQyKTsKICAgIGlmIChzY2hlZHVsZS5zdGF0ZSA+IENSRUFURUQpCiAgICAgIHRocm93IG5ldyBFcnJvcigidG9vIGxhdGU7IGFscmVhZHkgc2NoZWR1bGVkIik7CiAgICByZXR1cm4gc2NoZWR1bGU7CiAgfQogIGZ1bmN0aW9uIHNldDIobm9kZSwgaWQyKSB7CiAgICB2YXIgc2NoZWR1bGUgPSBnZXQyKG5vZGUsIGlkMik7CiAgICBpZiAoc2NoZWR1bGUuc3RhdGUgPiBTVEFSVEVEKQogICAgICB0aHJvdyBuZXcgRXJyb3IoInRvbyBsYXRlOyBhbHJlYWR5IHJ1bm5pbmciKTsKICAgIHJldHVybiBzY2hlZHVsZTsKICB9CiAgZnVuY3Rpb24gZ2V0Mihub2RlLCBpZDIpIHsKICAgIHZhciBzY2hlZHVsZSA9IG5vZGUuX190cmFuc2l0aW9uOwogICAgaWYgKCFzY2hlZHVsZSB8fCAhKHNjaGVkdWxlID0gc2NoZWR1bGVbaWQyXSkpCiAgICAgIHRocm93IG5ldyBFcnJvcigidHJhbnNpdGlvbiBub3QgZm91bmQiKTsKICAgIHJldHVybiBzY2hlZHVsZTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlKG5vZGUsIGlkMiwgc2VsZikgewogICAgdmFyIHNjaGVkdWxlcyA9IG5vZGUuX190cmFuc2l0aW9uLCB0d2VlbjsKICAgIHNjaGVkdWxlc1tpZDJdID0gc2VsZjsKICAgIHNlbGYudGltZXIgPSB0aW1lcihzY2hlZHVsZSwgMCwgc2VsZi50aW1lKTsKICAgIGZ1bmN0aW9uIHNjaGVkdWxlKGVsYXBzZWQpIHsKICAgICAgc2VsZi5zdGF0ZSA9IFNDSEVEVUxFRDsKICAgICAgc2VsZi50aW1lci5yZXN0YXJ0KHN0YXJ0Miwgc2VsZi5kZWxheSwgc2VsZi50aW1lKTsKICAgICAgaWYgKHNlbGYuZGVsYXkgPD0gZWxhcHNlZCkKICAgICAgICBzdGFydDIoZWxhcHNlZCAtIHNlbGYuZGVsYXkpOwogICAgfQogICAgZnVuY3Rpb24gc3RhcnQyKGVsYXBzZWQpIHsKICAgICAgdmFyIGksIGosIG4sIG87CiAgICAgIGlmIChzZWxmLnN0YXRlICE9PSBTQ0hFRFVMRUQpCiAgICAgICAgcmV0dXJuIHN0b3AoKTsKICAgICAgZm9yIChpIGluIHNjaGVkdWxlcykgewogICAgICAgIG8gPSBzY2hlZHVsZXNbaV07CiAgICAgICAgaWYgKG8ubmFtZSAhPT0gc2VsZi5uYW1lKQogICAgICAgICAgY29udGludWU7CiAgICAgICAgaWYgKG8uc3RhdGUgPT09IFNUQVJURUQpCiAgICAgICAgICByZXR1cm4gdGltZW91dF9kZWZhdWx0KHN0YXJ0Mik7CiAgICAgICAgaWYgKG8uc3RhdGUgPT09IFJVTk5JTkcpIHsKICAgICAgICAgIG8uc3RhdGUgPSBFTkRFRDsKICAgICAgICAgIG8udGltZXIuc3RvcCgpOwogICAgICAgICAgby5vbi5jYWxsKCJpbnRlcnJ1cHQiLCBub2RlLCBub2RlLl9fZGF0YV9fLCBvLmluZGV4LCBvLmdyb3VwKTsKICAgICAgICAgIGRlbGV0ZSBzY2hlZHVsZXNbaV07CiAgICAgICAgfSBlbHNlIGlmICgraSA8IGlkMikgewogICAgICAgICAgby5zdGF0ZSA9IEVOREVEOwogICAgICAgICAgby50aW1lci5zdG9wKCk7CiAgICAgICAgICBvLm9uLmNhbGwoImNhbmNlbCIsIG5vZGUsIG5vZGUuX19kYXRhX18sIG8uaW5kZXgsIG8uZ3JvdXApOwogICAgICAgICAgZGVsZXRlIHNjaGVkdWxlc1tpXTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGltZW91dF9kZWZhdWx0KGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChzZWxmLnN0YXRlID09PSBTVEFSVEVEKSB7CiAgICAgICAgICBzZWxmLnN0YXRlID0gUlVOTklORzsKICAgICAgICAgIHNlbGYudGltZXIucmVzdGFydCh0aWNrLCBzZWxmLmRlbGF5LCBzZWxmLnRpbWUpOwogICAgICAgICAgdGljayhlbGFwc2VkKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBzZWxmLnN0YXRlID0gU1RBUlRJTkc7CiAgICAgIHNlbGYub24uY2FsbCgic3RhcnQiLCBub2RlLCBub2RlLl9fZGF0YV9fLCBzZWxmLmluZGV4LCBzZWxmLmdyb3VwKTsKICAgICAgaWYgKHNlbGYuc3RhdGUgIT09IFNUQVJUSU5HKQogICAgICAgIHJldHVybjsKICAgICAgc2VsZi5zdGF0ZSA9IFNUQVJURUQ7CiAgICAgIHR3ZWVuID0gbmV3IEFycmF5KG4gPSBzZWxmLnR3ZWVuLmxlbmd0aCk7CiAgICAgIGZvciAoaSA9IDAsIGogPSAtMTsgaSA8IG47ICsraSkgewogICAgICAgIGlmIChvID0gc2VsZi50d2VlbltpXS52YWx1ZS5jYWxsKG5vZGUsIG5vZGUuX19kYXRhX18sIHNlbGYuaW5kZXgsIHNlbGYuZ3JvdXApKSB7CiAgICAgICAgICB0d2VlblsrK2pdID0gbzsKICAgICAgICB9CiAgICAgIH0KICAgICAgdHdlZW4ubGVuZ3RoID0gaiArIDE7CiAgICB9CiAgICBmdW5jdGlvbiB0aWNrKGVsYXBzZWQpIHsKICAgICAgdmFyIHQgPSBlbGFwc2VkIDwgc2VsZi5kdXJhdGlvbiA/IHNlbGYuZWFzZS5jYWxsKG51bGwsIGVsYXBzZWQgLyBzZWxmLmR1cmF0aW9uKSA6IChzZWxmLnRpbWVyLnJlc3RhcnQoc3RvcCksIHNlbGYuc3RhdGUgPSBFTkRJTkcsIDEpLCBpID0gLTEsIG4gPSB0d2Vlbi5sZW5ndGg7CiAgICAgIHdoaWxlICgrK2kgPCBuKSB7CiAgICAgICAgdHdlZW5baV0uY2FsbChub2RlLCB0KTsKICAgICAgfQogICAgICBpZiAoc2VsZi5zdGF0ZSA9PT0gRU5ESU5HKSB7CiAgICAgICAgc2VsZi5vbi5jYWxsKCJlbmQiLCBub2RlLCBub2RlLl9fZGF0YV9fLCBzZWxmLmluZGV4LCBzZWxmLmdyb3VwKTsKICAgICAgICBzdG9wKCk7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIHN0b3AoKSB7CiAgICAgIHNlbGYuc3RhdGUgPSBFTkRFRDsKICAgICAgc2VsZi50aW1lci5zdG9wKCk7CiAgICAgIGRlbGV0ZSBzY2hlZHVsZXNbaWQyXTsKICAgICAgZm9yICh2YXIgaSBpbiBzY2hlZHVsZXMpCiAgICAgICAgcmV0dXJuOwogICAgICBkZWxldGUgbm9kZS5fX3RyYW5zaXRpb247CiAgICB9CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtdHJhbnNpdGlvbi9zcmMvaW50ZXJydXB0LmpzCiAgZnVuY3Rpb24gaW50ZXJydXB0X2RlZmF1bHQobm9kZSwgbmFtZSkgewogICAgdmFyIHNjaGVkdWxlcyA9IG5vZGUuX190cmFuc2l0aW9uLCBzY2hlZHVsZSwgYWN0aXZlLCBlbXB0eTIgPSB0cnVlLCBpOwogICAgaWYgKCFzY2hlZHVsZXMpCiAgICAgIHJldHVybjsKICAgIG5hbWUgPSBuYW1lID09IG51bGwgPyBudWxsIDogbmFtZSArICIiOwogICAgZm9yIChpIGluIHNjaGVkdWxlcykgewogICAgICBpZiAoKHNjaGVkdWxlID0gc2NoZWR1bGVzW2ldKS5uYW1lICE9PSBuYW1lKSB7CiAgICAgICAgZW1wdHkyID0gZmFsc2U7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgYWN0aXZlID0gc2NoZWR1bGUuc3RhdGUgPiBTVEFSVElORyAmJiBzY2hlZHVsZS5zdGF0ZSA8IEVORElORzsKICAgICAgc2NoZWR1bGUuc3RhdGUgPSBFTkRFRDsKICAgICAgc2NoZWR1bGUudGltZXIuc3RvcCgpOwogICAgICBzY2hlZHVsZS5vbi5jYWxsKGFjdGl2ZSA/ICJpbnRlcnJ1cHQiIDogImNhbmNlbCIsIG5vZGUsIG5vZGUuX19kYXRhX18sIHNjaGVkdWxlLmluZGV4LCBzY2hlZHVsZS5ncm91cCk7CiAgICAgIGRlbGV0ZSBzY2hlZHVsZXNbaV07CiAgICB9CiAgICBpZiAoZW1wdHkyKQogICAgICBkZWxldGUgbm9kZS5fX3RyYW5zaXRpb247CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtdHJhbnNpdGlvbi9zcmMvc2VsZWN0aW9uL2ludGVycnVwdC5qcwogIGZ1bmN0aW9uIGludGVycnVwdF9kZWZhdWx0MihuYW1lKSB7CiAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICBpbnRlcnJ1cHRfZGVmYXVsdCh0aGlzLCBuYW1lKTsKICAgIH0pOwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLXRyYW5zaXRpb24vc3JjL3RyYW5zaXRpb24vdHdlZW4uanMKICBmdW5jdGlvbiB0d2VlblJlbW92ZShpZDIsIG5hbWUpIHsKICAgIHZhciB0d2VlbjAsIHR3ZWVuMTsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHNjaGVkdWxlID0gc2V0Mih0aGlzLCBpZDIpLCB0d2VlbiA9IHNjaGVkdWxlLnR3ZWVuOwogICAgICBpZiAodHdlZW4gIT09IHR3ZWVuMCkgewogICAgICAgIHR3ZWVuMSA9IHR3ZWVuMCA9IHR3ZWVuOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBuID0gdHdlZW4xLmxlbmd0aDsgaSA8IG47ICsraSkgewogICAgICAgICAgaWYgKHR3ZWVuMVtpXS5uYW1lID09PSBuYW1lKSB7CiAgICAgICAgICAgIHR3ZWVuMSA9IHR3ZWVuMS5zbGljZSgpOwogICAgICAgICAgICB0d2VlbjEuc3BsaWNlKGksIDEpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgc2NoZWR1bGUudHdlZW4gPSB0d2VlbjE7CiAgICB9OwogIH0KICBmdW5jdGlvbiB0d2VlbkZ1bmN0aW9uKGlkMiwgbmFtZSwgdmFsdWUpIHsKICAgIHZhciB0d2VlbjAsIHR3ZWVuMTsKICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICJmdW5jdGlvbiIpCiAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgc2NoZWR1bGUgPSBzZXQyKHRoaXMsIGlkMiksIHR3ZWVuID0gc2NoZWR1bGUudHdlZW47CiAgICAgIGlmICh0d2VlbiAhPT0gdHdlZW4wKSB7CiAgICAgICAgdHdlZW4xID0gKHR3ZWVuMCA9IHR3ZWVuKS5zbGljZSgpOwogICAgICAgIGZvciAodmFyIHQgPSB7IG5hbWUsIHZhbHVlIH0sIGkgPSAwLCBuID0gdHdlZW4xLmxlbmd0aDsgaSA8IG47ICsraSkgewogICAgICAgICAgaWYgKHR3ZWVuMVtpXS5uYW1lID09PSBuYW1lKSB7CiAgICAgICAgICAgIHR3ZWVuMVtpXSA9IHQ7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoaSA9PT0gbikKICAgICAgICAgIHR3ZWVuMS5wdXNoKHQpOwogICAgICB9CiAgICAgIHNjaGVkdWxlLnR3ZWVuID0gdHdlZW4xOwogICAgfTsKICB9CiAgZnVuY3Rpb24gdHdlZW5fZGVmYXVsdChuYW1lLCB2YWx1ZSkgewogICAgdmFyIGlkMiA9IHRoaXMuX2lkOwogICAgbmFtZSArPSAiIjsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDwgMikgewogICAgICB2YXIgdHdlZW4gPSBnZXQyKHRoaXMubm9kZSgpLCBpZDIpLnR3ZWVuOwogICAgICBmb3IgKHZhciBpID0gMCwgbiA9IHR3ZWVuLmxlbmd0aCwgdDsgaSA8IG47ICsraSkgewogICAgICAgIGlmICgodCA9IHR3ZWVuW2ldKS5uYW1lID09PSBuYW1lKSB7CiAgICAgICAgICByZXR1cm4gdC52YWx1ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICByZXR1cm4gdGhpcy5lYWNoKCh2YWx1ZSA9PSBudWxsID8gdHdlZW5SZW1vdmUgOiB0d2VlbkZ1bmN0aW9uKShpZDIsIG5hbWUsIHZhbHVlKSk7CiAgfQogIGZ1bmN0aW9uIHR3ZWVuVmFsdWUodHJhbnNpdGlvbjIsIG5hbWUsIHZhbHVlKSB7CiAgICB2YXIgaWQyID0gdHJhbnNpdGlvbjIuX2lkOwogICAgdHJhbnNpdGlvbjIuZWFjaChmdW5jdGlvbigpIHsKICAgICAgdmFyIHNjaGVkdWxlID0gc2V0Mih0aGlzLCBpZDIpOwogICAgICAoc2NoZWR1bGUudmFsdWUgfHwgKHNjaGVkdWxlLnZhbHVlID0ge30pKVtuYW1lXSA9IHZhbHVlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9KTsKICAgIHJldHVybiBmdW5jdGlvbihub2RlKSB7CiAgICAgIHJldHVybiBnZXQyKG5vZGUsIGlkMikudmFsdWVbbmFtZV07CiAgICB9OwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLXRyYW5zaXRpb24vc3JjL3RyYW5zaXRpb24vaW50ZXJwb2xhdGUuanMKICBmdW5jdGlvbiBpbnRlcnBvbGF0ZV9kZWZhdWx0KGEyLCBiKSB7CiAgICB2YXIgYzI7CiAgICByZXR1cm4gKHR5cGVvZiBiID09PSAibnVtYmVyIiA/IG51bWJlcl9kZWZhdWx0IDogYiBpbnN0YW5jZW9mIGNvbG9yID8gcmdiX2RlZmF1bHQgOiAoYzIgPSBjb2xvcihiKSkgPyAoYiA9IGMyLCByZ2JfZGVmYXVsdCkgOiBzdHJpbmdfZGVmYXVsdCkoYTIsIGIpOwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLXRyYW5zaXRpb24vc3JjL3RyYW5zaXRpb24vYXR0ci5qcwogIGZ1bmN0aW9uIGF0dHJSZW1vdmUyKG5hbWUpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5yZW1vdmVBdHRyaWJ1dGUobmFtZSk7CiAgICB9OwogIH0KICBmdW5jdGlvbiBhdHRyUmVtb3ZlTlMyKGZ1bGxuYW1lKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMucmVtb3ZlQXR0cmlidXRlTlMoZnVsbG5hbWUuc3BhY2UsIGZ1bGxuYW1lLmxvY2FsKTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIGF0dHJDb25zdGFudDIobmFtZSwgaW50ZXJwb2xhdGUsIHZhbHVlMSkgewogICAgdmFyIHN0cmluZzAwLCBzdHJpbmcxID0gdmFsdWUxICsgIiIsIGludGVycG9sYXRlMDsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHN0cmluZzAgPSB0aGlzLmdldEF0dHJpYnV0ZShuYW1lKTsKICAgICAgcmV0dXJuIHN0cmluZzAgPT09IHN0cmluZzEgPyBudWxsIDogc3RyaW5nMCA9PT0gc3RyaW5nMDAgPyBpbnRlcnBvbGF0ZTAgOiBpbnRlcnBvbGF0ZTAgPSBpbnRlcnBvbGF0ZShzdHJpbmcwMCA9IHN0cmluZzAsIHZhbHVlMSk7CiAgICB9OwogIH0KICBmdW5jdGlvbiBhdHRyQ29uc3RhbnROUzIoZnVsbG5hbWUsIGludGVycG9sYXRlLCB2YWx1ZTEpIHsKICAgIHZhciBzdHJpbmcwMCwgc3RyaW5nMSA9IHZhbHVlMSArICIiLCBpbnRlcnBvbGF0ZTA7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzdHJpbmcwID0gdGhpcy5nZXRBdHRyaWJ1dGVOUyhmdWxsbmFtZS5zcGFjZSwgZnVsbG5hbWUubG9jYWwpOwogICAgICByZXR1cm4gc3RyaW5nMCA9PT0gc3RyaW5nMSA/IG51bGwgOiBzdHJpbmcwID09PSBzdHJpbmcwMCA/IGludGVycG9sYXRlMCA6IGludGVycG9sYXRlMCA9IGludGVycG9sYXRlKHN0cmluZzAwID0gc3RyaW5nMCwgdmFsdWUxKTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIGF0dHJGdW5jdGlvbjIobmFtZSwgaW50ZXJwb2xhdGUsIHZhbHVlKSB7CiAgICB2YXIgc3RyaW5nMDAsIHN0cmluZzEwLCBpbnRlcnBvbGF0ZTA7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzdHJpbmcwLCB2YWx1ZTEgPSB2YWx1ZSh0aGlzKSwgc3RyaW5nMTsKICAgICAgaWYgKHZhbHVlMSA9PSBudWxsKQogICAgICAgIHJldHVybiB2b2lkIHRoaXMucmVtb3ZlQXR0cmlidXRlKG5hbWUpOwogICAgICBzdHJpbmcwID0gdGhpcy5nZXRBdHRyaWJ1dGUobmFtZSk7CiAgICAgIHN0cmluZzEgPSB2YWx1ZTEgKyAiIjsKICAgICAgcmV0dXJuIHN0cmluZzAgPT09IHN0cmluZzEgPyBudWxsIDogc3RyaW5nMCA9PT0gc3RyaW5nMDAgJiYgc3RyaW5nMSA9PT0gc3RyaW5nMTAgPyBpbnRlcnBvbGF0ZTAgOiAoc3RyaW5nMTAgPSBzdHJpbmcxLCBpbnRlcnBvbGF0ZTAgPSBpbnRlcnBvbGF0ZShzdHJpbmcwMCA9IHN0cmluZzAsIHZhbHVlMSkpOwogICAgfTsKICB9CiAgZnVuY3Rpb24gYXR0ckZ1bmN0aW9uTlMyKGZ1bGxuYW1lLCBpbnRlcnBvbGF0ZSwgdmFsdWUpIHsKICAgIHZhciBzdHJpbmcwMCwgc3RyaW5nMTAsIGludGVycG9sYXRlMDsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHN0cmluZzAsIHZhbHVlMSA9IHZhbHVlKHRoaXMpLCBzdHJpbmcxOwogICAgICBpZiAodmFsdWUxID09IG51bGwpCiAgICAgICAgcmV0dXJuIHZvaWQgdGhpcy5yZW1vdmVBdHRyaWJ1dGVOUyhmdWxsbmFtZS5zcGFjZSwgZnVsbG5hbWUubG9jYWwpOwogICAgICBzdHJpbmcwID0gdGhpcy5nZXRBdHRyaWJ1dGVOUyhmdWxsbmFtZS5zcGFjZSwgZnVsbG5hbWUubG9jYWwpOwogICAgICBzdHJpbmcxID0gdmFsdWUxICsgIiI7CiAgICAgIHJldHVybiBzdHJpbmcwID09PSBzdHJpbmcxID8gbnVsbCA6IHN0cmluZzAgPT09IHN0cmluZzAwICYmIHN0cmluZzEgPT09IHN0cmluZzEwID8gaW50ZXJwb2xhdGUwIDogKHN0cmluZzEwID0gc3RyaW5nMSwgaW50ZXJwb2xhdGUwID0gaW50ZXJwb2xhdGUoc3RyaW5nMDAgPSBzdHJpbmcwLCB2YWx1ZTEpKTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIGF0dHJfZGVmYXVsdDIobmFtZSwgdmFsdWUpIHsKICAgIHZhciBmdWxsbmFtZSA9IG5hbWVzcGFjZV9kZWZhdWx0KG5hbWUpLCBpID0gZnVsbG5hbWUgPT09ICJ0cmFuc2Zvcm0iID8gaW50ZXJwb2xhdGVUcmFuc2Zvcm1TdmcgOiBpbnRlcnBvbGF0ZV9kZWZhdWx0OwogICAgcmV0dXJuIHRoaXMuYXR0clR3ZWVuKG5hbWUsIHR5cGVvZiB2YWx1ZSA9PT0gImZ1bmN0aW9uIiA/IChmdWxsbmFtZS5sb2NhbCA/IGF0dHJGdW5jdGlvbk5TMiA6IGF0dHJGdW5jdGlvbjIpKGZ1bGxuYW1lLCBpLCB0d2VlblZhbHVlKHRoaXMsICJhdHRyLiIgKyBuYW1lLCB2YWx1ZSkpIDogdmFsdWUgPT0gbnVsbCA/IChmdWxsbmFtZS5sb2NhbCA/IGF0dHJSZW1vdmVOUzIgOiBhdHRyUmVtb3ZlMikoZnVsbG5hbWUpIDogKGZ1bGxuYW1lLmxvY2FsID8gYXR0ckNvbnN0YW50TlMyIDogYXR0ckNvbnN0YW50MikoZnVsbG5hbWUsIGksIHZhbHVlKSk7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtdHJhbnNpdGlvbi9zcmMvdHJhbnNpdGlvbi9hdHRyVHdlZW4uanMKICBmdW5jdGlvbiBhdHRySW50ZXJwb2xhdGUobmFtZSwgaSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUobmFtZSwgaS5jYWxsKHRoaXMsIHQpKTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIGF0dHJJbnRlcnBvbGF0ZU5TKGZ1bGxuYW1lLCBpKSB7CiAgICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgICB0aGlzLnNldEF0dHJpYnV0ZU5TKGZ1bGxuYW1lLnNwYWNlLCBmdWxsbmFtZS5sb2NhbCwgaS5jYWxsKHRoaXMsIHQpKTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIGF0dHJUd2Vlbk5TKGZ1bGxuYW1lLCB2YWx1ZSkgewogICAgdmFyIHQwLCBpMDsKICAgIGZ1bmN0aW9uIHR3ZWVuKCkgewogICAgICB2YXIgaSA9IHZhbHVlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIGlmIChpICE9PSBpMCkKICAgICAgICB0MCA9IChpMCA9IGkpICYmIGF0dHJJbnRlcnBvbGF0ZU5TKGZ1bGxuYW1lLCBpKTsKICAgICAgcmV0dXJuIHQwOwogICAgfQogICAgdHdlZW4uX3ZhbHVlID0gdmFsdWU7CiAgICByZXR1cm4gdHdlZW47CiAgfQogIGZ1bmN0aW9uIGF0dHJUd2VlbihuYW1lLCB2YWx1ZSkgewogICAgdmFyIHQwLCBpMDsKICAgIGZ1bmN0aW9uIHR3ZWVuKCkgewogICAgICB2YXIgaSA9IHZhbHVlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIGlmIChpICE9PSBpMCkKICAgICAgICB0MCA9IChpMCA9IGkpICYmIGF0dHJJbnRlcnBvbGF0ZShuYW1lLCBpKTsKICAgICAgcmV0dXJuIHQwOwogICAgfQogICAgdHdlZW4uX3ZhbHVlID0gdmFsdWU7CiAgICByZXR1cm4gdHdlZW47CiAgfQogIGZ1bmN0aW9uIGF0dHJUd2Vlbl9kZWZhdWx0KG5hbWUsIHZhbHVlKSB7CiAgICB2YXIga2V5ID0gImF0dHIuIiArIG5hbWU7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8IDIpCiAgICAgIHJldHVybiAoa2V5ID0gdGhpcy50d2VlbihrZXkpKSAmJiBrZXkuX3ZhbHVlOwogICAgaWYgKHZhbHVlID09IG51bGwpCiAgICAgIHJldHVybiB0aGlzLnR3ZWVuKGtleSwgbnVsbCk7CiAgICBpZiAodHlwZW9mIHZhbHVlICE9PSAiZnVuY3Rpb24iKQogICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgIHZhciBmdWxsbmFtZSA9IG5hbWVzcGFjZV9kZWZhdWx0KG5hbWUpOwogICAgcmV0dXJuIHRoaXMudHdlZW4oa2V5LCAoZnVsbG5hbWUubG9jYWwgPyBhdHRyVHdlZW5OUyA6IGF0dHJUd2VlbikoZnVsbG5hbWUsIHZhbHVlKSk7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtdHJhbnNpdGlvbi9zcmMvdHJhbnNpdGlvbi9kZWxheS5qcwogIGZ1bmN0aW9uIGRlbGF5RnVuY3Rpb24oaWQyLCB2YWx1ZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBpbml0KHRoaXMsIGlkMikuZGVsYXkgPSArdmFsdWUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIGRlbGF5Q29uc3RhbnQoaWQyLCB2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlID0gK3ZhbHVlLCBmdW5jdGlvbigpIHsKICAgICAgaW5pdCh0aGlzLCBpZDIpLmRlbGF5ID0gdmFsdWU7CiAgICB9OwogIH0KICBmdW5jdGlvbiBkZWxheV9kZWZhdWx0KHZhbHVlKSB7CiAgICB2YXIgaWQyID0gdGhpcy5faWQ7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IHRoaXMuZWFjaCgodHlwZW9mIHZhbHVlID09PSAiZnVuY3Rpb24iID8gZGVsYXlGdW5jdGlvbiA6IGRlbGF5Q29uc3RhbnQpKGlkMiwgdmFsdWUpKSA6IGdldDIodGhpcy5ub2RlKCksIGlkMikuZGVsYXk7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtdHJhbnNpdGlvbi9zcmMvdHJhbnNpdGlvbi9kdXJhdGlvbi5qcwogIGZ1bmN0aW9uIGR1cmF0aW9uRnVuY3Rpb24oaWQyLCB2YWx1ZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBzZXQyKHRoaXMsIGlkMikuZHVyYXRpb24gPSArdmFsdWUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIGR1cmF0aW9uQ29uc3RhbnQoaWQyLCB2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlID0gK3ZhbHVlLCBmdW5jdGlvbigpIHsKICAgICAgc2V0Mih0aGlzLCBpZDIpLmR1cmF0aW9uID0gdmFsdWU7CiAgICB9OwogIH0KICBmdW5jdGlvbiBkdXJhdGlvbl9kZWZhdWx0KHZhbHVlKSB7CiAgICB2YXIgaWQyID0gdGhpcy5faWQ7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IHRoaXMuZWFjaCgodHlwZW9mIHZhbHVlID09PSAiZnVuY3Rpb24iID8gZHVyYXRpb25GdW5jdGlvbiA6IGR1cmF0aW9uQ29uc3RhbnQpKGlkMiwgdmFsdWUpKSA6IGdldDIodGhpcy5ub2RlKCksIGlkMikuZHVyYXRpb247CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtdHJhbnNpdGlvbi9zcmMvdHJhbnNpdGlvbi9lYXNlLmpzCiAgZnVuY3Rpb24gZWFzZUNvbnN0YW50KGlkMiwgdmFsdWUpIHsKICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICJmdW5jdGlvbiIpCiAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBzZXQyKHRoaXMsIGlkMikuZWFzZSA9IHZhbHVlOwogICAgfTsKICB9CiAgZnVuY3Rpb24gZWFzZV9kZWZhdWx0KHZhbHVlKSB7CiAgICB2YXIgaWQyID0gdGhpcy5faWQ7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IHRoaXMuZWFjaChlYXNlQ29uc3RhbnQoaWQyLCB2YWx1ZSkpIDogZ2V0Mih0aGlzLm5vZGUoKSwgaWQyKS5lYXNlOwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLXRyYW5zaXRpb24vc3JjL3RyYW5zaXRpb24vZWFzZVZhcnlpbmcuanMKICBmdW5jdGlvbiBlYXNlVmFyeWluZyhpZDIsIHZhbHVlKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciB2ID0gdmFsdWUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgaWYgKHR5cGVvZiB2ICE9PSAiZnVuY3Rpb24iKQogICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICBzZXQyKHRoaXMsIGlkMikuZWFzZSA9IHY7CiAgICB9OwogIH0KICBmdW5jdGlvbiBlYXNlVmFyeWluZ19kZWZhdWx0KHZhbHVlKSB7CiAgICBpZiAodHlwZW9mIHZhbHVlICE9PSAiZnVuY3Rpb24iKQogICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgIHJldHVybiB0aGlzLmVhY2goZWFzZVZhcnlpbmcodGhpcy5faWQsIHZhbHVlKSk7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtdHJhbnNpdGlvbi9zcmMvdHJhbnNpdGlvbi9maWx0ZXIuanMKICBmdW5jdGlvbiBmaWx0ZXJfZGVmYXVsdDIobWF0Y2gpIHsKICAgIGlmICh0eXBlb2YgbWF0Y2ggIT09ICJmdW5jdGlvbiIpCiAgICAgIG1hdGNoID0gbWF0Y2hlcl9kZWZhdWx0KG1hdGNoKTsKICAgIGZvciAodmFyIGdyb3VwcyA9IHRoaXMuX2dyb3VwcywgbTIgPSBncm91cHMubGVuZ3RoLCBzdWJncm91cHMgPSBuZXcgQXJyYXkobTIpLCBqID0gMDsgaiA8IG0yOyArK2opIHsKICAgICAgZm9yICh2YXIgZ3JvdXAgPSBncm91cHNbal0sIG4gPSBncm91cC5sZW5ndGgsIHN1Ymdyb3VwID0gc3ViZ3JvdXBzW2pdID0gW10sIG5vZGUsIGkgPSAwOyBpIDwgbjsgKytpKSB7CiAgICAgICAgaWYgKChub2RlID0gZ3JvdXBbaV0pICYmIG1hdGNoLmNhbGwobm9kZSwgbm9kZS5fX2RhdGFfXywgaSwgZ3JvdXApKSB7CiAgICAgICAgICBzdWJncm91cC5wdXNoKG5vZGUpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIG5ldyBUcmFuc2l0aW9uKHN1Ymdyb3VwcywgdGhpcy5fcGFyZW50cywgdGhpcy5fbmFtZSwgdGhpcy5faWQpOwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLXRyYW5zaXRpb24vc3JjL3RyYW5zaXRpb24vbWVyZ2UuanMKICBmdW5jdGlvbiBtZXJnZV9kZWZhdWx0Mih0cmFuc2l0aW9uMikgewogICAgaWYgKHRyYW5zaXRpb24yLl9pZCAhPT0gdGhpcy5faWQpCiAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgZm9yICh2YXIgZ3JvdXBzMCA9IHRoaXMuX2dyb3VwcywgZ3JvdXBzMSA9IHRyYW5zaXRpb24yLl9ncm91cHMsIG0wID0gZ3JvdXBzMC5sZW5ndGgsIG0xID0gZ3JvdXBzMS5sZW5ndGgsIG0yID0gTWF0aC5taW4obTAsIG0xKSwgbWVyZ2VzID0gbmV3IEFycmF5KG0wKSwgaiA9IDA7IGogPCBtMjsgKytqKSB7CiAgICAgIGZvciAodmFyIGdyb3VwMCA9IGdyb3VwczBbal0sIGdyb3VwMSA9IGdyb3VwczFbal0sIG4gPSBncm91cDAubGVuZ3RoLCBtZXJnZSA9IG1lcmdlc1tqXSA9IG5ldyBBcnJheShuKSwgbm9kZSwgaSA9IDA7IGkgPCBuOyArK2kpIHsKICAgICAgICBpZiAobm9kZSA9IGdyb3VwMFtpXSB8fCBncm91cDFbaV0pIHsKICAgICAgICAgIG1lcmdlW2ldID0gbm9kZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGZvciAoOyBqIDwgbTA7ICsraikgewogICAgICBtZXJnZXNbal0gPSBncm91cHMwW2pdOwogICAgfQogICAgcmV0dXJuIG5ldyBUcmFuc2l0aW9uKG1lcmdlcywgdGhpcy5fcGFyZW50cywgdGhpcy5fbmFtZSwgdGhpcy5faWQpOwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLXRyYW5zaXRpb24vc3JjL3RyYW5zaXRpb24vb24uanMKICBmdW5jdGlvbiBzdGFydChuYW1lKSB7CiAgICByZXR1cm4gKG5hbWUgKyAiIikudHJpbSgpLnNwbGl0KC9efFxzKy8pLmV2ZXJ5KGZ1bmN0aW9uKHQpIHsKICAgICAgdmFyIGkgPSB0LmluZGV4T2YoIi4iKTsKICAgICAgaWYgKGkgPj0gMCkKICAgICAgICB0ID0gdC5zbGljZSgwLCBpKTsKICAgICAgcmV0dXJuICF0IHx8IHQgPT09ICJzdGFydCI7CiAgICB9KTsKICB9CiAgZnVuY3Rpb24gb25GdW5jdGlvbihpZDIsIG5hbWUsIGxpc3RlbmVyKSB7CiAgICB2YXIgb24wLCBvbjEsIHNpdCA9IHN0YXJ0KG5hbWUpID8gaW5pdCA6IHNldDI7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzY2hlZHVsZSA9IHNpdCh0aGlzLCBpZDIpLCBvbiA9IHNjaGVkdWxlLm9uOwogICAgICBpZiAob24gIT09IG9uMCkKICAgICAgICAob24xID0gKG9uMCA9IG9uKS5jb3B5KCkpLm9uKG5hbWUsIGxpc3RlbmVyKTsKICAgICAgc2NoZWR1bGUub24gPSBvbjE7CiAgICB9OwogIH0KICBmdW5jdGlvbiBvbl9kZWZhdWx0MihuYW1lLCBsaXN0ZW5lcikgewogICAgdmFyIGlkMiA9IHRoaXMuX2lkOwogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPCAyID8gZ2V0Mih0aGlzLm5vZGUoKSwgaWQyKS5vbi5vbihuYW1lKSA6IHRoaXMuZWFjaChvbkZ1bmN0aW9uKGlkMiwgbmFtZSwgbGlzdGVuZXIpKTsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9kMy10cmFuc2l0aW9uL3NyYy90cmFuc2l0aW9uL3JlbW92ZS5qcwogIGZ1bmN0aW9uIHJlbW92ZUZ1bmN0aW9uKGlkMikgewogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgcGFyZW50ID0gdGhpcy5wYXJlbnROb2RlOwogICAgICBmb3IgKHZhciBpIGluIHRoaXMuX190cmFuc2l0aW9uKQogICAgICAgIGlmICgraSAhPT0gaWQyKQogICAgICAgICAgcmV0dXJuOwogICAgICBpZiAocGFyZW50KQogICAgICAgIHBhcmVudC5yZW1vdmVDaGlsZCh0aGlzKTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIHJlbW92ZV9kZWZhdWx0MigpIHsKICAgIHJldHVybiB0aGlzLm9uKCJlbmQucmVtb3ZlIiwgcmVtb3ZlRnVuY3Rpb24odGhpcy5faWQpKTsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9kMy10cmFuc2l0aW9uL3NyYy90cmFuc2l0aW9uL3NlbGVjdC5qcwogIGZ1bmN0aW9uIHNlbGVjdF9kZWZhdWx0MyhzZWxlY3QpIHsKICAgIHZhciBuYW1lID0gdGhpcy5fbmFtZSwgaWQyID0gdGhpcy5faWQ7CiAgICBpZiAodHlwZW9mIHNlbGVjdCAhPT0gImZ1bmN0aW9uIikKICAgICAgc2VsZWN0ID0gc2VsZWN0b3JfZGVmYXVsdChzZWxlY3QpOwogICAgZm9yICh2YXIgZ3JvdXBzID0gdGhpcy5fZ3JvdXBzLCBtMiA9IGdyb3Vwcy5sZW5ndGgsIHN1Ymdyb3VwcyA9IG5ldyBBcnJheShtMiksIGogPSAwOyBqIDwgbTI7ICsraikgewogICAgICBmb3IgKHZhciBncm91cCA9IGdyb3Vwc1tqXSwgbiA9IGdyb3VwLmxlbmd0aCwgc3ViZ3JvdXAgPSBzdWJncm91cHNbal0gPSBuZXcgQXJyYXkobiksIG5vZGUsIHN1Ym5vZGUsIGkgPSAwOyBpIDwgbjsgKytpKSB7CiAgICAgICAgaWYgKChub2RlID0gZ3JvdXBbaV0pICYmIChzdWJub2RlID0gc2VsZWN0LmNhbGwobm9kZSwgbm9kZS5fX2RhdGFfXywgaSwgZ3JvdXApKSkgewogICAgICAgICAgaWYgKCJfX2RhdGFfXyIgaW4gbm9kZSkKICAgICAgICAgICAgc3Vibm9kZS5fX2RhdGFfXyA9IG5vZGUuX19kYXRhX187CiAgICAgICAgICBzdWJncm91cFtpXSA9IHN1Ym5vZGU7CiAgICAgICAgICBzY2hlZHVsZV9kZWZhdWx0KHN1Ymdyb3VwW2ldLCBuYW1lLCBpZDIsIGksIHN1Ymdyb3VwLCBnZXQyKG5vZGUsIGlkMikpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIG5ldyBUcmFuc2l0aW9uKHN1Ymdyb3VwcywgdGhpcy5fcGFyZW50cywgbmFtZSwgaWQyKTsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9kMy10cmFuc2l0aW9uL3NyYy90cmFuc2l0aW9uL3NlbGVjdEFsbC5qcwogIGZ1bmN0aW9uIHNlbGVjdEFsbF9kZWZhdWx0MihzZWxlY3QpIHsKICAgIHZhciBuYW1lID0gdGhpcy5fbmFtZSwgaWQyID0gdGhpcy5faWQ7CiAgICBpZiAodHlwZW9mIHNlbGVjdCAhPT0gImZ1bmN0aW9uIikKICAgICAgc2VsZWN0ID0gc2VsZWN0b3JBbGxfZGVmYXVsdChzZWxlY3QpOwogICAgZm9yICh2YXIgZ3JvdXBzID0gdGhpcy5fZ3JvdXBzLCBtMiA9IGdyb3Vwcy5sZW5ndGgsIHN1Ymdyb3VwcyA9IFtdLCBwYXJlbnRzID0gW10sIGogPSAwOyBqIDwgbTI7ICsraikgewogICAgICBmb3IgKHZhciBncm91cCA9IGdyb3Vwc1tqXSwgbiA9IGdyb3VwLmxlbmd0aCwgbm9kZSwgaSA9IDA7IGkgPCBuOyArK2kpIHsKICAgICAgICBpZiAobm9kZSA9IGdyb3VwW2ldKSB7CiAgICAgICAgICBmb3IgKHZhciBjaGlsZHJlbjIgPSBzZWxlY3QuY2FsbChub2RlLCBub2RlLl9fZGF0YV9fLCBpLCBncm91cCksIGNoaWxkLCBpbmhlcml0MiA9IGdldDIobm9kZSwgaWQyKSwgayA9IDAsIGwgPSBjaGlsZHJlbjIubGVuZ3RoOyBrIDwgbDsgKytrKSB7CiAgICAgICAgICAgIGlmIChjaGlsZCA9IGNoaWxkcmVuMltrXSkgewogICAgICAgICAgICAgIHNjaGVkdWxlX2RlZmF1bHQoY2hpbGQsIG5hbWUsIGlkMiwgaywgY2hpbGRyZW4yLCBpbmhlcml0Mik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHN1Ymdyb3Vwcy5wdXNoKGNoaWxkcmVuMik7CiAgICAgICAgICBwYXJlbnRzLnB1c2gobm9kZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gbmV3IFRyYW5zaXRpb24oc3ViZ3JvdXBzLCBwYXJlbnRzLCBuYW1lLCBpZDIpOwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLXRyYW5zaXRpb24vc3JjL3RyYW5zaXRpb24vc2VsZWN0aW9uLmpzCiAgdmFyIFNlbGVjdGlvbjIgPSBzZWxlY3Rpb25fZGVmYXVsdC5wcm90b3R5cGUuY29uc3RydWN0b3I7CiAgZnVuY3Rpb24gc2VsZWN0aW9uX2RlZmF1bHQyKCkgewogICAgcmV0dXJuIG5ldyBTZWxlY3Rpb24yKHRoaXMuX2dyb3VwcywgdGhpcy5fcGFyZW50cyk7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtdHJhbnNpdGlvbi9zcmMvdHJhbnNpdGlvbi9zdHlsZS5qcwogIGZ1bmN0aW9uIHN0eWxlTnVsbChuYW1lLCBpbnRlcnBvbGF0ZSkgewogICAgdmFyIHN0cmluZzAwLCBzdHJpbmcxMCwgaW50ZXJwb2xhdGUwOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgc3RyaW5nMCA9IHN0eWxlVmFsdWUodGhpcywgbmFtZSksIHN0cmluZzEgPSAodGhpcy5zdHlsZS5yZW1vdmVQcm9wZXJ0eShuYW1lKSwgc3R5bGVWYWx1ZSh0aGlzLCBuYW1lKSk7CiAgICAgIHJldHVybiBzdHJpbmcwID09PSBzdHJpbmcxID8gbnVsbCA6IHN0cmluZzAgPT09IHN0cmluZzAwICYmIHN0cmluZzEgPT09IHN0cmluZzEwID8gaW50ZXJwb2xhdGUwIDogaW50ZXJwb2xhdGUwID0gaW50ZXJwb2xhdGUoc3RyaW5nMDAgPSBzdHJpbmcwLCBzdHJpbmcxMCA9IHN0cmluZzEpOwogICAgfTsKICB9CiAgZnVuY3Rpb24gc3R5bGVSZW1vdmUyKG5hbWUpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5zdHlsZS5yZW1vdmVQcm9wZXJ0eShuYW1lKTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIHN0eWxlQ29uc3RhbnQyKG5hbWUsIGludGVycG9sYXRlLCB2YWx1ZTEpIHsKICAgIHZhciBzdHJpbmcwMCwgc3RyaW5nMSA9IHZhbHVlMSArICIiLCBpbnRlcnBvbGF0ZTA7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzdHJpbmcwID0gc3R5bGVWYWx1ZSh0aGlzLCBuYW1lKTsKICAgICAgcmV0dXJuIHN0cmluZzAgPT09IHN0cmluZzEgPyBudWxsIDogc3RyaW5nMCA9PT0gc3RyaW5nMDAgPyBpbnRlcnBvbGF0ZTAgOiBpbnRlcnBvbGF0ZTAgPSBpbnRlcnBvbGF0ZShzdHJpbmcwMCA9IHN0cmluZzAsIHZhbHVlMSk7CiAgICB9OwogIH0KICBmdW5jdGlvbiBzdHlsZUZ1bmN0aW9uMihuYW1lLCBpbnRlcnBvbGF0ZSwgdmFsdWUpIHsKICAgIHZhciBzdHJpbmcwMCwgc3RyaW5nMTAsIGludGVycG9sYXRlMDsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHN0cmluZzAgPSBzdHlsZVZhbHVlKHRoaXMsIG5hbWUpLCB2YWx1ZTEgPSB2YWx1ZSh0aGlzKSwgc3RyaW5nMSA9IHZhbHVlMSArICIiOwogICAgICBpZiAodmFsdWUxID09IG51bGwpCiAgICAgICAgc3RyaW5nMSA9IHZhbHVlMSA9ICh0aGlzLnN0eWxlLnJlbW92ZVByb3BlcnR5KG5hbWUpLCBzdHlsZVZhbHVlKHRoaXMsIG5hbWUpKTsKICAgICAgcmV0dXJuIHN0cmluZzAgPT09IHN0cmluZzEgPyBudWxsIDogc3RyaW5nMCA9PT0gc3RyaW5nMDAgJiYgc3RyaW5nMSA9PT0gc3RyaW5nMTAgPyBpbnRlcnBvbGF0ZTAgOiAoc3RyaW5nMTAgPSBzdHJpbmcxLCBpbnRlcnBvbGF0ZTAgPSBpbnRlcnBvbGF0ZShzdHJpbmcwMCA9IHN0cmluZzAsIHZhbHVlMSkpOwogICAgfTsKICB9CiAgZnVuY3Rpb24gc3R5bGVNYXliZVJlbW92ZShpZDIsIG5hbWUpIHsKICAgIHZhciBvbjAsIG9uMSwgbGlzdGVuZXIwLCBrZXkgPSAic3R5bGUuIiArIG5hbWUsIGV2ZW50ID0gImVuZC4iICsga2V5LCByZW1vdmUyOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgc2NoZWR1bGUgPSBzZXQyKHRoaXMsIGlkMiksIG9uID0gc2NoZWR1bGUub24sIGxpc3RlbmVyID0gc2NoZWR1bGUudmFsdWVba2V5XSA9PSBudWxsID8gcmVtb3ZlMiB8fCAocmVtb3ZlMiA9IHN0eWxlUmVtb3ZlMihuYW1lKSkgOiB2b2lkIDA7CiAgICAgIGlmIChvbiAhPT0gb24wIHx8IGxpc3RlbmVyMCAhPT0gbGlzdGVuZXIpCiAgICAgICAgKG9uMSA9IChvbjAgPSBvbikuY29weSgpKS5vbihldmVudCwgbGlzdGVuZXIwID0gbGlzdGVuZXIpOwogICAgICBzY2hlZHVsZS5vbiA9IG9uMTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIHN0eWxlX2RlZmF1bHQyKG5hbWUsIHZhbHVlLCBwcmlvcml0eSkgewogICAgdmFyIGkgPSAobmFtZSArPSAiIikgPT09ICJ0cmFuc2Zvcm0iID8gaW50ZXJwb2xhdGVUcmFuc2Zvcm1Dc3MgOiBpbnRlcnBvbGF0ZV9kZWZhdWx0OwogICAgcmV0dXJuIHZhbHVlID09IG51bGwgPyB0aGlzLnN0eWxlVHdlZW4obmFtZSwgc3R5bGVOdWxsKG5hbWUsIGkpKS5vbigiZW5kLnN0eWxlLiIgKyBuYW1lLCBzdHlsZVJlbW92ZTIobmFtZSkpIDogdHlwZW9mIHZhbHVlID09PSAiZnVuY3Rpb24iID8gdGhpcy5zdHlsZVR3ZWVuKG5hbWUsIHN0eWxlRnVuY3Rpb24yKG5hbWUsIGksIHR3ZWVuVmFsdWUodGhpcywgInN0eWxlLiIgKyBuYW1lLCB2YWx1ZSkpKS5lYWNoKHN0eWxlTWF5YmVSZW1vdmUodGhpcy5faWQsIG5hbWUpKSA6IHRoaXMuc3R5bGVUd2VlbihuYW1lLCBzdHlsZUNvbnN0YW50MihuYW1lLCBpLCB2YWx1ZSksIHByaW9yaXR5KS5vbigiZW5kLnN0eWxlLiIgKyBuYW1lLCBudWxsKTsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9kMy10cmFuc2l0aW9uL3NyYy90cmFuc2l0aW9uL3N0eWxlVHdlZW4uanMKICBmdW5jdGlvbiBzdHlsZUludGVycG9sYXRlKG5hbWUsIGksIHByaW9yaXR5KSB7CiAgICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgICB0aGlzLnN0eWxlLnNldFByb3BlcnR5KG5hbWUsIGkuY2FsbCh0aGlzLCB0KSwgcHJpb3JpdHkpOwogICAgfTsKICB9CiAgZnVuY3Rpb24gc3R5bGVUd2VlbihuYW1lLCB2YWx1ZSwgcHJpb3JpdHkpIHsKICAgIHZhciB0LCBpMDsKICAgIGZ1bmN0aW9uIHR3ZWVuKCkgewogICAgICB2YXIgaSA9IHZhbHVlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIGlmIChpICE9PSBpMCkKICAgICAgICB0ID0gKGkwID0gaSkgJiYgc3R5bGVJbnRlcnBvbGF0ZShuYW1lLCBpLCBwcmlvcml0eSk7CiAgICAgIHJldHVybiB0OwogICAgfQogICAgdHdlZW4uX3ZhbHVlID0gdmFsdWU7CiAgICByZXR1cm4gdHdlZW47CiAgfQogIGZ1bmN0aW9uIHN0eWxlVHdlZW5fZGVmYXVsdChuYW1lLCB2YWx1ZSwgcHJpb3JpdHkpIHsKICAgIHZhciBrZXkgPSAic3R5bGUuIiArIChuYW1lICs9ICIiKTsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDwgMikKICAgICAgcmV0dXJuIChrZXkgPSB0aGlzLnR3ZWVuKGtleSkpICYmIGtleS5fdmFsdWU7CiAgICBpZiAodmFsdWUgPT0gbnVsbCkKICAgICAgcmV0dXJuIHRoaXMudHdlZW4oa2V5LCBudWxsKTsKICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICJmdW5jdGlvbiIpCiAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgcmV0dXJuIHRoaXMudHdlZW4oa2V5LCBzdHlsZVR3ZWVuKG5hbWUsIHZhbHVlLCBwcmlvcml0eSA9PSBudWxsID8gIiIgOiBwcmlvcml0eSkpOwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLXRyYW5zaXRpb24vc3JjL3RyYW5zaXRpb24vdGV4dC5qcwogIGZ1bmN0aW9uIHRleHRDb25zdGFudDIodmFsdWUpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy50ZXh0Q29udGVudCA9IHZhbHVlOwogICAgfTsKICB9CiAgZnVuY3Rpb24gdGV4dEZ1bmN0aW9uMih2YWx1ZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgdmFsdWUxID0gdmFsdWUodGhpcyk7CiAgICAgIHRoaXMudGV4dENvbnRlbnQgPSB2YWx1ZTEgPT0gbnVsbCA/ICIiIDogdmFsdWUxOwogICAgfTsKICB9CiAgZnVuY3Rpb24gdGV4dF9kZWZhdWx0Mih2YWx1ZSkgewogICAgcmV0dXJuIHRoaXMudHdlZW4oInRleHQiLCB0eXBlb2YgdmFsdWUgPT09ICJmdW5jdGlvbiIgPyB0ZXh0RnVuY3Rpb24yKHR3ZWVuVmFsdWUodGhpcywgInRleHQiLCB2YWx1ZSkpIDogdGV4dENvbnN0YW50Mih2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZSArICIiKSk7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtdHJhbnNpdGlvbi9zcmMvdHJhbnNpdGlvbi90ZXh0VHdlZW4uanMKICBmdW5jdGlvbiB0ZXh0SW50ZXJwb2xhdGUoaSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgICAgdGhpcy50ZXh0Q29udGVudCA9IGkuY2FsbCh0aGlzLCB0KTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIHRleHRUd2Vlbih2YWx1ZSkgewogICAgdmFyIHQwLCBpMDsKICAgIGZ1bmN0aW9uIHR3ZWVuKCkgewogICAgICB2YXIgaSA9IHZhbHVlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIGlmIChpICE9PSBpMCkKICAgICAgICB0MCA9IChpMCA9IGkpICYmIHRleHRJbnRlcnBvbGF0ZShpKTsKICAgICAgcmV0dXJuIHQwOwogICAgfQogICAgdHdlZW4uX3ZhbHVlID0gdmFsdWU7CiAgICByZXR1cm4gdHdlZW47CiAgfQogIGZ1bmN0aW9uIHRleHRUd2Vlbl9kZWZhdWx0KHZhbHVlKSB7CiAgICB2YXIga2V5ID0gInRleHQiOwogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPCAxKQogICAgICByZXR1cm4gKGtleSA9IHRoaXMudHdlZW4oa2V5KSkgJiYga2V5Ll92YWx1ZTsKICAgIGlmICh2YWx1ZSA9PSBudWxsKQogICAgICByZXR1cm4gdGhpcy50d2VlbihrZXksIG51bGwpOwogICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gImZ1bmN0aW9uIikKICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICByZXR1cm4gdGhpcy50d2VlbihrZXksIHRleHRUd2Vlbih2YWx1ZSkpOwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLXRyYW5zaXRpb24vc3JjL3RyYW5zaXRpb24vdHJhbnNpdGlvbi5qcwogIGZ1bmN0aW9uIHRyYW5zaXRpb25fZGVmYXVsdCgpIHsKICAgIHZhciBuYW1lID0gdGhpcy5fbmFtZSwgaWQwID0gdGhpcy5faWQsIGlkMSA9IG5ld0lkKCk7CiAgICBmb3IgKHZhciBncm91cHMgPSB0aGlzLl9ncm91cHMsIG0yID0gZ3JvdXBzLmxlbmd0aCwgaiA9IDA7IGogPCBtMjsgKytqKSB7CiAgICAgIGZvciAodmFyIGdyb3VwID0gZ3JvdXBzW2pdLCBuID0gZ3JvdXAubGVuZ3RoLCBub2RlLCBpID0gMDsgaSA8IG47ICsraSkgewogICAgICAgIGlmIChub2RlID0gZ3JvdXBbaV0pIHsKICAgICAgICAgIHZhciBpbmhlcml0MiA9IGdldDIobm9kZSwgaWQwKTsKICAgICAgICAgIHNjaGVkdWxlX2RlZmF1bHQobm9kZSwgbmFtZSwgaWQxLCBpLCBncm91cCwgewogICAgICAgICAgICB0aW1lOiBpbmhlcml0Mi50aW1lICsgaW5oZXJpdDIuZGVsYXkgKyBpbmhlcml0Mi5kdXJhdGlvbiwKICAgICAgICAgICAgZGVsYXk6IDAsCiAgICAgICAgICAgIGR1cmF0aW9uOiBpbmhlcml0Mi5kdXJhdGlvbiwKICAgICAgICAgICAgZWFzZTogaW5oZXJpdDIuZWFzZQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gbmV3IFRyYW5zaXRpb24oZ3JvdXBzLCB0aGlzLl9wYXJlbnRzLCBuYW1lLCBpZDEpOwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLXRyYW5zaXRpb24vc3JjL3RyYW5zaXRpb24vZW5kLmpzCiAgZnVuY3Rpb24gZW5kX2RlZmF1bHQoKSB7CiAgICB2YXIgb24wLCBvbjEsIHRoYXQgPSB0aGlzLCBpZDIgPSB0aGF0Ll9pZCwgc2l6ZSA9IHRoYXQuc2l6ZSgpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICB2YXIgY2FuY2VsID0geyB2YWx1ZTogcmVqZWN0IH0sIGVuZCA9IHsgdmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICgtLXNpemUgPT09IDApCiAgICAgICAgICByZXNvbHZlKCk7CiAgICAgIH0gfTsKICAgICAgdGhhdC5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBzY2hlZHVsZSA9IHNldDIodGhpcywgaWQyKSwgb24gPSBzY2hlZHVsZS5vbjsKICAgICAgICBpZiAob24gIT09IG9uMCkgewogICAgICAgICAgb24xID0gKG9uMCA9IG9uKS5jb3B5KCk7CiAgICAgICAgICBvbjEuXy5jYW5jZWwucHVzaChjYW5jZWwpOwogICAgICAgICAgb24xLl8uaW50ZXJydXB0LnB1c2goY2FuY2VsKTsKICAgICAgICAgIG9uMS5fLmVuZC5wdXNoKGVuZCk7CiAgICAgICAgfQogICAgICAgIHNjaGVkdWxlLm9uID0gb24xOwogICAgICB9KTsKICAgICAgaWYgKHNpemUgPT09IDApCiAgICAgICAgcmVzb2x2ZSgpOwogICAgfSk7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtdHJhbnNpdGlvbi9zcmMvdHJhbnNpdGlvbi9pbmRleC5qcwogIHZhciBpZCA9IDA7CiAgZnVuY3Rpb24gVHJhbnNpdGlvbihncm91cHMsIHBhcmVudHMsIG5hbWUsIGlkMikgewogICAgdGhpcy5fZ3JvdXBzID0gZ3JvdXBzOwogICAgdGhpcy5fcGFyZW50cyA9IHBhcmVudHM7CiAgICB0aGlzLl9uYW1lID0gbmFtZTsKICAgIHRoaXMuX2lkID0gaWQyOwogIH0KICBmdW5jdGlvbiB0cmFuc2l0aW9uKG5hbWUpIHsKICAgIHJldHVybiBzZWxlY3Rpb25fZGVmYXVsdCgpLnRyYW5zaXRpb24obmFtZSk7CiAgfQogIGZ1bmN0aW9uIG5ld0lkKCkgewogICAgcmV0dXJuICsraWQ7CiAgfQogIHZhciBzZWxlY3Rpb25fcHJvdG90eXBlID0gc2VsZWN0aW9uX2RlZmF1bHQucHJvdG90eXBlOwogIFRyYW5zaXRpb24ucHJvdG90eXBlID0gdHJhbnNpdGlvbi5wcm90b3R5cGUgPSB7CiAgICBjb25zdHJ1Y3RvcjogVHJhbnNpdGlvbiwKICAgIHNlbGVjdDogc2VsZWN0X2RlZmF1bHQzLAogICAgc2VsZWN0QWxsOiBzZWxlY3RBbGxfZGVmYXVsdDIsCiAgICBzZWxlY3RDaGlsZDogc2VsZWN0aW9uX3Byb3RvdHlwZS5zZWxlY3RDaGlsZCwKICAgIHNlbGVjdENoaWxkcmVuOiBzZWxlY3Rpb25fcHJvdG90eXBlLnNlbGVjdENoaWxkcmVuLAogICAgZmlsdGVyOiBmaWx0ZXJfZGVmYXVsdDIsCiAgICBtZXJnZTogbWVyZ2VfZGVmYXVsdDIsCiAgICBzZWxlY3Rpb246IHNlbGVjdGlvbl9kZWZhdWx0MiwKICAgIHRyYW5zaXRpb246IHRyYW5zaXRpb25fZGVmYXVsdCwKICAgIGNhbGw6IHNlbGVjdGlvbl9wcm90b3R5cGUuY2FsbCwKICAgIG5vZGVzOiBzZWxlY3Rpb25fcHJvdG90eXBlLm5vZGVzLAogICAgbm9kZTogc2VsZWN0aW9uX3Byb3RvdHlwZS5ub2RlLAogICAgc2l6ZTogc2VsZWN0aW9uX3Byb3RvdHlwZS5zaXplLAogICAgZW1wdHk6IHNlbGVjdGlvbl9wcm90b3R5cGUuZW1wdHksCiAgICBlYWNoOiBzZWxlY3Rpb25fcHJvdG90eXBlLmVhY2gsCiAgICBvbjogb25fZGVmYXVsdDIsCiAgICBhdHRyOiBhdHRyX2RlZmF1bHQyLAogICAgYXR0clR3ZWVuOiBhdHRyVHdlZW5fZGVmYXVsdCwKICAgIHN0eWxlOiBzdHlsZV9kZWZhdWx0MiwKICAgIHN0eWxlVHdlZW46IHN0eWxlVHdlZW5fZGVmYXVsdCwKICAgIHRleHQ6IHRleHRfZGVmYXVsdDIsCiAgICB0ZXh0VHdlZW46IHRleHRUd2Vlbl9kZWZhdWx0LAogICAgcmVtb3ZlOiByZW1vdmVfZGVmYXVsdDIsCiAgICB0d2VlbjogdHdlZW5fZGVmYXVsdCwKICAgIGRlbGF5OiBkZWxheV9kZWZhdWx0LAogICAgZHVyYXRpb246IGR1cmF0aW9uX2RlZmF1bHQsCiAgICBlYXNlOiBlYXNlX2RlZmF1bHQsCiAgICBlYXNlVmFyeWluZzogZWFzZVZhcnlpbmdfZGVmYXVsdCwKICAgIGVuZDogZW5kX2RlZmF1bHQsCiAgICBbU3ltYm9sLml0ZXJhdG9yXTogc2VsZWN0aW9uX3Byb3RvdHlwZVtTeW1ib2wuaXRlcmF0b3JdCiAgfTsKCiAgLy8gbm9kZV9tb2R1bGVzL2QzLWVhc2Uvc3JjL2N1YmljLmpzCiAgZnVuY3Rpb24gY3ViaWNJbk91dCh0KSB7CiAgICByZXR1cm4gKCh0ICo9IDIpIDw9IDEgPyB0ICogdCAqIHQgOiAodCAtPSAyKSAqIHQgKiB0ICsgMikgLyAyOwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLXRyYW5zaXRpb24vc3JjL3NlbGVjdGlvbi90cmFuc2l0aW9uLmpzCiAgdmFyIGRlZmF1bHRUaW1pbmcgPSB7CiAgICB0aW1lOiBudWxsLAogICAgLy8gU2V0IG9uIHVzZS4KICAgIGRlbGF5OiAwLAogICAgZHVyYXRpb246IDI1MCwKICAgIGVhc2U6IGN1YmljSW5PdXQKICB9OwogIGZ1bmN0aW9uIGluaGVyaXQobm9kZSwgaWQyKSB7CiAgICB2YXIgdGltaW5nOwogICAgd2hpbGUgKCEodGltaW5nID0gbm9kZS5fX3RyYW5zaXRpb24pIHx8ICEodGltaW5nID0gdGltaW5nW2lkMl0pKSB7CiAgICAgIGlmICghKG5vZGUgPSBub2RlLnBhcmVudE5vZGUpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB0cmFuc2l0aW9uICR7aWQyfSBub3QgZm91bmRgKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRpbWluZzsKICB9CiAgZnVuY3Rpb24gdHJhbnNpdGlvbl9kZWZhdWx0MihuYW1lKSB7CiAgICB2YXIgaWQyLCB0aW1pbmc7CiAgICBpZiAobmFtZSBpbnN0YW5jZW9mIFRyYW5zaXRpb24pIHsKICAgICAgaWQyID0gbmFtZS5faWQsIG5hbWUgPSBuYW1lLl9uYW1lOwogICAgfSBlbHNlIHsKICAgICAgaWQyID0gbmV3SWQoKSwgKHRpbWluZyA9IGRlZmF1bHRUaW1pbmcpLnRpbWUgPSBub3coKSwgbmFtZSA9IG5hbWUgPT0gbnVsbCA/IG51bGwgOiBuYW1lICsgIiI7CiAgICB9CiAgICBmb3IgKHZhciBncm91cHMgPSB0aGlzLl9ncm91cHMsIG0yID0gZ3JvdXBzLmxlbmd0aCwgaiA9IDA7IGogPCBtMjsgKytqKSB7CiAgICAgIGZvciAodmFyIGdyb3VwID0gZ3JvdXBzW2pdLCBuID0gZ3JvdXAubGVuZ3RoLCBub2RlLCBpID0gMDsgaSA8IG47ICsraSkgewogICAgICAgIGlmIChub2RlID0gZ3JvdXBbaV0pIHsKICAgICAgICAgIHNjaGVkdWxlX2RlZmF1bHQobm9kZSwgbmFtZSwgaWQyLCBpLCBncm91cCwgdGltaW5nIHx8IGluaGVyaXQobm9kZSwgaWQyKSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gbmV3IFRyYW5zaXRpb24oZ3JvdXBzLCB0aGlzLl9wYXJlbnRzLCBuYW1lLCBpZDIpOwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLXRyYW5zaXRpb24vc3JjL3NlbGVjdGlvbi9pbmRleC5qcwogIHNlbGVjdGlvbl9kZWZhdWx0LnByb3RvdHlwZS5pbnRlcnJ1cHQgPSBpbnRlcnJ1cHRfZGVmYXVsdDI7CiAgc2VsZWN0aW9uX2RlZmF1bHQucHJvdG90eXBlLnRyYW5zaXRpb24gPSB0cmFuc2l0aW9uX2RlZmF1bHQyOwoKICAvLyBub2RlX21vZHVsZXMvZDMtYnJ1c2gvc3JjL2JydXNoLmpzCiAgdmFyIHsgYWJzLCBtYXgsIG1pbiB9ID0gTWF0aDsKICBmdW5jdGlvbiBudW1iZXIxKGUpIHsKICAgIHJldHVybiBbK2VbMF0sICtlWzFdXTsKICB9CiAgZnVuY3Rpb24gbnVtYmVyMihlKSB7CiAgICByZXR1cm4gW251bWJlcjEoZVswXSksIG51bWJlcjEoZVsxXSldOwogIH0KICB2YXIgWCA9IHsKICAgIG5hbWU6ICJ4IiwKICAgIGhhbmRsZXM6IFsidyIsICJlIl0ubWFwKHR5cGUpLAogICAgaW5wdXQ6IGZ1bmN0aW9uKHgyLCBlKSB7CiAgICAgIHJldHVybiB4MiA9PSBudWxsID8gbnVsbCA6IFtbK3gyWzBdLCBlWzBdWzFdXSwgWyt4MlsxXSwgZVsxXVsxXV1dOwogICAgfSwKICAgIG91dHB1dDogZnVuY3Rpb24oeHkpIHsKICAgICAgcmV0dXJuIHh5ICYmIFt4eVswXVswXSwgeHlbMV1bMF1dOwogICAgfQogIH07CiAgdmFyIFkgPSB7CiAgICBuYW1lOiAieSIsCiAgICBoYW5kbGVzOiBbIm4iLCAicyJdLm1hcCh0eXBlKSwKICAgIGlucHV0OiBmdW5jdGlvbih5MiwgZSkgewogICAgICByZXR1cm4geTIgPT0gbnVsbCA/IG51bGwgOiBbW2VbMF1bMF0sICt5MlswXV0sIFtlWzFdWzBdLCAreTJbMV1dXTsKICAgIH0sCiAgICBvdXRwdXQ6IGZ1bmN0aW9uKHh5KSB7CiAgICAgIHJldHVybiB4eSAmJiBbeHlbMF1bMV0sIHh5WzFdWzFdXTsKICAgIH0KICB9OwogIHZhciBYWSA9IHsKICAgIG5hbWU6ICJ4eSIsCiAgICBoYW5kbGVzOiBbIm4iLCAidyIsICJlIiwgInMiLCAibnciLCAibmUiLCAic3ciLCAic2UiXS5tYXAodHlwZSksCiAgICBpbnB1dDogZnVuY3Rpb24oeHkpIHsKICAgICAgcmV0dXJuIHh5ID09IG51bGwgPyBudWxsIDogbnVtYmVyMih4eSk7CiAgICB9LAogICAgb3V0cHV0OiBmdW5jdGlvbih4eSkgewogICAgICByZXR1cm4geHk7CiAgICB9CiAgfTsKICBmdW5jdGlvbiB0eXBlKHQpIHsKICAgIHJldHVybiB7IHR5cGU6IHQgfTsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9kMy1xdWFkdHJlZS9zcmMvYWRkLmpzCiAgZnVuY3Rpb24gYWRkX2RlZmF1bHQoZCkgewogICAgY29uc3QgeDIgPSArdGhpcy5feC5jYWxsKG51bGwsIGQpLCB5MiA9ICt0aGlzLl95LmNhbGwobnVsbCwgZCk7CiAgICByZXR1cm4gYWRkKHRoaXMuY292ZXIoeDIsIHkyKSwgeDIsIHkyLCBkKTsKICB9CiAgZnVuY3Rpb24gYWRkKHRyZWUsIHgyLCB5MiwgZCkgewogICAgaWYgKGlzTmFOKHgyKSB8fCBpc05hTih5MikpCiAgICAgIHJldHVybiB0cmVlOwogICAgdmFyIHBhcmVudCwgbm9kZSA9IHRyZWUuX3Jvb3QsIGxlYWYgPSB7IGRhdGE6IGQgfSwgeDAgPSB0cmVlLl94MCwgeTAgPSB0cmVlLl95MCwgeDEgPSB0cmVlLl94MSwgeTEgPSB0cmVlLl95MSwgeG0sIHltLCB4cCwgeXAsIHJpZ2h0LCBib3R0b20sIGksIGo7CiAgICBpZiAoIW5vZGUpCiAgICAgIHJldHVybiB0cmVlLl9yb290ID0gbGVhZiwgdHJlZTsKICAgIHdoaWxlIChub2RlLmxlbmd0aCkgewogICAgICBpZiAocmlnaHQgPSB4MiA+PSAoeG0gPSAoeDAgKyB4MSkgLyAyKSkKICAgICAgICB4MCA9IHhtOwogICAgICBlbHNlCiAgICAgICAgeDEgPSB4bTsKICAgICAgaWYgKGJvdHRvbSA9IHkyID49ICh5bSA9ICh5MCArIHkxKSAvIDIpKQogICAgICAgIHkwID0geW07CiAgICAgIGVsc2UKICAgICAgICB5MSA9IHltOwogICAgICBpZiAocGFyZW50ID0gbm9kZSwgIShub2RlID0gbm9kZVtpID0gYm90dG9tIDw8IDEgfCByaWdodF0pKQogICAgICAgIHJldHVybiBwYXJlbnRbaV0gPSBsZWFmLCB0cmVlOwogICAgfQogICAgeHAgPSArdHJlZS5feC5jYWxsKG51bGwsIG5vZGUuZGF0YSk7CiAgICB5cCA9ICt0cmVlLl95LmNhbGwobnVsbCwgbm9kZS5kYXRhKTsKICAgIGlmICh4MiA9PT0geHAgJiYgeTIgPT09IHlwKQogICAgICByZXR1cm4gbGVhZi5uZXh0ID0gbm9kZSwgcGFyZW50ID8gcGFyZW50W2ldID0gbGVhZiA6IHRyZWUuX3Jvb3QgPSBsZWFmLCB0cmVlOwogICAgZG8gewogICAgICBwYXJlbnQgPSBwYXJlbnQgPyBwYXJlbnRbaV0gPSBuZXcgQXJyYXkoNCkgOiB0cmVlLl9yb290ID0gbmV3IEFycmF5KDQpOwogICAgICBpZiAocmlnaHQgPSB4MiA+PSAoeG0gPSAoeDAgKyB4MSkgLyAyKSkKICAgICAgICB4MCA9IHhtOwogICAgICBlbHNlCiAgICAgICAgeDEgPSB4bTsKICAgICAgaWYgKGJvdHRvbSA9IHkyID49ICh5bSA9ICh5MCArIHkxKSAvIDIpKQogICAgICAgIHkwID0geW07CiAgICAgIGVsc2UKICAgICAgICB5MSA9IHltOwogICAgfSB3aGlsZSAoKGkgPSBib3R0b20gPDwgMSB8IHJpZ2h0KSA9PT0gKGogPSAoeXAgPj0geW0pIDw8IDEgfCB4cCA+PSB4bSkpOwogICAgcmV0dXJuIHBhcmVudFtqXSA9IG5vZGUsIHBhcmVudFtpXSA9IGxlYWYsIHRyZWU7CiAgfQogIGZ1bmN0aW9uIGFkZEFsbChkYXRhKSB7CiAgICB2YXIgZCwgaSwgbiA9IGRhdGEubGVuZ3RoLCB4MiwgeTIsIHh6ID0gbmV3IEFycmF5KG4pLCB5eiA9IG5ldyBBcnJheShuKSwgeDAgPSBJbmZpbml0eSwgeTAgPSBJbmZpbml0eSwgeDEgPSAtSW5maW5pdHksIHkxID0gLUluZmluaXR5OwogICAgZm9yIChpID0gMDsgaSA8IG47ICsraSkgewogICAgICBpZiAoaXNOYU4oeDIgPSArdGhpcy5feC5jYWxsKG51bGwsIGQgPSBkYXRhW2ldKSkgfHwgaXNOYU4oeTIgPSArdGhpcy5feS5jYWxsKG51bGwsIGQpKSkKICAgICAgICBjb250aW51ZTsKICAgICAgeHpbaV0gPSB4MjsKICAgICAgeXpbaV0gPSB5MjsKICAgICAgaWYgKHgyIDwgeDApCiAgICAgICAgeDAgPSB4MjsKICAgICAgaWYgKHgyID4geDEpCiAgICAgICAgeDEgPSB4MjsKICAgICAgaWYgKHkyIDwgeTApCiAgICAgICAgeTAgPSB5MjsKICAgICAgaWYgKHkyID4geTEpCiAgICAgICAgeTEgPSB5MjsKICAgIH0KICAgIGlmICh4MCA+IHgxIHx8IHkwID4geTEpCiAgICAgIHJldHVybiB0aGlzOwogICAgdGhpcy5jb3Zlcih4MCwgeTApLmNvdmVyKHgxLCB5MSk7CiAgICBmb3IgKGkgPSAwOyBpIDwgbjsgKytpKSB7CiAgICAgIGFkZCh0aGlzLCB4eltpXSwgeXpbaV0sIGRhdGFbaV0pOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtcXVhZHRyZWUvc3JjL2NvdmVyLmpzCiAgZnVuY3Rpb24gY292ZXJfZGVmYXVsdCh4MiwgeTIpIHsKICAgIGlmIChpc05hTih4MiA9ICt4MikgfHwgaXNOYU4oeTIgPSAreTIpKQogICAgICByZXR1cm4gdGhpczsKICAgIHZhciB4MCA9IHRoaXMuX3gwLCB5MCA9IHRoaXMuX3kwLCB4MSA9IHRoaXMuX3gxLCB5MSA9IHRoaXMuX3kxOwogICAgaWYgKGlzTmFOKHgwKSkgewogICAgICB4MSA9ICh4MCA9IE1hdGguZmxvb3IoeDIpKSArIDE7CiAgICAgIHkxID0gKHkwID0gTWF0aC5mbG9vcih5MikpICsgMTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciB6ID0geDEgLSB4MCB8fCAxLCBub2RlID0gdGhpcy5fcm9vdCwgcGFyZW50LCBpOwogICAgICB3aGlsZSAoeDAgPiB4MiB8fCB4MiA+PSB4MSB8fCB5MCA+IHkyIHx8IHkyID49IHkxKSB7CiAgICAgICAgaSA9ICh5MiA8IHkwKSA8PCAxIHwgeDIgPCB4MDsKICAgICAgICBwYXJlbnQgPSBuZXcgQXJyYXkoNCksIHBhcmVudFtpXSA9IG5vZGUsIG5vZGUgPSBwYXJlbnQsIHogKj0gMjsKICAgICAgICBzd2l0Y2ggKGkpIHsKICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgeDEgPSB4MCArIHosIHkxID0geTAgKyB6OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgeDAgPSB4MSAtIHosIHkxID0geTAgKyB6OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgeDEgPSB4MCArIHosIHkwID0geTEgLSB6OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgeDAgPSB4MSAtIHosIHkwID0geTEgLSB6OwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHRoaXMuX3Jvb3QgJiYgdGhpcy5fcm9vdC5sZW5ndGgpCiAgICAgICAgdGhpcy5fcm9vdCA9IG5vZGU7CiAgICB9CiAgICB0aGlzLl94MCA9IHgwOwogICAgdGhpcy5feTAgPSB5MDsKICAgIHRoaXMuX3gxID0geDE7CiAgICB0aGlzLl95MSA9IHkxOwogICAgcmV0dXJuIHRoaXM7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtcXVhZHRyZWUvc3JjL2RhdGEuanMKICBmdW5jdGlvbiBkYXRhX2RlZmF1bHQyKCkgewogICAgdmFyIGRhdGEgPSBbXTsKICAgIHRoaXMudmlzaXQoZnVuY3Rpb24obm9kZSkgewogICAgICBpZiAoIW5vZGUubGVuZ3RoKQogICAgICAgIGRvCiAgICAgICAgICBkYXRhLnB1c2gobm9kZS5kYXRhKTsKICAgICAgICB3aGlsZSAobm9kZSA9IG5vZGUubmV4dCk7CiAgICB9KTsKICAgIHJldHVybiBkYXRhOwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLXF1YWR0cmVlL3NyYy9leHRlbnQuanMKICBmdW5jdGlvbiBleHRlbnRfZGVmYXVsdChfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IHRoaXMuY292ZXIoK19bMF1bMF0sICtfWzBdWzFdKS5jb3ZlcigrX1sxXVswXSwgK19bMV1bMV0pIDogaXNOYU4odGhpcy5feDApID8gdm9pZCAwIDogW1t0aGlzLl94MCwgdGhpcy5feTBdLCBbdGhpcy5feDEsIHRoaXMuX3kxXV07CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtcXVhZHRyZWUvc3JjL3F1YWQuanMKICBmdW5jdGlvbiBxdWFkX2RlZmF1bHQobm9kZSwgeDAsIHkwLCB4MSwgeTEpIHsKICAgIHRoaXMubm9kZSA9IG5vZGU7CiAgICB0aGlzLngwID0geDA7CiAgICB0aGlzLnkwID0geTA7CiAgICB0aGlzLngxID0geDE7CiAgICB0aGlzLnkxID0geTE7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtcXVhZHRyZWUvc3JjL2ZpbmQuanMKICBmdW5jdGlvbiBmaW5kX2RlZmF1bHQoeDIsIHkyLCByYWRpdXMpIHsKICAgIHZhciBkYXRhLCB4MCA9IHRoaXMuX3gwLCB5MCA9IHRoaXMuX3kwLCB4MSwgeTEsIHgyMiwgeTIyLCB4MyA9IHRoaXMuX3gxLCB5MyA9IHRoaXMuX3kxLCBxdWFkcyA9IFtdLCBub2RlID0gdGhpcy5fcm9vdCwgcSwgaTsKICAgIGlmIChub2RlKQogICAgICBxdWFkcy5wdXNoKG5ldyBxdWFkX2RlZmF1bHQobm9kZSwgeDAsIHkwLCB4MywgeTMpKTsKICAgIGlmIChyYWRpdXMgPT0gbnVsbCkKICAgICAgcmFkaXVzID0gSW5maW5pdHk7CiAgICBlbHNlIHsKICAgICAgeDAgPSB4MiAtIHJhZGl1cywgeTAgPSB5MiAtIHJhZGl1czsKICAgICAgeDMgPSB4MiArIHJhZGl1cywgeTMgPSB5MiArIHJhZGl1czsKICAgICAgcmFkaXVzICo9IHJhZGl1czsKICAgIH0KICAgIHdoaWxlIChxID0gcXVhZHMucG9wKCkpIHsKICAgICAgaWYgKCEobm9kZSA9IHEubm9kZSkgfHwgKHgxID0gcS54MCkgPiB4MyB8fCAoeTEgPSBxLnkwKSA+IHkzIHx8ICh4MjIgPSBxLngxKSA8IHgwIHx8ICh5MjIgPSBxLnkxKSA8IHkwKQogICAgICAgIGNvbnRpbnVlOwogICAgICBpZiAobm9kZS5sZW5ndGgpIHsKICAgICAgICB2YXIgeG0gPSAoeDEgKyB4MjIpIC8gMiwgeW0gPSAoeTEgKyB5MjIpIC8gMjsKICAgICAgICBxdWFkcy5wdXNoKAogICAgICAgICAgbmV3IHF1YWRfZGVmYXVsdChub2RlWzNdLCB4bSwgeW0sIHgyMiwgeTIyKSwKICAgICAgICAgIG5ldyBxdWFkX2RlZmF1bHQobm9kZVsyXSwgeDEsIHltLCB4bSwgeTIyKSwKICAgICAgICAgIG5ldyBxdWFkX2RlZmF1bHQobm9kZVsxXSwgeG0sIHkxLCB4MjIsIHltKSwKICAgICAgICAgIG5ldyBxdWFkX2RlZmF1bHQobm9kZVswXSwgeDEsIHkxLCB4bSwgeW0pCiAgICAgICAgKTsKICAgICAgICBpZiAoaSA9ICh5MiA+PSB5bSkgPDwgMSB8IHgyID49IHhtKSB7CiAgICAgICAgICBxID0gcXVhZHNbcXVhZHMubGVuZ3RoIC0gMV07CiAgICAgICAgICBxdWFkc1txdWFkcy5sZW5ndGggLSAxXSA9IHF1YWRzW3F1YWRzLmxlbmd0aCAtIDEgLSBpXTsKICAgICAgICAgIHF1YWRzW3F1YWRzLmxlbmd0aCAtIDEgLSBpXSA9IHE7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHZhciBkeCA9IHgyIC0gK3RoaXMuX3guY2FsbChudWxsLCBub2RlLmRhdGEpLCBkeSA9IHkyIC0gK3RoaXMuX3kuY2FsbChudWxsLCBub2RlLmRhdGEpLCBkMiA9IGR4ICogZHggKyBkeSAqIGR5OwogICAgICAgIGlmIChkMiA8IHJhZGl1cykgewogICAgICAgICAgdmFyIGQgPSBNYXRoLnNxcnQocmFkaXVzID0gZDIpOwogICAgICAgICAgeDAgPSB4MiAtIGQsIHkwID0geTIgLSBkOwogICAgICAgICAgeDMgPSB4MiArIGQsIHkzID0geTIgKyBkOwogICAgICAgICAgZGF0YSA9IG5vZGUuZGF0YTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBkYXRhOwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLXF1YWR0cmVlL3NyYy9yZW1vdmUuanMKICBmdW5jdGlvbiByZW1vdmVfZGVmYXVsdDMoZCkgewogICAgaWYgKGlzTmFOKHgyID0gK3RoaXMuX3guY2FsbChudWxsLCBkKSkgfHwgaXNOYU4oeTIgPSArdGhpcy5feS5jYWxsKG51bGwsIGQpKSkKICAgICAgcmV0dXJuIHRoaXM7CiAgICB2YXIgcGFyZW50LCBub2RlID0gdGhpcy5fcm9vdCwgcmV0YWluZXIsIHByZXZpb3VzLCBuZXh0LCB4MCA9IHRoaXMuX3gwLCB5MCA9IHRoaXMuX3kwLCB4MSA9IHRoaXMuX3gxLCB5MSA9IHRoaXMuX3kxLCB4MiwgeTIsIHhtLCB5bSwgcmlnaHQsIGJvdHRvbSwgaSwgajsKICAgIGlmICghbm9kZSkKICAgICAgcmV0dXJuIHRoaXM7CiAgICBpZiAobm9kZS5sZW5ndGgpCiAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgaWYgKHJpZ2h0ID0geDIgPj0gKHhtID0gKHgwICsgeDEpIC8gMikpCiAgICAgICAgICB4MCA9IHhtOwogICAgICAgIGVsc2UKICAgICAgICAgIHgxID0geG07CiAgICAgICAgaWYgKGJvdHRvbSA9IHkyID49ICh5bSA9ICh5MCArIHkxKSAvIDIpKQogICAgICAgICAgeTAgPSB5bTsKICAgICAgICBlbHNlCiAgICAgICAgICB5MSA9IHltOwogICAgICAgIGlmICghKHBhcmVudCA9IG5vZGUsIG5vZGUgPSBub2RlW2kgPSBib3R0b20gPDwgMSB8IHJpZ2h0XSkpCiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICBpZiAoIW5vZGUubGVuZ3RoKQogICAgICAgICAgYnJlYWs7CiAgICAgICAgaWYgKHBhcmVudFtpICsgMSAmIDNdIHx8IHBhcmVudFtpICsgMiAmIDNdIHx8IHBhcmVudFtpICsgMyAmIDNdKQogICAgICAgICAgcmV0YWluZXIgPSBwYXJlbnQsIGogPSBpOwogICAgICB9CiAgICB3aGlsZSAobm9kZS5kYXRhICE9PSBkKQogICAgICBpZiAoIShwcmV2aW91cyA9IG5vZGUsIG5vZGUgPSBub2RlLm5leHQpKQogICAgICAgIHJldHVybiB0aGlzOwogICAgaWYgKG5leHQgPSBub2RlLm5leHQpCiAgICAgIGRlbGV0ZSBub2RlLm5leHQ7CiAgICBpZiAocHJldmlvdXMpCiAgICAgIHJldHVybiBuZXh0ID8gcHJldmlvdXMubmV4dCA9IG5leHQgOiBkZWxldGUgcHJldmlvdXMubmV4dCwgdGhpczsKICAgIGlmICghcGFyZW50KQogICAgICByZXR1cm4gdGhpcy5fcm9vdCA9IG5leHQsIHRoaXM7CiAgICBuZXh0ID8gcGFyZW50W2ldID0gbmV4dCA6IGRlbGV0ZSBwYXJlbnRbaV07CiAgICBpZiAoKG5vZGUgPSBwYXJlbnRbMF0gfHwgcGFyZW50WzFdIHx8IHBhcmVudFsyXSB8fCBwYXJlbnRbM10pICYmIG5vZGUgPT09IChwYXJlbnRbM10gfHwgcGFyZW50WzJdIHx8IHBhcmVudFsxXSB8fCBwYXJlbnRbMF0pICYmICFub2RlLmxlbmd0aCkgewogICAgICBpZiAocmV0YWluZXIpCiAgICAgICAgcmV0YWluZXJbal0gPSBub2RlOwogICAgICBlbHNlCiAgICAgICAgdGhpcy5fcm9vdCA9IG5vZGU7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgZnVuY3Rpb24gcmVtb3ZlQWxsKGRhdGEpIHsKICAgIGZvciAodmFyIGkgPSAwLCBuID0gZGF0YS5sZW5ndGg7IGkgPCBuOyArK2kpCiAgICAgIHRoaXMucmVtb3ZlKGRhdGFbaV0pOwogICAgcmV0dXJuIHRoaXM7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtcXVhZHRyZWUvc3JjL3Jvb3QuanMKICBmdW5jdGlvbiByb290X2RlZmF1bHQoKSB7CiAgICByZXR1cm4gdGhpcy5fcm9vdDsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9kMy1xdWFkdHJlZS9zcmMvc2l6ZS5qcwogIGZ1bmN0aW9uIHNpemVfZGVmYXVsdDIoKSB7CiAgICB2YXIgc2l6ZSA9IDA7CiAgICB0aGlzLnZpc2l0KGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgaWYgKCFub2RlLmxlbmd0aCkKICAgICAgICBkbwogICAgICAgICAgKytzaXplOwogICAgICAgIHdoaWxlIChub2RlID0gbm9kZS5uZXh0KTsKICAgIH0pOwogICAgcmV0dXJuIHNpemU7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtcXVhZHRyZWUvc3JjL3Zpc2l0LmpzCiAgZnVuY3Rpb24gdmlzaXRfZGVmYXVsdChjYWxsYmFjaykgewogICAgdmFyIHF1YWRzID0gW10sIHEsIG5vZGUgPSB0aGlzLl9yb290LCBjaGlsZCwgeDAsIHkwLCB4MSwgeTE7CiAgICBpZiAobm9kZSkKICAgICAgcXVhZHMucHVzaChuZXcgcXVhZF9kZWZhdWx0KG5vZGUsIHRoaXMuX3gwLCB0aGlzLl95MCwgdGhpcy5feDEsIHRoaXMuX3kxKSk7CiAgICB3aGlsZSAocSA9IHF1YWRzLnBvcCgpKSB7CiAgICAgIGlmICghY2FsbGJhY2sobm9kZSA9IHEubm9kZSwgeDAgPSBxLngwLCB5MCA9IHEueTAsIHgxID0gcS54MSwgeTEgPSBxLnkxKSAmJiBub2RlLmxlbmd0aCkgewogICAgICAgIHZhciB4bSA9ICh4MCArIHgxKSAvIDIsIHltID0gKHkwICsgeTEpIC8gMjsKICAgICAgICBpZiAoY2hpbGQgPSBub2RlWzNdKQogICAgICAgICAgcXVhZHMucHVzaChuZXcgcXVhZF9kZWZhdWx0KGNoaWxkLCB4bSwgeW0sIHgxLCB5MSkpOwogICAgICAgIGlmIChjaGlsZCA9IG5vZGVbMl0pCiAgICAgICAgICBxdWFkcy5wdXNoKG5ldyBxdWFkX2RlZmF1bHQoY2hpbGQsIHgwLCB5bSwgeG0sIHkxKSk7CiAgICAgICAgaWYgKGNoaWxkID0gbm9kZVsxXSkKICAgICAgICAgIHF1YWRzLnB1c2gobmV3IHF1YWRfZGVmYXVsdChjaGlsZCwgeG0sIHkwLCB4MSwgeW0pKTsKICAgICAgICBpZiAoY2hpbGQgPSBub2RlWzBdKQogICAgICAgICAgcXVhZHMucHVzaChuZXcgcXVhZF9kZWZhdWx0KGNoaWxkLCB4MCwgeTAsIHhtLCB5bSkpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9kMy1xdWFkdHJlZS9zcmMvdmlzaXRBZnRlci5qcwogIGZ1bmN0aW9uIHZpc2l0QWZ0ZXJfZGVmYXVsdChjYWxsYmFjaykgewogICAgdmFyIHF1YWRzID0gW10sIG5leHQgPSBbXSwgcTsKICAgIGlmICh0aGlzLl9yb290KQogICAgICBxdWFkcy5wdXNoKG5ldyBxdWFkX2RlZmF1bHQodGhpcy5fcm9vdCwgdGhpcy5feDAsIHRoaXMuX3kwLCB0aGlzLl94MSwgdGhpcy5feTEpKTsKICAgIHdoaWxlIChxID0gcXVhZHMucG9wKCkpIHsKICAgICAgdmFyIG5vZGUgPSBxLm5vZGU7CiAgICAgIGlmIChub2RlLmxlbmd0aCkgewogICAgICAgIHZhciBjaGlsZCwgeDAgPSBxLngwLCB5MCA9IHEueTAsIHgxID0gcS54MSwgeTEgPSBxLnkxLCB4bSA9ICh4MCArIHgxKSAvIDIsIHltID0gKHkwICsgeTEpIC8gMjsKICAgICAgICBpZiAoY2hpbGQgPSBub2RlWzBdKQogICAgICAgICAgcXVhZHMucHVzaChuZXcgcXVhZF9kZWZhdWx0KGNoaWxkLCB4MCwgeTAsIHhtLCB5bSkpOwogICAgICAgIGlmIChjaGlsZCA9IG5vZGVbMV0pCiAgICAgICAgICBxdWFkcy5wdXNoKG5ldyBxdWFkX2RlZmF1bHQoY2hpbGQsIHhtLCB5MCwgeDEsIHltKSk7CiAgICAgICAgaWYgKGNoaWxkID0gbm9kZVsyXSkKICAgICAgICAgIHF1YWRzLnB1c2gobmV3IHF1YWRfZGVmYXVsdChjaGlsZCwgeDAsIHltLCB4bSwgeTEpKTsKICAgICAgICBpZiAoY2hpbGQgPSBub2RlWzNdKQogICAgICAgICAgcXVhZHMucHVzaChuZXcgcXVhZF9kZWZhdWx0KGNoaWxkLCB4bSwgeW0sIHgxLCB5MSkpOwogICAgICB9CiAgICAgIG5leHQucHVzaChxKTsKICAgIH0KICAgIHdoaWxlIChxID0gbmV4dC5wb3AoKSkgewogICAgICBjYWxsYmFjayhxLm5vZGUsIHEueDAsIHEueTAsIHEueDEsIHEueTEpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtcXVhZHRyZWUvc3JjL3guanMKICBmdW5jdGlvbiBkZWZhdWx0WChkKSB7CiAgICByZXR1cm4gZFswXTsKICB9CiAgZnVuY3Rpb24geF9kZWZhdWx0KF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHRoaXMuX3ggPSBfLCB0aGlzKSA6IHRoaXMuX3g7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtcXVhZHRyZWUvc3JjL3kuanMKICBmdW5jdGlvbiBkZWZhdWx0WShkKSB7CiAgICByZXR1cm4gZFsxXTsKICB9CiAgZnVuY3Rpb24geV9kZWZhdWx0KF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHRoaXMuX3kgPSBfLCB0aGlzKSA6IHRoaXMuX3k7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtcXVhZHRyZWUvc3JjL3F1YWR0cmVlLmpzCiAgZnVuY3Rpb24gcXVhZHRyZWUobm9kZXMsIHgyLCB5MikgewogICAgdmFyIHRyZWUgPSBuZXcgUXVhZHRyZWUoeDIgPT0gbnVsbCA/IGRlZmF1bHRYIDogeDIsIHkyID09IG51bGwgPyBkZWZhdWx0WSA6IHkyLCBOYU4sIE5hTiwgTmFOLCBOYU4pOwogICAgcmV0dXJuIG5vZGVzID09IG51bGwgPyB0cmVlIDogdHJlZS5hZGRBbGwobm9kZXMpOwogIH0KICBmdW5jdGlvbiBRdWFkdHJlZSh4MiwgeTIsIHgwLCB5MCwgeDEsIHkxKSB7CiAgICB0aGlzLl94ID0geDI7CiAgICB0aGlzLl95ID0geTI7CiAgICB0aGlzLl94MCA9IHgwOwogICAgdGhpcy5feTAgPSB5MDsKICAgIHRoaXMuX3gxID0geDE7CiAgICB0aGlzLl95MSA9IHkxOwogICAgdGhpcy5fcm9vdCA9IHZvaWQgMDsKICB9CiAgZnVuY3Rpb24gbGVhZl9jb3B5KGxlYWYpIHsKICAgIHZhciBjb3B5ID0geyBkYXRhOiBsZWFmLmRhdGEgfSwgbmV4dCA9IGNvcHk7CiAgICB3aGlsZSAobGVhZiA9IGxlYWYubmV4dCkKICAgICAgbmV4dCA9IG5leHQubmV4dCA9IHsgZGF0YTogbGVhZi5kYXRhIH07CiAgICByZXR1cm4gY29weTsKICB9CiAgdmFyIHRyZWVQcm90byA9IHF1YWR0cmVlLnByb3RvdHlwZSA9IFF1YWR0cmVlLnByb3RvdHlwZTsKICB0cmVlUHJvdG8uY29weSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGNvcHkgPSBuZXcgUXVhZHRyZWUodGhpcy5feCwgdGhpcy5feSwgdGhpcy5feDAsIHRoaXMuX3kwLCB0aGlzLl94MSwgdGhpcy5feTEpLCBub2RlID0gdGhpcy5fcm9vdCwgbm9kZXMsIGNoaWxkOwogICAgaWYgKCFub2RlKQogICAgICByZXR1cm4gY29weTsKICAgIGlmICghbm9kZS5sZW5ndGgpCiAgICAgIHJldHVybiBjb3B5Ll9yb290ID0gbGVhZl9jb3B5KG5vZGUpLCBjb3B5OwogICAgbm9kZXMgPSBbeyBzb3VyY2U6IG5vZGUsIHRhcmdldDogY29weS5fcm9vdCA9IG5ldyBBcnJheSg0KSB9XTsKICAgIHdoaWxlIChub2RlID0gbm9kZXMucG9wKCkpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCA0OyArK2kpIHsKICAgICAgICBpZiAoY2hpbGQgPSBub2RlLnNvdXJjZVtpXSkgewogICAgICAgICAgaWYgKGNoaWxkLmxlbmd0aCkKICAgICAgICAgICAgbm9kZXMucHVzaCh7IHNvdXJjZTogY2hpbGQsIHRhcmdldDogbm9kZS50YXJnZXRbaV0gPSBuZXcgQXJyYXkoNCkgfSk7CiAgICAgICAgICBlbHNlCiAgICAgICAgICAgIG5vZGUudGFyZ2V0W2ldID0gbGVhZl9jb3B5KGNoaWxkKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBjb3B5OwogIH07CiAgdHJlZVByb3RvLmFkZCA9IGFkZF9kZWZhdWx0OwogIHRyZWVQcm90by5hZGRBbGwgPSBhZGRBbGw7CiAgdHJlZVByb3RvLmNvdmVyID0gY292ZXJfZGVmYXVsdDsKICB0cmVlUHJvdG8uZGF0YSA9IGRhdGFfZGVmYXVsdDI7CiAgdHJlZVByb3RvLmV4dGVudCA9IGV4dGVudF9kZWZhdWx0OwogIHRyZWVQcm90by5maW5kID0gZmluZF9kZWZhdWx0OwogIHRyZWVQcm90by5yZW1vdmUgPSByZW1vdmVfZGVmYXVsdDM7CiAgdHJlZVByb3RvLnJlbW92ZUFsbCA9IHJlbW92ZUFsbDsKICB0cmVlUHJvdG8ucm9vdCA9IHJvb3RfZGVmYXVsdDsKICB0cmVlUHJvdG8uc2l6ZSA9IHNpemVfZGVmYXVsdDI7CiAgdHJlZVByb3RvLnZpc2l0ID0gdmlzaXRfZGVmYXVsdDsKICB0cmVlUHJvdG8udmlzaXRBZnRlciA9IHZpc2l0QWZ0ZXJfZGVmYXVsdDsKICB0cmVlUHJvdG8ueCA9IHhfZGVmYXVsdDsKICB0cmVlUHJvdG8ueSA9IHlfZGVmYXVsdDsKCiAgLy8gbm9kZV9tb2R1bGVzL2QzLWZvcmNlL3NyYy9jb25zdGFudC5qcwogIGZ1bmN0aW9uIGNvbnN0YW50X2RlZmF1bHQ1KHgyKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB4MjsKICAgIH07CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtZm9yY2Uvc3JjL2ppZ2dsZS5qcwogIGZ1bmN0aW9uIGppZ2dsZV9kZWZhdWx0KHJhbmRvbSkgewogICAgcmV0dXJuIChyYW5kb20oKSAtIDAuNSkgKiAxZS02OwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLWZvcmNlL3NyYy9saW5rLmpzCiAgZnVuY3Rpb24gaW5kZXgoZCkgewogICAgcmV0dXJuIGQuaW5kZXg7CiAgfQogIGZ1bmN0aW9uIGZpbmQyKG5vZGVCeUlkLCBub2RlSWQpIHsKICAgIHZhciBub2RlID0gbm9kZUJ5SWQuZ2V0KG5vZGVJZCk7CiAgICBpZiAoIW5vZGUpCiAgICAgIHRocm93IG5ldyBFcnJvcigibm9kZSBub3QgZm91bmQ6ICIgKyBub2RlSWQpOwogICAgcmV0dXJuIG5vZGU7CiAgfQogIGZ1bmN0aW9uIGxpbmtfZGVmYXVsdChsaW5rcykgewogICAgdmFyIGlkMiA9IGluZGV4LCBzdHJlbmd0aCA9IGRlZmF1bHRTdHJlbmd0aCwgc3RyZW5ndGhzLCBkaXN0YW5jZSA9IGNvbnN0YW50X2RlZmF1bHQ1KDMwKSwgZGlzdGFuY2VzLCBub2RlcywgY291bnQsIGJpYXMsIHJhbmRvbSwgaXRlcmF0aW9ucyA9IDE7CiAgICBpZiAobGlua3MgPT0gbnVsbCkKICAgICAgbGlua3MgPSBbXTsKICAgIGZ1bmN0aW9uIGRlZmF1bHRTdHJlbmd0aChsaW5rKSB7CiAgICAgIHJldHVybiAxIC8gTWF0aC5taW4oY291bnRbbGluay5zb3VyY2UuaW5kZXhdLCBjb3VudFtsaW5rLnRhcmdldC5pbmRleF0pOwogICAgfQogICAgZnVuY3Rpb24gZm9yY2UoYWxwaGEpIHsKICAgICAgZm9yICh2YXIgayA9IDAsIG4gPSBsaW5rcy5sZW5ndGg7IGsgPCBpdGVyYXRpb25zOyArK2spIHsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbGluaywgc291cmNlLCB0YXJnZXQsIHgyLCB5MiwgbCwgYjsgaSA8IG47ICsraSkgewogICAgICAgICAgbGluayA9IGxpbmtzW2ldLCBzb3VyY2UgPSBsaW5rLnNvdXJjZSwgdGFyZ2V0ID0gbGluay50YXJnZXQ7CiAgICAgICAgICB4MiA9IHRhcmdldC54ICsgdGFyZ2V0LnZ4IC0gc291cmNlLnggLSBzb3VyY2UudnggfHwgamlnZ2xlX2RlZmF1bHQocmFuZG9tKTsKICAgICAgICAgIHkyID0gdGFyZ2V0LnkgKyB0YXJnZXQudnkgLSBzb3VyY2UueSAtIHNvdXJjZS52eSB8fCBqaWdnbGVfZGVmYXVsdChyYW5kb20pOwogICAgICAgICAgbCA9IE1hdGguc3FydCh4MiAqIHgyICsgeTIgKiB5Mik7CiAgICAgICAgICBsID0gKGwgLSBkaXN0YW5jZXNbaV0pIC8gbCAqIGFscGhhICogc3RyZW5ndGhzW2ldOwogICAgICAgICAgeDIgKj0gbCwgeTIgKj0gbDsKICAgICAgICAgIHRhcmdldC52eCAtPSB4MiAqIChiID0gYmlhc1tpXSk7CiAgICAgICAgICB0YXJnZXQudnkgLT0geTIgKiBiOwogICAgICAgICAgc291cmNlLnZ4ICs9IHgyICogKGIgPSAxIC0gYik7CiAgICAgICAgICBzb3VyY2UudnkgKz0geTIgKiBiOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gaW5pdGlhbGl6ZSgpIHsKICAgICAgaWYgKCFub2RlcykKICAgICAgICByZXR1cm47CiAgICAgIHZhciBpLCBuID0gbm9kZXMubGVuZ3RoLCBtMiA9IGxpbmtzLmxlbmd0aCwgbm9kZUJ5SWQgPSBuZXcgTWFwKG5vZGVzLm1hcCgoZCwgaTIpID0+IFtpZDIoZCwgaTIsIG5vZGVzKSwgZF0pKSwgbGluazsKICAgICAgZm9yIChpID0gMCwgY291bnQgPSBuZXcgQXJyYXkobik7IGkgPCBtMjsgKytpKSB7CiAgICAgICAgbGluayA9IGxpbmtzW2ldLCBsaW5rLmluZGV4ID0gaTsKICAgICAgICBpZiAodHlwZW9mIGxpbmsuc291cmNlICE9PSAib2JqZWN0IikKICAgICAgICAgIGxpbmsuc291cmNlID0gZmluZDIobm9kZUJ5SWQsIGxpbmsuc291cmNlKTsKICAgICAgICBpZiAodHlwZW9mIGxpbmsudGFyZ2V0ICE9PSAib2JqZWN0IikKICAgICAgICAgIGxpbmsudGFyZ2V0ID0gZmluZDIobm9kZUJ5SWQsIGxpbmsudGFyZ2V0KTsKICAgICAgICBjb3VudFtsaW5rLnNvdXJjZS5pbmRleF0gPSAoY291bnRbbGluay5zb3VyY2UuaW5kZXhdIHx8IDApICsgMTsKICAgICAgICBjb3VudFtsaW5rLnRhcmdldC5pbmRleF0gPSAoY291bnRbbGluay50YXJnZXQuaW5kZXhdIHx8IDApICsgMTsKICAgICAgfQogICAgICBmb3IgKGkgPSAwLCBiaWFzID0gbmV3IEFycmF5KG0yKTsgaSA8IG0yOyArK2kpIHsKICAgICAgICBsaW5rID0gbGlua3NbaV0sIGJpYXNbaV0gPSBjb3VudFtsaW5rLnNvdXJjZS5pbmRleF0gLyAoY291bnRbbGluay5zb3VyY2UuaW5kZXhdICsgY291bnRbbGluay50YXJnZXQuaW5kZXhdKTsKICAgICAgfQogICAgICBzdHJlbmd0aHMgPSBuZXcgQXJyYXkobTIpLCBpbml0aWFsaXplU3RyZW5ndGgoKTsKICAgICAgZGlzdGFuY2VzID0gbmV3IEFycmF5KG0yKSwgaW5pdGlhbGl6ZURpc3RhbmNlKCk7CiAgICB9CiAgICBmdW5jdGlvbiBpbml0aWFsaXplU3RyZW5ndGgoKSB7CiAgICAgIGlmICghbm9kZXMpCiAgICAgICAgcmV0dXJuOwogICAgICBmb3IgKHZhciBpID0gMCwgbiA9IGxpbmtzLmxlbmd0aDsgaSA8IG47ICsraSkgewogICAgICAgIHN0cmVuZ3Roc1tpXSA9ICtzdHJlbmd0aChsaW5rc1tpXSwgaSwgbGlua3MpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBpbml0aWFsaXplRGlzdGFuY2UoKSB7CiAgICAgIGlmICghbm9kZXMpCiAgICAgICAgcmV0dXJuOwogICAgICBmb3IgKHZhciBpID0gMCwgbiA9IGxpbmtzLmxlbmd0aDsgaSA8IG47ICsraSkgewogICAgICAgIGRpc3RhbmNlc1tpXSA9ICtkaXN0YW5jZShsaW5rc1tpXSwgaSwgbGlua3MpOwogICAgICB9CiAgICB9CiAgICBmb3JjZS5pbml0aWFsaXplID0gZnVuY3Rpb24oX25vZGVzLCBfcmFuZG9tKSB7CiAgICAgIG5vZGVzID0gX25vZGVzOwogICAgICByYW5kb20gPSBfcmFuZG9tOwogICAgICBpbml0aWFsaXplKCk7CiAgICB9OwogICAgZm9yY2UubGlua3MgPSBmdW5jdGlvbihfKSB7CiAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGxpbmtzID0gXywgaW5pdGlhbGl6ZSgpLCBmb3JjZSkgOiBsaW5rczsKICAgIH07CiAgICBmb3JjZS5pZCA9IGZ1bmN0aW9uKF8pIHsKICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoaWQyID0gXywgZm9yY2UpIDogaWQyOwogICAgfTsKICAgIGZvcmNlLml0ZXJhdGlvbnMgPSBmdW5jdGlvbihfKSB7CiAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGl0ZXJhdGlvbnMgPSArXywgZm9yY2UpIDogaXRlcmF0aW9uczsKICAgIH07CiAgICBmb3JjZS5zdHJlbmd0aCA9IGZ1bmN0aW9uKF8pIHsKICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoc3RyZW5ndGggPSB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0NSgrXyksIGluaXRpYWxpemVTdHJlbmd0aCgpLCBmb3JjZSkgOiBzdHJlbmd0aDsKICAgIH07CiAgICBmb3JjZS5kaXN0YW5jZSA9IGZ1bmN0aW9uKF8pIHsKICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoZGlzdGFuY2UgPSB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0NSgrXyksIGluaXRpYWxpemVEaXN0YW5jZSgpLCBmb3JjZSkgOiBkaXN0YW5jZTsKICAgIH07CiAgICByZXR1cm4gZm9yY2U7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtZm9yY2Uvc3JjL2xjZy5qcwogIHZhciBhID0gMTY2NDUyNTsKICB2YXIgYyA9IDEwMTM5MDQyMjM7CiAgdmFyIG0gPSA0Mjk0OTY3Mjk2OwogIGZ1bmN0aW9uIGxjZ19kZWZhdWx0KCkgewogICAgbGV0IHMgPSAxOwogICAgcmV0dXJuICgpID0+IChzID0gKGEgKiBzICsgYykgJSBtKSAvIG07CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtZm9yY2Uvc3JjL3NpbXVsYXRpb24uanMKICBmdW5jdGlvbiB4KGQpIHsKICAgIHJldHVybiBkLng7CiAgfQogIGZ1bmN0aW9uIHkoZCkgewogICAgcmV0dXJuIGQueTsKICB9CiAgdmFyIGluaXRpYWxSYWRpdXMgPSAxMDsKICB2YXIgaW5pdGlhbEFuZ2xlID0gTWF0aC5QSSAqICgzIC0gTWF0aC5zcXJ0KDUpKTsKICBmdW5jdGlvbiBzaW11bGF0aW9uX2RlZmF1bHQobm9kZXMpIHsKICAgIHZhciBzaW11bGF0aW9uLCBhbHBoYSA9IDEsIGFscGhhTWluID0gMWUtMywgYWxwaGFEZWNheSA9IDEgLSBNYXRoLnBvdyhhbHBoYU1pbiwgMSAvIDMwMCksIGFscGhhVGFyZ2V0ID0gMCwgdmVsb2NpdHlEZWNheSA9IDAuNiwgZm9yY2VzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKSwgc3RlcHBlciA9IHRpbWVyKHN0ZXApLCBldmVudCA9IGRpc3BhdGNoX2RlZmF1bHQoInRpY2siLCAiZW5kIiksIHJhbmRvbSA9IGxjZ19kZWZhdWx0KCk7CiAgICBpZiAobm9kZXMgPT0gbnVsbCkKICAgICAgbm9kZXMgPSBbXTsKICAgIGZ1bmN0aW9uIHN0ZXAoKSB7CiAgICAgIHRpY2soKTsKICAgICAgZXZlbnQuY2FsbCgidGljayIsIHNpbXVsYXRpb24pOwogICAgICBpZiAoYWxwaGEgPCBhbHBoYU1pbikgewogICAgICAgIHN0ZXBwZXIuc3RvcCgpOwogICAgICAgIGV2ZW50LmNhbGwoImVuZCIsIHNpbXVsYXRpb24pOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiB0aWNrKGl0ZXJhdGlvbnMpIHsKICAgICAgdmFyIGksIG4gPSBub2Rlcy5sZW5ndGgsIG5vZGU7CiAgICAgIGlmIChpdGVyYXRpb25zID09PSB2b2lkIDApCiAgICAgICAgaXRlcmF0aW9ucyA9IDE7CiAgICAgIGZvciAodmFyIGsgPSAwOyBrIDwgaXRlcmF0aW9uczsgKytrKSB7CiAgICAgICAgYWxwaGEgKz0gKGFscGhhVGFyZ2V0IC0gYWxwaGEpICogYWxwaGFEZWNheTsKICAgICAgICBmb3JjZXMuZm9yRWFjaChmdW5jdGlvbihmb3JjZSkgewogICAgICAgICAgZm9yY2UoYWxwaGEpOwogICAgICAgIH0pOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBuOyArK2kpIHsKICAgICAgICAgIG5vZGUgPSBub2Rlc1tpXTsKICAgICAgICAgIGlmIChub2RlLmZ4ID09IG51bGwpCiAgICAgICAgICAgIG5vZGUueCArPSBub2RlLnZ4ICo9IHZlbG9jaXR5RGVjYXk7CiAgICAgICAgICBlbHNlCiAgICAgICAgICAgIG5vZGUueCA9IG5vZGUuZngsIG5vZGUudnggPSAwOwogICAgICAgICAgaWYgKG5vZGUuZnkgPT0gbnVsbCkKICAgICAgICAgICAgbm9kZS55ICs9IG5vZGUudnkgKj0gdmVsb2NpdHlEZWNheTsKICAgICAgICAgIGVsc2UKICAgICAgICAgICAgbm9kZS55ID0gbm9kZS5meSwgbm9kZS52eSA9IDA7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBzaW11bGF0aW9uOwogICAgfQogICAgZnVuY3Rpb24gaW5pdGlhbGl6ZU5vZGVzKCkgewogICAgICBmb3IgKHZhciBpID0gMCwgbiA9IG5vZGVzLmxlbmd0aCwgbm9kZTsgaSA8IG47ICsraSkgewogICAgICAgIG5vZGUgPSBub2Rlc1tpXSwgbm9kZS5pbmRleCA9IGk7CiAgICAgICAgaWYgKG5vZGUuZnggIT0gbnVsbCkKICAgICAgICAgIG5vZGUueCA9IG5vZGUuZng7CiAgICAgICAgaWYgKG5vZGUuZnkgIT0gbnVsbCkKICAgICAgICAgIG5vZGUueSA9IG5vZGUuZnk7CiAgICAgICAgaWYgKGlzTmFOKG5vZGUueCkgfHwgaXNOYU4obm9kZS55KSkgewogICAgICAgICAgdmFyIHJhZGl1cyA9IGluaXRpYWxSYWRpdXMgKiBNYXRoLnNxcnQoMC41ICsgaSksIGFuZ2xlID0gaSAqIGluaXRpYWxBbmdsZTsKICAgICAgICAgIG5vZGUueCA9IHJhZGl1cyAqIE1hdGguY29zKGFuZ2xlKTsKICAgICAgICAgIG5vZGUueSA9IHJhZGl1cyAqIE1hdGguc2luKGFuZ2xlKTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzTmFOKG5vZGUudngpIHx8IGlzTmFOKG5vZGUudnkpKSB7CiAgICAgICAgICBub2RlLnZ4ID0gbm9kZS52eSA9IDA7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBpbml0aWFsaXplRm9yY2UoZm9yY2UpIHsKICAgICAgaWYgKGZvcmNlLmluaXRpYWxpemUpCiAgICAgICAgZm9yY2UuaW5pdGlhbGl6ZShub2RlcywgcmFuZG9tKTsKICAgICAgcmV0dXJuIGZvcmNlOwogICAgfQogICAgaW5pdGlhbGl6ZU5vZGVzKCk7CiAgICByZXR1cm4gc2ltdWxhdGlvbiA9IHsKICAgICAgdGljaywKICAgICAgcmVzdGFydDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHN0ZXBwZXIucmVzdGFydChzdGVwKSwgc2ltdWxhdGlvbjsKICAgICAgfSwKICAgICAgc3RvcDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHN0ZXBwZXIuc3RvcCgpLCBzaW11bGF0aW9uOwogICAgICB9LAogICAgICBub2RlczogZnVuY3Rpb24oXykgewogICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKG5vZGVzID0gXywgaW5pdGlhbGl6ZU5vZGVzKCksIGZvcmNlcy5mb3JFYWNoKGluaXRpYWxpemVGb3JjZSksIHNpbXVsYXRpb24pIDogbm9kZXM7CiAgICAgIH0sCiAgICAgIGFscGhhOiBmdW5jdGlvbihfKSB7CiAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoYWxwaGEgPSArXywgc2ltdWxhdGlvbikgOiBhbHBoYTsKICAgICAgfSwKICAgICAgYWxwaGFNaW46IGZ1bmN0aW9uKF8pIHsKICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChhbHBoYU1pbiA9ICtfLCBzaW11bGF0aW9uKSA6IGFscGhhTWluOwogICAgICB9LAogICAgICBhbHBoYURlY2F5OiBmdW5jdGlvbihfKSB7CiAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoYWxwaGFEZWNheSA9ICtfLCBzaW11bGF0aW9uKSA6ICthbHBoYURlY2F5OwogICAgICB9LAogICAgICBhbHBoYVRhcmdldDogZnVuY3Rpb24oXykgewogICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGFscGhhVGFyZ2V0ID0gK18sIHNpbXVsYXRpb24pIDogYWxwaGFUYXJnZXQ7CiAgICAgIH0sCiAgICAgIHZlbG9jaXR5RGVjYXk6IGZ1bmN0aW9uKF8pIHsKICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh2ZWxvY2l0eURlY2F5ID0gMSAtIF8sIHNpbXVsYXRpb24pIDogMSAtIHZlbG9jaXR5RGVjYXk7CiAgICAgIH0sCiAgICAgIHJhbmRvbVNvdXJjZTogZnVuY3Rpb24oXykgewogICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHJhbmRvbSA9IF8sIGZvcmNlcy5mb3JFYWNoKGluaXRpYWxpemVGb3JjZSksIHNpbXVsYXRpb24pIDogcmFuZG9tOwogICAgICB9LAogICAgICBmb3JjZTogZnVuY3Rpb24obmFtZSwgXykgewogICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID4gMSA/IChfID09IG51bGwgPyBmb3JjZXMuZGVsZXRlKG5hbWUpIDogZm9yY2VzLnNldChuYW1lLCBpbml0aWFsaXplRm9yY2UoXykpLCBzaW11bGF0aW9uKSA6IGZvcmNlcy5nZXQobmFtZSk7CiAgICAgIH0sCiAgICAgIGZpbmQ6IGZ1bmN0aW9uKHgyLCB5MiwgcmFkaXVzKSB7CiAgICAgICAgdmFyIGkgPSAwLCBuID0gbm9kZXMubGVuZ3RoLCBkeCwgZHksIGQyLCBub2RlLCBjbG9zZXN0OwogICAgICAgIGlmIChyYWRpdXMgPT0gbnVsbCkKICAgICAgICAgIHJhZGl1cyA9IEluZmluaXR5OwogICAgICAgIGVsc2UKICAgICAgICAgIHJhZGl1cyAqPSByYWRpdXM7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IG47ICsraSkgewogICAgICAgICAgbm9kZSA9IG5vZGVzW2ldOwogICAgICAgICAgZHggPSB4MiAtIG5vZGUueDsKICAgICAgICAgIGR5ID0geTIgLSBub2RlLnk7CiAgICAgICAgICBkMiA9IGR4ICogZHggKyBkeSAqIGR5OwogICAgICAgICAgaWYgKGQyIDwgcmFkaXVzKQogICAgICAgICAgICBjbG9zZXN0ID0gbm9kZSwgcmFkaXVzID0gZDI7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjbG9zZXN0OwogICAgICB9LAogICAgICBvbjogZnVuY3Rpb24obmFtZSwgXykgewogICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID4gMSA/IChldmVudC5vbihuYW1lLCBfKSwgc2ltdWxhdGlvbikgOiBldmVudC5vbihuYW1lKTsKICAgICAgfQogICAgfTsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9kMy1mb3JjZS9zcmMvbWFueUJvZHkuanMKICBmdW5jdGlvbiBtYW55Qm9keV9kZWZhdWx0KCkgewogICAgdmFyIG5vZGVzLCBub2RlLCByYW5kb20sIGFscGhhLCBzdHJlbmd0aCA9IGNvbnN0YW50X2RlZmF1bHQ1KC0zMCksIHN0cmVuZ3RocywgZGlzdGFuY2VNaW4yID0gMSwgZGlzdGFuY2VNYXgyID0gSW5maW5pdHksIHRoZXRhMiA9IDAuODE7CiAgICBmdW5jdGlvbiBmb3JjZShfKSB7CiAgICAgIHZhciBpLCBuID0gbm9kZXMubGVuZ3RoLCB0cmVlID0gcXVhZHRyZWUobm9kZXMsIHgsIHkpLnZpc2l0QWZ0ZXIoYWNjdW11bGF0ZSk7CiAgICAgIGZvciAoYWxwaGEgPSBfLCBpID0gMDsgaSA8IG47ICsraSkKICAgICAgICBub2RlID0gbm9kZXNbaV0sIHRyZWUudmlzaXQoYXBwbHkpOwogICAgfQogICAgZnVuY3Rpb24gaW5pdGlhbGl6ZSgpIHsKICAgICAgaWYgKCFub2RlcykKICAgICAgICByZXR1cm47CiAgICAgIHZhciBpLCBuID0gbm9kZXMubGVuZ3RoLCBub2RlMjsKICAgICAgc3RyZW5ndGhzID0gbmV3IEFycmF5KG4pOwogICAgICBmb3IgKGkgPSAwOyBpIDwgbjsgKytpKQogICAgICAgIG5vZGUyID0gbm9kZXNbaV0sIHN0cmVuZ3Roc1tub2RlMi5pbmRleF0gPSArc3RyZW5ndGgobm9kZTIsIGksIG5vZGVzKTsKICAgIH0KICAgIGZ1bmN0aW9uIGFjY3VtdWxhdGUocXVhZCkgewogICAgICB2YXIgc3RyZW5ndGgyID0gMCwgcSwgYzIsIHdlaWdodCA9IDAsIHgyLCB5MiwgaTsKICAgICAgaWYgKHF1YWQubGVuZ3RoKSB7CiAgICAgICAgZm9yICh4MiA9IHkyID0gaSA9IDA7IGkgPCA0OyArK2kpIHsKICAgICAgICAgIGlmICgocSA9IHF1YWRbaV0pICYmIChjMiA9IE1hdGguYWJzKHEudmFsdWUpKSkgewogICAgICAgICAgICBzdHJlbmd0aDIgKz0gcS52YWx1ZSwgd2VpZ2h0ICs9IGMyLCB4MiArPSBjMiAqIHEueCwgeTIgKz0gYzIgKiBxLnk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHF1YWQueCA9IHgyIC8gd2VpZ2h0OwogICAgICAgIHF1YWQueSA9IHkyIC8gd2VpZ2h0OwogICAgICB9IGVsc2UgewogICAgICAgIHEgPSBxdWFkOwogICAgICAgIHEueCA9IHEuZGF0YS54OwogICAgICAgIHEueSA9IHEuZGF0YS55OwogICAgICAgIGRvCiAgICAgICAgICBzdHJlbmd0aDIgKz0gc3RyZW5ndGhzW3EuZGF0YS5pbmRleF07CiAgICAgICAgd2hpbGUgKHEgPSBxLm5leHQpOwogICAgICB9CiAgICAgIHF1YWQudmFsdWUgPSBzdHJlbmd0aDI7CiAgICB9CiAgICBmdW5jdGlvbiBhcHBseShxdWFkLCB4MSwgXywgeDIpIHsKICAgICAgaWYgKCFxdWFkLnZhbHVlKQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB2YXIgeDMgPSBxdWFkLnggLSBub2RlLngsIHkyID0gcXVhZC55IC0gbm9kZS55LCB3ID0geDIgLSB4MSwgbCA9IHgzICogeDMgKyB5MiAqIHkyOwogICAgICBpZiAodyAqIHcgLyB0aGV0YTIgPCBsKSB7CiAgICAgICAgaWYgKGwgPCBkaXN0YW5jZU1heDIpIHsKICAgICAgICAgIGlmICh4MyA9PT0gMCkKICAgICAgICAgICAgeDMgPSBqaWdnbGVfZGVmYXVsdChyYW5kb20pLCBsICs9IHgzICogeDM7CiAgICAgICAgICBpZiAoeTIgPT09IDApCiAgICAgICAgICAgIHkyID0gamlnZ2xlX2RlZmF1bHQocmFuZG9tKSwgbCArPSB5MiAqIHkyOwogICAgICAgICAgaWYgKGwgPCBkaXN0YW5jZU1pbjIpCiAgICAgICAgICAgIGwgPSBNYXRoLnNxcnQoZGlzdGFuY2VNaW4yICogbCk7CiAgICAgICAgICBub2RlLnZ4ICs9IHgzICogcXVhZC52YWx1ZSAqIGFscGhhIC8gbDsKICAgICAgICAgIG5vZGUudnkgKz0geTIgKiBxdWFkLnZhbHVlICogYWxwaGEgLyBsOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIGlmIChxdWFkLmxlbmd0aCB8fCBsID49IGRpc3RhbmNlTWF4MikKICAgICAgICByZXR1cm47CiAgICAgIGlmIChxdWFkLmRhdGEgIT09IG5vZGUgfHwgcXVhZC5uZXh0KSB7CiAgICAgICAgaWYgKHgzID09PSAwKQogICAgICAgICAgeDMgPSBqaWdnbGVfZGVmYXVsdChyYW5kb20pLCBsICs9IHgzICogeDM7CiAgICAgICAgaWYgKHkyID09PSAwKQogICAgICAgICAgeTIgPSBqaWdnbGVfZGVmYXVsdChyYW5kb20pLCBsICs9IHkyICogeTI7CiAgICAgICAgaWYgKGwgPCBkaXN0YW5jZU1pbjIpCiAgICAgICAgICBsID0gTWF0aC5zcXJ0KGRpc3RhbmNlTWluMiAqIGwpOwogICAgICB9CiAgICAgIGRvCiAgICAgICAgaWYgKHF1YWQuZGF0YSAhPT0gbm9kZSkgewogICAgICAgICAgdyA9IHN0cmVuZ3Roc1txdWFkLmRhdGEuaW5kZXhdICogYWxwaGEgLyBsOwogICAgICAgICAgbm9kZS52eCArPSB4MyAqIHc7CiAgICAgICAgICBub2RlLnZ5ICs9IHkyICogdzsKICAgICAgICB9CiAgICAgIHdoaWxlIChxdWFkID0gcXVhZC5uZXh0KTsKICAgIH0KICAgIGZvcmNlLmluaXRpYWxpemUgPSBmdW5jdGlvbihfbm9kZXMsIF9yYW5kb20pIHsKICAgICAgbm9kZXMgPSBfbm9kZXM7CiAgICAgIHJhbmRvbSA9IF9yYW5kb207CiAgICAgIGluaXRpYWxpemUoKTsKICAgIH07CiAgICBmb3JjZS5zdHJlbmd0aCA9IGZ1bmN0aW9uKF8pIHsKICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoc3RyZW5ndGggPSB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0NSgrXyksIGluaXRpYWxpemUoKSwgZm9yY2UpIDogc3RyZW5ndGg7CiAgICB9OwogICAgZm9yY2UuZGlzdGFuY2VNaW4gPSBmdW5jdGlvbihfKSB7CiAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGRpc3RhbmNlTWluMiA9IF8gKiBfLCBmb3JjZSkgOiBNYXRoLnNxcnQoZGlzdGFuY2VNaW4yKTsKICAgIH07CiAgICBmb3JjZS5kaXN0YW5jZU1heCA9IGZ1bmN0aW9uKF8pIHsKICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoZGlzdGFuY2VNYXgyID0gXyAqIF8sIGZvcmNlKSA6IE1hdGguc3FydChkaXN0YW5jZU1heDIpOwogICAgfTsKICAgIGZvcmNlLnRoZXRhID0gZnVuY3Rpb24oXykgewogICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh0aGV0YTIgPSBfICogXywgZm9yY2UpIDogTWF0aC5zcXJ0KHRoZXRhMik7CiAgICB9OwogICAgcmV0dXJuIGZvcmNlOwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2QzLWZvcmNlL3NyYy94LmpzCiAgZnVuY3Rpb24geF9kZWZhdWx0Mih4MikgewogICAgdmFyIHN0cmVuZ3RoID0gY29uc3RhbnRfZGVmYXVsdDUoMC4xKSwgbm9kZXMsIHN0cmVuZ3RocywgeHo7CiAgICBpZiAodHlwZW9mIHgyICE9PSAiZnVuY3Rpb24iKQogICAgICB4MiA9IGNvbnN0YW50X2RlZmF1bHQ1KHgyID09IG51bGwgPyAwIDogK3gyKTsKICAgIGZ1bmN0aW9uIGZvcmNlKGFscGhhKSB7CiAgICAgIGZvciAodmFyIGkgPSAwLCBuID0gbm9kZXMubGVuZ3RoLCBub2RlOyBpIDwgbjsgKytpKSB7CiAgICAgICAgbm9kZSA9IG5vZGVzW2ldLCBub2RlLnZ4ICs9ICh4eltpXSAtIG5vZGUueCkgKiBzdHJlbmd0aHNbaV0gKiBhbHBoYTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gaW5pdGlhbGl6ZSgpIHsKICAgICAgaWYgKCFub2RlcykKICAgICAgICByZXR1cm47CiAgICAgIHZhciBpLCBuID0gbm9kZXMubGVuZ3RoOwogICAgICBzdHJlbmd0aHMgPSBuZXcgQXJyYXkobik7CiAgICAgIHh6ID0gbmV3IEFycmF5KG4pOwogICAgICBmb3IgKGkgPSAwOyBpIDwgbjsgKytpKSB7CiAgICAgICAgc3RyZW5ndGhzW2ldID0gaXNOYU4oeHpbaV0gPSAreDIobm9kZXNbaV0sIGksIG5vZGVzKSkgPyAwIDogK3N0cmVuZ3RoKG5vZGVzW2ldLCBpLCBub2Rlcyk7CiAgICAgIH0KICAgIH0KICAgIGZvcmNlLmluaXRpYWxpemUgPSBmdW5jdGlvbihfKSB7CiAgICAgIG5vZGVzID0gXzsKICAgICAgaW5pdGlhbGl6ZSgpOwogICAgfTsKICAgIGZvcmNlLnN0cmVuZ3RoID0gZnVuY3Rpb24oXykgewogICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChzdHJlbmd0aCA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQ1KCtfKSwgaW5pdGlhbGl6ZSgpLCBmb3JjZSkgOiBzdHJlbmd0aDsKICAgIH07CiAgICBmb3JjZS54ID0gZnVuY3Rpb24oXykgewogICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh4MiA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQ1KCtfKSwgaW5pdGlhbGl6ZSgpLCBmb3JjZSkgOiB4MjsKICAgIH07CiAgICByZXR1cm4gZm9yY2U7CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZDMtZm9yY2Uvc3JjL3kuanMKICBmdW5jdGlvbiB5X2RlZmF1bHQyKHkyKSB7CiAgICB2YXIgc3RyZW5ndGggPSBjb25zdGFudF9kZWZhdWx0NSgwLjEpLCBub2Rlcywgc3RyZW5ndGhzLCB5ejsKICAgIGlmICh0eXBlb2YgeTIgIT09ICJmdW5jdGlvbiIpCiAgICAgIHkyID0gY29uc3RhbnRfZGVmYXVsdDUoeTIgPT0gbnVsbCA/IDAgOiAreTIpOwogICAgZnVuY3Rpb24gZm9yY2UoYWxwaGEpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIG4gPSBub2Rlcy5sZW5ndGgsIG5vZGU7IGkgPCBuOyArK2kpIHsKICAgICAgICBub2RlID0gbm9kZXNbaV0sIG5vZGUudnkgKz0gKHl6W2ldIC0gbm9kZS55KSAqIHN0cmVuZ3Roc1tpXSAqIGFscGhhOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBpbml0aWFsaXplKCkgewogICAgICBpZiAoIW5vZGVzKQogICAgICAgIHJldHVybjsKICAgICAgdmFyIGksIG4gPSBub2Rlcy5sZW5ndGg7CiAgICAgIHN0cmVuZ3RocyA9IG5ldyBBcnJheShuKTsKICAgICAgeXogPSBuZXcgQXJyYXkobik7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBuOyArK2kpIHsKICAgICAgICBzdHJlbmd0aHNbaV0gPSBpc05hTih5eltpXSA9ICt5Mihub2Rlc1tpXSwgaSwgbm9kZXMpKSA/IDAgOiArc3RyZW5ndGgobm9kZXNbaV0sIGksIG5vZGVzKTsKICAgICAgfQogICAgfQogICAgZm9yY2UuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKF8pIHsKICAgICAgbm9kZXMgPSBfOwogICAgICBpbml0aWFsaXplKCk7CiAgICB9OwogICAgZm9yY2Uuc3RyZW5ndGggPSBmdW5jdGlvbihfKSB7CiAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHN0cmVuZ3RoID0gdHlwZW9mIF8gPT09ICJmdW5jdGlvbiIgPyBfIDogY29uc3RhbnRfZGVmYXVsdDUoK18pLCBpbml0aWFsaXplKCksIGZvcmNlKSA6IHN0cmVuZ3RoOwogICAgfTsKICAgIGZvcmNlLnkgPSBmdW5jdGlvbihfKSB7CiAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHkyID0gdHlwZW9mIF8gPT09ICJmdW5jdGlvbiIgPyBfIDogY29uc3RhbnRfZGVmYXVsdDUoK18pLCBpbml0aWFsaXplKCksIGZvcmNlKSA6IHkyOwogICAgfTsKICAgIHJldHVybiBmb3JjZTsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9kMy16b29tL3NyYy90cmFuc2Zvcm0uanMKICBmdW5jdGlvbiBUcmFuc2Zvcm0oaywgeDIsIHkyKSB7CiAgICB0aGlzLmsgPSBrOwogICAgdGhpcy54ID0geDI7CiAgICB0aGlzLnkgPSB5MjsKICB9CiAgVHJhbnNmb3JtLnByb3RvdHlwZSA9IHsKICAgIGNvbnN0cnVjdG9yOiBUcmFuc2Zvcm0sCiAgICBzY2FsZTogZnVuY3Rpb24oaykgewogICAgICByZXR1cm4gayA9PT0gMSA/IHRoaXMgOiBuZXcgVHJhbnNmb3JtKHRoaXMuayAqIGssIHRoaXMueCwgdGhpcy55KTsKICAgIH0sCiAgICB0cmFuc2xhdGU6IGZ1bmN0aW9uKHgyLCB5MikgewogICAgICByZXR1cm4geDIgPT09IDAgJiB5MiA9PT0gMCA/IHRoaXMgOiBuZXcgVHJhbnNmb3JtKHRoaXMuaywgdGhpcy54ICsgdGhpcy5rICogeDIsIHRoaXMueSArIHRoaXMuayAqIHkyKTsKICAgIH0sCiAgICBhcHBseTogZnVuY3Rpb24ocG9pbnQpIHsKICAgICAgcmV0dXJuIFtwb2ludFswXSAqIHRoaXMuayArIHRoaXMueCwgcG9pbnRbMV0gKiB0aGlzLmsgKyB0aGlzLnldOwogICAgfSwKICAgIGFwcGx5WDogZnVuY3Rpb24oeDIpIHsKICAgICAgcmV0dXJuIHgyICogdGhpcy5rICsgdGhpcy54OwogICAgfSwKICAgIGFwcGx5WTogZnVuY3Rpb24oeTIpIHsKICAgICAgcmV0dXJuIHkyICogdGhpcy5rICsgdGhpcy55OwogICAgfSwKICAgIGludmVydDogZnVuY3Rpb24obG9jYXRpb24pIHsKICAgICAgcmV0dXJuIFsobG9jYXRpb25bMF0gLSB0aGlzLngpIC8gdGhpcy5rLCAobG9jYXRpb25bMV0gLSB0aGlzLnkpIC8gdGhpcy5rXTsKICAgIH0sCiAgICBpbnZlcnRYOiBmdW5jdGlvbih4MikgewogICAgICByZXR1cm4gKHgyIC0gdGhpcy54KSAvIHRoaXMuazsKICAgIH0sCiAgICBpbnZlcnRZOiBmdW5jdGlvbih5MikgewogICAgICByZXR1cm4gKHkyIC0gdGhpcy55KSAvIHRoaXMuazsKICAgIH0sCiAgICByZXNjYWxlWDogZnVuY3Rpb24oeDIpIHsKICAgICAgcmV0dXJuIHgyLmNvcHkoKS5kb21haW4oeDIucmFuZ2UoKS5tYXAodGhpcy5pbnZlcnRYLCB0aGlzKS5tYXAoeDIuaW52ZXJ0LCB4MikpOwogICAgfSwKICAgIHJlc2NhbGVZOiBmdW5jdGlvbih5MikgewogICAgICByZXR1cm4geTIuY29weSgpLmRvbWFpbih5Mi5yYW5nZSgpLm1hcCh0aGlzLmludmVydFksIHRoaXMpLm1hcCh5Mi5pbnZlcnQsIHkyKSk7CiAgICB9LAogICAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gInRyYW5zbGF0ZSgiICsgdGhpcy54ICsgIiwiICsgdGhpcy55ICsgIikgc2NhbGUoIiArIHRoaXMuayArICIpIjsKICAgIH0KICB9OwogIHZhciBpZGVudGl0eTIgPSBuZXcgVHJhbnNmb3JtKDEsIDAsIDApOwogIHRyYW5zZm9ybS5wcm90b3R5cGUgPSBUcmFuc2Zvcm0ucHJvdG90eXBlOwogIGZ1bmN0aW9uIHRyYW5zZm9ybShub2RlKSB7CiAgICB3aGlsZSAoIW5vZGUuX196b29tKQogICAgICBpZiAoIShub2RlID0gbm9kZS5wYXJlbnROb2RlKSkKICAgICAgICByZXR1cm4gaWRlbnRpdHkyOwogICAgcmV0dXJuIG5vZGUuX196b29tOwogIH0KCiAgLy8gc3JjL3B1YmxpYy9jb21wb25lbnRzL1Rvb2x0aXAudHN4CiAgdmFyIGltcG9ydF9yZWFjdCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKICB2YXIgaW1wb3J0X3JlYWN0MiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKICBmdW5jdGlvbiBUb29sdGlwKHsgY2hpbGRyZW46IGNoaWxkcmVuMiwgc2hvdywgcGFyZW50IH0pIHsKICAgIGNoaWxkcmVuMiA9IFtjaGlsZHJlbjJdLmZsYXQoKTsKICAgIGNvbnN0IFthdHRyaWJ1dGVzLCBzZXRBdHRyaWJ1dGVzXSA9ICgwLCBpbXBvcnRfcmVhY3QudXNlU3RhdGUpKHsgeDogMCwgeTogMCwgc2hvdzogZmFsc2UgfSk7CiAgICAoMCwgaW1wb3J0X3JlYWN0LnVzZUVmZmVjdCkoKCkgPT4gewogICAgICBmdW5jdGlvbiBmb2xsb3dNb3VzZShldikgewogICAgICAgIHRyeSB7CiAgICAgICAgICBpZiAoIXNob3cgJiYgYXR0cmlidXRlcy5zaG93KQogICAgICAgICAgICBzZXRBdHRyaWJ1dGVzKHsKICAgICAgICAgICAgICB4OiBhdHRyaWJ1dGVzLngsCiAgICAgICAgICAgICAgeTogYXR0cmlidXRlcy55LAogICAgICAgICAgICAgIHNob3cKICAgICAgICAgICAgfSk7CiAgICAgICAgICBpZiAoIXNob3cpCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIGNvbnN0IGJvdW5kcyA9IHBhcmVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgICAgIHNldEF0dHJpYnV0ZXMoewogICAgICAgICAgICB4OiBldi5jbGllbnRYIC0gYm91bmRzLngsCiAgICAgICAgICAgIHk6IGV2LmNsaWVudFkgLSBib3VuZHMueSwKICAgICAgICAgICAgc2hvdwogICAgICAgICAgfSk7CiAgICAgICAgfSBjYXRjaCAoXykgewogICAgICAgIH0KICAgICAgfQogICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJtb3VzZW1vdmUiLCBmb2xsb3dNb3VzZSk7CiAgICAgIHJldHVybiAoKSA9PiB7CiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigibW91c2Vtb3ZlIiwgZm9sbG93TW91c2UpOwogICAgICB9OwogICAgfSk7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIGltcG9ydF9yZWFjdDIuZGVmYXVsdC5jcmVhdGVFbGVtZW50KAogICAgICAiZGl2IiwKICAgICAgewogICAgICAgIHN0eWxlOiB7CiAgICAgICAgICBkaXNwbGF5OiBhdHRyaWJ1dGVzLnNob3cgPyAiYmxvY2siIDogIm5vbmUiLAogICAgICAgICAgbGVmdDogYXR0cmlidXRlcy54ICsgMTAgKyAicHgiLAogICAgICAgICAgdG9wOiBhdHRyaWJ1dGVzLnkgKyAicHgiCiAgICAgICAgfSwKICAgICAgICBjbGFzc05hbWU6ICJ0b29sdGlwIgogICAgICB9LAogICAgICAuLi5jaGlsZHJlbjIKICAgICk7CiAgfQoKICAvLyBzcmMvcHVibGljL2NvbXBvbmVudHMvTmV0d29ya0dyYXBoLnRzeAogIHZhciBpbXBvcnRfcmVhY3QzID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwogIHZhciBpbXBvcnRfcmVhY3Q0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwogIGZ1bmN0aW9uIGRyYWcoc2ltdWxhdGlvbikgewogICAgZnVuY3Rpb24gZHJhZ3N0YXJ0ZWQoZXZlbnQsIGQpIHsKICAgICAgaWYgKCFldmVudC5hY3RpdmUpCiAgICAgICAgc2ltdWxhdGlvbi5hbHBoYVRhcmdldCgwLjMpLnJlc3RhcnQoKTsKICAgICAgZC5meCA9IGQueDsKICAgICAgZC5meSA9IGQueTsKICAgIH0KICAgIGZ1bmN0aW9uIGRyYWdnZWQoZXZlbnQsIGQpIHsKICAgICAgZC5meCA9IGV2ZW50Lng7CiAgICAgIGQuZnkgPSBldmVudC55OwogICAgfQogICAgZnVuY3Rpb24gZHJhZ2VuZGVkKGV2ZW50LCBkKSB7CiAgICAgIGlmICghZXZlbnQuYWN0aXZlKQogICAgICAgIHNpbXVsYXRpb24uYWxwaGFUYXJnZXQoMCk7CiAgICAgIGQuZnggPSBudWxsOwogICAgICBkLmZ5ID0gbnVsbDsKICAgIH0KICAgIHJldHVybiBkcmFnX2RlZmF1bHQoKS5vbigic3RhcnQiLCBkcmFnc3RhcnRlZCkub24oImRyYWciLCBkcmFnZ2VkKS5vbigiZW5kIiwgZHJhZ2VuZGVkKTsKICB9CiAgZnVuY3Rpb24gZ2V0R3JhcGhEYXRhKG5ldHdvcmspIHsKICAgIGNvbnN0IGZpbHRlcmVkTmV0d29yayA9IG5ldHdvcmsuZmlsdGVyKChzZXJ2ZXIpID0+ICFzZXJ2ZXIucHVyY2hhc2VkQnlQbGF5ZXIgfHwgc2VydmVyLmhvc3RuYW1lID09ICJob21lIik7CiAgICBjb25zdCBub2RlcyA9IGZpbHRlcmVkTmV0d29yay5tYXAoKG5vZGUsIGluZGV4MikgPT4gX19zcHJlYWRWYWx1ZXMoeyBpZDogaW5kZXgyIH0sIG5vZGUpKTsKICAgIGNvbnN0IGxpbmtzID0gZmlsdGVyZWROZXR3b3JrLmZsYXRNYXAoCiAgICAgICh7IGNvbm5lY3Rpb25zIH0sIHNlcnZlckluZGV4KSA9PiBjb25uZWN0aW9ucy5tYXAoKGNvbm5lY3Rpb24pID0+IHsKICAgICAgICB2YXIgX2EsIF9iOwogICAgICAgIHJldHVybiB7IHNvdXJjZTogc2VydmVySW5kZXgsIHRhcmdldDogKF9iID0gKF9hID0gbm9kZXMuZmluZCgoZWwpID0+IGVsLmhvc3RuYW1lID09IGNvbm5lY3Rpb24pKSA9PSBudWxsID8gdm9pZCAwIDogX2EuaWQpICE9IG51bGwgPyBfYiA6IDAgfTsKICAgICAgfSkKICAgICk7CiAgICBjb25zdCBncmFwaERhdGEgPSB7IG5vZGVzLCBsaW5rcyB9OwogICAgcmV0dXJuIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZ3JhcGhEYXRhKSk7CiAgfQogIGZ1bmN0aW9uIGZpbmRQYXRoVG9TZXJ2ZXIobmV0d29yaywgdGFyZ2V0KSB7CiAgICBjb25zdCBsaW5rcyA9IG5ldHdvcmsubGlua3M7CiAgICBjb25zdCB2aXNpdGVkID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgIGNvbnN0IHN0YXJ0Tm9kZSA9IG5ldHdvcmsubm9kZXMuZmluZCgobm9kZSkgPT4gbm9kZS5ob3N0bmFtZSA9PSAiaG9tZSIpLmlkOwogICAgaWYgKHRhcmdldCA9PSBzdGFydE5vZGUpCiAgICAgIHJldHVybiBbXTsKICAgIGZ1bmN0aW9uIGV4cGxvcmUobm9kZSkgewogICAgICBpZiAodmlzaXRlZC5oYXMobm9kZSkpIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgICAgOwogICAgICB2aXNpdGVkLmFkZChub2RlKTsKICAgICAgY29uc3QgY29ubmVjdGVkTm9kZXMgPSBsaW5rcy5maWx0ZXIoKGxpbmspID0+IGxpbmsuc291cmNlID09IG5vZGUpOwogICAgICBpZiAoY29ubmVjdGVkTm9kZXMuZmluZCgobm9kZTIpID0+IG5vZGUyLnRhcmdldCA9PSB0YXJnZXQpKSB7CiAgICAgICAgcmV0dXJuIFt0YXJnZXRdOwogICAgICB9CiAgICAgIGZvciAoY29uc3QgeyB0YXJnZXQ6IGNvbm5lY3RlZE5vZGUgfSBvZiBjb25uZWN0ZWROb2RlcykgewogICAgICAgIGNvbnN0IHBhdGgyID0gZXhwbG9yZShjb25uZWN0ZWROb2RlKTsKICAgICAgICBpZiAocGF0aDIubGVuZ3RoID4gMCkKICAgICAgICAgIHJldHVybiBbY29ubmVjdGVkTm9kZSwgLi4ucGF0aDJdOwogICAgICB9CiAgICAgIHJldHVybiBbXTsKICAgIH0KICAgIGNvbnN0IHBhdGggPSBleHBsb3JlKHN0YXJ0Tm9kZSk7CiAgICByZXR1cm4gcGF0aC5tYXAoKG5vZGVJZCkgPT4gbmV0d29yay5ub2Rlcy5maW5kKChub2RlKSA9PiBub2RlLmlkID09IG5vZGVJZCkuaG9zdG5hbWUpOwogIH0KICBmdW5jdGlvbiBOZXR3b3JrR3JhcGgoeyBzZXJ2ZXJDbGlja2VkIH0pIHsKICAgIHZhciBfYTsKICAgIGNvbnN0IFtzaG93VG9vbHRpcCwgc2V0U2hvd1Rvb2x0aXBdID0gKDAsIGltcG9ydF9yZWFjdDQudXNlU3RhdGUpKGZhbHNlKTsKICAgIGNvbnN0IFtjdXJyZW50U2VydmVyRGF0YSwgc2V0Q3VycmVudFNlcnZlckRhdGFdID0gKDAsIGltcG9ydF9yZWFjdDQudXNlU3RhdGUpKCk7CiAgICBjb25zdCByZWYgPSAoMCwgaW1wb3J0X3JlYWN0NC51c2VSZWYpKCk7CiAgICAoMCwgaW1wb3J0X3JlYWN0NC51c2VFZmZlY3QpKCgpID0+IHsKICAgICAgKGFzeW5jIGZ1bmN0aW9uKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibmV0d29yay1ncmFwaC1zdmctd3JhcHBlciIpLmlubmVySFRNTCA9ICIiOwogICAgICAgICAgY29uc3QgbmV0d29yayA9IGF3YWl0IEJpdGJ1cm5lckluc3RhbmNlLmdldE5ldHdvcmtEYXRhKCk7CiAgICAgICAgICBjb25zdCBncmFwaERhdGEgPSBnZXRHcmFwaERhdGEobmV0d29yayk7CiAgICAgICAgICBjb25zdCB3aWR0aCA9IDYwMDsKICAgICAgICAgIGNvbnN0IGhlaWdodCA9IDQwMDsKICAgICAgICAgIGNvbnN0IGhvbWVOb2RlID0gZ3JhcGhEYXRhLm5vZGVzLmZpbmQoKG5vZGUyKSA9PiBub2RlMi5ob3N0bmFtZSA9PSAiaG9tZSIpOwogICAgICAgICAgaG9tZU5vZGUuZnggPSB3aWR0aCAvIDI7CiAgICAgICAgICBob21lTm9kZS5meSA9IGhlaWdodCAvIDI7CiAgICAgICAgICBjb25zdCB0aW1lID0gRGF0ZS5ub3coKTsKICAgICAgICAgIGNvbnN0IHNpbXVsYXRpb24gPSBzaW11bGF0aW9uX2RlZmF1bHQoZ3JhcGhEYXRhLm5vZGVzKS5mb3JjZSgKICAgICAgICAgICAgImxpbmsiLAogICAgICAgICAgICBsaW5rX2RlZmF1bHQoKS5pZChmdW5jdGlvbihkKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGQuaWQ7CiAgICAgICAgICAgIH0pLmxpbmtzKGdyYXBoRGF0YS5saW5rcykuc3RyZW5ndGgoMikKICAgICAgICAgICkuZm9yY2UoImNoYXJnZSIsIG1hbnlCb2R5X2RlZmF1bHQoKS5zdHJlbmd0aCgtMWUzKSkuZm9yY2UoImZvcmNlWCIsIHhfZGVmYXVsdDIod2lkdGggLyAyKS5zdHJlbmd0aCgxLjIpKS5mb3JjZSgiZm9yY2VZIiwgeV9kZWZhdWx0MihoZWlnaHQgLyAyKS5zdHJlbmd0aCgyKSkub24oInRpY2siLCAoKSA9PiB7CiAgICAgICAgICAgIGlmIChEYXRlLm5vdygpIDwgdGltZSArIDFlMykKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIG5vZGUuYXR0cigiY3giLCBmdW5jdGlvbihkKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGQueDsKICAgICAgICAgICAgfSkuYXR0cigiY3kiLCBmdW5jdGlvbihkKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGQueTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGxpbmsuYXR0cigieDEiLCBmdW5jdGlvbihkKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGQuc291cmNlLng7CiAgICAgICAgICAgIH0pLmF0dHIoInkxIiwgZnVuY3Rpb24oZCkgewogICAgICAgICAgICAgIHJldHVybiBkLnNvdXJjZS55OwogICAgICAgICAgICB9KS5hdHRyKCJ4MiIsIGZ1bmN0aW9uKGQpIHsKICAgICAgICAgICAgICByZXR1cm4gZC50YXJnZXQueDsKICAgICAgICAgICAgfSkuYXR0cigieTIiLCBmdW5jdGlvbihkKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGQudGFyZ2V0Lnk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgICBjb25zdCBzdmcgPSBzZWxlY3RfZGVmYXVsdDIoIiNuZXR3b3JrLWdyYXBoLXN2Zy13cmFwcGVyIikuYXBwZW5kKCJzdmciKS5hdHRyKCJ2aWV3Qm94IiwgYDAgMCAke3dpZHRofSAke2hlaWdodH1gKS5hcHBlbmQoImciKTsKICAgICAgICAgIGNvbnN0IGxpbmsgPSBzdmcuc2VsZWN0QWxsKCJsaW5lIikuZGF0YShncmFwaERhdGEubGlua3MpLmVudGVyKCkuYXBwZW5kKCJsaW5lIikuc3R5bGUoInN0cm9rZSIsICJ2YXIoLS1wcmltYXJ5KSIpOwogICAgICAgICAgY29uc3Qgbm9kZSA9IHN2Zy5zZWxlY3RBbGwoImNpcmNsZSIpLmRhdGEoZ3JhcGhEYXRhLm5vZGVzKS5lbnRlcigpLmFwcGVuZCgiY2lyY2xlIikuYXR0cigiciIsIDEwKS5hdHRyKCJjbGFzcyIsIChkKSA9PiBgbmV0d29yay1ub2RlICR7ZC5oYXNBZG1pblJpZ2h0cyA/ICJyb290IiA6ICIifWApLm9uKCJtb3VzZW92ZXIiLCAoZXZlbnQsIGQpID0+IHsKICAgICAgICAgICAgc2V0U2hvd1Rvb2x0aXAodHJ1ZSk7CiAgICAgICAgICAgIHNldEN1cnJlbnRTZXJ2ZXJEYXRhKGQpOwogICAgICAgICAgfSkub24oIm1vdXNlbGVhdmUiLCAoKSA9PiBzZXRTaG93VG9vbHRpcChmYWxzZSkpLm9uKCJjbGljayIsIGFzeW5jIChlbnYsIGQpID0+IHNlcnZlckNsaWNrZWQoZmluZFBhdGhUb1NlcnZlcihnZXRHcmFwaERhdGEobmV0d29yayksIGQuaWQpKSkuY2FsbChkcmFnKHNpbXVsYXRpb24pKS5hdHRyKCJjeCIsIHdpZHRoIC8gMikuYXR0cigiY3kiLCBoZWlnaHQgLyAyKTsKICAgICAgICB9IGNhdGNoIChfKSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKF8pOwogICAgICAgIH0KICAgICAgICA7CiAgICAgIH0pKCk7CiAgICB9LCBbXSk7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIGltcG9ydF9yZWFjdDMuZGVmYXVsdC5jcmVhdGVFbGVtZW50KGltcG9ydF9yZWFjdDMuZGVmYXVsdC5GcmFnbWVudCwgbnVsbCwgLyogQF9fUFVSRV9fICovIGltcG9ydF9yZWFjdDMuZGVmYXVsdC5jcmVhdGVFbGVtZW50KCJkaXYiLCB7IHJlZiwgc3R5bGU6IHsgcG9zaXRpb246ICJyZWxhdGl2ZSIgfSB9LCAvKiBAX19QVVJFX18gKi8gaW1wb3J0X3JlYWN0My5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoCiAgICAgIFRvb2x0aXAsCiAgICAgIHsKICAgICAgICBzaG93OiBzaG93VG9vbHRpcCwKICAgICAgICBwYXJlbnQ6IHJlZi5jdXJyZW50CiAgICAgIH0sCiAgICAgIC8qIEBfX1BVUkVfXyAqLyBpbXBvcnRfcmVhY3QzLmRlZmF1bHQuY3JlYXRlRWxlbWVudCgicCIsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBpbXBvcnRfcmVhY3QzLmRlZmF1bHQuY3JlYXRlRWxlbWVudCgic3BhbiIsIG51bGwsICJTZXJ2ZXI6ICIpLCAvKiBAX19QVVJFX18gKi8gaW1wb3J0X3JlYWN0My5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoInNwYW4iLCBudWxsLCAoX2EgPSBgJHtjdXJyZW50U2VydmVyRGF0YSA9PSBudWxsID8gdm9pZCAwIDogY3VycmVudFNlcnZlckRhdGEuaG9zdG5hbWV9ICgke2N1cnJlbnRTZXJ2ZXJEYXRhID09IG51bGwgPyB2b2lkIDAgOiBjdXJyZW50U2VydmVyRGF0YS5pcH0pYCkgIT0gbnVsbCA/IF9hIDogIiIpKSwKICAgICAgLyogQF9fUFVSRV9fICovIGltcG9ydF9yZWFjdDMuZGVmYXVsdC5jcmVhdGVFbGVtZW50KCJwIiwgbnVsbCwgLyogQF9fUFVSRV9fICovIGltcG9ydF9yZWFjdDMuZGVmYXVsdC5jcmVhdGVFbGVtZW50KCJzcGFuIiwgbnVsbCwgIkhUVFA6ICIpLCAvKiBAX19QVVJFX18gKi8gaW1wb3J0X3JlYWN0My5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoInNwYW4iLCBudWxsLCAoY3VycmVudFNlcnZlckRhdGEgPT0gbnVsbCA/IHZvaWQgMCA6IGN1cnJlbnRTZXJ2ZXJEYXRhLmh0dHBQb3J0T3BlbikgPyAib3BlbiIgOiAiY2xvc2VkIikpLAogICAgICAvKiBAX19QVVJFX18gKi8gaW1wb3J0X3JlYWN0My5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoInAiLCBudWxsLCAvKiBAX19QVVJFX18gKi8gaW1wb3J0X3JlYWN0My5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoInNwYW4iLCBudWxsLCAiU1NIOiAiKSwgLyogQF9fUFVSRV9fICovIGltcG9ydF9yZWFjdDMuZGVmYXVsdC5jcmVhdGVFbGVtZW50KCJzcGFuIiwgbnVsbCwgKGN1cnJlbnRTZXJ2ZXJEYXRhID09IG51bGwgPyB2b2lkIDAgOiBjdXJyZW50U2VydmVyRGF0YS5zc2hQb3J0T3BlbikgPyAib3BlbiIgOiAiY2xvc2VkIikpLAogICAgICAvKiBAX19QVVJFX18gKi8gaW1wb3J0X3JlYWN0My5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoInAiLCBudWxsLCAvKiBAX19QVVJFX18gKi8gaW1wb3J0X3JlYWN0My5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoInNwYW4iLCBudWxsLCAiRlRQOiAiKSwgLyogQF9fUFVSRV9fICovIGltcG9ydF9yZWFjdDMuZGVmYXVsdC5jcmVhdGVFbGVtZW50KCJzcGFuIiwgbnVsbCwgKGN1cnJlbnRTZXJ2ZXJEYXRhID09IG51bGwgPyB2b2lkIDAgOiBjdXJyZW50U2VydmVyRGF0YS5mdHBQb3J0T3BlbikgPyAib3BlbiIgOiAiY2xvc2VkIikpLAogICAgICAvKiBAX19QVVJFX18gKi8gaW1wb3J0X3JlYWN0My5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoInAiLCBudWxsLCAvKiBAX19QVVJFX18gKi8gaW1wb3J0X3JlYWN0My5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoInNwYW4iLCBudWxsLCAiU1FMOiAiKSwgLyogQF9fUFVSRV9fICovIGltcG9ydF9yZWFjdDMuZGVmYXVsdC5jcmVhdGVFbGVtZW50KCJzcGFuIiwgbnVsbCwgKGN1cnJlbnRTZXJ2ZXJEYXRhID09IG51bGwgPyB2b2lkIDAgOiBjdXJyZW50U2VydmVyRGF0YS5zcWxQb3J0T3BlbikgPyAib3BlbiIgOiAiY2xvc2VkIikpLAogICAgICAvKiBAX19QVVJFX18gKi8gaW1wb3J0X3JlYWN0My5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoInAiLCBudWxsLCAvKiBAX19QVVJFX18gKi8gaW1wb3J0X3JlYWN0My5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoInNwYW4iLCBudWxsLCAiU01UUDogIiksIC8qIEBfX1BVUkVfXyAqLyBpbXBvcnRfcmVhY3QzLmRlZmF1bHQuY3JlYXRlRWxlbWVudCgic3BhbiIsIG51bGwsIChjdXJyZW50U2VydmVyRGF0YSA9PSBudWxsID8gdm9pZCAwIDogY3VycmVudFNlcnZlckRhdGEuc210cFBvcnRPcGVuKSA/ICJvcGVuIiA6ICJjbG9zZWQiKSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyBpbXBvcnRfcmVhY3QzLmRlZmF1bHQuY3JlYXRlRWxlbWVudCgicCIsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBpbXBvcnRfcmVhY3QzLmRlZmF1bHQuY3JlYXRlRWxlbWVudCgic3BhbiIsIG51bGwsICJyb290OiAiKSwgLyogQF9fUFVSRV9fICovIGltcG9ydF9yZWFjdDMuZGVmYXVsdC5jcmVhdGVFbGVtZW50KCJzcGFuIiwgbnVsbCwgKGN1cnJlbnRTZXJ2ZXJEYXRhID09IG51bGwgPyB2b2lkIDAgOiBjdXJyZW50U2VydmVyRGF0YS5oYXNBZG1pblJpZ2h0cykgPyAieWVzIiA6ICJubyIpKQogICAgKSwgLyogQF9fUFVSRV9fICovIGltcG9ydF9yZWFjdDMuZGVmYXVsdC5jcmVhdGVFbGVtZW50KCJkaXYiLCB7IGlkOiAibmV0d29yay1ncmFwaC1zdmctd3JhcHBlciIgfSkpKTsKICB9CgogIC8vIHNyYy9wdWJsaWMvY29tcG9uZW50cy9BcHAudHN4CiAgZnVuY3Rpb24gQXBwKCkgewogICAgQml0YnVybmVySW5zdGFuY2UubG9hZFRoZW1lKCk7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIGltcG9ydF9yZWFjdDUuZGVmYXVsdC5jcmVhdGVFbGVtZW50KGltcG9ydF9yZWFjdDUuZGVmYXVsdC5GcmFnbWVudCwgbnVsbCwgLyogQF9fUFVSRV9fICovIGltcG9ydF9yZWFjdDUuZGVmYXVsdC5jcmVhdGVFbGVtZW50KAogICAgICBOZXR3b3JrR3JhcGgsCiAgICAgIHsKICAgICAgICBzZXJ2ZXJDbGlja2VkOiAocGF0aCkgPT4gQml0YnVybmVySW5zdGFuY2UuY29ubmVjdFRvU2VydmVyKHBhdGgpCiAgICAgIH0KICAgICkpOwogIH0KCiAgLy8gc3JjL3B1YmxpYy9tYWluLnRzeAogIGltcG9ydF9jbGllbnQuZGVmYXVsdC5jcmVhdGVSb290KGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJiYi11aS1leHQtcm9vdCIpKS5yZW5kZXIoCiAgICAvLyA8PjwvPgogICAgLy8gICAvLyA8UmVhY3QuU3RyaWN0TW9kZT4KICAgIC8qIEBfX1BVUkVfXyAqLyBpbXBvcnRfcmVhY3Q2LmRlZmF1bHQuY3JlYXRlRWxlbWVudChBcHAsIG51bGwpCiAgICAvLyAgICAgLy8gPGRpdj48L2Rpdj4KICAgIC8vICAgLy8gPC9SZWFjdC5TdHJpY3RNb2RlPiwKICApOwp9KSgpOwovKiEgQnVuZGxlZCBsaWNlbnNlIGluZm9ybWF0aW9uOgoKcmVhY3QvY2pzL3JlYWN0LmRldmVsb3BtZW50LmpzOgogICgqKgogICAqIEBsaWNlbnNlIFJlYWN0CiAgICogcmVhY3QuZGV2ZWxvcG1lbnQuanMKICAgKgogICAqIENvcHlyaWdodCAoYykgRmFjZWJvb2ssIEluYy4gYW5kIGl0cyBhZmZpbGlhdGVzLgogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlCiAgICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKc2NoZWR1bGVyL2Nqcy9zY2hlZHVsZXIuZGV2ZWxvcG1lbnQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgUmVhY3QKICAgKiBzY2hlZHVsZXIuZGV2ZWxvcG1lbnQuanMKICAgKgogICAqIENvcHlyaWdodCAoYykgRmFjZWJvb2ssIEluYy4gYW5kIGl0cyBhZmZpbGlhdGVzLgogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlCiAgICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKcmVhY3QtZG9tL2Nqcy9yZWFjdC1kb20uZGV2ZWxvcG1lbnQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgUmVhY3QKICAgKiByZWFjdC1kb20uZGV2ZWxvcG1lbnQuanMKICAgKgogICAqIENvcHlyaWdodCAoYykgRmFjZWJvb2ssIEluYy4gYW5kIGl0cyBhZmZpbGlhdGVzLgogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlCiAgICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQogICgqKgogICAqIENoZWNrcyBpZiBhbiBldmVudCBpcyBzdXBwb3J0ZWQgaW4gdGhlIGN1cnJlbnQgZXhlY3V0aW9uIGVudmlyb25tZW50LgogICAqCiAgICogTk9URTogVGhpcyB3aWxsIG5vdCB3b3JrIGNvcnJlY3RseSBmb3Igbm9uLWdlbmVyaWMgZXZlbnRzIHN1Y2ggYXMgYGNoYW5nZWAsCiAgICogYHJlc2V0YCwgYGxvYWRgLCBgZXJyb3JgLCBhbmQgYHNlbGVjdGAuCiAgICoKICAgKiBCb3Jyb3dzIGZyb20gTW9kZXJuaXpyLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IGV2ZW50TmFtZVN1ZmZpeCBFdmVudCBuYW1lLCBlLmcuICJjbGljayIuCiAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgZXZlbnQgaXMgc3VwcG9ydGVkLgogICAqIEBpbnRlcm5hbAogICAqIEBsaWNlbnNlIE1vZGVybml6ciAzLjAuMHByZSAoQ3VzdG9tIEJ1aWxkKSB8IE1JVAogICAqKQoqLwo=", "Lyogc3JjL3B1YmxpYy9zdHlsZS9BcHAuY3NzICovCi8qIHNyYy9wdWJsaWMvc3R5bGUvTmV0d29ya0dyYXBoLmNzcyAqLwoubmV0d29yay1ub2RlOmhvdmVyIHsKICBzdHJva2U6IHZhcigtLXdoaXRlKTsKfQoubmV0d29yay1ub2RlIHsKICBmaWxsOiB2YXIoLS1zZWNvbmRhcnlkYXJrKTsKICBzdHJva2U6IHZhcigtLWVycm9yKTsKfQoubmV0d29yay1ub2RlLnJvb3QgewogIHN0cm9rZTogdmFyKC0tc3VjY2Vzcyk7Cn0KCi8qIHNyYy9wdWJsaWMvc3R5bGUvVG9vbHRpcC5jc3MgKi8KLnRvb2x0aXAgewogIHotaW5kZXg6IDk5OTsKICBkaXNwbGF5OiBibG9jazsKICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgYmFja2dyb3VuZDogdmFyKC0tYmFja2dyb3VuZHByaW1hcnkpOwogIGJvcmRlcjogNXB4OwogIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLXByaW1hcnkpOwogIGNvbG9yOiB2YXIoLS1wcmltYXJ5KTsKICBib3gtc2hhZG93OiAwIDAgMTBweCAzcHggdmFyKC0tcHJpbWFyeWRhcmspOwogIHBhZGRpbmc6IDAuMmVtOwp9Ci50b29sdGlwIHAgc3BhbjpmaXJzdC1jaGlsZCB7CiAgdGV4dC1hbGlnbjogcmlnaHQ7Cn0KLnRvb2x0aXAgcCB7CiAgbWFyZ2luOiAwOwogIHBhZGRpbmc6IDA7CiAgZGlzcGxheTogZ3JpZDsKICBncmlkLWF1dG8tY29sdW1uczogNzBweCBhdXRvOwogIGdhcDogNXB4Owp9Ci50b29sdGlwIHAgc3BhbiB7CiAgZ3JpZC1yb3c6IDE7Cn0KLnRvb2x0aXAgcCB7CiAgbWFyZ2luOiAwOwogIHBhZGRpbmc6IDA7Cn0KCi8qIHNyYy9wdWJsaWMvc3R5bGUvZ2xvYmFsLmNzcyAqLwpib2R5IHsKICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1iYWNrZ3JvdW5kcHJpbWFyeSwgIzAwMCk7CiAgY29sb3I6IHZhcigtLXByaW1hcnljb2xvcik7CiAgZm9udC1mYW1pbHk6CiAgICAiTHVjaWRhIENvbnNvbGUiLAogICAgIkx1Y2lkYSBTYW5zIFVuaWNvZGUiLAogICAgIkZpcmEgTW9ubyIsCiAgICBDb25zb2xhcywKICAgICJDb3VyaWVyIE5ldyIsCiAgICBDb3VyaWVyLAogICAgbW9ub3NwYWNlLAogICAgIlRpbWVzIE5ldyBSb21hbiI7CiAgb3ZlcmZsb3c6IGhpZGRlbjsKfQoKLyogc3JjL3B1YmxpYy9zdHlsZS9ub3JtYWxpemUuY3NzICovCmh0bWwgewogIGxpbmUtaGVpZ2h0OiAxLjE1OwogIC13ZWJraXQtdGV4dC1zaXplLWFkanVzdDogMTAwJTsKfQpib2R5IHsKICBtYXJnaW46IDA7Cn0KbWFpbiB7CiAgZGlzcGxheTogYmxvY2s7Cn0KaDEgewogIGZvbnQtc2l6ZTogMmVtOwogIG1hcmdpbjogMC42N2VtIDA7Cn0KaHIgewogIGJveC1zaXppbmc6IGNvbnRlbnQtYm94OwogIGhlaWdodDogMDsKICBvdmVyZmxvdzogdmlzaWJsZTsKfQpwcmUgewogIGZvbnQtZmFtaWx5OiBtb25vc3BhY2UsIG1vbm9zcGFjZTsKICBmb250LXNpemU6IDFlbTsKfQphIHsKICBiYWNrZ3JvdW5kLWNvbG9yOiB0cmFuc3BhcmVudDsKfQphYmJyW3RpdGxlXSB7CiAgYm9yZGVyLWJvdHRvbTogbm9uZTsKICB0ZXh0LWRlY29yYXRpb246IHVuZGVybGluZTsKICB0ZXh0LWRlY29yYXRpb246IHVuZGVybGluZSBkb3R0ZWQ7Cn0KYiwKc3Ryb25nIHsKICBmb250LXdlaWdodDogYm9sZGVyOwp9CmNvZGUsCmtiZCwKc2FtcCB7CiAgZm9udC1mYW1pbHk6IG1vbm9zcGFjZSwgbW9ub3NwYWNlOwogIGZvbnQtc2l6ZTogMWVtOwp9CnNtYWxsIHsKICBmb250LXNpemU6IDgwJTsKfQpzdWIsCnN1cCB7CiAgZm9udC1zaXplOiA3NSU7CiAgbGluZS1oZWlnaHQ6IDA7CiAgcG9zaXRpb246IHJlbGF0aXZlOwogIHZlcnRpY2FsLWFsaWduOiBiYXNlbGluZTsKfQpzdWIgewogIGJvdHRvbTogLTAuMjVlbTsKfQpzdXAgewogIHRvcDogLTAuNWVtOwp9CmltZyB7CiAgYm9yZGVyLXN0eWxlOiBub25lOwp9CmJ1dHRvbiwKaW5wdXQsCm9wdGdyb3VwLApzZWxlY3QsCnRleHRhcmVhIHsKICBmb250LWZhbWlseTogaW5oZXJpdDsKICBmb250LXNpemU6IDEwMCU7CiAgbGluZS1oZWlnaHQ6IDEuMTU7CiAgbWFyZ2luOiAwOwp9CmJ1dHRvbiwKaW5wdXQgewogIG92ZXJmbG93OiB2aXNpYmxlOwp9CmJ1dHRvbiwKc2VsZWN0IHsKICB0ZXh0LXRyYW5zZm9ybTogbm9uZTsKfQpidXR0b24sClt0eXBlPWJ1dHRvbl0sClt0eXBlPXJlc2V0XSwKW3R5cGU9c3VibWl0XSB7CiAgLXdlYmtpdC1hcHBlYXJhbmNlOiBidXR0b247Cn0KYnV0dG9uOjotbW96LWZvY3VzLWlubmVyLApbdHlwZT1idXR0b25dOjotbW96LWZvY3VzLWlubmVyLApbdHlwZT1yZXNldF06Oi1tb3otZm9jdXMtaW5uZXIsClt0eXBlPXN1Ym1pdF06Oi1tb3otZm9jdXMtaW5uZXIgewogIGJvcmRlci1zdHlsZTogbm9uZTsKICBwYWRkaW5nOiAwOwp9CmJ1dHRvbjotbW96LWZvY3VzcmluZywKW3R5cGU9YnV0dG9uXTotbW96LWZvY3VzcmluZywKW3R5cGU9cmVzZXRdOi1tb3otZm9jdXNyaW5nLApbdHlwZT1zdWJtaXRdOi1tb3otZm9jdXNyaW5nIHsKICBvdXRsaW5lOiAxcHggZG90dGVkIEJ1dHRvblRleHQ7Cn0KZmllbGRzZXQgewogIHBhZGRpbmc6IDAuMzVlbSAwLjc1ZW0gMC42MjVlbTsKfQpsZWdlbmQgewogIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgY29sb3I6IGluaGVyaXQ7CiAgZGlzcGxheTogdGFibGU7CiAgbWF4LXdpZHRoOiAxMDAlOwogIHBhZGRpbmc6IDA7CiAgd2hpdGUtc3BhY2U6IG5vcm1hbDsKfQpwcm9ncmVzcyB7CiAgdmVydGljYWwtYWxpZ246IGJhc2VsaW5lOwp9CnRleHRhcmVhIHsKICBvdmVyZmxvdzogYXV0bzsKfQpbdHlwZT1jaGVja2JveF0sClt0eXBlPXJhZGlvXSB7CiAgYm94LXNpemluZzogYm9yZGVyLWJveDsKICBwYWRkaW5nOiAwOwp9Clt0eXBlPW51bWJlcl06Oi13ZWJraXQtaW5uZXItc3Bpbi1idXR0b24sClt0eXBlPW51bWJlcl06Oi13ZWJraXQtb3V0ZXItc3Bpbi1idXR0b24gewogIGhlaWdodDogYXV0bzsKfQpbdHlwZT1zZWFyY2hdIHsKICAtd2Via2l0LWFwcGVhcmFuY2U6IHRleHRmaWVsZDsKICBvdXRsaW5lLW9mZnNldDogLTJweDsKfQpbdHlwZT1zZWFyY2hdOjotd2Via2l0LXNlYXJjaC1kZWNvcmF0aW9uIHsKICAtd2Via2l0LWFwcGVhcmFuY2U6IG5vbmU7Cn0KOjotd2Via2l0LWZpbGUtdXBsb2FkLWJ1dHRvbiB7CiAgLXdlYmtpdC1hcHBlYXJhbmNlOiBidXR0b247CiAgZm9udDogaW5oZXJpdDsKfQpkZXRhaWxzIHsKICBkaXNwbGF5OiBibG9jazsKfQpzdW1tYXJ5IHsKICBkaXNwbGF5OiBsaXN0LWl0ZW07Cn0KdGVtcGxhdGUgewogIGRpc3BsYXk6IG5vbmU7Cn0KW2hpZGRlbl0gewogIGRpc3BsYXk6IG5vbmU7Cn0KLyohIG5vcm1hbGl6ZS5jc3MgdjguMC4xIHwgTUlUIExpY2Vuc2UgfCBnaXRodWIuY29tL25lY29sYXMvbm9ybWFsaXplLmNzcyAqLwo="];

// src/bitburner/lib/Actions.ts
var Actions_exports = {};
__export(Actions_exports, {
  connectToServer: () => connectToServer,
  nsFunction: () => nsFunction,
  scanNetwork: () => scanNetwork
});

// src/bitburner/lib/Terminal.ts
function executeOnTerminal(command) {
  const terminalInput = document.getElementById("terminal-input");
  terminalInput.value = command;
  const handler = Object.keys(terminalInput).filter((key) => /.*reactProps.*/.test(key))[0];
  if (!handler)
    return;
  terminalInput[handler].onChange({ target: terminalInput });
  terminalInput[handler].onKeyDown({ key: "Enter", preventDefault: () => null });
}

// src/bitburner/lib/Actions.ts
function connectToServer(netscript, params) {
  const command = params.reduce((prev, cur) => `${prev};connect ${cur}`, "home");
  executeOnTerminal(command);
}
function scanNetwork(netscript) {
  const network = /* @__PURE__ */ new Map();
  recursiveScan("home");
  function recursiveScan(server) {
    if (network.has(server))
      return;
    const details = {
      connections: netscript.scan(server),
      ...netscript.getServer(server)
    };
    network.set(server, details);
    for (const connection of details.connections) {
      recursiveScan(connection);
    }
  }
  return [...network.values()];
}
async function nsFunction(netscript, params) {
  const [functionWithNamespaces, ...functionParams] = params;
  let targetFunction = netscript;
  for (const key of functionWithNamespaces.split(".")) {
    if (Object.hasOwn(targetFunction, key))
      targetFunction = targetFunction[key];
  }
  return await targetFunction(...functionParams);
}

// src/bitburner/lib/UIWindow.ts
var UIWindow = class {
  // w: Element;
  netscript;
  constructor(netscript, w) {
    this.netscript = netscript;
    const listener = ({ detail }) => this.messageHandler(detail);
    window.addEventListener("bitburner", listener);
    netscript.atExit(() => window.removeEventListener("bitburner", listener));
  }
  async messageHandler(message) {
    const { uuid, action, params } = message;
    if (!action)
      return;
    const actionIndex = action.split("-").map((string, index) => index != 0 ? string.charAt(0).toUpperCase() + string.slice(1) : string.toLowerCase()).join("");
    if (Object.hasOwn(Actions_exports, actionIndex)) {
      const result = await Actions_exports[actionIndex](this.netscript, params);
      this.sendResponse({
        uuid,
        action,
        data: result
      });
    }
  }
  sendResponse(response) {
    window.dispatchEvent(new CustomEvent("bitburner-response", { detail: response }));
  }
};

// src/bitburner/bitburner-ui-extension.ts
async function main(netscript) {
  const ID = `BB_UI_EXT:${netscript.pid}`;
  netscript.tail(netscript.pid, "home");
  netscript.print(ID);
  await new Promise((resolve) => setTimeout(() => resolve(), 100));
  const tailWindows = [...document.querySelectorAll(".react-resizable")];
  const spans = tailWindows.map((win) => [...win.querySelectorAll("span")]).flat();
  const idSpan = spans.filter((cur) => cur.innerHTML == ID)[0];
  const windowEl = findRoot(idSpan);
  const window2 = new UIWindow(netscript, windowEl);
  windowEl.innerHTML = "<div id=bb-ui-ext-root></div>";
  const scriptEl = document.createElement("script");
  scriptEl.innerHTML = atob(payload[0]);
  const styleEl = document.createElement("style");
  styleEl.innerHTML = atob(payload[1]);
  windowEl.appendChild(scriptEl);
  windowEl.appendChild(styleEl);
  return new Promise((resolve) => watchElForDeletion(windowEl, () => resolve()));
}
function findRoot(span) {
  let el = span;
  while (!el.parentElement.classList.contains("react-resizable"))
    el = el.parentElement;
  return el;
}
function watchElForDeletion(elToWatch, callback) {
  const parent = document.body;
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === "childList") {
        mutation.removedNodes.forEach((node) => !containsRecursive(node, elToWatch) || callback());
      }
    });
  });
  observer.observe(parent, { childList: true, subtree: true });
}
function containsRecursive(container, child) {
  if (!("children" in container))
    return;
  return [...container.children].reduce((prev, cur) => prev || cur == child || containsRecursive(cur, child), false);
}
export {
  main
};
